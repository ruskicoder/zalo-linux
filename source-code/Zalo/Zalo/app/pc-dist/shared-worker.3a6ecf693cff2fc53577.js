__SCRIPT_TYPE__="renderer",function(e){function t(t){for(var i,r,o=t[0],c=t[1],d=t[2],l=0,u=[];l<o.length;l++)r=o[l],Object.prototype.hasOwnProperty.call(n,r)&&n[r]&&u.push(n[r][0]),n[r]=0;for(i in c)Object.prototype.hasOwnProperty.call(c,i)&&(e[i]=c[i]);for(h&&h(t);u.length;)u.shift()();return a.push.apply(a,d||[]),s()}function s(){for(var e,t=0;t<a.length;t++){for(var s=a[t],i=!0,r=1;r<s.length;r++){var c=s[r];0!==n[c]&&(i=!1)}i&&(a.splice(t--,1),e=o(o.s=s[0]))}return e}var i={},r={31:0},n={31:0},a=[];function o(t){if(i[t])return i[t].exports;var s=i[t]={i:t,l:!1,exports:{}};return e[t].call(s.exports,s,s.exports,o),s.l=!0,s.exports}o.e=function(e){var t=[];r[e]?t.push(r[e]):0!==r[e]&&{39:1,40:1,41:1}[e]&&t.push(r[e]=new Promise((function(t,s){for(var i=({13:"countries",20:"lang-en",21:"lang-vi"}[e]||e)+".3a6ecf693cff2fc53577.css",n=o.p+i,a=document.getElementsByTagName("link"),c=0;c<a.length;c++){var d=(h=a[c]).getAttribute("data-href")||h.getAttribute("href");if("stylesheet"===h.rel&&(d===i||d===n))return t()}var l=document.getElementsByTagName("style");for(c=0;c<l.length;c++){var h;if((d=(h=l[c]).getAttribute("data-href"))===i||d===n)return t()}var u=document.createElement("link");u.rel="stylesheet",u.type="text/css",u.onload=t,u.onerror=function(t){var i=t&&t.target&&t.target.src||n,a=new Error("Loading CSS chunk "+e+" failed.\n("+i+")");a.code="CSS_CHUNK_LOAD_FAILED",a.request=i,delete r[e],u.parentNode.removeChild(u),s(a)},u.href=n,document.getElementsByTagName("head")[0].appendChild(u)})).then((function(){r[e]=0})));var s=n[e];if(0!==s)if(s)t.push(s[2]);else{var i=new Promise((function(t,i){s=n[e]=[t,i]}));t.push(s[2]=i);var a,c=document.createElement("script");c.charset="utf-8",c.timeout=120,o.nc&&c.setAttribute("nonce",o.nc),c.src=function(e){return o.p+"lazy/"+({13:"countries",20:"lang-en",21:"lang-vi"}[e]||e)+"."+{12:"fadc7ea85a788f93e7cb",13:"932300cf9a36152c5ed9",20:"56238718443649810e49",21:"726eb5732efe07d13d77",37:"58e2286805582e3f980b",38:"67f1ec6882c9130825bc",39:"a90f165e1ab3329a1d8c",40:"fc2bfb61fe00db63c149",41:"6db3515e1198bc737305",43:"8cfd6a6b83837153503a",44:"44780d77b5c22a7cf097",45:"80baa2902d2f38174b38",46:"8a88dd4474733345cbe8",47:"3ab15a52f306e83d32a3",48:"beef79f849f9f284cc65",49:"14ffb09af60f77653334",50:"bc28144e5345fd739f24",51:"ebd711242da66d5b68fe"}[e]+".js"}(e);var d=new Error;a=function(t){c.onerror=c.onload=null,clearTimeout(l);var s=n[e];if(0!==s){if(s){var i=t&&("load"===t.type?"missing":t.type),r=t&&t.target&&t.target.src;d.message="Loading chunk "+e+" failed.\n("+i+": "+r+")",d.name="ChunkLoadError",d.type=i,d.request=r,s[1](d)}n[e]=void 0}};var l=setTimeout((function(){a({type:"timeout",target:c})}),12e4);c.onerror=c.onload=a,document.head.appendChild(c)}return Promise.all(t)},o.m=e,o.c=i,o.d=function(e,t,s){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(o.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)o.d(s,i,function(t){return e[t]}.bind(null,i));return s},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o.oe=function(e){throw e};var c=this.webpackJsonp=this.webpackJsonp||[],d=c.push.bind(c);c.push=t,c=c.slice();for(var l=0;l<c.length;l++)t(c[l]);var h=d;a.push([1,0,4,5,6,11,10,17,1,2,3,9,8,7,16]),s()}({1:function(e,t,s){e.exports=s("CdmT")},"8s2m":function(e,t,s){"use strict";s.d(t,"a",(function(){return r})),s.d(t,"b",(function(){return n}));var i=s("jDHv");let r;!function(e){e.DefaultInsertOptions={partition:void 0};let t=function(e){return e.Message="message",e.Res="res",e.Ref="ref",e}({});e.TableName=t;let s=function(e){return e.Core="Core",e.Res="Res",e.Ref="Ref",e}({});e.DBName=s;let i=function(e){return e.Message="Core/message",e.Res="Res/res",e.Ref="Res/ref",e}({});e.TablePath=i}(r||(r={}));const n=Object(i.define)("transfer-msg-database")},CdmT:function(e,t,s){"use strict";s.r(t);s("iGh7"),s("TlRV"),s("dUtG"),s("v5OU"),s("jmmm"),s("xDXR"),s("EmOc"),s("ezdo"),s("KdAX"),s("mzek"),s("aBYf"),s("zm+Q"),s("WSI5"),s("v/rv"),s("nAZb"),s("c0KM"),s("zheM"),s("CXIs"),s("cZjg");var i=s("YrRS");Object(i.b)();s("33YB"),s("LyOm"),s("lNuO");var r=s("T0aS"),n=s("jDHv");class a extends r.b{constructor(){super(),$zsub.$zsessionManager.onReceiveSession(((e,t)=>{this.setSession(t)}))}}n.ModuleContainer.registerSingleton(r.a,a);s("0rWR"),s("Lq8m"),s("nUpV"),s("5yGw"),s("hRcX"),s("/2rj"),s("gpNb"),s("rhBN"),s("BP4/"),s("cF85"),s("7g9m"),s("oqw1");var o,c=s("8/YW"),d=s("PmZf"),l=s("tHMN"),h=s("jIg3"),u=s("8eps"),g=s("fsN4"),m=s("Mgpg");let p=Object(c.h)()(o=n.ModuleContainer.injectable()(o=function(e,t){return n.ModuleContainer.inject(l.b)(e,void 0,0)}(o=function(e,t){return n.ModuleContainer.inject(m.ZLoggerFactory)(e,void 0,1)}(o=Reflect.metadata("design:type",Function)(o=Reflect.metadata("design:paramtypes",[void 0===l.a?Object:l.a,void 0===m.ZLoggerFactory?Object:m.ZLoggerFactory])(o=class extends h.a{constructor(e,t){super(),this.engine=e,this.logger=void 0,this.removeListeners=()=>{},this.logger=t.createZLogger("db",["client"]),this.registerListeners()}registerListeners(){const e=e=>this.dispatchEvent(e),t=[];t.push(this.engine.addEventListener(d.b.UnexpectedError,e)),t.push(this.engine.addEventListener(d.b.QueryExec,e)),t.push(this.engine.addEventListener(d.b.QueryError,e)),t.push(this.engine.addEventListener(d.b.SuccessOpenDB,e)),t.push(this.engine.addEventListener(d.b.LongOpenDB,e)),t.push(this.engine.addEventListener(d.b.TimeConsumingQuery,e)),t.push(this.engine.addEventListener(d.b.ConnectionClosedAbnormally,e)),t.push(this.engine.addEventListener(d.b.SchemaMigratedAbnormally,e)),t.push(this.engine.addEventListener(d.b.Warning,e)),this.removeListeners=()=>t.forEach((e=>e()))}onDispose(){this.removeListeners()}install(){$zsub.$zdb.onReceiveSession(((e,t)=>{this.authenticate(t)})),$zdb.notifyDbConnected(__ZaBUNDLENAME__),$zsub.$zdb.onRequestCloseDbs((async(e,t,s)=>{this.logger.zsymb(0,"g2sc6L","closing databases"),await this.closeDBs(t,s),this.logger.zsymb(0,"EBBPB_","closed databases"),$zdb.notifyFinishCloseDb(__ZaBUNDLENAME__)})),this.logger.zsymb(0,"UUV339","installed")}areYouOk(){return!0}authenticate(e){e&&(this.session=e,this.dispatchEvent(new d.g(e)),this.engine.authenticate(e),this.logger.zsymb(0,"uUcfEO",(()=>["authenticated",`id: ${e.userId}`])))}async closeDBs(e,t){const s=g.default.getInstance(),i=this.logger;let r=[];if(e){if(e.length){let a=[...e];i.zsymb(3,"RQ-qwe",["Start closing dbs: {}","pgQwMz"],e),i.zsymb(3,"_26zF8",["Wait for dbs to be closed: {}","QhuMGo"],a),r=e.map((async e=>{let r=s[e];if(void 0===r){const t=n.ModuleContainer.resolve(u.a).getValue().Meta;if(t.databaseName!==e)return void i.zsymb(21,"pjL7C3",["Can't close invalid db: {}","Fal05B"],e);r=t}await r.closeThisDatabase(t),a=a.filter((t=>t!==e)),0===a.length?i.zsymb(0,"Hybkm4","Done closing dbs"):i.zsymb(3,"t069kp",["Wait for dbs to be closed: {}","QhuMGo"],a)}))}}else r=[s.closeAllDatabases(t)];await Promise.all(r)}})||o)||o)||o)||o)||o)||o;n.ModuleContainer.registerSingleton(h.b,p);s("6Pbj"),s("EicM"),s("m+NF");var I,f=s("UGJm"),b=s("Y58e"),M=s("hI9i"),y=s("q1tI"),w=s.n(y),v=s("/MKj"),S=s("ClHk");function _(){const{data:e}=Object(M.k)(S.a,"all");return 0===e.length?w.a.createElement("div",null,"No Tasks"):w.a.createElement("table",null,w.a.createElement("thead",null,w.a.createElement("tr",null,w.a.createElement("th",null,"ID"),w.a.createElement("th",null,"Type"),w.a.createElement("th",null,"Status"),w.a.createElement("th",null,"Process"),w.a.createElement("th",null))),w.a.createElement("tbody",null,e.map((e=>w.a.createElement(E,{key:e,id:e})))))}function E(e){const t=Object(M.j)(S.a,e.id);return t?w.a.createElement("tr",null,w.a.createElement("td",null,t.id),w.a.createElement("td",null,t.type),w.a.createElement("td",null,t.status),w.a.createElement("td",null,t.progress),w.a.createElement("td",null,new Date(t.startTime).toLocaleString())):null}function T(){return w.a.createElement(v.a,{store:M.b,context:M.a},w.a.createElement(_,null))}Object(n.injectable)()(I=Object(n.singleton)(c.a)(I=function(e,t){return Object(n.inject)(b.a)(e,void 0,0)}(I=function(e,t){return Object(n.inject)(m.ZLoggerFactory)(e,void 0,1)}(I=Reflect.metadata("design:type",Function)(I=Reflect.metadata("design:paramtypes",[void 0===b.a?Object:b.a,void 0===m.ZLoggerFactory?Object:m.ZLoggerFactory])(I=class extends f.a{constructor(e,t){super("zalo",e,t,{component:T,container:document.getElementById("app")})}})||I)||I)||I)||I)||I);s("KszJ"),s("Hbak"),s("dhzt"),s("O6t0");var D=s("3jnX"),N=s("qUG6"),O=s("19h1"),C=s("R5gT"),L=s("4prX"),k=s("KP/S");class R extends D.b{constructor(e){super({type:"REQUEST_NOISE_ID",params:e})}}class F extends D.b{constructor(){super({type:"REQUEST_ALL_NOISE_ID",params:{}})}}var A=s("Hy6w"),G=s("h0S/");var U,Q=new class{constructor(){this._writeMsgs=new A.a("writeMsgs"),this._writeFileRes=new A.a("writeFileRes"),this._writeMedia=new A.a("writeMedia"),this._convertVersion=new A.a("convertVersion"),this._readSQL=new A.a("readSQL"),this._denoiseId=new A.a("denoiseId"),this._normalMsg=new A.a("normalMsg"),this._countMsg=new A.a("countMsg"),this._indexSearch=new A.a("indexSearch"),this._mediaRes=new A.a("mediaRes"),this._filterExists=new A.a("filterExists"),this._total=new A.a("totalRestoreMsg"),this.logger=void 0,this.writeMsgs=void 0,this.convertVersion=void 0,this.readSQL=void 0,this.denoiseId=void 0,this.writeFileRes=void 0,this.writeMedia=void 0,this.normalMsg=void 0,this.countMsg=void 0,this.indexSearch=void 0,this.mediaRes=void 0,this.filterExists=void 0,this.total=void 0,this.trackHolder=void 0,this.tracker=void 0,this.writeMsgs=this._writeMsgs.getTracker(),this.convertVersion=this._convertVersion.getTracker(),this.readSQL=this._readSQL.getTracker(),this.denoiseId=this._denoiseId.getTracker(),this.writeFileRes=this._writeFileRes.getTracker(),this.writeMedia=this._writeMedia.getTracker(),this.normalMsg=this._normalMsg.getTracker(),this.countMsg=this._countMsg.getTracker(),this.indexSearch=this._indexSearch.getTracker(),this.total=this._total.getTracker(),this.mediaRes=this._mediaRes.getTracker(),this.filterExists=this._filterExists.getTracker(),this.trackHolder=[this._writeMsgs,this._convertVersion,this._readSQL,this._denoiseId,this._writeFileRes,this._writeMedia,this._mediaRes,this._normalMsg,this._countMsg,this._indexSearch,this._filterExists,this._total],this.tracker=[this.writeMsgs,this.convertVersion,this.readSQL,this.denoiseId,this.writeFileRes,this.writeMedia,this.mediaRes,this.normalMsg,this.countMsg,this.indexSearch,this.filterExists,this.total],this.lock();const e=n.ModuleContainer.resolve(m.ZLoggerFactory);this.logger=e.createZLogger(G.ZLoggerNametags.msgSync,[G.ZLoggerNametags.syncMetrics])}lock(){this.trackHolder.forEach((e=>e.lock()))}unlock(){this.trackHolder.forEach((e=>e.unlock()))}reset(){this.tracker.forEach((e=>e.reset()))}print(){let e=0;this.trackHolder.forEach((t=>{"totalRestoreMsg"!==t.label&&(e+=t.time)})),this.logger.zsymb(0,"aaNoHv","ph7 total, track, untrack: ",this._total.time,e,this._total.time-e),this.trackHolder.forEach((e=>{this.logger.zsymb(0,"quwK-S",`ph7 ${e.info}`)}))}getSnapShot(){const e={};return this.trackHolder.forEach((t=>{e[t.label]=t.time})),e}};let q=Object(n.singleton)()(U=Object(n.injectable)()(U=class{constructor(){this.userId="",this.cache=new Map}async init(e){this.userId!==e&&(this.userId=e,this.cache=new Map,await this.tryToFetchCachedNoiseId())}async tryToFetchCachedNoiseId(){try{const e=new F,t=await e.run();t.length>0&&(this.cache=new Map(t))}catch(e){}}get(e){if(e)return this.cache.get(e.toString())}async import(e){return Q.denoiseId.start(),this._getNoiseId(e.uids||[],e.gids||[]).then((e=>(Q.denoiseId.end(),e)))}async _getNoiseId(e,t){const s=e.filter((e=>!this.cache.has(e)&&Number.parseInt(e).toString()===e)),i=t.filter((e=>!this.cache.has(e)&&Number.parseInt(e).toString()===e));if(s.length!==e.length||i.length!==t.length){const r=e.length-s.length+t.length-i.length;L.default.increaseFailed(k.f.REQ_NOISE_ID,1,r,k.d.INVALID_NOISE_ID,Date.now())}await this._requestNoiseId(s,i)}_requestNoiseId(e,t){return new Promise(((s,i)=>{setTimeout((()=>{i("_requestNoiseId timeout")}),1e4);new R({uids:e,gids:t}).run().then((e=>{e.forEach((([e,t])=>{this.cache.set(e,t)})),s(!0)})).catch(i)}))}})||U)||U;var B=s("1pet"),j=s("z0WU"),x=s("/Bne"),P=s("1qqm"),z=s("8s2m");let $=new P.b(P.a);var V=s("fqRP"),W=s("s2Ee"),Z=s("PoHQ"),Y=s("bUXd"),H=s("EYv5"),K=s("v6qY");const X={shouldUseNewMediaDBConfig:1};function J(){return X.shouldUseNewMediaDBConfig}function ee(e){X.shouldUseNewMediaDBConfig=e}var te,se=s("NDmK"),ie=s("igA5"),re=s("/YHU");let ne=Object(n.injectable)()(te=function(e,t){return Object(n.inject)(m.ZLoggerFactory)(e,void 0,0)}(te=function(e,t){return Object(n.inject)(V.a)(e,void 0,1)}(te=Reflect.metadata("design:type",Function)(te=Reflect.metadata("design:paramtypes",[void 0===m.ZLoggerFactory?Object:m.ZLoggerFactory,void 0===V.a?Object:V.a])(te=class{constructor(e,t){this.readyToInsertMsgsQueue=[],this.idStore=void 0,this.coreDB=null,this.resDB=null,this.ttl=void 0,this.logger=void 0,this.checkSum=new Set,this.checkSum2=new Set,this.waitForNoiseId=[],this.noiseIdQueue=[],this.waitForGlobalId=[],this.lastInsertedMsgId=Date.now(),this.uid="",this.idStore=n.ModuleContainer.resolveToken(q),this.logger=e.createZLogger("sync-message",["msg-cross-importer"]),this.ttl=t}async open(e,t){await this.close(),this.uid=e,Z.p.setSessionUserId(e),n.ModuleContainer.resolve(h.b).authenticate({userId:e,UIN:t}),this.checkSum=new Set,this.checkSum2=new Set;const s=g.default.getInstance();this.coreDB=s.Core,this.resDB=s.Res,this.waitForGlobalId=[]}close(){this.coreDB&&(this.coreDB=null),this.resDB&&(this.resDB=null)}queueNewMessages(e){let t=this.verifyCrossMsg(e);this.readyToInsertMsgsQueue=this.readyToInsertMsgsQueue.concat(t.readyToInsert),this.waitForNoiseId=this.waitForNoiseId.concat(t.waitForNoiseId),this.noiseIdQueue=this.noiseIdQueue.concat(t.idsToGetNoise)}resetLastGlobalMsgId(){this.lastInsertedMsgId=Date.now()}async processImportQueue(e){if((e||this.shouldProcessMsgsInWaitForNoiseQueue())&&await this.processWaitForNoiseIdQueue(),(e&&0===this.readyToInsertMsgsQueue.length||this.waitForGlobalId.length>99)&&this.waitForGlobalId.length>0){const e=[];this.processWaitForGlobalIdQueue(e),e.length>0&&(this.queueNewMessages(e),await this.processWaitForNoiseIdQueue())}if(this.readyToInsertMsgsQueue.length){const e=this.readyToInsertMsgsQueue.splice(0,2e3);let s=Math.min(...e.map((e=>e.sequenseId)));s=Math.max(s,this.waitForGlobalId.length?this.waitForGlobalId[0].sequenseId:0,this.waitForNoiseId.length?this.waitForNoiseId[0].sequenseId:0);try{const t=[];this.crossMsgsToNormalMsgs(e,t);return{inserted:(await this.insertToDb(t)).success,minSeqId:s,queued:e,validMsgCount:t.length,hasMore:this.waitForNoiseId.length>0||this.waitForGlobalId.length>0}}catch(t){this.logger.zsymb(18,"JyTDCG",(()=>["processImportQueue error",{error:t}]))}return{inserted:[],minSeqId:s,queued:e,validMsgCount:e.length,hasMore:this.waitForNoiseId.length>0||this.waitForGlobalId.length>0}}return{inserted:[],minSeqId:-1,queued:[],validMsgCount:0,hasMore:this.waitForNoiseId.length>0||this.waitForGlobalId.length>0}}printChecksum(){this.logger.zsymb(12,"4Vc6cw",(()=>["size",{waitNoise:this.waitForNoiseId,waitGlobal:this.waitForGlobalId,ready:this.readyToInsertMsgsQueue}])),this.checkSum.size>0?this.logger.zsymb(18,"1MfUxb",(()=>["checkSum.size > 0",{miss:this.checkSum.values()}])):this.logger.zsymb(3,"edFDXl",["checkSum.size == 0","3fM7Bb"])}processWaitForGlobalIdQueue(e){const t=this.waitForGlobalId;this.waitForGlobalId=[],this.lastInsertedMsgId=t[0].cliMsgId;for(let s=t.length-1;s>=0;s--){const i=t[s];i.globalMsgId=`${this.lastInsertedMsgId}_${s.toString().padStart(3,"0")}`,e.push(i)}}async insertMsgs(e){e=e.filter((e=>!!e.globalMsgId));let t=this.verifyCrossMsg(e).idsToGetNoise;t.length&&await this.idStore.import({uids:t});let s=[];return this.crossMsgsToNormalMsgs(e,s),this.insertToDb(s)}async processWaitForNoiseIdQueue(){if(0===this.noiseIdQueue.length)return;const e=this.noiseIdQueue,t=this.waitForNoiseId;this.waitForNoiseId=[],this.noiseIdQueue=[],await this.idStore.import({uids:e}),this.readyToInsertMsgsQueue.push(...t)}shouldProcessMsgsInWaitForNoiseQueue(){return this.noiseIdQueue.length>=1e3||this.waitForNoiseId.length>150}crossMsgsToNormalMsgs(e,t){Q.normalMsg.start();for(let i=0;i<e.length;i++){const r=e[i];try{if("number"==typeof r.globalMsgId&&r.globalMsgId>0&&(this.lastInsertedMsgId=r.globalMsgId,this.waitForGlobalId.length>0)){const e=this.waitForGlobalId;this.waitForGlobalId=[];for(let s=e.length-1;s>=0;s--){const i=e[s];i.globalMsgId=`${r.globalMsgId}_${s.toString().padStart(3,"0")}`,this.crossMsgToNormalMsg(i,t)}}this.crossMsgToNormalMsg(r,t)}catch(s){}}Q.normalMsg.end()}crossMsgToNormalMsg(e,t){if(!e.globalMsgId)return void this.waitForGlobalId.push(e);const s=e.parsedType||j.default.normalizeMessageType(e.type);if(s===B.MSG_UNKNOWN)return void 0;let i=e.parsedIdTo||this.idStore.get(e.ownerId),r=e.parsedUidFrom||e.fromId==e.userId?"0":this.idStore.get(e.fromId);if(!r||!i)return void 0;let n=e.msg,a=e.attachData;switch(a.mentions&&Array.isArray(a.mentions)&&a.mentions.forEach((e=>{e.uid="-1"===e.uid?"-1":this.idStore.get(e.uid)})),a.quote&&(a.quote.ownerId=this.idStore.get(a.quote.ownerId)),s){case B.MSG_TEXT:a&&a.attach&&a.attach.action&&"rtf"==a.attach.action&&(a.attach.title||(a.attach.title=e.msg),n=a.attach);break;case B.MSG_PHOTO:n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action),n.description=l(n.description),n.title=l(n.title),n.type=l(n.type);break;case B.MSG_STICKER:n=a.attach||{};break;case B.MSG_GIF:n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action),n.description=l(n.description),n.title=l(n.title),n.type=l(n.type);break;case B.MSG_VOICE:n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action),n.description=l(n.description),n.params=l(n.params),n.thumb=l(n.thumb),n.title=l(n.title),n.type=l(n.type);break;case B.MSG_VIDEO:n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action),n.description=l(n.description),n.type=l(n.type);break;case B.MSG_LOCATION:n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action),n.href=l(n.href),n.thumb=l(n.thumb),n.type=l(n.type);break;case B.MSG_DOODLE:n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action),n.description=l(n.description),n.thumb=l(n.thumb),n.title=l(n.title);break;case B.MSG_CONTACT:n=a.attach||{},n.description=l(n.description),n.thumb=l(n.thumb);const t=n.action;"recommened.user"!==t&&"recommened.vip"!==t||(n.params=this.idStore.get(n.params));break;case B.MSG_FILE:n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action),n.description=l(n.description),n.thumb=l(n.thumb),n.type=l(n.type);break;case B.MSG_UNDO:n="";break;case B.MSG_OA:case B.MSG_ECARD:case B.MSG_POLL:n=a.attach;break;case B.MSG_ZINSTANT_OLD:case B.MSG_ZINSTANT:if(!a.attach||!a.attach.params||-1==a.attach.params.indexOf("pcItem"))return void this.logger.zsymb(0,"QD7xbH","Skip invalid zinstant",null==e?void 0:e.globalMsgId);n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action,""),n.description=l(n.description,""),n.title=l(n.title,""),n.href=l(n.href,""),n.thumb=l(n.thumb,""),n.params=l(n.params),delete n.childNumber}let o=null;if("chat.undo"==e.type&&e.attach)try{if(a.attach&&a.attach.params){let t=JSON.parse(a.attach.params).custom_message;if(t){t=JSON.parse(t);const s=t.highLightsV2;s.length&&(o=s[0]&&s[0].uid,o=this.idStore.get(o),o=o==this.uid?"0":o,e.type="chat.delete.everyone")}}}catch(h){this.logger.zsymb(18,"rtN6nR",(()=>["parseParams error:",{error:h}]))}const c={msgId:e.globalMsgId,cliMsgId:e.cliMsgId,msgType:e.type,status:"0"==r?B.MSG_DELIVERED:B.MSG_READ,notify:"1",mentions:a.mentions,quote:a.quote,content:n,ts:e.ts.toString(),uidFrom:r,dName:e.fromName,propertyExt:a.property,ttl:e.ttl};a.reference&&(c.reference=a.reference);const d=x.a.transformMessageFromServer(c,i);function l(e,t=""){return e instanceof Object&&Object.keys(e).length?t:e||t}d.localDttm=Date.now(),d.src=B.MSG_SRC.SYNC_MOBILE_DB,d.sequenceId=e.sequenseId,d.uidSenderDel=o,d.msgType!==B.MSG_UNKNOWN?t.push(d):this.logger.zsymb(0,"LMo2CF",(()=>["skip message: unknown type",{id:d.cliMsgId,type:e.type}]))}verifyCrossMsg(e){const t=[],s=[],i=new Set;for(let o=0;o<e.length;o++){var r,n;const c=e[o];if(!c)continue;let d=!1;const l=e=>{e&&"-1"!==(e=e.toString())&&(this.idStore.get(e)||(d||(d=!0,t.push(c)),i.add(e)))};if(l(c.ownerId),l(c.fromId),!c.attachData){let e={};if(c.attach)try{e=JSON.parse(c.attach)}catch(a){}c.attachData=e}const h=c.attachData,u=null===(r=h.attach)||void 0===r?void 0:r.action;"recommened.user"!==u&&"recommened.vip"!==u||null===(n=h.attach)||void 0===n||!n.params||l(h.attach.params),h.mentions&&Array.isArray(h.mentions)&&h.mentions.forEach((e=>{l(e.uid)})),h.quote&&l(h.quote.ownerId),d||s.push(c)}return{waitForNoiseId:t,readyToInsert:s,idsToGetNoise:Array.from(i)}}async insertToDb(e){e=await this._filterDeletedMessages(e);const t=await this._insertMessage(e);return Q.mediaRes.start(),await Promise.all([this._insertMedia(t.success),this._insertFilesToResDB(t.success)]),Q.mediaRes.end(),await this._insertTTL(t.success),this._sendMediaMsgToMain(t.success),t}_insertMedia(e){Q.writeMedia.start();const t=`${K.c.TRANSFER_MOBILE}${K.d.FROM_MSG}`;return n.ModuleContainer.resolve(H.a).addMediasWhenTransferMessage(e,t,J()).then((e=>(Q.writeMedia.end(),e)))}_insertFilesToResDB(e){Q.writeFileRes.start();const t=e.reduce(((e,t)=>(t.msgType===B.MSG_FILE&&e.push({msgId:t.msgId,userId:t.toUid,message:t.message,sendDttm:t.sendDttm,fromUid:t.fromUid,type:"file",cliMsgId:t.cliMsgId}),e)),[]);return(async(e,t)=>{try{let s=[],i=[];for(let e of t){const{res:t,ref:r,error:n}=$.toDb(e);n||(s.push(t),i.push(r))}s.length>0&&await e.Res.insertMulti(s),i.length>0&&await e.Ref.insertMulti(i)}catch{}})(this.resDB,t).then((e=>(Q.writeFileRes.end(),e)))}async _insertTTL(e){const t=e.filter((e=>e.ttl&&e.ttl>0)),s=W.b.createFromUid(this.uid).deriveTTLItems(t);if(t.length<=0)return;const i=await this.ttl.putMsgs(s);i.ok?this.logger.zsymb(3,"fvRZF9",["ttl insert success","2JG3Gc"]):(this.logger.zsymb(21,"LatGzt",["ttl insert fail","8VcPXf"]),this.logger.zsymb(3,"MyztLp",["ttl invalid {}, error {}","o5FDW3"],i.error.invalidItems.length,i.error.errorItems.length))}async _insertMessage(e){Q.writeMsgs.start();const t=new Map;e.forEach((e=>{t.has(e.toUid)?t.get(e.toUid).push(e):t.set(e.toUid,[e])}));const s=[];return t.forEach(((e,t)=>{s.push(this.coreDB.Message.insertMulti(e,{replace:!1,partition:t}))})),Promise.all(s).then((e=>(Q.writeMsgs.end(),e.reduce(((e,t)=>(e.success.push(...t.success),e.fail.push(...t.fail),e)),{success:[],fail:[]}))))}async _filterExistsMessages(e){if(!e||!e.length)return[];const t={};e.forEach((({msgId:e,toUid:s})=>{void 0===t[s]&&(t[s]=[]),t[s].push(e)}));const s=Object.entries(t).map((([e,t])=>this.coreDB.Message.getMultiIfExists(t,{partition:e}))),i=await Promise.all(s).then((e=>e.flat())),r=new Set(i.map((e=>e&&e.msgId)));return e.filter((e=>!r.has(e.msgId)))}_sendMediaMsgToMain(e){if(!j.default.isWeb()){const t=ie.default.getInstance().getItem(B.KEY_CONFIG_TRANSFER_AUTODL),{validDays:s}=t&&Object(re.a)(t),i=24*(s||se.default.auto_download_media_transfered.validDays)*60*60*1e3,r=e.filter((e=>this._isMediaMsg(e)&&!this._isAIStickerMessage(e)&&!this._isPhotoStickerMessage(e)&&this._isValidTime(e,i)));Array.isArray(r)&&r.length>0&&$zFeatures.transfer.notifyReceiveMediaMsgs(r)}}_isMediaMsg(e){var t;const s=e.msgType;if(s===B.MSG_CONTACT&&"recommened.link"===(null===(t=e.message)||void 0===t?void 0:t.action))return!0;return[B.MSG_PHOTO,B.MSG_PHOTO_2,B.MSG_DOODLE,B.MSG_FILE,B.MSG_VOICE,B.MSG_VIDEO].includes(s)}_isAIStickerMessage(e){return!1}_isPhotoStickerMessage(e){return!1}_isValidTime(e,t){const s=+e.sendDttm;return!(Y.default.getTimeNow()-s>=t)}async _filterDeletedMessages(e){let t={},s=[];for(let n=0;n<e.length;n++){const i=e[n];i.msgType==B.MSG_UNDO?s.push(i):(t[i.toUid]||(t[i.toUid]=[]),t[i.toUid].push(i))}await this._sendUndo(s);let i=Object.keys(t);const r=[];for(let n=0;n<i.length;n++){const e=i[n];r.push(...t[e])}return r}async _sendUndo(e){}})||te)||te)||te)||te)||te;class ae{constructor(e){this.noiseIdStore=void 0,this.importer=void 0,this.session=null,this.logger=void 0,this._searchIndexQueue=null,this.noiseIdStore=n.ModuleContainer.resolveToken(q),this.importer=n.ModuleContainer.resolveToken(ne);const t=n.ModuleContainer.resolve(m.ZLoggerFactory);this.logger=t.createZLogger("msg-sync",["importer",e])}async restoreConversations(e){const t=e.params.noiseUserId,s=e.params.password,i=this.doRestoreConversations.bind(this,e);return this.usingDatabase(t,s,i)}async restoreMessages(e){const t=e.params.noiseUserId,s=e.params.password,i=this.doRestoreMessages.bind(this,e);return this.usingDatabase(t,s,i)}async usingDatabase(e,t,s){let i,r;await this.noiseIdStore.init(e),await this.open(e,t);try{i=await s()}catch(n){r=n}if(await this.close(),r)throw r;return i}async open(e,t){await this.importer.close(),this.session={userId:e,UIN:t},await this.importer.open(e,t)}async close(){await this.importer.close()}indexSearch(e,t){if(t.queueIndexSearch)return this.searchIndexQueue.queueIdxs(e);return C.a.getInstance().executeMessageDbData(e)}get searchIndexQueue(){var e,t,s,i;this._searchIndexQueue||(null!==(e=this.session)&&void 0!==e&&e.userId&&null!==(t=this.session)&&void 0!==t&&t.UIN&&n.ModuleContainer.resolve(h.b).authenticate({userId:null===(s=this.session)||void 0===s?void 0:s.userId,UIN:null===(i=this.session)||void 0===i?void 0:i.UIN}),this._searchIndexQueue=new O.a);return this._searchIndexQueue}}class oe extends ae{constructor(){super("format-0"),this._backup=null,this._Logger=void 0}get Logger(){return this._Logger||(this._Logger=n.ModuleContainer.resolve(m.ZLoggerFactory).createZLogger("sync-msg",["import-format1"])),this._Logger}async doRestoreConversations(e){const{params:t,abort:s}=e,i=await this.getBackup(t.backupPath),r=await i.getAllConversations(),n=await i.getRespondedConversations(),a=new Set(n.map((e=>e.ownerId))),o=[],c=[];if(r.forEach((e=>{1===e.ownerType?o.push(e.ownerId):c.push(e.ownerId)})),await this.noiseIdStore.import({gids:o,uids:c}),s.aborted)throw new Error("aborted");const d=await i.getLastMsgForEachConversations();if(s.aborted)throw new Error("aborted");let l=await this.importer.insertMsgs(d);const h={},u=[],g=[];return r.forEach((e=>{const t=this.noiseIdStore.get(e.ownerId);if(t){const s=1===e.ownerType,i={plainId:e.ownerId,noisedId:t,isGroup:s,respondedByMe:a.has(e.ownerId),backupPath:""};u.push(i),h[t]=i}else g.push(e.ownerId)})),l.success.forEach((e=>{h[e.toUid]&&(h[e.toUid].lastMessage=e)})),l.fail.forEach((e=>{h[e.toUid]&&(h[e.toUid].lastMessage=e)})),u}async doRestoreMessages(e){const{params:t,checkpoint:s,abort:i,report:r}=e;if(!s||0!==s.format)throw new Error("invalid checkpoint");const n=new Map(t.conversations.filter((e=>!e.hasPreviewMsg)).map((e=>[e.noiseId,void 0]))),a=t.conversations.filter((e=>e.shouldIgnore)).map((e=>e.plainId));let o=s.currentSeq,c=s.maxSeq,d=s.minSeq,l=s.syncedConversations,h=0,u=s.syncedMessages||0;const g=await this.getBackup(t.backupPath),m=await g.countMessageFrom(d,a);let p=await g.countMessageFrom(o,a),I=m,f=!1;for(;;){if(i.aborted)return{trackInfo:{}};let e=await g.getMessages(o,d,a,100);if(0===e.length)I=0;else{e[0].sequenseId>c&&(c=e[0].sequenseId);for(let t=e.length-1;t>=0;t--){const s=e[t].sequenseId;if(s<o){o=s;break}}this.importer.queueNewMessages(e),I-=e.length}let s=await this.importer.processImportQueue(f);if(0===s.queued.length){if(s.hasMore){f=!0;continue}}else f=!1;if(0===s.queued.length&&0===I){(0===d||d>o)&&(d=o);return r(100,{format:0,minSeq:d,maxSeq:c,currentSeq:o,syncedMessages:u,syncedConversations:l}),{trackInfo:{}}}let b=new Map;for(let t=0;t<s.inserted.length;t++){const e=s.inserted[t];if(n.has(e.toUid)){const t=n.get(e.toUid);(!t||t<e.sequenceId)&&(b.set(e.toUid,e),n.set(e.toUid,e.sequenceId))}}if(b.size>0){u+=b.size;const e=new N.a(Array.from(b.values()));await e.run()}p+=s.validMsgCount;const M=p/m,y=Math.round(95*M);y!==h&&(h=y,s.minSeqId>0&&(this.Logger.zsymb(3,"GydqZu",["checkpoint: {} {}/{} ({}%)","mVQA3L"],s.minSeqId,p,m,y),r(y,{format:0,minSeq:d,maxSeq:c,currentSeq:o,syncedMessages:u,syncedConversations:l}))),await this.indexSearch(s.inserted,{queueIndexSearch:t.meta.queueIndexSearch}),await new Promise((e=>setTimeout(e,50)))}}async close(){return this._backup&&await this._backup.close(),super.close()}async getBackup(e){return this._backup||(this._backup=new ce(e),await this._backup.open()),this._backup}}class ce{constructor(e){this._db=void 0,this._db=$zsqlite.createConnection(e,{OPEN_CREATE:!0,OPEN_READWRITE:!0})}close(){return this._db.close()}async open(){await this._db.open(),await this._db.runQuery(le),await this._db.runQuery(he)}async getLastMsgForEachConversations(){return this._db.getAllStatementResult(ue)}async getAllConversations(){return(await this._db.getAllQuery(pe)).filter((e=>/^\d+$/.test(e.ownerId)))}async getRespondedConversations(){return this._db.getAllQuery(Ie)}async getMessages(e,t,s,i){return this._db.getAllStatementResult(ge,[e,t,s.join(","),i])}async countMessageFrom(e,t){const s=await this._db.getStatementResult(me,[e,t.join(",")]);return s?s.count:0}}const de='type != "chat.webcontent" AND type != "chat.livelocation" AND type != "chat.video.live.msg"',le='CREATE INDEX IF NOT EXISTS "sequenseId" ON "chats" ("sequenseId" DESC)',he='CREATE INDEX IF NOT EXISTS "ts" ON "chats" ("ts" DESC)',ue=`SELECT chats.* FROM chats INNER JOIN (SELECT ownerId, MAX(ts) as maxTs from chats WHERE ${de} GROUP BY ownerId) AS latest ON chats.ts = latest.maxTs ORDER BY chats.ts DESC`,ge=`SELECT * FROM chats WHERE sequenseId < (?) AND sequenseId > (?) AND cliMsgId NOT NULL AND ownerId NOT IN (?) AND ${de} ORDER BY sequenseId DESC LIMIT (?)`,me=`SELECT count(*) as count FROM chats WHERE sequenseId > (?) AND cliMsgId NOT NULL AND ownerId NOT IN (?) AND ${de} ORDER BY sequenseId DESC`,pe="SELECT ownerId, ownerType, ts  FROM threads",Ie="SELECT DISTINCT ownerId from chats WHERE userId = fromId";class fe extends D.b{constructor(e){super({type:"RELOAD_MESSAGE",params:e})}}class be extends D.b{constructor(e){super({type:"RELOAD_MEDIA",params:e})}}class Me{constructor(){this._searchIndexQueue=null,this.session=null}static instance(){return this._instance||(this._instance=new this),this._instance}init(e){this.session=e}indexSearch(e,t){if(t.queueIndexSearch)return this.searchIndexQueue.queueIdxs(e);return C.a.getInstance().executeMessageDbData(e)}get searchIndexQueue(){var e,t,s,i;this._searchIndexQueue||(null!==(e=this.session)&&void 0!==e&&e.userId&&null!==(t=this.session)&&void 0!==t&&t.UIN&&n.ModuleContainer.resolve(h.b).authenticate({userId:null===(s=this.session)||void 0===s?void 0:s.userId,UIN:null===(i=this.session)||void 0===i?void 0:i.UIN}),this._searchIndexQueue=new O.a);return this._searchIndexQueue}}Me._instance=void 0;class ye{constructor(){this.readyToInsertMsgsQueue=[],this.idStore=void 0,this.ttl=void 0,this.logger=void 0,this.database=void 0,this.checkSum=new Set,this.checkSum2=new Set,this.waitForNoiseId=[],this.noiseIdQueue=[],this.waitForGlobalId=[],this.lastInsertedMsgId=Date.now(),this.uid="";const e=n.ModuleContainer.resolve(m.ZLoggerFactory);this.idStore=n.ModuleContainer.resolveToken(q),this.logger=e.createZLogger("sync-message",["msg-cross-importer"]),this.ttl=n.ModuleContainer.resolve(V.a),this.database=null}async open(e,t){await this.close(),this.uid=e,Z.p.setSessionUserId(e),this.checkSum=new Set,this.checkSum2=new Set,n.ModuleContainer.resolve(h.b).authenticate({userId:e,UIN:t}),this.database=n.ModuleContainer.resolve(z.b),this.database.authenticate({userId:e,UIN:t}),this.waitForGlobalId=[]}close(){n.ModuleContainer.resolve(z.b).close()}queueNewMessages(e){let t=this.verifyCrossMsg(e);this.readyToInsertMsgsQueue=this.readyToInsertMsgsQueue.concat(t.readyToInsert),this.waitForNoiseId=this.waitForNoiseId.concat(t.waitForNoiseId),this.noiseIdQueue=this.noiseIdQueue.concat(t.idsToGetNoise)}resetLastGlobalMsgId(){this.lastInsertedMsgId=Date.now()}async processImportQueue(e){if((e||this.shouldProcessMsgsInWaitForNoiseQueue())&&await this.processWaitForNoiseIdQueue(),(e&&0===this.readyToInsertMsgsQueue.length||this.waitForGlobalId.length>99)&&this.waitForGlobalId.length>0){const e=[];this.processWaitForGlobalIdQueue(e),e.length>0&&(this.queueNewMessages(e),await this.processWaitForNoiseIdQueue())}if(this.readyToInsertMsgsQueue.length){const e=this.readyToInsertMsgsQueue.splice(0,2e3);let s=Math.min(...e.map((e=>e.sequenseId)));s=Math.max(s,this.waitForGlobalId.length?this.waitForGlobalId[0].sequenseId:0,this.waitForNoiseId.length?this.waitForNoiseId[0].sequenseId:0);try{const t=[];this.crossMsgsToNormalMsgs(e,t);return{inserted:(await this.insertToDb(t)).success,minSeqId:s,queued:e,validMsgCount:t.length,hasMore:this.waitForNoiseId.length>0||this.waitForGlobalId.length>0}}catch(t){this.logger.zsymb(18,"Z51bil",(()=>["processImportQueue error",{error:t}]))}return{inserted:[],minSeqId:s,queued:e,validMsgCount:e.length,hasMore:this.waitForNoiseId.length>0||this.waitForGlobalId.length>0}}return{inserted:[],minSeqId:-1,queued:[],validMsgCount:0,hasMore:this.waitForNoiseId.length>0||this.waitForGlobalId.length>0}}printChecksum(){this.logger.zsymb(12,"Bs5LlD",(()=>["size",{waitNoise:this.waitForNoiseId,waitGlobal:this.waitForGlobalId,ready:this.readyToInsertMsgsQueue}])),this.checkSum.size>0?this.logger.zsymb(18,"t0wIRQ",(()=>["checkSum.size > 0",{miss:this.checkSum.values()}])):this.logger.zsymb(3,"U_sf4m",["checkSum.size == 0","3fM7Bb"])}processWaitForGlobalIdQueue(e){const t=this.waitForGlobalId;this.waitForGlobalId=[],this.lastInsertedMsgId=t[0].cliMsgId;for(let s=t.length-1;s>=0;s--){const i=t[s];i.globalMsgId=`${this.lastInsertedMsgId}_${s.toString().padStart(3,"0")}`,e.push(i)}}async insertMsgs(e){e=e.filter((e=>!!e.globalMsgId));let t=this.verifyCrossMsg(e).idsToGetNoise;t.length&&await this.idStore.import({uids:t});let s=[];return this.crossMsgsToNormalMsgs(e,s),this.insertToDb(s)}async processWaitForNoiseIdQueue(){if(0===this.noiseIdQueue.length)return;const e=this.noiseIdQueue,t=this.waitForNoiseId;this.waitForNoiseId=[],this.noiseIdQueue=[],await this.idStore.import({uids:e}),this.readyToInsertMsgsQueue.push(...t)}shouldProcessMsgsInWaitForNoiseQueue(){return this.noiseIdQueue.length>=1e3||this.waitForNoiseId.length>150}crossMsgsToNormalMsgs(e,t){Q.normalMsg.start();for(let i=0;i<e.length;i++){const r=e[i];try{if("number"==typeof r.globalMsgId&&r.globalMsgId>0&&(this.lastInsertedMsgId=r.globalMsgId,this.waitForGlobalId.length>0)){const e=this.waitForGlobalId;this.waitForGlobalId=[];for(let s=e.length-1;s>=0;s--){const i=e[s];i.globalMsgId=`${r.globalMsgId}_${s.toString().padStart(3,"0")}`,this.crossMsgToNormalMsg(i,t)}}this.crossMsgToNormalMsg(r,t)}catch(s){}}Q.normalMsg.end()}crossMsgToNormalMsg(e,t){if(!e.globalMsgId)return void this.waitForGlobalId.push(e);const s=e.parsedType||j.default.normalizeMessageType(e.type);if(s===B.MSG_UNKNOWN)return void 0;let i=e.parsedIdTo||this.idStore.get(e.ownerId),r=e.parsedUidFrom||e.fromId==e.userId?"0":this.idStore.get(e.fromId);if(!r||!i)return void 0;let n=e.msg,a=e.attachData;switch(a.mentions&&Array.isArray(a.mentions)&&a.mentions.forEach((e=>{e.uid="-1"===e.uid?"-1":this.idStore.get(e.uid)})),a.quote&&(a.quote.ownerId=this.idStore.get(a.quote.ownerId)),s){case B.MSG_TEXT:a&&a.attach&&a.attach.action&&"rtf"==a.attach.action&&(a.attach.title||(a.attach.title=e.msg),n=a.attach);break;case B.MSG_PHOTO:n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action),n.description=l(n.description),n.title=l(n.title),n.type=l(n.type);break;case B.MSG_STICKER:n=a.attach||{};break;case B.MSG_GIF:n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action),n.description=l(n.description),n.title=l(n.title),n.type=l(n.type);break;case B.MSG_VOICE:n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action),n.description=l(n.description),n.params=l(n.params),n.thumb=l(n.thumb),n.title=l(n.title),n.type=l(n.type);break;case B.MSG_VIDEO:n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action),n.description=l(n.description),n.type=l(n.type);break;case B.MSG_LOCATION:n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action),n.href=l(n.href),n.thumb=l(n.thumb),n.type=l(n.type);break;case B.MSG_DOODLE:n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action),n.description=l(n.description),n.thumb=l(n.thumb),n.title=l(n.title);break;case B.MSG_CONTACT:n=a.attach||{},n.description=l(n.description),n.thumb=l(n.thumb);const t=n.action;"recommened.user"!==t&&"recommened.vip"!==t||(n.params=this.idStore.get(n.params));break;case B.MSG_FILE:n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action),n.description=l(n.description),n.thumb=l(n.thumb),n.type=l(n.type);break;case B.MSG_UNDO:n="";break;case B.MSG_OA:case B.MSG_ECARD:case B.MSG_POLL:n=a.attach;break;case B.MSG_ZINSTANT_OLD:case B.MSG_ZINSTANT:if(!a.attach||!a.attach.params||-1==a.attach.params.indexOf("pcItem"))return void this.logger.zsymb(0,"1M7lc0","Skip invalid zinstant",null==e?void 0:e.globalMsgId);n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action,""),n.description=l(n.description,""),n.title=l(n.title,""),n.href=l(n.href,""),n.thumb=l(n.thumb,""),n.params=l(n.params),delete n.childNumber}let o=null;if("chat.undo"==e.type&&e.attach)try{if(a.attach&&a.attach.params){let t=JSON.parse(a.attach.params).custom_message;if(t){t=JSON.parse(t);const s=t.highLightsV2;s.length&&(o=s[0]&&s[0].uid,o=this.idStore.get(o),o=o==this.uid?"0":o,e.type="chat.delete.everyone")}}}catch(h){this.logger.zsymb(18,"YLQ89o",(()=>["parseParams error:",{error:h}]))}const c={msgId:e.globalMsgId,zglobalMsgId:-1,cliMsgId:e.cliMsgId,msgType:e.type,status:"0"==r?B.MSG_DELIVERED:B.MSG_READ,notify:"1",mentions:a.mentions,quote:a.quote,content:n,ts:e.ts.toString(),uidFrom:r,dName:e.fromName,propertyExt:a.property,ttl:e.ttl};a.reference&&(c.reference=a.reference);const d=x.a.transformMessageFromServer(c,i);function l(e,t=""){return e instanceof Object&&Object.keys(e).length?t:e||t}d.localDttm=Date.now(),d.src=B.MSG_SRC.SYNC_MOBILE_DB,d.sequenceId=e.sequenseId,d.uidSenderDel=o,d.msgType!==B.MSG_UNKNOWN?t.push(d):this.logger.zsymb(0,"wDkv9K",(()=>["skip message: unknown type",{id:d.cliMsgId,type:e.type}]))}verifyCrossMsg(e){const t=[],s=[],i=new Set;for(let o=0;o<e.length;o++){var r,n;const c=e[o];if(!c)continue;let d=!1;const l=e=>{e&&"-1"!==(e=e.toString())&&(this.idStore.get(e)||(d||(d=!0,t.push(c)),i.add(e)))};if(l(c.ownerId),l(c.fromId),!c.attachData){let e={};if(c.attach)try{e=JSON.parse(c.attach)}catch(a){}c.attachData=e}const h=c.attachData,u=null===(r=h.attach)||void 0===r?void 0:r.action;"recommened.user"!==u&&"recommened.vip"!==u||null===(n=h.attach)||void 0===n||!n.params||l(h.attach.params),h.mentions&&Array.isArray(h.mentions)&&h.mentions.forEach((e=>{l(e.uid)})),h.quote&&l(h.quote.ownerId),d||s.push(c)}return{waitForNoiseId:t,readyToInsert:s,idsToGetNoise:Array.from(i)}}async insertToDb(e){e=await this._filterDeletedMessages(e);const t=await this._insertMessage(e);return Q.mediaRes.start(),await Promise.all([this._insertMedia(t.success),this._insertFilesToResDB(t.success)]),Q.mediaRes.end(),await this._insertTTL(t.success),this._sendMediaMsgToMain(t.success),t}_insertMedia(e){Q.writeMedia.start();const t=`${K.c.TRANSFER_MOBILE}${K.d.FROM_MSG}`;return n.ModuleContainer.resolve(H.a).addMediasWhenTransferMessage(e,t,J()).then((e=>(Q.writeMedia.end(),e)))}_insertFilesToResDB(e){Q.writeFileRes.start();const t=e.reduce(((e,t)=>(t.msgType===B.MSG_FILE&&e.push({msgId:t.msgId,userId:t.toUid,message:t.message,sendDttm:t.sendDttm,fromUid:t.fromUid,type:"file",cliMsgId:t.cliMsgId}),e)),[]);return(async(e,t)=>{try{let s=[],i=[];for(let e of t){const{res:t,ref:r,error:n}=$.toDb(e);n||(s.push(t),i.push(r))}if(s.length>0){const t=e.table(z.a.TablePath.Res);await t.insertMulti(s)}if(i.length>0){const t=e.table(z.a.TablePath.Ref);await t.insertMulti(i)}}catch{}})(this.database,t).then((e=>(Q.writeFileRes.end(),e)))}async _insertTTL(e){const t=e.filter((e=>e.ttl&&e.ttl>0)),s=W.b.createFromUid(this.uid).deriveTTLItems(t);if(t.length<=0)return;const i=await this.ttl.putMsgs(s);i.ok?this.logger.zsymb(3,"44F5vg",["ttl insert success","2JG3Gc"]):(this.logger.zsymb(21,"eRY7kg",["ttl insert fail","8VcPXf"]),this.logger.zsymb(3,"Vrotcg",["ttl invalid {}, error {}","o5FDW3"],i.error.invalidItems.length,i.error.errorItems.length))}async _insertMessage(e){Q.writeMsgs.start();const t=new Map;e.forEach((e=>{t.has(e.toUid)?t.get(e.toUid).push(e):t.set(e.toUid,[e])}));const s=[],i=this.database.table(z.a.TablePath.Message);return t.forEach(((e,t)=>{s.push(i.insertMulti(e,{partition:t}))})),Promise.all(s).then((e=>(Q.writeMsgs.end(),e.reduce(((e,t)=>(e.success.push(...t.success),e.fail.push(...t.fail),e)),{success:[],fail:[]})))).catch((e=>{throw this.logger.zsymb(18,"QF8b1t","insert msg err",e),e}))}_sendMediaMsgToMain(e){if(!j.default.isWeb()){const t=ie.default.getInstance().getItem(B.KEY_CONFIG_TRANSFER_AUTODL),{validDays:s}=t&&Object(re.a)(t),i=24*(s||se.default.auto_download_media_transfered.validDays)*60*60*1e3,r=e.filter((e=>this._isMediaMsg(e)&&!this._isAIStickerMessage(e)&&!this._isPhotoStickerMessage(e)&&this._isValidTime(e,i)));Array.isArray(r)&&r.length>0&&$zFeatures.transfer.notifyReceiveMediaMsgs(r)}}_isMediaMsg(e){var t;const s=e.msgType;if(s===B.MSG_CONTACT&&"recommened.link"===(null===(t=e.message)||void 0===t?void 0:t.action))return!0;return[B.MSG_PHOTO,B.MSG_PHOTO_2,B.MSG_DOODLE,B.MSG_FILE,B.MSG_VOICE,B.MSG_VIDEO].includes(s)}_isAIStickerMessage(e){return!1}_isPhotoStickerMessage(e){return!1}_isValidTime(e,t){const s=+e.sendDttm;return!(Y.default.getTimeNow()-s>=t)}async _filterDeletedMessages(e){let t={},s=[];for(let n=0;n<e.length;n++){const i=e[n];i.msgType==B.MSG_UNDO?s.push(i):(t[i.toUid]||(t[i.toUid]=[]),t[i.toUid].push(i))}await this._sendUndo(s);let i=Object.keys(t);const r=[];for(let n=0;n<i.length;n++){const e=i[n];r.push(...t[e])}return r}async _sendUndo(e){}}class we{constructor(e,t,s,i,r){this.session=e,this.backup=t,this.conv=s,this.lastTimetemp=i,this.abort=r,this.logger=void 0,this.msgInserted=void 0;const a=n.ModuleContainer.resolve(m.ZLoggerFactory);this.logger=a.createZLogger("msg-sync",["importerv2","format-2"]),this.msgInserted=!1,this.lastTimetemp||(this.lastTimetemp=Number.MAX_SAFE_INTEGER)}async execute(e,t){this.logger.zsymb(0,"xPo2XD",`restoring ${this.conv.plainId}, ${this.conv.noiseId}`);try{await this.doRestoreMessages(e,t)}catch(s){this.logger.zsymb(18,"m9HivO",(()=>[`restore error: ${this.conv.plainId}`,{error:s.message||s}]))}this.msgInserted&&this.reloadConversation(),this.logger.zsymb(0,"0pi1p0",`done restoring ${this.msgInserted} ${this.conv.noiseId}`)}async doRestoreMessages(e,t){const s={ownerId:this.conv.plainId,ownerType:this.conv.isGroup?1:0},i=new ye,r=await this.backup.getBackupOfConversation(s);if(!r)return void this.logger.zsymb(0,"R3Ci3O","backup not found, skip",s.ownerId);const n=await r.getFirstMessageTimeStamp();i.open(this.session.userId,this.session.UIN);let a=0,o=!1,c=0,d=!this.conv.hasPreviewMsg;Q.countMsg.start();let l=await r.countMessages(this.lastTimetemp);for(Q.countMsg.end(),i.resetLastGlobalMsgId();;){if(this.abort.aborted)return;if(l>0){let e=await(null==r?void 0:r.getMessages(this.lastTimetemp,c,2e3,s.ownerId));if(0===e.length)l=0;else{c=e[e.length-1].cliMsgId,(0===a||e[0].ts>a)&&(a=e[0].ts);for(let t=e.length-1;t>=0;t--){const s=e[t].ts;if(s<this.lastTimetemp){this.lastTimetemp=s;break}}i.queueNewMessages(e),l-=e.length}}let h=await i.processImportQueue(o);if(0===h.queued.length){if(h.hasMore){o=!0;continue}}else o=!1;if(this.msgInserted=this.msgInserted||h.inserted.length>0,0===h.queued.length&&l<=0)return i.close(),void r.close();d&&h.inserted.length>0&&(d=!1,this.reloadPreview(h)),Q.indexSearch.start(),await Me.instance().indexSearch(h.inserted,{queueIndexSearch:e}),Q.indexSearch.end(),t(h.validMsgCount,h.inserted.length,this.lastTimetemp,n,a),await new Promise((e=>setTimeout(e,10)))}}reloadConversation(){new fe({convId:this.conv.noiseId,fromTs:0,toTs:0}).run(),new be({convId:this.conv.noiseId}).run()}reloadPreview(e){let t=e.inserted[0];for(let s=1;s<e.inserted.length;s++){const i=e.inserted[s];i.sendDttm>t.sendDttm&&(t=i)}new N.a([t]).run()}}class ve{constructor(e){this.noiseIdStore=void 0,this.importer=void 0,this.session=null,this.logger=void 0,this.noiseIdStore=n.ModuleContainer.resolveToken(q),this.importer=n.ModuleContainer.resolveToken(ye);const t=n.ModuleContainer.resolve(m.ZLoggerFactory);this.logger=t.createZLogger("msg-sync",["importer",e])}async restoreConversations(e){const t=e.params.noiseUserId,s=e.params.password,i=this.doRestoreConversations.bind(this,e);return Me.instance().init(this.session),this.usingDatabase(t,s,i)}async restoreMessages(e){const t=e.params.noiseUserId,s=e.params.password,i=this.doRestoreMessages.bind(this,e);return Me.instance().init(this.session),this.usingDatabase(t,s,i)}async usingDatabase(e,t,s){let i,r;await this.noiseIdStore.init(e),await this.open(e,t);try{i=await s()}catch(n){r=n}if(await this.close(),r)throw r;return i}async open(e,t){await this.importer.close(),this.session={userId:e,UIN:t},await this.importer.open(e,t)}async close(){await this.importer.close()}}let Se=function(e){return e[e.Text=0]="Text",e[e.Doodle=2]="Doodle",e[e.Photo=3]="Photo",e[e.Photo_V2=4]="Photo_V2",e[e.Voice=6]="Voice",e[e.Sticker=10]="Sticker",e[e.Contact=12]="Contact",e[e.OA=15]="OA",e[e.Location=18]="Location",e[e.Video=19]="Video",e[e.ECard=21]="ECard",e[e.File=22]="File",e[e.Gift=23]="Gift",e[e.Webcontent=24]="Webcontent",e[e.VideoLive=25]="VideoLive",e[e.PhotoV2=31]="PhotoV2",e[e.ChatDelete=33]="ChatDelete",e[e.Undo=36]="Undo",e}({});const _e={0:"webchat",2:"chat.doodle",3:"chat.photo",4:"chat.photo",6:"chat.voice",10:"chat.sticker",12:"chat.recommended",15:"chat.list.action",18:"chat.location.new",19:"chat.video.msg",20:"webchat",22:"share.file",23:"chat.gif",24:"chat.webcontent",25:"chat.video.live.msg",26:"group.poll",31:"chat.photo",33:"chat.delete",36:"chat.undo"};var Ee=s("nhJq");const Te=$znode.nativelibs.dbUtils(),De=$znode.path;class Ne{constructor(e){this.noiseUserId=void 0,this._db=void 0,this.plainUserId=void 0,this.logger=void 0,this.noiseId=void 0,this._db=$zsqlite.createConnection(e.path,{OPEN_CREATE:!0,OPEN_READWRITE:!0}),this.logger=e.logger,this.noiseUserId=e.noiseUserId,this.plainUserId=e.plainUserId,this.noiseId=e.noiseId}close(){return this._db.close()}open(){return this._db.open()}doWithLog(e,t,...s){return t(...s).catch((t=>{throw this.logger.zsymb(18,"1AgOap",`backup: ${e}`,...s,t),t}))}async getFirstMessageTimeStamp(){const e=await this.doWithLog("getFirstMessageTimeStamp",this._db.getAllQuery,Le);return 0===e.length?0:e[0].TimeStamp}async countMessages(e){const t=[e],s=await this.doWithLog("countMessages",this._db.getStatementResult,Re,t);return s?s.count:0}async getMessages(e,t,s,i){const r=[e,t,s];Q.readSQL.start();const n=await this.doWithLog("getMessages",this._db.getAllStatementResult,ke,r);Q.readSQL.end();const a=[];return Q.convertVersion.start(),n.forEach((e=>{const t=this.convertCrossV2ToCrossV1(e);t&&a.push(t)})),Q.convertVersion.end(),this.logger.zsymb(0,"w3Kq5B",`getMessages: ${i}, old:${n.length}, new:${a.length}`),a}async hasResponsedByUser(e){const t=await this.doWithLog("hasResponsedByUser",this._db.getQuery,Fe(e));return!!t&&t.count>0}convertCrossV2ToCrossV1(e){const t=_e[e.MsgType];if(!t)return null;const s=Te.parseBinNet(e.BinNet)||{};if(s.result>0)return this.logger.zsymb(21,"fBe31n",["ParseBinNetFail","zWvxRN"],{message:s.error_message,result:s.result,innerError:s.inner_error}),null;const i=s.data;return i.attachs&&i.attachs.length>0&&i.attachs[0]&&(e.MsgType===Se.OA?i.attach=i.attachs:(i.attach=i.attachs[0],e.MsgType!==Se.Sticker&&i.attach&&delete i.attach.catId)),{fromId:e.SenderId.toString(),fromName:"",attach:"{}",attachData:i,globalMsgId:e.GlbMsgId,cliMsgId:e.CliMsgId,msg:e.MsgContent,ownerId:this.noiseId,ownerType:0,sequenseId:e.TimeStamp,ts:e.TimeStamp,ttl:e.TTL,type:t,userId:this.plainUserId}}}class Oe{constructor(e,t,s,i){this.path=e,this.plainUserId=t,this.noiseUserId=s,this.logger=i,this._responsedByMe=new Set}async open(){}async close(){}async getAllConversations(){const e=[],t=await Ee.c(this.path);for(const s of t)if(s.endsWith(".db")){const t="g"===s[0]?1:0,i=t?6:0,r=s.length-3,n=s.substring(i,r);e.push({ownerId:n,ownerType:t})}return e}async getMetaDataConversations(e){const t={},s=Date.now();for(const r of e){const e=await this.getBackupOfConversation(r);if(e)try{const i=await e.getMessages(s,0,1,r.ownerId),n=await e.countMessages(s);if(i.length>0){t[r.ownerId]={msg:i[0],numOfMsg:n};await e.hasResponsedByUser(this.plainUserId)&&this._responsedByMe.add(r.ownerId)}}catch(i){if(this.logger.zsymb(18,"JwRkkU",`read conv failure: ${i.message}`),11!==i.errno)throw i}finally{e.close()}}return t}getRespondedByMeSet(){return this._responsedByMe}async getBackupOfConversation(e){return this._getNewBackupOfConversation(e)}async _getNewBackupOfConversation(e){const t=e.ownerId,s=1===e.ownerType?`group_${t}`:t,i=De.join(this.path,`${s}.db`),r=new Ne({path:i,noiseId:t,noiseUserId:this.noiseUserId,plainUserId:this.plainUserId,logger:this.logger});return await r.open(),r}}const Ce=[20,21,25,26,29,32,34,35,45,51,52].map((e=>`MsgType != ${e}`)).join(" AND "),Le="SELECT TimeStamp FROM ChatContent ORDER BY TimeStamp ASC LIMIT 1",ke=`SELECT * FROM ChatContent WHERE TimeStamp <= (?) AND MsgStatus > 0 AND CliMsgId NOT NULL AND CliMsgId != (?) AND ${Ce} ORDER BY TimeStamp DESC LIMIT (?)`,Re=`SELECT count(*) as count FROM ChatContent WHERE TimeStamp <= (?) AND MsgStatus > 0 AND cliMsgId NOT NULL AND ${Ce}`,Fe=e=>`SELECT count(*) as count FROM ChatContent WHERE SenderId = ${e} AND MsgStatus > 0 AND ${Ce}`;var Ae=s("cfFl");class Ge extends ve{constructor(){super("format-1"),this._backup=null}async doRestoreConversations(e){Me.instance().searchIndexQueue.pause();const{params:t,abort:s}=e,i=await this._getBackup(t.backupPath,t.plainUserId,t.noiseUserId);let r=await i.getAllConversations();const n=[],a=[];if(r.forEach((e=>{1===e.ownerType?n.push(e.ownerId):a.push(e.ownerId)})),await this.noiseIdStore.import({gids:n,uids:a}),s.aborted)throw new Error("aborted");const o=await i.getMetaDataConversations(r),c=i.getRespondedByMeSet();if(s.aborted)throw new Error("aborted");r=r.filter((e=>o[e.ownerId]&&o[e.ownerId].numOfMsg>0));const d=r.map((e=>o[e.ownerId].msg)),l=await this.importer.insertMsgs(d),h={},u=[],g=[];return r.forEach((e=>{const t=this.noiseIdStore.get(e.ownerId);if(t){const s=1===e.ownerType,i={plainId:e.ownerId,noisedId:t,isGroup:s,respondedByMe:c.has(e.ownerId)};u.push(i),h[t]=i}else g.push(e.ownerId)})),l.success.forEach((e=>{h[e.toUid]&&(h[e.toUid].lastMessage=e)})),l.fail.forEach((e=>{h[e.toUid]&&(h[e.toUid].lastMessage=e)})),await Me.instance().indexSearch(l.success,{queueIndexSearch:t.meta.queueIndexSearch}),u}doRestoreMessages(e){return Me.instance().searchIndexQueue.pause(),Q.reset(),Q.unlock(),Q.total.start(),new Promise((async t=>{const{params:s,checkpoint:i,abort:r,report:n}=e,a=new Set;if(!i||1!==i.format)throw new Error("invalid checkpoint");let o=s.conversations.filter((e=>!e.shouldIgnore)),c=s.meta.viewingConversation;const d=()=>{if(c){const t=(e=c,o.find((t=>t.noiseId===e)));if(this.logger.zsymb(0,"ksZqOI",`getViewingConversation ${c} ${JSON.stringify(t)}`),t)return t}var e;return null};let l=i.priorities;function h(){if(l.length>0){const e=d();let t;if(e&&!a.has(e.plainId))c=null,t=e;else{const e=l.find((e=>!a.has(e)));t=o.find((t=>t.plainId===e))}return t}return o[0]}e.onParamsChange((e=>{e&&e.meta&&e.meta.viewingConversation&&(this.logger.zsymb(0,"_Ycwr8",`viewing conversation changed to ${e.meta.viewingConversation}`),c=e.meta.viewingConversation)}));const u=()=>Math.floor(i.syncedMessages/s.meta.numberOfMessages*95),g=await this._getBackup(s.backupPath,s.plainUserId,s.noiseUserId);let m;const p=()=>{i.syncedConversations=s.meta.numberOfConversations,n(100,i),Q.total.end(),Q.print(),a.clear(),t({trackInfo:Q.getSnapShot()})},I=()=>{if(l.length>o.length){this.logger.zsymb(0,"RBvCna","detect invalid priority conv "+(o.length-l.length));const e=new Set(o.map((e=>e.plainId))),t=[];for(let s=0;s<l.length;s++)e.has(l[s])&&t.push(l[s]);l=t,i.priorities=t}},f=()=>{if(l.length<=0||r.aborted)return void this.logger.zsymb(0,"_Reclm","done restore: ",l.length,r.aborted);const e=h();e?(a.add(e.plainId),m.push(e)):I()};m=Object(Ae.queue)((async e=>{i.syncingConversation=e.noiseId,n(u(),i);const t=new we(this.session,g,e,i.currentSeq[e.plainId],r);var a;await t.execute(s.meta.queueIndexSearch,((t,s,r,a,o)=>{i.syncedMessages+=t,i.importedMessages+=s,i.currentSeq[e.plainId]=r,0===i.maxSeq?i.maxSeq=o:i.maxSeq=Math.max(i.maxSeq,o),0===i.minSeq?i.minSeq=a:i.minSeq=Math.min(i.minSeq,a),n(u(),i)})),delete i.currentSeq[e.plainId],t.msgInserted&&(i.updatedConversation++,n(u(),i)),a=e,l=l.filter((e=>e!==a.plainId)),i.priorities=l.filter((e=>e!==a.plainId)),o=o.filter((e=>e.noiseId!==a.noiseId)),f()}),5),I(),h()?m.drain=p:p();for(let e=0;e<=5;e++)f()}))}async close(){return this._backup&&await this._backup.close(),super.close()}async _getBackup(e,t,s){return this._backup||(this._backup=new Oe(e,t,s,this.logger),await this._backup.open()),this._backup}}function Ue(e){try{if(0===e)return new oe;if(1===e)return new Ge}catch(t){throw t}throw new Error(`Unsupported format: ${e}`)}var Qe;Object(c.j)()(Qe=Object(n.injectable)()(Qe=class extends D.a{getType(){return"RESTORE_CONVERSATIONS"}async execute(e){if(e.abort.aborted)return Promise.reject(new Error("Aborted"));const t=Ue(e.params.format);return ee(e.params.shouldUseNewMediaDBFlowConfig),t.restoreConversations(e)}})||Qe);var qe;Object(c.j)()(qe=Object(n.injectable)()(qe=class extends D.a{getType(){return"RESTORE_MESSAGES"}async execute(e){if(e.abort.aborted)return Promise.reject(new Error("Aborted"));const t=Ue(e.params.format);return ee(e.params.shouldUseNewMediaDBFlowConfig),t.restoreMessages(e)}})||qe);var Be;const je=$znode.nativelibs.dbUtils();Object(c.j)()(Be=Object(n.injectable)()(Be=class extends D.a{getType(){return"DECRYPT_BACKUP"}async execute(e){return e.abort.aborted?Promise.reject(new Error("Aborted")):this._decyptBackup(e)}async _decyptBackup(e){const{params:t,report:s}=e;return await Object(Ee.b)(t.outputPath),0===t.format?this._decryptBackupFormat0(t.inputPath,t.outputPath,t.privateKey):this._decryptBackupFormat1(t.inputPath,t.outputPath,t.privateKey,t.numberOfConversationsCount,s)}async _decryptBackupFormat0(e,t,s){const{result:i,err_message:r}=je.decompressAndDecryptDb(e,t,s);return 0===i?t:Promise.reject({error:i,message:r})}async _decryptBackupFormat1(e,t,s,i,r){t=await Object(Ee.a)(t);let n=0;const{result:a,inner_error:o,error_message:c}=je.decompressAndDecryptDb_V2(e,t,s.toUpperCase(),(()=>{n++;const e=Math.floor(Math.round(n/i*100));r(e)}));return 0===a?t:Promise.reject({error:a,inner_error:o,message:c})}})||Be);var xe=s("Jz/+"),Pe=s("d/or"),ze=s("YEoC");n.ModuleContainer.resolve(r.a).addEventListener(xe.a.SessionChange,(async({session:e})=>{if(null===e)return;const t=n.ModuleContainer.resolve(Pe.a);await t.getAdapterTypeOfUserScopedDatabases(e.userId)==ze.a.IDB?s.e(46).then(s.bind(null,"AYQT")):s.e(47).then(s.bind(null,"PKoC"))}));s("Ceyj"),s("69Uf"),s("Q/Ir");var $e,Ve=s("tn+9"),We=s("y3vM"),Ze=s("X+c2");Object(c.j)()($e=Object(n.injectable)()($e=class extends D.a{getType(){return"ZCLOUD"}async execute(e){let{params:t}=e;if(t){let{method:e,data:s,service:i}=t;return i&&i!==We.a.Default?Object(Ze.a)(i,s):(new Ve.a)[e](s)}throw Error("zcloud worker no params")}})||$e);s("rBRb");var Ye,He=s("jbAT"),Ke=s("zLd2"),Xe=s("5txd");Object(n.injectable)()(Ye=Object(n.singleton)(Ke.c)(Ye=function(e,t){return Object(n.inject)(He.b)(e,void 0,0)}(Ye=function(e,t){return Object(n.inject)(m.ZLoggerFactory)(e,void 0,1)}(Ye=Reflect.metadata("design:type",Function)(Ye=Reflect.metadata("design:paramtypes",[void 0===He.a?Object:He.a,void 0===m.ZLoggerFactory?Object:m.ZLoggerFactory])(Ye=class{constructor(e,t){this._utilsMediaAppService=void 0,this._logger=void 0,this._log=void 0,this._utilsMediaAppService=e,this._logger=t.createZLogger(Ke.b,["manage-utils-media-in-ui"]),this._log=Object(Xe.a)(this._logger)}create(e){return this._utilsMediaAppService.create(e)}createOrUpdate(e){return this._utilsMediaAppService.createOrUpdate(e)}async createOrUpdateFromMedias(e){return this._utilsMediaAppService.createOrUpdateFromMedias(e)}})||Ye)||Ye)||Ye)||Ye)||Ye);s("37f1");var Je,et=s("X2RP"),tt=s("ggcH"),st=s("rvru"),it=s("rkiK"),rt=s("Mk04"),nt=s("DOOx"),at=s("Yggq"),ot=s("HWGt");(new(Object(c.h)()(Je=class extends ot.a{constructor(...e){super(...e),this.dbQos=null,this.signalOutOfMem=Object(rt.a)((()=>{Z.p.triggerEvent(Z.o,[{type:nt.b.OUT_OF_MEM,src:nt.a.DB}])})),this.signalInvalidVersion=Object(rt.a)((()=>{$zdb.notifyOpenDBFailed(!0,"VersionError")})),this.signalMissingStore=Object(rt.a)((()=>{$zdb.notifyOpenDBFailed(!0,"zkey-miss-object-store")})),this.signalExceedingLimitInReopeningDBConnection=Object(rt.a)((()=>{$zdb.notifyOpenDBFailed(!1)})),this.signalDBClosedAbnormally=Object(rt.a)((()=>{n.ModuleContainer.resolve(tt.TDBCorruptionDetector).forceCheckDBCorruption()}))}getDBQos(){return null===this.dbQos&&(this.dbQos=n.ModuleContainer.resolve(st.a)),this.dbQos}handleQueryError(e){this.getDBQos().sendDBErrorQos(e)}handleOutOfMemError(e){this.signalOutOfMem()}handleInvalidVersionError(){this.signalInvalidVersion()}handleMissingStoreError(e){const{database:t,missingTables:s,adapterType:i}=e;this.signalMissingStore();this.getDBQos().sendMissingTableQos(t,s)}handleExceedingLimitInReopeningDBConnection(e){this.signalExceedingLimitInReopeningDBConnection()}handleQueryExec(e){const{database:t,table:s,method:i,transaction:r,startTime:n,getEndTime:a}=e;at.a.has(t)||a().then((e=>{const a={method:i,database:t,table:s,transaction:r};it.default.recordInfo(it.MetricName.query_resolution_time,{startAt:n,endAt:e,info:a})})).catch((e=>{}))}handleSuccessOpenDB(e){const{startTime:t,endTime:s,fullname:i}=e;this.getDBQos().sendSuccessOpenDBDurationQos(i,t,s-t),it.default.recordInfo(it.MetricName.db_ready,{startAt:t,endAt:s,info:{dbName:i}})}handleConnectionClosedAbnormally(){this.signalDBClosedAbnormally()}handleSchemaMigratedAbnormally(){}handleLongOpenDB(e){const{startTime:t,endTime:s,fullname:i}=e;this.getDBQos().sendLongOpenRequestQos(i,t,s-t)}handleTimeConsumingQuery(e,t){this.getDBQos().sendTimeConsumingQueryQos(e,t)}handleWarning(e){const t=this.getDBQos();if(e.type===et.b.FAILED_MULTI)t.sendFailedMultiErrorQos(e)}onDispose(){this.dispose()}})||Je)).start(),n.ModuleContainer.resolve(r.a).addEventListener(xe.a.SessionChange,(async({session:e})=>{const t=ie.default.getInstance();null!==e?t.init(e.userId,e.UIN):t.resetSession()}));s("uiYo")},O6t0:function(e,t,s){"use strict";(function(e){var t=s("c8uc"),i=s("AsUd");e&&e.env;const r=12;let n=0;function a(){return new Promise(((e,s)=>{let i=t.a.isLoadedLib();i&&i.ok?(c("load lib success!!"),$zdb.sendResponse({act:r}),$zdb.updateAvailableSqliteState(!0),o(!0,91002,0,0,3==n?0:3,Date.now()),e(i)):n>0?(n--,c("load lib fail go retry "+n+" "+(i?i.error:" _resp = null")),o(!1,91002,0,0,2,Date.now()),setTimeout((()=>{a()}),15e3)):(c("load lib fail "+(i?i.error:" _resp = null")),$zdb.updateAvailableSqliteState(!1),o(!1,91002,0,0,1,Date.now()),s(i))}))}function o(e,t,s=0,i,r,n){$zlogger.crossQosLog({success:e,commandId:t,subCommandId:s,duration:i,errorCode:r,startTime:n})}function c(e){$zlogger.sendLog("info","shared-worker: "+e)}!function(){try{const e={increaseSuccess:(e,t,s,i=[],r={})=>{$zlogger.crossQosLog({success:!0,commandId:e,subCommandId:t,duration:s,params:i,options:r})},increaseFailed:(e,t,s,i,r,n=[],a={})=>{$zlogger.crossQosLog({success:!1,commandId:e,subCommandId:t,duration:s,errorCode:i,startTime:r,params:n,options:a})}},{MetriczDriver:t}=s("rkiK");t.registerQosControl(e)}catch(e){}}(),$zsub.$zdb.processRequest(((e,s)=>{!function(e){e&&(e.constructor===Array?e.forEach((e=>{t.a.receiverEvent(e)})):t.a.receiverEvent(e))}(s)})),$zapp.onPing((()=>Date.now())),$zlogger.onReceiveViewerkey(((e,t)=>{i.j("viewer_key",t)})),document.addEventListener("load",(()=>{a()})),c("[pid][shared-worker]"+e.pid),$zapp.registerProcess("dbtask",e.pid)}).call(this,s("8oxB"))},c8uc:function(e,t,s){"use strict";(function(e){var i=s("VTBJ"),r=s("ES/k"),n=s("4prX"),a=s("AtyM"),o=s("Mgpg"),c=s("jDHv");e&&e.env;let d=$zsqlite;const l=s("wBhU"),h=c.ModuleContainer.resolve(o.ZLoggerFactory).createZLogger("dbtask",["manager"]),u={QUERY:1,ADD_DATA:2,PRE_DATA:3,INIT:4,GET_INDEX:5,ABORTED_SEARCH:6,MIGRATE:7,DEL_OLDDATA:8,DELETE_ALL:9,PRE_TAGGING:10,INIT_TAGGING:11,PROCESS_READY:12,QUERY_GLOBAL_MSG:13,CLOSE_DB:14,DELETE_DATA:15,PURE_QUERY:18,QUERY_GLOBAL_MSG_V3:19,COUNT_TOTAL:20},g={[u.QUERY]:function(e,t,s,n){return new Promise(((a,o)=>{let c;N(e,n),c=t?()=>k(s,n):()=>!1;let l=r.a.formatTextSearch(e);if(l=l.trim(),!l){let e=n.filter;if(!e||!0!==e.searchForEmpty)return o("text is null")}let u=l.split(" ");if((n=n||{}).progress){let e,t=!0,r=0,l=n.configs&&n.configs.limit?n.configs.limit:Q,g=n.configs&&void 0!==n.configs.offset?n.configs.offset:0,m=n.configs?Object(i.a)({},n.configs):{},p=[];const I=()=>{clearTimeout(e),e=null,a(p)},f=(a,g)=>{if(c&&c())return o("aborted");d.query(u,n.filter,Object(i.a)(Object(i.a)({},m),{},{limit:g,offset:a}),c).then((i=>{if(c&&c())return o("aborted");l-=g,i&&i.constructor==Array?(p.push.apply(p,i),i.length>=g&&l>0?(t?(t=!1,r=p.length,C(p,s)):e||(e=setTimeout((()=>{e=null,r<p.length&&(r=p.length,C(p,s))}),2e3)),f(a+i.length,Math.min(100,l))):I()):I()})).catch((e=>{N("_doQuery",e),h.zsymb(18,"VsEvdT","_query fail",s,e),I()}))};f(g,Math.min(100,l))}else n.configs&&n.configs.limit||(n.configs=n.configs?n.configs:{},n.configs.limit=Q,n.configs.offset=n.configs.offset||0),a(d.query(u,n.filter,n.configs,c))}))},[u.ADD_DATA]:function(e){return Promise.reject("not impl")},[u.INIT]:function(e){return new Promise(((t,s)=>{if(N(e),d.isLoadedLib(),!e.userId||!e.UIN)return s("invalid init data "+e.userId+" "+e.UIN);if(G){if(G.userId!=e.userId||G.UIN!=e.UIN)return L("open new db last"+e.userId),G={userId:e.userId,UIN:e.UIN},L("new Session!!"),m.length>0&&(L("promote last task priority"),m.forEach((e=>{e.priority=E}))),m.unshift({act:u.CLOSE_DB,taskId:p.next(),isAbort:!1,additions:null,priority:E,isMicro:!0}),m.unshift({act:u.INIT,data:e,taskId:p.next(),isAbort:!1,additions:null,priority:E,isMicro:!0}),t();if(!U){L("open new db now!!!"+e.userId),U={userId:e.userId,UIN:e.UIN};const s=Date.now(),i=a.a.now();return t(d.openDb(e.userId,e.UIN).catch((t=>{throw l&&e.onSentry&&l.withScope((function(e){e.setTag("db-error","open"),e.setLevel("error"),l.captureException(t)})),n.default.increaseFailed(91002,0,a.a.now()-i,4,s),t.errno&&n.default.increaseFailed(91002,0,a.a.now()-i,1e4*t.errno+4,s),t})))}return L("reopen the same with last"+e.userId),t()}G={userId:e.userId,UIN:e.UIN},L("open db first time now!!!"+e.userId),U={userId:e.userId,UIN:e.UIN},t(d.openDb(e.userId,e.UIN,e.onSentry))}))},[u.PRE_DATA]:function(e,t=!1,s,n,a){return N(e),new Promise(((t,o)=>{if(!e||0==e.length)return t();if(e.length>y){let t=e.slice(y,e.length);R({act:u.PRE_DATA,data:t,taskId:p.next(),isAbort:!1,additions:n,priority:a}),e=e.slice(0,y)}let c=[];e.forEach((e=>{if(!e||e.constructor!==Object)return;let t=r.a.getTextFromMessage(e.content);t&&c.push(Object(i.a)(Object(i.a)({},e),{},{content:t}))}));const l=!1;Date.now();c.length?d.writev2(c).then((()=>{t()})).catch((e=>{h.zsymb(18,"Y1srPG","predata fail",s,e),o(e)})):t()}))},[u.GET_INDEX]:function(e){return Promise.reject("not impl")},[u.MIGRATE]:function(e){return Promise.reject("not impl")},[u.DEL_OLDDATA]:function(){return Promise.reject("not impl")},[u.DELETE_ALL]:function(){return Promise.reject("not impl")},[u.QUERY_GLOBAL_MSG]:function(e,t,s,i){return new Promise(((n,a)=>{let o;o=t?()=>k(s,i):()=>!1;let c=r.a.formatTextSearch(e);if(c=c.trim(),!c)return a("text is null");if(i||(i={}),i.progress){let e=0;const t=[10,20,50],r=(e,t)=>({data:e,page:t}),l=(c,h,u,g=30)=>{if(o())a("aborted");else if(u>=h.length)n(r(null,e));else{const m=Math.min(u+g,h.length);d.queryGlobalMessageV2(c,h.slice(u,m),i.configs,o).then((i=>{i?(C(r(i,e),s),e>=1?setTimeout((()=>{l(c,h,u+g,t[Math.min(++e,t.length-1)])}),100):l(c,h,u+g,t[Math.min(++e,t.length-1)])):n(r(null,e))})).catch((e=>{a(e)}))}};(()=>{d.getConversationMatch(c,o).then((s=>{if(s&&s.length>0){s.sort(((e,t)=>t.ts-e.ts));let e=[];s.forEach((t=>{e.push(t.convId)})),e.length>0&&l(c,e,0,t[0])}else n(r(null,e))})).catch((e=>{a(e)}))})()}else n(d.queryGlobalMessageV2(c,i.listConvs,i.configs,o))}))},[u.CLOSE_DB]:function(){return new Promise(((e,t)=>{U?(L("go close db "+U.userId),e(d.closeDb(U.userId,U.UIN))):t("close what?? curr: "+JSON.stringify(U)),U=null}))},[u.DELETE_DATA]:function(e){return d.deleteRow(e.msgId)},[u.PURE_QUERY]:function(e){return new Promise(((t,s)=>{d.pureQuery(e).then((e=>{e?t(e):s(null)})).catch((t=>{h.zsymb(18,"rZ-BKQ","pure query fail",e,t),s(t)}))}))},[u.QUERY_GLOBAL_MSG_V3]:function(e,t,s,i){return new Promise(((n,a)=>{let o;o=t?()=>k(s,i):()=>!1;let c=r.a.formatTextSearch(e);if(c=c.trim(),!c)return a("text is null");const l=(e,t)=>({data:e,page:t});D(`_queryGlobalMessageV3, kw: ${e}`);let h=i.configs.filter;d.queryGlobalMessageV3(c,o,h,D).then((t=>{D(`_queryGlobalMessageV3 SUCCESS, kw: ${e}, total res: ${t?t.length:"empty"}`),t?(C(l(t,0),s),n(l(t,0))):n(l(null,0))})).catch((e=>{D("_queryGlobalMessageV3 Error",JSON.stringify(e)),a(e)}))}))},[u.COUNT_TOTAL]:function(){return new Promise(((e,t)=>{d.countTotal().then((s=>{s?e(s):t(null)})).catch((e=>{h.zsymb(18,"hv5tJ4","count total fail",e),t(e)}))}))}};let m=[];const p=new class{constructor(){this.value=1}next(){return this.value++,this.value}};let I=new Map;const f=1,b=2;let M=2;const y=300;let w=null;const v="FLAG_SLEEP_TOO_LONG",S=6e4,_=6e4,E=100,T=!0;function D(...e){T&&h.zsymb(0,"6KvRNY","[search]",...e)}function N(){}var O=e=>{$zdb.sendResponse(e)};function C(e,t){O({progress:!0,taskId:t,data:e})}function L(e){O({logErr:!0,data:e})}function k(e,t){return t&&t.filter?e!=I.get("with-filter"):e!=I.get("_")}function R(e){let t=!1;[u.QUERY,u.QUERY_GLOBAL_MSG,u.QUERY_GLOBAL_MSG_V3].indexOf(e.act)>=0&&(e.additions&&e.additions.filter?I.set("with-filter",e.taskId):I.set("_",e.taskId));for(let r=0;r<m.length;++r)if(s=m[r],i=e,s.priority>=i.priority){m.splice(r,0,e),t=!0;break}var s,i;t||m.push(e),function(){if(M==f)return;M=f,A()}()}function F(e,t,s){try{e.callback&&O({success:s,data:t,taskId:e.taskId}),s||L(" err "+e.act+" "+t)}catch(i){L(" _afterAction "+e.act+": "+i)}A()}function A(){if(0==m.length)return M=b,w&&clearTimeout(w),void(w=setTimeout((()=>{L(v),w=null}),S));w&&(clearTimeout(w),w=null);let e=m.pop();if(!e||"object"!=typeof e)return L("ev is not Object"),void A();let t=g&&e.act&&g.hasOwnProperty(e.act)?g[e.act]:null;if("function"==typeof t){let i=!1,r=setTimeout((()=>{r=null,i=!0,L("timeout event "+e.act),F(e,"timeout!!",!1)}),_);const n=()=>(r&&(clearTimeout(r),r=null),i);try{t(e.data,e.isAbort,e.taskId,e.additions,e.priority).then((t=>{n()||F(e,t,!0)})).catch((t=>{n()||F(e,t,!1)}))}catch(s){F(e,s,!1)}}else F(e,"not support this function "+e.act,!1)}let G,U;const Q=1e4;t.a={receiverEvent:function(e){switch(e.act,e.act){case u.ABORTED_SEARCH:I=new Map,m=m.filter((e=>e.act!=u.QUERY));break;case u.DELETE_ALL:m=[],R(e);break;default:R(e)}},isLoadedLib:()=>d.isLoadedLib()}}).call(this,s("8oxB"))}});
//# sourceMappingURL=sourcemaps/shared-worker.3a6ecf693cff2fc53577.js.map