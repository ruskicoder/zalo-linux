(this.webpackJsonp=this.webpackJsonp||[]).push([[16],{"37f1":function(e,t,i){"use strict";var s,r=i("VTBJ"),a=i("v6qY"),n=i("bUXd"),o=i("1pet"),d=i("NDmK"),l=i("AjFa"),c=i("W13p"),m=i("5R0e"),g=i("jDHv"),u=i("EYv5"),h=i("Mlp7"),p=i("Mgpg"),f=i("3dEI"),M=i("fhp4"),I=i("7WMW"),y=i("K4Ns"),b=i("fsN4"),_=i("XS0u"),O=i("z0WU"),D=i("1erv"),T=i("wH4e"),v=i("zLd2"),w=i("KPNQ"),E=i("H8Z7"),U=i("8tev"),S=i("dm9D"),F=i("vAzq"),j=i("AtyM");Object(g.injectable)()(s=Object(g.singleton)(u.a)(s=function(e,t){return Object(g.inject)(v.c)(e,void 0,0)}(s=function(e,t){return Object(g.inject)(f.b)(e,void 0,1)}(s=function(e,t){return Object(g.inject)(M.e)(e,void 0,2)}(s=function(e,t){return Object(g.inject)(w.b)(e,void 0,3)}(s=function(e,t){return Object(g.inject)(p.ZLoggerFactory)(e,void 0,4)}(s=Reflect.metadata("design:type",Function)(s=Reflect.metadata("design:paramtypes",[void 0===v.IUtilsMediaManager?Object:v.IUtilsMediaManager,void 0===f.IMediaRepositoryFactory?Object:f.IMediaRepositoryFactory,void 0===M.b?Object:M.b,void 0===w.IMediaPrimaryKeyConvertor?Object:w.IMediaPrimaryKeyConvertor,void 0===p.ZLoggerFactory?Object:p.ZLoggerFactory])(s=class{constructor(e,t,i,s,r){this._utilsMediaManager=void 0,this._mediaMapperFactory=void 0,this._mediaRepositoryFactory=void 0,this._mediaPrimaryKeyConvertor=void 0,this._logger=void 0,this._utilsMediaManager=e,this._mediaRepositoryFactory=t,this._mediaMapperFactory=i,this._mediaPrimaryKeyConvertor=s,this._logger=r.createZLogger("media-manager",[""])}filter(e,t){return Object(D.a)()?I.a.filterMedia(e,t):h.a.filter(e,t)}getMediaRepository(e,t=!0){const i=this._mediaRepositoryFactory.getMediaRepository(e);if(!i&&t)throw Error(`[getMediaRepository]: can't get mediaRepository has mediaType: ${e}!`);return i}getMediaMapper(e,t=!0){const i=this._mediaMapperFactory.getMediaMapper(e);if(!i&&t)throw Error(`[getMediaMapper]: can't get mediaMapper has mediaType: ${e}!`);return i}async _isMigrationDone(){return(await g.ModuleContainer.resolve(E.c).getMediaMigrationState()).stateName===U.b.DONE}async isExistedMedia(e,t){try{if(!e)throw Error("mediaType is invalid!");if(!t)throw Error("mediaIdObj is invalid!");const i=this.getMediaRepository(e);return await i.isExistedMedia({newId:t.newId||"",oldId:t.oldId||""})}catch(s){var i;const e=[null==s||null===(i=s.toString)||void 0===i?void 0:i.call(s),null==s?void 0:s.stack].join("\n");return this._logger.zsymb(21,"ZN6J3H",["[isExistedMedia] - error: {}","9KnA77"],e),!1}}async addMedias(e,t,i=`${a.c.UNKNOWN}${a.d.UNKNOWN}`){try{if(!e)throw Error("mediaType is undefined!");if(!t||!t.length)return;const s=this.getMediaRepository(e),r=this.getMediaMapper(e),a=t.map((t=>(t.src=i,"image"===e&&(t.subType=o.MSG_SUBTYPE_MEDIA_DOODLE),r.toDomainFromDTO(t)))),n=(await s.insertMulti(a)).success.map((t=>this.getMediaMapper(e).toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(t)));await this._utilsMediaManager.createOrUpdateFromMedias(n)}catch(r){var s;const e=[null==r||null===(s=r.toString)||void 0===s?void 0:s.call(r),null==r?void 0:r.stack].join("\n");this._logger.zsymb(21,"wM4d6Y",["[addMedias] - error: {}","HK7QTD"],e)}}addMediaToConvOnly(e,t=`${a.c.UNKNOWN}${a.d.UNKNOWN}`){var i,s,r;if(!Object(D.a)())return h.a.addMediaToConversationOnly(e);let n=[];if(null!=e&&null!==(i=e.image)&&void 0!==i&&i.length){const i=this.getMediaRepository("image"),s=this.getMediaMapper("image");n.push(null==i?void 0:i.insertMulti(e.image.map((e=>(e.src=t,s.toDomainFromDTO(e))))).then((e=>{if(e.success.length){const t=e.success.map((e=>this.getMediaMapper("image").toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e)));this._utilsMediaManager.createOrUpdateFromMedias(t)}})))}if(null!=e&&null!==(s=e.link)&&void 0!==s&&s.length){const i=this.getMediaRepository("link"),s=this.getMediaMapper("link");n.push(null==i?void 0:i.insertMulti(e.link.map((e=>{e.src=t;return s.toDomainFromDTO(e)}))).then((e=>{if(e.success.length){const t=e.success.map((e=>this.getMediaMapper("link").toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e)));this._utilsMediaManager.createOrUpdateFromMedias(t)}})))}if(null!=e&&null!==(r=e.file)&&void 0!==r&&r.length){const i=this.getMediaRepository("file"),s=this.getMediaMapper("file");n.push(i.insertMulti(e.file.map((e=>(e.src=t,s.toDomainFromDTO(e))))).then((e=>{if(e.success.length){const t=e.success.map((e=>this.getMediaMapper("file").toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e)));this._utilsMediaManager.createOrUpdateFromMedias(t)}})))}return Promise.all(n)}async deleteMediasById(e,t,i){try{if(!i)throw Error("mediaIdObjs is undefined!");const o=Array.isArray(i)?[...i]:[i];for(const e of o){const{newId:i,oldId:s}=e;if(!i&&s){const i=await this.getMediaFieldsByMsgId(t,s);e.newId=i?`${i.cliMsgId}_${i.fromUid}_${i.toUid}`:""}}const d=this.getMediaRepository(e,!1),u=[];for(const e of o)u.push(Object(r.a)(Object(r.a)({},e),{},{deleteTo:await this._isMigrationDone()?y.a.NEW:y.a.UNKNOWN}));if(d)await d.deleteMultiMedias(u);else{var s,a,n;const e=[];e.push(null===(s=g.ModuleContainer.resolve(l.b))||void 0===s?void 0:s.deleteMultiMedias(u),null===(a=g.ModuleContainer.resolve(c.b))||void 0===a?void 0:a.deleteMultiMedias(u),null===(n=g.ModuleContainer.resolve(m.b))||void 0===n?void 0:n.deleteMultiMedias(u)),await Promise.all(e)}}catch(d){var o;const e=[null==d||null===(o=d.toString)||void 0===o?void 0:o.call(d),null==d?void 0:d.stack].join("\n");this._logger.zsymb(21,"iDvsZs",["[deleteMediasById] - error: {}","5DRrqN"],e)}}async getValidMediasOfConv(e,t,i,s,a,n){try{if(!t)return Promise.resolve([]);const d=j.a.now(),l={cliMsgId:o.MessageConstants.MAX_MSG_ID,sendDttm:parseInt(o.MessageConstants.MAX_SENDDTTM),msgId:s||o.MessageConstants.MAX_MSG_ID};if(null!=n&&n.lastItemOpts)l.cliMsgId=n.lastItemOpts.cliMsgId,l.sendDttm=n.lastItemOpts.sendDttm;else if(s){const e=await this.getMediaFieldsByMsgId(t,s);e&&(l.cliMsgId=e.cliMsgId,l.sendDttm=e.sendDttm)}const c=h.a.getLastDeleteConv(t,e),m=this.getMediaRepository(e),g=await m.getMediasOfConv(t,l,i,Object(r.a)(Object(r.a)({},a),{},{deletePointOfConv:c}));if(!g.length)return[];const u=this.getMediaMapper(e),p=await Promise.all(g.map((e=>u.toDTO(e))));return this._trackDBPerformance({executionTime:j.a.now()-d,actionName:"getByConv",mediaType:e,resultSize:p.length}),p}catch(l){var d;const e=[null==l||null===(d=l.toString)||void 0===d?void 0:d.call(l),null==l?void 0:l.stack].join("\n");return this._logger.zsymb(21,"-uwt8f",["[getValidMediasOfConv] - error: {}","qPu_I4"],e),Promise.resolve([])}}async getLastMediasOfConvWithoutCorrectData(e,t,i,s=100,r){if(!Object(D.a)())return h.a.getLastMediaFromConversation(t,e,s,i);try{if(!t)return Promise.resolve([null,Error("convId is undefined!")]);const a={cliMsgId:o.MessageConstants.MAX_MSG_ID,sendDttm:parseInt(o.MessageConstants.MAX_SENDDTTM),msgId:i||d.default.load_media.use_max_id||o.MessageConstants.MAX_MSG_ID};if(null!=r&&r.lastItemOpts)a.cliMsgId=r.lastItemOpts.cliMsgId,a.sendDttm=r.lastItemOpts.sendDttm;else if(i){const e=await this.getMediaFieldsByMsgId(t,i);e&&(a.cliMsgId=e.cliMsgId,a.sendDttm=e.sendDttm)}const n=this.getMediaRepository(e),l=await n.getLastMediasOfConv(t,a,s);return[await Promise.all(l.map((t=>this.getMediaMapper(e).toDTO(t)))),null]}catch(n){var a;const e=[null==n||null===(a=n.toString)||void 0===a?void 0:a.call(n),null==n?void 0:n.stack].join("\n");return this._logger.zsymb(21,"np6XON",["[getLastMediasOfConvWithoutCorrectData] - error: {}","yEzKU4"],e),[null,n]}}async updateMedia(e,t,i,s,a){if(!Object(D.a)()){const t=Object(r.a)(Object(r.a)({},s),{},{msgId:i});return h.a.updateMedia(t,e,a)}return this._updateMedia(e,t,i,s,a)}async countMediaOfConv(e,t,i){try{t||Promise.resolve({ok:!0,result:0,error:null});const{from:s,to:a}=i;s.cliMsgId=s.cliMsgId?s.cliMsgId:"",s.sendDttm=s.sendDttm?s.sendDttm:0,s.msgId=s.msgId?s.msgId:"",a.cliMsgId=a.cliMsgId?a.cliMsgId:o.MessageConstants.MAX_MSG_ID,a.sendDttm=a.sendDttm?a.sendDttm:parseInt(o.MessageConstants.MAX_SENDDTTM),a.msgId=a.msgId?a.msgId:o.MessageConstants.MAX_MSG_ID;const n=this.getMediaRepository(e);return{ok:!0,result:await n.countMediaOfConv(t,{from:Object(r.a)({},s),to:Object(r.a)({},a)}),error:null}}catch(a){var s;const e=[null==a||null===(s=a.toString)||void 0===s?void 0:s.call(a),null==a?void 0:a.stack].join("\n");return this._logger.zsymb(21,"a8z8Hs",["[countMediaOfConv] - error: {}","dZWiuO"],e),{ok:!1,result:0,error:a}}}async getMediaFieldsByMsgId(e,t){if(!t)return Promise.resolve(void 0);const i=await b.default.getInstance().Core.Message.get(t,{partition:e});return i?{cliMsgId:"number"==typeof i.cliMsgId?i.cliMsgId.toString():i.cliMsgId,fromUid:i.fromUid,toUid:i.toUid,sendDttm:"string"==typeof i.sendDttm?parseInt(i.sendDttm):i.sendDttm}:Promise.resolve(void 0)}async getAllValidPhotoAndVideosOfConv(e){if(!Object(D.a)())return h.a.getAllMediaFromConv(e);let t=!0,i={cliMsgId:o.MessageConstants.MAX_MSG_ID,sendDttm:parseInt(o.MessageConstants.MAX_SENDDTTM)},s=o.MessageConstants.MAX_MSG_ID,r="",a=[],n=[];for(;t;){const d=await this.getValidMediasOfConv("image",e,50,s,{},{lastItemOpts:{cliMsgId:i.cliMsgId,sendDttm:i.sendDttm}});t=d.length>=50;let l=i,c=r,m=s;if(d.length){if(d.forEach((e=>{e&&e.subType==o.MSG_SUBTYPE_MEDIA_VIDEO?a.push(e):!e||e.subType!=o.MSG_SUBTYPE_PHOTO&&e.subType!==o.MSG_SUBTYPE_MEDIA_DOODLE||n.push(e)})),l={cliMsgId:d[d.length-1].cliMsgId,sendDttm:d[d.length-1].sendDttm},m=d[d.length-1].msgId,c=d[d.length-1].mediaId,m&&s&&m==s||c&&r&&c==r)break;i=l,r=c,s=m}}return{photos:n,videos:a}}async getAllValidPhotoAndVideosOfConvV2(e){if(!Object(D.a)())return h.a.getAllMediaFromConv(e);let t=[],i=[];const s=j.a.now();let a=!1,n={cliMsgId:o.MessageConstants.MAX_MSG_ID,sendDttm:parseInt(o.MessageConstants.MAX_SENDDTTM)};do{const s=await this.getMediaRepository("image").getLastMediasOfConvInNewDB(e,n,50),d=[],l=s.map((e=>e.cliMsgId)),c={index:"cliMsgIdIndex",partition:e},m=b.default.getInstance(),g=(await m.Core.Message.getMultiIfExists(l,c)).reduce(((e,t)=>(t&&(e[`${t.cliMsgId}_${t.fromUid}_${t.toUid}`]=t),e)),{}),u=[];for(const e of s)u.push(new Promise((async t=>{try{var i,s;const t=Object(r.a)(Object(r.a)({},e),{},{msgId:null!==(i=null===(s=g[e.mediaId])||void 0===s?void 0:s.msgId)&&void 0!==i?i:""}),a=await this.getMediaMapper("image").toDTO(t,!1);d.push(a)}catch(a){}t()})));if(await Promise.all(u),d.length){d.forEach((e=>{e.subType==o.MSG_SUBTYPE_MEDIA_VIDEO?i.push(e):e.subType!=o.MSG_SUBTYPE_PHOTO&&e.subType!=o.MSG_SUBTYPE_MEDIA_DOODLE||t.push(e)}));let e={cliMsgId:d[d.length-1].cliMsgId,sendDttm:d[d.length-1].sendDttm};if(e.cliMsgId&&n.cliMsgId==e.cliMsgId||e.sendDttm&&n.sendDttm==e.sendDttm)break;n=e}a=d.length>=50}while(a);a=!1;let d=o.MessageConstants.MAX_MSG_ID;do{const s=await this.getMediaRepository("image").getLastMediasOfConvInOldDB(e,{msgId:d},50),r=await Promise.all(s.map((e=>this.getMediaMapper("image").toDTO(e,!1))));if(r.length){r.forEach((e=>{e.subType==o.MSG_SUBTYPE_MEDIA_VIDEO?i.push(e):e.subType!=o.MSG_SUBTYPE_PHOTO&&e.subType!=o.MSG_SUBTYPE_MEDIA_DOODLE||t.push(e)}));let e=r[r.length-1].msgId;if(e&&d==e)break;d=e}a=r.length>=50}while(a);return this._trackDBPerformance({executionTime:j.a.now()-s,actionName:"getAllByConv",mediaType:"all",resultSize:t.length+i.length}),{photos:t,videos:i}}async getImageMessagesForPhotoViewer(e,t,i,s,r,a){if(!Object(D.a)())return _.default.getImagesForPhotoViewer({userId:e},t,i,s,r,a);try{var n;if(!e||!t)throw Error("convId or lastMsgId is undefined!");const d=await this.getMediaFieldsByMsgId(e,t);return await(null===(n=g.ModuleContainer.resolve(l.b))||void 0===n?void 0:n.getImageMessagesForPhotoViewer(e,i,{sendDttm:(null==d?void 0:d.sendDttm)||parseInt(o.MessageConstants.MAX_SENDDTTM),cliMsgId:(null==d?void 0:d.cliMsgId)||o.MessageConstants.MAX_MSG_ID,msgId:t},s,r,a))}catch(c){var d;const e=[null==c||null===(d=c.toString)||void 0===d?void 0:d.call(c),null==c?void 0:c.stack].join("\n");return this._logger.zsymb(21,"anHF6J",["[getImageMessagesForPhotoViewer] - error: {}","Lw6pqq"],e),[]}}async getLastestAddedFiles(e,t=40){if(!Object(D.a)())return _.default.getLatestFiles(e,t);try{if(!e){e=Date.now();let t=n.default.getTimeNow();e=e>t?e:t}const i=o.MessageConstants.MAX_CONVERSATION_ID,s=parseInt(o.MessageConstants.MAX_MSG_ID),r=g.ModuleContainer.resolve(c.b),a=await r.getLastestAddedFiles({convId:i,sendDttm:e,cliMsgId:s},t);if(a.length>0){const e=this.getMediaMapper("file");return await Promise.all(a.map((t=>e.toDTO(t))))}return[]}catch(s){var i;const e=[null==s||null===(i=s.toString)||void 0===i?void 0:i.call(s),null==s?void 0:s.stack].join("\n");return this._logger.zsymb(21,"8jDOwb",["[getLastestAddedFiles] - error: {}","K6_tmM"],e),Promise.resolve([])}}async getMultiMedias(e,t,i){if(!Object(D.a)())return _.default.getMediaByIds(e,i);try{if(!i||i.length<0)throw Error("msgIds is undefined or empty!");const s=j.a.now(),r=[],a=i.map((e=>this.getMediaFieldsByMsgId(t,e).then((async t=>{r.push({newId:t?`${t.cliMsgId}_${t.fromUid}_${t.toUid}`:"",oldId:e,getFrom:await this._isMigrationDone()?y.b.NEW:y.b.UNKNOWN})}))));if(await Promise.all(a),!r.length)return[];const n=(await this.getMediaRepository(e).getMultiMedias(r)).filter(Boolean);return n.length>0?(this._trackDBPerformance({executionTime:j.a.now()-s,actionName:"getByIds",mediaType:e,resultSize:n.length}),await Promise.all(n.map((t=>this.getMediaMapper(e).toDTO(t))))):[]}catch(r){var s;const e=[null==r||null===(s=r.toString)||void 0===s?void 0:s.call(r),null==r?void 0:r.stack].join("\n");return this._logger.zsymb(21,"rARX79",["[getMultiMedias] - error: {}","dtjZJQ"],e),[]}}async getMediaById(e,t,i){try{if(!i)throw Error("mediaId is undefined!");const s=await this.getMediaFieldsByMsgId(t,i),r=this.getMediaRepository(e),a=await r.getMedia({newId:s?`${s.cliMsgId}_${s.fromUid}_${s.toUid}`:"",oldId:i},void 0,await this._isMigrationDone()?y.b.NEW:y.b.UNKNOWN);return a?await this.getMediaMapper(e).toDTO(a):void 0}catch(r){var s;const e=[null==r||null===(s=r.toString)||void 0===s?void 0:s.call(r),null==r?void 0:r.stack].join("\n");return this._logger.zsymb(21,"awjoCF",["[getMediaById] - error: {}","TKU2_m"],e),Promise.resolve(void 0)}}async _updateMedia(e,t,i,s,r){try{if(!t)throw Error("chatID isn't valid!");if(!i)throw Error("mediaId isn't valid!");if(!s)throw Error("mediaValue isn't valid!");const r=this.getMediaRepository(e),a=await this._mediaPrimaryKeyConvertor.toMediaPKFromMessagePK(t,i),n=this.getMediaMapper(e).toNewEAttsFromDTOAtts(s);return await r.updateMedia({newId:a,oldId:i},{attributes:Object.keys(n),value:n,ignoreNotFound:!0},await this._isMigrationDone()?y.c.NEW:y.c.UNKNOWN)}catch(n){var a;const e=[null==n||null===(a=n.toString)||void 0===a?void 0:a.call(n),null==n?void 0:n.stack].join("\n");return this._logger.zsymb(21,"7qOrwV",["[_updateMedia] - error: {}","dDYnqL"],e),!1}}async _addMediasWhenTransferMessageOldFlow(e){try{const t=[],i=[],s=[];for(let n=0;n<e.length;n++){const a=e[n],d=a.msgType,l=Number(a.sendDttm);switch(d){case o.MSG_PHOTO:case o.MSG_PHOTO_2:case o.MSG_DOODLE:if(!Object(S.a)(a)&&!O.default.isPhotoStickerMessage(a)){const e=a.message.thumb||a.message.oriUrl,t=d==o.MSG_DOODLE?Object(r.a)(Object(r.a)({},a.message),{},{thumbUrl:e}):a.message;i.push({sendDttm:l,msgId:a.msgId,userId:a.toUid,message:t,fromUid:a.fromUid,subType:o.MSG_SUBTYPE_PHOTO,type:"image",ttl:a.ttl,cliMsgId:a.cliMsgId})}break;case o.MSG_FILE:t.push({sendDttm:l,msgId:a.msgId,userId:a.toUid,message:a.message,fromUid:a.fromUid,type:"file",ttl:a.ttl,cliMsgId:a.cliMsgId});break;case o.MSG_CONTACT:"recommened.link"===a.message.action&&s.push({sendDttm:l,msgId:a.msgId,userId:a.toUid,message:a.message,fromUid:a.fromUid,type:"link",ttl:a.ttl,cliMsgId:a.cliMsgId});break;case o.MSG_VIDEO:i.push({sendDttm:l,msgId:a.msgId,userId:a.toUid,message:a.message,fromUid:a.fromUid,subType:o.MSG_SUBTYPE_MEDIA_VIDEO,type:"image",ttl:a.ttl,cliMsgId:a.cliMsgId})}}let a=[];return i.length>0&&a.push(b.default.getInstance().Core.Image.insertMulti(i,{replace:!1})),s.length>0&&a.push(b.default.getInstance().Core.Link.insertMulti(s,{replace:!1})),t.length>0&&a.push(b.default.getInstance().Core.File.insertMulti(t,{replace:!1})),await Promise.all(a)}catch(i){var t;const e=[null==i||null===(t=i.toString)||void 0===t?void 0:t.call(i),null==i?void 0:i.stack].join("\n");this._logger.zsymb(21,"Ztheb1",["[_addMediasWhenTransferMessageOldFlow] - error: {}","KvaI-1"],e)}}async _addMediasFromMessages(e,t){try{if(!e||!e.length)return;t=t||`${a.c.UNKNOWN}${a.d.FROM_MSG}`;const i=[],s=[],n=[],d=this.getMediaMapper("image"),l=this.getMediaMapper("file"),c=this.getMediaMapper("link");e.forEach((e=>{const a=e.msgType;switch(a){case o.MSG_PHOTO:case o.MSG_PHOTO_2:case o.MSG_DOODLE:if(a===o.MSG_DOODLE){let s=e.message;if(e.message){const t=e.message.thumb||e.message.oriUrl;s=Object(r.a)(Object(r.a)({},e.message),{},{thumbUrl:t})}i.push(d.toDomainFromTMessage(Object(r.a)(Object(r.a)({},e),{},{message:s}),o.MSG_SUBTYPE_MEDIA_DOODLE,t))}else Object(S.a)(e)||O.default.isPhotoStickerMessage(e)||i.push(d.toDomainFromTMessage(e,o.MSG_SUBTYPE_PHOTO,t));break;case o.MSG_FILE:s.push(l.toDomainFromMessage(e,t));break;case o.MSG_CONTACT:"recommened.link"===e.message.action&&n.push(c.toDomainFromMessage(e,t));break;case o.MSG_VIDEO:i.push(d.toDomainFromTMessage(e,o.MSG_SUBTYPE_MEDIA_VIDEO,t))}}));let m=[];return i.length>0&&m.push(this.getMediaRepository("image").insertMulti(i).then((e=>{if(e.success.length){const t=e.success.map((e=>this.getMediaMapper("image").toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e)));this._utilsMediaManager.createOrUpdateFromMedias(t)}}))),s.length>0&&m.push(this.getMediaRepository("file").insertMulti(s).then((e=>{if(e.success.length){const t=e.success.map((e=>this.getMediaMapper("file").toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e)));this._utilsMediaManager.createOrUpdateFromMedias(t)}}))),n.length>0&&m.push(this.getMediaRepository("link").insertMulti(n).then((e=>{if(e.success.length){const t=e.success.map((e=>this.getMediaMapper("link").toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e)));this._utilsMediaManager.createOrUpdateFromMedias(t)}}))),await Promise.all(m)}catch(s){var i;const e=[null==s||null===(i=s.toString)||void 0===i?void 0:i.call(s),null==s?void 0:s.stack].join("\n");this._logger.zsymb(21,"7Ad2kT",["[_addMediasFromMessages] - error: {}","gOdYZz"],e)}}async _addMediasAtExportImportFlowOldFlow(e){if(!e||!e.length)return;const t=[],i=[],s=[];e.forEach((e=>{if(e.msgType===o.MSG_FILE)i.push({msgId:e.msgId,userId:e.toUid,message:e.message,sendDttm:e.sendDttm,localPath:e.localPath,fromUid:e.fromUid,type:"file",ttl:e.ttl});else if(e.msgType===o.MSG_CONTACT)"recommened.link"===e.message.action&&s.push({msgId:e.msgId,userId:e.toUid,message:e.message,sendDttm:e.sendDttm,fromUid:e.fromUid,type:"link",ttl:e.ttl});else if(e.msgType!==o.MSG_PHOTO&&e.msgType!==o.MSG_PHOTO_2&&e.msgType!==o.MSG_DOODLE||Object(S.a)(e)||O.default.isPhotoStickerMessage(e))e.msgType===o.MSG_VIDEO&&t.push({msgId:e.msgId,userId:e.toUid,message:e.message,sendDttm:e.sendDttm,fromUid:e.fromUid,type:"image",subType:o.MSG_SUBTYPE_MEDIA_VIDEO,ttl:e.ttl});else{const i={msgId:e.msgId,userId:e.toUid,message:e.message,sendDttm:e.sendDttm,fromUid:e.fromUid,type:"image",subType:o.MSG_SUBTYPE_PHOTO,ttl:e.ttl};if(e.msgType===o.MSG_DOODLE){const e=i.message.thumb||i.message.oriUrl;i.subType=o.MSG_SUBTYPE_MEDIA_DOODLE,i.message=Object(r.a)(Object(r.a)({},i.message),{},{thumbUrl:e})}t.push(i)}})),i.length&&_.default.addFilesToConversation(i),s.length&&_.default.addLinksToConversation(s),t.length&&_.default.addOrUpdateImagesToConversation(t)}async _addMediasFromMessagesWhenBackupOldFlow(e){if(!e||!e.length)return;const t=[],i=[],s=[];e.forEach((e=>{if(e.msgType===o.MSG_FILE)i.push({msgId:e.msgId,userId:e.toUid,message:e.message,sendDttm:e.sendDttm,localPath:e.localPath,fromUid:e.fromUid,ttl:e.ttl});else if(e.msgType===o.MSG_CONTACT&&"recommened.link"===e.message.action)s.push({msgId:e.msgId,userId:e.toUid,message:e.message,sendDttm:e.sendDttm,fromUid:e.fromUid,ttl:e.ttl});else if(!(e.msgType!==o.MSG_PHOTO&&e.msgType!==o.MSG_PHOTO_2&&e.msgType!==o.MSG_DOODLE||Object(S.a)(e)||O.default.isPhotoStickerMessage(e))){let i=e.message;if(e.msgType===o.MSG_DOODLE){const t=e.message.thumb||e.message.oriUrl;i=Object(r.a)(Object(r.a)({},e.message),{},{thumbUrl:t})}t.push({msgId:e.msgId,userId:e.toUid,message:i,sendDttm:e.sendDttm,fromUid:e.fromUid,ttl:e.ttl})}})),i.length&&_.default.addFilesToConversation(i),s.length&&_.default.addLinksToConversation(s),t.length&&_.default.addOrUpdateImagesToConversation(t)}async _emptyOldMediaStore(e,t){const i={from:[t,0,""],to:[t,o.MessageConstants.MAX_MSG_ID.length,o.MessageConstants.MAX_MSG_ID],excludeFrom:!1,excludeTo:!1},s={index:"userId_sendDttm_msgId",direction:T.CursorDirection.PREV},r=await e.getAllKey(i,s);null!=r&&r.length&&await e.deleteMulti(r)}async _emptyNewMediaStore(e,t){const i={from:[t,0,""],to:[t,parseInt(o.MessageConstants.MAX_SENDDTTM),o.MessageConstants.MAX_MSG_ID],excludeFrom:!1,excludeTo:!1},s={index:"convId_sendDttm_cliMsgId",direction:T.CursorDirection.PREV},r=await e.getAllKey(i,s);null!=r&&r.length&&await e.deleteMulti(r)}async updateFile(e,t,i,s){return Object(D.a)()?this._updateMedia("file",e,t,i,s):!!(await _.default.updateFile(t,i,s))}getMediaFromConversation(e,t,i,s,r){if(!Object(D.a)())return h.a.getMediaFromConversation({userId:t},e,i,s,r);const a=e.substring(0,e.length-1);return this.getValidMediasOfConv(a,t,i,s,r)}async deleteMediaWhenDeleteMsg(e,t,i){if(!Object(D.a)())return void _.default.deleteMediaItem(t);let s="";if(null!=i&&i.mediaIdKeys){const{cliMsgId:e,fromUid:t,convId:r}=i.mediaIdKeys;s=`${e}_${t}_${r}`}else s=await this._mediaPrimaryKeyConvertor.toMediaPKFromMessagePK(e,t);this.deleteMediasById("",e,{newId:s,oldId:t})}async deleteMediaItems(e,t,i,s){if(!i)return[];if(!Object(D.a)())return h.a.deleteMediaItem(i,e);let r=[];r=null!=s&&s.mediaIdKeysArr&&s.mediaIdKeysArr.length?s.mediaIdKeysArr.map((e=>`${e.cliMsgId}_${e.fromUid}_${e.convId}`)):await Promise.all(i.map((e=>this._mediaPrimaryKeyConvertor.toMediaPKFromMessagePK(t,e))));const a=i.map(((e,t)=>({oldId:e,newId:r[t]})));return this.deleteMediasById(e,t,a)}async addLinksToConversation(e){Object(D.a)()?this.addMedias("link",e):_.default.addLinksToConversation(e)}async getFilesFromConversation(e,t,i){return Object(D.a)()?this.getValidMediasOfConv("file",e,t,i,null):_.default.getFilesFromConversation({userId:e},t,i)}async addMediasWhenTransferMessage(e,t,i){return i?this._addMediasFromMessages(e,t):this._addMediasWhenTransferMessageOldFlow(e)}async addMediasAtExportImportFlow(e,t){return Object(D.a)()?this._addMediasFromMessages(e,t):this._addMediasAtExportImportFlowOldFlow(e)}async addMediasFromMessagesWhenBackup(e,t){return Object(D.a)()?this._addMediasFromMessages(e,t):this._addMediasFromMessagesWhenBackupOldFlow(e)}async deleteImageByMsgId(e,t,i){if(!Object(D.a)())return _.default.deleteImageByMsgId(t);let s="";return s=null!=i&&i.mediaIdKeys?`${i.mediaIdKeys.cliMsgId}_${i.mediaIdKeys.fromUid}_${i.mediaIdKeys.convId}`:await this._mediaPrimaryKeyConvertor.toMediaPKFromMessagePK(e,t),await this.deleteMediasById("image",e,{newId:s,oldId:t}),!0}async doAddMediaToConversation(e,t){return Object(D.a)()?this.addMedias(e,t):h.a.doAddMediaToConversation(t,e)}async updateMsgIdForRelativeMedia(e,t,i){if(Object(D.a)()){const s=(t,i,s)=>{this.getMediaById(t,e,s).then((r=>{r&&(r.msgId=i,this.deleteMediasById(t,e,{newId:void 0,oldId:s}).then((()=>{this.addMedias(t,[r])})))}))};s("file",t,i),s("image",t,i),s("link",t,i)}else{const e=(e,t,i)=>{e.get(i).then((s=>{s&&(s.msgId=t,e.delete(i).then((()=>{e.insert(s)})))}))},s=b.default.getInstance();e(s.Core.File,t,i),e(s.Core.Image,t,i),e(s.Core.Link,t,i)}}async emptyMediaStores(e,t){e&&t&&t.length&&(Object(D.a)()?t.forEach((t=>{"file"===t?this._emptyNewMediaStore(b.default.getInstance().Media.File,e):"image"===t?this._emptyNewMediaStore(b.default.getInstance().Media.Image,e):"link"===t&&this._emptyNewMediaStore(b.default.getInstance().Media.Link,e)})):t.forEach((t=>{"file"===t?this._emptyOldMediaStore(b.default.getInstance().Core.File,e):"image"===t?this._emptyOldMediaStore(b.default.getInstance().Core.Image,e):"link"===t&&this._emptyOldMediaStore(b.default.getInstance().Core.Link,e)})))}async addMediasFromOldDB(e,t){if(!t||!t.length)return[];const i=this.getMediaRepository(e),s=h.a.getAllDeleteConv();let r=t,a=t.map((e=>e.msgId));if(s){const i=t.reduce(((t,i)=>{var r;const{userId:a}=i;if(null!==(r=s[a])&&void 0!==r&&r[e]){const r=i.msgId,n=s[a][e].lastId;n&&r&&n<r&&t.oldMediaEntitiesShouldAddToNewDB.push(i)}else t.oldMediaEntitiesShouldAddToNewDB.push(i);return t.oldMediaIdsShouldDeleteFromOldDB.push(i.msgId),t}),{oldMediaEntitiesShouldAddToNewDB:[],oldMediaIdsShouldDeleteFromOldDB:[]});r=i.oldMediaEntitiesShouldAddToNewDB,a=i.oldMediaIdsShouldDeleteFromOldDB}const n=await i.correctMediasInOldDB(r,{saveBack:!1}),o=this.getMediaMapper(e),d=n.map((e=>o.toDomainFromOldDomain(e))),l=await i.insertMulti(d);if(l.success.length){const e=l.success.map((e=>o.toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e)));return this._utilsMediaManager.createOrUpdateFromMedias(e),a}return[]}async getMediasFromOldDB(e,t,i){if(await this._isMigrationDone())return[];const s={from:"",to:i,excludeFrom:!0,excludeTo:!0},r={index:"primary",direction:T.CursorDirection.PREV,limit:t};return this.getMediaRepository(e).getOldDBTable().getAll(s,r)}async deleteMediasFromOldDB(e,t){const i=this.getMediaRepository(e);return(await i.getOldDBTable().deleteMulti(t)).success}async deleteMediasFromOldDBByRange(e,t,i){const s={from:"",to:i,excludeFrom:!0,excludeTo:!0},r={index:"primary",direction:T.CursorDirection.PREV,limit:t},a=this.getMediaRepository(e),n=await a.getOldDBTable().getAllKey(s,r);return(await a.getOldDBTable().deleteMulti(n)).success}async countTotalMediaInOldDB(e){try{return this.getMediaRepository(e).getOldDBTable().count()}catch(i){var t;const e=[null==i||null===(t=i.toString)||void 0===t?void 0:t.call(i),null==i?void 0:i.stack].join("\n");return this._logger.zsymb(21,"fBMRxo",["[countTotalMediaInOldDB] - error: {}","fWKhF2"],e),0}}async _testAddMedias(e,t=50){let i=[];const s=2*Date.now()+Math.round(1e5*Math.random())+1e3,r=5*Date.now()+Math.round(1e7*Math.random())+1e3,a=["0","123456123111111456","12345111111345","111111111111111","12345111111167890","2121212121112222121","1231231231232222123","22222222222222222","2111111111111222111","322222222222222222","12341234212341123","9753434346787646","1234123412341234","987651235545454545","123123455432123432","21212123443434545","5454544531321323","98909087567564545645"],n=["4037840159631073270",...JSON.parse('["101598415","124139871","147333052","169079931","194945127","200868372","225822710","276214855","355712826","361879215","910825795994501468","g100588026","g112969450","g1149397433596350988","g1352476194718464059","g147262698","g149205131","g158719108","g158754949","g160924468","g164283274","g175572981","g194334627","g230291933","g2426404535463764819","g245533229","g25193586","g257364624","g263690118","g285979907","g285992315","g28757702","g288999008","g289367881","g293290840","g301757910","g302249930","g302577276","g309222362","g312505929","g317894641","g318028102","g320951866","g321466298","g322706780","g325920125","g325933426","g328827910","g331912501","g34509241","g47431271","g5355130437069108654","g55402697","g6911969691454201107","g85951308"]')];switch(e){case"image":for(let e=0;e<t;e++){const t=a[Math.round(Math.random()*(a.length-1))],d=n[Math.round(Math.random()*(n.length-1))],l=s+e,c=r+e;i.push({userId:d,cliMsgId:l,fromUid:t,msgId:c.toString(),message:{hdUrl:"https://b-f62-zpg-r.zdn.vn/8236607293085145247/0d5e94a8fc3726697f26.jpg?e2esession=QIqxr2vdpiBkZh0yizDjKzJIO2LACOAaSb+KBDlUkbwlil6lySe5/p1RncUJJLfTJj1Co/AkPZAOh6ln",oriUrl:"https://b-f62-zpg-r.zdn.vn/8236607293085145247/0d5e94a8fc3726697f26.jpg?e2esession=QIqxr2vdpiBkZh0yizDjKzJIO2LACOAaSb+KBDlUkbwlil6lySe5/p1RncUJJLfTJj1Co/AkPZAOh6ln",params:'{"width":800,"height":800,"hd":"https://b-f62-zpg-r.zdn.vn/8236607293085145247/0d5e94a8fc3726697f26.jpg?e2esession=QIqxr2vdpiBkZh0yizDjKzJIO2LACOAaSb+KBDlUkbwlil6lySe5/p1RncUJJLfTJj1Co/AkPZAOh6ln","rawThumbUrl":"https://b-f62-zpg-r.zdn.vn/8236607293085145247/0d5e94a8fc3726697f26.jpg"}',thumbUrl:"https://f62-zpg-r.zdn.vn/1518777612491889561/5571c987a1187b462209.jpg?e2esession=YBl+XgC1U90bnMk4yPcU519rhnRW4KoItoeNXLpRsl/secNpaT3Nxkal57Nj3UZhy2rUFgxhf8Pcjwah",title:void 0},type:"image",isExpired:!1,isExpiredAll:!1,subType:Math.round(Math.random())?o.MSG_SUBTYPE_PHOTO:o.MSG_SUBTYPE_MEDIA_VIDEO,sendDttm:Date.now()+e,ttl:0,localPath:null,previewThumb:void 0,updateTime:Date.now(),width:0,height:0})}break;case"file":for(let e=0;e<t;e++){const t=a[Math.round(Math.random()*(a.length-1))],o=n[Math.round(Math.random()*(n.length-1))],d=s+e,l=r+e;i.push({userId:o,cliMsgId:d,fromUid:t,msgId:l.toString(),message:{href:"https://f27-group-zfr.zdn.vn/7f8b522a54e0babee3f1/117090926800068678?e2esession=RSHmz0Kj28vN9gMz6oFilBjFxVFqisUPnj3XpjlolXXpTo3bwJ0hqlUl5uR6Sr/wtHrtcyXqXj/mLYl3",params:'{"fileSize":8178,"checksum":"78c2c03eeab27abbdf28b0fe25088e30","checksumSha":"","fileExt":"xlsx","fdata":"{}","fType":1}',title:"program_matrix_laP5chSikftFYc_LmERud.xlsx"},type:"file",fileType:-1,extType:"",sendDttm:Date.now()+e,ttl:0,updateTime:Date.now(),localPath:null,folderPath:null,previewThumb:"",dimension:null,downloadError:!1,isExpired:!1,isExpiredAll:!1})}break;case"link":for(let e=0;e<t;e++){const t=a[Math.round(Math.random()*(a.length-1))],o=n[Math.round(Math.random()*(n.length-1))],d=s+e,l=r+e;i.push({userId:o,cliMsgId:d,fromUid:t,msgId:l.toString(),message:{action:"recommened.link",childnumber:0,description:"http://tinhte.vn",href:"http://tinhte.vn",oriUrl:"http://tinhte.vn",params:'{"mediaTitle":"http://tinhte.vn","artist":"","src":"tinhte.vn","stream_icon":"","streamUrl":"","type":0,"subType":3}',thumb:"",thumbUrl:"",title:"tinhte.vn",type:""},type:"link",sendDttm:Date.now()+e,ttl:0,updateTime:Date.now(),previewThumb:""})}}const d=this._getMediaDB(e,!1);await(null==d?void 0:d.insertMulti(i))}_getMediaDB(e,t){const i=b.default.getInstance();switch(e){case"image":return t?i.Media.Image:i.Core.Image;case"file":return t?i.Media.File:i.Core.File;case"link":return t?i.Media.Link:i.Core.Link}}_trackDBPerformance(e){Object(F.b)().logInfo(F.a.LoadMedia,{duration:e.executionTime,action_name:e.actionName,media_type:e.mediaType,result_size:e.resultSize})}})||s)||s)||s)||s)||s)||s)||s)||s)},"3dEI":function(e,t,i){"use strict";i.d(t,"b",(function(){return r}));var s=i("jDHv");const r=Object(s.define)("media-repository-factory")},"4ePI":function(e,t,i){"use strict";i.d(t,"a",(function(){return h}));var s=i("VTBJ"),r=i("NDmK"),a=i("fsN4"),n=i("GbHB"),o=i("1pet"),d=i("K4Ns"),l=i("wH4e"),c=i("8Nax"),m=i("z0WU"),g=i("XS0u"),u=i("8tev");class h{constructor(e,t,i,s,r,n){this._dbInstance=void 0,this._mediaMigrationManager=void 0,this._dalInstance=a.default.getInstance(),this.dbTable=void 0,this.logger=void 0,this.mediaType=void 0,this.dbTable=this._dalInstance[e][t],this._dbInstance=this._dalInstance[e],this.mediaType=i,this._mediaMigrationManager=r,this.logger=n.createZLogger(`${e}-${t}-repository`,[s])}async insert(e,t){if(!e)throw Error("[insert]: item is undefined!");if(!e.cliMsgId||!e.fromUid||!e.convId)throw Error(`[insert]: item doesn't have valid key_from_to: ${e.cliMsgId}_${e.fromUid}_${e.convId}`);return e.mediaId=`${e.cliMsgId}_${e.fromUid}_${e.convId}`,!!(await this.dbTable.insert(e,t))}insertMulti(e,t){if(!e||!e.length)throw Error("[insertMulti]: items is undefined or empty!");const i=[];return e.forEach((e=>{e.cliMsgId&&e.fromUid&&e.convId?(e.mediaId=`${e.cliMsgId}_${e.fromUid}_${e.convId}`,i.push(e)):this.logger.zsymb(21,"vKezdL",["[insertMulti]: media doesn't have valid key_from_to: {}_{}_{}","Lvk_NU"],e.cliMsgId,e.fromUid,e.convId)})),this.dbTable.insertMulti(i,t)}async update(e,t){if(!h.isNewMediaIdFormat(e))throw Error("[update]: mediaId doesn't have new media id format!");return!!(await this.dbTable.update(e,t))}async updateMedia(e,t,i=d.c.UNKNOWN){if(!e)throw Error("[updateMedia]: mediaIdObj is undefined!");const{newId:r,oldId:a}=e;if((i===d.c.NEW||await this._isMigrationDone())&&r)return!!(await this.dbTable.update(r,t));if(i===d.c.OLD&&a){let e;if(t){const i=this.getMediaMapper().toOldEAttsFromNewEAtts(t.value||{});return e=Object(s.a)(Object(s.a)({},t),{},{attributes:Object.keys(i),value:i}),!!(await this.getOldDBTable().update(a,e))}throw Error("options is undefined!")}try{if(r){if(await this.dbTable.get(r))return!!(await this.dbTable.update(r,t))}if(a){let e;if(t){const i=this.getMediaMapper().toOldEAttsFromNewEAtts(t.value||{});return e=Object(s.a)(Object(s.a)({},t),{},{attributes:Object.keys(i),value:i}),!!(await this.getOldDBTable().update(a,e))}throw Error("options is undefined!")}throw Error(`${r} or ${a} isn't valid!`)}catch(n){throw Error(`[updateMedia] - err: ${n.message}`)}}async updateMulti(e){return await this.dbTable.updateMulti(e)}async updateMultiMedias(e){throw Error("This updateMultiMedias isn't implemented!")}delete(e,t){if(!h.isNewMediaIdFormat(e))throw Error("[delete]: mediaId doesn't have new media id format!");return this.dbTable.delete(e,t)}deleteMulti(e,t){if(!e||!e.length)throw Error("[deleteMulti]: mediaIds is undefined or empty!");if(e.some((e=>!h.isNewMediaIdFormat(e))))throw Error("[deleteMulti]: mediaIds contains an id which doesn't have new media id format!");return this.dbTable.deleteMulti(e,t)}async deleteMedia(e,t,i=d.a.UNKNOWN){if(!e)throw Error("[deleteMedia]: mediaObj is undefined!");const{newId:s,oldId:r}=e;if((i===d.a.NEW||await this._isMigrationDone())&&s)return this.dbTable.delete(s);if(i===d.a.OLD&&r)return this.getOldDBTable().delete(r,t);{const e=[];s&&e.push(this.dbTable.delete(s,t)),r&&e.push(this.getOldDBTable().delete(r,t));return(await Promise.allSettled(e)).every((e=>"fulfilled"===e.status&&e.value))}}async deleteMultiMedias(e,t){if(!e||!e.length)throw Error("[deleteMultiMedias]: mediaIdObjs is undefined or empty!");const i={success:[],fail:[]},s=[];for(const{newId:r,oldId:a,deleteTo:n}of e){const e=(n===d.a.NEW?r:n===d.a.OLD?a:r||a||"")||"",o=async()=>{try{await this.deleteMedia({newId:r,oldId:a},t,n)&&i.success.push(e)}catch(o){var s;const t=[null==o||null===(s=o.toString)||void 0===s?void 0:s.call(o),null==o?void 0:o.stack].join("\n");this.logger.zsymb(18,"FTr-mv",t),i.fail.push(e)}};s.push(o)}return await Promise.allSettled(s.map((e=>e()))),i}async get(e,t){if(!h.isNewMediaIdFormat(e))throw Error("[get]: mediaId doesn't have new media id format!");return this.dbTable.get(e,t)}async getMulti(e,t){const{newIdFormats:i,oldIdFormats:s}=e.reduce(((e,t)=>(h.isNewMediaIdFormat(t)&&e.newIdFormats.push(t),e)),{newIdFormats:[],oldIdFormats:[]});let r=[];if(i.length){const e=await this.dbTable.getMulti(i,t);e.length&&r.push(...e)}return r}async getMedia(e,t,i=d.b.UNKNOWN){if(!e)throw Error("[getMedia]: mediaIdObj params is undefined!");const{newId:s,oldId:r}=e;if((i===d.b.NEW||await this._isMigrationDone())&&s)return this.dbTable.get(s,t);if(i===d.b.OLD&&r){const e=await this.getOldDBTable().get(r,t);if(e)return this.getMediaMapper().toDomainFromOldDomain(e)}else{if(s){const e=await this.dbTable.get(s,t);if(e)return e}if(r){const e=await this.getOldDBTable().get(r,t);if(e)return this.getMediaMapper().toDomainFromOldDomain(e)}}}async getMultiMedias(e,t){if(!e||!e.length)throw Error("[getMultiMedias]: mediaIdObjs is undefined or empty!");let i=[];const s=[];for(const{newId:r,oldId:a,getFrom:n}of e)s.push(this.getMedia({newId:r,oldId:a},t,"number"==typeof n?n:d.b.UNKNOWN));return i=(await Promise.allSettled(s)).map((e=>"fulfilled"===e.status?e.value:void 0)),i}getAll(e,t){if(!e)throw Error("[getAll]: keyRange is undefined!");return this.dbTable.getAll(e,t)}async getAllInOldDB(e,t){if(await this._isMigrationDone())return[];if(!e)throw Error("[getAllInOldDB]: keyRange is undefined!");const i=await this.getOldDBTable().getAll(e,t);return null!=i&&i.length?i.map((e=>this.getMediaMapper().toDomainFromOldDomain(e))):[]}static isNewMediaIdFormat(e){if(!e)return!1;const t=e.split("_");return 3===t.length&&t.every(Boolean)}static filterMedia(e,t){if(!(t&&(t.member||t.date&&(t.date.start||t.date.end)||t.name||t.ext)))return!0;if(!t.member||e.fromUid&&e.fromUid===t.member){let s,r,a;if(t.name){if(e.message.params&&e.message.href)try{let t=JSON.parse(e.message.params);s=t.mediaTitle?m.default.simpleStripVietnamese(t.mediaTitle):m.default.simpleStripVietnamese(e.message.title),r=t.src}catch(i){return m.default.logCoreError(i),!1}a=m.default.simpleStripVietnamese(t.name)}if(!t.name||a.length<=s.length&&m.default.searchContent(s,a)){let s=!1;if(t.ext&&(s=o.fileExt[t.ext].some((t=>{if(!e.message.title){const t=n.a.decrypt(e.message,g.default.UIN,!1);try{e.message=JSON.parse(t)}catch(i){e.message={title:""}}}return e.message.title.endsWith(t)}))),!t.ext||s)return null==t.date.start&&null==t.date.end||(e.sendDttm>=t.date.start?e.sendDttm<=t.date.end:0)}}return!1}async isExistedMedia(e){let t=!1;if(e){const{newId:i,oldId:s}=e;i&&(t=!!(await this.dbTable.get(i))),s&&!t&&(t=!!(await this.getOldDBTable().get(s)))}return t}async getLastMediasOfConv(e,t,i=100){if(!e||!t)throw Error(`[getLastMediasOfConv]: convId: ${e}, lastItemOptions:${JSON.stringify(t)} isn't valid!`);const{sendDttm:s,cliMsgId:r,msgId:a}=t,n=await this.getLastMediasOfConvInNewDB(e,{sendDttm:s,cliMsgId:r},i);return n.length<i&&!(await this._isMigrationDone())&&n.push(...await this.getLastMediasOfConvInOldDB(e,{msgId:a},i-n.length)),n}async countMediaOfConv(e,t){let i=0;if(!(e&&t&&t.from&&t.to))throw Error(`[countMediaOfConv]: convId: ${e}, options: ${JSON.stringify(t)} isn't valid!`);const{from:s,to:r}=t;return i=await this.countMediaOfConvInNewDB(e,{from:{sendDttm:s.sendDttm,cliMsgId:s.cliMsgId},to:{sendDttm:r.sendDttm,cliMsgId:r.cliMsgId}}),await this._isMigrationDone()||(i+=await this.countMediaOfConvInOldDB(e,{from:{msgId:s.msgId},to:{msgId:r.msgId}})),i}countMediaOfConvInNewDB(e,t){const{from:i,to:s}=t,r={from:[e,i.sendDttm,i.cliMsgId],to:[e,s.sendDttm,s.cliMsgId],excludeFrom:!1,excludeTo:!1};return this.dbTable.count(r,{index:"convId_sendDttm_cliMsgId"})}async countMediaOfConvInOldDB(e,t){if(await this._isMigrationDone())return 0;const{from:i,to:s}=t,r={from:[e,i.msgId.length,i.msgId],to:[e,s.msgId.length,s.msgId],excludeFrom:!1,excludeTo:!1};return this.getOldDBTable().count(r,{index:"userId_sendDttm_msgId"})}async getMediasOfConv(e,t,i,s){if(!e||!t||!i)return Promise.resolve([]);let a=[];if(r.default.load_media.optimize_mode&&(a=await this._isMigrationDone()?await this.getMediasOfConvOptimizeMode(e,t,i,s):await this.getMediasOfConvOptimizeModeInMixedDB(e,t,i,s)),null!=s&&s.deletePointOfConv){const{lastId:e,lastSendDttm:t,lastCliMsgId:i}=s.deletePointOfConv;return a.filter((s=>!(e&&s.msgId&&s.msgId<=e)&&(!(t&&s.sendDttm<=t)&&!(i&&s.cliMsgId<=i))))}return a}async getMediasOfConvOptimizeModeInMixedDB(e,t,i,s){let r=!1,a=!1;s&&s.date&&(null!==s.date.start||null!==s.date.end)&&(r=!0);const n=[],{sendDttm:o,cliMsgId:d}=await this.getSendDttmOfLatestMediaInOldDB(e),{sendDttm:g,cliMsgId:u,msgId:p}=t,f={from:[e,0,""],to:[e,g,u],excludeFrom:!0,excludeTo:!0},M={index:"convId_sendDttm_cliMsgId",limit:i,direction:l.CursorDirection.PREV,useLGKeyRange:!0,predicate:e=>{if(!e)return!1;if(!m.default.mapHasItem(e.content))return!1;if(!c.a.instance.filterDBMessage(e))return!1;let t=h.filterMedia({message:e.content,fromUid:e.fromUid,sendDttm:e.sendDttm},s);return 0===t&&(a=!0),!!t&&(e.sendDttm>o&&e.cliMsgId>d||(n.push(e),!1))},aborted:r?()=>a:void 0};try{let t=await this.dbTable.getAll(f,M);if(t.length<i){const r=await this.getMediasOfConvOptimizeModeInOldDB(e,{msgId:p},i-t.length,s),a=[];r.length>0?n.length>0?(r.forEach((e=>{const t=n[0];t&&e.sendDttm<=t.sendDttm&&e.cliMsgId<=t.cliMsgId?(a.push(t),n.shift()):a.push(e)})),n.length>0&&a.push(...n),t.push(...a.slice(0,i-t.length))):t.push(...r):n.length>0&&t.push(...n)}return t}catch(I){const t=[e,this.mediaType,i,g,u,!!s].join("_");throw this.logger.zsymb(21,"tzSXMB",["[getMediasOfConvOptimizeModeInMixedDB] errInfo: {}","NEtm6U"],t),I}}async getSendDttmOfLatestMediaInOldDB(e){const t={from:[e,0,""],to:[e,o.MessageConstants.MAX_SENDDTTM,o.MessageConstants.MAX_MSG_ID],excludeFrom:!1,excludeTo:!1},i={index:"userId_sendDttm_msgId",limit:1,direction:l.CursorDirection.PREV},s=await this.getOldDBTable().getAll(t,i);if(!s||!s[0])return{sendDttm:0,cliMsgId:"0"};return{sendDttm:"string"==typeof s[0].sendDttm?parseInt(s[0].sendDttm):s[0].sendDttm,cliMsgId:""+(s[0].cliMsgId||0)}}async getMediasOfConvOptimizeMode(e,t,i,s){if(!e||!t||!i)throw Error(`[getMediasOfConvOptimizeMode]: convId: ${e}, lastItemOptions: ${JSON.stringify(t)}, limit: ${i} isn't valid!`);const{sendDttm:r,cliMsgId:a,msgId:n}=t,o=await this.getMediasOfConvOptimizeModeInNewDB(e,{sendDttm:r,cliMsgId:a},i,s);return o.length<i&&!(await this._isMigrationDone())&&o.push(...await this.getMediasOfConvOptimizeModeInOldDB(e,{msgId:n},i-o.length,s)),o}getMediasOfConvOptimizeModeInNewDB(e,t,i,s){let r=!1,a=!1;s&&s.date&&(null!==s.date.start||null!==s.date.end)&&(r=!0);const{sendDttm:n,cliMsgId:o}=t,d={from:[e,0,""],to:[e,n,o],excludeFrom:!0,excludeTo:!0},g={index:"convId_sendDttm_cliMsgId",limit:i,direction:l.CursorDirection.PREV,predicate:e=>{if(!e)return!1;if(!m.default.mapHasItem(e.content))return!1;if(!c.a.instance.filterDBMessage(e))return!1;let t=h.filterMedia({message:e.content,fromUid:e.fromUid,sendDttm:e.sendDttm},s);return 0===t&&(a=!0),!!t},aborted:r?()=>a:void 0};try{return this.dbTable.getAll(d,g)}catch(u){const t=[e,this.mediaType,i,n,o,!!s].join("_");throw this.logger.zsymb(21,"nlfBaJ",["[getMediasOfConvOptimizeModeInNewDB] errInfo: {}","3Lyb_z"],t),u}}async getMediasOfConvOptimizeModeInOldDB(e,t,i,s){if(await this._isMigrationDone())return[];let r=!1,a=!1;s&&s.date&&(null!=s.date.start||null!=s.date.end)&&(r=!0);const{msgId:n}=t,o={from:[e,0,""],to:[e,n.length,n],excludeFrom:!0,excludeTo:!0},d={index:"userId_sendDttm_msgId",limit:i,direction:l.CursorDirection.PREV,useLGKeyRange:!0,predicate:e=>{if(e){if(e.msgId&&e.msgId.includes("_"))return!1;if(!m.default.mapHasItem(e.message))return!1}if(!c.a.instance.filterDBMessage(e))return!1;let t=h.filterMedia(e,s);return 0===t&&(a=!0),!!t},aborted:r?()=>a:void 0};try{const e=await this.getOldDBTable().getAll(o,d);return(await this.correctMediasInOldDB(e)).map((e=>this.getMediaMapper().toDomainFromOldDomain(e)))}catch(g){const t=[e,this.mediaType,i,n,!!s].join("_");throw this.logger.zsymb(21,"WxR2X2",["[getMediasOfConvOptimizeModeInOldDB] errInfo: {}","2OPoNi"],t),g}}getLastMediasOfConvInNewDB(e,t,i){const{sendDttm:s,cliMsgId:r}=t,a={from:[e,0,""],to:[e,s,r],excludeFrom:!1,excludeTo:!1},n={index:"convId_sendDttm_cliMsgId",limit:i,direction:l.CursorDirection.PREV};return this.dbTable.getAll(a,n)}async getLastMediasOfConvInOldDB(e,t,i){if(await this._isMigrationDone())return[];const{msgId:r}=t,a={from:[e,0,""],to:[e,r.length,r],excludeFrom:!1,excludeTo:!1},n={index:"userId_sendDttm_msgId",limit:i,direction:l.CursorDirection.PREV},o=await this.getOldDBTable().getAll(a,n);return o.length>0?o.map((e=>Object(s.a)(Object(s.a)({},this.getMediaMapper().toDomainFromOldDomain(e)),{},{msgId:e.msgId}))):[]}correctMediasInOldDB(e,t={saveBack:!0}){return e&&e.length?new Promise((i=>{let s=[],r={},a=[];if(e.forEach((e=>{if(e&&e.msgId&&e.sendDttm){const t=null==e.fromUid;e.type&&e.cliMsgId&&!t?a.push(e):(s.push(e.msgId),r[e.msgId]=e)}})),!s.length)return i(a);{let n="";const d=(e,t)=>{let i=!0;switch(t.msgType){case o.MSG_PHOTO:case o.MSG_PHOTO_2:n="image",e.subType=o.MSG_SUBTYPE_PHOTO;break;case o.MSG_VIDEO:n="image",e.subType=o.MSG_SUBTYPE_MEDIA_VIDEO;break;case o.MSG_FILE:n="file";break;case o.MSG_CONTACT:"object"==typeof t.message&&"recommened.link"===t.message.action&&(n="link")}e.cliMsgId=t.cliMsgId,e.type=n;return""!==t.fromUid&&null!=t.fromUid?(i=!0,e.fromUid=t.fromUid+""):i=!1,{isSuccess:i,data:i?e:null}},l=e[0].userId;g.default.getConvMessagesByIdsInQueue(s,l).then((e=>{const s=[],n=[];if(e){for(let i in e)if(e[i]){const t=r[i];delete r[i];const{isSuccess:a,data:o}=d(t,e[i]);a&&o?s.push(o):n.push(i)}const t=Object.getOwnPropertyNames(r);t.length&&t.forEach((e=>{n.push(e)}))}let o=a.concat(s);return o.sort(((e,t)=>parseInt(t.sendDttm)-parseInt(e.sendDttm))),s.length&&t.saveBack&&this.deleteAndInsertInOldDB(s),n.length&&this.getOldDBTable().deleteMulti(n),i(o)})).catch((e=>i(a)))}})):Promise.resolve([])}async deleteAndInsertInOldDB(e){if(!e||!e.length)throw Error(`[deleteAndInsertInOldDB]: oldItems: ${JSON.stringify(e)} isn't valid!`);return this.getOldDBTable().insertMulti(e,{replace:!0})}async _isMigrationDone(){return(await this._mediaMigrationManager.getMediaMigrationState()).stateName===u.b.DONE}}},"5R0e":function(e,t,i){"use strict";i.d(t,"a",(function(){return a})),i.d(t,"b",(function(){return n}));var s=i("4ePI"),r=i("jDHv");class a extends s.a{constructor(e,t,i,s,r,a){super(e,t,i,s,r,a)}}const n=Object(r.define)("link-media-repository")},"5txd":function(e,t,i){"use strict";function s(e){const t=e;return function(e,i,s="error"){const r=`${e} ${s}: ${i}`;switch(s){case"error":t.zsymb(18,"hpAxD8",r);break;case"debug":t.zsymb(12,"jlgeBX",r);break;case"info":t.zsymb(0,"K2Fft9",r)}}}i.d(t,"a",(function(){return s}))},"7WMW":function(e,t,i){"use strict";i.d(t,"a",(function(){return s.a})),i.d(t,"b",(function(){})),i.d(t,"c",(function(){return a}));i("AjFa"),i("W13p"),i("5R0e");var s=i("4ePI"),r=i("jDHv");const a=Object(r.define)("utils-media-repository")},"8tev":function(e,t,i){"use strict";i.d(t,"b",(function(){return s})),i.d(t,"d",(function(){return r})),i.d(t,"e",(function(){return a})),i.d(t,"a",(function(){return n})),i.d(t,"c",(function(){return o}));const s={DONE:"DONE",NOT_DONE:"NOT_DONE",UNKNOWN:"UNKNOWN"},r={GET_FROM_OLD_DB:"GET_FROM_OLD_DB",ADD_TO_NEW_DB:"ADD_TO_NEW_DB",DELETE_FROM_OLD_DB:"DELETE_FROM_OLD_DB"},a={DONE:"DONE",FAILED:"FAILED"},n={NEW:"NEW",LOAD_FROM_LOCAL:"LOAD_FROM_LOCAL",RUNNING:"RUNNING",DONE:"DONE",FAILED:"FAILED"},o={PERSISTED_JOB_DESC_SUMMARIES_KEY:"persisted_job_desc_summaries",MSG_ID_CURSOR_KEY:"msg_id_cursor",MIGRATION_STATE_KEY:"migration_state"}},AjFa:function(e,t,i){"use strict";i.d(t,"a",(function(){return m})),i.d(t,"b",(function(){return g}));var s=i("VTBJ"),r=i("4ePI"),a=i("jDHv"),n=i("wH4e"),o=i("fsN4"),d=i("z0WU"),l=i("1pet"),c=i("XS0u");class m extends r.a{constructor(e,t,i,s,r,a){super(e,t,i,s,r,a)}async getImageMessagesForPhotoViewer(e,t,i,r,a,n){const d=await this.getMsgIdsOfImageMediaForPhotoViewer(e,i,t,r,a,n);if(null==d||!d.length)return[];const l=await Promise.all(d.map((e=>this.getMediaMapper().toDTO(e)))),m=[];let g=[];for(const c of l)m.push(o.default.getInstance().Core.Message.get(c.msgId,{partition:e}).then((e=>{e?g.push(Object(s.a)(Object(s.a)({},c),e)):c.message&&g.push(c)})));return await Promise.all(m),g.reverse(),c.default._fillExifBeforeShow(g),g}async getMsgIdsOfImageMediaForPhotoViewer(e,t,i,s,r,a){const{cliMsgId:o,sendDttm:c,msgId:m}=t,g=s&&r;let u=!1;const h=()=>u,p=e=>{if(!(a&&(a.member||a.date&&(a.date.start||a.date.end)||a.name||a.ext)))return!0;if(!a.member||e.fromUid&&e.fromUid===a.member){let i,s,r;if(a.name){if(e.message.params&&e.message.href)try{let t=JSON.parse(e.message.params);i=t.mediaTitle?d.default.simpleStripVietnamese(t.mediaTitle):d.default.simpleStripVietnamese(e.message.title),s=t.src}catch(t){return this.logger.zsymb(18,"sj4E3Y",t),!1}r=d.default.simpleStripVietnamese(a.name)}if(!a.name||d.default.searchContent(i,r)||d.default.searchContent(s,r)){let t=!1;if(a.ext&&(t=l.fileExt[a.ext].some((t=>e.message.title.endsWith(t)))),!a.ext||t)return!a.date.start||!a.date.end||(a.date.end<e.sendDttm?e.sendDttm<a.date.start+864e5:(u=!0,!1))}}return!1};let f=[];if(s){const t=async()=>{let t=[];if(!(await this._isMigrationDone())){const s={from:[e,m.length,m],to:[e,l.MessageConstants.MAX_MSG_ID.length,l.MessageConstants.MAX_MSG_ID],excludeFrom:!g,excludeTo:!g},r={limit:i,index:"userId_sendDttm_msgId",direction:n.CursorDirection.NEXT,predicate:e=>p({fromUid:e.fromUid,message:e.message,sendDttm:"string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm}),aborted:h,useLGKeyRange:!0};t=await this.getAllInOldDB(s,r)}if(t.length<i){const s={from:[e,c,o],to:[e,parseInt(l.MessageConstants.MAX_SENDDTTM),l.MessageConstants.MAX_MSG_ID],excludeFrom:!g,excludeTo:!g},r={limit:i-t.length,index:"convId_sendDttm_cliMsgId",direction:n.CursorDirection.NEXT,predicate:e=>p({fromUid:e.fromUid,message:e.content,sendDttm:e.sendDttm}),aborted:h,useLGKeyRange:!0};t.push(...await this.getAll(s,r))}return t};f.push(t())}if(r){const t=async()=>{let t=[];const s={from:[e,0,""],to:[e,c,o],excludeFrom:!g,excludeTo:!g},r={limit:i,index:"convId_sendDttm_cliMsgId",direction:n.CursorDirection.PREV,predicate:e=>p({fromUid:e.fromUid,message:e.content,sendDttm:e.sendDttm}),aborted:h,useLGKeyRange:!0};if(t=await this.getAll(s,r),t.length<i&&!(await this._isMigrationDone())){const s={from:[e,0,""],to:[e,m.length,m],excludeFrom:!g,excludeTo:!g},r={limit:t?i-t.length:i,index:"userId_sendDttm_msgId",direction:n.CursorDirection.PREV,predicate:e=>p({fromUid:e.fromUid,message:e.message,sendDttm:"string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm}),aborted:h,useLGKeyRange:!0};t.push(...await this.getAllInOldDB(s,r))}return t};f.push(t())}try{const e=await Promise.all(f);if(2===e.length){let t=e[0].reverse();return t.pop(),t=t.concat(e[1]),t}return r?e[0]:e[0].reverse()}catch(M){return this.logger.zsymb(18,"Wp5MK8",M),[]}}}const g=Object(a.define)("image-media-repository")},Ceyj:function(e,t,i){"use strict";var s=i("VTBJ"),r=i("fsN4");function a(e,t){return e.reduce(((e,i,s,r)=>(e[t(i,s,r)?0:1].push(i),e)),[[],[]])}var n,o=i("D8f9"),d=i("1pet"),l=i("jDHv"),c=i("fqRP"),m=i("Mgpg"),g=i("MPLC");const u=d.MessageConstants.MAX_MSG_ID;Object(l.singleton)(c.a)(n=Reflect.metadata("design:type",Function)(n=Reflect.metadata("design:paramtypes",[])(n=class{constructor(){this._logger=void 0,this.dispose=()=>{},this.correctTTLItemEntity=e=>{function t(e,t){return null==e?t:e}const i=Object(s.a)({},e);return i.beginTime=t(i.beginTime,0),i.cliMsgId=t(i.cliMsgId,""),i.expireOn=t(i.expireOn,Date.now()),i.fromUid=t(i.fromUid,""),i.mediaType=t(i.mediaType,""),i.msgId=t(i.msgId,""),i.sendDttm=t(i.sendDttm,"")+"",i.serverTime=t(i.serverTime,"")+"",i.toUid=t(i.toUid,""),i.ttl=t(i.ttl,0),i.ttlType=t(i.ttlType,""),i},this._safePut=async e=>{const t=[],i=[],s=r.default.getInstance();for(const r of e)try{const e=this.correctTTLItemEntity(r);await s.MsgInfo.TTLItem.insert(e,{replace:!0}),t.push(r)}catch(a){i.push([r,a])}return[t,i]},this.putMsgs=async e=>{let t=e.map((e=>f(e)));const[i,s]=a(t,(e=>e.ok)),r=i.map((e=>e.value));let n=[],o=[];[o,n]=await this._safePut(r);const d=s.map((e=>e.error));return n.lastItem||d.length?{ok:!1,error:{invalidItems:d,errorItems:n}}:{ok:!0,value:o}},this.deletes=e=>r.default.getInstance().MsgInfo.TTLItem.deleteMulti(e),this.getExpireItemsBefore=async(e,t)=>{const i=t?{from:[t.expireOn,t.toUid,t.msgId,t.ttlType],to:[e,d.MessageConstants.MAX_CONVERSATION_ID,u],excludeFrom:!1,excludeTo:!0}:{to:[e],excludeTo:!1},s={limit:50,index:"expireOn_toUid_pk"},a=r.default.getInstance();return await a.MsgInfo.TTLItem.getAll(i,s)},this.getYoungestExpiredItem=async()=>{const e={to:[Number.MAX_VALUE],excludeTo:!0},t=r.default.getInstance();return(await t.MsgInfo.TTLItem.getAll(e,{limit:1,index:"expireOn_toUid_pk"}))[0]},this.getMappedMsgsByConvIdFromTTLItems=async e=>{const t=g.b.messageCache;let i;return t&&(i=await t.getMappedMessagesByConvIdAsync(e)),i},this._logger=l.ModuleContainer.resolve(m.ZLoggerFactory).createZLogger("utils",["ttl","destructor","ttl"])}})||n)||n);const h=e=>"number"==typeof e?String(e):e,p=[o.a.Message,o.a.Quote],f=(e={})=>{const t=Object(s.a)({},e);return t.cliMsgId=h(t.cliMsgId),t.cliMsgId?(t.fromUid=h(t.fromUid),t.fromUid?(t.toUid=h(t.toUid),t.toUid?(t.msgId=h(t.msgId),i=t.ttlType,p.includes(i)?(t.expireOn=+t.expireOn,"number"!=typeof t.expireOn?{ok:!1,error:e}:{ok:!0,value:t}):{ok:!1,error:e}):{ok:!1,error:e}):{ok:!1,error:e}):{ok:!1,error:e};var i}},ClHk:function(e,t,i){"use strict";i.d(t,"a",(function(){return d}));var s,r=i("VTBJ"),a=i("jDHv"),n=i("hI9i"),o=i("rCQs");const d=Object(a.define)("shared-tasks-monitor");Object(o.b)(d)(s=class{constructor(){this.tasks=new Map,this.taskIds=[],this.name="shared-tasks-monitor",this.key="id"}insertTask(e,t){this.taskIds.length>20&&(this.taskIds=this.taskIds.slice(1)),this.taskIds=[...this.taskIds,e],this.tasks.set(e,{id:e,type:t,startTime:Date.now(),endTime:0,progress:0,status:"running"}),Object(n.h)(this.name,"all")}updateTaskProgress(e,t){const i=this.tasks.get(e);i&&(this.tasks.set(e,Object(r.a)(Object(r.a)({},i),{},{progress:t})),Object(n.g)(this.name,e))}updateTaskStatus(e,t){const i=this.tasks.get(e);i&&(this.tasks.set(e,Object(r.a)(Object(r.a)({},i),{},{status:t})),Object(n.g)(this.name,e))}init(){}getItem(e,t){return this.tasks.get(e.key)}getList(){return this.taskIds}onGetItemFailure(){}onGetListFailure(){}})},Hbak:function(e,t,i){"use strict";var s,r=i("jDHv"),a=i("8/YW"),n=i("dOPt"),o=i("ClHk"),d=i("Mgpg");Object(a.j)()(s=Object(r.singleton)(n.a)(s=Object(r.injectable)()(s=function(e,t){return Object(r.inject)(d.ZLoggerFactory)(e,void 0,0)}(s=Reflect.metadata("design:type",Function)(s=Reflect.metadata("design:paramtypes",[void 0===d.ZLoggerFactory?Object:d.ZLoggerFactory])(s=class{constructor(e){this.handlers=new Map,this.runningMap=new Map,this.logger=void 0,this.monitor=void 0,this.logger=e.createZLogger("core",["shared-worker-runner"]),this.monitor=r.ModuleContainer.resolveIfExist(o.a)}onStart(){this.logger.zsymb(3,"lrxuQI",["start","WxrJ0m"]),$zsharedWorker.start(),$zsub.$zsharedWorker.onRequestRunTask((async(e,t)=>{var i;const s=this.handlers.get(t.type);if(!s)return;null===(i=this.monitor)||void 0===i||i.insertTask(t.id,t.type),this.logger.zsymb(3,"if0B4o",["{} id: {}","hzOVUf"],t.type,t.id);const r=new AbortController,a=t.id,n={abort:r,updateParams:()=>{}};this.runningMap.set(a,n),this.logger.zsymb(3,"ewCPc_",["{} id: {} start","TKyvNa"],t.type,t.id);try{const e=(e,i)=>{var s;$zsharedWorker.updateProgress({id:a,progress:e,checkpoint:i}),null===(s=this.monitor)||void 0===s||s.updateTaskProgress(t.id,e)};await s.execute({abort:r.signal,params:t.params,checkpoint:t.checkpoint,onParamsChange:e=>{n.updateParams=e},report:e}).then((e=>{var i;r.signal.aborted||(null===(i=this.monitor)||void 0===i||i.updateTaskStatus(t.id,"finished"),$zsharedWorker.responseResult({id:a,result:e}),this.logger.zsymb(3,"7xCxi_",["{} id: {} finished","zlX2wc"],t.type,t.id))})).catch((e=>{var i;if(r.signal.aborted)return;null===(i=this.monitor)||void 0===i||i.updateTaskStatus(t.id,"error");const s="number"==typeof e.error?e.error:-999;$zsharedWorker.responseResult({id:a,error:{message:e.message,error_code:s}}),this.logger.zsymb(0,"tjVCHc",(()=>[`task ${t.type} id: ${t.id} failed`,{error:e}]))}))}catch(d){var o;null===(o=this.monitor)||void 0===o||o.updateTaskStatus(t.id,"error"),$zsharedWorker.responseResult({id:a,error:{message:d.message}}),this.logger.zsymb(0,"cI_n-t",(()=>[`task ${t.type} id: ${t.id} failed`,{error:d}]))}this.runningMap.delete(a)})),$zsub.$zsharedWorker.onRequestAbortTask(((e,t)=>{const i=this.runningMap.get(t.id);var s;i&&(null===(s=this.monitor)||void 0===s||s.updateTaskStatus(t.id,"error"),i.abort.abort());this.logger.zsymb(3,"xyw0y_",["abort task {} id: {}","HP1Vgm"],t.type,t.id)})),$zsub.$zsharedWorker.onRequestUpdateTaskParams(((e,t)=>{const i=this.runningMap.get(t.id);if(i)return i.updateParams(t.params),void this.logger.zsymb(3,"Y2sx_2",["{} id: {} - updated params","FJnn95"],t.type,t.id);this.logger.zsymb(18,"b7JW_S",`${t.type} id: ${t.id} - update params failed. task not found`)}));const e=()=>{$zFileManager.cleanupLogFileDescriptors(),$zsub.$zsharedWorker.removeListenUnloadZLog(e)};$zsub.$zsharedWorker.onUnloadZLog(e),"shared-worker"===__ZaBUNDLENAME__&&this.startCheckAlive()}registerHandler(e,t){this.logger.zsymb(3,"3BO7MV",["register handler: {}","L0LS1a"],e),this.handlers.set(e,t),$zsharedWorker.register(e)}startCheckAlive(){this.logger.zsymb(3,"5z36eb",["start check alive","6XGRLT"]),setInterval((()=>{this.logger.zsymb(3,"Y1huno",["sending ping","k-3kRl"]),$zsharedWorker.ping()}),6e4)}})||s)||s)||s)||s)||s)},Hy6w:function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));var s=i("VTBJ");class r{constructor(e){this.label=e,this.data=new Map,this.id=0,this.locked=!1}get nextId(){return++this.id}get info(){return`${this.label}: ${this.time}`}get time(){let e=0;return this.data.forEach((t=>e+=t.time)),e}lock(){this.locked=!0}unlock(){this.locked=!1}getTracker(){const e=this.nextId;return{start:()=>this.start(e),end:()=>this.end(e),do:(t,...i)=>{this.start(e);const s=t(...i);return this.end(e),s},doAsync:(t,...i)=>(this.start(e),t(...i).then((t=>(this.end(e),t)))),reset:()=>{this.data.delete(e)}}}start(e){if(this.locked)return;const t=this.data.get(e);if(t){let i=t.start;t.counting<=0&&(i=Date.now()),this.data.set(e,Object(s.a)(Object(s.a)({},t),{},{counting:t.counting+1,start:i}))}else this.data.set(e,{counting:1,time:0,start:Date.now()})}end(e){if(this.locked)return;const t=this.data.get(e);if(t){let i=t.start,r=t.time+Date.now()-t.start;t.counting&&t.counting>1&&(i=Date.now()),this.data.set(e,Object(s.a)(Object(s.a)({},t),{},{time:r,start:i,counting:t.counting-1}))}}}},K4Ns:function(e,t,i){"use strict";i.d(t,"c",(function(){return s})),i.d(t,"b",(function(){return r})),i.d(t,"a",(function(){return a}));let s=function(e){return e[e.OLD=0]="OLD",e[e.NEW=1]="NEW",e[e.UNKNOWN=2]="UNKNOWN",e}({}),r=function(e){return e[e.OLD=0]="OLD",e[e.NEW=1]="NEW",e[e.UNKNOWN=2]="UNKNOWN",e}({}),a=function(e){return e[e.OLD=0]="OLD",e[e.NEW=1]="NEW",e[e.UNKNOWN=2]="UNKNOWN",e}({})},KPNQ:function(e,t,i){"use strict";i.d(t,"b",(function(){return r}));var s=i("jDHv");const r=Object(s.define)("media-primary-key-convertor")},KszJ:function(e,t,i){"use strict";var s,r=i("jDHv"),a=i("8/YW"),n=i("Xy/4"),o=i("Mgpg"),d=i("/n5c");Object(a.j)()(s=Object(a.h)()(s=Object(r.injectable)()(s=Object(r.singleton)(n.a)(s=function(e,t){return Object(r.inject)(o.ZLoggerFactory)(e,void 0,0)}(s=Reflect.metadata("design:type",Function)(s=Reflect.metadata("design:paramtypes",[void 0===o.ZLoggerFactory?Object:o.ZLoggerFactory])(s=class{constructor(e){this.idCounter=0,this.runningTasks=new Map,this.logger=void 0,this.logger=e.createZLogger("shared-worker",["client"])}onStart(){$zsub.$zsharedWorker.onReceiveUpdateProgress(((e,t)=>{const i=this.runningTasks.get(t.id);i?i.notifyProgressChange(t.progress,t.checkpoint):$zsharedWorker.abortTask({id:t.id})})),$zsub.$zsharedWorker.onReceiveResult(((e,t)=>{const i=this.runningTasks.get(t.id);i?(this.logger.zsymb(3,"gfdtdu",["resolve:{} id: {} success:{}","pNCrBT"],i.type,t.id,!t.error),t.error?i.notifyError(t.error):i.notifyResult(t.result,t.checkpoint),this.runningTasks.delete(t.id)):this.logger.zsymb(18,"Vs-rVP",(()=>["not found resolver for task",{id:t.id}]))}));const e=async()=>{await r.ModuleContainer.resolve(d.a).tryFlushAll(),await $zFileManager.cleanupLogFileDescriptors(),$zsub.$zwindow.removeListenUnloadZLog(e)};$zsub.$zwindow.onUnloadZLog(e)}onDispose(){$zsharedWorker.dispose()}run(e){const t=(this.idCounter++).toString();e.id=t,this.runningTasks.set(t,e),this.logger.zsymb(3,"chrj72",["run:{} id: {}","uVx8I-"],e.type,t),$zsharedWorker.runTask(e.toDescriptor())}abort(e){this.runningTasks.get(e)&&(this.runningTasks.delete(e),$zsharedWorker.abortTask({id:e}))}notifyChangeParams(e,t){const i=this.runningTasks.get(e);if(!i)throw new Error(`not found task with id: ${e}`);const s={id:e,type:i.type,params:t};$zsharedWorker.updateTaskParams(s)}})||s)||s)||s)||s)||s)||s)},"Q/Ir":function(e,t,i){"use strict";var s=i("jDHv"),r=i("8/YW"),a=i("Mgpg"),n=i("+eUS"),o=i("wH4e"),d=i("YrRS");const l="render"!==__ZaBUNDLENAME__&&"WEB"!==__ZaBUNDLENAME__&&"shared-worker"!==__ZaBUNDLENAME__&&"main"!==__ZaBUNDLENAME__;setTimeout((async function(){if(l)return;const e=s.ModuleContainer.resolve(a.ZLoggerFactory).createZLogger("bootstrap",["shared"]);e.zsymb(3,"aAhUkC",["running application bootstrap","F9lM3W"]);let t=(()=>{switch(__ZaBUNDLENAME__){case"WEB":return o.RunMode.Browser;case"render":return o.RunMode.Host;case"shared-worker":return o.RunMode.Client;case"main":return o.RunMode.Background;default:return o.RunMode.Unknown}})();try{const i=s.ModuleContainer.resolve(r.a);await i.start(),Object(n.a)(t),t===o.RunMode.Browser&&Object(d.b)(),"shared-worker"===__ZaBUNDLENAME__&&await i.init(),e.zsymb(3,"q-ylI-",["application bootstrap success","FU-L8m"])}catch(i){e.zsymb(0,"XdmVWp",(()=>["application bootstrap fail",{reason:i}]))}}),0)},W13p:function(e,t,i){"use strict";i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return o}));var s=i("4ePI"),r=i("jDHv"),a=i("wH4e");class n extends s.a{constructor(e,t,i,s,r,a){super(e,t,i,s,r,a)}async getLastestAddedFiles(e,t){if(!e||"number"!=typeof t)throw Error(`[getLastestAddedFiles]: ${JSON.stringify(e)} or ${t} isn't valid!`);const i=await this.getLastestAddedFilesInNewDB(e,t);return i.length<t&&!(await this._isMigrationDone())&&i.push(...await this.getLastestAddedFilesInOldDB({sendDttm:e.sendDttm},t-i.length)),i}async getLastestAddedFilesInNewDB(e,t){const{convId:i,sendDttm:s,cliMsgId:r}=e;return this.dbTable.getAll({from:["",0,0],to:[i,s,r],excludeFrom:!0,excludeTo:!0},{index:"convId_sendDttm_cliMsgId",limit:t,direction:a.CursorDirection.PREV})}async getLastestAddedFilesInOldDB(e,t){if(await this._isMigrationDone())return[];const i=await this.getOldDBTable().getAll({from:0,to:e.sendDttm,excludeFrom:!0,excludeTo:!0},{index:"sendDttm",limit:t,direction:a.CursorDirection.PREV});return i.length>0?i.map((e=>this.getMediaMapper().toDomainFromOldDomain(e))):[]}}const o=Object(r.define)("file-media-repository")},jbAT:function(e,t,i){"use strict";var s=i("mvkY");i.d(t,"a",(function(){return s.IUtilsMediaAppService})),i.d(t,"b",(function(){return s.c}))},mvkY:function(e,t,i){"use strict";i.d(t,"b",(function(){return r})),i.d(t,"c",(function(){return a}));var s=i("jDHv");const r="utils-media-app-service",a=Object(s.define)(r)},nhJq:function(e,t,i){"use strict";i.d(t,"b",(function(){return a})),i.d(t,"a",(function(){return n})),i.d(t,"c",(function(){return d}));let s=$znode.rimraf,r=$znode.fs;async function a(e){if(await o(e))return new Promise(((t,i)=>{s(e,(e=>{e?i(e):t()}))}))}async function n(e){return e.endsWith("/")||(e+="/"),await o(e)?e:new Promise(((t,i)=>{r.mkdir(e,(s=>{s?i(s):t(e)}))}))}function o(e){return new Promise((t=>{r.stat(e,(e=>{t(!e)}))}))}function d(e){return new Promise(((t,i)=>{r.readdir(e,((e,s)=>{e?i(e):t(s)}))}))}},oqw1:function(e,t,i){"use strict";i.r(t);var s,r=i("jDHv"),a=i("xM06"),n=i("x9oK"),o=i("drXQ"),d=i("Hw41");let l=r.ModuleContainer.injectable()(s=class{async createAdapter(e,t){return o.a.factory(e,t)}async getExistedPartitionKeys(e){const t=r.ModuleContainer.resolve(d.b),i=await t.getPort(),s={typeID:a.i,data:{type:a.n,data:{fullname:e}}};return i.invokeMessage(s)}})||s;r.ModuleContainer.registerSingleton(n.c,l)},qUG6:function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));var s=i("3jnX");class r extends s.b{constructor(e){super({type:"UPDATE_CONVERSATION_PREVIEW",params:e})}}},rBRb:function(e,t,i){"use strict";var s,r=i("jDHv"),a=i("fsN4"),n=i("KPNQ");let o=Object(r.injectable)()(s=class{async toMediaPKFromMessagePK(e,t){if(!t)return"";const i=await a.default.getInstance().Core.Message.get(t,{partition:e});return i&&(i.cliMsgId||i.fromUid||i.toUid)?`${i.cliMsgId}_${i.fromUid}_${i.toUid}`:""}async toMessagePKFromMediaPK(e){const[t,i,s]=this._getThreePartsFromMediaPK(e);if(!t||!i||!s)return"";const r=await this._getMessagesByCliMsgIdRange(t,s);let a="";return r.forEach((e=>{e.fromUid===i&&e.toUid===s&&(a=e.msgId)})),a}_getMessagesByCliMsgIdRange(e,t){const i={from:e,to:e,excludeFrom:!1,excludeTo:!1},s={index:"cliMsgIdIndex",partition:t};return a.default.getInstance().Core.Message.getAll(i,s)}_getThreePartsFromMediaPK(e){if("string"!=typeof e||!e)return[];const[t,i,s]=e.split("_");return[t,i,s]}})||s;r.ModuleContainer.register(n.b,o);const d=Object(r.define)("utils-media-mapper");var l,c=i("RgQf"),m=i("MLPV"),g=i("J/8C");let u=Object(r.injectable)()(l=class{toUtilsMediaDTOFromDomain(e){return{id:e.id,convId:e.convId,mediaType:e.mediaType,senderIds:e.senderIds,fileTypes:e.fileTypes}}})||l;r.ModuleContainer.register(d,u);var h,p=i("VTBJ"),f=i("v6qY"),M=i("IZCB");function I(e){try{const t=JSON.parse(e),{fileExt:i,fType:s}=t;return"zip"===i&&2===s}catch(t){return!1}}function y(e){try{if(I(e))return"folder";const t=JSON.parse(e);if(!t)return"";const{fileExt:i}=t;return i.toLowerCase()}catch(t){return""}}function b(e){try{const t=JSON.parse(e);if(!t)return{width:null,height:null};const{width:i,height:s}=t;return{width:i,height:s}}catch(t){return{width:null,height:null}}}let _=Object(r.injectable)()(h=class{toDomainFromOldDomain(e,t=`${f.c.UNKNOWN}${f.d.FROM_OLD_DB}`){if(!e||!e.message)throw Error("This oldImageEntity isn't valid!");if(!e.cliMsgId||"0"!=e.fromUid&&!e.fromUid||!e.userId){0;const t={cliMsgId:e.cliMsgId,fromUid:e.fromUid,userId:e.userId},i=`This oldImageEntity doesn't have key_from_to valid: ${JSON.stringify(t)}`;throw Error(i)}const i="string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm,s="number"==typeof e.fromUid?e.fromUid.toString():e.fromUid;return{mediaId:`${e.cliMsgId}_${s}_${e.userId}`,convId:e.userId,cliMsgId:"number"==typeof e.cliMsgId?e.cliMsgId.toString():e.cliMsgId,fromUid:s,content:{title:e.message.title||null,thumbUrl:e.message.thumbUrl||"",hdUrl:e.message.hdUrl||"",normalUrl:e.message.normalUrl||"",oriUrl:e.message.oriUrl,params:e.message.params,duration:e.message.duration||null},type:"number"==typeof e.subType?e.subType:-1,src:t,sendDttm:i,ttl:e.ttl,localPath:e.localPath||"",previewThumb:e.previewThumb||"",modifiedTime:e.updateTime||i,metadata:Object(p.a)(Object(p.a)({},b(e.message.params)),{},{vOrient:M.a.None})}}toDomainFromDTO(e){if(!e||!e.message)throw Error("This imageDTO isn't valid!");if(!e.cliMsgId||"0"!=e.fromUid&&!e.fromUid||!e.userId){0;const t={cliMsgId:e.cliMsgId,fromUid:e.fromUid,userId:e.userId},i=`This imageDTO doesn't have key_from_to valid: ${JSON.stringify(t)}`;throw Error(i)}const t="string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm,i="number"==typeof e.fromUid?e.fromUid.toString():e.fromUid;return{mediaId:e.mediaId,convId:e.userId,cliMsgId:"number"==typeof e.cliMsgId?e.cliMsgId.toString():e.cliMsgId,fromUid:i,content:{title:e.message.title||null,thumbUrl:e.message.thumbUrl||"",hdUrl:e.message.hdUrl||"",normalUrl:e.message.normalUrl||"",oriUrl:e.message.oriUrl,params:e.message.params,duration:e.message.duration||null},type:"number"==typeof e.subType?e.subType:-1,sendDttm:t,src:e.src,ttl:"number"==typeof e.ttl?e.ttl:0,localPath:e.localPath||"",previewThumb:e.previewThumb||"",modifiedTime:"number"==typeof e.updateTime?e.updateTime:t,metadata:Object(p.a)(Object(p.a)({},b(e.message.params)),{},{vOrient:e.vOrient||M.a.None})}}toDomainFromTMessage(e,t,i=`${f.c.UNKNOWN}${f.d.FROM_MSG}`){if(!e||!e.message)throw Error("This messageEntity isn't valid!");if(!e.cliMsgId||"0"!=e.fromUid&&!e.fromUid||!e.toUid){0;const t={cliMsgId:e.cliMsgId,fromUid:e.fromUid,toUid:e.toUid},i=`This messageEntity doesn't have key_from_to valid: ${JSON.stringify(t)}`;throw Error(i)}const s="string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm,r="number"==typeof e.fromUid?e.fromUid.toString():e.fromUid;return{mediaId:`${e.cliMsgId}_${r}_${e.toUid}`,convId:e.toUid,cliMsgId:"number"==typeof e.cliMsgId?e.cliMsgId.toString():e.cliMsgId,fromUid:r,content:{title:e.message.title||null,thumbUrl:e.message.thumbUrl||"",hdUrl:e.message.hdUrl||"",normalUrl:e.message.normalUrl||"",oriUrl:e.message.oriUrl,params:e.message.params,duration:e.message.duration||null},src:i,type:t,sendDttm:s,ttl:e.ttl||0,localPath:e.localPath||"",previewThumb:e.previewThumb||"",modifiedTime:s,metadata:Object(p.a)(Object(p.a)({},b(e.message.params)),{},{vOrient:M.a.None})}}async toDTO(e,t=!0){if(!e||!e.mediaId)throw Error("This imageEntity isn't valid!");const i=e.msgId?e.msgId:t?await r.ModuleContainer.resolve(n.b).toMessagePKFromMediaPK(e.mediaId):"";return{mediaId:e.mediaId,msgId:i,cliMsgId:e.cliMsgId,fromUid:e.fromUid,userId:e.convId,message:{title:e.content.title,description:"",childnumber:0,action:"",params:e.content.params,type:"",thumbUrl:e.content.thumbUrl,oriUrl:e.content.oriUrl,hdUrl:e.content.hdUrl,normalUrl:e.content.normalUrl,duration:e.content.duration||null,thumb:"",href:""},sendDttm:e.sendDttm,src:e.src,ttl:e.ttl,type:"image",subType:e.type,id:0,localPath:e.localPath,previewThumb:e.previewThumb,updateTime:e.modifiedTime,width:e.metadata.width,height:e.metadata.height,vOrient:e.metadata.vOrient}}toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e){return{convId:e.convId,fromUid:e.fromUid,mediaType:"image",content:{params:e.content.params}}}toOldEAttsFromNewEAtts(e){if(!e||"object"!=typeof e)throw Error("newEAtts is undefined or not valid!");const t={};var i,s;(e.hasOwnProperty("message")&&"object"==typeof e.content&&(t.message={title:e.content.title,description:"",childnumber:0,action:"",params:e.content.params,type:"",thumbUrl:e.content.thumbUrl,oriUrl:e.content.oriUrl,hdUrl:e.content.hdUrl,normalUrl:e.content.normalUrl,duration:e.content.duration||null,thumb:"",href:""}),e.hasOwnProperty("subType")&&(t.subType=e.type),e.hasOwnProperty("sendDttm")&&(t.sendDttm="string"==typeof e.sendDttm?+e.sendDttm:e.sendDttm),e.hasOwnProperty("ttl")&&(t.ttl=e.ttl||0),e.hasOwnProperty("localPath")&&(t.localPath=e.localPath||""),e.hasOwnProperty("previewThumb")&&(t.previewThumb=e.previewThumb||""),e.hasOwnProperty("updateTime")&&(t.updateTime=e.modifiedTime||Date.now()),e.hasOwnProperty("metadata"))&&(t.width=null===(i=e.metadata)||void 0===i?void 0:i.width,t.height=null===(s=e.metadata)||void 0===s?void 0:s.height);return t}toNewEAttsFromDTOAtts(e){if(!e||"object"!=typeof e)throw Error("dtoAtts is undefined or not valid!");const t={};return e.hasOwnProperty("message")&&"object"==typeof e.message&&(t.content={title:e.message.title||null,thumbUrl:e.message.thumbUrl||"",hdUrl:e.message.hdUrl||"",normalUrl:e.message.normalUrl||"",oriUrl:e.message.oriUrl,params:e.message.params,duration:e.message.duration||null}),e.hasOwnProperty("subType")&&(t.type=e.subType),e.hasOwnProperty("sendDttm")&&(t.sendDttm="string"==typeof e.sendDttm?+e.sendDttm:e.sendDttm),e.hasOwnProperty("ttl")&&(t.ttl=e.ttl||0),e.hasOwnProperty("localPath")&&(t.localPath=e.localPath||""),e.hasOwnProperty("previewThumb")&&(t.previewThumb=e.previewThumb||""),e.hasOwnProperty("updateTime")&&(t.modifiedTime=e.updateTime||Date.now()),e.hasOwnProperty("width")&&e.hasOwnProperty("height")&&e.hasOwnProperty("vOrient")&&(t.metadata={width:e.width,height:e.height,vOrient:e.vOrient||0}),t}})||h;var O;r.ModuleContainer.register(m.b,_);let D=Object(r.injectable)()(O=class{toDomainFromOldDomain(e,t=`${f.c.UNKNOWN}${f.d.FROM_OLD_DB}`){if(!e||!e.message)throw Error("This oldFileEntity isn't valid!");if(!e.cliMsgId||"0"!=e.fromUid&&!e.fromUid||!e.userId){0;const t={cliMsgId:e.cliMsgId,fromUid:e.fromUid,userId:e.userId},i=`This oldFileEntity doesn't have key_from_to valid: ${JSON.stringify(t)}`;throw Error(i)}const i="string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm,s="number"==typeof e.fromUid?e.fromUid.toString():e.fromUid;return{mediaId:`${e.cliMsgId}_${s}_${e.userId}`,convId:e.userId,cliMsgId:"number"==typeof e.cliMsgId?e.cliMsgId.toString():e.cliMsgId,fromUid:s,content:{title:e.message.title,href:e.message.href,params:e.message.params,thumb:e.message.thumb||""},type:I(e.message.params)?f.a.FOLDER:f.a.FILE,src:t,extType:y(e.message.params),sendDttm:i,ttl:"number"==typeof e.ttl?e.ttl:0,modifiedTime:e.updateTime||i,localPath:e.localPath||"",folderPath:e.folderPath||"",thumbMetadata:e.dimension?{width:e.dimension.width,height:e.dimension.height,type:e.dimension.type,orientation:Object(p.a)({},e.dimension.orientation),bigRes:e.dimension.bigRes}:null}}toDomainFromDTO(e){if(!e||!e.message)throw Error("This fileDTO isn't valid!");if(!e.cliMsgId||"0"!=e.fromUid&&!e.fromUid||!e.userId){0;const t={cliMsgId:e.cliMsgId,fromUid:e.fromUid,userId:e.userId},i=`This fileDTO doesn't have key_from_to valid: ${JSON.stringify(t)}`;throw Error(i)}const t="string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm,i="number"==typeof e.fromUid?e.fromUid.toString():e.fromUid;return{mediaId:e.mediaId,convId:e.userId,cliMsgId:"number"==typeof e.cliMsgId?e.cliMsgId.toString():e.cliMsgId,fromUid:i,content:{title:e.message.title,href:e.message.href,params:e.message.params,thumb:e.message.thumb||""},type:e.fileType||I(e.message.params)?f.a.FOLDER:f.a.FILE,src:e.src,extType:e.extType||y(e.message.params),sendDttm:t,ttl:"number"==typeof e.ttl?e.ttl:0,modifiedTime:e.updateTime||t,localPath:e.localPath||"",folderPath:e.folderPath||"",thumbMetadata:e.dimension?{width:e.dimension.width,height:e.dimension.height,type:e.dimension.type,orientation:Object(p.a)({},e.dimension.orientation),bigRes:e.dimension.bigRes}:null}}async toDTO(e){if(!e||!e.mediaId||!e.content)throw Error("This fileEntity isn't valid!");const t=e.msgId?e.msgId:await r.ModuleContainer.resolve(n.b).toMessagePKFromMediaPK(e.mediaId);return{mediaId:e.mediaId,msgId:t,cliMsgId:e.cliMsgId,fromUid:e.fromUid,userId:e.convId,message:{title:e.content.title,href:e.content.href,params:e.content.params,thumb:e.content.thumb,childnumber:0,action:"",description:"",type:"",thumbUrl:"",oriUrl:""},sendDttm:e.sendDttm,ttl:e.ttl,src:e.src,type:"file",fileType:e.type,extType:e.extType,id:0,updateTime:e.modifiedTime,localPath:e.localPath||"",folderPath:e.folderPath||"",downloadError:!1,dimension:"object"==typeof e.thumbMetadata?e.thumbMetadata:null,previewThumb:""}}toDomainFromMessage(e,t=`${f.c.UNKNOWN}${f.d.FROM_MSG}`){if(!e||!e.msgId||!e.message)throw Error("This messageEntity isn't valid!");if(!e.cliMsgId||"0"!=e.fromUid&&!e.fromUid||!e.toUid){0;const t={cliMsgId:e.cliMsgId,fromUid:e.fromUid,toUid:e.toUid},i=`This messageEntity doesn't have key_from_to valid: ${JSON.stringify(t)}`;throw Error(i)}const i="string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm,s="number"==typeof e.fromUid?e.fromUid.toString():e.fromUid;return{mediaId:`${e.cliMsgId}_${s}_${e.toUid}`,convId:e.toUid,cliMsgId:"number"==typeof e.cliMsgId?e.cliMsgId.toString():e.cliMsgId,fromUid:s,content:{title:e.message.title,href:e.message.href,params:e.message.params,thumb:e.message.thumb||""},type:I(e.message.params)?f.a.FOLDER:f.a.FILE,src:t,extType:y(e.message.params),sendDttm:i,ttl:e.ttl||0,modifiedTime:i,localPath:e.localPath||"",folderPath:e.folderPath||"",thumbMetadata:null}}toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e){return{convId:e.convId,fromUid:e.fromUid,mediaType:"file",content:{params:e.content.params}}}toOldEAttsFromNewEAtts(e){if(!e||"object"!=typeof e)throw Error("newEAtts isn't valid!");const t={};return e.hasOwnProperty("message")&&"object"==typeof e.content&&(t.message={title:e.content.title,href:e.content.href,params:e.content.params,thumb:e.content.thumb,childnumber:0,action:"",description:"",type:"",thumbUrl:"",oriUrl:""}),e.hasOwnProperty("sendDttm")&&(t.sendDttm=e.sendDttm),e.hasOwnProperty("ttl")&&(t.ttl=e.ttl||0),e.hasOwnProperty("localPath")&&(t.localPath=e.localPath||""),e.hasOwnProperty("folderPath")&&(t.folderPath=e.folderPath||""),e.hasOwnProperty("updateTime")&&(t.updateTime=e.modifiedTime||Date.now()),e.hasOwnProperty("dimension")&&(t.dimension=e.thumbMetadata?{width:e.thumbMetadata.width,height:e.thumbMetadata.height,type:e.thumbMetadata.type,orientation:e.thumbMetadata.orientation,bigRes:e.thumbMetadata.bigRes}:null),t}toNewEAttsFromDTOAtts(e){if(!e||"object"!=typeof e)throw Error("dtoAtts isn't valid!");const t={};return e.hasOwnProperty("message")&&"object"==typeof e.message&&(t.content={title:e.message.title,href:e.message.href,params:e.message.params,thumb:e.message.thumb||""}),e.hasOwnProperty("fileType")&&(t.type=e.fileType),e.hasOwnProperty("extType")&&(t.extType=e.extType||""),e.hasOwnProperty("sendDttm")&&(t.sendDttm="string"==typeof e.sendDttm?+e.sendDttm:e.sendDttm),e.hasOwnProperty("ttl")&&(t.ttl=e.ttl||0),e.hasOwnProperty("localPath")&&(t.localPath=e.localPath||""),e.hasOwnProperty("folderPath")&&(t.folderPath=e.folderPath||""),e.hasOwnProperty("updateTime")&&(t.modifiedTime=e.updateTime||Date.now()),e.hasOwnProperty("dimension")&&(t.thumbMetadata=e.dimension?{width:e.dimension.width,height:e.dimension.height,type:e.dimension.type,orientation:e.dimension.orientation,bigRes:e.dimension.bigRes}:null),t}})||O;var T;r.ModuleContainer.register(c.a,D);let v=Object(r.injectable)()(T=class{toDomainFromOldDomain(e,t=`${f.c.UNKNOWN}${f.d.FROM_OLD_DB}`){if(!e||!e.message)throw Error("This oldLinkEntity isn't valid!");if(!e.cliMsgId||"0"!=e.fromUid&&!e.fromUid||!e.userId){0;const t={cliMsgId:e.cliMsgId,fromUid:e.fromUid,userId:e.userId},i=`This oldLinkEntity doesn't have key_from_to valid: ${JSON.stringify(t)}`;throw Error(i)}const i="string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm,s="number"==typeof e.fromUid?e.fromUid.toString():e.fromUid;return{mediaId:`${e.cliMsgId}_${s}_${e.userId}`,convId:e.userId,cliMsgId:"number"==typeof e.cliMsgId?e.cliMsgId.toString():e.cliMsgId,fromUid:s,content:{title:"object"==typeof e.message.title?e.message.title.title||"":e.message.title,params:e.message.params||"",href:e.message.href||"",thumb:e.message.thumb||"",description:e.message.description||"",type:e.message.type||""},type:-1,src:t,sendDttm:i,ttl:e.ttl,modifiedTime:e.updateTime||i,parsedInfo:null}}toDomainFromDTO(e){if(!e||!e.message)throw Error("This linkDTO isn't valid!");if(!e.cliMsgId||"0"!=e.fromUid&&!e.fromUid||!e.userId){0;const t={cliMsgId:e.cliMsgId,fromUid:e.fromUid,userId:e.userId},i=`This linkDTO doesn't have key_from_to valid: ${JSON.stringify(t)}`;throw Error(i)}const t="string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm,i="number"==typeof e.fromUid?e.fromUid.toString():e.fromUid;return{mediaId:e.mediaId,convId:e.userId,cliMsgId:"number"==typeof e.cliMsgId?e.cliMsgId.toString():e.cliMsgId,fromUid:i,content:{title:"object"==typeof e.message.title?e.message.title.title:e.message.title||"",params:e.message.params||"",href:e.message.href||"",thumb:e.message.thumb||"",description:e.message.description||"",type:e.message.type},src:e.src,type:"number"==typeof e.linkType?e.linkType:-1,sendDttm:t,ttl:"number"==typeof e.ttl?e.ttl:0,modifiedTime:e.updateTime||t,parsedInfo:null}}async toDTO(e){if(!e||!e.mediaId)throw Error("This linkEntity isn't valid!");const t=e.msgId?e.msgId:await r.ModuleContainer.resolve(n.b).toMessagePKFromMediaPK(e.mediaId);return{mediaId:e.mediaId,msgId:t,cliMsgId:parseInt(e.cliMsgId),fromUid:e.fromUid,userId:e.convId,message:{title:e.content.title,params:e.content.params,href:e.content.href,thumb:e.content.thumb,description:e.content.description,type:e.content.type,action:"",childnumber:0,oriUrl:"",thumbUrl:""},sendDttm:e.sendDttm,type:"link",ttl:e.ttl,src:e.src,linkType:e.type,id:0,updateTime:e.modifiedTime,previewThumb:"",parsedInfo:"object"==typeof e.parsedInfo?Object(p.a)({},e.parsedInfo):null}}toDomainFromMessage(e,t=`${f.c.UNKNOWN}${f.d.FROM_MSG}`){if(!e)throw Error("This messageEntity isn't valid!");if(!e.cliMsgId||"0"!=e.fromUid&&!e.fromUid||!e.toUid){0;const t={cliMsgId:e.cliMsgId,fromUid:e.fromUid,toUid:e.toUid},i=`This messageEntity doesn't have key_from_to valid: ${JSON.stringify(t)}`;throw Error(i)}const i="string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm,s="number"==typeof e.fromUid?e.fromUid.toString():e.fromUid;return{mediaId:`${e.cliMsgId}_${s}_${e.toUid}`,convId:e.toUid,cliMsgId:"number"==typeof e.cliMsgId?e.cliMsgId.toString():e.cliMsgId,fromUid:s,content:{title:"object"===e.message.title?e.message.title.title:e.message.title||"",params:e.message.params||"",href:e.message.href||"",thumb:e.message.thumb||"",description:e.message.description||"",type:e.message.type},type:-1,src:t,sendDttm:i,ttl:e.ttl||0,modifiedTime:i,parsedInfo:null}}toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e){return{convId:e.convId,fromUid:e.fromUid,mediaType:"link",content:{params:e.content.params}}}toOldEAttsFromNewEAtts(e){if(!e||"object"!=typeof e)throw Error("newEAtts isn't valid!");const t={};return e.hasOwnProperty("content")&&"object"==typeof e.content&&(t.message={title:e.content.title,params:e.content.params,href:e.content.href,thumb:e.content.thumb,description:e.content.description,type:e.content.type,action:"",childnumber:0,oriUrl:"",thumbUrl:""}),e.hasOwnProperty("sendDttm")&&(t.sendDttm=e.sendDttm),e.hasOwnProperty("ttl")&&(t.ttl=e.ttl||0),e.hasOwnProperty("updateTime")&&(t.updateTime=e.modifiedTime||Date.now()),t}toNewEAttsFromDTOAtts(e){if(!e||"object"!=typeof e)throw Error("dtoAtts isn't valid!");const t={};var i;e.hasOwnProperty("message")&&"object"==typeof e.message&&(t.content={title:"object"==typeof e.message.title?(null===(i=e.message.title)||void 0===i?void 0:i.title)||"":e.message.title||"",params:e.message.params||"",href:e.message.href||"",thumb:e.message.thumb||"",description:e.message.description||"",type:e.message.type||""});return e.hasOwnProperty("sendDttm")&&(t.sendDttm="string"==typeof e.sendDttm?+e.sendDttm:e.sendDttm),e.hasOwnProperty("ttl")&&(t.ttl=e.ttl||0),e.hasOwnProperty("linkType")&&(t.type=e.linkType),e.hasOwnProperty("updateTime")&&(t.modifiedTime=e.updateTime||Date.now()),e.hasOwnProperty("parsedInfo")&&(t.parsedInfo=e.parsedInfo?{protocol:e.parsedInfo.protocol||"",host:e.parsedInfo.domain||""}:null),t}})||T;r.ModuleContainer.register(g.b,v);var w,E=i("AjFa"),U=i("Mgpg"),S=i("H8Z7");Object(r.injectable)()(w=Object(r.singleton)(E.b)(w=function(e,t){return Object(r.inject)(m.b)(e,void 0,0)}(w=function(e,t){return Object(r.inject)(S.c)(e,void 0,1)}(w=function(e,t){return Object(r.inject)(U.ZLoggerFactory)(e,void 0,2)}(w=Reflect.metadata("design:type",Function)(w=Reflect.metadata("design:paramtypes",[void 0===m.IImageMediaMapper?Object:m.IImageMediaMapper,void 0===S.IMediaMigrationManager?Object:S.IMediaMigrationManager,void 0===U.ZLoggerFactory?Object:U.ZLoggerFactory])(w=class extends E.a{constructor(e,t,i){super("Media","Image","image","crud-image-media",t,i),this.imageMediaMapper=void 0,this.oldDBTable=void 0,this.imageMediaMapper=e,this.oldDBTable=this._dalInstance.Core.Image}getOldDBTable(){return this.oldDBTable||(this.oldDBTable=a.default.getInstance().Core.Image),this.oldDBTable}getMediaMapper(){return this.imageMediaMapper}deleteMatch(e,t){throw Error("Currently, this method isn't supported!")}getAllKey(e,t){throw Error("Currently, this method isn't supported!")}put(e,t){throw Error("Currently, this method isn't supported!")}runTransaction(e,t,i){throw Error("Currently, this method isn't supported!")}})||w)||w)||w)||w)||w)||w);var F,j=i("W13p");Object(r.injectable)()(F=Object(r.singleton)(j.b)(F=function(e,t){return Object(r.inject)(c.a)(e,void 0,0)}(F=function(e,t){return Object(r.inject)(S.c)(e,void 0,1)}(F=function(e,t){return Object(r.inject)(U.ZLoggerFactory)(e,void 0,2)}(F=Reflect.metadata("design:type",Function)(F=Reflect.metadata("design:paramtypes",[void 0===c.IFileMediaMapper?Object:c.IFileMediaMapper,void 0===S.IMediaMigrationManager?Object:S.IMediaMigrationManager,void 0===U.ZLoggerFactory?Object:U.ZLoggerFactory])(F=class extends j.a{constructor(e,t,i){super("Media","File","file","crud-file-media",t,i),this.fileMediaMapper=void 0,this.oldDBTable=void 0,this.fileMediaMapper=e,this.oldDBTable=this._dalInstance.Core.File}getOldDBTable(){return this.oldDBTable||(this.oldDBTable=a.default.getInstance().Core.File),this.oldDBTable}getMediaMapper(){return this.fileMediaMapper}deleteMatch(e,t){throw Error("Currently, this method isn't supported!")}getAllKey(e,t){throw Error("Currently, this method isn't supported!")}put(e,t){throw Error("Currently, this method isn't supported!")}runTransaction(e,t,i){throw Error("Currently, this method isn't supported!")}})||F)||F)||F)||F)||F)||F);var N,C=i("5R0e");Object(r.injectable)()(N=Object(r.singleton)(C.b)(N=function(e,t){return Object(r.inject)(g.b)(e,void 0,0)}(N=function(e,t){return Object(r.inject)(S.c)(e,void 0,1)}(N=function(e,t){return Object(r.inject)(U.ZLoggerFactory)(e,void 0,2)}(N=Reflect.metadata("design:type",Function)(N=Reflect.metadata("design:paramtypes",[void 0===g.ILinkMediaMapper?Object:g.ILinkMediaMapper,void 0===S.IMediaMigrationManager?Object:S.IMediaMigrationManager,void 0===U.ZLoggerFactory?Object:U.ZLoggerFactory])(N=class extends C.a{constructor(e,t,i){super("Media","Link","link","crud-link-media",t,i),this.linkMediaMapper=void 0,this.oldDBTable=void 0,this.linkMediaMapper=e,this.oldDBTable=this._dalInstance.Core.Link}getOldDBTable(){return this.oldDBTable||(this.oldDBTable=a.default.getInstance().Core.Link),this.oldDBTable}getMediaMapper(){return this.linkMediaMapper}deleteMatch(e,t){throw Error("Currently, this method isn't supported!")}getAllKey(e,t){throw Error("Currently, this method isn't supported!")}put(e,t){throw Error("Currently, this method isn't supported!")}runTransaction(e,t,i){throw Error("Currently, this method isn't supported!")}})||N)||N)||N)||N)||N)||N);var P,A=i("hWjG"),k=i("7WMW"),B=i("ndDP");class L{constructor(e){this._lruCache=void 0,this._lruCache=new B.default(e)}get(e){return this._lruCache.get(e)}getAll(e="ASC"){const t="ASC"===e?this._lruCache.entriesAscending():this._lruCache.entriesDescending();return Object.values(t)}getAllKey(e="ASC"){const t="ASC"===e?this._lruCache.entriesAscending():this._lruCache.entriesDescending();return Object.keys(t)}set(e,t){this._lruCache.set(e,t)}delete(e){return this._lruCache.delete(e)}clear(){this._lruCache.clear()}}Object(r.injectable)()(P=Object(r.singleton)(k.c)(P=function(e,t){return Object(r.inject)(U.ZLoggerFactory)(e,void 0,0)}(P=Reflect.metadata("design:type",Function)(P=Reflect.metadata("design:paramtypes",[void 0===U.ZLoggerFactory?Object:U.ZLoggerFactory])(P=class extends A.b{constructor(e){super("Media","UtilsMedia","utils-media-repo",e,"id",f.b),this._cache=new L({maxSize:f.b})}async isExisted(e){if(!e)return!1;const t=this._cache.get(e);if(!t){const t=await this._dbCollection.get(e);return t&&this._cache.set(e,t),!!t}return!!t}async update(e,t){if(await this._dbCollection.update(e,t)){const t=await this._dbCollection.get(e);if(t)return this._cache.set(e,t),!0}return!1}async updateReturnEntity(e,t){if(await this._dbCollection.update(e,t)){const t=await this._dbCollection.get(e);if(t)return this._cache.set(e,t),t}throw Error(`[update]: cannot update record with id: ${e}`)}async updateMulti(e){const t=await this._dbCollection.updateMulti(e);return t.success.forEach((e=>this._cache.set(e.id,e))),t}getAllSenderIds(e,t=!0){if(!e)throw Error(`[getAllSenderIds]: id: ${e} isn't valid!`);return this._getItemListByField(e,"senderIds",t)}getAllFileTypes(e,t){if(!e)throw Error(`[getAllFileTypes]: id: ${e} isn't valid!`);return this._getItemListByField(e,"fileTypes",t)}saveSender(e,t){if(!e)throw Error(`[saveSender]: id: ${e} isn't valid!`);return this._saveValueOnField(e,"senderIds",t)}saveFileType(e,t){if(!e)throw Error(`[saveFileType]: id: ${e} isn't valid!`);return this._saveValueOnField(e,"fileTypes",t)}saveSenders(e,t){if(!e)throw Error(`[saveSenders]: id: ${e} isn't valid!`);return this._saveValuesOnField(e,"senderIds",t)}saveFileTypes(e,t){if(!e)throw Error(`[saveSenders]: id: ${e} isn't valid!`);return this._saveValuesOnField(e,"fileTypes",t)}deleteSender(e,t){if(!e)throw Error(`[deleteSender]: id: ${e} isn't valid!`);return this._deleteValueOnField(e,"senderIds",t)}deleteFileType(e,t){if(!e)throw Error(`[deleteFileType]: id: ${e} isn't valid!`);return this._deleteValueOnField(e,"fileTypes",t)}deleteSenders(e,t){if(!e)throw Error(`[deleteSenders]: id: ${e} isn't valid!`);return this._deleteValuesByField(e,"senderIds",t)}deleteFileTypes(e,t){if(!e)throw Error(`[deleteFileTypes]: id: ${e} isn't valid!`);return this._deleteValuesByField(e,"fileTypes",t)}async _saveValueOnField(e,t,i){const s=this._cache.get(e)||await this._dbCollection.get(e);if(s){s[t].some((e=>e===i))||(s[t].push(i),await this.update(e,{value:{[t]:s[t]},attributes:[t]}))}return!0}async _saveValuesOnField(e,t,i){const s=this._cache.get(e)||await this._dbCollection.get(e);if(s){const r=i.filter((e=>!s[t].includes(e)));r.length&&(s[t].push(...r),await this.update(e,{value:{[t]:s[t]},attributes:[t]}))}return!0}async _deleteValueOnField(e,t,i){const s=this._cache.get(e)||await this._dbCollection.get(e);if(s){const r=s[t].indexOf(i);-1!==r&&(s[t].splice(r,1),await this.update(e,{value:{[t]:s[t]},attributes:[t]}))}return!0}async _deleteValuesByField(e,t,i){const s=this._cache.get(e)||await this._dbCollection.get(e);if(s){const r=s[t].filter((e=>!i.includes(e)));r.length<s[t].length&&(s[t]=r,await this.update(e,{value:{[t]:r},attributes:[t]}))}return!0}async _getItemListByField(e,t,i=!0){var s;const r=this._cache.get(e);var a;if(i)return r&&null!==(a=r[t])&&void 0!==a&&a.length?r[t].slice():[];const n=await this._dbCollection.get(e);return n&&!r&&this._cache.set(e,Object(p.a)({},n)),n&&null!==(s=n[t])&&void 0!==s&&s.length?n[t].slice():[]}})||P)||P)||P)||P);var R,x=i("SrDO"),$=i("fhp4");Object(r.injectable)()(R=Object(r.singleton)(x.b)(R=class{getMediaMapper(e){switch(e){case"image":return r.ModuleContainer.resolve($.c);case"file":return r.ModuleContainer.resolve($.a);case"link":return r.ModuleContainer.resolve($.d);default:return}}})||R);var z,J=i("3dEI");Object(r.injectable)()(z=Object(r.singleton)(J.b)(z=class{getMediaRepository(e){switch(e){case"image":return r.ModuleContainer.resolve(E.b);case"link":return r.ModuleContainer.resolve(C.b);case"file":return r.ModuleContainer.resolve(j.b);default:return}}})||z);const K="utils-media-domain-service",G=Object(r.define)(K);var W,V=i("5txd");Object(r.injectable)()(W=Object(r.singleton)(G)(W=function(e,t){return Object(r.inject)(k.c)(e,void 0,0)}(W=function(e,t){return Object(r.inject)(U.ZLoggerFactory)(e,void 0,1)}(W=Reflect.metadata("design:type",Function)(W=Reflect.metadata("design:paramtypes",[void 0===k.b?Object:k.b,void 0===U.ZLoggerFactory?Object:U.ZLoggerFactory])(W=class{constructor(e,t){this._log=void 0,this._logger=void 0,this._utilsMediaRepository=void 0,this._utilsMediaRepository=e,this._logger=t.createZLogger(`${K}`,["mn-utils-media-de"]),this._log=Object(V.a)(this._logger)}async create(e){if(!e)throw Error(`utilsMedia(${e}) isn't existed!`);if(!e.convId||!e.mediaType)throw Error(`cannot create utilsMedia with convId(${e.convId}) and mediaType(${e.mediaType})`);if(await this._utilsMediaRepository.isExisted(`${e.convId}_${e.mediaType}`))throw this._log("[create]",`existed utilsMedia have convId(${e.convId}) and mediaType(${e.mediaType})`,"info"),Error(`existed utilsMedia have convId(${e.convId}) and mediaType(${e.mediaType})`);return{id:`${e.convId}_${e.mediaType}`,convId:e.convId,mediaType:e.mediaType,senderIds:e.senderIds||[],fileTypes:e.fileTypes||[]}}addSenders(e,t){if(!e)throw Error("[addFileTypes] utilsMediaEntity isn't existed!");if(!t||!t.length)return Object(p.a)({},e);return Object(p.a)(Object(p.a)({},e),{},{senderIds:t.reduce(((e,t)=>(e.includes(t)||e.push(t),e)),[...e.senderIds]||!1)})}addFileTypes(e,t){if(!e)throw Error("[addFileTypes] utilsMediaEntity isn't existed!");if(!t||!t.length)return Object(p.a)({},e);const i=Object(p.a)(Object(p.a)({},e),{},{fileTypes:t.reduce(((e,t)=>(e.includes(t)||e.push(t),e)),[...e.fileTypes]||!1)});return i}})||W)||W)||W)||W)||W);var Z,H=i("mvkY"),X=i("jbAT");Object(r.injectable)()(Z=Object(r.singleton)(X.b)(Z=function(e,t){return Object(r.inject)(G)(e,void 0,0)}(Z=function(e,t){return Object(r.inject)(k.c)(e,void 0,1)}(Z=function(e,t){return Object(r.inject)(d)(e,void 0,2)}(Z=function(e,t){return Object(r.inject)(U.ZLoggerFactory)(e,void 0,3)}(Z=Reflect.metadata("design:type",Function)(Z=Reflect.metadata("design:paramtypes",[Object,void 0===k.b?Object:k.b,Object,void 0===U.ZLoggerFactory?Object:U.ZLoggerFactory])(Z=class{constructor(e,t,i,s){this._utilsMediaDomainService=void 0,this._utilsMediaRepository=void 0,this._mapper=void 0,this._logger=void 0,this._log=void 0,this._utilsMediaDomainService=e,this._utilsMediaRepository=t,this._mapper=i,this._logger=s.createZLogger(H.b,["manage-utils-media-in-app"]),this._log=Object(V.a)(this._logger)}async create(e){try{const t=await this._utilsMediaDomainService.create(e);return this._mapper.toUtilsMediaDTOFromDomain(await this._utilsMediaRepository.insert(t))}catch(t){return void this._log("[create]",t.message)}}async createOrUpdate(e){try{const t=`${e.convId}_${e.mediaType}`;let i=await this._utilsMediaRepository.get(t);if(i){const{senderIds:s,fileTypes:r}=e;let a=i.senderIds,n=i.fileTypes;if(s&&s.length&&(a=this._utilsMediaDomainService.addSenders(i,s).senderIds),r&&r.length&&(n=this._utilsMediaDomainService.addFileTypes(i,r).fileTypes),a.length!==i.senderIds.length||n.length!==i.fileTypes.length){const e=await this._utilsMediaRepository.updateReturnEntity(t,{value:{senderIds:a,fileTypes:n},attributes:["senderIds","fileTypes"]});return this._mapper.toUtilsMediaDTOFromDomain(e)}return this._mapper.toUtilsMediaDTOFromDomain(i)}return this.create(e)}catch(t){return void this._log("[createOrUpdate]",t.message)}}async deleteUtilsMediasByConvId(e){try{if(!e)return[];const t=Object.values(f.e).map((t=>`${e}_${t}`));return(await this._utilsMediaRepository.deleteMulti(t)).success}catch(t){return this._log("[deleteUtilsMediasByConvId]",t.message),[]}}async createOrUpdateFromMedias(e){try{if(!e||!e.length)return[];const t=new Map;e.forEach((e=>{let i=t.get(e.convId);if("image"===e.mediaType||"link"===e.mediaType)if(i){-1===i.senderIds.indexOf(e.fromUid)&&(i.senderIds.push(e.fromUid),t.set(e.convId,i))}else i={convId:e.convId,mediaType:e.mediaType,senderIds:[e.fromUid],fileTypes:[]},t.set(e.convId,i);else if("file"===e.mediaType){const s=this._getFileType(e.content.params);if(i){-1===i.fileTypes.indexOf(s)&&(i.fileTypes.push(s),t.set(e.convId,i))}else i={convId:e.convId,mediaType:e.mediaType,senderIds:[e.fromUid],fileTypes:[s]},t.set(e.convId,i)}}));const i=Array.from(t.values());return(await Promise.all(i.map((e=>this.createOrUpdate(e))))).filter(Boolean)}catch(t){return this._log("[createOrUpdateFromMedias]",t.message),[]}}_getFileType(e){try{const t=JSON.parse(e);if(!t)throw Error(`paramsObj is ${t}!`);const{fileExt:i,fType:s}=t;return"zip"===i&&2===s?"folder":i.toLowerCase()}catch(t){return this._log("[_getFileType]",t.message),""}}})||Z)||Z)||Z)||Z)||Z)||Z)||Z);var Y=i("igA5");const q=Object(r.define)("media-migration-state-persist");var Q,ee=i("8tev");Object(r.injectable)()(Q=Object(r.singleton)(q)(Q=class{constructor(){this._localStorage=Y.default.getInstance()}async saveMigrationState(e){e&&await this._localStorage.setItemForCurrentUserAsync(ee.c.MIGRATION_STATE_KEY,JSON.stringify(e))}async getMigrationState(){try{const e=await this._localStorage.getItemForCurrentUserAsync(ee.c.MIGRATION_STATE_KEY);return e?JSON.parse(e):{stateName:ee.b.UNKNOWN,mediaTableNamesToMigrate:[]}}catch(e){return{stateName:ee.b.UNKNOWN,mediaTableNamesToMigrate:[]}}}async saveJobDescSummaries(e){Array.isArray(e)&&await this._localStorage.setItemForCurrentUserAsync(ee.c.PERSISTED_JOB_DESC_SUMMARIES_KEY,JSON.stringify(e))}async getSavedJobDescSummaries(){try{const e=await this._localStorage.getItemForCurrentUserAsync(ee.c.PERSISTED_JOB_DESC_SUMMARIES_KEY);if(!e)return[];return JSON.parse(e)}catch(e){return[]}}async clearPersistedJobDescSummaries(){await this._localStorage.removeItemForCurrentUserAsync(ee.c.PERSISTED_JOB_DESC_SUMMARIES_KEY)}})||Q);var te=i("8/YW"),ie=i("mH7l"),se=i.n(ie);const re=e=>"GET_FROM_OLD_DB"===e.name,ae=e=>"ADD_TO_NEW_DB"===e.name,ne=e=>"DELETE_FROM_OLD_DB"===e.name;var oe=i("1pet"),de=i("ZsEe"),le=i("EYv5"),ce=i("NDmK");function me(){return ce.default.media_migration_db.should_stop_migration}function ge(){return ce.default.media_migration_db.max_running_concurrency_job}function ue(){return ce.default.media_migration_db.delay_time_per_job}function he(){return ce.default.media_migration_db.delay_time_each_k_jobs}function pe(){return ce.default.media_migration_db.media_limit_per_job}function fe(){return ce.default.media_migration_db.min_retry_after}function Me(){return ce.default.media_migration_db.max_retry_after}var Ie=i("1erv");const ye={MAX_RETRY:0,INVALID_CONFIG_JITTER:1,INVALID_CONFIG_MIN:2,TIMEOUT:3,RETRY_ON_ERROR_CONDITION_FAIL:4};class be extends Error{constructor(e){super(`ExpBackoff error:${e}`),this.code=e}}function _e({step:e,nTry:t,jitter:i,min:s,max:r}){let a=s*Math.pow(e,t);if(i){const e=Math.random(),t=Math.floor(e*i*a);a=1&Math.floor(10*e)?a+t:a-t}return 0|Math.min(a,r)}function Oe(e,t){return async function(...i){for await(const{sleep:r,duration:a,nTry:n}of function*(e){var t,i,s,r,a;const n=null!==(t=null==e?void 0:e.retries)&&void 0!==t?t:3,o=null!==(i=null==e?void 0:e.min)&&void 0!==i?i:100,d=null!==(s=null==e?void 0:e.max)&&void 0!==s?s:1e4,l=null!==(r=null==e?void 0:e.step)&&void 0!==r?r:2,c=null!==(a=null==e?void 0:e.jitter)&&void 0!==a?a:0;if(o<=0)throw new be(ye.INVALID_CONFIG_MIN);if(c<0||c>1)throw new be(ye.INVALID_CONFIG_JITTER);let m=0;for(;m<=n;){const e=_e({nTry:m,step:l,jitter:c,min:o,max:d});yield{nTry:m,duration:e,sleep:()=>new Promise((t=>{setTimeout(t,e)}))},m++}}(t))try{const s=await e(...i);return null!=t&&t.afterRetry&&(null==t||t.afterRetry({nTry:n,duration:a,sleep:r,success:!0,shouldRetry:!1})),s}catch(s){const e=null!=t&&t.shouldRetryOnError?null==t?void 0:t.shouldRetryOnError:()=>Promise.resolve(!0),o=await e({error:s,currentState:{nTry:n,duration:a,sleep:r},input:i});if(null!=t&&t.afterRetry&&(null==t||t.afterRetry({nTry:n,duration:a,sleep:r,shouldRetry:o,success:!1})),!o)throw new be(ye.RETRY_ON_ERROR_CONDITION_FAIL);await r()}throw new be(ye.MAX_RETRY)}}var De;const Te=new de.a,ve=999999,we=1/0;Object(te.d)()(De=Object(r.injectable)()(De=Object(r.singleton)(S.c)(De=function(e,t){return Object(r.inject)(q)(e,void 0,0)}(De=function(e,t){return Object(r.inject)(te.a)(e,void 0,1)}(De=function(e,t){return Object(r.inject)(U.ZLoggerFactory)(e,void 0,2)}(De=Reflect.metadata("design:type",Function)(De=Reflect.metadata("design:paramtypes",[Object,void 0===te.a?Object:te.a,void 0===U.ZLoggerFactory?Object:U.ZLoggerFactory])(De=class{constructor(e,t,i){this._isLoadData=!1,this._forceStop=!1,this._mediaMigrationStatePersist=void 0,this._maxWorkerPoolNum=ge(),this._worker=new se.a({concurrency:this._maxWorkerPoolNum,autoStart:!1}),this._delayTimePerJob=ue(),this._delayTimeEachKJobs=he(),this._mediaNumLimitPerJob=pe(),this._minRetryAfter=fe(),this._maxRetryAfter=Me(),this._currentJobDescs=[],this._currentJobHolders=[],this._currentMsgIdCursor=oe.MessageConstants.MAX_MSG_ID,this._mediaMigrationState=void 0,this._failedGetJob=!1,this._failedAddJob=!1,this._failedDeleteJob=!1,this._hasDBError=!1,this._logger=void 0,this._application=void 0,this._mediaMigrationStatePersist=e,this._onApplicationIdle=this._onApplicationIdle.bind(this),this._onApplicationActive=this._onApplicationActive.bind(this),this._onApplicationExit=this._onApplicationExit.bind(this),this._application=t,this._logger=i.createZLogger(S.b,["manage-media-migration"])}onApplicationReady(e){this._listenEvents(),this._isLoadData||this._loadData().then((()=>{this._runMigration()})),this.toggleDBError(this._getTestMediaMigrationFlag("[mm]:db_error")),this.toggleGetJobFailed(this._getTestMediaMigrationFlag("[mm]:get_failed")),this.toggleAddJobFailed(this._getTestMediaMigrationFlag("[mm]:add_failed")),this.toggleDeleteJobFailed(this._getTestMediaMigrationFlag("[mm]:delete_failed"))}async getMediaMigrationState(){if(!Object(Ie.a)()||me())return{stateName:ee.b.UNKNOWN,mediaTableNamesToMigrate:[]};if(!this._mediaMigrationState){const{stateName:e,remainingTableNames:t}=await this._statsMediaMigration();this._mediaMigrationState={stateName:e,mediaTableNamesToMigrate:t}}return this._mediaMigrationState}pauseMigration(e){this._logger.zsymb(3,"kK74Tg",["[mm] pause migration - reason: {}","_PgAln"],e),this.flushHoldingJobs(),this._forceStop=!0,this._worker.pause()}async resumeMigration(e){this._logger.zsymb(3,"4q4F-c",["[mm] resume migration - reason: {}","2MJ_Q9"],e),this._forceStop=!1,Object(Ie.a)()&&!me()&&(this._isLoadData||await this._loadData(),this._currentJobDescs.forEach((e=>{if(e.state===ee.a.FAILED){e.state=ee.a.NEW;const t=this._createJob(e);if(t){const i=this._scheduleJob(e.id,t);this._worker.add(i,{priority:ve})}}})),this._worker.size>0?this._worker.isPaused&&this._worker.start():this._runMigration())}flushHoldingJobs(){this._currentJobHolders.forEach((e=>{clearTimeout(e.timeoutId),e.resolver()})),this._currentJobHolders=[]}toggleGetJobFailed(e){this._failedGetJob=e}toggleAddJobFailed(e){this._failedAddJob=e}toggleDeleteJobFailed(e){this._failedDeleteJob=e}toggleDBError(e){this._hasDBError=e}_createJob(e){const{id:t,currentStep:i}=e;return this._updateStateOfCurrentJobByJobId(t,ee.a.RUNNING),re(i)?this._createJobFromGetFromOldDBCurrentStep(t,i):ae(i)?this._createJobFromAddToNewDBCurrentStep(t,i):ne(i)?this._createJobFromDeleteFromOldDBCurrentStep(t,i):void 0}_createJobFromGetFromOldDBCurrentStep(e,t){const i=Object(p.a)({},t),{mediaTableName:s,amount:r,lastMsgId:a}=i.dataToRun;return async()=>{try{await this._withRetry((async()=>{const t=this._createStep(i);if(!t)return void this._logger.zsymb(21,"72Zpsn",["[mm] getFromOldDBStep is undefined!","nNX1_t"]);let n=await t();if(n.state===ee.e.FAILED)throw n.data.jobId=e,n.data.jobType="GET_FROM_OLD_DB",n.data;const{data:o}=n;if(this._logger.zsymb(3,"lJXeB-",["[mm] getFromOldDBStep - DONE - jobId: {}, {}","n76TNc"],e,o.length),o.length>=r?this._currentMsgIdCursor=o[o.length-1].msgId:this._mediaMigrationState&&this._mediaMigrationState.mediaTableNamesToMigrate.length&&(this._mediaMigrationState.mediaTableNamesToMigrate.shift(),this._currentMsgIdCursor=oe.MessageConstants.MAX_MSG_ID),this._runMigration(),o.length){const t={name:ee.d.ADD_TO_NEW_DB,dataToRun:{mediaTableName:s,amount:r,lastMsgId:a,data:o}};this._updateCurrentStepByJobId(e,t);const i=this._createJobFromAddToNewDBCurrentStep(e,t);await i()}}))()}catch(t){this._logger.zsymb(3,"Ruz9sG",["[mm] throw error from get from old DB step - jobId: {}, {}","vQ3cCD"],e,null==t?void 0:t.message)}}}_createJobFromAddToNewDBCurrentStep(e,t){const i=Object(p.a)({},t),{mediaTableName:s,amount:r,lastMsgId:a}=i.dataToRun;return async()=>{try{await this._withRetry((async()=>{await this._persistCurrentJobDescs();const i=this._createStep(t);if(!i)return void this._logger.zsymb(18,"jSzHFJ","[mm] addToNewDBStep is undefined!");const n=await i();if(n.state===ee.e.FAILED)throw n.data.jobId=e,n.data.jobType="ADD_TO_NEW_DB",n.data;const{data:o}=n;if(this._logger.zsymb(3,"nuy9hr",["[mm] addToNewDBStep - jobId: {}, {}","X0dfnc"],e,o.length),o.length){const t={name:ee.d.DELETE_FROM_OLD_DB,dataToRun:{mediaTableName:s,amount:r,lastMsgId:a,data:o}};this._updateCurrentStepByJobId(e,t);const i=this._createJobFromDeleteFromOldDBCurrentStep(e,t);await i()}}))()}catch(i){this._logger.zsymb(3,"a_por3",["[mm] throw error from add to new DB step - jobId: {}, {}","UFr4Pr"],e,null==i?void 0:i.message)}}}_createJobFromDeleteFromOldDBCurrentStep(e,t){const i=Object(p.a)({},t);return async()=>{try{await this._withRetry((async()=>{await this._persistCurrentJobDescs();const t=this._createStep(i);if(!t)return void this._logger.zsymb(21,"HN_tZi",["[mm] deleteFromOldDBStep is undefined!","816L28"]);const s=await t();if(s.state===ee.e.FAILED)throw s.data.jobId=e,s.data.jobType="DELETE_FROM_OLD_DB",s.data;this._logger.zsymb(3,"ArCsB-",["[mm] deleteFromOldDBStep - DONE - jobId: {}","m4nwL_"],e),this._currentJobDescs=this._currentJobDescs.filter((t=>t.id!==e)),this._currentJobHolders=this._currentJobHolders.filter((t=>t.jobId!==e)),this._persistCurrentJobDescs()}))()}catch(t){this._logger.zsymb(3,"vMOoUY",["[mm] throw error from delete from old DB step - jobId: {} - err: {}","bVLhGM"],e,null==t?void 0:t.message)}}}_updateCurrentStepByJobId(e,t){const i=this._currentJobDescs.find((t=>t.id===e));i&&(i.currentStep=t)}_updateStateOfCurrentJobByJobId(e,t){const i=this._currentJobDescs.find((t=>t.id===e));i&&(i.state=t)}async _persistCurrentJobDescs(){await this._mediaMigrationStatePersist.saveJobDescSummaries(this._currentJobDescs.reduce(((e,t)=>(t.currentStep.name!==ee.d.GET_FROM_OLD_DB&&e.push(this._toJobDescSummary(t)),e)),[]))}_createStep(e){return re(e)?async()=>{try{if(this._hasDBError)this._throwDBError();else if(this._failedGetJob)throw Error("[SIMULATE]: Failed to get job from old DB!");const{mediaTableName:t,amount:i,lastMsgId:s}=e.dataToRun,a=t,n=r.ModuleContainer.resolve(le.a),o=await n.getMediasFromOldDB(a,i,s);return{state:ee.e.DONE,data:o}}catch(t){return this._logger.zsymb(21,"Yy14mT",["[mm] get from old db step err: {}","_ui-5s"],null==t?void 0:t.message),{state:ee.e.FAILED,data:t}}}:ae(e)?async()=>{try{if(this._hasDBError)this._throwDBError();else if(this._failedAddJob)throw Error("[SIMULATE]: Failed to add job to new DB!");let{mediaTableName:t,data:i,lastMsgId:s,amount:a}=e.dataToRun;const n=t,o=r.ModuleContainer.resolve(le.a);let d=i;d||(d=await o.getMediasFromOldDB(n,a,s));const l=await o.addMediasFromOldDB(n,d);return{state:ee.e.DONE,data:l}}catch(t){return this._logger.zsymb(21,"Jxz4uv",["[mm] add to new db step err: {}","5E8LLr"],null==t?void 0:t.message),{state:ee.e.FAILED,data:t}}}:ne(e)?async()=>{try{if(this._hasDBError)this._throwDBError();else if(this._failedDeleteJob)throw Error("[SIMULATE]: Failed to delete job from old DB!");const{mediaTableName:t,data:i,lastMsgId:s,amount:a}=e.dataToRun,n=t,o=r.ModuleContainer.resolve(le.a);return i?{state:ee.e.DONE,data:await o.deleteMediasFromOldDB(n,i)}:{state:ee.e.DONE,data:await o.deleteMediasFromOldDBByRange(n,a,s)}}catch(t){return this._logger.zsymb(21,"ye0d3p",["[mm] delete from old db step err: {}","z_Gabr"],null==t?void 0:t.message),{state:ee.e.FAILED,data:t}}}:void 0}async _loadData(){if(me()||!Object(Ie.a)())return;const e=await this.getMediaMigrationState();this._logger.zsymb(3,"8ALLgw",["[mm] MEDIA MIGRATION STATE after load data: {}","plqM9_"],e.stateName),this._mediaMigrationState=e;const t=await this._mediaMigrationStatePersist.getSavedJobDescSummaries();t.length>0&&t.forEach((e=>{const t=this._toJobDesc(e);this._currentJobDescs.push(t);const i=this._createJob(t);if(i){const e=this._scheduleJob(t.id,i);this._worker.add(e,{priority:ve})}})),this._isLoadData=!0}async _statsMediaMigration(){const e=r.ModuleContainer.resolve(le.a),t=await Promise.all([e.countTotalMediaInOldDB("image"),e.countTotalMediaInOldDB("file"),e.countTotalMediaInOldDB("link")]);let i=ee.b.NOT_DONE,s=[];return i=t.reduce(((e,t,i)=>(0===i&&t>0?s.push("image"):1===i&&t>0?s.push("file"):2===i&&t>0&&s.push("link"),e+t)),0)>0?ee.b.NOT_DONE:ee.b.DONE,{stateName:i,remainingTableNames:s}}async _runMigration(){if(this._logger.zsymb(0,"xw1VAH","[mm] ====================RUN MIGRATION===================="),!Object(Ie.a)())return void this._logger.zsymb(0,"Yi52OT","[mm] ==========STOP MIGRATION: not use new media DB flow (cfsv)==========");if(me())return void this._logger.zsymb(0,"45tI6p","[mm] ==========STOP MIGRATION: stop migration (cfsv)==========");if(this._forceStop)return void this._logger.zsymb(0,"ztJ3le","[mm] ==========STOP MIGRATION: force stop (in app)==========");if(!this._isLoadData&&(await this._loadData(),!this._isLoadData))return;if(this._mediaMigrationState.stateName===ee.b.DONE)return void this._logger.zsymb(0,"RupBQp","[mm] ==========STOP MIGRATION: migration done==========");const e=this._mediaMigrationState.mediaTableNamesToMigrate.length>0?this._mediaMigrationState.mediaTableNamesToMigrate[0]:"";if(!e){if(!this._currentJobDescs.length)return this._logger.zsymb(0,"sKFjbg","[mm] ==========STOP MIGRATION: no media table to migrate=========="),this._stopListenEvents(),void(await this._mediaMigrationStatePersist.clearPersistedJobDescSummaries());this._logger.zsymb(0,"TA7sYr","[mm] ==========STOP MIGRATION: no media table to migrate, but still have running jobs==========")}if(this._logger.zsymb(3,"0Z6h7F",["[mm] worker pending: ","siVomN"],this._worker.pending),this._logger.zsymb(3,"Kr3hNj",["[mm] worker size: ","qpE4_W"],this._worker.size),e){if(Te.value%this._maxWorkerPoolNum==0&&(await this._waitIn(this._delayTimeEachKJobs),this._forceStop||!Object(Ie.a)()||me()))return;const t={id:Te.next(),state:ee.a.NEW,currentStep:{name:ee.d.GET_FROM_OLD_DB,dataToRun:{mediaTableName:e,amount:this._mediaNumLimitPerJob,lastMsgId:this._currentMsgIdCursor}}},i=this._createJob(t);if(i){this._currentJobDescs.push(t);const e=this._scheduleJob(t.id,i);this._worker.add(e)}}else if(!this._currentJobDescs.length)return;this._worker.isPaused&&this._worker.start()}_listenEvents(){this._application.addEventListener(te.b.Idle,this._onApplicationIdle),this._application.addEventListener(te.b.Active,this._onApplicationActive),this._application.addEventListener(te.b.Exit,this._onApplicationExit)}_stopListenEvents(){this._application.removeEventListener(te.b.Idle,this._onApplicationIdle),this._application.removeEventListener(te.b.Active,this._onApplicationActive),this._application.removeEventListener(te.b.Exit,this._onApplicationExit)}_onApplicationIdle(){this._setupMigrationConfig({maxWorkerPoolNum:ge(),mediaNumLimitPerJob:pe(),delayTimePerJob:ue(),delayTimeEachKJobs:he(),minRetryAfter:fe(),maxRetryAfter:Me()})}_onApplicationActive(){this._setupMigrationConfig({maxWorkerPoolNum:ge(),mediaNumLimitPerJob:pe(),delayTimePerJob:ue(),delayTimeEachKJobs:he(),minRetryAfter:fe(),maxRetryAfter:Me()})}_onApplicationExit(){this.pauseMigration("EXIT_APP")}_toJobDescSummary(e){const{currentStep:t}=e;return{currentStep:{name:t.name,summaryData:{mediaTableName:t.dataToRun.mediaTableName,amount:t.dataToRun.amount,lastMsgId:t.dataToRun.lastMsgId}}}}_toJobDesc(e){let{currentStep:t}=e;return{id:Te.next(),state:ee.a.NEW,currentStep:{name:t.name,dataToRun:Object(p.a)(Object(p.a)({},t.summaryData),{},{data:void 0})}}}_setupMigrationConfig(e){"number"==typeof e.maxWorkerPoolNum&&(this._worker.concurrency=e.maxWorkerPoolNum),"number"==typeof e.mediaNumLimitPerJob&&(this._mediaNumLimitPerJob=e.mediaNumLimitPerJob),"number"==typeof e.delayTimePerJob&&(this._delayTimePerJob=e.delayTimePerJob),"number"==typeof e.delayTimeEachKJobs&&(this._delayTimeEachKJobs=e.delayTimeEachKJobs),"number"==typeof e.minRetryAfter&&(this._minRetryAfter=e.minRetryAfter),"number"==typeof e.maxRetryAfter&&(this._maxRetryAfter=e.maxRetryAfter)}_scheduleJob(e,t){return async()=>new Promise((t=>{const i=setTimeout((()=>{this._currentJobHolders=this._currentJobHolders.filter((t=>t.jobId!==e)),t()}),1e3*this._delayTimePerJob);this._currentJobHolders.push({jobId:e,timeoutId:i,resolver:t})})).then((()=>t()))}_withRetry(e){return Oe(e,{retries:we,min:1e3*this._minRetryAfter,max:1e3*this._maxRetryAfter,shouldRetryOnError:async({error:e,currentState:t})=>this._forceStop||me()||!Object(Ie.a)()?(this._updateStateOfCurrentJobByJobId(e.jobId,ee.a.FAILED),!1):"UnknownError"===e.name||"QuotaExceededError"===e.name||22===e.code?(this._updateStateOfCurrentJobByJobId(e.jobId,ee.a.FAILED),this.pauseMigration("DB_ERROR"),!1):(this._logger.zsymb(21,"EtJzTS",["[mm]: Retry - jobId: {} - jobType: {} - error: {}","QL-p9p"],e.jobId,e.jobType,e.message),!0)})}async _waitIn(e){return this._logger.zsymb(3,"fEd3CT",["[mm]: waiting in {} seconds","0ZZraF"],e),new Promise((t=>{setTimeout(t,1e3*e)}))}_getTestMediaMigrationFlag(e){const t=Y.default.getInstance().getItemForCurrentUser(e);try{return!!t&&JSON.parse(t)}catch(i){return!1}}_throwDBError(){const e=new Error("[SIMULATE]: DB is corrupted or quota is exceeded!");throw e.name="UnknownError",e.code=22,e}})||De)||De)||De)||De)||De)||De)||De)}}]);
//# sourceMappingURL=../sourcemaps/lazy/default-main-startup-shared-worker.5c91269df319dfa18b53.js.map