(this.webpackJsonp=this.webpackJsonp||[]).push([[15],{"4Vil":function(e,t,s){"use strict";var r=s("T0aS"),n=s("jDHv");class i extends r.b{setSession(e){this.isNewSession(e)&&($zsessionManager.authenticate(e),super.setSession(e))}}n.ModuleContainer.registerSingleton(r.a,i)},"5lV7":function(e,t,s){"use strict";var r,n=s("wH4e"),i=s("ggcH"),o=s("zmG6"),a=s("LW7J"),c=s("jDHv"),d=s("fc/q"),u=s("J25b"),l=s("AH6j"),h=s("Mgpg");var p=function(e){return e.IDLE="IDLE",e.CHECKING="CHECKING",e.STOP="STOP",e}(p||{});let g=Object(c.injectable)()(r=function(e,t){return Object(c.inject)(h.ZLoggerFactory)(e,void 0,0)}(r=function(e,t){return Object(c.inject)(d.b)(e,void 0,1)}(r=function(e,t){return Object(c.inject)(u.b)(e,void 0,2)}(r=Reflect.metadata("design:type",Function)(r=Reflect.metadata("design:paramtypes",[void 0===h.ZLoggerFactory?Object:h.ZLoggerFactory,"undefined"==typeof IQosService?Object:IQosService,"undefined"==typeof ISystemTime?Object:ISystemTime])(r=class extends l.b{constructor(e,t,s){super(),this.adapterType=n.AdapterType.IDB,this.logger=void 0,this.qos=void 0,this.systemTime=void 0,this.state=void 0,this.lastTsStartCheck=0,this.intervalCheckDBCorruption=null,this.hasCorruptedThisSession=void 0,this.processRequestRestartAppForBackup=(e,t)=>{this.submitReportCorruption(a.e,o.c.RESET_COUNTER),this.dispatchEvent(new i.IndexedDBCorruptionDetectedEvent(this.lastTsStartCheck,t))},this.logger=e.createZLogger("db-corruption-detector",["renderer","indexedDB-adapter"]),this.qos=t,this.systemTime=s,this.state=p.IDLE,this.hasCorruptedThisSession=!1}start(){this.checkStartUp(),this.startIntervalCheck(),$zsub.$zapp.onRequestRestartAppForBackup(this.processRequestRestartAppForBackup)}stop(){this.stopIntervalCheckDBCorruption(),$zsub.$zapp.removeListenBackupRestartReq(this.processRequestRestartAppForBackup),this.logger.zsymb(0,"CFvirw","IndexedDBCorruptionDetector stopped")}checkStartUp(){this.checkDatabase(o.b.STARTUP)}startIntervalCheck(){this.logger.zsymb(0,"zQHmEV","Start interval check database corruption"),this.intervalCheckDBCorruption&&clearInterval(this.intervalCheckDBCorruption),this.intervalCheckDBCorruption=setInterval((()=>{this.checkDatabase(o.b.INTERVAL)}),12e5)}stopIntervalCheckDBCorruption(){this.intervalCheckDBCorruption&&(clearInterval(this.intervalCheckDBCorruption),this.intervalCheckDBCorruption=null),this.logger.zsymb(0,"4OxJah","Stop interval check database corruption")}corruptionHasOccurred(){return this.hasCorruptedThisSession}forceCheckDBCorruption(){return this.checkDatabase(o.b.FORCE_CHECK)}async checkDatabase(e){if(this.state===p.STOP)return;if(this.state===p.CHECKING)return void this.logger.zsymb(0,"uXdZdu",`Checking... Entry check: ${e}`);this.state=p.CHECKING,this.logger.zsymb(0,"NsyhJY",`Let start check database. Entry check: ${e}`),this.lastTsStartCheck=this.systemTime.getTimeNow();const t=await $zdb.getIDBDatabaseHealthStatus(),s=this.isCorruption(t);this.state=p.IDLE,this.submitReportCorruption(e,t),s&&(this.state=p.STOP,this.logger.zsymb(18,"WZn5jR",`Corruption detected. Entry check: ${e}`),this.stopIntervalCheckDBCorruption(),this.hasCorruptedThisSession=!0,$zapp.notifyDbFail(),$zapp.notifyDbCorruption())}submitReportCorruption(e,t){const s=a.c[e];this.qos.log({success:!1,commandId:s,subCommandId:0,errorCode:t,duration:0,startTime:0}),this.logger.zsymb(18,"p2DsPd",`Submit report database corruption. ${e}::${s}`)}isCorruption(e){switch(e){case o.c.RESET_COUNTER:return!0;case o.c.INVALID_COUNTER:case o.c.OK:default:return!1}}})||r)||r)||r)||r)||r)||r;c.ModuleContainer.registerSingleton(i.TDBCorruptionDetectorAdapter,g);var m,b=s("Ilem"),C=(s("Ofqi"),s("aEKn")),v=s("1pet");let D=Object(c.injectable)()(m=function(e,t){return Object(c.inject)(h.ZLoggerFactory)(e,void 0,0)}(m=function(e,t){return Object(c.inject)(d.b)(e,void 0,1)}(m=function(e,t){return Object(c.inject)(u.b)(e,void 0,2)}(m=Reflect.metadata("design:type",Function)(m=Reflect.metadata("design:paramtypes",[void 0===h.ZLoggerFactory?Object:h.ZLoggerFactory,"undefined"==typeof IQosService?Object:IQosService,"undefined"==typeof ISystemTime?Object:ISystemTime])(m=class extends l.b{constructor(e,t,s){super(),this.adapterType=n.AdapterType.SQLite,this.logger=void 0,this.qos=void 0,this.systemTime=void 0,this.hasCorruptedThisSession=void 0,this.handleCorruptionEvent=e=>{this.hasCorruptedThisSession=!0,this.logger.zsymb(18,"AEuEJp","Corruption detected, corruption info",JSON.stringify(e.corruptionInfo)),this.dispatchEvent(new i.SQLiteDBCorruptionDetectedEvent(this.systemTime.getTimeNow(),e.corruptionInfo)),this.submitReportCorruption(e.corruptionInfo)},this.logger=e.createZLogger("db-corruption-detector",["renderer","sqlite-adapter"]),this.qos=t,this.systemTime=s,this.hasCorruptedThisSession=!1}corruptionHasOccurred(){return this.hasCorruptedThisSession}async forceCheckDBCorruption(){}start(){C.a.getInstance().addEventListener("corruption",this.handleCorruptionEvent)}stop(){C.a.getInstance().removeEventListener("corruption",this.handleCorruptionEvent),this.logger.zsymb(0,"I7ZjjK","SQLiteDBCorruptionDetector stopped")}submitReportCorruption(e){const{commandId:t,errorCode:s}=this.getQosInfo(e);this.qos.log({success:!1,commandId:t,subCommandId:0,errorCode:s,duration:0,startTime:0}),this.logger.zsymb(18,"rORF2W","Submit report database corruption")}getQosInfo(e){var t,s;if("Message"===e.databaseCorruptInfo.table){const t=(()=>{const[t]=e.databaseCorrupt.split("/").slice(-1);return t.startsWith(v.GROUPID_PREFIX)})();return{commandId:a.d.CORRUPTION_TABLE_MESSAGE,errorCode:t?a.b.Group:a.b.OneOne}}return e.type===b.a.FULL?{commandId:a.d.CORRUPTION_IMPACT_FULL,errorCode:null!==(s=a.a[e.databaseCorruptInfo.database])&&void 0!==s?s:-1}:{commandId:a.d.CORRUPTION_IMPACT_PARTIAL,errorCode:null!==(t=a.a[e.databaseCorruptInfo.database])&&void 0!==t?t:-1}}})||m)||m)||m)||m)||m)||m;c.ModuleContainer.registerSingleton(i.TDBCorruptionDetectorAdapter,D)},"9AEM":function(e,t,s){"use strict";var r,n=s("ggcH"),i=s("wH4e"),o=s("pAGP"),a=s("zmG6"),c=s("jDHv"),d=s("AH6j"),u=s("Mgpg"),l=s("T0aS"),h=s("Jz/+");let p=Object(c.injectable)()(r=function(e,t){return Object(c.inject)(u.ZLoggerFactory)(e,void 0,0)}(r=Reflect.metadata("design:type",Function)(r=Reflect.metadata("design:paramtypes",[void 0===u.ZLoggerFactory?Object:u.ZLoggerFactory])(r=class extends d.b{constructor(e){super(),this.logger=void 0,this.corruptionDetectorAdapters=void 0,this.handleCorruptionEvent=e=>{this.logger.zsymb(0,"U9y3T3","Corrupt occurs"),this.dispatchEvent(e)},this.logger=e.createZLogger("db-corruption-detector",[]),this.corruptionDetectorAdapters=new Map,this.startDetectForSharedDB();c.ModuleContainer.resolve(l.a).addEventListener(h.a.SessionChange,(async({session:e})=>{null!==e&&this.startDetectForUserScopedDB(e.userId)}))}getAdapter(e){return c.ModuleContainer.resolveAll(n.TDBCorruptionDetectorAdapter).find((t=>t.adapterType===e))}async startDetect(e){if(!c.ModuleContainer.isRegistered(n.TDBCorruptionDetectorAdapter))return void this.logger.zsymb(0,"GQj9eU","Skip track corrupt, no available adapters.");const t=this.getAdapter(e);t&&!this.corruptionDetectorAdapters.has(e)&&(this.corruptionDetectorAdapters.set(e,t),t.addEventListener(a.a.DB_CORRUPTION_DETECTED,this.handleCorruptionEvent),t.start())}async startDetectForSharedDB(){const e=await c.ModuleContainer.resolve(o.a).getAdapterTypeOfSharedDatabases();this.startDetect(e)}async startDetectForUserScopedDB(e){const t=await c.ModuleContainer.resolve(o.a).getAdapterTypeOfUserScopedDatabases(e);this.startDetect(t)}async forceCheckDBCorruption(){this.logger.zsymb(0,"m3KnR1","forceCheckDBCorruption"),this.corruptionDetectorAdapters.forEach((e=>e.forceCheckDBCorruption()))}async forceCheckDBCorruptionFor(e){switch(this.logger.zsymb(0,"wYnTXX","forceCheckDBCorruptionFor",e),e){case i.AdapterType.IDB:{const t=this.getAdapter(e);if(!t){this.logger.zsymb(0,"7EVkHL","Adapter not found",e);break}await t.forceCheckDBCorruption(),t.corruptionHasOccurred()&&this.handleCorruptionEvent(new n.IndexedDBCorruptionDetectedEvent(Date.now(),!1));break}default:throw new Error("Not support"+e)}}corruptionHasOccurred(){let e=!1;return this.corruptionDetectorAdapters.forEach((t=>{e=e||t.corruptionHasOccurred()})),e}})||r)||r)||r)||r;c.ModuleContainer.registerSingleton(n.TDBCorruptionDetector,p),c.ModuleContainer.resolve(n.TDBCorruptionDetector)},EUMs:function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var r=s("q1tI"),n=s.n(r);const i=n.a.lazy((()=>s.e(42).then(s.bind(null,"TZgy")))),o=()=>n.a.createElement(n.a.Suspense,{fallback:null},n.a.createElement(i,null))},J25b:function(e,t,s){"use strict";s.d(t,"b",(function(){return n}));var r=s("jDHv");const n=Object(r.define)("system-time")},KwLe:function(e,t,s){"use strict";var r=s("q1tI"),n=s("jDHv"),i=s("ODpZ"),o=s("nQja");t.a=()=>{const[e,t]=Object(r.useState)(o.a.NONE);return Object(r.useEffect)((()=>{{const e=n.ModuleContainer.resolve(i.a).checkAppVersion();t(e)}}),[]),{appVersionState:e}}},ODpZ:function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));var r=s("jDHv");const n=Object(r.define)("app-version-manager")},Ppsz:function(e,t,s){"use strict";var r=s("jDHv"),n=s("hmll"),i=s("1pet"),o=s("NL/6");const a=[{chord:`${i.CmdOrCtrl}${i.K_I}`,commandId:o.a.FOCUS_MAIN_CHAT_INPUT_AT_ACTIVE_WINDOW,commandTitle:"",isMatchedContext:(e,t)=>!0},{chord:`${i.CmdOrCtrl}${i.K_I}`,commandId:o.a.APPLY_ITALIC_STYLE_FOR_SELECTED_TEXT,commandTitle:"",isMatchedContext:(e,t)=>!0},{chord:`${i.CmdOrCtrl}${i.K_B}`,commandId:o.a.APPLY_BOLD_STYLE_FOR_SELECTED_TEXT,commandTitle:"",isMatchedContext:(e,t)=>!0},{chord:`${i.CmdOrCtrl}${i.K_U}`,commandId:o.a.APPLY_UNDERLINE_STYLE_FOR_SELECTED_TEXT,commandTitle:"",isMatchedContext:(e,t)=>!0},{chord:`${i.CmdOrCtrl}${i.Shift}${i.K_X}`,commandId:o.a.TOGGLE_RTF_MODE,commandTitle:"",isMatchedContext:(e,t)=>!0}];r.ModuleContainer.register(n.a,class{constructor(){this._keybindings=[],a.forEach((e=>{this._keybindings.push({chord:e.chord,commandId:e.commandId,commandTitle:e.commandTitle,isMatchedContext:e.isMatchedContext,eventHandlers:[]})}))}registerEventHandlerByCommandId(e,t){return e&&t?(this._keybindings.forEach((s=>{s.commandId!==e||s.eventHandlers.includes(t)||s.eventHandlers.push(t)})),()=>{this._keybindings.forEach((s=>{s.commandId===e&&s.eventHandlers.includes(t)&&(s.eventHandlers=s.eventHandlers.filter((e=>e!==t)))}))}):()=>{}}loopkupKeybindingByCommandId(e){return e?this._keybindings.reduce(((t,s)=>(e===s.commandId&&t.push(s),t)),[]):[]}loopkupKeybindingByChord(e){return e?this._keybindings.reduce(((t,s)=>(e===s.chord&&t.push(s),t)),[]):[]}});var c=s("XRso"),d=s("Xt6Q");r.ModuleContainer.register(c.a,class{buildChord(e){let t="";return e&&this._isChord(e)&&((e.ctrlKey||e.metaKey)&&(t+=i.CmdOrCtrl),e.shiftKey&&(t+=i.Shift),e.altKey&&(t+=i.Alt),t+=e.keyCode||e.which),t}buildKeybindingContext(e,t){return e&&t?`${e}#${t}`:""}getChordByCommandId(e){return e===o.a.TOGGLE_RTF_MODE?(Object(d.c)()?"Cmd":"Ctrl")+" + Shift + X":""}_isOnlyModifier(e){return["Shift","Control","Alt","Meta"].includes(e.key)}_isOnlyNonModifier(e){return!(e.ctrlKey||e.metaKey||e.shiftKey||e.altKey)}_isChord(e){return!(this._isOnlyModifier(e)||this._isOnlyNonModifier(e))}})},TGaw:function(e,t,s){"use strict";var r=s("jDHv"),n=s("8/YW"),i=(s("jw3m"),s("Y58e")),o=s("UGJm");let a=function(e){return e.Idle="idle",e.Active="active",e}({});var c=s("AH6j");let d=function(e){return e[e.idle=0]="idle",e[e.active=1]="active",e}({});class u extends c.b{constructor(e){super(),this.status=d.active,this.window=void 0,this.idleDelay=void 0,this.minimumIdlePeriod=void 0,this.lastIdleTime=void 0,this.focusStateChangeDebounceTimer=void 0,this.handleDocumentBlur=()=>{this.resetFocusStateChangeDebounceTimer(),this.focusStateChangeDebounceTimer=setTimeout((()=>{this.setStateToIdle()}),this.idleDelay)},this.handleDocumentFocus=()=>{this.resetFocusStateChangeDebounceTimer(),this.setStateToActive()},this.idleDelay=e.idleDelay,this.minimumIdlePeriod=e.minimumIdlePeriod,this.window=e.window||window,this.lastIdleTime=0,this.focusStateChangeDebounceTimer=null}start(){this.window.addEventListener("blur",this.handleDocumentBlur),this.window.addEventListener("focus",this.handleDocumentFocus)}stop(){this.window.removeEventListener("blur",this.handleDocumentBlur),this.window.removeEventListener("focus",this.handleDocumentFocus)}onIdle(e){return this.addEventListener(a.Idle,e)}setStateToActive(){this.status!==d.idle||(this.status=d.active,this.dispatchEvent(new Event(a.Active)))}setStateToIdle(){if(this.status!==d.active)return;this.isThrottlingIdleState()||(this.lastIdleTime=Date.now(),this.status=d.idle,this.dispatchEvent(new Event(a.Idle)))}isThrottlingIdleState(){return Date.now()-this.lastIdleTime<this.minimumIdlePeriod}resetFocusStateChangeDebounceTimer(){this.focusStateChangeDebounceTimer&&(clearTimeout(this.focusStateChangeDebounceTimer),this.focusStateChangeDebounceTimer=null)}}var l=s("wx14"),h=s("q1tI"),p=s.n(h),g=s("/MKj"),m=s("FK2X"),b=s("emRR"),C=s("xrk1"),v=s("ZBGy"),D=s("T1Xd"),f=s("uzdi");const y=Object(f.a)();function I(){const e=y.useRecoilSnapshot();return y.setSnapShot(e),null}var E=s("QVmZ"),O=s("72hn"),T=s("ZlRg"),S=s("VaDh"),A=s("CzFt"),_=s("h0sc"),L=s("1pet"),j=s("L+5E"),R=s("UiPd"),B=s("Yi2m"),M=s("6uTC"),w=s("c51z"),z=s("sqm0"),N=s("NTw/");var k=s("hI9i"),V=s("q9t1"),F=s("Jq9Z"),$=s("KwLe"),P=s("nQja"),U=s("EUMs");const Q=e=>{const t=Object(g.f)(),s=Object(h.useMemo)((()=>Object(v.d)(t)),[t]),r=Object(v.c)(),n=Object(g.g)((e=>({user:e.user,popup:e.popup,status:e.status,profile:e.profile,chatview:e.chatview})),((e,t)=>e.user==t.user&&e.popup==t.popup&&e.status==t.status&&e.profile==t.profile&&e.chatview==t.chatview));return(e=>{const t=Object(h.useCallback)((()=>{_.ModalManagerV2.openModal({windowId:"1",name:L.ModalIdentitiesDefine.SETTINGS,params:!0,forceCloseAll:!0})}),[]),s=Object(h.useCallback)((()=>{_.ModalManagerV2.openModal({windowId:"1",name:L.ModalIdentitiesDefine.APP_INFO,params:!0})}),[]),r=Object(h.useCallback)(((e,t)=>{var s;z.a.setFlagCopyFromCapture(!!t&&!!t.isCopyFromCap),z.a.setTimeClipboardChanged(performance.now()),null===(s=Object(N.b)())||void 0===s||s.setTimeClipboardChanged(performance.now())}),[]),n=(t,s)=>{const r=R.default.getFriendsSync();j.a.doActionWithUri(s,e,r)},i=(t,{term:s,data:r})=>{switch(s){case"id":j.a.autoOpenConversationById(r,e),r.startsWith(L.GROUPID_PREFIX)?B.default.logAction(2220801):r.startsWith(L.OA_ID_PREFIX)?B.default.logAction(2220803):B.default.logAction(2220802);break;case"phone":B.default.logAction(2220804),j.a.autoOpenConversationByPhone(r,e);break;case"username":B.default.logAction(2220805),j.a.autoOpenConversationByUsername(r,e);break;default:M.a.createError(w.default.str("STR_GROUP_NO_EXIST"))}};Object(h.useEffect)((()=>($zsub.$zuri.onNewRequest(n),$zsub.$zuri.onRequestOpenConv(i),()=>{$zsub.$zuri.removeListenNewRequest(n),$zsub.$zuri.removeListenRequestOpenConv(i)})),[e]),Object(h.useEffect)((()=>{$zsub.$zapp.onRequestShowPreference(t),$zsub.$zapp.onRequestShowAbout(s),$zsub.$zresource.onClipboardChange(r)}),[])})(s),p.a.createElement(m.c,Object(l.a)({emitter:r,dispatch:s},n,{shouldShowMigrateScreen:e.shouldShowMigrateScreen}))};function H(e){const t=Object(k.j)(V.b,V.c,(e=>{const{status:t}=e;return F.b.includes(t)}));return p.a.createElement(Q,Object(l.a)({},e,{shouldShowMigrateScreen:t}))}const q=e=>{const{appVersionState:t}=Object($.a)();if(t===P.a.NONE)return null;return t===P.a.VERIFIED?p.a.createElement(H,e):p.a.createElement(U.a,null)},Z=((...e)=>({children:t})=>e.reduceRight(((e,[t,s={}])=>p.a.createElement(t,s,e)),t))([g.a,{store:b.default}],[g.a,{store:A.a,context:A.b}],[g.a,{store:E.a,context:O.a}],[g.a,{store:T.a,context:S.a}],[g.a,{store:k.b,context:k.a}],[v.b],[C.c],[D.a]),x=()=>p.a.createElement(Z,null,p.a.createElement(I,null),p.a.createElement(q,null));var K,W=s("Mgpg");let G=Object(r.injectable)()(K=function(e,t){return Object(r.inject)(i.a)(e,void 0,0)}(K=function(e,t){return Object(r.inject)(W.ZLoggerFactory)(e,void 0,1)}(K=Reflect.metadata("design:type",Function)(K=Reflect.metadata("design:paramtypes",[void 0===i.a?Object:i.a,void 0===W.ZLoggerFactory?Object:W.ZLoggerFactory])(K=class extends o.a{constructor(e,t){super("zalo",e,t,{component:x,container:document.getElementById("app")})}async start(){this.setupIdleDetector(),await super.start()}setupIdleDetector(){const e=this.config.get("idle_detector"),t=new u(e);t.addEventListener(a.Idle,(()=>{this.setStateToIdle()})),t.addEventListener(a.Active,(()=>this.setStateToActive())),t.start(),this.disposables.add((()=>t.stop())),document.hasFocus()?this.setStateToActive():this.setStateToIdle()}})||K)||K)||K)||K)||K;r.ModuleContainer.registerSingleton(n.a,G)},WrSY:function(e,t,s){"use strict";s("EmOc"),s("ezdo"),s("KdAX"),s("mzek"),s("aBYf"),s("zm+Q"),s("WSI5"),s("v/rv"),s("nAZb"),s("c0KM"),s("zheM"),s("CXIs"),s("cZjg");var r=s("YrRS");Object(r.b)()},Ws6j:function(e,t,s){"use strict";s("Of9+");var r,n=s("8/YW"),i=s("0B28"),o=s("YEoC"),a=s("X2RP"),c=s("ggcH"),d=s("rvru"),u=s("jDHv"),l=s("rkiK"),h=s("Mk04"),p=s("PoHQ"),g=s("DOOx"),m=s("Yggq"),b=s("HWGt");(new(Object(n.h)()(r=class extends b.a{constructor(...e){super(...e),this.dbQos=null,this.signalDisableCreatingBackup=Object(h.a)((e=>{i.a.getInstance().disableCreatingBackup(e)})),this.signalEnableCreatingBackupForIDB=Object(h.a)((()=>{i.a.getInstance().enableCreatingBackup(o.a.IDB)})),this.signalOutOfMem=Object(h.a)((()=>{p.p.triggerEvent(p.o,[{type:g.b.OUT_OF_MEM,src:g.a.DB}])})),this.signalInvalidVersion=Object(h.a)((()=>{$zdb.notifyOpenDBFailed(!0,"VersionError")})),this.signalMissingStore=Object(h.a)((()=>{$zdb.notifyOpenDBFailed(!0,"zkey-miss-object-store")})),this.signalExceedingLimitInReopeningDBConnection=Object(h.a)((()=>{$zdb.notifyOpenDBFailed(!1)})),this.signalDBClosedAbnormally=Object(h.a)((()=>{u.ModuleContainer.resolve(c.TDBCorruptionDetector).forceCheckDBCorruption()}))}getDBQos(){return null===this.dbQos&&(this.dbQos=u.ModuleContainer.resolve(d.a)),this.dbQos}handleQueryError(e){this.getDBQos().sendDBErrorQos(e)}handleOutOfMemError(e){this.signalOutOfMem(),this.signalDisableCreatingBackup(e.adapterType)}handleInvalidVersionError(){this.signalInvalidVersion()}handleMissingStoreError(e){const{database:t,missingTables:s,adapterType:r}=e;this.signalMissingStore(),this.signalDisableCreatingBackup(r);this.getDBQos().sendMissingTableQos(t,s)}handleExceedingLimitInReopeningDBConnection(e){this.signalExceedingLimitInReopeningDBConnection(),this.signalDisableCreatingBackup(e.adapterType)}handleQueryExec(e){const{database:t,table:s,method:r,transaction:n,startTime:i,getEndTime:o}=e;m.a.has(t)||o().then((e=>{const o={method:r,database:t,table:s,transaction:n};l.default.recordInfo(l.MetricName.query_resolution_time,{startAt:i,endAt:e,info:o})})).catch((e=>{}))}handleSuccessOpenDB(e){const{startTime:t,endTime:s,fullname:r,adapterType:n}=e;this.getDBQos().sendSuccessOpenDBDurationQos(r,t,s-t),l.default.recordInfo(l.MetricName.db_ready,{startAt:t,endAt:s,info:{dbName:r}}),n===o.a.IDB&&this.signalEnableCreatingBackupForIDB()}handleConnectionClosedAbnormally(){this.signalDBClosedAbnormally()}handleSchemaMigratedAbnormally(){}handleLongOpenDB(e){const{startTime:t,endTime:s,fullname:r}=e;this.getDBQos().sendLongOpenRequestQos(r,t,s-t)}handleTimeConsumingQuery(e,t){this.getDBQos().sendTimeConsumingQueryQos(e,t)}handleWarning(e){const t=this.getDBQos();if(e.type===a.b.FAILED_MULTI)t.sendFailedMultiErrorQos(e)}onDispose(){this.dispose()}})||r)).start()},bO0B:function(e,t,s){"use strict";s("v5OU")},fNRA:function(e,t,s){"use strict";var r,n=s("8/YW"),i=s("Hw41"),o=s("YEoC"),a=s("PmZf"),c=s("bSii"),d=s("tHMN"),u=s("d/or"),l=s("1UUk"),h=s("jDHv"),p=s("xM06"),g=s("8eps"),m=s("fsN4"),b=s("Mgpg");let C=Object(n.h)()(r=h.ModuleContainer.injectable()(r=function(e,t){return h.ModuleContainer.inject(d.b)(e,void 0,0)}(r=function(e,t){return h.ModuleContainer.inject(u.a)(e,void 0,1)}(r=function(e,t){return h.ModuleContainer.inject(b.ZLoggerFactory)(e,void 0,2)}(r=Reflect.metadata("design:type",Function)(r=Reflect.metadata("design:paramtypes",[void 0===d.a?Object:d.a,void 0===u.a?Object:u.a,void 0===b.ZLoggerFactory?Object:b.ZLoggerFactory])(r=class extends l.a{constructor(e,t,s){super(),this.engine=e,this.settingsManager=t,this.logger=void 0,this.removeListeners=()=>{},this.logger=s.createZLogger("db",["host"]),this.registerListeners()}registerListeners(){const e=e=>this.dispatchEvent(e),t=[];t.push(this.engine.addEventListener(a.b.UnexpectedError,e)),t.push(this.engine.addEventListener(a.b.QueryExec,e)),t.push(this.engine.addEventListener(a.b.QueryError,e)),t.push(this.engine.addEventListener(a.b.SuccessOpenDB,e)),t.push(this.engine.addEventListener(a.b.LongOpenDB,e)),t.push(this.engine.addEventListener(a.b.TimeConsumingQuery,e)),t.push(this.engine.addEventListener(a.b.ConnectionClosedAbnormally,e)),t.push(this.engine.addEventListener(a.b.SchemaMigratedAbnormally,e)),t.push(this.engine.addEventListener(a.b.Warning,e)),t.push(this.addEventListener(a.b.SessionChange,(()=>{Object(c.c)(!1)}))),this.removeListeners=()=>t.forEach((e=>e()))}onDispose(){this.removeListeners()}removePartitionKeyTableMapping(){Object(c.b)()||this.engine.deleteDatabase("Meta").then((()=>{Object(c.c)(!0)})).catch((e=>{this.logger.zsymb(18,"lOvrcP","Failed to remove partition key table mapping",e)}))}install(){$zsub.$zdb.onRequestCloseDbs((async(e,t)=>{this.logger.zsymb(0,"0TSN5f","closing requested databases ..."),await this.closeDBsForThisScript(t),$zdb.notifyFinishCloseDb(__ZaBUNDLENAME__),this.logger.zsymb(0,"DQkCs6","closed database")})),$zdb.notifyDbConnected(__ZaBUNDLENAME__)}areYouOk(){return!0}authenticate(e){$zdb.authenticateDb(e),e&&(this.session=e,this.dispatchEvent(new a.g(e)),this.engine.authenticate(e),this.logger.zsymb(0,"ysfImO",(()=>["authenticated",`id: ${e.userId}`])))}async closeDBsForThisScript(e,t){const s=m.default.getInstance(),r=this.logger;let n=[];if(e){if(e.length){let i=[...e];r.zsymb(3,"5HP9HI",["Start closing dbs: {}","pgQwMz"],e),r.zsymb(3,"RRQSXb",["Wait for dbs to be closed: {}","QhuMGo"],i),n=e.map((async e=>{let n=s[e];if(void 0===n){const t=h.ModuleContainer.resolve(g.a).getValue().Meta;if(t.databaseName!==e)return void r.zsymb(21,"LLVc0H",["Can't close invalid db: {}","Fal05B"],e);n=t}await n.closeThisDatabase(t),i=i.filter((t=>t!==e)),0===i.length?r.zsymb(0,"r6mf3z","Done closing dbs"):r.zsymb(3,"iWodRI",["Wait for dbs to be closed: {}","QhuMGo"],i)}))}}else n=[s.closeAllDatabases(t)];await Promise.all(n)}async signalCloseDBs(e,t){var s;this.logger.zsymb(0,"v_8Riy","send closing requested databases signal"),null!==(s=window.$zenv)&&void 0!==s&&s.isPreloaded&&(await $zdb.requestCloseDbs(e,__ZaBUNDLENAME__,t),this.logger.zsymb(0,"vnL26B","All clients have finished closing the requested DBs"))}async closeDBs(e,t){void 0===e?this.logger.zsymb(0,"cF3SQb","close all databases"):this.logger.zsymb(3,"ZZ7k8R",["close the following database: {}","Ef5tJR"],e);const s=(await this.settingsManager.getInUseAdaperTypes()).map((async s=>{try{if(s===o.a.IDB)return this.signalCloseDBs(e,t);if(s===o.a.SQLite)return e?this.signalCloseDBs(e,t):this.signalSQLiteProcessToCloseAllDBs()}catch(r){this.logger.zsymb(21,"cdBJ0n",["error close database: {}","hKJ9px"],r)}}));await Promise.all(s)}async signalSQLiteProcessToCloseAllDBs(){const e={typeID:p.i,data:{type:p.d,data:{}}},t=h.ModuleContainer.resolve(i.b),s=await t.getPort();await s.invokeMessage(e)}})||r)||r)||r)||r)||r)||r)||r;h.ModuleContainer.registerSingleton(l.b,C)},jw3m:function(e,t,s){},mneU:function(e,t,s){"use strict";var r=s("Y65e"),n=s("jDHv"),i=s("8/YW"),o=s("+ExH"),a=s("ycTR"),c=s("wH4e"),d=s("Mgpg"),u=s("CDcE"),l=s("ODpZ"),h=s("nQja"),p=s("rkiK");var g=s("QrVG");class m{constructor(e){this.versionConfigs=void 0,this.versionConfigs=e||[]}getConfigList(){return this.versionConfigs}getConfigByDbName(e){return this.versionConfigs.find((t=>t.name===e))}serialize(){return this.versionConfigs.length?JSON.stringify(this.versionConfigs):""}toString(){return this.versionConfigs.map((e=>`${e.name}::${e.version}`)).join(" | ")}static deserialize(e){try{let t=[];const s=JSON.parse(e);return null!=s&&s.length&&s.forEach((e=>{null!=e&&e.name&&Number.isInteger(Number(e.version))&&t.push({name:e.name,version:Number(e.version)})})),new this(t)}catch(t){}return new this}}var b,C,v,D,f,y,I,E,O,T,S=s("Q97H");b=Object(i.j)(),C=Object(i.h)(),v=Object(n.singleton)(l.a),D=Reflect.metadata("design:type",Function),f=Reflect.metadata("design:paramtypes",[]),y=p.MetriczMessenger.invoker("appVersionManager.saveLastUsedInfo"),I=Reflect.metadata("design:type",Function),E=Reflect.metadata("design:paramtypes",[Number,String]),b(O=C(O=v(O=D(O=f((T=class{constructor(){this._logger=void 0,this.currentDbVersion=void 0,this.appVersionState=void 0,this.handleQuitApp=()=>{S.a.closeDB((()=>{$zapp.requestQuitAppImmediately()}))}}async requestUpdateLastUsedAppVersionInfo(e,t){return[e,t]}async onStart(){if(null==this.appVersionState&&(this.appVersionState=this.verifyAppVersion(),this.afterVerifyAppVersion()),this.appVersionState===h.a.VERIFIED){this.currentDbVersion||(this.currentDbVersion=this.getCurrentDBVersion());try{await this.requestUpdateLastUsedAppVersionInfo(1,this.currentDbVersion.serialize()),this.logger.zsymb(0,"2lGVio",`save app version success. majorVersion 1; dbVersion ${this.currentDbVersion.toString()}`)}catch(e){this.logger.zsymb(18,"7Hj2jG",`failed on save app version state. ERR ${Object(u.e)(e)}`)}}}onDispose(){this.appVersionState!==h.a.VERIFIED&&$zsub.$zapp.removeListenConfirmAppQuit(this.handleQuitApp)}checkAppVersion(){return null==this.appVersionState&&(this.appVersionState=this.verifyAppVersion(),this.afterVerifyAppVersion()),this.appVersionState}quitApp(){this.handleQuitApp()}verifyAppVersion(){const e=g.a.lastUsedMajorVersion,t=g.a.lastUsedDbVersion?m.deserialize(g.a.lastUsedDbVersion):null;if(!(!e||e<=1))return this.logger.zsymb(18,"RqfX7j",`verifyAppVersion: detect old major version. current 1; lastUsed ${e}`),h.a.OLD_MAJOR_VERSION;if(!t)return this.logger.zsymb(0,"fMBDnW","verifyAppVersion: VALID. no previous db version."),h.a.VERIFIED;this.currentDbVersion||(this.currentDbVersion=this.getCurrentDBVersion());return this.verifyDbVersion(t,this.currentDbVersion)?(this.logger.zsymb(0,"AhRO8h",`verifyAppVersion: VALID. lastUsedMajorVersion ${e}; lastUsedDbVersion ${t.toString()}`),h.a.VERIFIED):(this.logger.zsymb(18,"o6u2ut",`verifyAppVersion: detect old DB version. current ${this.currentDbVersion.toString()}; lastUsed ${t.toString()}`),h.a.OLD_DB_VERSION)}afterVerifyAppVersion(){this.appVersionState!==h.a.VERIFIED&&$zsub.$zapp.onConfirmAppQuit(this.handleQuitApp)}verifyDbVersion(e,t){for(const s of t.getConfigList()){const t=e.getConfigByDbName(s.name);if(t&&t.version>s.version)return this.logger.zsymb(18,"OypPa4",`verifyDbVersion: old DB version. dbName ${s.name}; current ${s.version}; lastUsed ${t.version}`),!1}return!0}get logger(){return this._logger||(this._logger=n.ModuleContainer.resolve(d.ZLoggerFactory).createZLogger("app-version",["manager"])),this._logger}getCurrentDBVersion(){const e=Object.values(o.a).map((e=>e.baseConfig.name)),t=[];e.forEach((e=>{const s=Object(a.a)(e,c.AdapterType.SQLite);s&&t.push({name:e,version:s.version})}));return new m(t)}},Object(r.a)(T.prototype,"requestUpdateLastUsedAppVersionInfo",[y,I,E],Object.getOwnPropertyDescriptor(T.prototype,"requestUpdateLastUsedAppVersionInfo"),T.prototype),O=T))||O)||O)||O)||O)},nQja:function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));let r=function(e){return e.VERIFIED="VERIFIED",e.OLD_MAJOR_VERSION="OLD_MAJOR_VERSION",e.OLD_DB_VERSION="OLD_DB_VERSION",e.NONE="NONE",e}({})},o0oJ:function(e,t,s){(function(e){const t={};function s(e){return t[e]||(t[e]=0),t[e]+=1,100*e+t[e]}if(!e.perf){let t=()=>Date.now();const r={STARTUP:s(1),MIGRATION_DONE:s(2),MAIN_SCRIPT:s(2),LOADED_MAIN_SCRIPT:s(3),MAIN_APP_READY:s(3),LOADED_STARTUP_SCRIPT:s(2),STARTUP_BEFORE_HEAVY:s(3),CREATE_MAIN_WINDOW:s(3),SHOW_MAIN_WINDOW:s(3),MAIN_WINDOW_LOADING:s(3),MAIN_WINDOW_LOADED:s(3),APP_STARTUP:s(2),LOAD_APP_SCRIPT:s(3),APP_DID_MOUNT:s(3),CHATBOX_DID_MOUNT:s(3),SELECT_CONVERSATION:s(1),SELECTED_CONVERSATION:s(2)};e.perf={...r,perfRecords:[],record:s=>{s||(s=0);const r=[s,t()];e.perf.perfRecords.push(r)}}}}).call(this,s("yLpj"))},szdT:function(e,t,s){"use strict";var r,n=s("8/YW"),i=s("nMWc"),o=s("jDHv");let a=Object(n.h)()(r=Reflect.metadata("design:type",Function)(r=Reflect.metadata("design:paramtypes",[])(r=class extends i.a{constructor(){super(),this.disposeEventListeners=()=>{},this.setUpEventListeners()}setUpEventListeners(){const e=[];{const t=(e,t)=>{this.updateEventMapOnStartIdleEvent(t);for(const s of this.startIdleListeners)s(t)};$zsub.$zapp.onStartIdle(t),e.push((()=>{$zsub.$zapp.removeListenStartIdle(t)}))}{const t=e=>{this.updateEventMapOnEndIdleEvent();for(const t of this.endIdleListeners)t()};$zsub.$zapp.onEndIdle(t),e.push((()=>{$zsub.$zapp.removeListenEndIdle(t)}))}this.disposeEventListeners=()=>{for(const t of e)t()}}registerIdleCheckInterval(e){$zapp.registerIdleCheckInterval(e)}onDispose(){this.disposeEventListeners()}preload_onIdleCheckIntervalRegistered(e,t){throw new Error("Method not implemented.")}})||r)||r)||r;o.ModuleContainer.registerSingleton(i.b,a)},tPRg:function(e,t,s){"use strict";s("o0oJ"),s("dThN"),s("z0WU"),s("vSga"),s("XS0u");perf.record(perf.LOAD_APP_SCRIPT),function(){window.__loadTimer&&clearTimeout(window.__loadTimer);window.__startTime&&$zlogger.loadShellQos(Date.now()-window.__startTime)}()},vUp1:function(e,t,s){"use strict";var r,n=s("VTBJ"),i=s("JTyQ"),o=s("hI9i"),a=s("rCQs"),c=s("rfrl"),d=s("7nHs");const u={isShown:!1,modalTitle:"",guideTitle:"",errorCode:"",guideItems:[],showPrimaryBtn:!0,primaryBtnName:"STR_BU_CONFIRM_TEXT_6",showSecondaryBtn:!0,secondaryBtnName:"STR_BU_CANCEL_TEXT_6",adapterType:i.b};Object(a.b)(d.a)(r=class{constructor(){this.name=d.b,this.key="",this.state=u}setState(e){const t=Object(c.a)(this.state,e);this.state!==t&&(this.state=t,Object(o.g)(this.name,""))}showModal(e){this.state.isShown||this.setState((t=>Object(n.a)(Object(n.a)(Object(n.a)({},t),e),{},{isShown:!0})))}closeModal(){this.state.isShown&&this.setState((e=>Object(n.a)(Object(n.a)(Object(n.a)({},e),u),{},{isShown:!1})))}init(e){}getItem(e,t){return this.state}getList(e,t){return[]}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})},xir9:function(e,t,s){"use strict";var r=s("jDHv"),n=s("fc/q"),i=s("PoHQ");r.ModuleContainer.registerSingleton(n.b,class{log(e){i.p.triggerEvent(i.i,[{commandId:e.commandId,success:!0===e.success,subCommandId:e.subCommandId||0,duration:e.duration||0,errorCode:e.errorCode||0,startTime:e.startTime||Date.now(),params:e.params}])}})}}]);
//# sourceMappingURL=../sourcemaps/lazy/default-login-startup-main-startup.838381f3353074e58886.js.map