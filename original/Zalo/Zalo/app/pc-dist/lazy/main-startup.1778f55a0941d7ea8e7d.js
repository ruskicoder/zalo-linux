(this.webpackJsonp=this.webpackJsonp||[]).push([[24],{"3OF5":function(e,t,s){"use strict";s.r(t);s("TlRV"),s("m+NF"),s("bO0B"),s("33YB"),s("jmmm"),s("xDXR"),s("WrSY");var i=s("jDHv"),a=s("W8Xk"),n=s("igA5");const r=Object(i.define)("kv-cache"),o=Object(i.define)("kv-cache-in-mem");var c;class l{constructor(e){this._prefix=void 0,this._prefix=`${e}-kv-db`}_buildKey(e){return`${this._prefix}-${e}`}async setItem(e,t){const s=this._buildKey(e),i=n.default.getInstance();return await i.setItemAsync(s,a.b(t)),t}async getItem(e){const t=this._buildKey(e),s=n.default.getInstance(),i=await s.getItemAsync(t);return Promise.resolve(i?a.a(i):void 0)}async removeItem(e){const t=this._buildKey(e),s=n.default.getInstance();return await s.removeItemAsync(t),this}}Object(i.singleton)(r)(c=class{createCache(e){return new l(`${e}`)}});var d,h=s("ndDP");class u{constructor(e,t){this._unused_name=e,this._lru=void 0,this._lru=new h.default(t)}setItem(e,t){return this._lru.set(e,t),Promise.resolve(t)}getItem(e){return Promise.resolve(this._lru.get(e))}removeItem(e){return this._lru.delete(e),Promise.resolve(this)}}Object(i.singleton)(o)(d=class{constructor(){this._registry={}}createCache(e,t){return this._registry[e]||(this._registry[e]=new u(e,t)),this._registry[e]}});s("LyOm"),s("lNuO"),s("xir9"),s("4Vil"),s("0rWR"),s("Lq8m"),s("EicM"),s("nUpV"),s("5yGw"),s("hRcX"),s("/2rj"),s("gpNb"),s("rhBN"),s("BP4/"),s("cF85"),s("7g9m"),s("oqw1");var g,m=s("8/YW"),p=s("Hw41"),f=s("xM06"),v=s("fcdz"),_=s("Ofqi"),b=s("aEKn");Object(m.e)()(g=Object(m.f)()(g=Object(i.singleton)()(g=Reflect.metadata("design:type",Function)(g=Reflect.metadata("design:paramtypes",[])(g=class{constructor(){this.corruptionSignalConsumer=void 0,this.corruptionAnalyzeConsumer=void 0,this.corruptionSignalConsumer=b.a.getInstance(),this.corruptionAnalyzeConsumer=_.a.getInstance()}onApplicationStart(){this.install()}onAuthenticated(e){this.corruptionAnalyzeConsumer.authenticate(e._session)}async install(){const e=i.ModuleContainer.resolve(p.b);(await e.getPort()).handleMessage((e=>this.handleRequest(e)))}async handleRequest(e){const{typeID:t}=e;if(t===f.j){const{type:t,data:s}=e.data;switch(t){case f.b:return this.corruptionAnalyzeConsumer.processAnalyzeCorruption(s.database);case f.y:return this.corruptionSignalConsumer.processSignalCorruption(s.corruptionInfo)}}return v.b}})||g)||g)||g)||g);s("9AEM");var y=s("UK4g"),I=s("DI/x"),S=s("0Grr"),C=s("ipWf"),E=s.n(C);class O extends S.a{async getDBRoot(){const e=await $zelectron.getPath("userData");if(null===e)throw new I.D("Can't retrieve 'userData' path!");return E.a.join(e,y.a,"_production")}async getMainBackupRoot(){const e=await $zelectron.getPath("userData");if(null===e)throw new I.D("Can't retrieve 'userData' path!");let t="_production";return t+="_bu",E.a.join(e,y.a,"_production_bu")}async getTempBackupRoot(){const e=await $zelectron.getPath("userData");if(null===e)throw new I.D("Can't retrieve 'userData' path!");let t="_production";return t+="_temp_bu",E.a.join(e,y.a,"_production_temp_bu")}async getRejectBackupRoot(){const e=await $zelectron.getPath("userData");if(null===e)throw new I.D("Can't retrieve 'userData' path!");let t="_production";return t+="_rej_bu",E.a.join(e,y.a,"_production_rej_bu")}}i.ModuleContainer.registerSingleton(S.c,O);s("fNRA"),s("6Pbj"),s("5lV7"),s("szdT");var T=s("VTBJ"),M=s("ahRi");var R=s("ptxg"),w=s("pUq9");let L;L=class{getOverrideDomain(e){}getDomainConfig(){return{}}setDomainConfig(e){return this}subscribe(e){return()=>{}}},Object(i.injectable)()(L),Object(i.singleton)(R.a)(L);s("dhzt");var F=s("J25b"),D=s("bUXd");i.ModuleContainer.registerSingleton(F.b,class{getHourNow(){return new Date(D.default.getTimeNow()).getHours()}getTimeNow(){return D.default.getTimeNow()}getSystemTimeNow(){return D.default.getSystemTimeNow()}});s("tPRg");var A=s("z0WU"),N=(s("FcQj"),s("Ydol")),k=s("sxU/"),P=s("97kL"),j=s("eSGF"),U=s("NDmK"),B=s("Mgpg");let G;function z(){return G||(G=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger("utils",["event-bus-effects"])),G}const x={[P.FetchActions.DELETE_EVERYONE]:(e,t)=>{V(e.toUid,e.msgId)},[P.FetchActions.UNDO_MULTI]:(e,t)=>{var s;null==e||null===(s=e.forEach)||void 0===s||s.call(e,(e=>V(e.toUid||e.userId,e.msgId)))},[P.FetchActions.UNDO]:(e,t)=>{V(e.toUid||e.userId,e.msgId)},[P.FetchActions.REMOVE_MEDIA]:(e,t)=>{for(let s of e.items)V(null==e?void 0:e.conversationId,null==s?void 0:s.msgId)},[P.ChatBoxActions.REMOVE_EXPIRED_MEDIA]:(e,t)=>{V(null==e?void 0:e.conversationId,(null==e?void 0:e.msgIds)||(null==e?void 0:e.msgId))},[P.ChatBoxActions.DELETE_MESSAGE]:(e,t)=>{const s=e.toUid||e.userId||e.conversation&&e.conversation.userId;s!==U.default.sendToMeId&&V(s,e.msgId)}};function V(e,t){if(!e)return;if(!t)return;let s=Object(j.a)(t);k.a.instance.emit("media-removed",{convId:e,msgIds:s})}N.default.subscribe((function(e,t){let s=x[e];if(s)try{s(t,e)}catch(i){z().zsymb(18,"Qqo1dW","Failed to run side effect for event:"+e),z().zsymb(18,"fl6Uth",[i])}}));var H=s("2ua2");s.p;H.default.init(),A.default.checkSupport(),A.default.showWarningMsg();var q,W=s("1pet"),Z=s("UiPd"),K=s("Kvb3"),Q=s("QPNp"),$=s("lTs8"),Y=s("DvVh"),J=s("Y4eg"),X=s("+2cI");Object(i.singleton)(K.a)(q=Object(m.f)()(q=Reflect.metadata("design:type",Function)(q=Reflect.metadata("design:paramtypes",[])(q=class{constructor(){this._isConnectSignalChangeInfo=void 0,this._dispatch=void 0,this._authEvent=void 0,this._isConnectSignalChangeInfo=!1,this.signalInfoChange=this.signalInfoChange.bind(this)}isWeb(){return!1}bindDispatch(e){this._dispatch=e}getDispatch(){return this._dispatch}async preFormatPayload(e){let t=Object(T.a)({},e);if(t.conversation){var s,i;if(null===(s=t.conversation.userId)||void 0===s||null===(i=s.startsWith)||void 0===i?void 0:i.call(s,W.GROUPID_PREFIX)){const e=t.conversation.userId,s=await Q.a.GroupManager.get(e);if(s&&(t.conversation.topMember=s.topMembers,t.conversation.displayName=s.displayName),t.conversation.topMember)for(const i of t.conversation.topMember){const e=Z.default.getMiniInfo(i.id);e&&(i.dName=e.dName,i.avatar=e.avatar)}}else{const e=Z.default.getMiniInfo(t.conversation.userId);e&&(t.conversation.displayName=e.dName,t.conversation.avatar=e.avatar)}}return t}signalInfoChange(e){this.isWeb()}connectSignalToFriendWorker(){this._isConnectSignalChangeInfo||(this._isConnectSignalChangeInfo=!0,Z.default.connectSignalChangeDNameAndAvatar(this.signalInfoChange))}onAuthenticated(e){this._authEvent=e}_addSession(e){var t;return(e=Object(T.a)({},e)).session=null===(t=this._authEvent)||void 0===t?void 0:t.getSession(),e}async openPhotoViewer(e){var t;let s=await this.preFormatPayload(e);s=this._addSession(s),this.connectSignalToFriendWorker();const i=this.getDispatch();i&&i({type:P.ChatBoxActions.SHOW_FULL_IMAGE,payload:s}),J.a.initLog(),X.a.startSession(),$.a.emitWithKey(Y.d.userOnNewDeviceTracking,null!==(t=s)&&void 0!==t&&t.isVideo?Y.d.openVideo:Y.d.openPhoto)}async openImageCaptionEditor(e){let t=await this.preFormatPayload(e);t=this._addSession(t),this.connectSignalToFriendWorker();const s=this.getDispatch();s&&s({type:P.ChatBoxActions.SHOW_MEDIA_CAPTION_EDITOR,payload:t})}})||q)||q)||q);s("TGaw");var ee,te=s("EAii"),se=s("Fdeg"),ie=s("rCQs"),ae=s("PD1X"),ne=s("KkZn"),re=s("IpzU"),oe=s("vXRA");const ce=$znode.path,le=$znode.fs;Object(ie.b)(te.a)(ee=function(e,t){return i.ModuleContainer.inject(B.ZLoggerFactory)(e,void 0,0)}(ee=function(e,t){return i.ModuleContainer.inject(m.a)(e,void 0,1)}(ee=Reflect.metadata("design:type",Function)(ee=Reflect.metadata("design:paramtypes",[void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory,void 0===m.a?Object:m.a])(ee=class{constructor(e,t){this._app=t,this._isExpired=!0,this._localCacheName="res.zcache",this._localCacheFolders={[se.a.zaloLocal]:"",[se.a.zaloDB]:"",[se.a.zaloProramExe]:"",[se.a.zaRF]:"",[se.a.zaloTemp]:"",[se.a.zTemp]:""},this._localCacheData={[se.a.zaloLocal]:new h.default({maxSize:1e4}),[se.a.zaloDB]:new h.default({maxSize:1e3}),[se.a.zaloProramExe]:new h.default({maxSize:5e3}),[se.a.zaRF]:new h.default({maxSize:1e3}),[se.a.zaloTemp]:new h.default({maxSize:1e3}),[se.a.zTemp]:new h.default({maxSize:1e3})},this.logger=void 0,this.init=()=>{"render"===__ZaBUNDLENAME__&&this.getCachePaths()},this.getLocalCacheData=async e=>{const t=".rescache",s=[],i=await Object(re.getzTempDir)(),a=await Object(re.getZaloTempDir)();se.b.forEach((n=>{try{let r;r="zTemp"===n?ce.join(i,t):"ZaloTemp"===n?ce.join(a,t):ce.join(e,"ZaloDownloads"===n?"":n,t),null!=le&&le.existsSync(r)&&s.push(this.readCacheFile(r,n))}catch(r){}}));const n=await Promise.all(s),r={};return n.forEach((e=>{r[e.type]={count:(null==e?void 0:e.count)||0,size:(null==e?void 0:e.totalSize)||0}})),r},this.readCacheFile=async(e,t)=>{try{{let s=await $zFileManager.getFileArrayBuffer(e);const i=new Blob([s]),a=await i.text();return Object(T.a)(Object(T.a)({},Object(ne.g)(a)),{},{type:t})||null}}catch(s){throw Error(s)}},this._listenEvents=()=>{"render"===__ZaBUNDLENAME__&&(this._app.addEventListener(m.b.Authenticated,this.init),this._app.addEventListener(m.b.Exit,this._removeListeners))},this._removeListeners=()=>{"render"===__ZaBUNDLENAME__&&(this._app.removeEventListener(m.b.Authenticated,this.init),this._app.removeEventListener(m.b.Exit,this._removeListeners))},this.logger=e.createZLogger("resmgmt",["cache-maanger"]),this.logger.zsymb(5,"wfkGoF",["ResCacheManager is created","0-8tmJ"]),this._listenEvents()}async getCacheType(e){if((e=(null==ce?void 0:ce.join(e,ce.sep))||e).startsWith(this._localCacheFolders[se.a.zaloLocal]))return se.a.zaloLocal;if(e.startsWith(this._localCacheFolders[se.a.zaloDB]))return se.a.zaloDB;if(e.startsWith(this._localCacheFolders[se.a.zaloProramExe]))return se.a.zaloProramExe;if(e.startsWith(this._localCacheFolders[se.a.zTemp]))return se.a.zTemp;if(e.startsWith(this._localCacheFolders[se.a.zaloTemp]))return se.a.zaloTemp;if(await this._getVerifiedZaRFPath(),e.includes(this._localCacheFolders[se.a.zaRF]))return se.a.zaRF;throw new Error("Invalid cache type "+e)}async hasScan(e){const t=await this.getCacheType(e);return this._localCacheData[t].has(e)}async getScan(e){e=e.endsWith("/")?e.slice(0,-1):e;const t=await this.getCacheType(e);if(this._localCacheData[t].has(e))return this._localCacheData[t].get(e);let s=()=>{},i=()=>{};const a=new Promise(((e,t)=>{s=e,i=t}));return this._localCacheData[t].set(e,{promise:a,resolve:s,reject:i}),{promise:a,resolve:s,reject:i}}async revokeCache(){this._isExpired=!0}async signCache(){this._isExpired=!1,this._clearAllCacheData()}async hasCacheFile(e){let t=ce.dirname(e);t=t.endsWith("/")?t.slice(0,-1):t;const s=await this.getCacheType(t);if(this._isExpired)return this._localCacheData[s].delete(e),!1;this._localCacheFolders[s]||await this.getCachePaths();return this._localCacheData[s].has(t)}async getCacheFile(e){let t=0,s=ce.dirname(e);s=s.endsWith("/")?s.slice(0,-1):s;const i=ce.basename(e);if(!this.hasCacheFile(e)){this.logger.zsymb(15,"kTKZbh",["Cache not found for {}. Request calculator for {}","LjHVbw"],e,s);try{const e=new ae.a(s),i=await e.run();t=i.result||0,this.logger.zsymb(15,"PbJl5A",["Calculate {} responded with {}","qMzbJO"],s,i)}catch(r){}}const a=await this.getCacheType(s),n=this._localCacheData[a].get(s);return t=(await n.promise).data[i][1],this.logger.zsymb(15,"WD7NEp",["Folder size: {} === {} bytes","-oFrt8"],e,t),t}verifyCache(){this._isExpired=!1}isValid(){return!this._isExpired}deleteCacheObject(e){this._localCacheData[e].clear()}_clearAllCacheData(){this._localCacheData[se.a.zaloLocal].clear(),this._localCacheData[se.a.zaloDB].clear(),this._localCacheData[se.a.zaloProramExe].clear(),this._localCacheData[se.a.zaRF].clear()}_removeTrailingPathSeparator(e){return e.replace(/[\\/]+$/,"")}async getCachePaths(){this._localCacheFolders[se.a.zaloLocal]=this._removeTrailingPathSeparator(await Object(re.getZaloPCDir)()),this._localCacheFolders[se.a.zaloDB]=this._removeTrailingPathSeparator(await Object(re.getZaloDir)()),this._localCacheFolders[se.a.zaloProramExe]=this._removeTrailingPathSeparator(await Object(re.getexeDir)()),this._localCacheFolders[se.a.zaRF]=this._removeTrailingPathSeparator(await Object(oe.a)()),this._localCacheFolders[se.a.zTemp]=this._removeTrailingPathSeparator(await Object(re.getzTempDir)()),this._localCacheFolders[se.a.zaloTemp]=this._removeTrailingPathSeparator(await Object(re.getZaloTempDir)());for(const e in this._localCacheFolders){const t=this._localCacheFolders[e];t&&(this._localCacheFolders[t]=e)}await this._getVerifiedZaRFPath()}async _getVerifiedZaRFPath(){const e=await Object(oe.a)(),t=ce.dirname(e);return this._localCacheFolders[se.a.zaRF]=t,this._localCacheFolders[t]=se.a.zaRF,t}})||ee)||ee)||ee)||ee);var de=s("7Xnh"),he=s("Ff2n");let ue=function(e){return e.DiskStatus="DiskStatus",e.ZaloUsage="ZaloUsage",e.DeleteConv="DeleteConv",e.Cache="Cache",e.TimeGoToSM="TimeGoToSM",e.TimeFinishedScan="TimeFinishedScan",e}({}),ge=function(e){return e[e.Routine=0]="Routine",e[e.UserManual=1]="UserManual",e}({}),me=function(e){return e.CacheValid="cache_valid",e.StartNewScanWithoutCache="start_new_scan_without_cache",e.StartNewScanWithCache="start_new_scan_with_cache",e.ContinueQuickScan="continue_quick_scan",e.ContinueDBScan="continue_db_scan",e}({});const pe={[ue.DiskStatus]:5,[ue.ZaloUsage]:7,[ue.DeleteConv]:8,[ue.Cache]:9,[ue.TimeGoToSM]:10,[ue.TimeFinishedScan]:11};var fe=s("Yi2m"),ve=s("KmCD"),_e=s("u8fi"),be=s("MGH9"),ye=s("PoHQ"),Ie=s("v4vb");const Se=["type"];var Ce;const Ee="resource_management_last_time_send_log_auto",Oe="resource_management_last_time_send_log_disk_status_auto";var Te=function(e){return e[e.YES=1]="YES",e[e.NO=0]="NO",e}(Te||{});let Me=Object(m.d)()(Ce=Reflect.metadata("design:type",Function)(Ce=Reflect.metadata("design:paramtypes",[])(Ce=class{constructor(){this.userCacheDir="",this.LogHistory={[ue.DiskStatus]:{ts:-U.default.full_disk_check.report_interval,pending:!1},[ue.ZaloUsage]:{ts:-U.default.full_disk_check.report_interval,pending:!1},[ue.Cache]:{ts:-U.default.full_disk_check.report_interval,pending:!1}},this.autoReportTimer=null,this.autoDiskStatusReportTimer=null,this.secureLocalStorage=void 0,this.timeGoToSM=0,this.startAutoReport=()=>{if(this.autoReportTimer)return;const e=this.secureLocalStorage.getItem(Ee);e&&this.getTimeNow()-+e>=U.default.full_disk_check.report_interval&&this.report(),this.autoReportTimer=setInterval(this.report,U.default.full_disk_check.report_interval)},this.report=async()=>{this.zaloUsageReport(),this.cacheReport({scan_event:ge.Routine}),this.secureLocalStorage.setItem(Ee,`${this.getTimeNow()}`)},this.getScanType=()=>ge,this.getTimeNow=()=>D.default.getSystemTimeNow()||Date.now(),this.canReport=()=>U.default.full_disk_check.enable_disk_cache&&U.default.full_disk_check.enable_report,this.diskStatusReport=e=>{if(!this.canReport())return;const{DiskStatus:t}=this.LogHistory,s=e?ge.UserManual:ge.Routine;if(s===ge.Routine&&!this._canActionLogDiskStatus(t.ts)||t.pending)return;this.LogHistory.DiskStatus.pending=!0;const i=e||ve.a.analyzeMainDisk();if(i){const{total:e,free:t}=i;this.logAction999({type:"DiskStatus",scan_event:s,free:t,total:e,ts:this.getTimeNow()})}this.LogHistory.DiskStatus.pending=!1},this.zaloUsageReport=async e=>{var t,s,a;if(!this.canReport())return;const{ZaloUsage:n}=this.LogHistory,r=e?ge.UserManual:ge.Routine;if(r===ge.Routine&&!this._canActionLog(n.ts)||n.pending)return;this.LogHistory.ZaloUsage.pending=!0;const o=i.ModuleContainer.resolve(_e.b),c=ve.a.analyzeMainDisk(),l=await o.getZaloUsageForLog(),d=i.ModuleContainer.resolve(be.a),h=ve.a.analyzeMainDisk();let u=0,g=0,m=0;if(!this.userCacheDir){const e=ye.p.getSessionUserId();this.userCacheDir=await Object(re.getUserZaloDownloadsDir)(e)}const p=i.ModuleContainer.resolve(te.a),f=await p.getLocalCacheData(this.userCacheDir);d.getConvData().forEach((e=>{const t=e.convId,s=ve.a.getCache(t);s&&(u+=s.filesSize,m+=s.imagesSize,g+=s.videosSize)}));const v=l.appDataSize,_={used:l.total,free:null!==(t=null==c?void 0:c.free)&&void 0!==t?t:-1},b={total_disk:h?h.total:0,photo:m,file_on_db:u,video_on_db:g,zalo_received_files:l.zarf,other_data:l.otherDataSize,db_size:v,zalo_temp:(null==f||null===(s=f.ZaloTemp)||void 0===s?void 0:s.size)||0,ztemp:(null==f||null===(a=f.zTemp)||void 0===a?void 0:a.size)||0};_&&this.logAction999(Object(T.a)({type:"ZaloUsage",scan_event:r,used:_.used,ts:this.getTimeNow(),free:_.free},b)),this.LogHistory.ZaloUsage.pending=!1},this.cacheReport=async e=>{var t;if(!this.canReport())return;const{Cache:s}=this.LogHistory,a=null!==(t=null==e?void 0:e.scan_event)&&void 0!==t?t:ge.Routine;if(a===ge.Routine&&!this._canActionLog(s.ts)||s.pending)return;this.LogHistory.Cache.pending=!0;const n=i.ModuleContainer.resolve(te.a);if(!this.userCacheDir){const e=ye.p.getSessionUserId();this.userCacheDir=await Object(re.getUserZaloDownloadsDir)(e)}const r=await n.getLocalCacheData(this.userCacheDir),o=i.ModuleContainer.resolve(be.a),c={count:0,size:0},l=ve.a.analyzeMainDisk();let d=0,h=0;var u;(o.getConvData().forEach((e=>{const t=e.convId,s=ve.a.getCache(t);c.count+=1,s&&(c.size+=s.filesSize+s.imagesSize+s.videosSize,d+=s.filesSize,h+=s.videosSize)})),r)&&this.logAction999({type:"Cache",scan_event:a,cache:{cache:r.Cache,file_thumb:r.fileThumb,file:r.file,video:r.video,picture:r.picture,file_noise:r.fileNoise,rich_thumb:r.richThumb,known_by_db:c,total_disk:r.ZaloDownloads,voice:r.voice,zinstant:r.zinstant,file_on_db:d,video_on_db:h},ts:this.getTimeNow(),free:null!==(u=null==l?void 0:l.free)&&void 0!==u?u:-1});this.LogHistory.Cache.pending=!1},this.timeGoToSMReport=e=>{if(!this.canReport())return;const t=this.timeGoToSM,s=e?me.StartNewScanWithCache:me.StartNewScanWithoutCache;this.logAction999({type:"TimeGoToSM",ts:this.getTimeNow(),status:s,times_opened_SM_tool_in_this_session:t}),this.timeGoToSM++},this.timeFinishedScanReport=({scanEvent:e,timeToComplete:t})=>{const s=this.secureLocalStorage.checkExist(Ie.c)?Te.YES:Te.NO;this.logAction999({type:"TimeFinishedScan",ts:this.getTimeNow(),time_to_complete_db_scan:t,scan_event:e,opening_tool_when_db_scan_complete:s})},this.dispose=()=>{clearInterval(this.autoReportTimer),clearInterval(this.autoDiskStatusReportTimer)},this.logAction999=e=>{const{type:t}=e;Object(he.a)(e,Se);let s;switch(t){case"DiskStatus":s=pe.DiskStatus,this.LogHistory.DiskStatus.ts=performance.now();break;case"ZaloUsage":s=pe.ZaloUsage,this.LogHistory.ZaloUsage.ts=performance.now();break;case"DeleteConv":s=pe.DeleteConv;break;case"Cache":s=pe.Cache,this.LogHistory.Cache.ts=performance.now();break;case"TimeGoToSM":s=pe.TimeGoToSM;break;case"TimeFinishedScan":s=pe.TimeFinishedScan}const i=Object(T.a)(Object(T.a)({},e),{},{device_id:fe.default.getDeviceID()});return"TimeGoToSM"!==t&&"TimeFinishedScan"!==t||delete i.type,fe.default.logActionInfoV2(fe.FeaturesInfo.ResourceManagementV2,s,i),Promise.resolve()},this._canActionLog=e=>performance.now()-e>U.default.full_disk_check.report_interval,this._canActionLogDiskStatus=e=>performance.now()-e>U.default.full_disk_check.disk_status_report_interval,this.secureLocalStorage=n.default.getInstance(),this.startAutoReport()}onApplicationReady(){this.startDiskStatusReport(),this.startDiskStatusAutoReport()}startDiskStatusAutoReport(){const e=this.secureLocalStorage.getItem(Oe);e&&this.getTimeNow()-+e>=U.default.full_disk_check.disk_status_report_interval&&this.startDiskStatusReport(),this.autoDiskStatusReportTimer=setInterval(this.diskStatusReport,U.default.full_disk_check.disk_status_report_interval)}startDiskStatusReport(){this.diskStatusReport(),this.secureLocalStorage.setItem(Oe,`${this.getTimeNow()}`)}})||Ce)||Ce)||Ce;i.ModuleContainer.registerSingleton(de.a,Me);const Re=Object(i.define)("resmgmt-conv-filter-manager"),we=Object(i.define)("resmgmt-convdata-manager");var Le=s("EFQ6"),Fe=s("Gm1y"),De=s("AH6j");Event;class Ae extends Event{constructor(e,t){super(e),this.payload=void 0,this.payload=t}}class Ne extends Event{constructor(e,t){super(e),this.payload=void 0,this.payload=t}}class ke extends Event{constructor(e,t){super(e),this.payload=void 0,this.payload=t}}class Pe extends Event{constructor(e){super(e)}}Event;Event;let je=function(e){return e.Update_Convdata_List="Update_Convdata_List",e.ResCalc_UI_Status_Change="ResCalc_UI_Status_Change",e.ResCalc_ZaRF_Status="ResCalc_ZaRF_Status",e.ResCalc_AppData_Status="ResCalc_AppData_Status",e.ResCalc_ProgramExe_Status="ResCalc_ProgramExe_Status",e.ResCalc_ZaloLocal_Status="ResCalc_ZaloLocal_Status",e.ResCalc_ConvData_Status="ResCalc_ConvData_Status",e.ResConv_FilterSort_Status_Change="ResConv_FilterSort_Status_Change",e.ResDisk_Status="ResDisk_Status",e.ResNoti_Dimiss="ResNoti_Dimiss",e.ResNoti_Open_Setttings="ResNoti_Open_Setttings",e.ResStats_Tree_Change="ResStats_Tree_Change",e.ResDisk_CurrentLevel="ResDisk_CurrentLevel",e.ResDisk_Full_Disk_Status="ResDisk_Full_Disk_Status",e}({});var Ue,Be=s("7NAg"),Ge=s("WQAo"),ze=s("yzMR");function xe(){}function Ve(...e){0}let He=Object(i.injectable)()(Ue=function(e,t){return i.ModuleContainer.inject(B.ZLoggerFactory)(e,void 0,0)}(Ue=Reflect.metadata("design:type",Function)(Ue=Reflect.metadata("design:paramtypes",[void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory])(Ue=class extends De.b{constructor(e){super(),this.resultCallback=void 0,this.onDataChange=void 0,this.stopped=void 0,this.taskIds=void 0,this.data=void 0,this.didDelete=void 0,this._totalConvs=0,this._taskCalcTs=0,this.Logger=void 0,this._hasNewAutoDownload=0,this.hasNewAutoDownload=()=>{this.updateCurrentAutoDownload(this.getCurrentAutoDownload()+1)},this.getCurrentAutoDownload=()=>this._hasNewAutoDownload,this.updateCurrentAutoDownload=e=>{this._hasNewAutoDownload=e},this.startCalculating=async(e=!1)=>{Ve(),this._resetProgress();try{const t=this._hasNewAutoDownload>0||e?await this.getConvs():await this._getOutdatedConvs(),s=this.getCurrentAutoDownload();if(0===t.length&&s<=0)return!1;this._broadcastEvent(je.ResCalc_ConvData_Status,{status:Be.h.CALCULATING,type:"convDataStatus",progress:0}),this._totalConvs=t.length;for(let e=0;e<t.length;e++){if(this.stopped)return!0;await this.createTask(t[e])}return this._broadcastEvent(je.ResCalc_ConvData_Status,{status:Be.h.IDLE,type:"convDataStatus",progress:100}),this.updateCurrentAutoDownload(this.getCurrentAutoDownload()-s),this._taskCalcTs=Date.now(),!0}catch(t){return!1}},this._broadcastEvent=(e,t)=>{if(e===je.ResCalc_ConvData_Status)this.dispatchEvent(new Ae(je.ResCalc_ConvData_Status,t))},this.resultCallback=xe,this.onDataChange=xe,this.stopped=!0,this.taskIds=[],this.data=[],this.didDelete=new Map,this.Logger=e.createZLogger("resmgmt",["conv-datasource"])}status(){return this.stopped?Be.h.IDLE:Be.h.CALCULATING}getConvData(){return this.data}async start(e,t){this.stopped=!1,this.onDataChange=t,this.resultCallback=e=>{Ve(),this.stopped||(this.data=this.data.filter((t=>t.convId!==e.convId)),this.data.push(e),this._broadcastEvent(je.ResCalc_ConvData_Status,{status:Be.h.CALCULATING,type:"convDataStatus",progress:this._getPercentage(this.data.length)}),this.onDataChange(this.data))};let s=await this.getCache();this.data=s,this.onDataChange(this.data);return await this.startCalculating(e)}cancel(){Ve(),this.resultCallback=xe,this.stopped=!0,ve.a.cancel(this.taskIds),this._broadcastEvent(je.ResCalc_ConvData_Status,{status:Be.h.IDLE,type:"convDataStatus",progress:1})}async onDelete(e,t){for(let s=0;s<this.data.length;s++){const i=this.data[s];let a=i.amount.filesSize,n=i.amount.imagesSize,r=i.amount.videosSize;e.indexOf(i.convId)>-1&&(t.file&&(a=0),t.photo&&(n=0),t.video&&(r=0),this.data[s]=Object(T.a)(Object(T.a)({},i),{},{amount:{filesSize:a,imagesSize:n,videosSize:r}}),0===a&&0===n&&0===r&&this.didDelete.set(i.convId,!0))}await ve.a.cleanConvResource(e,t),this.onDataChange(this.data)}async preload(){return Ve(),this.stopped=!1,await this.startCalculating()}_resetProgress(){this._totalConvs=0}_getPercentage(e){return 0===this._totalConvs?0:Math.round(e/this._totalConvs*100)}async getCache(){let e=[],t=await this.getConvs();for(let s=0;s<t.length;s++){let i=t[s];if(i&&i.convId&&!this.didDelete.get(i.convId)){let t=ve.a.getCache(i.convId);t&&e.push(Object(T.a)(Object(T.a)({},i),{},{amount:t}))}}return e}async _getOutdatedConvs(){let e=await this.getConvs();this.Logger.zsymb(3,"N-hPgi",["total convs: {}","VFCvZh"],e.length);const t=i.ModuleContainer.resolve(Ge.b);return this._taskCalcTs>0&&(e=e.filter((e=>{const s=t.getLastOpenConv(e.convId);return s&&s>=this._taskCalcTs&&!this.didDelete.get(e.convId)}))),this.Logger.zsymb(3,"E9sNYZ",["outdated convs: {}","oFeYKD"],e.length),e}createTask(e){return Ve(e.convId),new Promise(((t,s)=>{try{const{convId:s}=e;let i=s=>{let i=Object(T.a)(Object(T.a)({},e),{},{amount:s});return this.resultCallback(i),t(i)},a=ve.a.calculateConvData(s,i);this.taskIds.push(a)}catch(i){return t(null)}}))}validateCalculateResult(e){return!(!e||e.videosSize+e.imagesSize+e.filesSize<1)}async getConvs(){try{const t=await Q.a.ConvInfoDataManager.getAllConv(),s=i.ModuleContainer.resolve(ze.i);let a=[];if(!t||!t.length)return a;for(let i=0;i<t.length;i++){var e;let n=t[i];if(!n||!n.userId||Le.a.isThreadHidden(n.userId))continue;let r="",o="",c=n.userId;const l=parseInt((null===(e=await s.getPreviewById(c))||void 0===e?void 0:e.messageTime)||"0");c.startsWith(W.GROUPID_PREFIX)?(r=Fe.default.getDName(c),o=Fe.default.getAvatarGroup(c)):(r=Z.default.getDName(c),o=Z.default.getAvatar(c)),r&&a.push(Object(T.a)(Object(T.a)({},n),{},{convId:c,displayName:r,userId:n.userId,avatar:o,lastMsgTime:l}))}return a}catch(t){return[]}}})||Ue)||Ue)||Ue)||Ue;var qe;let We=Object(i.injectable)()(qe=function(e,t){return i.ModuleContainer.inject(B.ZLoggerFactory)(e,void 0,0)}(qe=Reflect.metadata("design:type",Function)(qe=Reflect.metadata("design:paramtypes",[void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory])(qe=class extends De.b{constructor(e){super(),this._logger=void 0,this._filterBy=void 0,this._sortBy=void 0,this._logger=e.createZLogger("resmgmt",["ResConvFilterManager"]),this._filterBy=Be.f.ALL,this._sortBy=Be.g.DECREASE_CAPACITY}getCurrentFilter(){return this._filterBy}getCurrentSort(){return this._sortBy}filter(e){this._filterBy=e,this._logger.zsymb(2,"VURtFi","filterBy",e),this.dispatchEvent(new Ne(je.ResConv_FilterSort_Status_Change,{type:"filterBy",value:e}))}resetDefault(){this._filterBy=Be.f.ALL,this._sortBy=Be.g.DECREASE_CAPACITY,this._logger.zsymb(2,"nxibuw","resetDefault"),this.dispatchEvent(new Ne(je.ResConv_FilterSort_Status_Change,{type:"filterBy",value:Be.f.ALL,ignoreRender:!0})),this.dispatchEvent(new Ne(je.ResConv_FilterSort_Status_Change,{type:"sortBy",value:Be.g.DECREASE_CAPACITY,ignoreRender:!0}))}sort(e){this._sortBy=e,this._logger.zsymb(2,"3phP0r","sortBy",e),this.dispatchEvent(new Ne(je.ResConv_FilterSort_Status_Change,{type:"sortBy",value:e}))}})||qe)||qe)||qe)||qe;class Ze extends De.b{constructor(e,t){super(),this._calculationTracker={recalcRequests:1,lastTs:0},this.logger=void 0,this._recordCalcHistory=e=>{this._calculationTracker=e?Object(T.a)(Object(T.a)({},this._calculationTracker),e):{recalcRequests:0,lastTs:Date.now()}},this.logger=t.createZLogger("resmgmt",[e])}checkForceCalculate(e=!1){return e||this._calculationTracker.recalcRequests>0}}var Ke;let Qe=Object(i.injectable)()(Ke=function(e,t){return i.ModuleContainer.inject(B.ZLoggerFactory)(e,void 0,0)}(Ke=function(e,t){return i.ModuleContainer.inject(m.a)(e,void 0,1)}(Ke=function(e,t){return i.ModuleContainer.inject(be.a)(e,void 0,2)}(Ke=Reflect.metadata("design:type",Function)(Ke=Reflect.metadata("design:paramtypes",[void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory,void 0===m.a?Object:m.a,void 0===be.a?Object:be.a])(Ke=class extends Ze{constructor(e,t,s){super("ResConvDataManager",e),this.application=t,this.convDataSource=s,this.cancel=()=>{this.convDataSource.cancel(),this._recordCalcHistory({recalcRequests:1,lastTs:0})},this.calculateConvDataSize=e=>e.reduce(((e,t)=>{const s=t.amount||null;let i=0;for(let a in s)i+=s[a]||0;return e+i}),0),this._listenEvents=()=>{this.convDataSource.addEventListener(je.ResCalc_ConvData_Status,this._handleCalculationStatus),this.application.addEventListener(m.b.Exit,this.onApplicationExit)},this.onApplicationExit=()=>{this.cancel(),this._cleanupListeners()},this._cleanupListeners=()=>{this.convDataSource.removeEventListener(je.ResCalc_ConvData_Status,this._handleCalculationStatus),this.application.removeEventListener(m.b.Exit,this.onApplicationExit)},this._handleCalculationStatus=e=>{this.dispatchEvent(new Ae(je.ResCalc_UI_Status_Change,e.payload))},this._listenEvents()}start(e=!1,t){return this.checkForceCalculate(e)?(this.logger.zsymb(5,"7vktYw",["calculating: force:{} {}","KkstTJ"],this.checkForceCalculate(e),this._calculationTracker),new Promise(((s,i)=>{this.convDataSource.start(e,t).then((e=>{s(e),this._recordCalcHistory()})).catch((e=>{i(e)}))}))):(t&&t(this.convDataSource.getConvData()),Promise.resolve(!0))}isOA(e){return Z.default.isOA(e)}isMyCloud(e){return e===U.default.sendToMeId}isGroup(e){return String(e).startsWith(W.GROUPID_PREFIX)}isOtherInOtherGroup(e){return this.isMyCloud(e)||this.isOA(e)}getConvs(){return this.convDataSource.getConvData().filter((e=>this.validateCalculateResult(e.amount)))}async onDelete(e,t){return this.convDataSource.onDelete(e,t)}status(){return this.convDataSource.status()}validateCalculateResult(e){return this.convDataSource.validateCalculateResult(e)}calculateConvDataSizeByIds(e,t){return this.convDataSource.getConvData().filter((t=>e.includes(t.convId))).reduce(((e,s)=>e+(null!=t&&t.video&&s.amount.videosSize?s.amount.videosSize:null!=t&&t.file&&s.amount.filesSize?s.amount.filesSize:null!=t&&t.photo&&s.amount.imagesSize?s.amount.imagesSize:0)),0)}})||Ke)||Ke)||Ke)||Ke)||Ke)||Ke;i.ModuleContainer.registerSingleton(be.a,He),i.ModuleContainer.registerSingleton(we,Qe),i.ModuleContainer.registerSingleton(Re,We);const $e=Object(i.define)("resmgmt-zarf-datasource");var Ye;let Je=Object(i.injectable)()(Ye=function(e,t){return i.ModuleContainer.inject(B.ZLoggerFactory)(e,void 0,0)}(Ye=function(e,t){return i.ModuleContainer.inject(m.a)(e,void 0,1)}(Ye=function(e,t){return i.ModuleContainer.inject($e)(e,void 0,2)}(Ye=Reflect.metadata("design:type",Function)(Ye=Reflect.metadata("design:paramtypes",[void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory,void 0===m.a?Object:m.a,void 0===$e?Object:$e])(Ye=class extends Ze{constructor(e,t,s){super("ResZaRFDataManager",e),this.application=t,this.zarfDataSource=s,this._cleanupEvents=()=>{this.application.removeEventListener(m.b.Exit,this._cleanupEvents),this.removeEventListener(je.ResCalc_ZaRF_Status,this._handleCalcStatusChange)},this._handleCalcStatusChange=e=>{this._broadcastEvent(e.type,e.payload)},this._listenEvents=()=>{this.application.addEventListener(m.b.Exit,this._cleanupEvents),this.zarfDataSource.addEventListener(je.ResCalc_ZaRF_Status,this._handleCalcStatusChange)},this._cleanupEvents=this._cleanupEvents.bind(this),this._listenEvents()}start(e,t){return this.checkForceCalculate(e)?(this.logger.zsymb(5,"8-Szrt",["calculating: force:{} {}","KkstTJ"],this.checkForceCalculate(e),this._calculationTracker),new Promise(((e,s)=>{this.zarfDataSource.start(t).then((t=>{e(t),this._recordCalcHistory()})).catch((e=>{s(e)}))}))):(t&&t(this.zarfDataSource.getSize()),Promise.resolve(!0))}cancel(){this.zarfDataSource.cancel(),this._broadcastEvent(je.ResCalc_ConvData_Status,{status:Be.h.IDLE,type:"convDataStatus"})}_broadcastEvent(e,t){if(e===je.ResCalc_ZaRF_Status)this.dispatchEvent(new Ae(je.ResCalc_UI_Status_Change,t))}})||Ye)||Ye)||Ye)||Ye)||Ye)||Ye;var Xe;function et(){}let tt=Object(i.injectable)()(Xe=function(e,t){return i.ModuleContainer.inject(m.a)(e,void 0,0)}(Xe=Reflect.metadata("design:type",Function)(Xe=Reflect.metadata("design:paramtypes",[void 0===m.a?Object:m.a])(Xe=class extends De.b{constructor(e){super(),this.application=e,this.resultCallback=void 0,this.onDataChange=void 0,this._Tasks=[],this._size=0,this._broadcastEvent=(e,t)=>{if(e===je.ResCalc_ZaRF_Status)this.dispatchEvent(new Ae(je.ResCalc_ZaRF_Status,t))},this._cleanupEvents=()=>{this.application.removeEventListener(m.b.Exit,this._cleanupEvents)},this._listenEvents=()=>{this.application.addEventListener(m.b.Exit,this._cleanupEvents)},this.resultCallback=et,this.onDataChange=et,this._cleanupEvents=this._cleanupEvents.bind(this),this._listenEvents()}async start(e){var t;return this.onDataChange=t=>{this._size=t,e&&e(t)},this.resultCallback=e=>{this._size=e,this.onDataChange(e),this._broadcastEvent(je.ResCalc_ZaRF_Status,{status:Be.h.IDLE,type:"zaRFStatus"})},this._broadcastEvent(je.ResCalc_ZaRF_Status,{status:Be.h.CALCULATING,type:"zaRFStatus"}),null===(t=this._Tasks)||void 0===t||t.push(ve.a.getZaloReceivedFilesAmt(this.resultCallback,this.onDataChange)),!0}cancel(){this._cleanupEvents(),this.resultCallback=et,this.onDataChange=et,this._Tasks.length&&(ve.a.cancel(this._Tasks),this._Tasks.splice(0,this._Tasks.length)),this._broadcastEvent(je.ResCalc_ZaRF_Status,{status:Be.h.IDLE,type:"zaRFStatus"})}getSize(){return this._size}})||Xe)||Xe)||Xe)||Xe;const st=Object(i.define)("resmgmt-zarf-datamanager");i.ModuleContainer.registerSingleton($e,tt),i.ModuleContainer.registerSingleton(st,Je);const it=Object(i.define)("resmgmt-unlisted-datasource");var at;let nt=Object(i.injectable)()(at=function(e,t){return i.ModuleContainer.inject(B.ZLoggerFactory)(e,void 0,0)}(at=function(e,t){return i.ModuleContainer.inject(m.a)(e,void 0,1)}(at=function(e,t){return i.ModuleContainer.inject(it)(e,void 0,2)}(at=Reflect.metadata("design:type",Function)(at=Reflect.metadata("design:paramtypes",[void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory,void 0===m.a?Object:m.a,void 0===it?Object:it])(at=class extends Ze{constructor(e,t,s){super("ResUnlistedDataManager",e),this.application=t,this.resUnlistedDataSource=s,this._cleanupEvents=()=>{this.application.removeEventListener(m.b.Exit,this._cleanupEvents),this.resUnlistedDataSource.removeEventListener(je.ResCalc_ProgramExe_Status,this._handleCalcStatusChange),this.resUnlistedDataSource.removeEventListener(je.ResCalc_ZaloLocal_Status,this._handleCalcStatusChange),this.resUnlistedDataSource.removeEventListener(je.ResCalc_AppData_Status,this._handleCalcStatusChange)},this._handleCalcStatusChange=e=>{this._broadcastEvent(e.type,e.payload)},this._listenEvents=()=>{this.application.addEventListener(m.b.Exit,this._cleanupEvents),this.resUnlistedDataSource.addEventListener(je.ResCalc_ProgramExe_Status,this._handleCalcStatusChange),this.resUnlistedDataSource.addEventListener(je.ResCalc_ZaloLocal_Status,this._handleCalcStatusChange),this.resUnlistedDataSource.addEventListener(je.ResCalc_AppData_Status,this._handleCalcStatusChange)},this._cleanupEvents=this._cleanupEvents.bind(this),this._listenEvents()}onDeleteConvs(e){return this.resUnlistedDataSource.onDeleteConvs(e)}async calculateZaloAppData(e=!1,t,s){return this.checkForceCalculate(e)&&this.resUnlistedDataSource.calculateZaloAppData(e,t,s),!0}async calculateZaloAppDataLog(e=!1,t,s){return this.checkForceCalculate(e)&&this.resUnlistedDataSource.calculateZaloAppDataLog(e,t,s),!0}async calculateZaloLocal(e=!1,t,s){return this.checkForceCalculate(e)&&this.resUnlistedDataSource.calculateZaloLocal(e,t,s),!0}async calculateProgramExe(e=!1,t,s){return this.checkForceCalculate(e)&&this.resUnlistedDataSource.calculateProgramExe(e,t,s),!0}cancel(){this.resUnlistedDataSource.cancel(),this._broadcastEvent(je.ResCalc_UI_Status_Change,{status:Be.h.IDLE,type:"zaloLocalStatus"}),this._broadcastEvent(je.ResCalc_UI_Status_Change,{status:Be.h.IDLE,type:"appDataStatus"}),this._broadcastEvent(je.ResCalc_UI_Status_Change,{status:Be.h.IDLE,type:"programExeStatus"})}_broadcastEvent(e,t){switch(e){case je.ResCalc_ZaloLocal_Status:case je.ResCalc_ProgramExe_Status:case je.ResCalc_AppData_Status:this.dispatchEvent(new Ae(je.ResCalc_UI_Status_Change,t))}}})||at)||at)||at)||at)||at)||at;var rt,ot=s("zbf3");function ct(){}let lt=Object(i.injectable)()(rt=function(e,t){return i.ModuleContainer.inject(m.a)(e,void 0,0)}(rt=Reflect.metadata("design:type",Function)(rt=Reflect.metadata("design:paramtypes",[void 0===m.a?Object:m.a])(rt=class extends De.b{constructor(e){super(),this.application=e,this._Tasks=[],this._size=0,this._groupStatus=Be.h.IDLE,this._ProgramExe={calculated:!1,size:0,resCb:ct,changeCb:ct},this._ZaloAppData={calculated:!1,size:0,resCb:ct,changeCb:ct},this._ZaloLocal={calculated:!1,size:0,resCb:ct,changeCb:ct},this._broadcastEvent=(e,t)=>{switch(e){case je.ResCalc_ProgramExe_Status:case je.ResCalc_AppData_Status:case je.ResCalc_ZaloLocal_Status:this.dispatchEvent(new Ae(e,t))}},this._cleanupEvents=()=>{this.application.removeEventListener(m.b.Exit,this._cleanupEvents)},this._listenEvents=()=>{this.application.addEventListener(m.b.Exit,this._cleanupEvents)},this._cleanupEvents=this._cleanupEvents.bind(this),this._listenEvents()}cancel(){this._cleanupEvents(),this._Tasks.length&&(ve.a.cancel(this._Tasks),this._Tasks.splice(0,this._Tasks.length)),this._ZaloAppData.changeCb=ct,this._ZaloAppData.resCb=ct,this._ProgramExe.changeCb=ct,this._ProgramExe.resCb=ct,this._ZaloLocal.changeCb=ct,this._ZaloLocal.resCb=ct,this._broadcastEvent(je.ResCalc_ZaRF_Status,{status:Be.h.IDLE,type:"zaRFStatus"})}getSize(){return this._ZaloAppData.size+this._ProgramExe.size+this._ZaloLocal.size}getProgramExeSize(){return this._ProgramExe.size}getZaloAppDataSize(){return this._ZaloAppData.size}getZaloLocalSize(){return this._ZaloLocal.size}onDeleteConvs(e){return this._ZaloLocal.size-=e,this._ZaloLocal.changeCb&&this._ZaloLocal.changeCb(this._ZaloLocal.size),Promise.resolve()}calculateProgramExe(e,t,s){var i;if(this._ProgramExe.calculated&&!e)return void(t?t(this._ProgramExe.size):s&&s(this._ProgramExe.size));const a=e=>{this._ProgramExe.size=e,t&&t(e)},n=e=>{this._ProgramExe.size=e,this._broadcastEvent(je.ResCalc_ProgramExe_Status,{status:Be.h.IDLE,type:"programExeStatus"}),this._ProgramExe.calculated=!0,t&&t(e)};this._ProgramExe.resCb=n,this._ProgramExe.changeCb=a,this._broadcastEvent(je.ResCalc_ProgramExe_Status,{status:Be.h.CALCULATING,type:"programExeStatus"}),null===(i=this._Tasks)||void 0===i||i.push(ve.a.getZaloProgramAmt(n,a))}calculateZaloAppData(e,t,s){var i;if(this._ZaloAppData.calculated&&!e)return void(t?t(this._ZaloAppData.size):s&&s(this._ZaloAppData.size));const a=e=>{this._ZaloAppData.size=e,t&&t(e)},n=e=>{this._ZaloAppData.size=e,this._broadcastEvent(je.ResCalc_AppData_Status,{status:Be.h.IDLE,type:"appDataStatus"}),this._ZaloAppData.calculated=!0,t&&t(e)};this._ZaloAppData.resCb=n,this._ZaloAppData.changeCb=a,this._broadcastEvent(je.ResCalc_AppData_Status,{status:Be.h.CALCULATING,type:"appDataStatus"}),null===(i=this._Tasks)||void 0===i||i.push(ve.a.getZaloDBAmount(n,a))}calculateZaloAppDataLog(e,t,s){if(this._ZaloAppData.calculated&&!e)return void(t?t(this._ZaloAppData.size):s&&s(this._ZaloAppData.size));const i=e=>{this._ZaloAppData.size=e,this._broadcastEvent(je.ResCalc_AppData_Status,{status:Be.h.IDLE,type:"appDataStatus"}),this._ZaloAppData.calculated=!0,t&&t(e)};this._ZaloAppData.resCb=i,this._ZaloAppData.changeCb=e=>{this._ZaloAppData.size=e,t&&t(e)},this._broadcastEvent(je.ResCalc_AppData_Status,{status:Be.h.CALCULATING,type:"appDataStatus"});let a=Object(re.getZaloAppDirSync)();(async()=>{const e=await ot.b.execRaw("getDirSizeNoCaching",[a]);i(e)})()}calculateZaloLocal(e,t,s){var i;if(this._ZaloLocal.calculated&&!e)return void(t?t(this._ZaloLocal.size):s&&s(this._ZaloLocal.size));const a=e=>{this._ZaloLocal.size=e,t&&t(e)},n=e=>{this._ZaloLocal.size=e,this._broadcastEvent(je.ResCalc_ZaloLocal_Status,{status:Be.h.IDLE,type:"zaloLocalStatus"}),this._ZaloLocal.calculated=!0,t&&t(e)};this._ZaloLocal.resCb=n,this._ZaloLocal.changeCb=a,this._broadcastEvent(je.ResCalc_ZaloLocal_Status,{status:Be.h.CALCULATING,type:"zaloLocalStatus"}),null===(i=this._Tasks)||void 0===i||i.push(ve.a.getZaloDataAmount(n,a))}})||rt)||rt)||rt)||rt;const dt=Object(i.define)("resmgmt-unlisted-datamanager");i.ModuleContainer.registerSingleton(it,lt),i.ModuleContainer.registerSingleton(dt,nt);var ht=s("q1tI"),ut=s.n(ht),gt=s("B8k8"),mt=s("lCMA"),pt=s("v/qp"),ft=s("h0sc"),vt=s("DOOx"),_t=s("XS0u"),bt=s("kibv"),yt=s("3xbP"),It=s("7aVi"),St=s("pPa6");function Ct(e){const{value:t,expect:s,defaultValue:i,check:a}=e;return a?a(t)?t:i:typeof t===s?t:i}class Et{static get lowCapacityDevice(){if(null===this.lowCapacityStatus){const{total:e}=ve.a.analyzeMainDisk()||{};"number"==typeof e&&e<1073741824*U.default.full_disk_check.threadhold?this.lowCapacityStatus=!0:this.lowCapacityStatus=!1}return this.lowCapacityStatus}}Et.lowCapacityStatus=null,Et.localThreshold=null,Et.getServerConfigThreshold=()=>{const e=U.default.full_disk_check,t=St.a.full_disk_check;let s;return s=Et.lowCapacityDevice?{dismiss_low:Ct({value:e.low_capacity.dismiss_low,expect:"number",defaultValue:t.low_capacity.dismiss_low}),dismiss_high:Ct({value:e.low_capacity.dismiss_high,expect:"number",defaultValue:t.low_capacity.dismiss_high}),dismiss_low_two:Ct({value:e.low_capacity.dismiss_low_two,expect:"number",defaultValue:t.low_capacity.dismiss_low_two}),show_noti:Ct({value:e.low_capacity.show_noti,expect:"number",defaultValue:t.low_capacity.show_noti})}:{dismiss_low:Ct({value:e.high_capacity.dismiss_low,expect:"number",defaultValue:t.high_capacity.dismiss_low}),dismiss_high:Ct({value:e.high_capacity.dismiss_high,expect:"number",defaultValue:t.high_capacity.dismiss_high}),dismiss_low_two:Ct({value:e.high_capacity.dismiss_low_two,expect:"number",defaultValue:t.high_capacity.dismiss_low_two}),show_noti:Ct({value:e.high_capacity.show_noti,expect:"number",defaultValue:t.high_capacity.show_noti})},{firstAlmostFullThreshold:s.dismiss_high,secondAlmostFullThreshold:s.dismiss_low,fullThreshold:s.dismiss_low_two,showNoti:s.show_noti}},Et.getOverrideCapacityStatus=()=>{const e=U.default.full_disk_check,t=St.a.full_disk_check;let s;var i,a,n,r,o,c,l,d;Et.lowCapacityDevice?s={dismiss_high:Ct({value:(null===(i=Et.localThreshold)||void 0===i?void 0:i.firstAlmostFullThreshold)||e.low_capacity.dismiss_high,expect:"number",defaultValue:t.low_capacity.dismiss_high}),dismiss_low:Ct({value:(null===(a=Et.localThreshold)||void 0===a?void 0:a.secondAlmostFullThreshold)||e.low_capacity.dismiss_low,expect:"number",defaultValue:t.low_capacity.dismiss_low}),dismiss_low_two:Ct({value:(null===(n=Et.localThreshold)||void 0===n?void 0:n.fullThreshold)||e.low_capacity.dismiss_low_two,expect:"number",defaultValue:t.low_capacity.dismiss_low_two}),show_noti:Ct({value:(null===(r=Et.localThreshold)||void 0===r?void 0:r.showNoti)||e.low_capacity.show_noti,expect:"number",defaultValue:t.low_capacity.show_noti})}:s={dismiss_high:Ct({value:(null===(o=Et.localThreshold)||void 0===o?void 0:o.firstAlmostFullThreshold)||e.high_capacity.dismiss_high,expect:"number",defaultValue:t.high_capacity.dismiss_high}),dismiss_low:Ct({value:(null===(c=Et.localThreshold)||void 0===c?void 0:c.secondAlmostFullThreshold)||e.high_capacity.dismiss_low,expect:"number",defaultValue:t.high_capacity.dismiss_low}),dismiss_low_two:Ct({value:(null===(l=Et.localThreshold)||void 0===l?void 0:l.fullThreshold)||e.high_capacity.dismiss_low_two,expect:"number",defaultValue:t.high_capacity.dismiss_low_two}),show_noti:Ct({value:(null===(d=Et.localThreshold)||void 0===d?void 0:d.showNoti)||e.high_capacity.show_noti,expect:"number",defaultValue:t.high_capacity.show_noti})};return s},Et.updateLocalConfigThreshold=e=>{if(!Et.localThreshold)return;const t=Et.getServerConfigThreshold(),s=Object(T.a)(Object(T.a)({},t),{},{partialConfig:e});Et.localThreshold=s},Et.updateServerConfig=e=>{"object"==typeof e&&(U.default.full_disk_check=Object(T.a)(Object(T.a)({},U.default.full_disk_check||{}),e))};var Ot,Tt=s("7TIh");const{RICH_SPACE:Mt,ALMOST_FULL_1:Rt,ALMOST_FULL_2:wt,FULL:Lt}=Be.d,Ft=1073741824,Dt=[Rt,Lt],At=[wt,Lt];Object(i.injectable)()(Ot=Object(m.j)()(Ot=Object(ie.b)(It.a)(Ot=function(e,t){return i.ModuleContainer.inject(m.a)(e,void 0,0)}(Ot=Reflect.metadata("design:type",Function)(Ot=Reflect.metadata("design:paramtypes",[void 0===m.a?Object:m.a])(Ot=class extends De.b{constructor(e){super(),this.application=e,this._displayingNotiModal=void 0,this._displayingNotiBanner=void 0,this.didLog_2230101=void 0,this._Logger=void 0,this._total=0,this.openSetttings=e=>{const t=this._getLastNoti();if(e===Be.e.POPUP_MODAL||e===Be.e.FULL_DISK_BANNER){let s=D.default.getTimeNow();e===Be.e.FULL_DISK_BANNER&&null!=t&&t.ts&&(s=t.ts),_t.default.setFullDiskNoti(Object(T.a)(Object(T.a)({},t),{},{dismiss:!0,ts:s}))}this._closeNotiType("modal");const s={data:{tab:Tt.h.RES_MANAGEMENT}};ft.ModalManagerV2.openModal({windowId:yt.c,name:W.ModalIdentitiesDefine.SETTINGS,params:s,forceCloseAll:!0})},this.dismissNoti=e=>{if(!e)return this._closeNotiType("all");this._closeNotiType(e===Be.e.POPUP_MODAL?"modal":"banner",!0)},this._osEventHandler=e=>{if(e)switch(e.type){case vt.b.OUT_OF_MEM:{this._broadcastEvent(je.ResDisk_Status,{level:Lt});const e=this._getLastNoti(),t=this._getLastBannerNoti();this._handleDiskStatusModal(Lt,e),this._handleDiskStatusBanner(Lt,t);break}case vt.b.OPEN_SUCCESS:{const e=this._getLastNoti(),t=this._getLastBannerNoti();this._handleDiskStatusModal(Mt,e),this._handleDiskStatusBanner(Mt,t);break}}},this._handleDiskStatus=e=>{if(!U.default.full_disk_check.enable)return;const{total:t,free:s}=e,i=this._getFullStatus(t,s);i===Lt&&this._broadcastEvent(je.ResDisk_Full_Disk_Status,{level:i}),i===Mt||U.default.full_disk_check.enable&&U.default.full_disk_check.showWarning||this.didLog_2230101||(this.Logger.zsymb(3,"BMBH2Z",["Noti modal: noti={} | enable={} | showWarning={}","ZkJG7o"],i,U.default.full_disk_check.enable,U.default.full_disk_check.showWarning),this.didLog_2230101=!0,fe.default.logAction(2230101)),this._broadcastEvent(je.ResDisk_CurrentLevel,{level:i});const a=this._getLastNoti(),n=this._getLastBannerNoti();this._handleDiskStatusModal(i,a),this._handleDiskStatusBanner(i,n),bt.a.start()},this._handleDiskStatusModal=(e,t)=>{var s,i,a,n;if(!U.default.full_disk_check.enable||e===Rt&&0==(null===(s=U.default.full_disk_check)||void 0===s||null===(i=s.level_control)||void 0===i?void 0:i.af1)||e===Lt&&!1===(null===(a=U.default.full_disk_check)||void 0===a||null===(n=a.level_control)||void 0===n?void 0:n.full_modal))return;this._displayingNotiModal&&(!Dt.includes(e)||t&&t.level!==e)&&(this.Logger.zsymb(3,"xal4ef",["Noti modal closed lastNoti={} prep for currentNoti={}","rZ647P"],t,e),this._closeNotiType("modal"));const r=D.default.getTimeNow(),o=this._getLastNoti();if(!Dt.includes(e))return void(Be.c[e]<Be.c[t.level]&&(o.level=e===Mt?Rt:e,o.ts=r,_t.default.setFullDiskNoti(o)));const c=D.default.getTimeNow()-t.ts;if(this.Logger.zsymb(3,"ruVVDg",["fdn elapsed: {} | lastNoti={} | newNoti={}","K5mpRv"],c,t.level,e),!1===this._displayingNotiModal&&e===Lt)return t.dismiss&&c<=U.default.full_disk_check.modal_noti_gap&&t.level===Lt?void this.Logger.zsymb(3,"Antg8R",["Noti modal full dismissed and less than 7d seconds","WpmByZ"]):(this.Logger.zsymb(3,"DOU7QB",["Noti modal full (always show)","zt2l1Y"]),void this._triggerDiskStatus(e,"modal",!1));if(t&&t.level===e){if(this._displayingNotiModal||!this._displayingNotiModal&&t.dismiss&&Math.abs(r-t.ts)<U.default.full_disk_check.modal_noti_gap)return void(this._displayingNotiModal?this.Logger.zsymb(3,"gj1n_s",["Noti modal dismissed as type unchanged. already ON","mmmVB2"]):this.Logger.zsymb(3,"C_rIto",["Noti modal dismissed as type unchanged. applying 7d-rule={}","b0vt2k"],!0));this.Logger.zsymb(3,"wh6KGU",["Noti modal passed. 7d-rule reset. dismiss reset","fFJpIv"])}else if(t&&t.level&&e&&Be.c[e]<Be.c[t.level]){if(o.dismiss&&Math.abs(r-t.ts)<U.default.full_disk_check.type_change_noti_gap)return this.Logger.zsymb(3,"My1Xuk",["Noti modal dismissed: downgrading emergency => 1d-rule={}","hZOUiz"],!0),o.level=e===Mt?Rt:e,o.ts=r,void _t.default.setFullDiskNoti(o);this.Logger.zsymb(3,"qQZ6br",["Noti modal: downgrading emergency => 1d-rule expired","BWRMmR"])}this._triggerDiskStatus(e,"modal",!0)},this._handleDiskStatusBanner=(e,t)=>{var s,i;if(!U.default.full_disk_check.enable||e===Lt&&!1===(null===(s=U.default.full_disk_check)||void 0===s||null===(i=s.level_control)||void 0===i?void 0:i.full_banner)||e===wt&&!1===U.default.full_disk_check.level_control.af2)return;this._displayingNotiBanner&&(!At.includes(e)||t&&t.level!==e)&&(this.Logger.zsymb(3,"oQVRts",["Noti banner closed lastNoti={} prep for currentNoti={}","zh7Tfi"],t,e),this._closeNotiType("banner"));const a=D.default.getTimeNow(),n=this._getLastBannerNoti();if(At.includes(e)){if(!1===this._displayingNotiBanner&&e==Lt)return this.Logger.zsymb(3,"P1hjPW",["Noti banner full (always)","Y6ynrF"]),void this._triggerDiskStatus(e,"banner");if(t&&t.level===e){if(this._displayingNotiBanner||!this._displayingNotiBanner&&t.dismiss&&Math.abs(a-t.ts)<U.default.full_disk_check.banner_noti_gap)return void(this._displayingNotiBanner?this.Logger.zsymb(3,"ZBXdO7",["Noti banner dismissed as level unchanged. already ON","o-f4mt"]):this.Logger.zsymb(3,"x0vTki",["Noti banner dismissed as level unchanged. applying 1d-rule={}","hJTF0h"],!0));this.Logger.zsymb(3,"qWroxZ",["Noti banner passed. 1d-rule reset. dismiss reset","mF1INv"])}if(t&&t.level&&e&&t.dismiss&&Be.c[e]<Be.c[t.level]){if(n.dismiss&&Math.abs(a-t.ts)<U.default.full_disk_check.type_change_noti_gap)return this.Logger.zsymb(3,"okCU5B",["Noti banner dismissed as downgrading emergency. applying 1d-rule={}","cUaGgb"],!0),n.ts=a,n.level=e,void _t.default.setFullDiskChatBannerNoti(n);if(this._displayingNotiBanner)return void this.Logger.zsymb(3,"9x61ax",["Noti banner: downgrading emergency. 1d-rule expired but already ON","LVASjl"]);this.Logger.zsymb(3,"4Jdtwr",["Noti banner: downgrading emergency. 1d-rule expired. showing soon","RaX1I1"])}this._triggerDiskStatus(e,"banner",!0)}else Be.c[e]<Be.c[t.level]&&(n.level=e,n.ts=a,_t.default.setFullDiskChatBannerNoti(n))},this._dismissModal=()=>{this._closeNotiType("modal",!0)},this._listenEvents=()=>{this.application.addEventListener(m.b.Exit,this._cleanupEvents)},this._cleanupEvents=()=>{this.application.removeEventListener(m.b.Exit,this._cleanupEvents)},this._displayingNotiModal=!1,this._displayingNotiBanner=!1,this.didLog_2230101=!1,this.Logger.zsymb(5,"XFjeH4",["DiskStatusManager init","SYjrrJ"]),this._cleanupEvents=this._cleanupEvents.bind(this)}get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger("disk-status",["status-manager"])),this._Logger}onStart(e){ye.p.listenEvent(ye.d,this._handleDiskStatus),ye.p.listenEvent(ye.o,this._osEventHandler),this._listenEvents(),i.ModuleContainer.resolve(de.a).startDiskStatusAutoReport(),i.ModuleContainer.resolve(de.a).startAutoReport()}_getFullStatus(e,t){let s=Mt;if(e<U.default.full_disk_check.threadhold*Ft){const i=Et.getOverrideCapacityStatus(),a=t/e,n=a>.001?Math.round(100*a)/100:a;s=this._pickNormalizedStatus(n,i.dismiss_high,i.dismiss_low,i.dismiss_low_two)}else{const e=Et.getOverrideCapacityStatus(),i=t/Ft,a=i>1?Math.round(10*i)/10*Ft:t;s=this._pickNormalizedStatus(a,e.dismiss_high*Ft,e.dismiss_low*Ft,(e.dismiss_low_two||1)*Ft)}return s}_showNotiType(e,t,s){if("modal"===e){this._displayingNotiModal&&this._closeNotiType("modal"),this._displayingNotiModal=!0;const i=this._getLastNoti();_t.default.setFullDiskNoti(Object(T.a)(Object(T.a)({},i),{},{dismiss:!(s||!i.dismiss)&&i.dismiss,level:t,ts:D.default.getTimeNow()}));const a=()=>{t===Rt?fe.default.logAction(2230707):t===Lt&&fe.default.logAction(2230712),this.openSetttings(Be.e.POPUP_MODAL)},n=()=>{t===Rt?fe.default.logAction(2230704):t===Lt&&fe.default.logAction(2230711),this._dismissModal()};let r;switch(t){case Mt:return void gt.b.closeByKey("full-disk-noti-modal");case Rt:fe.default.logAction(2230102),r="STR_RESMGMT_MODAL_ALMOST_FULL";break;case wt:return void gt.b.closeByKey("full-disk-noti-modal");case Lt:fe.default.logAction(2230710),r="STR_RESMGMT_MODAL_FULL"}this.Logger.zsymb(5,"D4I3fN",["Noti {} triggered","wLlh26"],e,{level:Be.d[t],type:e},new Error);const o={type:W.MINI_NOTIFICATION_TYPE.SUCCESS,duration:-1,key:"full-disk-noti-modal",html:ut.a.createElement("div",{className:"flx flx-col"},ut.a.createElement("div",{className:"flx flx-1 disk-waring-content"},ut.a.createElement("div",{className:"fa fa-warning-24 disk-waring-icon"}),ut.a.createElement("span",null,ut.a.createElement(mt.a,{textKey:r})," "),ut.a.createElement("span",null)),ut.a.createElement("div",{className:"flx flx-1 flx-e"},ut.a.createElement(pt.a,{type:"neutral",onClick:n,size:"medium",style:{marginRight:"8px"}},ut.a.createElement(mt.a,{textKey:"STR_FILE_INTRO_POP_BTN_SKIP"})),ut.a.createElement(pt.a,{type:"primary",onClick:a,size:"medium"},ut.a.createElement(mt.a,{textKey:"STR_MANAGE"}))))};gt.b.show(o)}else if("banner"===e&&(t===wt||t===Lt)){this.Logger.zsymb(5,"WQHDpB",["Noti {} triggered","wLlh26"],e,{level:Be.d[t],type:e},new Error),this._broadcastEvent(je.ResDisk_Status,{level:t}),this._displayingNotiBanner=!0;const i=this._getLastBannerNoti();i.dismiss=!(s||!i.dismiss)&&i.dismiss,i.level=t,i.ts=D.default.getTimeNow(),_t.default.setFullDiskChatBannerNoti(i)}}_pickNormalizedStatus(e,t,s,i){return e>t?Mt:e>=s?Rt:e>=i?wt:Lt}_getLastNoti(){return _t.default.getFullDiskNoti()||{}}_closeNotiType(e="all",t=!1){if(this.Logger.zsymb(5,"APfbgS",["Noti {} closed","o6VYNq"],e),"all"!==e&&"modal"!==e||!this._displayingNotiModal){if(("banner"===e||"all"===e)&&this._displayingNotiBanner){const e=this._getLastBannerNoti();this._displayingNotiBanner&&_t.default.setFullDiskChatBannerNoti(Object(T.a)(Object(T.a)({},e),{},{dismiss:e.dismiss||t,ts:D.default.getTimeNow()})),this._displayingNotiBanner=!1,this._broadcastEvent(je.ResNoti_Dimiss)}}else{const e=this._getLastNoti(),s=D.default.getTimeNow();this.Logger.zsymb(5,"MLXahy",["fdn close modal at: {}","jo9s61"],new Date(s).toString()),this._displayingNotiModal&&_t.default.setFullDiskNoti(Object(T.a)(Object(T.a)({},e),{},{dismiss:e.dismiss||t,ts:s})),gt.b.closeByKey("full-disk-noti-modal"),this._displayingNotiModal=!1}bt.a.pause()}_getLastBannerNoti(){return _t.default.getFullDiskChatBannerNoti()||{}}_triggerDiskStatus(e=Lt,t="none",s=!1){if("none"!==t)if("banner"===t)this._showNotiType("banner",e,s);else if("modal"===t)switch(e){case Mt:this._closeNotiType("modal"),this._closeNotiType("banner");break;case Lt:fe.default.logActionInfo(fe.FeaturesInfo.ResourceManagement,2,[this._total,0]),this._showNotiType("modal",e,s),this._showNotiType("banner",e,s);break;case Rt:this._showNotiType("modal",e,s)}}_broadcastEvent(e,t){switch(e){case je.ResDisk_Status:this.dispatchEvent(new ke(e,t));break;case je.ResNoti_Dimiss:this.dispatchEvent(new Pe(e));break;case je.ResDisk_CurrentLevel:case je.ResDisk_Full_Disk_Status:this.dispatchEvent(new ke(e,t))}}})||Ot)||Ot)||Ot)||Ot)||Ot);var Nt=s("rBV8"),kt=s("rfrl");class Pt{constructor(e,t,s=!0){this.useDefaultList=s,this.type=void 0,this.name=void 0,this.key=void 0,this.data=void 0,this.name=e,this.key=t,this.data=this.getInitialData()}init(){}getInitialData(){return new Map}updateItem(e,t,s=!1){const i=Object(kt.a)(this.data.get(t)||{},e);this.data.set(t,i),s||(Object(Nt.f)(this.name,t),this.useDefaultList&&Object(Nt.g)(this.name,""))}removeItem(e,t=!1){this.data.delete(e),t||(Object(Nt.c)(this.name,e),Object(Nt.g)(this.name,""))}getItem(e,t){const s=e.key;return this.data.get(s)}getList(e,t){return this.getDefaultList()}onGetItemFailure(e,t){}onGetListFailure(e,t){}getDefaultItem(){return{value:null}}getDefaultList(){return this.useDefaultList?Array.from(this.data.keys()):[]}}var jt,Ut=s("MGLS");Object(m.f)()(jt=Object(ie.b)(Ut.b)(jt=function(e,t){return i.ModuleContainer.inject(B.ZLoggerFactory)(e,void 0,0)}(jt=function(e,t){return i.ModuleContainer.inject(m.a)(e,void 0,1)}(jt=Reflect.metadata("design:type",Function)(jt=Reflect.metadata("design:paramtypes",[void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory,void 0===m.a?Object:m.a])(jt=class extends Pt{constructor(e,t){super(Ut.a,"noti"),this.loggerFactory=e,this.application=t,this.logger=void 0,this.dismissReddot=()=>{const e=n.default.getInstance();this.shouldShowReddot()&&setTimeout((()=>{this.updateItem((e=>{e.dismissReddot=!0}),"dismissReddot"),e.setItemForCurrentUser(Ie.b,JSON.stringify({dismiss:!0}))}),500)},this.shouldShowReddot=()=>{var e;const t=null===(e=this.data.get("showOverviewWarningIcon"))||void 0===e?void 0:e.showOverviewWarningIcon;if(!(t&&t!==Be.d.RICH_SPACE))return!1;const s=n.default.getInstance().getItemForCurrentUser(Ie.b);if(!s)return!0;try{const e=JSON.parse(s);return!e||!e.dismiss}catch(i){return!0}},this.getWarningStatus=()=>{var e;return null===(e=this.data.get("showOverviewWarningIcon"))||void 0===e?void 0:e.showOverviewWarningIcon},this.checkShowReddot=()=>{this.Logger.zsymb(5,"LeInnN",["init","6AjwBe"]);this.shouldShowReddot()?this.updateItem((e=>{e.dismissReddot=!1}),"dismissReddot"):this.updateItem((e=>{e.dismissReddot=!0}),"dismissReddot")},this._cleanupEvents=()=>{"render"===__ZaBUNDLENAME__&&(this.application.removeEventListener(m.b.Exit,this._cleanupEvents),Q.a.DiskStatusManager.removeEventListener(je.ResDisk_Status,this._onDiskStatusChanged),Q.a.DiskStatusManager.removeEventListener(je.ResNoti_Dimiss,this._onNotiDismiss))},this._listenEvents=()=>{"render"===__ZaBUNDLENAME__&&(this.application.addEventListener(m.b.Exit,this._cleanupEvents),Q.a.DiskStatusManager.addEventListener(je.ResDisk_Status,this._onDiskStatusChanged),Q.a.DiskStatusManager.addEventListener(je.ResNoti_Dimiss,this._onNotiDismiss),Q.a.DiskStatusManager.addEventListener(je.ResDisk_CurrentLevel,this._onCurrentLevelChanged))},this._onCurrentLevelChanged=e=>{var t;(null==e||null===(t=e.payload)||void 0===t?void 0:t.level)!==Be.d.RICH_SPACE?this.updateItem((t=>{var s;t.showOverviewWarningIcon=null==e||null===(s=e.payload)||void 0===s?void 0:s.level}),"showOverviewWarningIcon"):this.updateItem((e=>{e.showOverviewWarningIcon=Be.d.RICH_SPACE}),"showOverviewWarningIcon"),this.checkShowReddot()},this._onNotiDismiss=()=>{this.updateItem((e=>{e.showFullDiskBanner={show:!1}}),"showFullDiskBanner")},this._onDiskStatusChanged=e=>{this.updateItem((t=>{const s=e.payload,i=(null==s?void 0:s.level)===Be.d.ALMOST_FULL_2||(null==s?void 0:s.level)===Be.d.FULL;t.showFullDiskBanner={show:i,level:null==s?void 0:s.level}}),"showFullDiskBanner")},this.logger=this.loggerFactory.createZLogger("resmgmt",[Ut.a]),this._cleanupEvents=this._cleanupEvents.bind(this)}get Logger(){return this.logger||(this.logger=this.loggerFactory.createZLogger("resmgmt",[Ut.a])),this.logger}onAuthenticated(e){this._listenEvents(),this.checkShowReddot()}dismissNoti(e){this.logger.zsymb(5,"r4OT6T",["Noti {} closed","o6VYNq"],e),Q.a.DiskStatusManager.dismissNoti(e),bt.a.pause()}openSettings(e){Q.a.DiskStatusManager.openSetttings(e)}})||jt)||jt)||jt)||jt)||jt);var Bt,Gt=s("FB77"),zt=s("OlUt");const xt=$znode.os;Object(i.injectable)()(Bt=Object(ie.b)(_e.b)(Bt=function(e,t){return i.ModuleContainer.inject(B.ZLoggerFactory)(e,void 0,0)}(Bt=function(e,t){return i.ModuleContainer.inject(we)(e,void 0,1)}(Bt=function(e,t){return i.ModuleContainer.inject(st)(e,void 0,2)}(Bt=function(e,t){return i.ModuleContainer.inject(dt)(e,void 0,3)}(Bt=function(e,t){return i.ModuleContainer.inject(Re)(e,void 0,4)}(Bt=Reflect.metadata("design:type",Function)(Bt=Reflect.metadata("design:paramtypes",[void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory,void 0===we?Object:we,void 0===st?Object:st,void 0===dt?Object:dt,void 0===Re?Object:Re])(Bt=class extends Pt{constructor(e,t,s,i,a){super(_e.a,"view"),this.loggerFactory=e,this._resConvDataManager=t,this._resZaRFDataManager=s,this._resUnlistedDataManager=i,this._resConvFilterManager=a,this.logger=void 0,this._listeningEvents=!1,this._isMounted=!1,this._aborted=!1,this._intervalOn=!1,this._calculating=!1,this._calculatingLog=!1,this._calcHistory=[],this._calculateInterval=Ie.a,this._onCalcDone=[],this.updateZaRFSize=e=>{this.updateItem((t=>{t.zaRFSize=e}),"zaRFSize",!this._isMounted)},this.getZaloUsage=()=>this.deferredPromise((()=>{var e,t,s,i,a;const n=(null===(e=this.data.get("zaRFSize"))||void 0===e?void 0:e.zaRFSize)||0,r=(null===(t=this.data.get("zaloLocalSize"))||void 0===t?void 0:t.zaloLocalSize)||0,o=(null===(s=this.data.get("appDataSize"))||void 0===s?void 0:s.appDataSize)||0,c=(null===(i=this.data.get("programExeSize"))||void 0===i?void 0:i.programExeSize)||0;return{total:n+r+o+c,zarf:n,appDataSize:o,otherDataSize:r-((null===(a=this.data.get("convDataSize"))||void 0===a?void 0:a.convDataSize)||0)+o+c}})),this.getZaloUsageForLog=()=>new Promise(((e,t)=>{this._resUnlistedDataManager.calculateZaloAppDataLog(!0,(t=>{const s=t;this._resUnlistedDataManager.calculateZaloLocal(!0,(t=>{var i,a,n;const r=t,o=(null===(i=this.data.get("zaRFSize"))||void 0===i?void 0:i.zaRFSize)||0,c=(null===(a=this.data.get("programExeSize"))||void 0===a?void 0:a.programExeSize)||0,l=o+r+s+c,d=(null===(n=this.data.get("convDataSize"))||void 0===n?void 0:n.convDataSize)||0;return e({total:l,zarf:o,appDataSize:s,otherDataSize:r-d+s+c})}))}),void 0)})),this.deferredPromise=e=>{const t={};t.promise=new Promise(((s,i)=>{t.resolve=()=>{s(e())},t.reject=i}));const s=this._calcHistory.length&&this._calcHistory[this._calcHistory.length-1],i=setTimeout((()=>{this._calculating||this.calculate(Be.a.ROUTINE)}),2e4);return!s||s.status!==Be.b.COMPLETED&&(null==s?void 0:s.status)!==Be.b.ABORTED?this._onCalcDone.push(t.resolve):(t.resolve(),clearTimeout(i)),t.promise},this.getConvData=()=>this.deferredPromise((()=>{var e;return(null===(e=this.data.get("convData"))||void 0===e?void 0:e.convData)||0})),this.updateConvs=e=>{const t=e.filter((e=>this._resConvDataManager.validateCalculateResult(null==e?void 0:e.amount)));this.updateItem((e=>{e.convs=t}),"convs"),this._filterRelative(this._resConvFilterManager.getCurrentFilter()),this._sortRelative(this._resConvFilterManager.getCurrentSort()),this.updateItem((e=>{e.convDataSize=this._resConvDataManager.calculateConvDataSize(t)}),"convDataSize",!this._isMounted)},this._updateZaloLocalSize=e=>{this.updateItem((t=>{t.zaloLocalSize=e}),"zaloLocalSize",!this._isMounted)},this._updateAppDataSize=e=>{this.updateItem((t=>{t.appDataSize=e}),"appDataSize",!this._isMounted)},this._updateProgramExeSize=e=>{this.updateItem((t=>{t.programExeSize=e}),"programExeSize",!this._isMounted)},this._handleSortFilterEventChange=e=>{switch(e.type){case je.ResConv_FilterSort_Status_Change:{const t=e.payload;this.updateItem((e=>{e[t.type]=t.value}),t.type,t.ignoreRender||!1),"filterBy"===t.type&&this._filterRelative(t.value),this._sortRelative(t.value);break}}},this._handleCalculationStatus=e=>{const t=e.payload;this.updateItem((e=>{var s;e[t.type]={status:t.status,progress:t.progress,hasCache:!0===(null===(s=e[t.type])||void 0===s?void 0:s.hasCache)||t.status===Be.h.IDLE}}),t.type,!this._isMounted)},this.logger=this.loggerFactory.createZLogger("resmgmt",["Controller"]),this.init()}setSelectedConvs(e){this.updateItem((t=>{t.selectedConvs=e}),"selectedConvs")}hasCache(){return this._calcHistory.length>0&&this._calcHistory[this._calcHistory.length-1].status!==Be.b.CALCULATING}startCalcInterval(){this._intervalOn=!0}resetCalcInterval(){this._intervalOn=!1}setCalculateInterval(e){this._calculateInterval=e,this.updateItem((t=>{t.calculateInterval=e}),"calculateInterval")}getLastCalcTs(){return this._calcHistory.length>0?this._calcHistory[this._calcHistory.length-1].end:0}getCalcHistory(){return this._calcHistory.length>0?this._calcHistory:null}getCalculateInterval(){return this._calculateInterval}async calculate(e,t=!1){var s;this._isMounted=!0,this._listeningEvents||this._listenEvents(),this._calculating=!0;const a=i.ModuleContainer.resolve(de.a),n=ve.a.analyzeMainDisk(),r=(null===(s=this.data.get("convDataSize"))||void 0===s?void 0:s.convDataSize)||0,o=a.getTimeNow();e===Be.a.RESMGMT_TAB_MOUNTED&&(n&&a.diskStatusReport({scan_event:a.getScanType().UserManual,ts:a.getTimeNow(),total:n.total,free:n.free}),a.timeGoToSMReport(r));try{await this._startAllCalculators(e,t)}catch(l){this.logger.zsymb(21,"Lpu5M0",["Error estimating resources","5A38AV"],l)}if(this._onCalcDone.forEach((e=>function(e,t){try{e()}catch(s){"function"==typeof t&&t(s)}}(e))),this._onCalcDone.splice(0,this._onCalcDone.length),this._calculating=!1,!(e!==Be.a.RESMGMT_TAB_MOUNTED&&e!==Be.a.ROUTINE||this._calculatingLog||this._calculating)){var c;this._calculatingLog=!0;const t=i.ModuleContainer.resolve(de.a),s=e===Be.a.RESMGMT_TAB_MOUNTED?t.getScanType().UserManual:t.getScanType().Routine;await this.scanZtempZaloTemp();const a=await this.getZaloUsage();t.zaloUsageReport({scan_event:s,ts:t.getTimeNow(),used:a.total,free:null!==(c=null==n?void 0:n.free)&&void 0!==c?c:-1}),t.cacheReport({scan_event:s});const l=t.getTimeNow()-o;t.timeFinishedScanReport({convDataSize:r,scanEvent:s,timeToComplete:l}),this._calculatingLog=!1}}async scanZtempZaloTemp(){try{await ve.a.scanZtempZaloTemp()}catch(e){this.logger.zsymb(21,"hHtEMM",["Error estimating resources","5A38AV"],e)}}init(){this.updateItem((e=>{e.view=Gt.a.OVERVIEW,e.theme=zt.a.default}),"view",!0),this.updateItem((e=>{e.sortBy=Be.g.DECREASE_CAPACITY}),"sortBy",!0),this.updateItem((e=>{e.filterBy=Be.f.ALL}),"filterBy",!0),this.updateItem((e=>{e.currentDisk="C:"}),"currentDisk",!0),this.updateItem((e=>{e.calculateInterval=this._calculateInterval}),"calculateInterval",!0),this.updateItem((e=>{e.selectedConvs={}}),"selectedConvs",!0),this._listenEvents()}resetStates(){this.updateItem((e=>{e.view=Gt.a.OVERVIEW}),"view",!0)}resetAll(){this.resetCalcInterval();i.ModuleContainer.resolve(Re).resetDefault(),this.updateItem((e=>{e.selectedConvs={}}),"selectedConvs")}updateView(e){this.updateItem((t=>{t.view=e}),"view")}abort(){this._isMounted=!1,this._cancelAllCalculations(),this._cleanupListeners()}sort(e){switch(e){case Be.g.DECREASE_CAPACITY:fe.default.logAction(2230601);break;case Be.g.INCREASE_CAPACITY:fe.default.logAction(2230603);break;case Be.g.INCREASE_LAST_UPDATE:fe.default.logAction(2230605);break;case Be.g.DECREASE_LAST_UPDATE:fe.default.logAction(2230607)}this._resConvFilterManager.getCurrentSort()!==e&&this._resConvFilterManager.sort(e)}filter(e){switch(e){case Be.f.ALL:fe.default.logAction(2230801);break;case Be.f.FILTER_GROUP_CONVS:fe.default.logAction(2230802);break;case Be.f.FILTER_SINGLE_CHAT_CONVS:fe.default.logAction(2230803);break;case Be.f.FILTER_OTHER_CONVS:fe.default.logAction(2230804)}this._resConvFilterManager.getCurrentFilter()!==e&&this._resConvFilterManager.filter(e)}isCurrentSort(e){var t;return(null===(t=this.data.get("sortBy"))||void 0===t?void 0:t.sortBy)===e}isCurrentFiler(e){var t;return(null===(t=this.data.get("filterBy"))||void 0===t?void 0:t.filterBy)===e}changeTheme(e){return Promise.resolve()}openZaRF(){Object(ve.d)()}async onDelete(e,t={photo:!0,video:!0,file:!0},s){var a;switch(this._resConvFilterManager.getCurrentFilter()){case Be.f.FILTER_GROUP_CONVS:fe.default.logAction(2230805);break;case Be.f.FILTER_GROUP_CONVS:fe.default.logAction(2230806);break;case Be.f.FILTER_SINGLE_CHAT_CONVS:fe.default.logAction(2230807);break;case Be.f.FILTER_OTHER_CONVS:fe.default.logAction(2230808)}let n=null!=s?s:0;s||(n=this._resConvDataManager.calculateConvDataSizeByIds(e,t));const r=ve.a.analyzeMainDisk(),o=i.ModuleContainer.resolve(de.a);await o.logAction999({type:"DeleteConv",deleted_count:e.length,deleted_size:n,target:Object(T.a)({},t),free:null!==(a=null==r?void 0:r.free)&&void 0!==a?a:-1}),await this._resUnlistedDataManager.onDeleteConvs(n),await this._resConvDataManager.onDelete(e,t)}abortTasks(){this._aborted=!0,this.logger.zsymb(0,"h-q4Zl","abort calc tasks"),Q.a.ResCacheManager.revokeCache()}_startAllCalculators(e,t=!1){const s=this._calcHistory.length&&this._calcHistory[this._calcHistory.length-1];return Object(ve.c)()?!this._canRequestCalculateRes(e)||s&&s.status===Be.b.CALCULATING?(this.logger.zsymb(3,"75TSLu",["recalculateResource is called too frequently. now:{} last:{}","K9nNXQ"],Date.now(),this.getLastCalcTs()),Promise.resolve(!0)):this._systemUsageInfo().then((e=>e.cpu>=U.default.full_disk_check.high_cpu||U.default.full_disk_check.high_mem?(this.logger.zsymb(3,"YiBLRA",["CPU or MEM usage is too high. No calculation will be postponed","HwNsZP"]),Promise.resolve()):Promise.resolve())).then((()=>{let e=!0;this._aborted=!1;const t={start:Date.now(),end:-1,status:Be.b.CALCULATING};this._calcHistory.push(t);const s=[this._resConvDataManager.start(e,this.updateConvs),this._resZaRFDataManager.start(e,this.updateZaRFSize),this._resUnlistedDataManager.calculateZaloAppData(e,this._updateAppDataSize),this._resUnlistedDataManager.calculateProgramExe(e,this._updateProgramExeSize)];return Promise.all(s).then((()=>this._resUnlistedDataManager.calculateZaloLocal(e,this._updateZaloLocalSize))).finally((()=>{this._aborted?(Q.a.ResCacheManager.revokeCache(),t.status=Be.b.ABORTED):(t.status=Be.b.COMPLETED,Q.a.ResCacheManager.signCache()),t.end=Date.now()}))})):(this.logger.zsymb(3,"rfH7Lg",["Full disk check is disabled. No calculation will be performed","L5PHxK"]),Promise.resolve(!0))}async _sortRelative(e){var t;let s=(null===(t=this.data.get("convs"))||void 0===t?void 0:t.convs)||this._resConvDataManager.getConvs();switch(e){case Be.g.DECREASE_CAPACITY:case Be.g.INCREASE_CAPACITY:s=s.slice().sort(((t,s)=>{let i=s.amount.videosSize+s.amount.imagesSize+s.amount.filesSize-t.amount.videosSize-t.amount.imagesSize-t.amount.filesSize;return e===Be.g.DECREASE_CAPACITY?i:-i}));break;case Be.g.INCREASE_LAST_UPDATE:case Be.g.DECREASE_LAST_UPDATE:s=s.slice().sort(((t,s)=>{const i=s.lastMsgTime-t.lastMsgTime;return e===Be.g.DECREASE_LAST_UPDATE?i:-i}))}this.updateItem((e=>{e.convs=s}),"convs")}_filterRelative(e){let t=this._resConvDataManager.getConvs()||[];switch(e){case Be.f.ALL:t=this._resConvDataManager.getConvs();break;case Be.f.FILTER_SINGLE_CHAT_CONVS:t=t.filter((e=>!this._resConvDataManager.isGroup(e.userId)&&!this._resConvDataManager.isOA(e.userId)||this._resConvDataManager.isMyCloud(e.userId)));break;case Be.f.FILTER_GROUP_CONVS:t=t.filter((e=>this._resConvDataManager.isGroup(e.userId)&&!this._resConvDataManager.isOA(e.userId)&&!this._resConvDataManager.isMyCloud(e.userId)));break;case Be.f.FILTER_OTHER_CONVS:t=t.filter((e=>this._resConvDataManager.isOA(e.userId)&&!this._resConvDataManager.isMyCloud(e.userId)))}this.updateItem((e=>{e.convs=t}),"convs",!0),this._sortRelative(this._resConvFilterManager.getCurrentSort())}_cancelAllCalculations(){this._resConvDataManager.cancel(),this._resZaRFDataManager.cancel(),this._resUnlistedDataManager.cancel()}_listenEvents(){this._listeningEvents=!0,this._resConvDataManager.addEventListener(je.ResCalc_UI_Status_Change,this._handleCalculationStatus),this._resZaRFDataManager.addEventListener(je.ResCalc_UI_Status_Change,this._handleCalculationStatus),this._resUnlistedDataManager.addEventListener(je.ResCalc_UI_Status_Change,this._handleCalculationStatus),this._resConvFilterManager.addEventListener(je.ResConv_FilterSort_Status_Change,this._handleSortFilterEventChange)}_cleanupListeners(){this._listeningEvents=!1,this._resConvDataManager.removeEventListener(je.ResCalc_UI_Status_Change,this._handleCalculationStatus),this._resZaRFDataManager.removeEventListener(je.ResCalc_UI_Status_Change,this._handleCalculationStatus),this._resUnlistedDataManager.removeEventListener(je.ResCalc_UI_Status_Change,this._handleCalculationStatus),this._resConvFilterManager.removeEventListener(je.ResConv_FilterSort_Status_Change,this._handleSortFilterEventChange)}_canRequestCalculateRes(e){if([Be.a.ACTIVE_EVENT].includes(e))return!1;if(!this._intervalOn)return this._intervalOn=!0,this._intervalOn;const t=Date.now(),s=t-this.getLastCalcTs()>=this._calculateInterval;return s&&Q.a.ResCacheManager.revokeCache(),this.logger.zsymb(5,"c9cwQO",["Checking expire: ","9V77K5"],s,t-this.getLastCalcTs(),this._calculateInterval,this._calcHistory),s}_getCPU(){var e=xt.cpus(),t=0,s=0,i=0,a=0,n=0;for(var r in e)e.hasOwnProperty(r)&&(t+=e[r].times.user,s+=e[r].times.nice,i+=e[r].times.sys,n+=e[r].times.irq,a+=e[r].times.idle);return{idle:a,total:t+s+i+a+n}}getCPUUsage(e,t=!1){const s=this._getCPU(),i=s.idle,a=s.total;setTimeout((()=>{const s=this._getCPU(),n=s.idle,r=s.total,o=(n-i)/(r-a);e(!0===t?o:1-o)}),1e3)}async _systemUsageInfo(){return new Promise(((e,t)=>{const s=xt.totalmem(),i=xt.freemem(),a=s-i;this.getCPUUsage((t=>{e({cpu:t,memory:a/s})}))}))}})||Bt)||Bt)||Bt)||Bt)||Bt)||Bt)||Bt)||Bt);s("KszJ"),s("Hbak");var Vt=s("SZ0g");i.ModuleContainer.registerValue(Vt.a,new class{constructor(){this._emitter=void 0,this._emitter=k.a.instance}emit(e){return this._emitter.emit(e.topic,e),Promise.resolve()}on(e,t){return this._emitter.on(e,t),this}off(e,t){return this._emitter.off(e,t),this}});var Ht,qt=s("hLuk");Object(m.j)()(Ht=class{onStart(){qt.default.init()}});var Wt=s("MPLC"),Zt=s("xdZB"),Kt=s("4wTQ");const Qt=Object(i.define)("message-controller");var $t,Yt=s("wH4e"),Jt=s("hWjG"),Xt=s("mE25"),es=s("mlG1"),ts=s("P6UB");let ss=Object(i.singleton)()($t=function(e,t){return Object(i.inject)(B.ZLoggerFactory)(e,void 0,0)}($t=Reflect.metadata("design:type",Function)($t=Reflect.metadata("design:paramtypes",[void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory])($t=class extends Jt.a{constructor(e){super("Core","Message","",e)}countMessages(e,t={from:[],to:[Xt.b,Xt.a]}){return this._dbCollection.count({from:[e,...t.from],to:[e,...t.to]},{index:"userId_sendDttm_msgId",partition:e})}async getLastMessage(e){var t;let s=null;const i={from:[e,"",""],to:[e,Xt.b,Xt.a],excludeFrom:!0,excludeTo:!0},a={index:"userId_sendDttm_msgId",direction:Yt.CursorDirection.PREV,limit:1,predicate:t=>{!s&&t&&(s=t);const i=es.d.reduceDeleteMsgs(e,[t],!0);return ts.b.isValidPreviewMessage(t)&&0!==i.length},partition:e},n=await this._dbCollection.getAll(i,a);return null!==(t=null==n?void 0:n[0])&&void 0!==t?t:s}async getPrevMessageIds(e,t,s){const i={from:[e,"",""],to:[e,(await this.get(t)).sendDttm,t],excludeFrom:!0,excludeTo:!0},a={index:"userId_sendDttm_msgId",direction:Yt.CursorDirection.PREV,limit:s,predicate:e=>!isNaN(Number(e.msgId)),partition:e};return(await this._dbCollection.getAll(i,a)).map((e=>e.msgId))}})||$t)||$t)||$t)||$t;const is=(e,t)=>{if(e)throw t};var as=s("Uzj0"),ns=s("S8fy"),rs=s("fBUP"),os=s("kCOK");class cs extends Error{constructor(e,t,s,i=[]){super(s),this.code=void 0,this.qosParams=void 0,this.name=e,this.qosParams=[s,...i],this.code=t}setStack(e){const t=`${this.name}: ${this.message}`;this.stack=t+(e||"")}toObject(){return{name:this.name,code:this.code,message:this.message,stack:this.stack,qosParams:this.qosParams}}static createFromObject(e){const{name:t="ZError Unknown",code:s=-1,message:i,stack:a,qosParams:n=[]}=e,r=new cs(t,s,i,n);return r.setStack(a),r}}let ls=function(e){return e[e.FETCH_ERROR=0]="FETCH_ERROR",e[e.FETCH_CONV_HAS_MSG_OFFLINE_ERROR=1]="FETCH_CONV_HAS_MSG_OFFLINE_ERROR",e[e.INVALID_RESPONSE=2]="INVALID_RESPONSE",e[e.INSERT_MULTI_ERROR=3]="INSERT_MULTI_ERROR",e}({});class ds extends cs{constructor(e,t,s,i){super("FetchMessageCloudError",ls.FETCH_ERROR,`ConvId: ${e}. RequestMsgId: ${t}. OriginError: ${JSON.stringify(s)}`,i)}}class hs extends cs{constructor(e,t){super("InvalidResponse",ls.INVALID_RESPONSE,e,t)}}class us extends cs{constructor(e,t){super("FetchConvHasMessageOfflineError",ls.FETCH_CONV_HAS_MSG_OFFLINE_ERROR,e,t)}}var gs,ms=s("mea/");let ps=Object(ns.h)()(gs=class{async fetchMessagesCloud(e,t,s,i,a){const n=ms.a.newReq(),[r,o]=await as.b.catchPromise(rs.default.getCM(e,Number(t),0,s,n,a,i));is(r,new ds(e,t,r));const[c,l]=await as.b.catchPromise(Object(os.a)(o));is(c,new hs(`ConvId: ${e}. RequestMsgId: ${t}. Cannot handle response: ${JSON.stringify(c)}`));const[d,h]=as.b.catchFn((()=>JSON.parse(l)));return is(d,new hs(`ConvId: ${e}. RequestMsgId: ${t}. Cannot parse json object`)),h}async fetchListConvHasMessageOffline(e,t,s){const[i,a]=await as.b.catchPromise(rs.default.getConvHasMessageOffline(e,t,s));is(i,new us(JSON.stringify(i)));const[n,r]=await as.b.catchPromise(Object(os.a)(a));return is(n,new hs(`Cannot handle response: ${JSON.stringify(n)}`)),r}})||gs;var fs,vs=s("/Bne");class _s{constructor(e,t){this.convId=e,this.messageCloudRaw=t,this.userId=void 0,this.idTo=void 0,this.uidFrom=void 0,this.uin=void 0,this.cliMsgId=void 0,this.msgId=void 0,this.content=void 0,this.dName=void 0,this.msgType=void 0,this.status=void 0,this.ts=void 0,this.isFromCloud=void 0,this.msgKey=void 0,this.isGroup=void 0,this.mentions=void 0,this.quote=void 0,this.st=void 0,this.at=void 0,this.ttl=void 0,this.src=void 0,this.cmd=void 0,this.footer=void 0,this.footerv2=void 0,this.previewThumb=void 0,this.property=void 0,this.propertyExt=void 0,this.specialMsgType=void 0,this.topOut=void 0,this.topOutImprTimeOut=void 0,this.topOutTimeOut=void 0,this.userId=t.userId,this.idTo=t.idTo,this.uidFrom=t.uidFrom,this.uin=t.uin,this.cliMsgId=t.cliMsgId,this.msgId=t.msgId,this.content=t.content,this.dName=t.dName,this.msgType=t.msgType,this.status=t.status,this.ts=t.ts,this.mentions=t.mentions,this.quote=t.quote,this.st=t.st,this.at=t.at,this.ttl=t.ttl,this.cmd=t.cmd,this.footer=t.footer,this.footerv2=t.footerv2,this.previewThumb=t.previewThumb,this.property=t.property,this.propertyExt=t.propertyExt,this.specialMsgType=t.specialMsgType,this.topOut=t.topOut,this.topOutImprTimeOut=t.topOutImprTimeOut,this.topOutTimeOut=t.topOutTimeOut,this.isFromCloud=!0,this.msgKey=e,this.isGroup=t.isGroup}toEntity(){return vs.a.transformMessageFromServer(this.messageCloudRaw,this.convId)}setSrc(e){this.src=e}}let bs=Object(ns.h)()(fs=Reflect.metadata("design:type",Function)(fs=Reflect.metadata("design:paramtypes",[])(fs=class{constructor(){this.apiAdapter=void 0,this.apiAdapter=i.ModuleContainer.resolveToken(ps)}async fetchMessagesCloud(e,t,s,i){var a;const[n,r]=await as.b.catchPromise(this.apiAdapter.fetchMessagesCloud(e,t,s,i));is(n,n);const o=(null!==(a=r.groupMsgs)&&void 0!==a?a:[]).map((t=>new _s(e,t)));return Object(T.a)(Object(T.a)({},r),{},{groupMsgs:o})}async fetchConvHasMessageOffline(e,t,s){return await this.apiAdapter.fetchListConvHasMessageOffline(e,t,s)}})||fs)||fs)||fs;var ys;Object(i.singleton)(Qt)(ys=Reflect.metadata("design:type",Function)(ys=Reflect.metadata("design:paramtypes",[])(ys=class{constructor(){this.messageRespository=void 0,this.messageService=void 0,this.messageRespository=i.ModuleContainer.resolveToken(ss),this.messageService=i.ModuleContainer.resolveToken(bs)}async fetchMessagesCloud(e,t,s,i){return await this.messageService.fetchMessagesCloud(e,t,s,i)}async getLastMessage(e){return await this.messageRespository.getLastMessage(e)}async getPrevMessageIds(e,t,s){return this.messageRespository.getPrevMessageIds(e,t,s)}async countMessages(e,t){return await this.messageRespository.countMessages(e,t)}async getGroupHasMessageOffline(e,t,s){const i=await this.messageService.fetchConvHasMessageOffline(e,t,s);return{listConvIds:i.grids.map((e=>W.GROUPID_PREFIX+e)),evict:!!i.evict}}reloadMessage(e){var t;null===(t=Wt.b.messageCache)||void 0===t||t.deleteConversation(e);Zt.a.getExistConvIds().includes(e)&&Kt.a.getLastMessagesForConversation(e,{})}})||ys)||ys);var Is=s("ZCU6"),Ss=s("h0S/");const Cs=Object(i.define)("cloud-segment-controller");var Es=s("npvr"),Os=s("t3h5");let Ts=function(e){return e[e.UPDATE_FAILED=0]="UPDATE_FAILED",e}({});class Ms extends cs{constructor(e,t){super("UpdateSegmentError",Ts.UPDATE_FAILED,e,t)}}var Rs;let ws=Object(i.singleton)()(Rs=class{async get(e){return Os.a.getSegmentByConvId(e)}async update(e,t){const[s]=await as.b.catchPromise(Es.b.updateSegmentDB(e,t));return is(s,new Ms(JSON.stringify(s))),Os.a.setSegmentCacheByConvId(e,t),t}})||Rs;var Ls;Object(i.injectable)()(Ls=Object(i.singleton)(Cs)(Ls=function(e,t){return Object(i.inject)(B.ZLoggerFactory)(e,void 0,0)}(Ls=Reflect.metadata("design:type",Function)(Ls=Reflect.metadata("design:paramtypes",[void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory])(Ls=class{constructor(e){this.logger=void 0,this.repository=void 0,this.repository=i.ModuleContainer.resolveToken(ws),this.logger=e.createZLogger(Ss.ZLoggerNametags.messageCloudSegment,[Ss.ZLoggerNametags.controller])}async get(e){return this.repository.get(e)}async update(e){return await this.repository.update(e.conversationId,e)}async updateSegment(e,t){const s=Is.a.addOrUpdateSegmentCache(e.conversationId,t.messages,e,{requestMsgId:t.requestMsgId,lastMsgId:t.lastMsgId,checkLoadTop:t.checkLoadTop,hasMore:t.hasMore}).segmentObj;return await this.repository.update(e.conversationId,s)}})||Ls)||Ls)||Ls)||Ls);var Fs,Ds=s("bV4z"),As=s("2kyb"),Ns=s("4b23"),ks=s("5NxC"),Ps=s("1gE3"),js=s("Jw4R"),Us=s("Xt6Q"),Bs=s("nWXR");Object(i.injectable)()(Fs=Object(i.singleton)(Ps.b)(Fs=function(e,t){return Object(i.inject)(m.a)(e,void 0,0)}(Fs=Reflect.metadata("design:type",Function)(Fs=Reflect.metadata("design:paramtypes",[void 0===m.a?Object:m.a])(Fs=class{get Logger(){return this._logger||(this._logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger(Ps.a,["clip-board-link-suggest"])),this._logger}constructor(e){this._lastFocusedWindowId=yt.c,this._linkSuggestData=null,this._currUrl="",this._showLinkSuggestTimes=0,this._showLinkSuggestTimeoutId=null,this._timeClipboardChanged=0,this._listeners=new Map,this._logger=void 0,this._appReadyTime=void 0,this.onFocusingWindowChange=this.onFocusingWindowChange.bind(this),this.onConvOnMainWindowChange=this.onConvOnMainWindowChange.bind(this),this.onNewLinkPreviewData=this.onNewLinkPreviewData.bind(this),e.addEventListenerOnce(m.b.ServicesReady,(()=>{this._appReadyTime=performance.now()})),ks.a.subscribe(P.LinkPreviewActions.NEW_LINK_PREVIEW,this.onNewLinkPreviewData)}onHaveUrlLinkFromClipboard(e){performance.now()-this.getTimeClipboardChanged()<=js.a.getTimeToGetClipboard()&&this._appReadyTime&&this.getTimeClipboardChanged()>this._appReadyTime&&Ds.isClipboardLinkSuggestEnabled()&&e&&e!==this.getCurrLinkUrl()&&Q.a.ParserConfig.get("enable_parse_link_client")&&this.pushLinkToCache(e)}isEnabledOnCurrentPlatform(){const e=Ds.getEnableOnPlatform().split(""),t=e[0],s=e[1];return Object(Us.l)()&&"1"==t||Object(Us.c)()&&"1"==s}setTimeClipboardChanged(e){this._checkIfEnabled()&&(this._timeClipboardChanged=e)}getTimeClipboardChanged(){return this._timeClipboardChanged}resetData(){var e;if(!this._checkIfEnabled())return;const t=null===(e=i.ModuleContainer.resolve(As.a))||void 0===e?void 0:e.getConvIdByWindowId(this._lastFocusedWindowId);this._hideShowLinkSuggest(this._lastFocusedWindowId,t),this._lastFocusedWindowId=yt.c,this._linkSuggestData=null,this._resetShowLinkTimes(),this.stopTimeout()}startTimeout(e=Ds.getTimeShowClipboardLinkSuggest()){this._checkIfEnabled()&&(this._showLinkSuggestTimeoutId||(this._showLinkSuggestTimeoutId=window.setTimeout((()=>{this.resetData()}),e)))}stopTimeout(){this._checkIfEnabled()&&this._showLinkSuggestTimeoutId&&(clearTimeout(this._showLinkSuggestTimeoutId),this._showLinkSuggestTimeoutId=null)}getCurrLinkUrl(){return this._checkIfEnabled()?this._currUrl:""}getLinkSuggestData(){return this._checkIfEnabled()?this._linkSuggestData:null}hasLinkSuggestData(){return!!this._checkIfEnabled()&&!!this._linkSuggestData}pushLinkToCache(e){this._checkIfEnabled()&&(e&&e!==this._currUrl&&this._resetShowLinkTimes(),this._setCurrLinkUrl(e),Bs.c.create(e).do("parse",[Bs.a.CLIPBOARD]).do("download-thumb").exec().toPromise().then((t=>{null!=t&&t.href&&(t.href=e||t.href,Ds.isClipboardLinkSuggestEnabled()&&this._setLinkSuggestData(t))})).catch((e=>{this.Logger.zsymb(21,"yqCAfU",["[pushLinkToCache] parse-link-control-error: {}","2A0agG"],e)})))}addListenerAtWindow(e,t){this._checkIfEnabled()&&this._listeners.set(e,t)}removeListenerAtWindow(e){this._checkIfEnabled()&&this._listeners.delete(e)}onFocusingWindowChange(e){var t,s;if(!this._checkIfEnabled())return;const a=this._lastFocusedWindowId;if(!e||a===e)return;const n=null===(t=i.ModuleContainer.resolve(As.a))||void 0===t?void 0:t.getConvIdByWindowId(a);this._hideShowLinkSuggest(a,n),this._lastFocusedWindowId=e;const r=null===(s=i.ModuleContainer.resolve(As.a))||void 0===s?void 0:s.getConvIdByWindowId(e);this._countShowLinkSuggest(e,r),this._showLinkSuggest(e,r)}onConvOnMainWindowChange(e=yt.c,t){this._checkIfEnabled()&&(this._countShowLinkSuggest(e,t),this._showLinkSuggest(e,t))}onNewLinkPreviewData(e){const{newLinkPreviewData:t}=e;this._linkSuggestData&&t&&this._linkSuggestData.data.href===t.link&&this.resetData()}_shouldResetData(){return this._showLinkSuggestTimes>=Ds.getLimitShowClipboardLinkSuggest()}_processCountShowLink(){if(this._shouldResetData())return this.resetData();this._increaseShowLinkTimes()}_increaseShowLinkTimes(e=1){this._showLinkSuggestTimes+=e}_resetShowLinkTimes(e=0){this._checkIfEnabled()&&(this._showLinkSuggestTimes=e)}_setCurrLinkUrl(e){this._currUrl=e}_setLinkSuggestData(e){var t;this._linkSuggestData={id:Object(Ns.a)(12),data:Object(T.a)({},e),typeSuggest:W.MSG_LINK_CLIENT};const s=null===(t=i.ModuleContainer.resolve(As.a))||void 0===t?void 0:t.getConvIdByWindowId(this._lastFocusedWindowId);this._countShowLinkSuggest(this._lastFocusedWindowId,s),this._showLinkSuggest(this._lastFocusedWindowId,s)}_checkIfEnabled(){return Ds.isClipboardLinkSuggestEnabled()&&this.isEnabledOnCurrentPlatform()}_checkIfValid(e,t){return!(!this._linkSuggestData||!e||""===t)}_showLinkSuggest(e,t){if(!this._checkIfValid(e,t))return;const s=this._listeners.get(e);s&&"function"==typeof s&&s({action:P.LinkSuggestManagerActions.NEW_LINK_SUGGEST,payload:{newLinkSuggestData:this._linkSuggestData}})}_hideShowLinkSuggest(e,t){if(!e||""===t)return;const s=this._listeners.get(e);s&&"function"==typeof s&&s({action:P.LinkSuggestManagerActions.HIDE_LINK_SUGGEST,payload:{newLinkSuggestData:null}})}_countShowLinkSuggest(e,t){this._checkIfValid(e,t)&&this._processCountShowLink()}})||Fs)||Fs)||Fs)||Fs);var Gs,zs=s("vQ8b"),xs=s("ZBGy"),Vs=s("smi1"),Hs=s("gEkt");let qs=Object(i.injectable)()(Gs=function(e,t){return i.ModuleContainer.inject(ze.j)(e,void 0,0)}(Gs=function(e,t){return i.ModuleContainer.inject(ze.i)(e,void 0,1)}(Gs=Reflect.metadata("design:type",Function)(Gs=Reflect.metadata("design:paramtypes",[void 0===ze.j?Object:ze.j,void 0===ze.i?Object:ze.i])(Gs=class{constructor(e,t){this.unreadDataManager=e,this.previewManager=t,this.menuRef=void 0,this.menuRef={}}deleteConversation(e,t=!0){e!=W.CONV_FILTER.STRANGER&&(A.default.logCoreError(`[user call del conv] ${e}`),Vs.default.deleteConversation(e,t).then((e=>{e&&e.delConversationId&&Object(xs.f)({type:P.ConversationListActions.TAG_CONV,payload:{data:[{userId:e.delConversationId,label:null}]}})})).catch((e=>{A.default.logCoreError("Delete conversation fail - "+JSON.stringify(e))})))}bindUIMenu(e,t){this.menuRef[e]=t}cleanUpUIMenu(e){this.menuRef[e]=null}showMenu(e,t,s){if(this.menuRef[e]&&e===Hs.b)this.showConvActionMenu(t,s)}hideMenu(e){this.menuRef[e]&&this.menuRef[e].close()}showConvActionMenu(e,t){if(t&&t.friendItem)return;const s=Object(T.a)({},t),i=s.userId;if(s&&!A.default.isFakeId(i)){const e=this.previewManager.getPreviewByIDSync(i),t=Z.default.getProfileFriendByIdSync(i)||{},a=this.unreadDataManager.getUnreadByConvIdSync(i);s.lastMessage=null==e?void 0:e.message,s.isFr=t.isFr,s.type=t.type,s.unreadMark=null==a?void 0:a.unreadMark,s.smsUnreadCount=null==a?void 0:a.smsUnreadCount}this.menuRef[Hs.b].updateTargetInfo(s),this.menuRef[Hs.b].showAction(Object(T.a)({},e))}})||Gs)||Gs)||Gs)||Gs)||Gs;var Ws,Zs=s("hI9i"),Ks=s("iZzu"),Qs=s("6Vk1"),$s=s("RojW"),Ys=s("rXIX"),Js=s("l+Gc"),Xs=s("VTLO"),ei=s("LJTV"),ti=s("Enw1"),si=s("M7kw"),ii=s("Ws4b"),ai=s("6uTC"),ni=s("c51z"),ri=s("Ja3U"),oi=s("SdS7"),ci=s("TeAh"),li=s("FEfs"),di=s("u1t/");const hi={typeFilter:Ks.FilterType.ALL,labelFilters:[],loaded:!1,isEnableArchivedChat:!!li.a.isEnableArchivedChat(),typeFilterSrc:Ks.FilterSrcType.ALL},ui="z_sendtome_bubbledot";Object(ie.b)(Ks.ConvListController)(Ws=function(e,t){return i.ModuleContainer.inject(ze.b)(e,void 0,0)}(Ws=function(e,t){return i.ModuleContainer.inject(Qs.b)(e,void 0,1)}(Ws=function(e,t){return i.ModuleContainer.inject(ze.j)(e,void 0,2)}(Ws=function(e,t){return i.ModuleContainer.inject(ze.g)(e,void 0,3)}(Ws=function(e,t){return i.ModuleContainer.inject(ze.h)(e,void 0,4)}(Ws=function(e,t){return i.ModuleContainer.inject(ze.a)(e,void 0,5)}(Ws=Reflect.metadata("design:type",Function)(Ws=Reflect.metadata("design:paramtypes",[void 0===ze.b?Object:ze.b,void 0===Qs.b?Object:Qs.b,void 0===ze.j?Object:ze.j,void 0===ze.g?Object:ze.g,void 0===ze.h?Object:ze.h,void 0===ze.a?Object:ze.a])(Ws=class extends De.b{constructor(e,t,s,i,a,n){super(),this.convDataManager=e,this.labelDataManager=t,this.unreadDataManager=s,this.muteDataManager=i,this.pinDataManager=a,this.archivedChatManager=n,this.typeFilter=void 0,this.labelFilters=void 0,this.listRawAll=void 0,this.listVisible=void 0,this.listStrangers=void 0,this.listHiddens=void 0,this.listFiltered=void 0,this.newestStrangerId=void 0,this.menuRef=void 0,this.convUIListContainer=void 0,this.showedOnboarding=void 0,this.loaded=void 0,this.isEnableArchivedChat=void 0,this.typeFilterSrc=void 0,this._logger=void 0,this._pm=null,this._sbc=null,this.handleMuteChange=e=>{const t=e.convId,s=e.payload,i=this.listFiltered.includes(t);this.logger.zsymb(0,"2z2Hg-","handleMuteChange",t,i,this.typeFilter,s),i&&(this.typeFilter===Ks.FilterType.UNREAD||this.isEnableArchivedChat&&this.typeFilterSrc===Ks.FilterSrcType.UNREAD)&&this.addConvToUnreadFilterV2(t)},this.deleteConversation=(e,t=!0)=>{e!=W.CONV_FILTER.STRANGER&&(this.logger.zsymb(18,"VCj3YV",`[user call del conv] ${e}`),Vs.default.deleteConversation(e,t).then((e=>{e&&e.delConversationId&&Object(xs.f)({type:P.ConversationListActions.TAG_CONV,payload:{data:[{userId:e.delConversationId,label:null}]}})})).catch((e=>{this.logger.zsymb(18,"rHOuGj","Delete conversation fail - "+JSON.stringify(e))})))},this.name=Ks.CONV_LIST_CONTROLLER,this.data=new Map,this.key="windowId",this.isEnableArchivedChat=!1,this.typeFilter=Ks.FilterType.ALL,this.labelFilters=[],this.typeFilterSrc=Ks.FilterSrcType.ALL,this.listRawAll=new Set,this.listVisible=[],this.listStrangers=[],this.listHiddens=[],this.listFiltered=[],this.newestStrangerId="",this.menuRef={},this.showedOnboarding=!1,this.loaded=!1,this.getRecentContactWithId=this.getRecentContactWithId.bind(this),this.selectConversation=this.selectConversation.bind(this),this.showBroadCastMsgModal=this.showBroadCastMsgModal.bind(this),this.markAsRead=this.markAsRead.bind(this),this.addListener()}get logger(){return this._logger||(this._logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger(Ss.ZLoggerNametags.conversation,[Ss.ZLoggerNametags.convList])),this._logger}get previewManager(){return this._pm||(this._pm=i.ModuleContainer.resolve(ze.i)),this._pm}get sidebarController(){return this._sbc||(this._sbc=i.ModuleContainer.resolve(Ks.SidebarController)),this._sbc}get currUser(){return Object(ii.c)()}onTypeFilterChange(e,t){if(e===Ks.FilterType.UNREAD){const e=this.labelFilters.length>0?1453215:1453214;fe.default.logAction(e),setTimeout((()=>{this.scrollToTop(!1)}))}else e!==Ks.FilterType.ARCHIVED&&e!==Ks.FilterType.FOCUSED||this.typeFilter===e||setTimeout((()=>{this.scrollToTop(!1)}));const s=this.typeFilter,a=e,n=i.ModuleContainer.resolve(di.TUnreadSubChatTabStateManager),r=n.convetFilterTypeToSubChatTabType(s),o=n.convetFilterTypeToSubChatTabType(a);n.isValidSubChatTabType(o)&&n.handleChangeSubtab(r,o),this.applyTypeFilter(e,t)}onLabelFilterChange(e){this.typeFilter===Ks.FilterType.UNREAD&&setTimeout((()=>{this.scrollToTop(!1)})),this.applyLabelFilter(e)}rerenderList(){this.signalRenderList()}async onPreviewChange(e,t){if(!e||!t)return;const s=e.convId;if(this.listRawAll.add(s),Le.a.isThreadHidden(s))return void(this.listHiddens.includes(s)||this.listHiddens.push(s));let i=s,a=!1,n=!1,r=!1;if(await $s.a.isOATypeAsync(s)){const e=this.convDataManager.getConvByIdSync(s);if(!e||!$s.a.popoutOA(e))return}else if($s.a.isStrangerV2(s)&&(a=!0,this.listStrangers.includes(s)||(this.logger.zsymb(0,"3rk_YY",`first new stranger msg ${s}`),this.listStrangers.push(s)),!this.isUnboxStrangerAccount())){const t="0"==e.fromUid||this.convDataManager.isRespondedByMeSync(s),a=this.listVisible.includes(s);t||(a&&(r=!0,this.listVisible=this.listVisible.filter((e=>e!==s))),this.updateNewestStrangerId(this.listStrangers),i=W.CONV_FILTER.STRANGER),t&&!a&&(n=!0,this.listVisible.unshift(s),this.newestStrangerId===s&&this.updateNewestStrangerId(this.listStrangers))}const[o,c]=$s.a.insertToProperPosition(this.listVisible,i,this.getAlterId());this.listVisible=o,e.msgId!==W.FAKE_DRAFT_MSG_ID||e.draft||(this.listVisible=this.listVisible.filter((e=>e!==s)),r=!0);const l=Js.a.getLabelObjByConversaionId(s),d=l&&l.id&&this.labelFilters.includes(""+l.id),h=a&&this.labelFilters.includes(Hs.g),u=d||h,g=c||n||r;if(this.typeFilter===Ks.FilterType.ALL)this.addTabAllFiltered(s,u,g);else if(this.typeFilter===Ks.FilterType.UNREAD)this.addTabUnreadFiltered(s,u,a);else if(this.typeFilter===Ks.FilterType.STRANGER){const e=d||!this.labelFilters.length,t=a&&e;this.addTabStrangerFiltered(s,t)}else if(this.isEnableArchivedChat){const e=this.typeFilter===Ks.FilterType.ARCHIVED;this.typeFilterSrc===Ks.FilterSrcType.UNREAD?(li.a.isArchivedChat(s)&&e||!li.a.isArchivedChat(s)&&!e)&&!Le.a.isThreadHidden(s)&&this.addTabUnreadFiltered(s,u,a):this.listFiltered=this.genListArchivedChat(this.listVisible,e,this.labelFilters),this.signalRenderList()}}addTabAllFiltered(e,t,s){if(t){const[t,s]=$s.a.insertToProperPosition(this.listFiltered,e,this.getAlterId());s&&(this.listFiltered=t,this.signalRenderList())}else s&&this.signalRenderList()}addTabUnreadFiltered(e,t,s){if(this.listFiltered.includes(e)||!ts.b.isMyMessage(this.previewManager.getPreviewByIDSync(e)))if(t)this.addConvToUnreadFilterV2(e);else{if(this.labelFilters.length)return;this.isUnboxStrangerAccount()||!s?this.addConvToUnreadFilterV2(e):this.addConvToUnreadFilterV2(W.CONV_FILTER.STRANGER)}}addTabStrangerFiltered(e,t){if(!t)return;const[s,i]=$s.a.insertToProperPosition(this.listFiltered,e,this.getAlterId());i&&(this.listFiltered=s,this.signalRenderList())}addConvToUnreadFilterV2(e){const[t,s]=$s.a.insertToProperPosition(this.listFiltered,e,this.getAlterId());s&&(this.listFiltered=this.safeSortConvList(t,!1),this.signalRenderList())}onPinChange(e){let t=!1;for(let s=0;s<e.length;s++){const i=e[s].priority,a=e[s].id;i?(this.onPreviewChange({convId:a},[]),t=!1):(t=!0,(!this.previewManager.getPreviewByIDSync(a)||!this.convDataManager.isRespondedByMeSync(a)&&$s.a.isStrangerV2(a))&&(this.listVisible=this.listVisible.filter((e=>e!==a))))}t&&(this.listVisible=this.safeSortConvList(this.listVisible,!1),(this.typeFilter!==Ks.FilterType.ALL||this.labelFilters.length)&&(this.listFiltered=$s.a.sortConvId(this.listFiltered,!1,!0))),this.signalRenderList()}onHiddenChat(e,t){const s=this.convDataManager.getConvByIdSync(e);if(this.logger.zsymb(0,"SBaLae","onHiddenChat ",e,t,!!s),t)this.listHiddens.push(e),this.listVisible=this.listVisible.filter((t=>t!==e)),this.listFiltered=this.listFiltered.filter((t=>t!==e)),this.signalRenderList();else{if(!s&&!Q.a.PinDataManager.isPinned(e))return;if(this.listHiddens=this.listHiddens.filter((t=>t!==e)),this.isUnboxStrangerAccount()||!$s.a.isStrangerV2(e)||this.listStrangers.includes(e)){const[t,s]=$s.a.insertToProperPosition(this.listVisible,e,this.getAlterId());this.listVisible=t}else this.listStrangers.push(e);if(this.listFiltered){const[t,s]=$s.a.insertToProperPosition(this.listFiltered,e,this.getAlterId());this.listFiltered=t,this.isEnableArchivedChat&&(this.listFiltered=this.genListArchivedChat(this.listVisible,this.typeFilter===Ks.FilterType.ARCHIVED,this.labelFilters))}}this.signalRenderList()}getCurrentFilter(){return{type:this.typeFilter,labels:this.labelFilters}}getRecentContacts(){const e=[];return this.listRawAll.forEach((t=>{const s=this.convDataManager.getConvByIdSync(t);s&&e.push(s)})),e}getRecentContactWithId(e){if(this.listRawAll.has(e)){return this.convDataManager.getConvByIdSync(e)||null}return null}addConvToLabel(e,t){let s=Js.a.getItem(t);ft.ModalManagerV2.openModal({windowId:yt.c,name:W.ModalIdentitiesDefine.MANAGE_LABEL,params:{view:Xs.b.ADD_CONVERSATION,info:s}}),e&&(e.preventDefault(),e.stopPropagation()),fe.default.logAction(14521)}selectConversation(e){if(ei.b.startPerf(ei.a),e.userId===W.CONV_FILTER.MEDIA)return void this.logger.zsymb(18,"2hF4Ol","No handler for mediabox. This feat disable!!!");if(e.userId===W.CONV_FILTER.STRANGER)return void(2==Number(_t.default.getConvUXVersion())?this.applyTypeFilter(Ks.FilterType.STRANGER):this.labelDataManager.onSelectLabel(Hs.g));const t=this.sidebarController.getState(yt.c).selectedId;e.userId===t&&e.userId!==W.FAKE_CONVERSATION_ID.FRIEND_CENTER?Object(xs.f)({type:P.ConversationListActions.SELECT_CONV_MINOR,payload:e}):(this.convUIListContainer&&this.convUIListContainer.focus(),e.userId===U.default.sendToMeId&&(ti.g.getFlagForCurrentUser(this.currUser.userId,ui)||(ye.p.getHasShownSendToMeTip()?ti.g.setFlagForCurrentUser(this.currUser.userId,ui,1):setTimeout((()=>{N.default.send(P.ConversationListActions.SHOW_BUBBLE_DOT),ye.p.setHasShownSendToMeTip(!0)}),144e5)),si.b.getCurrentStepKey()!==si.a.UPLOAD_IMAGES||this.showedOnboarding||(si.b.show(),this.showedOnboarding=!0),fe.default.logAction(13901)),e.userId===W.FAKE_CONVERSATION_ID.FRIEND_CENTER?Object(xs.f)({type:P.SideBarActions.SELECT_FRIEND_CENTER,payload:Object(T.a)({},e)}):i.ModuleContainer.resolve(Ge.b).openConversation(e.userId,Ge.d.fromConvItem(e))),this.logActionSelectConv(e.userId)}showBroadCastMsgModal(){var e;if(!_t.default.checkBroadcastTime())return void ai.a.createError(ni.default.str("STR_BROADCAST_OVER_LIMIT_TIP"));let t=!0;1===this.labelFilters.length&&(t=Js.a.getItem(this.labelFilters[0])||!0),null!==(e=U.default.broadcast_resend_config)&&void 0!==e&&e.enable?ft.ModalManagerV2.openModal({windowId:yt.c,name:W.ModalIdentitiesDefine.BROADCAST_RESEND,params:t}):ft.ModalManagerV2.openModal({windowId:yt.c,name:W.ModalIdentitiesDefine.BROADCAST_COMPSE,params:{label:t}}),fe.default.logAction(1453102)}markAsRead(e,t=null){e&&(e.preventDefault(),e.stopPropagation()),fe.default.logAction(164),_t.default.isShowMarkAsReadAgain()?ri.ConfirmManagerV2.openConfirm({windowId:yt.c,name:W.MODAL_CONFIRM.confirmIdentities,params:{message:ni.default.str("STR_MARK_READ_CONFIRM_TEXT"),okText:ni.default.str("STR_CONFIRM"),okType:"primary",cancelText:ni.default.str("STR_LOGOUT_NO"),onOk:e=>{_t.default.setShowMarkAsReadAgain(!(e&&e.dont_show_mark_as_read)),this.markConvsAsRead(t)},options:[{default_val:!1,key:"dont_show_mark_as_read",title:"STR_DONT_SHOW_AGAIN"}]}}):this.markConvsAsRead(t)}scrollToTop(e){const t=oi.b.instance().getConvList();t&&t.scrollToTop(e)}scrollToConv(e){const t=oi.b.instance().getConvList();t&&t.scrollToConversation(e)}openInNewWindow(e,t){if(!e||!e.userId)return;const s=this.menuRef[Hs.b];s&&s.openInNewWindow&&(s.updateTargetInfo(e),s.openInNewWindow(t))}getStrangerInfo(){let e="";if(this.newestStrangerId){const t=this.previewManager.getPreviewByIDSync(this.newestStrangerId);e=t?t.messageTime:""}return this.logger.zsymb(0,"eCJKIj","getStrangerInfo ",this.newestStrangerId,e),{messageTime:e}}getTopMostConv(){return this.typeFilter!==Ks.FilterType.ALL||this.labelFilters.length?this.listFiltered[0]:this.listVisible[0]}isPreviewLoaded(){return this.loaded}addListener(){setTimeout((()=>{this.labelDataManager.addEventListener(Qs.d.SelectedLabelChange,(e=>{this.onLabelFilterChange(e.payload)})),this.labelDataManager.addEventListener(Qs.d.LabelAddConvs,(e=>{this.onLabelChangeConvs(e.payload.labelId,e.payload.convIds,"add")})),this.labelDataManager.addEventListener(Qs.d.LabelRemoveConvs,(e=>{this.onLabelChangeConvs(e.payload.labelId,e.payload.convIds,"remove")}));const e=i.ModuleContainer.resolve(ze.i);e.addEventListener(Ys.b.DoneLoadPreview,(e=>{this.onLoadPreview(e.payload)})),e.addEventListener(Ys.b.DoneMigratePreview,(()=>{this.onMigratedPreview()})),e.addEventListener(Ys.b.PreviewChanged,(e=>{const{changedItem:t,all:s}=e.payload;this.onPreviewChange(t,s)})),e.addEventListener(Ys.b.DraftChanged,(e=>{})),this.convDataManager.addEventListener(Ys.b.DeleteConv,(e=>{this.moveConvOutConvList(e.convId)})),this.convDataManager.addEventListener(Ys.b.EmptyConv,(e=>{this.moveConvOutConvList(e.convId)})),this.convDataManager.addEventListener(Ys.b.LeaveGroup,(e=>{this.moveConvOutConvList(e.convId)})),this.pinDataManager.addEventListener(Ys.b.ChangePinConv,(e=>{this.onPinChange(e.payload)})),this.archivedChatManager.addEventListener(Ys.b.UpdateListArchivedChat,(e=>{this.updateListArchivedChat()})),this.archivedChatManager.addEventListener(Ys.b.OnOffArchivedChat,(e=>{this.onOffArchivedChat(e.payload.status)})),this.muteDataManager.addEventListener(Ys.b.MuteChanged,this.handleMuteChange),Z.default.subscribeEventFriend(W.EventFriend.ADD_FRIEND,(({userId:e})=>{let t=0;this.listStrangers.includes(e)&&(t++,this.listStrangers=this.listStrangers.filter((t=>t!==e)),e==this.newestStrangerId&&(t++,this.updateNewestStrangerId(this.listStrangers))),this.onPreviewChange({convId:e},[]);const s=Z.default.isFriend(e);this.logger.zsymb(0,"aU04VR",`on add friend ${e} ${t} ${s}`)})),Z.default.subscribeEventFriend(W.EventFriend.REMOVE_FRIEND,(({userId:e})=>{let t=0;!this.listStrangers.includes(e)&&this.listVisible.some((t=>t===e))&&(t++,this.listStrangers.push(e)),this.logger.zsymb(0,"fsDWbF",`on remove friend ${e} ${t}`)})),Z.default.subscribeEventFriend(W.EventFriend.DOWNGRADE_BIZ_PROFILE,(()=>{this.handleUserPackageChange()})),Z.default.subscribeEventFriend(W.EventFriend.UPGRADE_BIZ_PROFILE,(()=>{this.handleUserPackageChange()}))}),0)}addToListFiltered(e,t=!1){e.forEach((e=>{if(t){const t=this.unreadDataManager.getUnreadByConvIdSync(e);if(!t||!t.smsUnreadCount&&!t.unreadMark)return}const[s]=$s.a.insertToProperPosition(this.listFiltered,e);this.listFiltered=s}))}applyTypeFilter(e,t=!1){if(this.typeFilter===e&&!t)return;this.logger.zsymb(0,"O-iYEj","applyTypeFilter ",e,t);const s=this.typeFilter;switch(this.typeFilter=e,e){case Ks.FilterType.ALL:if(0!==this.labelFilters.length){if(this.listFiltered=$s.a.filterByLabel(this.listVisible,this.labelFilters),this.labelFilters.includes(Hs.g)){let e=this.listStrangers;this.showStrangerNROnly()&&(e=$s.a.filterByResponsed(e,!1)),this.addToListFiltered(e)}else this.doAddStrangerHasLabel(this.listFiltered,this.labelFilters);this.addLikeConvToFilterListV2(this.listFiltered,this.labelFilters)}break;case Ks.FilterType.UNREAD:if(0!==this.labelFilters.length){const e=s==Ks.FilterType.ALL?this.listFiltered:this.listVisible;this.listFiltered=$s.a.filterByLabel(e,this.labelFilters),this.labelFilters.includes(Hs.g)?this.addToListFiltered(this.listStrangers):this.doAddStrangerHasLabel(this.listFiltered,this.labelFilters),this.listFiltered=$s.a.filterByUnread(this.listFiltered),this.listFiltered=$s.a.sortConvId(this.listFiltered,!1,!0)}else this.listFiltered=$s.a.filterByUnread(this.listVisible),this.listFiltered=this.safeSortConvList(this.listFiltered,!1);break;case Ks.FilterType.STRANGER:this.listFiltered=$s.a.filterByLabel(this.listStrangers,this.labelFilters),this.listFiltered=$s.a.sortConvId(this.listFiltered,!1,!0),this.showStrangerNROnly()&&(this.listFiltered=$s.a.filterByResponsed(this.listFiltered,!1));break;case Ks.FilterType.FOCUSED:this.listFiltered=this.genListArchivedChat(this.listVisible,!1,this.labelFilters);break;case Ks.FilterType.ARCHIVED:this.listFiltered=this.genListArchivedChat(this.listVisible,!0,this.labelFilters)}this.signalRenderState(),this.signalRenderList()}applyLabelFilter(e){if(this.labelFilters!==e){switch(this.logger.zsymb(0,"twe2Uj","applyLabelFilter ",e.join("-")),this.labelFilters=e.map((e=>""+e)),this.typeFilter){case Ks.FilterType.ALL:if(this.listFiltered=$s.a.filterByLabel(this.listVisible,this.labelFilters),this.doAddStrangerHasLabel(this.listFiltered,this.labelFilters),this.addLikeConvToFilterListV2(this.listFiltered,e),this.labelFilters.some((e=>e==Hs.g))){let e=this.listStrangers;this.showStrangerNROnly()&&(e=$s.a.filterByResponsed(e,!1)),this.addToListFiltered(e)}break;case Ks.FilterType.UNREAD:if(this.listFiltered=$s.a.filterByLabel(this.listVisible,e),this.doAddStrangerHasLabel(this.listFiltered,this.labelFilters),this.labelFilters.some((e=>e==Hs.g))){let e=this.listStrangers;this.showStrangerNROnly()&&(e=$s.a.filterByResponsed(e,!1)),this.addToListFiltered(e)}this.listFiltered=$s.a.filterByUnread(this.listFiltered),this.listFiltered=this.safeSortConvList(this.listFiltered,!1);break;case Ks.FilterType.STRANGER:this.listFiltered=$s.a.filterByLabel(this.listStrangers,this.labelFilters),this.listFiltered=$s.a.sortConvId(this.listFiltered,!1,!0),this.showStrangerNROnly()&&(this.listFiltered=$s.a.filterByResponsed(this.listFiltered,!1));break;case Ks.FilterType.FOCUSED:this.listFiltered=this.genListArchivedChat(this.listVisible,!1,e);break;case Ks.FilterType.ARCHIVED:this.listFiltered=this.genListArchivedChat(this.listVisible,!0,e)}this.signalRenderState(),this.signalRenderList()}}showStrangerNROnly(){return!this.isUnboxStrangerAccount()}isUnboxStrangerAccount(){const e=ci.c.isUnboxStranger();return this.logger.zsymb(0,"8fhnqX","isUnboxStrangerAccount ",e),e}doAddStrangerHasLabel(e,t){if(t.length){const s=$s.a.filterByLabel(this.listStrangers,t);if(s.length){const t=new Set(s);for(let s=0;s<e.length;s++)t.has(e[s])&&t.delete(e[s]);this.addToListFiltered(t)}}return e}isConvExists(e){const t=this.convDataManager.getConvByIdSync(e);return!!(null!=t&&t.firstSmsLocalId||null!=t&&t.lastSmsLocalId)}safeSortConvList(e,t=!0){const s=e.indexOf(W.CONV_FILTER.STRANGER);if(-1!==s){e[s]=this.newestStrangerId;const i=(e=$s.a.sortConvId(e,t,!0)).indexOf(this.newestStrangerId);e[i]=W.CONV_FILTER.STRANGER}else e=$s.a.sortConvId(e,t,!0);return e}isValidFakeConv(e,t,s){if(e.some((e=>e==s))||Le.a.isThreadHidden(s))return!1;const i=Js.a.getLabelObjByConversaionId(s);return!(!i||!t.some((e=>e==i.id)))}isValidFakeConvV2(e,t){if(!t||e.some((e=>e==t))||Le.a.isThreadHidden(t))return!1;return!(t&&t.startsWith(W.GROUPID_PREFIX))||!!Fe.default.getGroupByIdSync(t)}addLikeConvToFilterListV2(e,t){if(t.length&&this.typeFilter!==Ks.FilterType.UNREAD){this.logger.zsymb(0,"qi9_zd","addLikeConvToFilterListV2 ",t);for(const s of t){const t=this.labelDataManager.getLabelById(s);if(t&&t.conversations)for(const s of t.conversations)this.isValidFakeConvV2(e,s)&&e.push(s)}}}markConvsAsRead(e){const t=[],s=0===this.labelFilters.length;this.logger.zsymb(0,"u90imm",`markConvsAsRead #1  ${null==e?void 0:e.join("-")}`),this.listRawAll.forEach((i=>{const a=this.unreadDataManager.getUnreadByConvIdSync(i);if(a&&(a.smsUnreadCount>0||a.unreadMark)){if(this.logger.zsymb(0,"9O-Pi-",`markConvsAsRead #2, ${i}, ${a.smsUnreadCount}`),e&&!e.hasOwnProperty(i)||i===W.FAKE_CONVERSATION_ID.FRIEND_CENTER)return;const n=Js.a.getLabelObjByConversaionId(i)||{},r=this.convDataManager.getConvByIdSync(i)||{userId:i};(s||this.labelFilters.some((e=>e==n.id))||$s.a.isInStrangerBoxV2(i)&&this.typeFilter===Ks.FilterType.STRANGER)&&t.push(r)}})),this.logger.zsymb(0,"WOSa_e",`markConvsAsRead #3 ${t.length} ${t.map((e=>e.userId)).join("-")}`),t.length>0&&(N.default.send(P.SideBarActions.MARK_AS_READ,{conversations:t}),fe.default.logAction(1453304))}onLoadPreview(e){this.logger.zsymb(0,"4rePkS",`onload Preview 1: ${this.listRawAll.size}`);let t=e.map((e=>e.convId));const s=_t.default.getConvUXVersion();this.isEnableArchivedChat=!!li.a.isEnableArchivedChat()&&"3"==s,this.typeFilter=this.isEnableArchivedChat?Ks.FilterType.FOCUSED:Ks.FilterType.ALL,this.listRawAll.size&&this.listRawAll.forEach((e=>{t.some((t=>t===e))||t.push(e)})),this.listRawAll=new Set(t);const i=U.default.sendToMeId;this.listRawAll.has(i)||(t.push(i),this.listRawAll.add(i)),this.logger.zsymb(0,"8eSHOn",`onload Preview 2: ${t.length}`),$s.a.groupConversaion(t).then((e=>{if(this.logger.zsymb(0,"YK56_O",`grouped list #1: \n\t\t\t\t${e.hidden.length}\n\t\t\t\t- ${e.stranger.length}\n\t\t\t\t- ${e.outdate.length}\n\t\t\t\t- ${e.visible.length}\n\t\t\t`),U.default.stagingAccount)for(const i in e)this.logger.zsymb(0,"nzcwel",`${i}: ${e[i]}`);this.listStrangers=e.stranger,this.listHiddens=e.hidden;const t=this.addStrangersToVisible(e.visible,this.listStrangers);let s=t;if(this.listVisible.length){this.logger.zsymb(0,"eLdIDa",`preview changed while group csc #1: ${this.listVisible}`),s=this.listVisible;const e=new Set(this.listVisible);t.forEach((t=>{e.has(t)||s.push(t)}))}this.listVisible=this.safeSortConvList(s,!1),this.initMyCloud(),this.isEnableArchivedChat&&(this.listFiltered=this.genListArchivedChat(this.listVisible,this.typeFilter===Ks.FilterType.ARCHIVED,this.labelFilters)),this.logger.zsymb(0,"Zxk6sD",`visible sorted #1: ${this.listVisible}`),this.loaded=!0,this.signalRenderList(),this.signalRenderState(),this.dispatchEvent(new Ys.a(Ys.c.LoadPreviewDone,"",this.listVisible.slice()))}))}onMigratedPreview(){this.logger.zsymb(0,"bWkII6",`onMigratedPreview #1: ${this.listVisible}`);const e=_t.default.getConvUXVersion();this.isEnableArchivedChat=!!li.a.isEnableArchivedChat()&&"3"==e,this.typeFilter=this.isEnableArchivedChat?Ks.FilterType.FOCUSED:Ks.FilterType.ALL;const t=U.default.sendToMeId;this.listRawAll.has(t)||this.initMyCloud(),this.convDataManager.getConvByIdSync(t)&&!this.listVisible.includes(t)&&(this.logger.zsymb(0,"gA5w-5","onMigratedPreview #2"),this.onPreviewChange({convId:t},[])),this.loaded=!0,this.signalRenderList(),this.signalRenderState()}initMyCloud(){const e=ti.g.getFlagForCurrentUser(null,"z_sendtome"),t=U.default.sendToMeId,s=!(U.default.isOffSendToMe||e&&1!==e);if(this.logger.zsymb(0,"MRrzs_","initMyCloud",e,U.default.isOffSendToMe),this.listVisible.some((e=>e===t))){const e=this.convDataManager.getConvByIdSync(t);e&&e.pinned?fe.default.logAction(1390703):(ti.g.setFlagForCurrentUser(null,"z_sendtome",Date.now()),fe.default.logAction(1390702))}else if(s){const e=Q.a.PinDataManager.getTotalPinnedConversation()>=U.default.limit_pin_messages,s=U.default.auto_pin_send2me&&!ti.g.getFlagForCurrentUser(null,"z_sendtome_pinned")&&!e;this.convDataManager.createEmptyConvForUser(t,s?1:0,W.CONV_OT_STATE.none,{}),s&&(Q.a.PinDataManager.pin([t]),ti.g.setFlagForCurrentUser(null,"z_sendtome_pinned",1)),ti.g.setFlagForCurrentUser(null,"z_sendtome",Date.now()),this.onPreviewChange({convId:t},[])}}addStrangersToVisible(e,t){if(!t||!t.length)return e;if(this.isUnboxStrangerAccount())return e.concat(t);{const s=$s.a.filterByResponsed(t,!1);if(s.length){this.newestStrangerId=$s.a.getNewestConvFromIds(s);e.includes(W.CONV_FILTER.STRANGER)||e.push(W.CONV_FILTER.STRANGER)}return t.forEach((t=>{this.convDataManager.isRespondedByMeSync(t)&&e.push(t)})),e}}onLabelChangeConvs(e,t,s){if(this.logger.zsymb(0,"CvKCNR","onLabelChangeConvs",t.length,e),t.length&&this.labelFilters.includes(e))if("add"==s){const e=t.filter((e=>!this.listFiltered.includes(e)&&!this.listHiddens.includes(e)));if(!e.length)return;this.listFiltered=[...this.listFiltered,...e],this.listFiltered=$s.a.sortConvId(this.listFiltered,!1,!1),this.signalRenderList()}else{let e=!1;t.forEach((t=>{const s=Js.a.getLabelObjByConversaionId(t),i=s?s.id:null;this.labelFilters.includes(""+i)||(this.listFiltered=this.listFiltered.filter((e=>e!==t)),e=!0)})),e&&this.signalRenderList()}}moveConvOutConvList(e){this.logger.zsymb(0,"yMlYDb","moveConvOutConvList",e),this.listVisible=this.listVisible.filter((t=>t!==e)),this.listFiltered=this.listFiltered.filter((t=>t!==e)),this.listStrangers=this.listStrangers.filter((t=>t!==e)),e!==this.newestStrangerId||this.isUnboxStrangerAccount()||this.updateNewestStrangerId(this.listStrangers),this.signalRenderList()}getAlterId(){return new Map([[W.CONV_FILTER.STRANGER,this.newestStrangerId]])}updateNewestStrangerId(e){if(this.isUnboxStrangerAccount())return;const t=$s.a.filterByResponsed(e,!1),s=this.newestStrangerId;if(this.newestStrangerId=$s.a.getNewestConvFromIds(t),this.newestStrangerId||(this.listVisible=this.listVisible.filter((e=>e!==W.CONV_FILTER.STRANGER)),this.signalRenderList()),this.previewManager.updateStrangerBox(this.newestStrangerId),s!==this.newestStrangerId&&this.newestStrangerId){const[e,t]=$s.a.insertToProperPosition(this.listVisible,W.CONV_FILTER.STRANGER,this.getAlterId());this.listVisible=e,this.signalRenderList()}}rebuildList(){this.logger.zsymb(0,"eZhykt",`rebuildList 1: ${this.listRawAll.size} ${this.listVisible.length} ${this.listStrangers.length}`),this.listStrangers=[],this.listVisible=[],this.listHiddens=[],this.listFiltered=[],this.newestStrangerId="";const e=Array.from(this.listRawAll),t=$s.a.groupConversaionSync(e);if(this.logger.zsymb(0,"SWOmrl",`grouped list #2: \n\t\t\t${t.hidden.length}\n\t\t\t- ${t.stranger.length}\n\t\t\t- ${t.outdate.length}\n\t\t\t- ${t.visible.length}\n\t\t`),U.default.stagingAccount)for(const a in t)this.logger.zsymb(0,"HsEzFN",`${a}:, ${t[a]}`);this.listStrangers=t.stranger,this.listHiddens=t.hidden;const s=this.addStrangersToVisible(t.visible,this.listStrangers),i=this.safeSortConvList(s,!1);this.listVisible=i,this.logger.zsymb(0,"3ehJBP",`visible sorted #2: ${this.listVisible}`),this.labelFilters.length&&this.applyLabelFilter(this.labelFilters),this.typeFilter!==Ks.FilterType.ALL&&this.applyTypeFilter(this.typeFilter,U.default.should_force_genlist_conv),this.signalRenderList(),this.signalRenderState()}handleUserPackageChange(){this.logger.zsymb(0,"0fIESJ",`handleUserPackageChange: ${Z.default.isMeBAAccount()}}`),this.rebuildList()}signalRenderList(e="all"){Object(Zs.h)(this.name,e)}signalRenderState(){Object(Zs.g)(this.name,yt.c)}logActionSelectConv(e){const t=this.labelFilters.length>0;if(this.typeFilter===Ks.FilterType.UNREAD?(fe.default.logAction(1453103),t||fe.default.logAction(1453107)):this.typeFilter===Ks.FilterType.ALL?(fe.default.logAction(1453104),t&&fe.default.logAction(1453108)):this.typeFilter===Ks.FilterType.FOCUSED?fe.default.logAction(1453501):this.typeFilter===Ks.FilterType.ARCHIVED&&fe.default.logAction(1453502),t)fe.default.logAction(1453105);else{fe.default.logAction(1453106);for(let e=0;e<this.labelFilters.length;e++){if(parseInt(this.labelFilters[e])>0){fe.default.logAction(1453109);break}}}this.typeFilter==Ks.FilterType.ARCHIVED&&li.a.sendTrackSrc(e,4,!1)}init(){}getItem(e){return e.key===yt.c?{labelFilters:this.labelFilters,typeFilter:this.typeFilter,loaded:this.loaded,isEnableArchivedChat:this.isEnableArchivedChat,typeFilterSrc:this.typeFilterSrc}:hi}getList(e){return e.key===yt.c||this.typeFilter==Ks.FilterType.ALL&&0===this.labelFilters.length?this.listVisible:this.listFiltered}onGetItemFailure(e){}onGetListFailure(e){}bindUIMenu(e,t){this.menuRef[e]=t}cleanUpUIMenu(e){this.menuRef[e]=null}showMenu(e,t,s){if(this.menuRef[e]&&e===Hs.b)this.showConvActionMenu(t,s)}hideMenu(e){this.menuRef[e]}showConvActionMenu(e,t){if(t&&t.friendItem)return;if(t.userId===W.CONV_FILTER.STRANGER||t.userId===W.CONV_FILTER.MEDIA)return;const s=Object(T.a)({},t),i=s.userId;if(s&&!A.default.isFakeId(i)){const e=this.previewManager.getPreviewByIDSync(i),t=Z.default.getProfileFriendByIdSync(i)||{},a=this.unreadDataManager.getUnreadByConvIdSync(i);s.lastMessage=null==e?void 0:e.message,s.isFr=t.isFr,s.unreadMark=null==a?void 0:a.unreadMark,s.smsUnreadCount=null==a?void 0:a.smsUnreadCount}this.menuRef[Hs.b].updateTargetInfo(s),this.menuRef[Hs.b].showAction(Object(T.a)({},e))}bindUIContainer(e){this.convUIListContainer=e}cleanUpUIContainer(){this.convUIListContainer=null}getEnableArchivedChat(){return this.isEnableArchivedChat}getListFilterSrc(e){return this.typeFilterSrc===Ks.FilterSrcType.UNREAD?$s.a.filterByUnread(e):e}setTypeFilterSrc(e){if(this.typeFilterSrc!==e&&(this.typeFilterSrc=e,this.applyTypeFilter(this.typeFilter,!0),e===Ks.FilterSrcType.UNREAD)){const e=this.labelFilters.length>0?1453215:1453214;fe.default.logAction(e)}}genListArchivedChat(e,t,s,i=!0,a=!0){let n=[];n=$s.a.filterByLabel(this.getListFilterSrc(e),s),s.length&&a&&this.typeFilterSrc!==Ks.FilterSrcType.UNREAD&&this.addLikeConvToFilterListV2(n,s);let r=this.getListFilterSrc(this.listStrangers).filter((e=>(li.a.isArchivedChat(e)&&t||!li.a.isArchivedChat(e)&&!t)&&!Le.a.isThreadHidden(e)));return s.includes(Hs.g)&&1==s.length?this.isUnboxStrangerAccount()||(r=$s.a.filterByResponsed(r,!1)):s.includes(Hs.g)||(r=$s.a.filterByLabel(r,s)),n=n.filter((e=>!(this.typeFilter===Ks.FilterType.ARCHIVED||!r.length||e!=W.CONV_FILTER.STRANGER)||(li.a.isArchivedChat(e)&&t||!li.a.isArchivedChat(e)&&!t)&&e!==W.CONV_FILTER.STRANGER&&!$s.a.isStrangerV2(e)&&!Le.a.isThreadHidden(e))),i&&(this.typeFilter===Ks.FilterType.ARCHIVED?n=n.concat(r):this.isUnboxStrangerAccount()||s.length?(this.isUnboxStrangerAccount()&&(null==s||!s.length)||null!=s&&s.length)&&(n=n.concat(r)):n=this.addStrangersToVisible(n,r)),n=n.filter(((e,t)=>n.indexOf(e)==t)),this.safeSortConvList(n,!1)}updateListArchivedChat(){this.typeFilter==Ks.FilterType.FOCUSED?this.onTypeFilterChange(Ks.FilterType.FOCUSED,!0):this.typeFilter==Ks.FilterType.ARCHIVED&&this.onTypeFilterChange(Ks.FilterType.ARCHIVED,!0)}onOffArchivedChat(e){if(!U.default.enable_archived_chat)return;const t=_t.default.getConvUXVersion();this.isEnableArchivedChat&&e&&"2"==t&&(this.isEnableArchivedChat=!1,this.signalRenderState()),this.isEnableArchivedChat!=e&&(e||this.typeFilter!==Ks.FilterType.ARCHIVED&&this.typeFilter!==Ks.FilterType.FOCUSED?e&&this.onTypeFilterChange(Ks.FilterType.FOCUSED,!0):this.onTypeFilterChange(Ks.FilterType.ALL,!0),this.labelDataManager.onClearFilter(),this.setTypeFilterSrc(Ks.FilterSrcType.ALL),this.isEnableArchivedChat=e&&"3"==t,this.signalRenderState())}})||Ws)||Ws)||Ws)||Ws)||Ws)||Ws)||Ws)||Ws);var gi,mi=s("EYv5"),pi=s("BR4E"),fi=s("AtyM"),vi=s("R5gT"),_i=s("Xzw3"),bi=s("d+hT"),yi=s("uEOi"),Ii=s("rQsU"),Si=s("4prX"),Ci=s("kTC5"),Ei=s("ES/k"),Oi=s("uAQs"),Ti=s("WBqA"),Mi=s("qa8q"),Ri=s("vAzq"),wi=s("rkiK");const Li={isFocusSearchBox:!1,isFocusOnRecentSearch:!1,searchText:"",searchResult:{},searching:!1,conversation:null,highlightId:"",filter:{timeFrom:0,timeTo:Date.now()}},Fi=new A.LocalId;var Di=function(e){return e[e.STEP_CONTACT=0]="STEP_CONTACT",e[e.STEP_MESSAGES=1]="STEP_MESSAGES",e[e.STEP_FILES=2]="STEP_FILES",e[e.STEP_DIRECTORY=3]="STEP_DIRECTORY",e}(Di||{});Object(ie.b)(Ks.SearchController)(gi=function(e,t){return i.ModuleContainer.inject(Ii.b)(e,void 0,0)}(gi=function(e,t){return i.ModuleContainer.inject(ze.b)(e,void 0,1)}(gi=function(e,t){return i.ModuleContainer.inject(ze.i)(e,void 0,2)}(gi=Reflect.metadata("design:type",Function)(gi=Reflect.metadata("design:paramtypes",[void 0===Ii.b?Object:Ii.b,void 0===ze.b?Object:ze.b,void 0===ze.i?Object:ze.i])(gi=class{constructor(e,t,s){this.convListController=e,this.convDataManager=t,this.previewDataManager=s,this.state=void 0,this.pageLoad=void 0,this.curQuery=void 0,this.cacheResSearch=void 0,this.countQuery=void 0,this.countTimeUseGlobalSearch=void 0,this.countSelectTopRes=void 0,this.cacheSearch=void 0,this.trackSearch=void 0,this.trackSearchVietnamese=void 0,this.lastTextSearch=void 0,this.lastTextSearchTs=void 0,this.isShowRecentSearch=void 0,this.isFirstLoadSuccess=void 0,this.isSearchingMsg=void 0,this.searchDelay=void 0,this.closeBySendingMsg=void 0,this.clearAdminMode=void 0,this.timeouResetDataMsg=void 0,this.searchResultList=void 0,this.recentSearchList=void 0,this.searchInput=void 0,this.loadingMore=void 0,this.loadingMoreFiles=void 0,this.oldestTime=void 0,this.functionSearchByName=void 0,this.timeoutLog=void 0,this._timeDebounceSearch=null,this.dataLoaded=void 0,this._sbc=null,this._removeSearchResult=(e,t)=>{const s=this.getSearchState();if(s&&!s.conversation&&s.searchResult)if(t){if(!s.searchResult.groups)return;const t=[...s.searchResult.groups];for(let i=0;i<t.length;i++)if(t[i].userId==e){t.splice(i,1),this.updateState(Object(T.a)(Object(T.a)({},s),{},{searchResult:Object(T.a)(Object(T.a)({},s.searchResult),{},{groups:t})}));break}}else{if(!s.searchResult.friends)return;const t=[...s.searchResult.friends];for(let i=0;i<t.length;i++)if(t[i].userId==e){t.splice(i,1),this.updateState(Object(T.a)(Object(T.a)({},s),{},{searchResult:Object(T.a)(Object(T.a)({},s.searchResult),{},{friends:t})}));break}}},this.name=Ks.SEARCH_CONTROLLER,this.key="windowId",this.state=Li,this.pageLoad=0,this.curQuery="",this.countQuery=0,this.countTimeUseGlobalSearch=0,this.countSelectTopRes=0,this.cacheSearch={items:[],keywords:null},this.trackSearch=!1,this.trackSearchVietnamese=!1,this.lastTextSearch="",this.lastTextSearchTs=0,this.isShowRecentSearch=!1,this.searchDelay=this._getSearchDelaySetting(),this.closeBySendingMsg=!1,this.loadingMore=!1,this.loadingMoreFiles=!1,this.oldestTime=0,this.timeoutLog=null,this.isFirstLoadSuccess=!1,this.isSearchingMsg=!1,this.dataLoaded=null,this._innerSearchFunc=this._innerSearchFunc.bind(this),this.functionSearchByName=A.default.throttle(this._innerSearchFunc,this.searchDelay),this.onKeywordChange=this.onKeywordChange.bind(this),this.loadMoreMessagesV2=this.loadMoreMessagesV2.bind(this),this.loadMessagesV2=this.loadMessagesV2.bind(this),this.loadMoreFiles=this.loadMoreFiles.bind(this),this.onKeyPressInput=this.onKeyPressInput.bind(this),this.onFocusInput=this.onFocusInput.bind(this),this.onBlurInput=this.onBlurInput.bind(this),this.onclickCloseSearchButton=this.onclickCloseSearchButton.bind(this),this.onClickClearSearch=this.onClickClearSearch.bind(this),this.onSearchKeyword=this.onSearchKeyword.bind(this),this.setRecentSearchFocusState=this.setRecentSearchFocusState.bind(this),this.focusSearchBox=this.focusSearchBox.bind(this),this.selectResult=this.selectResult.bind(this),this.onFileSelect=this.onFileSelect.bind(this),this.selectTopRes=this.selectTopRes.bind(this),this.listenEvents()}get sidebarController(){return this._sbc||(this._sbc=i.ModuleContainer.resolve(Ks.SidebarController)),this._sbc}listenEvents(){N.default.subscribe(((e,t)=>{switch(e){case P.SideBarActions.FOCUS_SEARCH_INPUT:this.focusSearchBox();break;case P.FetchActions.FRIENDS_REMOVED:this._removeSearchResult(t,!1);break;case P.FetchActions.GROUP_LEAVE:this._removeSearchResult(t,!0);break;case P.SideBarActions.SEARCH_FILE_DONE:this.updateState(Object(T.a)(Object(T.a)({},this.state),{},{searching:!1}));break;case P.SideBarActions.CLEAR_SEARCH:this.clearSearch();break;case P.ConversationListActions.SELECT_CONVERSATION:setTimeout((()=>{this.state.highlightId!==t.userId&&this.setRecentSearchFocusState(!1,!1,!0),t.callPoint!==Ge.a.JumpMessage&&this.updateStateOf("highlightId",null==t?void 0:t.userId)}),0)}}))}logSearch(e){ye.p.getDebugSearch().showLogSearchFlow}updateState(e,t=!0){this.state=e,t&&Object(Zs.g)(this.name,yt.c)}isTextKey(e){return e.match(/^[a-zA-Z0-9!@#$%^&*)(+=._-|\\\[\]{}~`"\';:?/<>,-\s\n]$/)}isMultipleKeyPressed(e){return e.ctrlKey||e.metaKey||e.altKey}isKeywordStale(e){return Ei.a.formatTextSearch(e)!==Ei.a.formatTextSearch(this.state.searchText)}bindUIList(e,t){this._updateListRef(e,t)}cleanUpUIList(e){this._updateListRef(e,null)}bindUISearchInput(e){this.searchInput=e}cleanUpUISearchInput(){this.searchInput=null}_updateListRef(e,t){switch(e){case Ci.c.SEARCH_RESULT:this.searchResultList=t;break;case Ci.c.RECENT_SEARCH:this.recentSearchList=t}}resetState(){this.searchInput.value="",this.updateState(Object(T.a)({},Li))}updateStateOf(e,t){this.state.hasOwnProperty(e)&&this.state[e]!==t&&("searchText"===e&&(this.searchInput.value=t),this.updateState(Object(T.a)(Object(T.a)({},this.state),{},{[e]:t})))}onKeyPressInput(e){if(this._isSelectAllSearchText()&&this.searchResultList&&this.isTextKey(e.key)&&!this.isMultipleKeyPressed(e)&&(this.searchResultList.openTabAll(),this.searchResultList.resetContactList()),e.which==W.K_BACK_SPACE?this.state&&this.state.searchText&&""!==this.state.searchText&&fe.default.logAction(12307):""===this.state.searchText&&!this.timeoutLog&&this.isTextKey(e.key)&&(this.timeoutLog=setTimeout((()=>{this.timeoutLog=null,fe.default.logAction(1232002)}),3e3)),e.which==W.K_ESC)!0===this.isShowRecentSearch&&(this.updateState(Object(T.a)(Object(T.a)({},this.state),{},{isFocusOnRecentSearch:!1,isFocusSearchBox:!1})),this.searchInput&&this.searchInput.blur(),this.onCloseSearch()),""!=this.searchInput.value?this.clearSearch(!1):this.clearSearch(!0);else if(e.which==W.K_ENTER){let e=this.searchResultList||this.recentSearchList;if(e&&this.state.searchText){let t=e.selectFocusedConversation(!0);setTimeout((()=>{this.state.conversation?this.focusSearchBox():Le.a.isThreadHidden(t)||N.default.send(P.ChatBoxActions.FOCUS_INPUT,{userId:t,windowId:yt.c})}),0)}}else if(e.which==W.K_UP||e.which==W.K_DOWN){this.searchResultList&&fe.default.logAction(12317);let t=this.searchResultList||this.recentSearchList;t&&(e.stopPropagation(),e.preventDefault(),e.which==W.K_UP?t.moveUp():t.moveDown())}}onAbortSearch(){vi.a.getInstance().abortSearch()}onKeywordChange(e,t){let s="";if(s=!e&&t?t:e.target.value,s&&(s=A.default.ZSafeFunction((()=>s.normalize()),s)),this.countTimeUseGlobalSearch||(this.countTimeUseGlobalSearch=fi.a.now(),this.countSelectTopRes=0),s){const e=Ei.a.formatTextSearch(this.lastTextSearch),t=Ei.a.formatTextSearch(s);A.default.log("searching: true"),U.default.stagingAccount&&this._checkOnAdminMode(s),this.trackSearch||(this.trackSearch=!0,fe.default.logAction(12318)),this.updateState(Object(T.a)(Object(T.a)({},this.state),{},{searchText:s})),this.countQuery=Fi.next(),this.functionSearchByName(s,this.countQuery,e!==t)}else{this._resetCacheResultSearch();vi.a.getInstance().abortSearch(),this.clearSearch(!1)}}onFocusInput(){Ti.a.onNewSession(yt.c),this.searchInput&&""!==this.searchInput.value&&this.searchInput.select(),this.updateState(Object(T.a)(Object(T.a)({},this.state),{},{isFocusSearchBox:!0})),fe.default.logAction(1232001)}onBlurInput(){setTimeout((()=>{this.updateState(Object(T.a)(Object(T.a)({},this.state),{},{isFocusSearchBox:!1})),this.searchInput&&""==this.searchInput.value&&this.qosLogSearch()}),20)}onclickCloseSearchButton(e){this.setRecentSearchFocusState(!1),this.onCloseSearch(),this._resetCacheResultSearch(),this.clearSearch(!this.state.conversation),fe.default.logAction(1232003),e&&(e.stopPropagation(),e.preventDefault())}onClickClearSearch(){ye.p.resetGlobalSearchMode(),this.state.conversation&&fe.default.logAction(12314),this._resetCacheResultSearch(),this.clearSearch(!this.state.conversation),this.focusSearchBox(),fe.default.logAction(1232006)}onSearchKeyword(e){"string"==typeof e&&this.searchInput&&(this.searchInput.value=e,this.onKeywordChange(null,e),yi.a.addCacheKeyword(e))}onRemoveKeyword(e){"string"==typeof e&&yi.a.removeCacheKeyword(e)}onFileSelect(e){null!=e&&e.msgId&&(this.updateStateOf("highlightId",e.msgId),this.state.searchText&&yi.a.addCacheKeyword(this.state.searchText))}setRecentSearchFocusState(e,t=!1,s=!1){if(!s){const t=this.sidebarController.getSelectedId();if(this.state.isFocusOnRecentSearch===e||t&&this.state.highlightId===t&&!e)return}this.state.isFocusOnRecentSearch=e,e&&(this.closeBySendingMsg=!1),Object(Zs.g)(this.name,yt.c)}onCloseSearch(){var e,t;fe.default.logAction(1232004),0==(null===(e=this.state.searchResult)||void 0===e||null===(t=e.messages)||void 0===t?void 0:t.length)&&fe.default.logAction(1232202),this.qosLogSearch()}focusSearchBox(e=!1){this.searchInput&&(this.searchInput.focus(),e&&setTimeout((()=>{this.searchInput.select()}),0))}openRecentSearch(){this.searchInput?this.searchInput.focus():this.setRecentSearchFocusState(!0)}loadCachedMessages(e,t,s){var i,a;if(!this.dataLoaded)return void(s&&s(null,-1));let n="";if(!this.state.searchText)return;n=this.state.searchText;const r=()=>!(!this.state.searchText||!this.isKeywordStale(n)),o=!(!e||!e.timeFrom&&!e.timeTo&&"string"!=typeof e.sender),c=[],l=t?this.dataLoaded.indexCurrent:0,d=Math.min(l+20,this.dataLoaded.allSearchedMsgs.length);if(t||delete this.dataLoaded.oldestIndex,e&&e.timeFrom&&this.dataLoaded.oldestIndex&&d>=this.dataLoaded.oldestIndex)return void(s&&s(null,-1,!1));if(d<=l)return void(s&&s(null,-1,!1));this.updateState(Object(T.a)(Object(T.a)({},this.state),{},{searching:!0}));let h=this.dataLoaded.allSearchedMsgs.slice(l,d);this.dataLoaded.indexCurrent=d;const u=i=>{let a=[];if(this.loadingMore=!1,this.isSearchingMsg=!1,r())s&&s(null,-1);else if(i&&i.listConv&&i.arr){if(this.convListController.getRecentContacts().forEach((e=>{let t=i.listConv.indexOf(e.userId);if(t>=0&&!Le.a.isThreadHidden(e.userId))for(let s=t;s<i.listConv.length;++s)i.listConv[s]==e.userId&&(i.arr[s].conversation=e)})),i.arr.forEach((t=>{if(o){if(!t.message)return;if(e&&"string"==typeof e.sender&&e.sender!==t.message.fromUid)return;if(e&&e.timeFrom&&e.timeFrom>t.message.sendDttm)return void(this.dataLoaded.oldestIndex=this.dataLoaded.indexCurrent);if(e&&e.timeTo&&e.timeTo<t.message.sendDttm)return}Object.keys(t.conversation).length>1&&a.push(t)})),Array.prototype.push.apply(c,a),!r()&&this.isFirstLoadSuccess){if(t&&this.state.searchResult.messages){var n;const e=null===(n=this.state.searchResult.messages[this.state.searchResult.messages.length-1])||void 0===n?void 0:n.message;e&&e.sendDttm<i.maxTime?(a=this.state.searchResult.messages.concat(a),a=a.sort(((e,t)=>t.message.sendDttm-e.message.sendDttm))):a=this.state.searchResult.messages.concat(a)}this.updateState(Object(T.a)(Object(T.a)({},this.state),{},{searchResult:Object(T.a)(Object(T.a)({},this.state.searchResult),{},{isMoreMsg:d<this.dataLoaded.allSearchedMsgs.length,messages:a}),searching:!1}));const r=!(o&&e.timeFrom&&d>=this.dataLoaded.allSearchedMsgs.length);s&&s(c,this.pageLoad,r)}}};pi.a.logTrace(`load more msg with key ${n} - msgID length: ${h.length} - ${d}/${null===(i=this.dataLoaded)||void 0===i||null===(a=i.allSearchedMsgs)||void 0===a?void 0:a.length}`),this.isSearchingMsg=!0;vi.a.getInstance().getMessages(h,r).then((e=>{u(e)})).catch((e=>{s&&s(null,-1)})).finally((()=>{this.isSearchingMsg=!1,this.updateState(Object(T.a)(Object(T.a)({},this.state),{},{searching:!1}))}))}loadMessagesV2(e,t=!1,s){return this.loadCachedMessages(e,t,s)}loadMoreMessagesWithMsgIdsLoaded(e,t=!1,s){return this.loadCachedMessages(e,t,s)}isCanLoadMoreWithMsgIdsLoaded(){return!!(this.dataLoaded&&A.default.valueValid(this.dataLoaded.indexCurrent)&&A.default.valueValid(this.dataLoaded.allSearchedMsgs))&&!(this.dataLoaded.allSearchedMsgs.length<=this.dataLoaded.indexCurrent)}loadMoreMessagesWithRange(e,t,s,i){var a,n,r;let o=this.state.searchText;if(!o)return;let c=null===(a=this.searchResultList)||void 0===a?void 0:a.getRange(!t);if(c.timeTo<this.oldestTime)return;const l=!(!i||!i.timeFrom&&!i.timeTo&&"string"!=typeof i.sender),d=()=>!(!this.state.searchText||!this.isKeywordStale(o));this.updateState(Object(T.a)(Object(T.a)({},this.state),{},{searchResult:Object(T.a)(Object(T.a)({},this.state.searchResult),{},{messages:t?null===(n=this.state.searchResult)||void 0===n?void 0:n.messages:null,isMoreMsg:!!t&&(null===(r=this.state.searchResult)||void 0===r?void 0:r.isMoreMsg)}),searching:!0}));const h=e=>{this.isSearchingMsg=!1;let a=[],n=[];if(d())return this.pageLoad++,void(s&&s(null,-1));if(!e||!e.listConv||!e.arr)return void(s&&s(null,-1));this.convListController.getRecentContacts().forEach((t=>{let s=e.listConv.indexOf(t.userId);if(s>=0&&!Le.a.isThreadHidden(t.userId))for(let i=s;i<e.listConv.length;++i)e.listConv[i]==t.userId&&(e.arr[i].conversation=t)})),e.arr.forEach((e=>{l&&i&&"string"==typeof i.sender&&i.sender!==e.message.fromUid||Object.keys(e.conversation).length>1&&n.push(e)})),Array.prototype.push.apply(a,n),t&&(n=this.state.searchResult.messages.concat(n)),this.dataLoaded?(e.dataLoaded.allSearchedMsgs&&(this.dataLoaded.allSearchedMsgs=this.dataLoaded.allSearchedMsgs.concat(e.dataLoaded.allSearchedMsgs)),e.dataLoaded.indexCurrent&&(this.dataLoaded.indexCurrent+=e.dataLoaded.indexCurrent)):this.dataLoaded=e.dataLoaded;const r=!(l&&i.timeFrom&&n.length<this.dataLoaded.allSearchedMsgs.length);this.updateState(Object(T.a)(Object(T.a)({},this.state),{},{searchResult:Object(T.a)(Object(T.a)({},this.state.searchResult),{},{messages:n,isMoreMsg:!(!n.length&&!this.dataLoaded.allSearchedMsgs.length)&&n.length<this.dataLoaded.allSearchedMsgs.length}),searching:!1})),s&&s(a,this.pageLoad,r)};let u={totalItemReq:4};pi.a.logTrace(`load more msg with range: ${c.timeFrom} - ${c.timeTo}`),this.isSearchingMsg=!0;vi.a.getInstance().searchGlobalMessagesV3(o,d,void 0,null,U.default.limit_result_msg_search+1,c,u).then((e=>h(e))).catch((e=>{this.loadingMore=!1,s&&s(null,-1),A.default.logCoreError("searchGlobalMsg v2 "+e)})).finally((()=>{this.isSearchingMsg=!1,this.updateState(Object(T.a)(Object(T.a)({},this.state),{},{searching:!1}))}))}loadMoreMessagesV2(e,t=!1,s,i){if(this.isFirstLoadSuccess&&!this.isSearchingMsg)return U.default.enable_optimize_search&&!Oi.a.isSearchOnSqlite3()?this.loadCachedMessages(i,t,s):t&&this.isCanLoadMoreWithMsgIdsLoaded()?this.loadMoreMessagesWithMsgIdsLoaded(i,t,s):(t||(this.dataLoaded=null),this.loadMoreMessagesWithRange(e,t,s,i));s&&s(null,-1)}loadMoreMessages(){let e=this.state.searchResult;if(Oi.a.isSearchOnSqlite3()&&e&&e.rawSearchResult&&e.messageList&&e.rawSearchResult.length>e.lastOffset&&!this.loadingMore){this.loadingMore=!0;const t=this.state.conversation.userId;vi.a.getInstance().getMessageOfConversation(e.rawSearchResult,this.state.conversation.userId,20,e.lastOffset).then((s=>{let i=s.list;if(this.state.conversation&&t==this.state.conversation.userId){let t=A.default.ZSafeFunction((()=>Math.max(0,e.rawSearchResult.length-e.lastOffset-20)+e.messageList.length+i.length),s.len);i.length>0?this.updateState(Object(T.a)(Object(T.a)({},this.state),{},{searchResult:Object(T.a)(Object(T.a)({},this.state.searchResult),{},{messageList:this.state.searchResult.messageList.concat(i.map((e=>({message:e,conversation:this.state.conversation})))),realLen:t,lastOffset:this.state.searchResult.lastOffset+20})})):this.state&&this.state.searchResult&&(this.state.searchResult.realLen!==t?this.updateState(Object(T.a)(Object(T.a)({},this.state),{},{searchResult:Object(T.a)(Object(T.a)({},this.state.searchResult),{},{realLen:t,lastOffset:e.lastOffset+20})})):this.state.searchResult.lastOffset+=20)}this.loadingMore=!1}))}}loadMoreFiles(){let e=this.state.searchResult,t=this.state.searchText;if(e&&e.rawFileResult&&e.files&&e.rawFileResult.length>e.lastFileOffset&&!this.loadingMoreFiles){this.loadingMoreFiles=!0;const s=e.rawFileResult.slice(e.lastFileOffset,e.lastFileOffset+20),a=new Map;s.forEach((e=>{const t=e.convId;a.has(t)||a.set(t,[]),a.set(t,a.get(t).concat(e.msgId))}));const n=i.ModuleContainer.resolve(mi.a),r=[];a.forEach(((e,t)=>{r.push(n.getMultiMedias("file",t,e).then((e=>({convID:t,media:e}))))})),Promise.all(r).then((i=>{if(this.loadingMoreFiles=!1,this.isKeywordStale(t))return;e=this.state.searchResult;const a=s.map((e=>{const t=i.find((t=>t.convID===e.convId));if(t)return t.media.find((t=>t.msgId===e.msgId))})).filter(Boolean);let n=A.default.ZSafeFunction((()=>Math.max(0,e.rawFileResult.length-e.lastFileOffset-20)+e.files.length+a.length),e.realFileLen),r=this.state.searchResult.files.concat(a);r.sort(((e,t)=>parseInt(t.sendDttm)-parseInt(e.sendDttm))),this.updateState(Object(T.a)(Object(T.a)({},this.state),{},{searchResult:Object(T.a)(Object(T.a)({},this.state.searchResult),{},{files:r,realFileLen:n,lastFileOffset:e.lastFileOffset+20})}))})).catch((e=>{this.loadingMoreFiles=!1,A.default.logCoreError("_loadMoreFiles ",e)}))}}qosLogSearch(){this.countTimeUseGlobalSearch&&(Si.default.increaseSuccess(97111,0,fi.a.now()-this.countTimeUseGlobalSearch),this.countTimeUseGlobalSearch=0),this.countSelectTopRes>=0&&(Si.default.increaseSuccess(97112,0,this.countSelectTopRes),this.countSelectTopRes=-1)}selectTopRes(){this.countSelectTopRes>=0&&this.countSelectTopRes++}selectResult(e,t=!1,s=!1,i=!1){var a;const n=this.state.searchText;let r=!!this.state.conversation;Kt.a.jumpToMessage(e.message,null===(a=e.conversation)||void 0===a?void 0:a.userId,xs.f).then((t=>{const{groupMsgs:s=[]}=t;let i=null;A.default.ZSafeFunction((()=>{if(s)for(let t=0;t<s.length;t++)if(s[t].msgId==e.message.msgId)return i=Object(T.a)({},s[t]),void(i.searchKeyWord=n)}),null),this.state.searchText&&yi.a.addCacheKeyword(this.state.searchText),N.default.send(P.ChatBoxActions.OPEN_CONV_JUMP_TO_MESSAGE_SEARCH,{messages:s,focusId:[""+e.message.msgId],conversation:e.conversation}),i&&Object(xs.f)({type:P.ChatBoxActions.UPDATE_MESSAGE_ATTRIBUTES,payload:i})})).catch((t=>{A.default.logCoreError(t),ai.a.createWarning(ni.default.str("STR_MESSAGE_NOT_FOUND")),i||N.default.send(P.ChatBoxActions.OPEN_CONV_JUMP_TO_MESSAGE_SEARCH,{messages:[],focusId:[],conversation:e.conversation})})),r?(s&&this.focusSearchBox(),this.updateState(Object(T.a)(Object(T.a)({},this.state),{},{highlightId:e.message.msgId}))):t||this.updateState(Object(T.a)(Object(T.a)({},this.state),{},{highlightId:e.message.msgId}))}getRecentSearchItems(){if(0===U.default.recent_search.is_enable)return[];let e=yi.a.getLocalRecentSearchList();if(!e)return[];let t=Fe.default.getGroupsListSync(),s=t||[];return e=e.filter((e=>{if(e&&e.userId&&!Le.a.isThreadHidden(e.userId)){if(e.userId.startsWith(W.GROUPID_PREFIX)||1===e.type){let t=!1;1!==e.type||e.userId.startsWith(W.GROUPID_PREFIX)||(e.userId=W.GROUPID_PREFIX+e.userId);for(let i of s)if(i.userId&&e.userId==i.userId){t=!0;break}return!!t||(yi.a.removeLocalRecentSearchList(e.userId),!1)}return!0}return!1})),e}getCacheRecentSearch(){return this.cacheSearch.items=this.getRecentSearchItems(),U.default.sync_recent_search.enable_kw&&(this.cacheSearch.keywords=yi.a.getLocalKeywordList()),this.cacheSearch}getPageLoad(){return this.pageLoad}getSearchInputRef(){return this.searchInput}getSearchState(){return this.state}clearSearch(e=!0){if(this._resetCacheResultSearch(),this.onAbortSearch(),this.dataLoaded=null,this.searchInput.value="",this.lastTextSearch="",e){if(_i.b.setMode(_i.a.NORMAL),this.updateState(Object(T.a)({},Li)),this.sidebarController.getState(yt.c).currentTab==Ks.SidebarTab.FILE_TAB)return void this.functionSearchByName(null,this.countQuery,!0)}else this.updateState(Object(T.a)(Object(T.a)({},this.state),{},{searchText:"",searching:!0,highlightId:""})),this.functionSearchByName("",this.countQuery,!0)}_resetCacheResultSearch(){this.curQuery="",this.cacheResSearch=null,this.trackSearch=!1,this.trackSearchVietnamese=!1}_checkOnAdminMode(e){let t=this.__checkOnAdminMode(e);t&&(1===t?(this.clearAdminMode&&clearTimeout(this.clearAdminMode),U.default.adminMode=!0,this.sidebarController.togglePerfTab(!0),this.clearAdminMode=setTimeout((()=>{this.clearAdminMode=void 0,U.default.adminMode=void 0,this.sidebarController.togglePerfTab()}),216e5)):2===t&&(this.clearAdminMode&&(clearTimeout(this.clearAdminMode),this.clearAdminMode=void 0),U.default.adminMode=!1,this.sidebarController.togglePerfTab(!1)))}__checkOnAdminMode(e){if(e&&"string"==typeof e&&e.startsWith("$##")){return e.substring(3)===U.default.zAminKey?1:2}return 0}_innerSearchFunc(e,t,s=!0){if(!Fi.valid(t))return;if(this.sidebarController.getState(yt.c).currentTab===Ks.SidebarTab.FILE_TAB)N.default.send(P.SideBarActions.SEARCH_FILE,{term:e});else if(this.state.conversation)this.filterByConversation(e,this.state.conversation);else{const t=s&&this.isKeywordStale(this.lastTextSearch),a=Ei.a.formatTextSearch(e);var i;if(this.logSearch(`[Search flow] start search-------: ${t}, ${a}`),!a)null===(i=this.searchResultList)||void 0===i||i.forceStopSearch(),this.updateState(Object(T.a)(Object(T.a)({},this.state),{},{searchResult:Object(T.a)(Object(T.a)({},this.state.searchResult),{},{messages:null,files:[],rawFileResult:[]})}));this._searchGlobal(e,t)}}debounceSearchMsgAndFile(e,t){this._timeDebounceSearch&&clearTimeout(this._timeDebounceSearch),this._timeDebounceSearch=setTimeout((()=>{e()}),t)}getTimeDebounceSearchMsgAndFile(){return vi.a.getInstance().isEnableSearchSqlite?U.default.debounce_search_msg:U.default.debounce_search_msg_optimize}_searchGlobal(e,t=!0){var s,a,n,r,o,c;wi.default.createCPUUsageRecorder(wi.CPUMetricName.search_global).start().then((e=>this._trackCPUUsageOnSearching(e))),this.lastTextSearchTs=Date.now(),this.lastTextSearch=e;let l=2,d=0,h={},u=this.convDataManager.getAllConvSync(),g=this.previewDataManager.getAllPreviewsSync(),m=A.default.simpleStripVietnamese(e,!1);const p=(s,i)=>{s!==Di.STEP_DIRECTORY&&s!==Di.STEP_FILES&&l--;let a,n=1==l&&s===Di.STEP_CONTACT&&0==d;if(a=!!(l>1||n),this.updateState(Object(T.a)(Object(T.a)({},this.state),{},{searchResult:i,searching:a})),s===Di.STEP_CONTACT&&t&&(U.default.enable_optimize_search?this.debounceSearchMsgAndFile((()=>{f()?pi.a.logTrace(`abort debound search msg: ${e}`):(pi.a.logTrace(`do search msg & file: ${e}`),_(i&&!i.all.length),U.default.tabbedGlobalSearchResult&&_i.b.setMode(_i.a.SEARCHING),U.default.enableFileGlobalSearch&&v())}),this.getTimeDebounceSearchMsgAndFile()):(_(i&&!i.all.length),U.default.tabbedGlobalSearchResult&&_i.b.setMode(_i.a.SEARCHING),U.default.enableFileGlobalSearch&&v())),0==l&&!this.isKeywordStale(e)){let e=Date.now()-this.lastTextSearchTs;e>2e3?this._upSearchDelay():e<600&&this._downSearchDelay()}this.isKeywordStale(e)||this._trackPerformanceSearch(s,i,Date.now()-this.lastTextSearchTs)},f=()=>!!this.isKeywordStale(e),v=()=>{if(U.default.adminConfig&&U.default.adminConfig.offglobalSearchMessage)return setTimeout((()=>{this.state&&!this.isKeywordStale(e)&&p(Di.STEP_FILES,this.state.searchResult)}),100);const t=(t,s=!0)=>{var a,n;if(this.isKeywordStale(e))return;(null!=t&&t.length||!s)&&Mi.a.fileUIVisible(fi.a.now(),(null==t?void 0:t.length)||0);let r=new Set;const o=[];var c,l,h,u,g,m;if((t.forEach((e=>{const t=e.msgId;t&&!r.has(t)&&(r.add(t),o.push({msgId:t,convId:e.convId}))})),(null===(a=this.state.searchResult)||void 0===a||null===(n=a.rawFileResult)||void 0===n?void 0:n.length)>=20&&(null==o?void 0:o.length)>=20)&&((null===(c=this.state.searchResult)||void 0===c||null===(l=c.rawFileResult[0])||void 0===l?void 0:l.msgId)==(null===(h=o[0])||void 0===h?void 0:h.msgId)&&(null===(u=this.state.searchResult)||void 0===u||null===(g=u.rawFileResult[19])||void 0===g?void 0:g.msgId)==(null===(m=o[19])||void 0===m?void 0:m.msgId)))return void this.updateState(Object(T.a)(Object(T.a)({},this.state),{},{searchResult:Object(T.a)(Object(T.a)({},this.state.searchResult),{},{rawFileResult:o,realFileLen:o.length})}),!1);const f=o.slice(0,20),v=new Map;f.forEach((e=>{const t=e.convId;v.has(t)||v.set(t,[]),v.set(t,v.get(t).concat(e.msgId))}));const _=i.ModuleContainer.resolve(mi.a),b=[];v.forEach(((e,t)=>{b.push(_.getMultiMedias("file",t,e).then((e=>({convID:t,media:e}))))})),Promise.all(b).then((t=>{if(this.isKeywordStale(e))return;const s=f.map((e=>{const s=t.find((t=>t.convID===e.convId));if(s)return s.media.find((t=>t.msgId===e.msgId))})).filter(Boolean);let i=[],a=0,n=0;for(const e of s)e?(i.push(e),a++):n++;i.sort(((e,t)=>parseInt(t.sendDttm)-parseInt(e.sendDttm)));let r=this.state.searchResult;A.default.log("search files: cur = "+r.searchKey+" this query = "+e,i.length),r=r?Object(T.a)({},r):{},r.files=i,r.realFileLen=o.length-n,r.rawFileResult=o,r.lastFileOffset=f.length,r.searchKey=e,d+=a,p(Di.STEP_FILES,r)})).catch((t=>{A.default.logCoreError("doSearchFiles "+t),this.state&&!this.isKeywordStale(e)&&p(Di.STEP_FILES,this.state.searchResult)}))};Mi.a.startQueryFile(fi.a.now());vi.a.getInstance().search(e,null,{msgType:W.MSG_FILE},t,{enableReject:!0}).then((e=>{t(e,!1)})).catch((e=>{this.state.searchResult.files&&this.state.searchResult.files.length||this.updateState(Object(T.a)(Object(T.a)({},this.state),{},{searchResult:Object(T.a)(Object(T.a)({},this.state.searchResult),{},{files:[]})}),!0)}))},_=(t=!1)=>{if(U.default.adminConfig&&U.default.adminConfig.offglobalSearchMessage)return setTimeout((()=>{this.state&&!this.isKeywordStale(e)&&p(Di.STEP_MESSAGES,this.state.searchResult)}),100);this.logSearch(`[Search flow] search msg: ${e}`);const s=(t,s=!1)=>{var i;if(s&&(this.isSearchingMsg=!1),this.logSearch(`[Search flow] search msg res first load: ${e}, ${null===(i=t.arr)||void 0===i?void 0:i.length}`),this.pageLoad=0,this.timeouResetDataMsg&&(clearTimeout(this.timeouResetDataMsg),this.timeouResetDataMsg=!1,this.updateState(Object(T.a)(Object(T.a)({},this.state),{},{searchResult:Object(T.a)(Object(T.a)({},this.state.searchResult),{},{messages:null})}),!1)),!this.isKeywordStale(e)&&t){let i=[],r=0;t&&t.listConv&&t.arr&&u.forEach((e=>{let s=t.listConv.indexOf(e.userId);if(s>=0&&!Le.a.isThreadHidden(e.userId))for(let a=s;a<t.listConv.length;++a)t.listConv[a]==e.userId&&(t.arr[a].conversation=e,r+=1,i.push(t.arr[a]))}));let o=this.state.searchResult,c=i;var a;if(o.messages&&(c=o.messages.slice(),Array.prototype.push.apply(c,i)),c.sort(((e,t)=>parseInt(t.message.sendDttm)-parseInt(e.message.sendDttm))),o=o?Object(T.a)({},o):{},o.messages=c,o.searchKey=e,o.isMoreMsg=t.isMoreMsg,this.dataLoaded=t.dataLoaded,d+=r,s)this.isFirstLoadSuccess=!0,this.searchResultList&&n&&this.searchResultList.updateFirstLoadPos(n.timeFrom),A.default.logCoreError("[Global search] check First data",e,null===(a=this.state.searchResult.messages)||void 0===a?void 0:a.length);else if(!i.length)return;p(Di.STEP_MESSAGES,o)}};let i=null;var a;this.searchResultList&&(!this.timeouResetDataMsg&&this.state.searchResult.messages&&(this.timeouResetDataMsg=setTimeout((()=>{this.timeouResetDataMsg=!1,this.updateState(Object(T.a)(Object(T.a)({},this.state),{},{searchResult:Object(T.a)(Object(T.a)({},this.state.searchResult),{},{messages:null})})),this.searchResultList&&this.searchResultList.resetDataSearch()}),1e3)),this.searchResultList.resetDataSearch(),Oi.a.isSearchOnSqlite3()&&(i=null===(a=this.searchResultList)||void 0===a?void 0:a.getRange(),this.updateState(Object(T.a)(Object(T.a)({},this.state),{},{filter:{timeFrom:i.timeFrom,timeTo:i.timeTo}}),!1)));const n=Object(T.a)({},i);this.updateState(Object(T.a)(Object(T.a)({},this.state),{},{searching:!0,highlightId:"",searchResult:Object(T.a)(Object(T.a)({},this.state.searchResult),{},{messages:!this.lastTextSearch||e.length<this.lastTextSearch.length?null:this.state.searchResult.messages})})),this.loadingMore=!1,this.isFirstLoadSuccess=!1;let r={};t||(r.totalItemReq=4);const o=vi.a.getInstance();Mi.a.startQueryMsg(fi.a.now(),o.isEnableSearchSqlite),this.isSearchingMsg=!0,o.searchGlobalMessagesV3(e,(()=>!(!Oi.a.isSearchOnSqlite3()||this.state.filter.timeFrom==n.timeFrom&&this.state.filter.timeTo==n.timeTo)||f()),void 0,s,U.default.limit_result_msg_search+1,i,r).then((e=>s(e,!0))).catch((t=>{if(this.logSearch(`[Search flow] search msg fail: ${t}`),A.default.logCoreError("searchGlobalMsg "+t),this.state&&!this.isKeywordStale(e)){this.searchResultList&&this.searchResultList.forceStopSearch(),this.timeouResetDataMsg&&(clearTimeout(this.timeouResetDataMsg),this.timeouResetDataMsg=!1);let e=this.state.searchResult;e.messages=[],p(Di.STEP_MESSAGES,e)}})).finally((()=>{this.isSearchingMsg=!1}))};if(this.curQuery&&0!==e.indexOf(this.curQuery)&&this._resetCacheResultSearch(),!this.cacheResSearch){const e=e=>{for(const t of e){const e=t.userId||t.convId;t&&!h[e]&&(null!=t&&t.userId||(t.userId=e),null!=t&&t.infoSearch&&delete t.infoSearch,null!=t&&t.isDirectory&&delete t.isDirectory,h[e]=t)}};g.length&&e(g),e(Z.default.getFriendsSync()),e(Fe.default.getGroupsListSync())}const b=fi.a.now();Mi.a.setKeyword(e),Mi.a.resetTracking(),bi.a.search(e,this.cacheResSearch?this.cacheResSearch:h,{hasSection:!0,suggestGroupWithMember:!0,searchFriendInGroup:!0,isCalc:!0,updateLastChat:!this.cacheResSearch,searchPb:!0,searchZName:!0,searchNumPhone:!0,filterHidden:Le.a.isKeyPIN(e)}).then((t=>{var s;Mi.a.trackingContact(fi.a.now()-b,null==t||null===(s=t.all)||void 0===s?void 0:s.length);let i=this.state.searchResult;if(!this.isKeywordStale(e)){{var a;let s=[];if(Le.a.isKeyPIN(e)){fe.default.logAction(1970601);const e=Le.a.getUidsHiddenChat();if(e.length)for(let t of e){let e=!1;for(let i of u)if(i&&i.userId==t){s.push(Object(T.a)(Object(T.a)({},i),{},{infoSearch:{}})),e=!0;break}if(!e){let e=null;e=t.startsWith(W.GROUPID_PREFIX)?Fe.default.getGroupByIdSync(t):Z.default.getProfileFriendSync(t),e&&(e.lastMessageTime||(e.lastMessageTime=0),s.push(Object(T.a)(Object(T.a)({},e),{},{infoSearch:{}})))}}}this.curQuery||(this.curQuery=e),!this.cacheResSearch&&t.orderAll&&t.orderAll.constructor==Array&&t.orderAll.length>0&&(this.cacheResSearch=h),null!==(a=t.phone)&&void 0!==a&&a.length&&(t.phone=t.phone.filter((e=>e.userId))),i=i?Object(T.a)({},i):{},i.recentChat=t.recentChat,i.groups=t.groups,i.friends=t.friends,i.oa=t.oa,i.directory=t.directory,i.searchKey=e,i.phone=t.phone,i.hiddenChat=s,i.all=t.all,i.orderAll=t.orderAll,d+=(i.groups?i.groups.length:0)+(i.friends?i.friends.length:0)+(i.oa?i.oa.length:0),d+=(i.recentChat?i.recentChat.length:0)+i.hiddenChat.length}p(Di.STEP_CONTACT,i)}})).catch((e=>{A.default.logCoreError(e)})),0==(null===(s=this.state.searchResult)||void 0===s||null===(a=s.messages)||void 0===a?void 0:a.length)&&0==(null===(n=this.state.searchResult)||void 0===n||null===(r=n.all)||void 0===r?void 0:r.length)&&0==(null===(o=this.state.searchResult)||void 0===o||null===(c=o.files)||void 0===c?void 0:c.length)&&fe.default.logAction(1232201),m===e||this.trackSearchVietnamese||(this.trackSearchVietnamese=!0,fe.default.logAction(1232010))}filterByConversation(e,t){if(!e)return this.searchInput.value="",void this.updateState(Object(T.a)(Object(T.a)({},Li),{},{conversation:t,searching:!1,highlightId:""}));let s=(s,i=!1)=>{if(this.isKeywordStale(e))return void A.default.logCoreError("search: abort filtermode 1",this.state.searchText,e);if(i&&(!s||0==s.length))return;vi.a.getInstance().getMessageOfConversation(s,t.userId,20).then((a=>{if(this.isKeywordStale(e))return void A.default.logCoreError("search: abort filtermode 2",this.state.searchText,e);let n=a.list;if(i&&(!n||0===n.length))return;let r=n.length<20&&s.length>20;n.length>0?(this.updateState(Object(T.a)(Object(T.a)({},this.state),{},{conversation:t,searchResult:{messageList:n.map((e=>({message:e,conversation:t}))),realLen:a.len,rawSearchResult:s,lastOffset:20,progress:i},searching:!1,highlightId:n[0].msgId})),i||(this.focusSearchBox(),r&&this.loadMoreMessages()),!i&&this.searchResultList&&this.searchResultList.scrollToTop&&this.searchResultList.scrollToTop()):(this.updateState(Object(T.a)(Object(T.a)({},this.state),{},{conversation:t,searchResult:{messageList:[],realLen:0,lastOffset:0,progress:!1},searching:!1,highlightId:""})),this.focusSearchBox(),!i&&r&&this.loadMoreMessages())}))};vi.a.getInstance().search(e,null,{convId:t.userId+""},(e=>{s(e,!0)})).then((e=>{s(e)}))}_getSearchDelaySetting(){return 70}_upSearchDelay(){let e=this.searchDelay;this.searchDelay=Math.min(400,Math.round(1.1*this.searchDelay+10*Math.random())),e!==this.searchDelay&&this._resetSearchFunction()}_downSearchDelay(){let e=this.searchDelay;this.searchDelay=Math.max(70,Math.round(.9*this.searchDelay+10*Math.random())),e!==this.searchDelay&&this._resetSearchFunction()}_resetSearchFunction(){A.default.logCoreError("__rssf__",this.searchDelay),this.functionSearchByName=A.default.throttle(this._innerSearchFunc,this.searchDelay)}_isSelectAllSearchText(){if(this.searchInput){const e=this.searchInput.selectionStart,t=this.searchInput.selectionEnd;return!(!this.searchInput.value.length||0!=e||t!=this.searchInput.value.length)}return!1}_trackPerformanceSearch(e,t,s){var i,a,n,r,o;const c={[Di.STEP_MESSAGES]:"msg",[Di.STEP_FILES]:"file",[Di.STEP_CONTACT]:"contact"}[e];let l={[Di.STEP_MESSAGES]:null==t||null===(i=t.messages)||void 0===i?void 0:i.length,[Di.STEP_FILES]:null==t||null===(a=t.files)||void 0===a?void 0:a.length,[Di.STEP_CONTACT]:((null==t||null===(n=t.groups)||void 0===n?void 0:n.length)||0)+((null==t||null===(r=t.friends)||void 0===r?void 0:r.length)||0)+((null==t||null===(o=t.oa)||void 0===o?void 0:o.length)||0)}[e]||0;if(c&&l){Object(Ri.b)().logInfo(Ri.a.GlobalSearch,{duration:s,search_type:c,result_size:l})}}_trackCPUUsageOnSearching(e){if(!e)return;Object(Ri.b)().logInfo(Ri.a.CPU_GlobalSearch,{cpu:e.cpu,duration:e.endAt-e.startAt,process:e.processes.map((e=>({cpu:e.cpu,name:e.name,type:e.type})))})}init(){}getItem(e){return this.state}getList(e){throw new Error("No imp!!!")}onGetItemFailure(e){}onGetListFailure(e){}loadOldestTime(){this.loadOldestTimeWithRetry(U.default.sqlite_mac.max_load_oldest_time_retry).then((e=>{this.oldestTime=e})).catch((e=>{pi.a.logError("loadOldestTime fail after retrying",e),this.oldestTime=0}))}async loadOldestTimeWithRetry(e){return new Promise(((t,s)=>{vi.a.getInstance().getOldestTime().then((e=>{e&&e.length&&!isNaN(e[0].ts)?t(+e[0].ts):t(0)})).catch((i=>{pi.a.logError("loadOldestTime fail",`remaining times: ${e}`,i),e>0?setTimeout((()=>{this.loadOldestTimeWithRetry(e-1).then(t).catch(s)}),0):s(i)}))}))}getOldestTime(){return this.oldestTime}getTotalQueriedMsgIds(){var e,t;return null===(e=this.dataLoaded)||void 0===e||null===(t=e.allSearchedMsgs)||void 0===t?void 0:t.length}})||gi)||gi)||gi)||gi)||gi);var Ai,Ni=s("dThN"),ki=s("jnrz"),Pi=s("Anfm"),ji=s("BZLJ"),Ui=(s("L+5E"),s("A9FD")),Bi=s("BKm0"),Gi=s("iKSP");const zi={windowId:yt.c,theme:zt.a.default,currentTab:Ks.SidebarTab.MESSAGE_TAB,previousTab:Ks.SidebarTab.MESSAGE_TAB,selectedId:null,previousId:null,showExportImportEntry:!0},xi="z_sendtome_bubbledot",Vi="SIDEBAR CONTROLLER";function Hi(...e){A.default.logCoreInfo(`[${Vi}] - `,e)}Object(m.j)()(Ai=Object(ie.b)(Ks.SidebarController)(Ai=function(e,t){return i.ModuleContainer.inject(Ks.ConvListController)(e,void 0,0)}(Ai=function(e,t){return i.ModuleContainer.inject(Ci.b)(e,void 0,1)}(Ai=Reflect.metadata("design:type",Function)(Ai=Reflect.metadata("design:paramtypes",[void 0===Ks.ConvListController?Object:Ks.ConvListController,void 0===Ci.b?Object:Ci.b])(Ai=class{constructor(e,t){this.convListController=e,this.searchController=t,this.changeTabFromSearch=void 0,this._firstTimePageLoad=void 0,this._querySelect=void 0,this._convsLoaded=void 0,this._exportImportFinished=void 0,this._exportImportProgressError=void 0,this._allowAutoJumpFC=void 0,this._es=void 0,this._onSendMsg=e=>{var t,s;const i=(null==e||null===(t=e.messages)||void 0===t||null===(s=t[0])||void 0===s?void 0:s.upSrc)&W.FILE_UP_SRC.TextEditor,a=this.getState();if(a.currentTab==Ks.SidebarTab.TODO_TAB||a.currentTab==Ks.SidebarTab.CATALOG_TAB||i||e.isChild)return;const n=this.searchController.getSearchState();a.currentTab!==Ks.SidebarTab.MESSAGE_TAB||n&&n.searchText?(a.currentTab=Ks.SidebarTab.MESSAGE_TAB,Object(Zs.g)(this.name,yt.c),Object(xs.f)({type:P.SideBarActions.SHOW_CHAT_VIEW}),n&&n.searchText&&fe.default.logAction(1232007),this.searchController.clearSearch(!0)):a.currentTab==Ks.SidebarTab.MESSAGE_TAB&&this.searchController.setRecentSearchFocusState(!1,!1,!0),this.searchController.closeBySendingMsg=!0,setTimeout((()=>{this.convListController.scrollToTop(!1)}),100)},this.changeTab=(e,t=yt.c)=>{const s=this._getStateByWindowId(t);let i=s.currentTab;s.currentTab!==e&&(s.currentTab=e,Object(Zs.g)(this.name,t)),this._onChangeTab(s.currentTab,i)},this.togglePerfTab=e=>{const t=this._getStateByWindowId(yt.c);t.showPerfTab!==e&&(t.showPerfTab=e,Object(Zs.g)(this.name,yt.c))},this.changeTheme=async e=>{const t=this._getStateByWindowId(yt.c);t.theme!==e&&(t.theme=e,Object(Zs.g)(this.name,yt.c))},this.selectMessageTab=()=>{this.changeTab(Ks.SidebarTab.MESSAGE_TAB)},this.selectTodoTab=()=>{this.changeTab(Ks.SidebarTab.TODO_TAB),fe.default.logAction(171),ji.h.setViewPopupTodoSrc(ji.c.TAB_ICON)},this.selectContactFromSearch=async(e,t=!1)=>{if(!e)return Hi("Select friend null!"),Promise.resolve(!1);const s=await i.ModuleContainer.resolve(Ge.b).openConversation(e.userId,Ge.d.fromSearchList(e));return!0===t?(this.searchController.onCloseSearch(),this.searchController.resetState()):this.searchController.updateStateOf("highlightId",e.userId),s?(e&&e.userId===U.default.sendToMeId&&(ti.g.getFlagForCurrentUser(this.currUser.userId,xi)||(ye.p.getHasShownSendToMeTip()?ti.g.setFlagForCurrentUser(this.currUser.userId,xi,1):setTimeout((()=>{N.default.send(P.ConversationListActions.SHOW_BUBBLE_DOT),ye.p.setHasShownSendToMeTip(!0)}),144e5)),fe.default.logAction(1390101)),Promise.resolve(!0)):(Hi("Open conv failure"),Promise.resolve(!1))},this.setupSelectConvOnPageLoad=()=>{},this.name=Ks.SIDEBAR_CONTROLLER,this.data=new Map,this.key="windowId",this.changeTabFromSearch=!1,this._firstTimePageLoad=!0,this._convsLoaded=!1,this._allowAutoJumpFC=!1,this.selectConversationForFriend=this.selectConversationForFriend.bind(this),this.listenEvents()}get currUser(){return Object(ii.c)()}get autoJumFC(){return this._allowAutoJumpFC}get eventStore(){return this._es||(this._es=s("emRR").default),this._es}onStart(e){i.ModuleContainer.resolve(Ge.b)}listenEvents(){N.default.subscribe(((e,t)=>{switch(e){case P.ChatBoxActions.SEND_MSG:this._onSendMsg(t);break;case P.ChatBoxActions.SELECT_FRIEND:this.selectConversationForFriend(t);break;case P.SideBarActions.SHOW_FILE_MANAGER:this.getState().currentTab=Ks.SidebarTab.FILE_TAB,Object(Zs.g)(this.name,yt.c);break;case P.SideBarActions.SELECT_TAB_MSG:this.changeTab(Ks.SidebarTab.MESSAGE_TAB);break;case P.FetchActions.DELETE_CONVERSATION:case P.FetchActions.GROUP_LEAVE:{const e=this.getState();e.previousId&&t===e.previousId&&(e.previousId=null);break}case P.ChatBoxActions.JUMP_TO_MESSAGE_SEARCH_HIDDEN_CHAT:case P.ChatBoxActions.JUMP_TO_MESSAGE_SEARCH:this.getState().currentTab==Ks.SidebarTab.FILE_TAB&&this.changeTab(Ks.SidebarTab.MESSAGE_TAB);break;case P.TodoActions.OPEN_TODO_LIST:{const e=oi.b.instance().getTodoView();e?e.onCheckOpenTab():this.changeTab(Ks.SidebarTab.TODO_TAB);break}case P.ActionList.ACT_OPEN_TAB_CHAT:this.selectMessageTab();break;case P.ActionList.ACT_OPEN_TAB_CONTACT:this.changeTab(Ks.SidebarTab.CONTACT_TAB);break;case P.ActionList.ACT_OPEN_GROUPLIST:if(this.getState().currentTab===Ks.SidebarTab.CONTACT_TAB){const e=oi.b.instance().getContactList();e&&e.onJumpGroupCenter()}else this.changeTab(Ks.SidebarTab.CONTACT_TAB);break;case Bi.c.EXPORT_IMPORT_START:this._exportImportFinished=!1,this._exportImportProgressError=!1;break;case Bi.c.EXPORT_IMPORT_FINISHED:this._exportImportFinished=!0,this._exportImportProgressError=!1;break;case Bi.c.IMPORT_DB_PROGRESS:case Bi.c.IMPORT_PROGRESS:case Bi.c.EXPORT_PROGRESS:case Bi.c.EXPORT_DB_PROGRESS:t&&t.error&&(this._exportImportProgressError=!0);break;case P.ConversationListActions.SELECT_CONVERSATION:{const e=this.getState();e.currentTab!==Ks.SidebarTab.FILE_TAB&&e.currentTab!==Ks.SidebarTab.CATALOG_TAB&&e.currentTab!==Ks.SidebarTab.ZCLOUD_TAB||this.changeTab(Ks.SidebarTab.MESSAGE_TAB);break}}})),Q.a.ConvInfoDataManager.addEventListener(Ys.b.DoneLoadDB,(e=>{this._convsLoaded=!0,this._autoSelectConv()})),Q.a.UnreadDataManager.addEventListener(Ys.b.DoneLoadDB,(e=>{ki.b.onDoneLoadUnreadDB(null==e?void 0:e.payload)}))}getState(e=yt.c){return this._getStateByWindowId(e)}getSelectedId(e){return this.getState(e).selectedId||null}getCurrMainConvId(){const e=this.eventStore.getState();return e&&e.chatview.view===Gi.c.CHAT_VIEW?this.getSelectedId():null}updateSelectedId(e,t=yt.c){const s=this._getStateByWindowId(t);s.selectedId!==e&&(s.previousId=e?null:s.selectedId,s.selectedId=e,Object(Zs.g)(this.name,t))}updateSelectedIdWithoutPrevious(e,t=yt.c){const s=this._getStateByWindowId(t);s.selectedId!==e&&(s.previousId=null,s.selectedId=e,Object(Zs.g)(this.name,t))}isInImportExportProcess(){const e=this._exportImportFinished||this._exportImportProgressError;return void 0!==e&&!e}openFriendCenter(){}selectConversationForFriend(e,t=!1){if(!e)return void A.default.logCoreError("friend null");if(xs.f&&(Object(xs.f)({type:P.ConversationListActions.SELECT_CONV_MINOR,payload:e}),Object(xs.f)({type:P.ChatBoxActions.READ_CONVERSATION,payload:{conversationId:e.userId}})),e.userId==this.currUser.userId)return void this._showMyProfile();let s=this.convListController.getRecentContactWithId(e.userId),i=!1;if(s)i=!0;else{let t=t=>{t&&t.includes(e.userId)&&(s=Object(T.a)({},t[e.userId]))};s||t(Fe.default.getGroupsListSync()),s||t(Z.default.getFriendsSync()),s||(s={}),Object.assign(s,e),s.isFr=s.isFr||0,s.type=s.type||W.FRIEND_TYPE_NORMAL}e.byPassPIN?s.byPassPIN=1:s.byPassPIN&&delete s.byPassPIN,setTimeout((()=>{Object(xs.f)({type:P.ConversationListActions.SELECT_CONVERSATION,payload:s})}),0);const a=this.data.get(yt.c);let n=null==a?void 0:a.currentTab;!0===t?(n=i?Ks.SidebarTab.MESSAGE_TAB:Ks.SidebarTab.CONTACT_TAB,n===Ks.SidebarTab.CONTACT_TAB&&(A.default.log("sidebar: select from search, should highlight thread"),this.changeTabFromSearch=!0),this.searchController.onCloseSearch(),this.searchController.resetState(),!e.userId||!e.byPassPIN&&Le.a.isThreadHidden(e.userId)||setTimeout((()=>{N.default.send(P.ChatBoxActions.FOCUS_INPUT,{userId:e.userId,windowId:yt.c})}),0)):this.searchController.updateStateOf("highlightId",e.userId),this.updateState(Object(T.a)(Object(T.a)({},a),{},{currentTab:n,selectedId:e.userId})),e&&e.userId===U.default.sendToMeId&&(ti.g.getFlagForCurrentUser(this.currUser.userId,xi)||(ye.p.getHasShownSendToMeTip()?ti.g.setFlagForCurrentUser(this.currUser.userId,xi,1):setTimeout((()=>{N.default.send(P.ConversationListActions.SHOW_BUBBLE_DOT),ye.p.setHasShownSendToMeTip(!0)}),144e5)))}showAddFriendModal(){fe.default.logAction(1020203),fe.default.logAction(12316),ft.ModalManagerV2.openModal({windowId:yt.c,name:W.ModalIdentitiesDefine.FIND_FRIEND})}showGroupCompose(){fe.default.logAction(1020202),Pi.c.markStart(Pi.a.CREATE_GROUP,Pi.b.Group.CREATE_GR_HEADER_ICON);const e=ye.p.getSessionUserId(),t=(e=!0)=>{ft.ModalManagerV2.openModal({windowId:yt.c,name:W.ModalIdentitiesDefine.CREATE_GROUP_COMPOSE,params:{needInitE2ee:e},forceCloseAll:!1})};!ti.g.getTimeEntryPointE2eGroup(e,Pi.b.Group.CREATE_GR_HEADER_ICON)&&U.default.e2ee.enable_group&&U.default.e2ee.group.can_enable_right_in_creation_step?ft.ModalManagerV2.openModal({windowId:yt.c,name:W.ModalIdentitiesDefine.E2EE_ONBOARDING,params:{entry:Ui.e.CREATE_GROUP,entrySrc:Pi.b.Group.CREATE_GR_HEADER_ICON,isGroup:!0,userId:"",callback:t,callbackCancel:t},forceCloseAll:!1}):t(!1)}enableAutoJupmFC(){this._allowAutoJumpFC=!0}disableAutoJupmFC(){this._allowAutoJumpFC=!1}init(){}getItem(e){const t=e.key;return this._getStateByWindowId(t)}getList(e){return Array.from(this.data.keys())}onGetItemFailure(e){}onGetListFailure(e){}updateState(e,t=yt.c,s=!0){this.data.set(t,e),s&&Object(Zs.g)(this.name,t)}_getStateByWindowId(e){let t=this.data.get(e);return t||(t=Object(T.a)({},zi),this.data.set(e,t)),t}_onChangeTab(e,t){switch(function(){switch(e){case Ks.SidebarTab.MESSAGE_TAB:fe.default.logAction(12801);break;case Ks.SidebarTab.CONTACT_TAB:fe.default.logAction(12802),3===U.default.noti_center_config.entry_position&&fe.default.logAction(1281205);break;case Ks.SidebarTab.MENTION_TAB:fe.default.logAction(12805);break;case Ks.SidebarTab.STAR_TAB:fe.default.logAction(12806);break;case Ks.SidebarTab.FILE_TAB:fe.default.logAction(133);break;case Ks.SidebarTab.TODO_TAB:3===U.default.noti_center_config.entry_position&&fe.default.logAction(1281206)}}(),ye.p.resetGlobalSearchMode(),this.searchController.clearSearch(!0),e){case Ks.SidebarTab.MESSAGE_TAB:{this._resetConversationList();const e=this.getState();!e.selectedId&&e.previousId&&this.updateSelectedId(e.previousId),Object(xs.f)({type:P.SideBarActions.SHOW_CHAT_VIEW});break}case Ks.SidebarTab.STAR_TAB:case Ks.SidebarTab.TODO_TAB:t===Ks.SidebarTab.ZCLOUD_TAB&&Object(xs.f)({type:P.SideBarActions.SHOW_CHAT_VIEW})}}_showMyProfile(){ft.ModalManagerV2.openModal({windowId:yt.c,name:W.ModalIdentitiesDefine.FRIEND_PROFILE,params:this.currUser.userId})}_resetConversationList(){}_getQueryParams(){let e={},t=window.location.search;if(t=t?t.substr(1).split("&"):null,t)for(let s=0;s<t.length;s++){let i=t[s].indexOf("=");if(i>=0){let a=t[s].slice(0,i),n=t[s].slice(i+1,t[s].length);a&&a.length>0&&n&&n.length>0&&(e[a]=decodeURIComponent(n))}}return e}_autoSelectConv(){this._querySelect&&this._convsLoaded&&(A.default.logCoreInfo(`[${this.name}] - auto select conv start`),this._querySelect(),this._querySelect=null)}})||Ai)||Ai)||Ai)||Ai)||Ai);var qi;const Wi={id:Hs.f,color:"#EA87FF",conversations:[],createTime:1634956772046,emoij:"",offset:100,text:"default"};var Zi=function(e){return e.ALL="all",e.SELECTED="selected",e}(Zi||{});Object(ie.b)(Ks.LabelDataManager)(qi=Reflect.metadata("design:type",Function)(qi=Reflect.metadata("design:paramtypes",[])(qi=class extends De.b{constructor(){super(),this.allLabels=void 0,this.selectedLabel=void 0,this.name=Ks.LABEL_DATA_MANAGER,this.data=new Map,this.key="labelId",this.allLabels=[],this.selectedLabel=[]}onLabelChange(e){const{color:t,conversations:s,createTime:i,emoij:a,offset:n,text:r}=e,o=""+e.id,c=this.data.get(o);if(!o||c&&s===c.conversations&&i==(null==c?void 0:c.createTime)&&a==c.emoij&&n==c.offset&&r===c.text&&t==c.color||(this.data.set(o,e),Object(Zs.g)(this.name,o),Object(Zs.h)(this.name,"all")),c&&c.conversations&&c.conversations.length!==s.length){let e=[];s.length>c.conversations.length?(e=s.filter((e=>!c.conversations.includes(e))),this.dispatchEvent(new Qs.c(Qs.d.LabelAddConvs,{labelId:o,convIds:e}))):(e=c.conversations.filter((e=>!s.includes(e))),this.dispatchEvent(new Qs.c(Qs.d.LabelRemoveConvs,{labelId:o,convIds:e})))}}onFetchLabels(e){if(Array.isArray(e)&&!(e.length<0)){for(let t=0;t<e.length;t++)this.onLabelChange(e[t]);this.data.forEach((t=>{const s=""+t.id;e.some((e=>e.id==s))||this.data.delete(s)})),this._updateAllLabels(e.map((e=>e.id)))}}onLabelDeleted(e){if("string"!=typeof e&&(A.default.logCoreError(`[${this.name}] - delete label invalid lid type ${e}`),e=""+e),!this.data.has(e))return void A.default.logCoreError(this.name+"Deleted not exists item!!!");const t=this.data.get(e);let s=[];t&&t.conversations&&(s=[...t.conversations]),this.data.delete(e),this._updateAllLabels(this.allLabels.filter((t=>t!==e))),this.selectedLabel.includes(e)&&this.onDeSelectLabel(e),this.dispatchEvent(new Qs.c(Qs.d.RemoveLabel,{labelId:e,convs:s})),Object(Zs.e)(this.name,e)}_updateAllLabels(e){return!A.default.shallowEqual(this.allLabels,e)&&(this.allLabels=e,Object(Zs.h)(this.name,Zi.ALL),!0)}onSelectLabel(e){this.selectedLabel=[""+e],Object(Zs.h)(this.name,Zi.SELECTED),this.selectedLabelChanged()}onDeSelectLabel(e){this.selectedLabel=this.selectedLabel.filter((t=>t!==e)),Object(Zs.h)(this.name,Zi.SELECTED),this.selectedLabelChanged()}onClearFilter(){this.selectedLabel=[],Object(Zs.h)(this.name,Zi.SELECTED),this.selectedLabelChanged()}getLabelById(e){return e?("string"!=typeof e&&(e=e.toString()),e==Hs.f?Wi:e==Hs.g?{id:Hs.g}:this.data.get(e)||null):null}getAllLabels(){return Array.from(this.data.values())}getAllLabelIds(){return this.allLabels}applyNewFilter(e){this.selectedLabel=e,Object(Zs.h)(this.name,Zi.SELECTED),this.selectedLabelChanged()}selectedLabelChanged(){this.dispatchEvent(new Qs.c(Qs.d.SelectedLabelChange,this.selectedLabel))}init(){Js.a.getAll().then((e=>{this.onFetchLabels(e)}))}getItem(e){const t=e.key;return this.getLabelById(t)}getList(e){const t=e.key;return t===Zi.ALL?this.allLabels:t===Zi.SELECTED?this.selectedLabel:[]}onGetItemFailure(e){}onGetListFailure(e){}})||qi)||qi);i.ModuleContainer.register(zs.b,qs);var Ki=s("k+R1"),Qi=s("Py3H");let $i=function(e){return e[e.FULL=0]="FULL",e[e.WINDOWED=1]="WINDOWED",e}({});var Yi=s("tQbm"),Ji=s("qzuk"),Xi=s("NMlV"),ea=s("4HQc"),ta=s("GpwQ");const sa={message:{action:"recommened.link",childnumber:0,description:"Zalo cho máy tính gửi file cực nhanh, chụp màn hình tiện lợi, trò chuyện nhóm không giới hạn.",href:`https://${U.default.CONFIG_DOMAIN}/may-tinh?utm_source=chatview&utm_campaign=reinstallpc&utm_medium=web`,params:`{"mediaTitle":"Zalo cho máy tính – Windows, Mac, Ubuntu","artist":"","src":"${U.default.CONFIG_DOMAIN}","stream_icon":"","streamUrl":"","type":0}`,thumb:"https://stc-chat.zdn.vn/images/banner/zalo-thumb-link.png",title:"Zalo cho máy tính – Windows, Mac, Ubuntu",type:"",copyLinkActionCode:null,confirmActionCode:null},msgType:6};var ia,aa=s("OU7N"),na=s("UYGI"),ra=s("X4fA"),oa=s("V8Oy"),ca=s("7WX+");let la;A.default.isWeb()||(la=s("Dprd").default);const da={conversationId:null,mode:$i.FULL,windowId:yt.c};Object(ie.b)(Yi.b)(ia=function(e,t){return i.ModuleContainer.inject(Ks.SidebarController)(e,void 0,0)}(ia=Reflect.metadata("design:type",Function)(ia=Reflect.metadata("design:paramtypes",[void 0===Ks.SidebarController?Object:Ks.SidebarController])(ia=class extends De.b{constructor(e){super(),this.sidebar=e,this.data=new Map,this.onLogOut=()=>{if(aa.d.isCalling())return void ai.a.createWarning(ni.default.str("STR_SIGNOUT_WITH_CALL"));let e=ye.p.getSessionUserId(),t="STR_LOGOUT_CONFIRM",s=+na.b.isUploading();if(!s&&la&&la.isDownloading()&&(s=2),s>0){const e=1===s?ni.default.str("STR_TITLE_BAR_SEND"):ni.default.str("STR_TITLE_BAR_RECEIVE");t=ni.default.str("STR_LOGOUT_CANCEL_FILE")+` ${e} `+ni.default.str("STR_TITLE_BAR_EXIT_ZALO_P2")}ra.default.getLogoutToken(),ri.ConfirmManagerV2.openConfirm({windowId:yt.c,name:W.MODAL_CONFIRM.confirmIdentities,params:{message:ni.default.str(t),okText:ni.default.str("STR_LOGOUT_YES"),cancelText:ni.default.str("STR_LOGOUT_NO"),onOk:this.doLogout,options:[{default_val:ti.g.isSetClearData(e),key:"del_history",title:"STR_LOGOUT_DEL_HISTORY"}],"data-id":{confirmBtn:"btn_Logout_Logout",cancelBtn:"btn_Logout_No"}}})},this.openConversationInNewWindow=async e=>{throw new Error("Method not implemented.")},this.openScreenCapture=async()=>{fe.default.logAction(12808),N.default.send(P.ChatBoxActions.SIDEBAR_CAPTURE)},this.openZaloSupport=async()=>{const e=U.default.supportPage;return e?i.ModuleContainer.resolve(Ge.b).openConversation(e,Ge.d.fromSupport()):Promise.resolve(!1)},this.openUpdateMyProfile=async()=>{ft.ModalManagerV2.openModal({windowId:yt.c,name:W.ModalIdentitiesDefine.UPDATE_PROFILE,params:{showCloseButton:!0}})},this.openUserInfo=async e=>{Qi.a.setFriendRequestSource(e,W.FRIEND_REQUEST_SRC_CONTACT_LIST_SUGGESTION),ye.p.setSelectConversationSource(178012),ft.ModalManagerV2.openModal({windowId:yt.c,name:W.ModalIdentitiesDefine.FRIEND_PROFILE,params:e})},this.openEditAlias=async e=>{const t={windowId:yt.c,name:W.ModalIdentitiesDefine.EDIT_ALIAS,params:Object(T.a)({},e)};ft.ModalManagerV2.openModal(t)},this.sendFile=async(e,t)=>{const s=this._getStateByWindowId(yt.c),i=Ki.default.getChatBoxControllerByConvId(t||s.conversationId);null==i||i._uploadDragFile(e,null,t)},this.getConvId=()=>this._getStateByWindowId(yt.c).conversationId,this.sendDirectMsgToSendToMe=(e,t)=>{!U.default.isOffSendToMe&&this.chatboxController&&_t.default.getConversation(U.default.sendToMeId).then((s=>{if(e===W.MSG_GIF&&t.url){var i;let e={hd:{width:t.width?t.width:0,height:t.height?t.height:0,url:t.url},original:{width:t.width?t.width:0,height:t.height?t.height:0,url:t.url},normal:{width:t.width?t.width:0,height:t.height?t.height:0,url:t.url}};null===(i=this.chatboxController)||void 0===i||i._sendMessage(s,W.MSG_GIF,e,null,null,null,null,null)}Object(xs.e)({type:P.ConversationListActions.SELECT_CONVERSATION,payload:s}),this.sidebar.updateSelectedId(U.default.sendToMeId)}))},this.handleSendMessageError=(e,t,s)=>{var i,a;if(_t.default.deleteMessageById(t.msgId,t.conversationId),null===(i=this.chatboxController)||void 0===i||i._cleanUpLocalTTLItem(t),ye.p.isDelSendingMsg(t.clientId))return;const n=t.convertToUIMessageObject();return null===(a=this.chatboxController)||void 0===a||a._handleMessageFailure(e,t,n,s,!0),e},this.broadCastMessage=(e,t,s,i)=>{if(e&&t)for(let o=0;o<e.length;o++){const c=e[o];if(c){let e=c.userId,o=e.startsWith(W.GROUPID_PREFIX);if(t.msgType===W.MSG_STICKER){var a;const l=Xi.a.next();t&&t.sendSrc&&Pi.c.track(l,t.sendSrc);const d=A.default.getMsgIdSendingFromCliMsgId(l),h=new ea.b(ye.p.getSessionUserId(),e,d,l,W.MSG_STICKER,o),u=ta.a.instance().isOnE2ee(c.userId);if(h.updateMessageContentProp(ea.a.STICKER,t.message),u){var n;const e={id:h.content.sticker.id,catId:h.content.sticker.cateId,type:h.content.sticker.type};var r;if(null!==(n=t.message)&&void 0!==n&&n.fssInfo)e.extInfo=null===(r=t.message)||void 0===r?void 0:r.fssInfo;h.updateMessageContentProp(ea.a.STICKER,e),h.e2eeStatus=W.MSG_E2EE}Ni.default.sendMsgObject(h,null,null,W.RETRY_MSG_TIMEOUT_DEFAULT).then((t=>{if(s){var a;const t=Xi.a.next(),i=A.default.getMsgIdSendingFromCliMsgId(t);let n=new ea.b(ye.p.getSessionUserId(),e,i,t,W.MSG_TEXT,o);n.updateMessageContentProp(ea.a.TEXT,s),u&&(n.e2eeStatus=W.MSG_E2EE),Ni.default.sendMsgObject(n,null,null,W.RETRY_MSG_TIMEOUT_DEFAULT).then((e=>{u&&(e=A.default.parseE2eeResp(e),this.chatboxController._sentMessage(n,e))})).catch((e=>{this.handleSendMessageError(e,n,c)})),null===(a=this.chatboxController)||void 0===a||a._showLocalMessage(n,c)}u&&(t=A.default.parseE2eeResp(t),this.chatboxController._sentMessage(h,t)),i&&i(t)})).catch((e=>{A.default.logCoreError("BroadcastErr: ",e),this.handleSendMessageError(e,h,c),i&&i(e)})),null===(a=this.chatboxController)||void 0===a||a._showLocalMessage(h,c)}else if(t.msgType===W.MSG_TEXT&&s){const t=Xi.a.next(),a=A.default.getMsgIdSendingFromCliMsgId(t);let n=new ea.b(ye.p.getSessionUserId(),e,a,t,W.MSG_TEXT,o);n.updateMessageContentProp(ea.a.TEXT,s);ta.a.instance().isOnE2ee(c.userId)&&(n.e2eeStatus=W.MSG_E2EE),Ni.default.sendMsgObject(n,null,null,W.RETRY_MSG_TIMEOUT_DEFAULT).then((e=>{i&&i(e)})).catch((e=>{this.handleSendMessageError(e,n,c),i&&i(e)}))}}}},this.handleEvent=(e,t)=>{if(e===P.ConversationListActions.SELECT_CONVERSATION){const e=this._getStateByWindowId(yt.c);if(t.userId!==e.conversationId)return this._updateStateByWindowId(yt.c,(e=>Object(T.a)(Object(T.a)({},e),{},{conversationId:t.userId}))),Object(Zs.g)(this.name,yt.c),void this.dispatchEvent(new Ji.a(t.userId,yt.c))}},this.name=Yi.a,this.key="windowId",this.init()}get chatboxController(){const e=this.sidebar.getState().selectedId;return Ki.default.getChatBoxControllerByConvId(e||yt.b)}onInviteFriend(){const e=[sa];ft.ModalManagerV2.openModal({windowId:yt.c,name:W.ModalIdentitiesDefine.SHARE_MSG_COMPOSE,params:{messages:e,title:ni.default.str("STR_INVITE_FRIEND_1"),disableGroup:!0,disablePcUser:!0,callback:(e,t)=>{N.default.send(P.SideBarActions.SEND_INVITATION,{target:e,message:(null==t?void 0:t.length)>0?t[0]:"",link:`https://${U.default.CONFIG_DOMAIN}/may-tinh`})}}})}onWhatNew(){ft.ModalManagerV2.openModal({windowId:yt.c,name:W.ModalIdentitiesDefine.APP_UPDATE_INFO,params:{data:_t.default.getCacheRecentUpdate(),isManual:!0}})}showMyProfile(){let e=ye.p.getSessionUserId();ft.ModalManagerV2.openModal({windowId:yt.c,name:W.ModalIdentitiesDefine.FRIEND_PROFILE,params:e})}get mainWindowConversationId(){return this._getStateByWindowId(yt.c).conversationId}doLogout(e){let t=ye.p.getSessionUserId();e&&e.del_history?ti.g.setClearData(t,1):ti.g.setClearData(t,0),oa.a.logout(),ca.a.logout(),ra.default.logout().catch((e=>{e.error_code&&18032===e.error_code&&ft.ModalManagerV2.openModal({windowId:yt.c,name:W.ModalIdentitiesDefine.CHANGE_PW})}))}init(){N.default.subscribe(this.handleEvent)}getItem(e,t){return this._getStateByWindowId(e.key)}getList(e,t){return Array.from(this.data.keys())}onGetItemFailure(e){}onGetListFailure(e){}_getStateByWindowId(e){let t=this.data.get(e);return t||(t=Object(T.a)({},da),this.data.set(e,t)),t}_updateStateByWindowId(e,t){const s=t(this._getStateByWindowId(e));this.data.set(e,s)}})||ia)||ia)||ia);var ha,ua=s("OI//");let ga=i.ModuleContainer.injectable()(ha=class{async get(e){return Fe.default.getGroupById(e)}async getMulti(e){const t=await Fe.default.getGroupsByIds(e);return Object.values(t)}async getAll(){return await Fe.default.getGroupsList()}})||ha;var ma;let pa=i.ModuleContainer.injectable()(ma=function(e,t){return i.ModuleContainer.inject(ua.c)(e,void 0,0)}(ma=function(e,t){return i.ModuleContainer.inject(B.ZLoggerFactory)(e,void 0,1)}(ma=Reflect.metadata("design:type",Function)(ma=Reflect.metadata("design:paramtypes",[void 0===ua.c?Object:ua.c,void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory])(ma=class{constructor(e,t){this.groupRepository=e,this.logger=void 0,this.logger=t.createZLogger("groups",["group-manager"])}getAll(){return this.groupRepository.getAll().then((e=>e.map((e=>new ua.a(e))))).catch((e=>(this.logger.zsymb(18,"Gy9iGd",(()=>["getAll error. return [].",{reason:e}])),[])))}getMulti(e){return this.groupRepository.getMulti(e).then((e=>e.map((e=>new ua.a(e)))))}get(e){return this.groupRepository.get(e).then((e=>e?new ua.a(e):void 0)).catch((e=>{this.logger.zsymb(18,"kfmiWR",(()=>["get error. return undefined.",{reason:e}]))}))}})||ma)||ma)||ma)||ma)||ma;i.ModuleContainer.registerSingleton(ua.c,ga),i.ModuleContainer.registerSingleton(ua.b,pa);var fa,va=s("MqnV");let _a=Object(i.injectable)()(fa=function(e,t){return Object(i.inject)(ze.e)(e,void 0,0)}(fa=function(e,t){return Object(i.inject)(Qt)(e,void 0,1)}(fa=function(e,t){return Object(i.inject)(ze.g)(e,void 0,2)}(fa=Reflect.metadata("design:type",Function)(fa=Reflect.metadata("design:paramtypes",[void 0===ze.e?Object:ze.e,"undefined"==typeof IMessageController?Object:IMessageController,void 0===ze.g?Object:ze.g])(fa=class{constructor(e,t,s){this.conversationRepository=e,this.messageLocalController=t,this.muteManager=s}getAllConvIds(){return this.conversationRepository.getAllConvIds()}async get(e){const t=await this.conversationRepository.get(e).catch((()=>{}));if(t)return new ze.c(t,this,this.messageLocalController)}isPinned(e){return this.conversationRepository.get(e).then((e=>!(null==e||!e.pinned))).catch((()=>!1))}isMuted(e){return!!this.muteManager.isMuted(e)}})||fa)||fa)||fa)||fa)||fa)||fa;var ba;let ya=i.ModuleContainer.injectable()(ba=function(e,t){return i.ModuleContainer.inject(ze.b)(e,void 0,0)}(ba=Reflect.metadata("design:type",Function)(ba=Reflect.metadata("design:paramtypes",[void 0===ze.b?Object:ze.b])(ba=class{constructor(e){this.convManager=e}getAllConvIds(){return this.convManager.getAllConvIds()}get(e){return this.convManager.getConvById(e)}})||ba)||ba)||ba)||ba;var Ia=s("SVh1");var Sa,Ca=new class{constructor(){}showMyProfile(){ft.ModalManagerV2.openModal({windowId:yt.c,name:W.ModalIdentitiesDefine.FRIEND_PROFILE,params:ye.p.getSessionUserId()})}},Ea=s("idnp"),Oa=s("44Ud"),Ta=s("SWHF"),Ma=s("oMqy"),Ra=s("oq0C"),wa=s("7gRy"),La=s("q9t1");const Fa="[Conversation controller]";function Da(...e){A.default.logCoreInfo(`${Fa} - `,e)}let Aa=Object(i.singleton)()(Sa=Object(i.injectable)()(Sa=function(e,t){return Object(i.inject)(ze.i)(e,void 0,0)}(Sa=function(e,t){return Object(i.inject)(Ta.b)(e,void 0,1)}(Sa=function(e,t){return Object(i.inject)(Ma.e)(e,void 0,2)}(Sa=function(e,t){return Object(i.inject)(Ma.o)(e,void 0,3)}(Sa=function(e,t){return Object(i.inject)(Ks.SidebarController)(e,void 0,4)}(Sa=function(e,t){return Object(i.inject)(ze.b)(e,void 0,5)}(Sa=Reflect.metadata("design:type",Function)(Sa=Reflect.metadata("design:paramtypes",[void 0===ze.i?Object:ze.i,void 0===Ta.b?Object:Ta.b,void 0===Ma.e?Object:Ma.e,void 0===Ma.o?Object:Ma.o,void 0===Ks.SidebarController?Object:Ks.SidebarController,void 0===ze.b?Object:ze.b])(Sa=class{constructor(e,t,s,i,a,n){this.previewManager=e,this.adminSettingController=t,this.communityController=s,this.groupLoadInfoController=i,this.sidebar=a,this.convDataManager=n,this.lastOpenConv=new Map,this._es=void 0,this.onRequestJumtoMsg=(e,t)=>{const s=t.conversation,i=e===P.ChatBoxActions.JUMP_TO_MESSAGE_SEARCH_HIDDEN_CHAT||Le.a.getListChatBoxViewCurrent().includes(null==s?void 0:s.userId)||s.byPassPIN;if(!s)return;if(s&&!i&&Le.a.isThreadHidden(s.userId))return Object(ii.b)({type:e,payload:t},!0),void Da("req jum to msg rejected because hidden chat");wi.default.Fps.record(wi.MetricName.fps_jump_to_msg),Da("req jum to msg open on main"),Object(ii.b)({type:e,payload:t},!0);const a=Ea.b.fromJumpMessage();this.openConversationForJump(s.userId,a)},this.tryToFocusChild=(e,t)=>!!Ki.default.isOpenChildWindowByConvId(e)&&(Da("Open conv forward because already open in child => call focus"),Ki.default.focusOnChildWindow(e,null==t?void 0:t.callPoint),!0),this.handleOutConversation=e=>{this.closeConversation(e.convId,{removed:!0})},this.listenEvent()}get eventStore(){return this._es||(this._es=s("emRR").default),this._es}listenEvent(){N.default.subscribe(((e,t)=>{switch(e){case P.ConversationListActions.SELECT_CONVERSATION_HIDDEN:this.sidebar.updateSelectedId(t.userId);break;case P.ChatBoxActions.OPEN_CONV_JUMP_TO_MESSAGE_SEARCH:this.onRequestJumtoMsg(P.ChatBoxActions.JUMP_TO_MESSAGE_SEARCH,t);break;case P.ChatBoxActions.OPEN_CONV_JUMP_TO_MESSAGE_SEARCH_HIDDEN_CHAT:this.onRequestJumtoMsg(P.ChatBoxActions.JUMP_TO_MESSAGE_SEARCH_HIDDEN_CHAT,t)}})),this.convDataManager.addEventListener(Ys.b.DeleteConv,this.handleOutConversation),this.convDataManager.addEventListener(Ys.b.EmptyConv,this.handleOutConversation),this.convDataManager.addEventListener(Ys.b.LeaveGroup,this.handleOutConversation)}isConvOpeningInMain(e){const t=this.eventStore.getState(),s=this.sidebar.getState().selectedId;return t&&t.chatview.view===Gi.c.CHAT_VIEW&&s===e}openConversationForJump(e,t=Ea.a){return new Promise((async s=>{if(Da(`Request open conv for jum: ${e}`),!e||this.isConvOpeningInMain(e)){if(Da(`Open conv rejected because null or opened: ${e}`),e){this.tryToFocusChild(e,t)||Ki.default.focusOnMainWindow()}return s(!1)}if(!(await this.conversationWillOpen(e)))return s(!1);let i=!1;if(t.window===Ia.b.Child)return i=this.tryToFocusChild(e,t),s(i);if(t.window===Ia.b.PreferChild){if(i=this.tryToFocusChild(e,t),i)return s(!0)}else t.window===Ia.b.MainAndChild&&(i=this.tryToFocusChild(e,t));i||Ki.default.focusOnMainWindow(),N.default.send(P.ConversationListActions.SELECT_CONV_MINOR,{userId:e}),Object(ii.b)({type:P.ConversationListActions.OPEN_CONV_FOR_JUMP,payload:{userId:e}}),this.sidebar.updateSelectedId(e),s(!0),this.conversationDidOpen(e)}))}openConversation(e,t=Ea.a){return new Promise((async(s,a)=>{if(Da(`Request open conv from: ${e} - ${t.callPoint}`),!e||this.isConvOpeningInMain(e)&&!t.force){if(Da(`Open conv rejected because null or opened: ${e}`),e){this.tryToFocusChild(e,t)||t.silently||Ki.default.focusOnMainWindow()}return s(!1)}const n=ye.p.getSessionUserId();if(e==n)return Ca.showMyProfile(),s(!1);wi.default.Fps.record(wi.MetricName.fps_switch_conv);if(!(await this.conversationWillOpen(e)))return s(!1);let r=!1;if(t.window===Ia.b.Child)return r=this.tryToFocusChild(e,t),s(r);if(t.window===Ia.b.PreferChild){if(r=this.tryToFocusChild(e,t),r)return s(!0)}else t.window===Ia.b.MainAndChild&&(r=this.tryToFocusChild(e,t));let o=t.credentConv;if(o||(o=await _t.default.getLikeConversation(e).catch((e=>{Da(`Failure to load conv from store ${e}`)})),Da(`Try to use storage conv: ${!!o}`)),o||(o=t.defaultConv,Da(`Try to use default conv: ${!!o}`)),!o)return Da(`Open conv not exists: ${e}`),s(!1);r||t.silently||Ki.default.focusOnMainWindow(),N.default.send(P.ConversationListActions.SELECT_CONV_MINOR,o);const c=Le.a.isThreadHidden(e);c&&Le.a.checkShowUnreadHiddenChat(e),t.byPassPIN?(o=Object(T.a)({},o),o.byPassPIN=1):delete o.byPassPIN,this.eventStore.dispatch({type:P.ConversationListActions.SELECT_CONVERSATION,payload:o}),N.default.send(P.ConversationListActions.SELECT_CONVERSATION,{userId:o.userId,needScroll:t.callPoint!==Ia.a.ConvItem,callPoint:t.callPoint});(!c||t.byPassPIN||Le.a.getListChatBoxViewCurrent().includes(o.userId))&&this.sidebar.updateSelectedId(e),s(!0),this.conversationDidOpen(e),i.ModuleContainer.resolve(La.b).promoteMigrateByOpenConv(e)}))}closeConversation(e,t={}){return new Promise((s=>{if(e&&this.sidebar.getState().selectedId!==e)return s(!1);const{windowId:i=yt.c,removed:a}=t;if(i===yt.c){const e={conversation:null,convId:null};this.eventStore.dispatch({type:P.ConversationListActions.SELECT_CONVERSATION,payload:e}),N.default.send(P.ConversationListActions.SELECT_CONVERSATION,e),a?this.sidebar.updateSelectedIdWithoutPrevious(null):this.sidebar.updateSelectedId(null)}s(!0)}))}closeAllConversations(){return Promise.resolve(!0)}deleteConversation(e,t=yt.c){return new Promise((async s=>{if(this.conversationWillDelete(e),await Vs.default.deleteConversation(e,!0,t),t===yt.c){const t={userId:null};this.eventStore.dispatch({type:P.ConversationListActions.SELECT_CONVERSATION,payload:t}),N.default.send(P.ConversationListActions.SELECT_CONVERSATION,t),this.sidebar.updateSelectedId(null),s(!0),this.conversationDidDelete(e)}else s(!1)}))}pinConversation(e){return Promise.resolve(!0)}renameConversation(e){return Promise.resolve(!0)}getLastOpenConv(e){return this.lastOpenConv.get(e)}isOpeningConversation(e){const t=this.sidebar.getSelectedId();return!(!t||t!=e)||Ki.default.isOpenChildWindowByConvId(e)}conversationWillOpen(e){return Oa.b.start(Oa.a.ART,{convId:e}),Da(`Will open conv ${e}`),this.lastOpenConv.set(e,Date.now()),Promise.resolve(!0)}conversationDidOpen(e){wi.default.start(wi.MetricName.open_conversation,e),wi.default.start(wi.MetricName.open_conversation_no_preload,e),Da(`Did open conv ${e}`),this.adminSettingController.onLoadSetting(e),this.communityController.onConversationDidOpen(e),this.groupLoadInfoController.onOpenConversation(e),i.ModuleContainer.resolve(Ra.a).onOpenConversation(e),i.ModuleContainer.resolve(wa.a).onOpenConversation(e),setTimeout((()=>{this.previewManager.revalidate(e)}),0)}conversationWillDelete(e){return Da(`Will delete conv ${e}`),Promise.resolve()}conversationDidDelete(e){Da(`Did delete conv ${e}`),this.lastOpenConv.delete(e)}})||Sa)||Sa)||Sa)||Sa)||Sa)||Sa)||Sa)||Sa)||Sa)||Sa;var Na,ka=s("s9sK"),Pa=s("TeMN"),ja=(s("EHdh"),s("Ln14")),Ua=s("bdot"),Ba=s("cfFl"),Ga=s.n(Ba);const za={userId:W.CONV_FILTER.STRANGER,label:null,isGroup:!1,respondedByMe:!1,numMsg:0,pinned:0,outside:0,topOut:!1,infoCheckSearch:null},xa=["userId","label","firstSmsLocalId","lastSmsLocalId","isGroup","respondedByMe","numMsg","pinned","outside","lastActionId","topOutImprTimeOut","topOutTimeOut","syncFromMobile","topOut","localType","infoCheckSearch","preLastSmsLocalId"];Object(ie.b)(ja.c)(Na=function(e,t){return i.ModuleContainer.inject(Pa.b)(e,void 0,0)}(Na=Reflect.metadata("design:type",Function)(Na=Reflect.metadata("design:paramtypes",[void 0===Ys.IReactiveDB?Object:Ys.IReactiveDB])(Na=class extends De.b{constructor(e){super(),this.DBConvInfo=e,this.name=void 0,this.key=void 0,this.data=void 0,this.didInit=void 0,this.doneLoadDB=void 0,this.fetchAllHolder=void 0,this.preloadCached=void 0,this._pm=void 0,this.pinEventQueue=void 0,this.labelEventQueue=void 0,this.doneEventQueue=void 0,this.name=ja.a,this.key="convId",this.data=new Map,this.didInit=!1,this.doneLoadDB=!1,this.fetchAllHolder=null,this.preloadCached=null,this._pm=null,this.pinEventQueue=[],this.labelEventQueue=[],this.doneEventQueue=!1}get previewManager(){return this._pm||(this._pm=i.ModuleContainer.resolve(ze.i)),this._pm}get unreadManager(){return Q.a.UnreadDataManager}init(){if(this.didInit)return Promise.resolve();const e=wi.default.start(wi.MetricName.load_conversation_list),t=()=>{e.end(),Q.a.ConvListController.removeEventListener(Ys.c.LoadPreviewDone,t)};return Q.a.ConvListController.addEventListener(Ys.c.LoadPreviewDone,t),this.didInit=!0,this.loadData()}async loadData(){this.fetchAllHolder||(this.fetchAllHolder=this.DBConvInfo.getAll());const e=await this.fetchAllHolder.catch((e=>{A.default.logCoreInfo(`[${this.name}] - load conv from DB got error ${e}`)}))||[],t=await this.onLoadDataFromDB(e);A.default.logCoreInfo(`[${this.name}] - done load db ${e.length}`),this.doneLoadDB=!0,this.doIdleTask(),this.broadcastEvent(Ys.b.DoneLoadDB,"",e),this.previewManager.migrate(t.map((e=>e.userId))),this.setCacheData(W.CONV_FILTER.STRANGER,za,!0)}async doIdleTask(){const e=this.pinEventQueue.slice(),t=this.labelEventQueue.slice();this.pinEventQueue=[],this.labelEventQueue=[];const s=Ga.a.series(e),i=Ga.a.series(t);return Promise.all([s,i]).then((e=>this.pinEventQueue.length||this.labelEventQueue.length?this.doIdleTask():(this.doneEventQueue=!0,e)))}getItem(e,t){return this.data.get(e.key)}getList(e,t){return e.key===ja.b.ALL?Array.from(this.data.keys()):[]}onGetItemFailure(e){}onGetListFailure(e){}async onLoadDataFromDB(e){const t=await $s.a.filterOutdatedConv(e);A.default.logCoreInfo(`[${this.name}] - done filter outdate ${e.length} ${t.length}`);const s=(new Date).getTime().toString(),i=[];Object(Zs.i)(s);for(let a=0;a<t.length;a++){if(!t[a].userId)continue;const e=Object(T.a)({},t[a]),n=this.data.get(e.userId);if(e.verified=!0,void 0===e.isGroup&&(e.isGroup=e.userId.startsWith(W.GROUPID_PREFIX)),n){if(!n.verified){const t=this.mergeConv(e,n);t.verified=!0,this.setCacheData(e.userId,t),Object(Zs.f)(s,this.name,e.userId),this.updateInDB(t)}}else this.setCacheData(e.userId,e),Object(Zs.f)(s,this.name,e.userId);e.infoCheckSearch&&(e.infoCheckSearch&&A.default.msgTypeValid(e.infoCheckSearch.lastType)?bi.a.pushCacheLastChat(e.userId,e.infoCheckSearch.lastMessageTime):e.numMsg&&e.numMsg>1&&i.push(e.userId))}return i.length>0&&bi.a.cacheCheckLastChatInDb(i),Object(Zs.c)(s),t}onReceiveNewMessages(e,t,s={outside:void 0,isGroup:!1}){return new Promise(((i,a)=>{var n,r;if(!t||t.length<0)return a("Empty msgs");const o=t[t.length-1],c=t[0],l=this.data.get(e),d=$s.a.getLastValidMsg(t);let h,u;d&&(h={lastMessageTime:Number(d.sendDttm),lastType:d.msgType},bi.a.pushCacheLastChat(e,h.lastMessageTime)),o.msgType===W.MSG_INFO&&(null==l||null===(n=l.infoCheckSearch)||void 0===n?void 0:n.lastMessageTime)>Number(o.sendDttm)&&(u=null==l?void 0:l.lastSmsLocalId);const g={userId:e,firstSmsLocalId:c.msgId,isGroup:s.isGroup||e.startsWith(W.GROUPID_PREFIX),numMsg:t.length,respondedByMe:ts.b.includeMyMessage(t),pinned:0,label:null,topOut:o.topOut,verified:!1,lastSmsLocalId:u||o.msgId,outside:s.outside,cloudMore:!1,infoCheckSearch:h};if(this.preloadCached&&this.preloadCached.onNewMsg(e,o),l){const t=this.mergeConv(Object(T.a)({},l),g);this.setCacheData(e,t),this.shouldSignalUpdate(l,t)&&Object(Zs.g)(this.name,e),l.verified&&this.updateInDB(t),i(t)}else{const s=Js.a.getLabelObjByConversaionId(e);if(g.label=s?s.id:null,this.setCacheData(e,g,!0),this.doneLoadDB){g.verified=!0,this.updateInDB(g);return ts.b.includeJoinEvent(t)&&(A.default.logCoreInfo(`[${this.name}] - Detect join msg ${e} ${o.msgId}`),this.previewManager.forceChangeItem(e)),i(g)}this.DBConvInfo.getById(e).then((t=>{const s=this.data.get(e);if(!s)return a("Internal logic handle wrong");let n=Object(T.a)({},s);n.verified=!0,t?s.verified||(n=this.mergeConv(n,t),this.setCacheData(e,n),this.shouldSignalUpdate(n,s)&&Object(Zs.g)(this.name,e),this.updateInDB(n)):this.updateInDB(n),i(n)}))}l&&l.respondedByMe||null===(r=this.data.get(e))||void 0===r||!r.respondedByMe||(A.default.logCoreInfo(`[${this.name}] - Detect first my msg ${e} ${o.msgId}`),this.previewManager.forceChangeItem(e))}))}async onDeleteMessages(e,t){const s=this.data.get(e);if(A.default.logCoreInfo(`[${this.name}] - onDeleteMessages #1 ${e} ${t.length}`),s&&s.verified){let i=!1;if(t.find((({msgId:e})=>s.firstSmsLocalId===e))){const t=await(await Ua.b.getFirstMessage(e)).firstMsg;if(!t)return A.default.logCoreInfo(`[${this.name}] - onDeleteMessages #4 ${e} `),this.forkDeleteCacheAndDB(e),{deletedId:e};s.firstSmsLocalId=null==t?void 0:t.msgId,i=!0}if(t.find((({msgId:e})=>s.lastSmsLocalId===e))){const t=await Ua.b.getLastMessage(e,s.lastSmsLocalId);if(!t||t.length<1)return A.default.logCoreInfo(`[${this.name}] - onDeleteMessages #5 ${e} ${!!t}`),this.forkDeleteCacheAndDB(e),{deletedId:e};s.lastSmsLocalId=t[0].msgId,i=!0}return A.default.logCoreInfo(`[${this.name}] - onDeleteMessages #6 ${e} ${i}`),i&&(this.setCacheData(e,Object(T.a)({},s)),this.updateInDB(s)),{conversation:s,updated:i}}{const t=await(await Ua.b.getFirstMessage(e)).firstMsg,s=await Ua.b.getLastMessage(e),i=s&&s[0];if(!t||!i)return A.default.logCoreInfo(`[${this.name}] - onDeleteMessages #2 ${e} ${!!t} ${!!i}`),Q.a.PinDataManager.isPinned(e)||this.onDeleteConversation(e),{deletedId:e};const a=await this.DBConvInfo.getById(e);let n=A.default.msgTypeValid(i)?{lastMessageTime:i.sendDttm,lastType:i.msgType}:void 0;if(A.default.logCoreInfo(`[${this.name}] - onDeleteMessages #3 ${e} ${!!a}`),a){let s=!1;a.firstSmsLocalId!==(null==t?void 0:t.msgId)&&(a.firstSmsLocalId=null==t?void 0:t.msgId,s=!0),a.lastSmsLocalId!==i.msgId&&(a.lastSmsLocalId=null==i?void 0:i.msgId,s=!0);const n=Object(T.a)(Object(T.a)({},a),{},{verified:!0});return this.setCacheData(e,n,!0),s&&this.updateInDB(n),{conversation:n,updated:!0}}{const s={userId:e,isGroup:e.startsWith(W.GROUPID_PREFIX),pinned:0,label:null,topOut:void 0,verified:!0,outside:null,cloudMore:!1,firstSmsLocalId:t.msgId,lastSmsLocalId:i.msgId,numMsg:2,respondedByMe:"0"==t.fromUid||"0"==i.fromUid,infoCheckSearch:n};return this.setCacheData(e,s,!0),this.updateInDB(s),{conversation:s,updated:!0}}}}mergeConv(e,t){const s=e=>null!=e&&("string"==typeof e?!e.includes("undefined")&&!e.includes("null"):"number"==typeof e&&!isNaN(e));let i=!1;return s(e.lastSmsLocalId)?s(t.lastSmsLocalId)&&(i=t.lastSmsLocalId>e.lastSmsLocalId):i=!0,i&&(e.preLastSmsLocalId=e.lastSmsLocalId||t.lastSmsLocalId,e.lastSmsLocalId=t.lastSmsLocalId,e.outside=t.outside),e.numMsg=(e.numMsg||0)+t.numMsg,e.respondedByMe=e.respondedByMe||t.respondedByMe,(!e.firstSmsLocalId||t.firstSmsLocalId&&t.firstSmsLocalId<e.firstSmsLocalId)&&(e.firstSmsLocalId=t.firstSmsLocalId),(!e.infoCheckSearch||!e.infoCheckSearch.lastMessageTime||t.infoCheckSearch&&t.infoCheckSearch.lastMessageTime>e.infoCheckSearch.lastMessageTime)&&(e.infoCheckSearch=t.infoCheckSearch),e.preLastSmsLocalId||(e.preLastSmsLocalId=t.lastSmsLocalId),!t.respondedByMe&&t.topOut&&(e.topOut=t.topOut),"string"!=typeof e.firstSmsLocalId&&(e.firstSmsLocalId=""+e.firstSmsLocalId),e}async onEmptyConversation(e){const t=await this.getConvById(e);if(A.default.logCoreInfo(`[${this.name}] - onEmptyConversation ${e} ${!!t}`),!t)return;const s=Object(T.a)({},t);return delete s.firstSmsLocalId,delete s.lastSmsLocalId,s.numMsg=0,s.respondedByMe=!1,this.setCacheData(e,s,!0),this.broadcastEvent(Ys.b.EmptyConv,e),Object(Zs.g)(this.name,e),Q.a.PinDataManager.isPinned(e)&&Q.a.PinDataManager.unpin([e]),this.updateInDB(s)}onDeleteConversation(e){A.default.logCoreInfo(`[${this.name}] - onDeleteConversation ${e}`);const t=this.data.get(e);return this.doDeleteConversation(e).then((s=>{this.broadcastEvent(Ys.b.DeleteConv,e,t)}))}doDeleteConversation(e){const t=this.data.get(e);return A.default.logCoreInfo(`[${this.name}] - doDeleteConversation ${e} ${!!t}`),t&&(this.data.delete(e),Object(Zs.e)(this.name,e)),Q.a.PinDataManager.isPinned(e)&&Q.a.PinDataManager.unpinLocal([e]),this.deleteInDB(e)}onPinConversation(e,t){return new Promise((s=>{this.doneEventQueue?this.doUpdatePin(e,t).then(s):this.pinEventQueue.push((async()=>{const i=await this.doUpdatePin(e,t);s(i)}))}))}doUpdatePin(e,t){if(t&&$s.a.isStrangerV2(e))return Promise.resolve(null);if(!this.data.get(e)){if(!t)return Promise.resolve(null);const s=this.getEmptyConv(e);s.verified=!0,this.setCacheData(e,s)}const s=new Map;return s.set("pinned",t),this.updateFields(e,s).then((s=>(this.broadcastEvent(Ys.b.ChangePinConv,e,t),s))).catch((t=>(A.default.logCoreInfo(`[${this.name}] - doUpdatePin err`,t),this.data.get(e))))}onLeaveGroup(e){return A.default.logCoreInfo(`[${this.name}] - onLeaveGroup ${e}`),this.doDeleteConversation(e).then((t=>{this.broadcastEvent(Ys.b.LeaveGroup,e)}))}async onChangeConvLabel(e,t){return new Promise((s=>{const i=this.data.get(e);if(i&&i.label===t)return s(i);this.doneEventQueue?this.doUpdateConvLabel(e,t).then(s):this.labelEventQueue.push((async()=>{const i=await this.doUpdateConvLabel(e,t);s(i)}))}))}doUpdateConvLabel(e,t){if(!e)return A.default.logCoreInfo(`[${this.name}] - doUpdateConvLabel with undefined ${t}`),Promise.resolve(null);const s=this.data.get(e);if(s&&s.label===t)return Promise.resolve(s);if(!s){if(!t)return Promise.resolve(null);const s=this.getEmptyConv(e);s.verified=!0,this.setCacheData(e,s)}const i=new Map;return i.set("label",t),this.updateFields(e,i).then((i=>(this.unreadManager.onChangeConvLabel(e,null==s?void 0:s.label,t),i)))}onFetchConvLabels(e){if(!e||!Array.isArray(e))return;A.default.logCoreInfo(`[${this.name}] - onChangeConvLabel ${e.length}`);const t={};this.getAllConv().then((s=>{for(let e=0;e<s.length;e++)t[s[e].userId]=1;for(let i=0;i<e.length;i++){const s=e[i].id,a=e[i].conversations;if(a)for(let e=0;e<a.length;e++){const i=a[e];delete t[i],this.onChangeConvLabel(i,s)}}for(const e in t)Object.hasOwnProperty.call(t,e)&&this.onChangeConvLabel(e,null)}))}onDeleteConvLabels(e){A.default.logCoreInfo(`[${this.name}] - onDeleteConvLabels ${e.length}`),e.forEach((e=>{const t=e.conversations;if(t&&t.length)for(let s=0;s<t.length;s++)this.data.has(t[s])&&this.onChangeConvLabel(t[s],null)}))}async onUpdateMsgId(e,t,s){if(!t||!s||t===s)return Promise.reject("[Conv-info-manager]- call update with invalid params!");const i=this.data.get(e);let a=i||{},n=!1;if(!i||!i.verified){const t=await this.DBConvInfo.getById(e);if(!i&&!t){const t=await this.createEmptyConvForUser(e,0,void 0,{firstSmsLocalId:s,lastSmsLocalId:s});return this.setCacheData(e,t),t}i&&t?(a=this.mergeConv(i,t),n=!0):(a=i||t,a.verified=!0,n=!0)}return a.firstSmsLocalId&&a.firstSmsLocalId!==t||(n=!0,a.firstSmsLocalId=s),a.lastSmsLocalId&&a.lastSmsLocalId!==t||(n=!0,a.lastSmsLocalId=s),n&&(this.setCacheData(e,a),this.updateInDB(a)),a}async addOrUpdateConv(e,t,s,i,a,n){"number"==typeof t&&(t=""+t),"number"==typeof s&&(s=""+s);const r=this.data.get(e);A.default.logCoreInfo(`[${this.name}] - addOrUpdateConv ${e} ${!!r} ${s}`);const o=e=>((!e.firstSmsLocalId||t&&t<e.firstSmsLocalId)&&(e.firstSmsLocalId=t),(!e.lastSmsLocalId||s&&s>e.lastSmsLocalId)&&(e.lastSmsLocalId=s),e.cloudMore=i,e.respondedByMe=e.respondedByMe||a,e.numMsg=(e.numMsg||0)+n,e);if(r&&r.verified){const t=o(r);return this.setCacheData(e,Object(T.a)({},t)),this.updateInDB(t),t}{const r=await this.DBConvInfo.getById(e);if(A.default.logCoreInfo(`[${this.name}] - addOrUpdateConv #2 ${e} ${!!r}`),r){const t=o(r);return this.setCacheData(e,Object(T.a)(Object(T.a)({},t),{},{verified:!0})),this.updateInDB(t),t}{const r={userId:e,firstSmsLocalId:t,lastSmsLocalId:s,isGroup:e.startsWith(W.GROUPID_PREFIX),respondedByMe:a,numMsg:n||2,label:null,pinned:0,verified:!0,cloudMore:i,outside:null,topOut:null,infoCheckSearch:void 0};return this.setCacheData(e,r,!0),this.updateInDB(r),r}}}async addIfNotExistsConv(e,t,s,i,a,n){const r=this.data.get(e);if(A.default.logCoreInfo(`[${this.name}] - addIfNotExistsConv #1 ${e} ${!!r} ${i}`),r)return!1;const o=await this.DBConvInfo.getById(e);if(A.default.logCoreInfo(`[${this.name}] - addIfNotExistsConv #2 ${!!o}`),o)return!1;{const r={userId:e,firstSmsLocalId:s,lastSmsLocalId:i,isGroup:t||e.startsWith(W.GROUPID_PREFIX),respondedByMe:a,numMsg:n||1,label:null,pinned:0,verified:!0,outside:null,topOut:null,infoCheckSearch:void 0};return this.setCacheData(e,r,!0),this.updateInDB(r),!0}}createEmptyConvForUser(e,t,s=W.CONV_OT_STATE.none,i){return new Promise(((a,n)=>{this.getConvById(e).then((a=>{let n;if(A.default.logCoreInfo(`[${this.name}] - createEmptyConvForUser ${e} ${!!a}`),a){const i=new Map;return n=a,s!==W.CONV_OT_STATE.none&&void 0!==s&&(n.outside=s,i.set("outside",s)),t&&!Q.a.PinDataManager.isPinned(n.userId)&&Q.a.PinDataManager.pin([n.userId]),this.updateFields(e,i),n}return n=Object(T.a)({userId:e,lastMessageTime:t?0:D.default.getTimeNow(),isGroup:e.startsWith(W.GROUPID_PREFIX)},i),s!==W.CONV_OT_STATE.none&&void 0!==s&&(n.outside=s),t&&Q.a.PinDataManager.pin([n.userId]),n.verified=!0,this.setCacheData(e,n,!0),this.updateInDB(n),n})).then((e=>{a(e)})).catch((e=>{A.default.logCoreError(e),n(e)}))}))}updateLastMsgId(e,t){const s=this.data.get(e);if(s&&s.lastSmsLocalId===t)return Promise.resolve(s);const i=new Map;return i.set("lastSmsLocalId",t),this.updateFields(e,i)}updateInfoCheckSearch(e,t,s){const i=this.data.get(e);if(i&&i.infoCheckSearch&&i.infoCheckSearch.lastMessageTime===t)return Promise.resolve(i);const a=new Map;return a.set("infoCheckSearch",{lastMessageTime:t,lastType:s}),this.updateFields(e,a)}updateConvSetting(e,t){let s=this.data.get(e);if(!s){const i=!!this.doneLoadDB;s={userId:e,verified:i},i||A.default.logCoreInfo(`[${this.name}] - update conv setting before done load db ${e}`,t)}A.default.shallowEqual(s.setting,t)||(s.setting=t,this.setCacheData(e,s,!0),A.default.logCoreInfo(`[${this.name}] - update conv setting for conv ${e}`,t))}async isRespondedByMe(e){const t=await this.getConvById(e);return!!t&&Boolean(t.respondedByMe)}isRespondedByMeSync(e){const t=this.data.get(e);return!!t&&Boolean(t.respondedByMe)}isDoneLoadDB(){return this.doneLoadDB}getConvByIdSync(e){return"string"!=typeof e&&A.default.logCoreInfo(`[${this.name}] - getConvByIdSync with invalid id type`,e,!!this.data.get(e),!!this.data.get(""+e)),this.data.get(e)}getConvById(e){return new Promise(((t,s)=>{if(this.data.has(e))return t(this.data.get(e));this.DBConvInfo.getById(e).then((e=>{t(e)})).catch(s)}))}getAllConvSync(){return Array.from(this.data.values())||[]}getAllConv(){return new Promise(((e,t)=>{if(this.doneLoadDB){return e(this.getAllConvSync())}this.fetchAllHolder||(this.fetchAllHolder=this.DBConvInfo.getAll()),this.fetchAllHolder.then(e).catch(t)}))}getAllConvIds(){return this.getAllConv().then((e=>e.map((({userId:e})=>e))))}getAllConvIdsSync(){return Array.from(this.data.keys())}setPreloadCache(e){this.preloadCached=e}onDoneSyncMobile(){A.default.logCoreInfo(`[${this.name}] - onDoneSyncMobile`),this.getAllConv().then((e=>{e&&this.previewManager.migrate(e.map((e=>e.userId)),!0)}))}setCacheData(e,t,s=!1){this.data.set(t.userId,t),s&&Object(Zs.g)(this.name,e)}updateFields(e,t){return new Promise(((s,i)=>{const a=this.data.get(e),n=a=>{A.default.logCoreInfo(`[${this.name}] - updateFields #2`);const n=Object(T.a)({},a);t.forEach(((e,t)=>{n[t]=e})),this.setCacheData(e,n,!0),this.updateInDB(n).then((()=>{s(n)})).catch(i)};a?n(a):this.DBConvInfo.getById(e).then((e=>{e&&n(e)}))}))}forkDeleteCacheAndDB(e){if(A.default.logCoreInfo(`[${this.name}] - forkDeleteCacheAndDB ${e}`),!Q.a.PinDataManager.isPinned(e)){const t=this.data.get(e);A.default.logCoreInfo(`[${this.name}] - forkDeleteCacheAndDB ${e} ${!!t}`),this.data.delete(e),Object(Zs.e)(this.name,e),this.deleteInDB(e).then((s=>{this.broadcastEvent(Ys.b.DeleteConv,e,t)}))}}broadcastEvent(e,t="",s){this.dispatchEvent(new Ys.a(e,t,s))}shouldSignalUpdate(e,t){return Q.a.PinDataManager.isPinned(e.userId)!==Q.a.PinDataManager.isPinned(t.userId)||e.label!==t.label||e.respondedByMe!==t.respondedByMe}cleanConversation(e){return Object.keys(e).forEach((t=>{xa.includes(t)||delete e[t]})),e}getEmptyConv(e){return{userId:e,isGroup:e.startsWith(W.GROUPID_PREFIX),numMsg:0,respondedByMe:!1,pinned:0,label:null,outside:null,infoCheckSearch:null,topOut:null}}updateInDB(e){const t=this.cleanConversation(Object(T.a)({},e));return this.DBConvInfo.addOrUpdate(t).catch((e=>{A.default.logCoreInfo(`[${this.name}] - updateInDB got error ${e}`)}))}deleteInDB(e){return this.DBConvInfo.remove(e).catch((e=>{A.default.logCoreInfo(`[${this.name}] - deleteInDB got error ${e}`)}))}})||Na)||Na)||Na);var Va=s("NSWB"),Ha=s("1Abx"),qa=s("XEtq"),Wa=s("ZRfj"),Za=s("oH3T"),Ka=s("13iL"),Qa=s("WK05");var $a,Ya=s("dwTj"),Ja=s("RVT8"),Xa=s("hkvp"),en=s("6tnf"),tn=s("sg3c"),sn=s("ofhN"),an=s("D8f9"),nn=s("bgEr"),rn=s("PGx3");const on="9999999999999999",cn="zum_m",ln="1.0.0",dn=!1,hn="total",un=e=>({convId:e,smsUnreadCount:0,smsUnreadNotCount:0,mentionUnreadCount:0,strangerUnreadCount:0,lastProcessMsgId:"",lastSeenReactId:"",unreadMark:void 0}),gn={CALL_INIT:!1},mn=1,pn=2;Object(ie.b)(Ja.b)($a=function(e,t){return i.ModuleContainer.inject(Xa.b)(e,void 0,0)}($a=Reflect.metadata("design:type",Function)($a=Reflect.metadata("design:paramtypes",[void 0===Ys.IReactiveDB?Object:Ys.IReactiveDB])($a=class extends De.b{constructor(e){super(),this.DBConvUnread=e,this.name=void 0,this.key=void 0,this.didInit=void 0,this.doneLoadDB=void 0,this.data=void 0,this.pendingMessage=void 0,this.previewMsgs=void 0,this.pendingClearUnread=void 0,this.fetchAllHolder=void 0,this.total=void 0,this.loadState=gn,this.isLoadDBStarted=void 0,this.updateTotalQueue=void 0,this._logger=void 0,this.setupQueue=()=>Object(Ba.queue)((async e=>{this.doneLoadDB&&await this.calculateComputeUnreadCount(e)}),1),this._getDeletedMsgByTTLItem=(e,t)=>{if(t)return t.find((t=>e.msgId?e.msgId===t.msgId:e.cliMsgId===t.cliMsgId))},this.name=Ja.a,this.key="convId",this.didInit=!1,this.doneLoadDB=!1,this.data=new Map,this.isLoadDBStarted=!1,this.pendingMessage=new Map,this.previewMsgs=[],this.pendingClearUnread=new Map,this.fetchAllHolder=null,this.total=this.getEmptyTotal(),this.updateTotalQueue=this.setupQueue()}init(){this.didInit||(this.logger.zsymb(3,"LQoxZ4",["call init unread","Iv2QLD"]),this.didInit=!0,this.addListener(),this.onState("CALL_INIT"))}onState(e){this.loadState[e]=!0;const t=Object.values(this.loadState).every((e=>!0===e));t&&!this.isLoadDBStarted&&(this.logger.zsymb(3,"KWYttz",["done all state, ready to load db...","Z5LOg2"]),this.loadData())}get logger(){return this._logger||(this._logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger(Ss.ZLoggerNametags.conversation,[Ss.ZLoggerNametags.unread])),this._logger}getEmptyTotal(){return{convId:"total",smsUnreadCount:0,smsUnreadNotCount:0,mentionUnreadCount:0,strangerUnreadCount:0,lastProcessMsgId:"0",lastSeenReactId:"0",unreadMark:0,smsUnreadNomute:0}}loadData(){const e=n.default.getInstance().getItemForCurrentUser(cn);if(e===ln)this.isLoadDBStarted=!0,this.logger.zsymb(3,"w5o6yB",["start load unread {}","apx5uQ"],e),this.fetchAllHolder||(this.fetchAllHolder=this.DBConvUnread.getAll()),this.fetchAllHolder.then((e=>{this.onLoadUnreadFromDBV2(pn,e),this.doDoneLoadDBTask()}));else{Q.a.ConvInfoDataManager.isDoneLoadDB()&&(this.isLoadDBStarted=!0,this.migrateV2())}}async migrateV2(){const e=n.default.getInstance(),t=e.getItemForCurrentUser(cn)===ln;if(this.logger.zsymb(3,"0v7hbQ",["call migrate unread {}","LWFEu4"],t),t)return;const s=Q.a.ConvInfoDataManager.getAllConvSync(),i=[];s.forEach((e=>{const t=e.smsUnreadCount||0,s=e.smsUnreadNotCount||0,a=e.mentionUnreadCount||0,n=e.unreadMark||null;if(!(e&&e.userId&&(t||s||a||n)))return;const r={convId:e.userId,smsUnreadCount:t,smsUnreadNotCount:s,strangerUnreadCount:0,mentionUnreadCount:a,lastProcessMsgId:e.lastMessageIdFromServerv2||"0",lastSeenReactId:e.lastSeenReactId||"0",unreadMark:n};i.push(r)})),this.onLoadUnreadFromDBV2(mn,i),this.doDoneLoadDBTask(),this.logger.zsymb(3,"5nqtPy",["done migrate unread {}","SsFFxN"],i.length),e.setItemForCurrentUser(cn,ln)}doDoneLoadDBTask(){const e=Array.from(this.data.values());this.doneLoadDB=!0,this.broadcastEvent(Ys.b.DoneLoadDB,"total",e),this.logger.zsymb(3,"dCYVv5",["done load unread {}","bn6t8U"],e.length),Object(rn.e)(e),setTimeout((()=>{this.unreadChanged("init")}),200)}addListener(){Q.a.MuteDataManager.addEventListener(Ys.b.MuteChanged,(e=>{this.onMuteConversation(e.convId,!!e.payload)})),Q.a.ConvInfoDataManager.addEventListener(Ys.b.LeaveGroup,(e=>{this.doDeleteUnread(e.convId)})),Q.a.ConvInfoDataManager.addEventListener(Ys.b.DeleteConv,(e=>{this.doDeleteUnread(e.convId)})),Q.a.ConvInfoDataManager.addEventListener(Ys.b.EmptyConv,(e=>{this.doDeleteUnread(e.convId)})),Q.a.ConvInfoDataManager.addEventListener(Ys.b.DoneLoadDB,(e=>{this.onState("CALL_INIT")})),Q.a.ArchivedChatManager.addEventListener(Ys.b.UpdateListArchivedChat,(e=>{this.onArchivedChat(e.convId)})),N.default.subscribe(((e,t)=>{if(null!=t&&t.length&&e===P.ConversationListActions.CLEAR_MARK_AS_UNREAD)t.forEach((e=>{this.updateUnreadMark(e,null)}));else if(null!=t&&t.length&&e===P.GeneralActions.UPDATE_HIDDEN_CHAT)for(let s=0;s<t.length;s++){const e=t[s];this.onHiddenConversation(e.uid,e.isHide)}}))}getItem(e,t){if(e.key===hn)return this.total;return this.data.get(e.key)}getList(e,t){return Array.from(this.data.keys())}onGetItemFailure(e){}onGetListFailure(e){throw new Error("Method not implemented.")}onMuteConversation(e,t){const s=this.data.get(e);!s||s.smsUnreadCount<1&&!s.unreadMark||Le.a.isThreadHidden(e)||!Object(nn.a)().enable_for_oa&&$s.a.isOAType({userId:e})||(this.logger.zsymb(0,"E9eTyW","onMuteConversation:",e,t,s.smsUnreadCount,s.smsUnreadNotCount),this.unreadChanged(e))}onHiddenConversation(e,t){const s=this.data.get(e);!s||s.smsUnreadCount<1&&!s.unreadMark||_t.default.isMuted(e)||!Object(nn.a)().enable_for_oa&&$s.a.isOAType({userId:e})||(this.logger.zsymb(0,"qT35O7","onHiddenConversation: ",e,t,s.smsUnreadCount,s.smsUnreadNotCount),this.unreadChanged(e))}onArchivedChat(e){const t=this.data.get(e);!t||t.smsUnreadCount<1&&!t.unreadMark||_t.default.isMuted(e)||!Object(nn.a)().enable_for_oa&&$s.a.isOAType({userId:e})||this.unreadChanged(e)}onChangeConvLabel(e,t,s){const i=this.data.get(e);t===s||!i||i.smsUnreadCount<1||_t.default.isMuted(e)||this.unreadChanged(e)}onReceivePreviewMessages(e){e.length>0&&(this.previewMsgs=[...this.previewMsgs,...e])}onReceiveNewMessagesOld(e,t,s){if(!s||!t)return;const i=this.data.get(e);if(i)this.logger.zsymb(0,"6CpHka","receive msg",e,i.lastProcessMsgId,s),(!i.lastProcessMsgId||i.lastProcessMsgId<t)&&(this.handleNewMessages(e,s,t),Object(Zs.g)(this.name,e));else{const t=this.pendingMessage.get(e),i=t?s.concat(t):s;this.pendingMessage.set(e,i),i.length===s.length&&this.DBConvUnread.getById(e).then((t=>{if(!t){const t=this.pendingMessage.get(e);if(t){const s=t.filter(((e,t,s)=>s.indexOf(e)===t)),i=ts.b.getLastMessageInList(s);if(!i)return;this.pendingMessage.delete(e),this.handleNewMessages(e,s,i.msgId),Object(Zs.g)(this.name,e)}}}))}}onReceiveNewMessages(e,t,s){if(!s||!s.length||!t)return;const a=this.data.get(e);if(this.doneLoadDB){if(!a||!a.lastProcessMsgId||a.lastProcessMsgId<t){const i=s.map((e=>e.msgId)).join("-");this.logger.zsymb(0,"fr9U1j",`onReceiveNewMessages: ${null==a?void 0:a.lastProcessMsgId} ${e} ${t} ${i}`),this.handleNewMessages(e,s,t),Object(Zs.g)(this.name,e)}}else{const t=this.pendingMessage.get(e),i=t?s.concat(t):s;this.pendingMessage.set(e,i)}i.ModuleContainer.resolve(di.TUnreadSubChatTabStateManager).handleReceiveLatestMessage({convId:e,msgId:t})}onDoneOffLineMessages(){this.logger.zsymb(0,"ABh5QW","ph7 done offline"),ki.b.onDoneEntry(ki.a.FIRST_FETCH),this.previewMsgs.length>0&&setTimeout((()=>{this.handlePreviewMsgs()}),0)}doDeleteUnread(e){if(!e)return;Object(rn.a)([e]);const t=this.data.get(e);this.logger.zsymb(0,"u6gT0y",`doDeleteUnread ${!!t}`),this.data.delete(e)&&(Object(Zs.e)(this.name,e),this.unreadChanged(e)),this.deleteInDB(e)}onReceiveDeleteConvMsg(e,t){if(this.doneLoadDB){const s=this.safeGetUnreadCached(e);if(0===s.smsUnreadCount)return;if(t>=+s.lastProcessMsgId){const t=Object(T.a)(Object(T.a)({},s),{},{smsUnreadCount:0,smsUnreadNotCount:0});this.data.set(t.convId,t),Object(Zs.g)(this.name,e),this.unreadChanged(e)}}else this.pendingClearUnread.set(e,t)}onClearUnreadConversations(e){if(!e||e.length<0)return;let t=[];for(let s=0;s<e.length;s++){const i=e[s],a=this.data.get(i.userId)||un(i.userId);this.logger.zsymb(0,"VAp24-","onClearUnreadConversations",!!i,null==a?void 0:a.smsUnreadCount),i&&(t.push(i.userId),a.smsUnreadCount>0&&_t.default.getLastMessageFrom(i.userId,i.lastSmsLocalId,on,a.smsUnreadCount,!0).then((e=>{let t={};if(e&&e.length>0)for(let i=0;i<e.length;i++){let s=e[i];A.default.validMessageFromOther(s)&&(t[s.msgId]=s)}const s={userId:i.userId,lastSmsLocalId:i.lastSmsLocalId,smsUnreadCount:a.smsUnreadCount};this.clearUnreadConversation(s,t),this.resetUnreadToZero(i.userId,a.lastProcessMsgId)})).catch((e=>{this.logger.zsymb(21,"sAyo6u",["clear unread conv failure {}","kDMrYR"],e)})),Qa.a.clearUnreadIfExist({userId:i.userId,lastSeenReactId:a.lastSeenReactId}))}Object(rn.a)(t,e.length>0)}onReadConversation(e,t){var s;if(U.default.mark_unread.enable&&!Object(rn.c)(e))return this.logger.zsymb(0,"JM4nDv",`[read-message] dont clear ${e}`,U.default.mark_unread.enable,Object(rn.c)(e)),!1;Object(rn.b)(e)&&(e.startsWith(W.GROUPID_PREFIX)?fe.default.logAction(2160024):fe.default.logAction(2160023),fe.default.logAction(2160022));const i=this.data.get(e)||un(e),a=i.smsUnreadCount;if(!t&&!a){this.logger.zsymb(0,"nih6s9",`[read-message] dont clear ${e} unread `,a,t);const s=Qa.a.sendClearUnread(e,i.lastSeenReactId);return Object(rn.a)([e],!1),s!=i.lastSeenReactId&&(i.lastSeenReactId=s,this.data.set(e,Object(T.a)({},i)),Object(Zs.g)(this.name,e),this.updateInDB(i)),!1}const n=this.acquireConvManager().getConvByIdSync(e);if(!n)return this.logger.zsymb(0,"doTMBi",`[read-message] convinfo not exists ${e}`),!1;const r=[],o={},c=n.lastSmsLocalId?n.lastSmsLocalId.toString().split("_")[0]:"";let l=!1;const d=null===(s=Wt.b.messageCache)||void 0===s?void 0:s.getLast({userId:e},a);for(let g=d.length-1;g>-1;g--){let e=d[g];if(A.default.validMessageFromOther(e)&&!r.includes(e.msgId)&&(r.push(e.msgId),o[e.msgId]=e,e.msgId==c&&(l=!0),r.length==a))break}const h={userId:e,lastSmsLocalId:n.lastSmsLocalId,smsUnreadCount:a};var u;!c||l||o[c]?this.clearUnreadConversation(h,o):(this.logger.zsymb(0,"3nVsls",`[read-message] append lastMsgIdInConv ${c} ${Object.keys(o).length}`),null===(u=Wt.b.messageCache)||void 0===u||u.getMessageByMsgIdAsync(c,e).then((e=>{o[c]=Object(T.a)({},e),this.clearUnreadConversation(h,o)})).catch((e=>{this.clearUnreadConversation(h,o)})));return Object(rn.a)([e],!1),i.lastSeenReactId=Qa.a.sendClearUnread(e,i.lastSeenReactId),this.resetUnreadToZero(e,i.lastProcessMsgId),!0}getUnreadByConvIdSync(e){return this.data.get(e)}getUnreadByConvId(e){return new Promise(((t,s)=>{if(this.data.has(e))return t(this.getUnreadByConvIdSync(e));this.DBConvUnread.getById(e).then((e=>t(e))).catch(s)}))}getAllUnreadsSync(){return Array.from(this.data.values())}getAllUnreads(){return new Promise(((e,t)=>{if(this.doneLoadDB)return e(this.getAllUnreadsSync());this.fetchAllHolder||(this.fetchAllHolder=this.DBConvUnread.getAll()),this.fetchAllHolder.then((t=>e(t))).catch(t)}))}resetUnreadToZero(e,t){return this.getUnreadByConvId(e).then((s=>{if(Za.b.onClearUnreadConv(e),!s||!s.smsUnreadCount&&!s.smsUnreadNotCount)return!1;if(this.logger.zsymb(3,"3JzP7W",["resetUnreadToZero {} {} {}","WadIcx"],e,t,s.smsUnreadCount),!$s.b.assertString(t,this.logger))return!1;const i={convId:e,smsUnreadCount:0,mentionUnreadCount:0,strangerUnreadCount:0,smsUnreadNotCount:0,lastProcessMsgId:t,lastSeenReactId:s.lastSeenReactId||"",unreadMark:s.unreadMark};return s.smsUnreadCount>0&&Wa.a.notiMainClearunread(e),this.forkUpdateCacheAndDB(i).then((t=>(this.broadcastEvent(Ys.b.ReadConv,e),!0))).catch((t=>(this.logger.zsymb(21,"b7XBBe",["resetUnreadToZero failure {} {}","iTEMba"],e,t),!1)))}))}isUnreadMessage(e){const{message:t,convId:s,lastProcessMsgId:i}=e,a=ts.b.isMyMessage(t),n=Ha.b.isRead({userId:s,msgId:t.msgId,msgSendDttm:t.ts||t.serverTime||t.sendDttm,msgLocalId:void 0,e2eeStatus:Object(tn.f)(t)}),r=!t.msgId||!i||t.msgId<=i;return!n&&r&&!a}_updateTTLUnreadCount(e,t,s){const i=this.data.get(e)||null;if(this.logger.zsymb(0,"qg-LsA","_updateTTLUnreadCount",e,null==i?void 0:i.smsUnreadCount),i&&i.smsUnreadCount===t&&i.smsUnreadNotCount===s)return;let a=this.safeGetUnreadCached(e);a.smsUnreadCount=t,a.smsUnreadNotCount=s,this.forkUpdateCacheAndDB(a)}updateUnreadTTLConversation(e,t,s){const i=this.getUnreadByConvIdSync(e);if(i){let a=i.smsUnreadCount,n=i.smsUnreadNotCount;t.filter((t=>t.ttlType===an.a.Message&&this.isUnreadMessage({message:this._getDeletedMsgByTTLItem(t,s),convId:e,lastProcessMsgId:i.lastProcessMsgId}))).forEach((e=>{const t=this._getDeletedMsgByTTLItem(e,s),i=A.default.getDataReminder(t),r=ts.b.isMyMessage(t);i&&r&&(t.idTo===U.default.sendToMeId||r)?(n-=1,a-=1):a-=1})),this._updateTTLUnreadCount(e,Math.max(a,0),Math.max(n,0))}}updateUnreadCount(e,t){const s=this.data.get(e)||null;if(this.logger.zsymb(0,"OlyJs-","updateUnreadCount",e,null==s?void 0:s.smsUnreadCount),s&&s.smsUnreadCount===t)return;let i=this.safeGetUnreadCached(e);i.smsUnreadCount=t,this.forkUpdateCacheAndDB(i)}updateMentionCount(e,t){this.logger.zsymb(0,"tiEIKn","updateMentionCount",e,t);let s=this.safeGetUnreadCached(e);s.mentionUnreadCount=t,this.forkUpdateCacheAndDB(s,!1),en.a.updateUnreadMentions(this.getTotalMentionCount())}updateLastSeenReactId(e,t){let s=this.safeGetUnreadCached(e);s.lastSeenReactId=t,this.forkUpdateCacheAndDB(s,!1)}updateUnreadMark(e,t){let s=this.safeGetUnreadCached(e);s.unreadMark||(s.unreadMark=null),t||(t=null),t!==s.unreadMark&&(this.total.unreadMark+=t?1:-1,Object(Zs.g)(this.name,hn),s.unreadMark=t,this.forkUpdateCacheAndDB(s))}shouldClearUnread(e,t){const s=this.data.get(e),i=null==s?void 0:s.smsUnreadCount,a=null==s?void 0:s.lastProcessMsgId;return!!i&&!!(a&&t&&+t>=+a)}async forkUpdateCacheAndDB(e,t=!0){this.data.set(e.convId,e),Object(Zs.g)(this.name,e.convId),t&&this.isValidConvKey(e.convId)&&this.unreadChanged(e.convId),await this.updateInDB(e)}safeGetUnreadCached(e){const t=this.data.get(e);let s;return s=t?Object(T.a)({},t):{convId:e,smsUnreadCount:0,smsUnreadNotCount:0,mentionUnreadCount:0,strangerUnreadCount:0,lastProcessMsgId:"0",lastSeenReactId:"0",unreadMark:null},s}getTotalMentionCount(){let e=0;return this.data.forEach((t=>{e+=t.mentionUnreadCount})),e}isValidConvKey(e){return!(!e||e.length<3)&&("null"!=e&&(e!==W.CONV_FILTER.STRANGER&&e!==hn))}unreadChanged(e){"null"!=e&&(this.updateTotalQueue.remove((e=>!0)),this.updateTotalQueue.push(e))}async calculateComputeUnreadCount(e){try{var t;const a=this.getEmptyTotal(),n=(null===(t=this.data.get(W.CONV_FILTER.STRANGER))||void 0===t?void 0:t.smsUnreadCount)||0;let r=0;const o=i.ModuleContainer.resolve(di.TUnreadSubChatTabStateManager),c=o.getAllSeenMilestones(),l={[di.SubChatTabType.FOCUSED]:!1,[di.SubChatTabType.ARCHIVED]:!1},d=new Map,h=new Map,u=new Map;Q.a.LabelDataManager.getAllLabelIds().map((e=>{const t=""+e;u.set(t,t)}));const g=new Map,m=[];for(let e of Array.from(this.data.keys())){if(!this.isValidConvKey(e))continue;const t=this.data.get(e);if(!t)continue;if(!(Boolean(t.smsUnreadCount)||Boolean(t.smsUnreadNotCount)||Boolean(t.unreadMark)))continue;const s=o.getSubtabTypeOfConv(e),i=_t.default.isMuted(e),a=t.lastProcessMsgId;!i&&o.isValidSubChatTabType(s)&&a>c[s]&&(l[s]=!0);if(Le.a.isThreadHidden(e))continue;li.a.isArchivedChat(e)||(g.set(e,t),m.push(e))}dn;if((await $s.a.verifyOATypeAsync(m)).forEach((({cid:e,isOA:t})=>{const s=g.get(e),i=s.convId,n=this.acquireConvManager().getConvByIdSync(i),o=_t.default.isMuted(i);const c=s.smsUnreadCount||0,l=s.smsUnreadNotCount||0;if(a.smsUnreadCount+=c,n&&!o&&(!t||Object(nn.a)().enable_for_oa)&&n.userId!==W.FAKE_CONVERSATION_ID.FRIEND_CENTER){const e=Math.max(c-l,0);a.smsUnreadNomute+=e;const t=n.label?""+n.label:"",o="0"==t||!!t;if(o&&(d.has(t)?d.set(t,d.get(t)+e):d.set(t,e)),s.unreadMark){const e=a.unreadMark||0;a.unreadMark=e+1,o&&(h.has(t)?h.set(t,h.get(t)+1):h.set(t,1))}e>0&&this.isInStrangerBox(i)&&(r+=e)}})),this.total.smsUnreadCount!==a.smsUnreadCount||this.total.smsUnreadNomute!==a.smsUnreadNomute||this.total.unreadMark!==a.unreadMark){var s;const t=null===(s=this.data.get(e))||void 0===s?void 0:s.smsUnreadCount,i=_t.default.isMuted(e);this.total=a,this.dispatchEvent(new Ys.a(Ys.b.ChangeUnreadCount,hn,{unreadNoMute:a.smsUnreadNomute,totalUnread:a.smsUnreadCount,convId:e,currentUnread:t,curentUnreadNoMute:i?0:t})),this.data.set(hn,a),Object(Zs.g)(this.name,hn)}if(o.handleShowReddotsAtSubChatTab(l),n!==r){const e=this.safeGetUnreadCached("");e.smsUnreadCount=r,e.convId=W.CONV_FILTER.STRANGER,this.data.set(W.CONV_FILTER.STRANGER,e),Object(Zs.g)(this.name,W.CONV_FILTER.STRANGER)}for(let e of Array.from(d.keys())){const t=this.safeGetUnreadCached("");t.smsUnreadCount=d.get(e),t.unreadMark=h.get(e),this.data.set(e,t),u.delete(e),Object(Zs.g)(this.name,e)}for(let e of Array.from(u.keys()))this.data.delete(e)&&Object(Zs.g)(this.name,e)}catch(a){this.logger.zsymb(21,"xUFAf8",[" unread err - contact phucnh7 please!!! {}","kfYZ2q"],a)}}acquireConvManager(){return Q.a.ConvInfoDataManager}onLoadUnreadFromDBV2(e,t){if(this.logger.zsymb(0,"MW5j-V","onLoadUnreadFromDB",t.length),t.length<1)return;const s=(new Date).getTime().toString();Object(Zs.i)(s);for(let i=0;i<t.length;i++){const a=t[i];if("object"==typeof a.lastProcessMsgId||"string"==typeof a.lastProcessMsgId&&a.lastProcessMsgId.includes("object")?(a.lastProcessMsgId="0",this.logger.zsymb(18,"_ESP7N","Corrected lastProcessMsgId!"),Si.default.increaseFailed(151101,0,0,0,Date.now())):Ha.b.isRead({userId:a.convId,msgId:+a.lastProcessMsgId,e2eeStatus:void 0,msgSendDttm:void 0,msgLocalId:void 0})&&(a.smsUnreadCount||a.smsUnreadNotCount)&&(this.logger.zsymb(0,"yiPu1Y","clear offline",a.convId,a.smsUnreadCount),a.smsUnreadCount=0,a.strangerUnreadCount=0,a.smsUnreadNotCount=0),this.pendingClearUnread.has(a.convId)){const e=this.pendingClearUnread.get(a.convId);e&&e>=+a.lastProcessMsgId&&(this.logger.zsymb(0,"uDxozK","clear pending",this.pendingClearUnread.size,a.convId),a.smsUnreadCount=0,a.strangerUnreadCount=0,a.smsUnreadNotCount=0)}"null"===a.lastProcessMsgId&&(a.lastProcessMsgId=""),this.data.set(a.convId,a),Object(Zs.f)(s,this.name,a.convId),e===mn&&this.updateInDB(a),a.unreadMark&&this.total.unreadMark++}this.pendingClearUnread.clear(),this.processPendingMessages(),Object(Zs.c)(s)}processPendingMessages(){this.logger.zsymb(0,"yQ9N2i","start processPendingMessages",this.pendingMessage.size),this.pendingMessage.forEach(((e,t)=>{const s=new Map,i=this.data.get(t);e.forEach((e=>{var t;(!i||i.lastProcessMsgId<e.msgId)&&s.set(`${(t=e).uidFrom||t.fromUid}_${t.idTo||t.toUid}_${t.cliMsgId}`,e)})),this.logger.zsymb(0,"AeBuXM","check processPendingMessages #2",t,null==i?void 0:i.smsUnreadCount,e.map((e=>e.msgId)),s.keys());const a=Array.from(s.values()),n=ts.b.getLastMessageInList(a);this.handleNewMessages(t,a,null==n?void 0:n.msgId)})),this.pendingMessage.clear()}handleNewMessages(e,t,s){if(!t||!t.length)return;if(!$s.b.assertString(s,this.logger))return;let i=!1;const a={convId:e,strangerUnreadCount:0,smsUnreadCount:0,smsUnreadNotCount:0,mentionUnreadCount:0,lastProcessMsgId:s,lastSeenReactId:"0"},n=Date.now(),r=new Set;if(t.forEach((t=>{const o=ts.b.isMyMessage(t);if(t.status!==W.MSG_READ&&!o){const s=t.ts||t.serverTime||t.sendDttm;Ha.b.isRead({userId:e,msgId:t.msgId,msgSendDttm:s,msgLocalId:void 0,e2eeStatus:Object(tn.f)(t)})&&(U.default.stagingAccount&&this.logger.zsymb(0,"AdaANb",`mark msg status as read ${e} ${t.msgId}`),t.status=W.MSG_READ)}let c=qa.a.get(t.msgId,t.status);c!=t.status&&U.default.stagingAccount&&this.logger.zsymb(0,"caXCRF",`change msg status ${t.status} => ${c}`),t.status=c;let l=!1;if("chat.todo"===t.msgType){let e=t.content;if(e){"todo.remind"===e.action&&(l=!0)}}let d=A.default.getDataReminder(t);var h,u;t.status!==W.MSG_READ&&!o||!0===l?(t.paramsExt&&A.default.valueValid(t.paramsExt.countUnread)&&0==t.paramsExt.countUnread&&(a.smsUnreadNotCount+=1),this.isCallTimeMessage(t)||(a.smsUnreadCount+=1,a.strangerUnreadCount+=1),Va.b.isMessageMentionMe(t)&&a.mentionUnreadCount++):d&&o&&(t.idTo===U.default.sendToMeId||o)?(a.smsUnreadCount+=1,a.smsUnreadNotCount+=1,this.logger.zsymb(0,"2rzJpn",`new unread #2: ${n} ${e} ${t.msgId} ${t.idTo} ${t.toUid} ${t.src} ${s}`)):!(h=t)||"0"==h.uidFrom&&(null===(u=h.paramsExt)||void 0===u?void 0:u.platformType)==Ui.i.DeviceIds.SYSTEM?(r.add(t.msgId),this.logger.zsymb(0,"iY4Xhw","_addMessages: skipped clear unread for",t.idTo)):t.isCallMessage||(a.smsUnreadCount=0,a.strangerUnreadCount=0,a.mentionUnreadCount=0,i=!0),a.smsUnreadCount>0&&ki.b.markGotUnread(e,t.msgId),ki.b.isLastMsgV2(t)&&this.onDoneOffLineMessages()})),r.has(s))for(let c=t.length-1;c>=0;c--){const s=t[c];if(A.default.validMessageFromServer(s)&&!r.has(s.msgId)){if(this.logger.zsymb(0,"HoEq_B","update last process id",e,a.lastProcessMsgId,s.msgId),a.lastProcessMsgId=s.msgId,!$s.b.assertString(s.msgId,this.logger))return;break}var o;0==c&&(a.lastProcessMsgId=(null===(o=this.data.get(e))||void 0===o?void 0:o.lastProcessMsgId)||"0")}return Object(rn.a)([e]),this.updateUnread(e,i,a)}handlePreviewMsgs(){if(!this.previewMsgs.length)return;const e=[...this.previewMsgs];this.previewMsgs=[],this.logger.zsymb(0,"P0y4wt","handle preview",e.map((e=>e.msgId))),e.forEach((e=>{const t=e.toUid,s=Ya.default.checkDuplicate(t,{uidFrom:e.fromUid,cliMsgId:e.cliMsgId});s&&s.src&&s.msgId!==e.msgId&&(this.logger.zsymb(0,"HCXMkv","detect dup msg",e.msgId,s.msgId),e.msgId=s.msgId),this.onReceiveNewMessages(t,e.msgId,[e])}))}updateUnread(e,t,s){let i=this.data.get(e);if(i){const e=i.lastSeenReactId||"0";t?i=s:(i.smsUnreadNotCount+=s.smsUnreadNotCount,i.smsUnreadCount+=s.smsUnreadCount,i.strangerUnreadCount+=s.strangerUnreadCount,i.mentionUnreadCount+=s.mentionUnreadCount,i.lastProcessMsgId=s.lastProcessMsgId),i.lastSeenReactId=e}else{if(i=s,!i)return void this.logger.zsymb(18,"bZ6FZc",`updateUnread undefined item ${e}`);i.lastSeenReactId=sn.b.getLastSeen(e)||"0"}this.data.set(e,Object.assign({},i)),this.updateInDB(i),0!=s.mentionUnreadCount&&en.a.updateUnreadMentions(this.getTotalMentionCount()),this.unreadChanged(e)}isInStrangerBox(e){const t=Q.a.ConvInfoDataManager.getConvByIdSync(e);return Wa.a.isInStrangerBox(t)}isCallTimeMessage(e){if("chat.recommended"===e.msgType&&e.content){if(e.content.action===W.CallMessageAction.CallTime)return!0;if(e.content.action===W.CallMessageAction.MissCall){let s=e.content.params;if("string"==typeof s)try{s=JSON.parse(e.content.params)}catch(t){}if(s&&3===s.reason)return!0}}return!1}clearUnreadConversation(e,t={}){if(e&&e.smsUnreadCount)try{let s=!0,i=Object.keys(t);i&&0!=i.length||(s=!1,this.logger.zsymb(0,"xsK3nc",`[read-message] actually, no need send seen in that case 2: ${i.length}`)),!s&&U.default.chat_aggressive_send_seen&&(s=!0),s?(i&&0!==i.length?this.sendClearUnreadToServer(t,e.userId):_t.default.getLastMessageFrom(e.userId,e.lastSmsLocalId,on,e.smsUnreadCount,!0).then((t=>{let s=[],i={};if(t&&t.length)for(let e=0;e<t.length;e++){let a=t[e];A.default.validMessageFromOther(a)&&(s.push(a.msgId),i[a.msgId]=a)}0===s.length?this.logger.zsymb(3,"Ylzeio",["- [read-message] get ids.length == 0 {}","xX8Ezg"],e.userId):this.sendClearUnreadToServer(i,e.userId)})).catch((e=>{this.logger.zsymb(21,"4nuDLx",[" [read-message] get msgs err {}","7Ga7z5"],e)})),$.a.emitWithKey(Y.d.userOnNewDeviceTracking,Y.d.clearUnreadMessages,{convId:e.userId})):this.logger.zsymb(3,"FPlFVW",["[read-message] no send {}","wiO5qH"],e.userId)}catch(s){this.logger.zsymb(21,"ceaa0p",["[read-message] err {}","e_0jw_"],s)}else this.logger.zsymb(0,"nghDLY",`[read-message] actually, no need send seen in that case 1: ${null==e?void 0:e.userId}`)}async sendClearUnreadToServer(e={},t){const s=Object.keys(e),i=Wa.a.isGroup(t),a=ms.a.newReq();try{await Ni.default.sendSeen(e,t,i,a),U.default.stagingAccount&&this.logger.zsymb(0,"qT78NZ",`[read-message] done ${t} msgId:\n\t\t\t\t\t${s&&s.length?s[s.length-1]:0}`)}catch(n){if(this.logger.zsymb(21,"rdpJmh",["[read-message] err {}","e_0jw_"],n),!(s&&s.length>0))throw this.logger.zsymb(21,"IJGmEE",["[read-message] send seen fail!!! convId:{} msgId len = 0","1RTvWW"],t),n;if(this.logger.zsymb(21,"3zFRSW",["[read-message] send seen fail!! convId:{} msgId:{}","2FFI_t"],t,s[s.length-1]),n&&(114===n.error_code||-69===n.error_code))throw this.logger.zsymb(21,"v9HZam",["[read-message] send seen fail!!! no need retry {}","iUr-iD"],n.error_code),n;throw U.default.retrySendSeen?(this.logger.zsymb(21,"FfVffK",["[read-message] send seen fail!!! retry","CsoZM3"]),Ka.b.retryAction(Ka.a.SEND_SEEN_V2,[e,t,i,a],{startedTime:Date.now(),duration:U.default.retrySendSeen.timeout})):this.logger.zsymb(21,"eovMTg",["[read-message] send seen fail!!! not retry","x2BMs1"]),n}}broadcastEvent(e,t,s){this.dispatchEvent(new Ys.a(e,t,s))}updateInDB(e){null==e.lastSeenReactId&&(e.lastSeenReactId=sn.b.getLastSeen(e.convId)||"0",this.logger.zsymb(18,"A0JGF6",`update invalid lastSeen ${e.convId}`)),$s.b.assertString(e.lastProcessMsgId,this.logger)&&this.DBConvUnread.addOrUpdate(e)}deleteInDB(e){this.DBConvUnread.remove(e)}})||$a)||$a)||$a);var fn=s("8Nax"),vn=s("GSHL"),_n=s("w5bt");let bn;var yn,In;(yn=bn||(bn={})).modelToEntity=function(e){if(!e)throw new Error("[PreviewHelper] Convert undefined model to entity");return{convId:e.convId,msgId:e.msgId,dName:e.dName,message:e.message,messageType:e.messageType,messageTime:e.messageTime,isGroup:e.isGroup,fromUid:e.fromUid,toUid:e.toUid,urgencyLevel:e.urgencyLevel,properties:e.properties?{type:e.properties.type}:null,mentions:e.mentions?e.mentions:null,ttl:e.ttl,cliMsgId:e.cliMsgId,status:e.status,substate:e.substate,computedMessage:e.computedMessage,computedIcon:e.computedIcon}},yn.entityToModel=function(e){return e?{convId:e.convId,msgId:e.msgId,dName:e.dName,message:e.message,messageType:e.messageType,messageTime:e.messageTime,isGroup:e.isGroup,fromUid:e.fromUid,toUid:e.toUid,urgencyLevel:e.urgencyLevel,properties:e.properties,mentions:e.mentions,ttl:e.ttl,cliMsgId:e.cliMsgId,status:e.status,substate:e.substate,computedMessage:e.computedMessage,computedIcon:e.computedIcon,src:"db.preview",verified:!1}:null};const Sn="zpm_m",Cn="1.0.0";Object(ie.b)(_n.b)(In=function(e,t){return i.ModuleContainer.inject(vn.b)(e,void 0,0)}(In=Reflect.metadata("design:type",Function)(In=Reflect.metadata("design:paramtypes",[void 0===Ys.IReactiveDB?Object:Ys.IReactiveDB])(In=class extends De.b{constructor(e){super(),this.DBConvPreview=e,this.name=void 0,this.key=void 0,this.didInit=void 0,this.data=void 0,this.list=void 0,this.deleteQueue=void 0,this.doneLoadDB=void 0,this.migrating=void 0,this.fetchAllHolder=void 0,this._Logger=void 0,this.name=_n.a,this.key="convId",this.didInit=!1,this.data=new Map,this.list=new Map,this.deleteQueue=[],this.doneLoadDB=!1,this.migrating=!1,this.fetchAllHolder=null}init(){return this.didInit?Promise.resolve():(this.didInit=!0,this.loadData())}get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger("conversation",[this.name])),this._Logger}signalRenderItem(e,t){Object(Zs.g)(e,t),this.broadcastEvent(Ys.b.PreviewChanged,t,{changedItem:this.data.get(t),all:Array.from(this.data.values())}),Object(Zs.h)(e,"all")}loadData(){return new Promise(((e,t)=>{n.default.getInstance().getItemForCurrentUser(Sn)!==Cn||this.migrating?e():(this.Logger.zsymb(3,"HaNid1",["start load preview","Ix9j9n"]),this.fetchAllHolder||(this.fetchAllHolder=this.DBConvPreview.getAll()),this.fetchAllHolder.then((t=>{this.onLoadPreviewsFromDB(t).then(e).catch((t=>{this.Logger.zsymb(21,"ygFv3j",["load previews from db failure #1! {}","e06tAI"],t),e()}))})).catch((t=>{this.Logger.zsymb(21,"pr6Tb8",["load preview from db failure #2! {}","Rf_38T"],t),e()})))}))}async revalidate(e){const t=!!this.getPreviewByIDSync(e),s=await Ua.b.getPreviewMessage(e).catch((s=>(this.Logger.zsymb(21,"-kPSrG",["revalidate failure #1 {} {} {}","goi6zS"],e,t,s),{previewMsg:void 0})));return!!s.previewMsg&&this.onReceiveNewMessage("db.message",s.previewMsg).then((s=>(this.Logger.zsymb(3,"dWzTeN",["revalidate success {} {} {}","MgX8wS"],e,t,s),!0))).catch((s=>(this.Logger.zsymb(21,"I6lL3W",["revalidate failure #2 {} {} {}","vyfl-e"],e,t,s),!1)))}migrate(e,t=!1){return new Promise((s=>{const i=n.default.getInstance().getItemForCurrentUser(Sn);if(i===Cn&&!t)return;if(this.Logger.zsymb(3,"2niMpl",["start migrate {} {}","HG92nD"],i,t),this.migrating=!0,0===e.length)return this.doneMigratePreivew(0),s(0);let a=0,r=0;const o=()=>{if(a++,a===e.length)return this.doneMigratePreivew(r),s(r)},c=()=>{r++,o()},l=()=>{for(let t=0;t<e.length;t++)Ua.b.getPreviewMessage(e[t]).then((s=>{s&&s.previewMsg?this.onReceiveNewMessage("db.message",s.previewMsg).then(c).catch(o):(this.Logger.zsymb(3,"QaycwO",["migrate not exists msg {}","hnLkdI"],e[t]),o())})).catch((s=>{o(),this.Logger.zsymb(21,"PoH5km",["migrate failure for conv {} {}","nyUkp5"],e[t],s)}))};let d=e.filter((e=>e!==W.FAKE_CONVERSATION_ID.FRIEND_CENTER&&e!==W.FAKE_CONVERSATION_ID.GROUP_CENTER&&!e.startsWith(W.GROUPID_PREFIX)));if(d.length>0)return Z.default.getProfileFriendByIds(d,W.SRC_GET_PROFILE.FETCH_MINI_INFO).then((()=>{l()})).catch((()=>{l()}));l()}))}doneMigratePreivew(e){this.Logger.zsymb(3,"JuU5d4",["done migrate preview {}","froNLN"],e);n.default.getInstance().setItemForCurrentUser(Sn,Cn),this.broadcastEvent(Ys.b.DoneMigratePreview,"")}upgradeItemsVersion(e=[]){this.Logger.zsymb(3,"JlR1YO",["upgradeItemsVersion","QC2KMX"]);const t=(new Date).getTime().toString();Object(Zs.i)(t),0!==e.length?e.forEach((e=>{Object(Zs.f)(t,this.name,e)})):this.data.forEach((e=>{Object(Zs.f)(t,this.name,e.convId)})),Object(Zs.c)(t)}updateStrangerBox(e){const t=this.data.get(e);t&&(this.data.set(W.CONV_FILTER.STRANGER,Object(T.a)({},t)),Object(Zs.g)(this.name,W.CONV_FILTER.STRANGER))}forceChangeItem(e){this.signalRenderItem(this.name,e)}getItem(e,t){const s=this.data.get(e.key);return s||this.Logger.zsymb(5,"3YCSie",["try to get item not exist in cache {}","iOXr3y"],e.key),s}getList(e,t){return Array.from(this.data.keys())}onGetItemFailure(e){this.Logger.zsymb(11,"L2fEEJ",["onGetItemFailure {}","b-Acu1"],e)}onGetListFailure(e,t){this.Logger.zsymb(11,"TvsaRp",["onGetListFailure {} {}","sMjSgn"],e,t)}onLoadPreviewsFromDB(e){return new Promise(((t,s)=>{if(this.Logger.zsymb(3,"qUoo7k",["onLoadPreviewsFromDB {}","cJH1yT"],null==e?void 0:e.length),!e||0===e.length)return this.doneLoadPreview(0),t();let i=0;const a=()=>{i++,i===e.length&&(this.doneLoadPreview(i),t())};for(let n=0;n<e.length;n++){const t=bn.entityToModel(e[n]);t&&!fn.a.instance.filterExpiredPreview(t)&&(t.messageType=W.MSG_VANISH,t.message="",this.updateInDB(t)),this.addPreviewToManager(t).then((()=>{a()})).catch((e=>{a(),this.Logger.zsymb(21,"-1cRGl",["onload preview failure for item {} {}","oSFh29"],null==t?void 0:t.convId,e)}))}}))}doneLoadPreview(e){this.Logger.zsymb(3,"n15frG",["doneLoadPreview {}","R0BF1d"],e),this.doneLoadDB=!0,this.broadcastEvent(Ys.b.DoneLoadPreview,"",Array.from(this.data.values())),Object(Zs.h)(this.name,"all")}onReceiveNewMessage(e,t){return new Promise(((s,i)=>{if(!t)return s(!1);const a=this.convertDBMessageToPreviewItem(e,t);this.addPreviewToManager(a).then((e=>e?(this.signalRenderItem(this.name,t.toUid),s(!0)):s(!1))).catch(i)}))}onReceiveNewMessages(e,t){return new Promise((s=>{if(!t)return s(!1);const i=this.groupMessageByConvId(t),a=[];for(const e in i){if(!Object.prototype.hasOwnProperty.call(i,e))continue;const t=i[e];for(let e=t.length-1;e>=0;e--){if(ts.b.isValidPreviewMessage(t[e])){a.push(t[e]);break}this.Logger.zsymb(3,"GUBHHO",["receive msg but not preview {}","e6cvew"],t[e].msgId)}}return a.length?Promise.all(a.map((async t=>this.onReceiveNewMessage(e,t)))).then((e=>{const t=e.some((e=>1==e));s(t)})).catch((e=>{this.Logger.zsymb(21,"Gg5eZ4",["add messages to preview got error {}","71R8Vg"],e),s(!1)})):s(!1)}))}onUndoMessage(e,t){if(!t)return;this.Logger.zsymb(3,"rdpoxU",["onUndoMessage {}","KqweSn"],t.msgId);const s=this.convertDBMessageToPreviewItem(e,t);s.messageType=W.MSG_UNDO,s.message="",this.addPreviewToManager(s).then((e=>{e&&this.signalRenderItem(this.name,t.toUid)}))}onUpdateE2EEMessage(e,t){if(!t)return;const s=t.toUid,i=this.data.get(s);if(this.Logger.zsymb(3,"7IpG9p",["onUpdateE2EEMessage {} {} {}","kL6D2c"],s,null==i?void 0:i.msgId,t.msgId),i&&(i.msgId!==t.msgId||!Va.b.isSameMsg(i,t)))return;const a=this.convertDBMessageToPreviewItem(e,t),n=A.default.normalizeMessageTypeFromSubState(null==t?void 0:t.e2eeStatus)||t.msgType;a.message=a.message||ts.b.getPlainText({msgType:n}),a.verified=!0,a.messageType=n,this.data.set(t.toUid,a),this.updateInDB(a),this.signalRenderItem(this.name,t.toUid)}onDeleteMessage(e,t){return new Promise(((e,s)=>{if(!t)return e(!1);this.Logger.zsymb(3,"tclgJC",["onDeleteMessage {}","6OMuMf"],t.msgId);const i=this.convertDBMessageToPreviewItem("db.message",t);this.deleteMessageInManager(i).then((s=>{s?(this.Logger.zsymb(3,"IWOUFM",["onDeleteMessage success {}","zrUrwW"],t.msgId),this.signalRenderItem(this.name,t.toUid),e(!0)):e(!1)}))}))}onDeleteMessages(e,t){if(!t||t.length<1)return;const s=this.groupMessageByConvId(t);for(const i in s)if(Object.prototype.hasOwnProperty.call(s,i)){const t=s[i];let a=this.convertDBMessageToPreviewItem(e,t[0]),n=0;for(let s=1;s<t.length;s++){const i=this.convertDBMessageToPreviewItem(e,t[s]);this.isSecondItemNewer(a,i)&&(n=s,a=i)}this.onDeleteMessage(e,t[n])}}onDeleteConversation(e){e&&(this.Logger.zsymb(3,"S_QZIM",["onDeleteConversation {}","Xsnw0i"],e),this.data.delete(e)&&Object(Zs.e)(this.name,e),this.deleteInDB(e))}onChangeDraft(e,t){let s=this.getPreviewByIDSync(e);return!e||!s||s.draft===t||s.draft&&t&&s.draft.draftTime===t.draftTime?(!s&&t&&(this.data.set(e,{convId:e,msgId:W.FAKE_DRAFT_MSG_ID,draft:t,messageTime:-1}),this.signalRenderItem(this.name,e)),void this.Logger.zsymb(3,"ZjbzQw",["onChangeDraft - reject {}","e1B22n"],!!s)):(this.Logger.zsymb(3,"QLaxHr",["onChangeDraft - call update {}","UtkJm3"],!!s),s.msgId!==W.FAKE_DRAFT_MSG_ID||t?(s=Object(T.a)(Object(T.a)({},s),{},{draft:t}),this.data.set(e,s),this.signalRenderItem(this.name,e),void this.broadcastEvent(Ys.b.DraftChanged)):(this.data.set(e,{convId:e,msgId:W.FAKE_DRAFT_MSG_ID,draft:void 0,messageTime:-1}),this.signalRenderItem(this.name,e),void this.data.delete(e)))}getPreviewById(e){return new Promise(((t,s)=>{if(this.data.has(e))return t(this.data.get(e));this.DBConvPreview.getById(e).then((s=>{s||this.Logger.zsymb(3,"dYUw4K",["get item not exist with id {}","UAwDjW"],e);const i=bn.entityToModel(s);t(i||void 0)})).catch(s)}))}getPreviewByIDSync(e){return this.data.get(e)}getAllPreviews(){return new Promise(((e,t)=>{if(this.doneLoadDB)return e(this.getAllPreviewsSync());this.fetchAllHolder||(this.fetchAllHolder=this.DBConvPreview.getAll()),this.fetchAllHolder.then((t=>{const s=t.map((e=>bn.entityToModel(e)));e(s)})).catch(t)}))}getAllPreviewsSync(){return Array.from(this.data.values())||[]}setPreview(e,t,s,i,a,n=1,r={}){const o=this.data.get(e);this.Logger.zsymb(3,"Ncrzee",["call set preview {} {}","FDzHaB"],e,!!o);const c={convId:e,msgId:r.msgId||"unset",src:"ui",dName:r.dName||"",message:t,messageType:"",isGroup:e.startsWith(W.GROUPID_PREFIX),messageTime:s,fromUid:i,toUid:a,urgencyLevel:r.urgencyLevel,properties:null,verified:!0,status:n,computedMessage:t,computedIcon:r.icon};this.data.set(e,c),this.signalRenderItem(this.name,e),this.updateInDB(c)}async addPreviewToManager(e){if(!e)return!1;const t=e.convId,s=this.data.get(t);let i=!1;if(s){const a=!(s.messageType||s.message||!e.messageType||!e.message);a&&(s.verified=!0,this.Logger.zsymb(3,"CKMi5O",["force update new preview item {}","F-lqyU"],t)),(a||this.isSecondItemNewer(s,e))&&(this.data.set(t,e),i=!0,s.verified?(e.verified=!0,this.updateInDB(e)):i=await this.compareCacheWithDBAndUpdate(t,e))}else this.data.set(t,e),i=!0,"db.preview"!==e.src&&(i=await this.compareCacheWithDBAndUpdate(t,e));return i}async deleteMessageInManager(e){if(!e)return!1;const t=e.convId,s=this.data.get(t);if(!s||!Va.b.isSameMsg(e,s)&&this.isSecondItemNewer(e,s))return 0!==this.deleteQueue.length&&this.deleteQueue.push(e),!1;const i=async()=>{const e=await Ua.b.getPreviewMessage(t),i=this.deleteQueue.find((t=>{var s;return t.msgId===(null===(s=e.previewMsg)||void 0===s?void 0:s.msgId)}));if(i)return this.data.set(t,i),await this.deleteMessageInManager(i);this.deleteQueue=[];const a=this.data.get(t);if(a&&this.isSecondItemNewer(s,a))return!1;if(e.previewMsg){const s=this.convertDBMessageToPreviewItem("db.message",e.previewMsg);return s.verified=!0,this.data.set(t,s),this.updateInDB(s),!0}return this.data.delete(t),this.deleteInDB(t),Object(Zs.e)(this.name,t),!1};if(s.verified)return await i();{const s=await this.DBConvPreview.getById(t),a=s&&bn.entityToModel(s);return a&&this.isSecondItemNewer(e,a)?(this.data.set(t,a),!0):await i()}}convertDBMessageToPreviewItem(e,t){let s=t.sendDttm||t.serverTime;s=s?s.toString():"";const i=t.fromUid||t.uidFrom,a=t.toUid||t.idTo,n=a&&a.startsWith(W.GROUPID_PREFIX);return{convId:t.toUid,msgId:t.msgId,src:e,dName:t.dName||"",message:t.message,messageType:t.msgType,mentions:t.mentions,isGroup:n,messageTime:s,fromUid:i,properties:t.properties,urgencyLevel:t.urgency,verified:!1,ttl:t.ttl,status:t.status||1,substate:t.e2eeStatus,cliMsgId:t.cliMsgId,toUid:t.toUid}}isSecondItemNewer(e,t){return!e||(t.msgId===e.msgId&&t.messageTime===e.messageTime||Va.b.isSameMsg(e,t)?t.messageType===W.MSG_UNDO&&e.messageType!==W.MSG_UNDO||$s.a.comparePreviewStt(t.status,e.status)>0:e.messageTime!==t.messageTime?t.messageTime>e.messageTime:t.msgId>e.msgId)}compareCacheWithDBAndUpdate(e,t){return new Promise(((s,i)=>{this.DBConvPreview.getById(e).then((i=>{this.Logger.zsymb(3,"sdfd15",["compareCacheWithDBAndUpdate {} {}","8zCkCX"],e,!!i);const a=bn.entityToModel(i),n=this.data.get(e);if(JSON.stringify(n)!==JSON.stringify(t))return s(!1);!a&&n||a&&n&&this.isSecondItemNewer(a,n)?(n.verified=!0,this.updateInDB(n)):a&&this.data.set(e,a),s(!0)})).catch(i)}))}groupMessageByConvId(e){const t={};for(let s=0;s<e.length;s++)t[e[s].toUid]?t[e[s].toUid].push(e[s]):t[e[s].toUid]=[e[s]];return t}broadcastEvent(e,t="",s){this.dispatchEvent(new Ys.a(e,t,s))}updateInDB(e){this.Logger.zsymb(3,"JfQJCP",["update in db {}","YQ_c90"],e.msgId);try{const t=bn.modelToEntity(e);this.DBConvPreview.addOrUpdate(t)}catch(t){this.Logger.zsymb(21,"5o95Tg",["update in db got err{}","B4BaX1"],t)}}deleteInDB(e){this.DBConvPreview.remove(e).catch((e=>{this.Logger.zsymb(18,"CG3_Lh",`[${this.name}] - deleteInDB got error ${e}`)}))}})||In)||In)||In);var En=s("rKwX"),On=s("SWKE");const Tn="z_ml";class Mn{constructor(){this.cache=void 0,this.cache={}}localKey(e){return Tn+"_"+e}muteConversation(e,t){const s=n.default.getInstance(),i=Tn+"_"+e;t?t.constructor===Object?s.setItemForCurrentUser(this.localKey(e),JSON.stringify(t)):s.setItemForCurrentUser(this.localKey(e),`${t}`):s.removeItemForCurrentUser(i),this.cache[e]=t||!1}isMuted(e){if(this.cache.hasOwnProperty(e))return this.cache[e];let t,s=n.default.getInstance().getItemForCurrentUser(this.localKey(e));if(!s)return null;try{return t=JSON.parse(s),this.cache[e]=t,t}catch(i){A.default.logCoreError(i)}return this.cache[e]=!1,!1}setMutedConversations(e){let t=[];e.chatEntries&&e.chatEntries.length>0&&e.chatEntries.reduce(((e,t)=>(e.push(t),e)),t),e.groupChatEntries&&e.groupChatEntries.length>0&&e.groupChatEntries.reduce(((e,t)=>(t.id=W.GROUPID_PREFIX+t.id,e.push(t),e)),t);On.a.getInstance().cleanupLocalStorageMatchConditions((e=>{const t=n.default.getInstance().getKeyNameForCurrentUser(this.localKey(""));return e.startsWith(t)})),this.cache={};for(let s=0;s<t.length;s++)this.muteConversation(t[s].id,t[s]);return t}}var Rn;Object(ie.b)(ze.g)(Rn=Reflect.metadata("design:type",Function)(Rn=Reflect.metadata("design:paramtypes",[])(Rn=class extends De.b{constructor(){super(),this.name=void 0,this.key=void 0,this.didInit=void 0,this._muteManager=void 0,this.userId=void 0,this.mapTimeout=void 0,this.name=ze.f,this.key="id",this.didInit=!1,this.userId="",this.mapTimeout={}}init(e){this.didInit||(this.didInit=!0,this.userId=e)}get muteManager(){return this._muteManager&&""!==this.userId||(this.userId,this._muteManager=new Mn),this._muteManager}getItem(e,t){return this.muteManager.isMuted(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e){}onGetListFailure(e,t){}onMute(e,t){return new Promise(((s,i)=>{this._clearTimeout(e);let a=-1;switch(t){case 1:a=3600;break;case 2:a=14400;break;case 3:a=Math.round(this._getNowTo8Am()/1e3)}A.default.logCoreInfo(`[${this.name}] - onMute ${e} ${a}`),En.a.lock(e,a,!0).then((t=>{this.muteManager.muteConversation(e,{id:e,startTime:t.startTime,duration:t.duration,systemTime:t.systemTime,currentTime:t.currentTime,muteMode:t.muteMode}),s(!0)})).catch(i)}))}onUnMute(e,t=!0,s=!1){return new Promise(((i,a)=>{this._clearTimeout(e),A.default.logCoreInfo(`[${this.name}] - onUnMute ${e} ${t} ${s}`),En.a.unlock(e,t,s).then((t=>{this.muteManager.muteConversation(e,0),i(!!t)})).catch(a)}))}onFetchMute(e){A.default.logCoreInfo(`[${this.name}] - onFetchMute`);let t=this.muteManager.setMutedConversations(e);return this.processFetchData(e),t}onCtrMute(e,t){t?(this.doLock(t,!1),this.muteManager.muteConversation(e,t),this.muteChanged(e,!!t)):this.onUnMute(e,!1).then((s=>{this.muteChanged(e,!!t)}))}isMuted(e){return this.muteManager.isMuted(e)}processFetchData(e){try{e.chatEntries&&(e.chatEntries.forEach((e=>{this.doLock(e,!0)})),e.groupChatEntries.forEach((e=>{this.doLock(e,!0)})))}catch(t){A.default.logCoreError(t)}}doLock(e,t=!0){if(this.mapTimeout.hasOwnProperty(e.id)&&(t=!0),this._clearTimeout(e.id),-1!=e.duration){A.default.log("setTimer",e);let s=e.duration-(e.currentTime-e.systemTime);s>=0?(A.default.log("setTimer: lock1",e.id),A.default.logCoreInfo("[Unmute timeout] setTimer: lock1",e.id,s),this.mapTimeout[e.id]=setTimeout((()=>{this.onUnMute(e.id,t,!0),A.default.logCoreInfo("[Unmute timeout] setTimer: unlock1",e.id)}),1e3*s)):(A.default.log("setTimer: unlock",s),A.default.logCoreInfo("[Unmute timeout] setTimer: unlock",e.id),this.onUnMute(e.id,t))}}_clearTimeout(e){this.mapTimeout.hasOwnProperty(e)&&(clearTimeout(this.mapTimeout[e]),delete this.mapTimeout[e])}_getNowTo8Am(){let e=(new Date).getTime(),t=new Date(e);return t.setHours(8,0,0,0),t.getTime()<=e?t.getTime()+864e5-e:t.getTime()-e}muteChanged(e,t){Object(Zs.g)(this.name,e),this.broadcastEvent(Ys.b.MuteChanged,e,t)}broadcastEvent(e,t="",s){this.dispatchEvent(new Ys.a(e,t,s))}})||Rn)||Rn);var wn,Ln=s("qvRd"),Fn=s("gwig");const Dn="zpinc",An="ver_pin",Nn=0,kn=1,Pn=2;Object(ie.b)(Ln.b)(wn=Reflect.metadata("design:type",Function)(wn=Reflect.metadata("design:paramtypes",[])(wn=class extends De.b{get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger("conversation",[this.name])),this._Logger}constructor(){super(),this.name=void 0,this.key=void 0,this.didInit=void 0,this.doneLoadDB=void 0,this.data=void 0,this._Logger=void 0,this.reFetchCount=void 0,this.retryTimeout=void 0,this.refetchInterval=void 0,this.lastFetchTime=void 0,this.isDataLastest=void 0,this.requestingIds=void 0,this.name=Ln.a,this.key="convId",this.didInit=!1,this.doneLoadDB=!1,this.data=new Map,this.reFetchCount=0,this.isDataLastest=!1,this.lastFetchTime=0,this.requestingIds=new Map}init(){this.didInit||(this.didInit=!0,this._loadData(),this._fetchPinnedConversations(),this._addListener())}_loadData(){const e=n.default.getInstance().getItemForCurrentUser(Dn);if(e&&e.length)try{const s=JSON.parse(e);Object.keys(s).map((e=>{this._verifyPin(s[e].id)&&this.data.set(s[e].id,{id:s[e].id,priority:+s[e].priority||D.default.getTimeNow()})}));try{this.Logger.zsymb(0,"DHdkSC","pin conversations loaded from local",JSON.stringify(Object.fromEntries(this.data)))}catch(t){this.Logger.zsymb(18,"f90GTF","stringify fail")}this.doneLoadDB=!0;const i=this.getAllPinnedConversations();i.length&&this._broadcastEvent(Ys.b.ChangePinConv,i)}catch(s){0}}_addListener(){Z.default.subscribeEventFriend(W.EventFriend.REMOVE_FRIEND,(e=>{this.Logger.zsymb(0,"31w3Yq","remove friend - unpin",e.userId),this.updateListPin([e.userId],Pn)})),this._setFetchInterval()}_setFetchInterval(){this.refetchInterval&&clearTimeout(this.refetchInterval),this.refetchInterval=setInterval((()=>{this._fetchPinnedConversations()}),864e5)}_broadcastEvent(e,t){this.dispatchEvent(new Ys.e(e,t))}_newPinItem(e,t){return{id:e,priority:t}}_syncServer(e,t){return this._updatePinnedConversationsV2(e,t)}getLastFetchTime(){return this.lastFetchTime}isPinned(e){return this.data.has(e)}getPinTime(e){const t=this.data.get(e);return t?t.priority:0}async _checkAndSyncDataBeforeAction(){if(!this.isDataLastest)try{return await this._fetchPinnedConversations(),!0}catch(e){return!1}return!0}pin(e){return this.Logger.zsymb(0,"r8IdGg","client pin",e),new Promise((async(t,s)=>{const i=await this._checkAndSyncDataBeforeAction();if(!e||!e.length)return s(null);if(i){if(this.data.size+e.length>U.default.limit_pin_messages)return s(null);let i=[];for(let t=0;t<e.length;++t)this.isPinned(e[t])||i.push(e[t]);if(i.length>0)try{const s=await this._syncServer(i,kn);return this.updateListPin(e,kn),t(s)}catch(a){return s(a)}}return s(null)}))}pinLocal(e){this.updateListPin(e,kn)}unpin(e,t=!1){return this.Logger.zsymb(0,"HOLhNJ","client unpin",e,"force sync",t),new Promise((async(s,i)=>{if(!e||!e.length)return i(null);if(await this._checkAndSyncDataBeforeAction()){let n=[];for(let s=0;s<e.length;++s)(this.isPinned(e[s])||t)&&n.push(e[s]);if(n.length>0)try{await this._syncServer(n,Pn),this.updateListPin(e,Pn),s(1)}catch(a){i(a)}}return i(null)}))}unpinLocal(e){this.Logger.zsymb(0,"lLPMic","unpin local",e),this.updateListPin(e,Pn)}getAllPinnedConversations(){return Array.from(this.data.values())}getAllPinnedConversationsSync(){return Array.from(this.data.values())}getTotalPinnedConversation(){return this.data.size+Array.from(this.requestingIds.values()).filter((e=>e===kn)).length}_verifyPin(e){return this.Logger.zsymb(0,"RRa6kK","verify conversation",e,Z.default.isFriend(e),!!Fe.default.getGroupByIdSync(e),e===U.default.sendToMeId),Z.default.isFriend(e)||!!Fe.default.getGroupByIdSync(e)||e===U.default.sendToMeId}updateListPin(e,t){if(this.Logger.zsymb(0,"0B_HJ9","updateListPin",e,t),!e||!e.length)return;const s=[];switch(t){case kn:let t=D.default.getTimeNow();for(let i=0;i<e.length;i++)if(this._verifyPin(e[i])&&!this.data.has(e[i])){++t,this.requestingIds.get(e[i])&&this.requestingIds.set(e[i],Nn);const a=this._newPinItem(e[i],t);this.data.set(e[i],a),s.push(a),Object(Zs.g)(this.name,e[i])}break;case Pn:for(let i=0;i<e.length;i++)if(this.data.has(e[i])){this.requestingIds.get(e[i])&&this.requestingIds.set(e[i],Nn),this.data.delete(e[i]);const t=this._newPinItem(e[i],0);s.push(t),Object(Zs.g)(this.name,e[i])}break;default:return}s.length&&this._broadcastEvent(Ys.b.ChangePinConv,s),this._updateInDB()}_retryFetch(e){if(this.reFetchCount>5)return;let t=0;switch(e){case"ERR_NO_NETWORK":case-69:break;case 212:this.Logger.zsymb(20,"CNb-DL","hasn't pinned conversation from server");n.default.getInstance().setItemForCurrentUser(An,"0"),this._sendToServer();break;case"ERR_CONNECTION_TIMED_OUT":case 112:t=5e3*this.reFetchCount;break;default:t=36e5}this.Logger.zsymb(21,"rRtQFK",["Handle request error fail with error: {}, retry after time= {}","MbwWKj"],e,t),this.retryTimeout||t>0&&(this.retryTimeout=setTimeout((()=>{this._fetchPinnedConversations(),this.retryTimeout=void 0}),t))}_parseData(e){let t=[];for(let s=0;s<e.length;++s)"m1"===e[s]||(e[s].startsWith("g")?t.push(e[s]):t.push(e[s].slice(1)));return t}_fetchPinnedConversations(){return this.reFetchCount++,this.Logger.zsymb(0,"5D8kas","_fetchPinnedConversations",this.reFetchCount),new Promise(((e,t)=>{rs.default.getPinnedConversations().then(os.a).then((t=>{if(t&&t.conversations){const e=n.default.getInstance();void 0===t.version&&null===t.version||e.setItemForCurrentUser(An,t.version),this._onFetchPin(this._parseData(t.conversations))}e(t)})).catch((e=>{this.isDataLastest=!1,e&&(e.error_code?this._retryFetch(e.error_code):e.code?this._retryFetch(e.code):this._retryFetch("UNKNOWN_ERROR")),t(e)}))}))}_updatePinnedConversationsV2(e,t){return new Promise(((s,i)=>{if(!U.default.enable_sync_pinned)return;if(!Fn.b.getStateNetwork())return void i(t===kn?ni.default.str("STR_ERR_NETWORK_PIN_CONVERSATION"):ni.default.str("STR_ERR_NETWORK_UNPIN_CONVERSATION"));let a=[];for(let n=0;n<e.length;++n)e[n].startsWith("g")||e[n].startsWith("u")||(e[n]="u"+e[n]),a.includes(e[n])||this.requestingIds.has(e[n])&&this.requestingIds.get(e[n])!==Nn||(a.push(e[n]),this.requestingIds.set(e[n],t));a.length&&rs.default.updatePinnedConversationsV2(a,t).then(os.a).then((()=>{a.forEach((e=>{this.requestingIds.set(e,Nn)})),s(!0)})).catch((e=>{a.forEach((e=>{this.requestingIds.set(e,Nn)})),this.Logger.zsymb(20,"OSJEWs","Update sync pin conv v2 FAIL: "+e);let s="";if(e)if(e.error_code)if(160===e.error_code)this._fetchPinnedConversations();else s=ni.default.str("STR_ERR_PIN_CONVERSATION")+" ("+e.error_code+")";else"ERR_NO_NETWORK"===e.code&&Fn.b.getStateNetwork()==Fn.a.DISCONNECT&&(s=t===kn?ni.default.str("STR_ERR_NETWORK_PIN_CONVERSATION"):ni.default.str("STR_ERR_NETWORK_UNPIN_CONVERSATION"));i(s)}))}))}_isRemoteDataChanged(e){const t=Array.from(this.data.values()).sort(((e,t)=>t.priority-e.priority)).map((e=>e.id));if(e.length!==t.length)return!0;let s=!1;return e.forEach(((e,i)=>{e!==t[i]&&(s=!0)})),s}_onFetchPin(e){this.Logger.zsymb(0,"r3GG0N","onFetchPin",e),this.isDataLastest=!0,this.lastFetchTime=D.default.getTimeNow(),this.reFetchCount=0;let t=D.default.getTimeNow();this._setFetchInterval();const s=[],i=[];for(let a=0;a<e.length;a++)this._verifyPin(e[a])?i.push(e[a]):this.unpin([e[a]],!0);if(this._isRemoteDataChanged(i)){for(const e of Array.from(this.data.values()))i.find((t=>t===e.id))||(this.data.delete(e.id),Object(Zs.g)(this.name,e.id),s.push({id:e.id,priority:0}));for(let e=0;e<i.length;e++){const a=this._newPinItem(i[e],t),n=this.isPinned(i[e]);this.data.set(i[e],a),n||Object(Zs.g)(this.name,i[e]),t--,s.push(a)}this.Logger.zsymb(0,"4BT5M2","[After Fetch]",Array.from(this.data.values())),s.length&&this._broadcastEvent(Ys.b.ChangePinConv,s),this._updateInDB()}}_sendToServer(){this._syncServer(Array.from(this.data.keys()),kn)}getItem(e,t){return this.data.get(e.key)}getList(e,t){return Array.from(this.data.keys())}onGetItemFailure(e,t){this.Logger.zsymb(18,"GmZ6er","onGetItemFailure - key:",e," - error",t)}onGetListFailure(e,t){this.Logger.zsymb(18,"u2LfiK","onGetItemFailure - key:",e," - error",t)}_updateInDB(){if(!this.data)return;const e=n.default.getInstance();this.data.size?e.setItemForCurrentUser(Dn,JSON.stringify(Array.from(this.data.values()))):e.removeItemForCurrentUser(Dn)}})||wn)||wn);var jn,Un=s("MnJw");Object(ie.b)(Un.a)(jn=Reflect.metadata("design:type",Function)(jn=Reflect.metadata("design:paramtypes",[])(jn=class extends De.b{constructor(){super()}onUpdateListArchivedChat(e){this.dispatchEvent(new Ys.a(Ys.b.UpdateListArchivedChat,e))}onOffArchivedChat(e){this.dispatchEvent(new Ys.a(Ys.b.OnOffArchivedChat,"",{status:e}))}})||jn)||jn);i.ModuleContainer.registerSingleton(va.b,ya),i.ModuleContainer.registerSingleton(ka.a,Aa),i.ModuleContainer.registerSingleton(va.a,_a);var Bn=s("/S2x"),Gn=s("vBob"),zn=s("qlGb"),xn=s("POdc");var Vn=s("fsN4");var Hn=s("7gmC");class qn{constructor(e,t,s,i){this.actionSrc=void 0,this.msgType=void 0,this.convType=void 0,this.dlt=void 0,this.actionSrc=e,this.msgType=t,this.convType=s,this.dlt=i}toString(){const e=[this.actionSrc,this.msgType,this.convType,this.dlt].filter((e=>void 0!==e));return e.length<=0?"":1==e.length?e.join(""):e.length>=2?e.join("."):""}}class Wn{constructor(){this.name=void 0,this.code=void 0}}class Zn extends Wn{constructor(){super(),this.name="SYNC_DOWNLOAD_DATA_INVALID",this.code=1}}class Kn extends Wn{constructor(){super(),this.name="MESSAGE_INVALID",this.code=2}}class Qn extends Wn{constructor(){super(),this.name="TOPIC_INVALID",this.code=3}}class $n extends Wn{constructor(){super(),this.name="DLT_DATA_INVALID",this.code=4}}class Yn extends Wn{constructor(){super(),this.name="ACTION_HASH_DUPLICATE",this.code=6}}class Jn extends Wn{constructor(){super(),this.name="MESSAGE_KEY_INVALID",this.code=7}}class Xn extends Wn{constructor(){super(),this.name="DOWNLOAD_ERROR",this.code=8}}class er{constructor(e){this.topic=e}}class tr{constructor(e){this.topic=e}}var sr,ir=s("ePll"),ar=s("nkyP");const nr=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger("tri-log",["producer produce"]);let rr=Object(i.injectable)()(sr=function(e,t){return Object(i.inject)(ar.i)(e,void 0,0)}(sr=function(e,t){return Object(i.inject)(ar.p)(e,void 0,1)}(sr=function(e,t){return Object(i.inject)(ar.j)(e,void 0,2)}(sr=function(e,t){return Object(i.inject)(ar.k)(e,void 0,3)}(sr=function(e,t){return Object(i.inject)(ar.m)(e,void 0,4)}(sr=function(e,t){return Object(i.inject)(ar.g)(e,void 0,5)}(sr=function(e,t){return Object(i.inject)(ar.n)(e,void 0,6)}(sr=function(e,t){return Object(i.inject)(ar.r)(e,void 0,7)}(sr=function(e,t){return Object(i.inject)(ar.c)(e,void 0,8)}(sr=function(e,t){return Object(i.inject)(ar.a)(e,void 0,9)}(sr=function(e,t){return Object(i.inject)(ar.s)(e,void 0,10)}(sr=Reflect.metadata("design:type",Function)(sr=Reflect.metadata("design:paramtypes",[Object,Object,Object,Object,Object,void 0===Hn.IMediator?Object:Hn.IMediator,Object,Object,Object,Object,Object])(sr=class{constructor(e,t,s,i,a,n,r,o,c,l,d){this.duplicateBucket=e,this.syncQueueRepository=t,this.messageRepository=s,this.messageValidator=i,this.syncActionsRepository=a,this.syncActionMediator=n,this.syncDownloadDataValidator=r,this.topicMapper=o,this.compositeKeyMapper=c,this.actionHashMapper=l,this.topicValidator=d}async produceByAction(e){try{if(!this.syncDownloadDataValidator.validateSyncDownloadData(e))throw new Zn;const t=this.actionHashMapper.map(e);if(this.syncDownloadDataValidator.validateDuplicateSyncDownloadData(t))throw new Yn;this.duplicateBucket.add(t.toString());const s=await this.messageRepository.getMessageByCliMsgId(e.clientMsgId,e.convId);if(!this.messageValidator.validateMessage(s))throw new Kn;const i=this.compositeKeyMapper.mapByAction(e),a=this.compositeKeyMapper.mapByMessage(s);if(!this.messageValidator.validateMessageByCompositeKey(a,i))throw new Jn;const n=this.topicMapper.map(e,s);if(!this.topicValidator.validateTopic(n))throw new Qn;this.syncQueueRepository.addByTopic(n.toString(),{action:e,message:s,lastClientMsgId:e.clientMsgId}),requestAnimationFrame((async()=>{await this.syncActionMediator.publish(new tr(n))}))}catch(t){t instanceof Yn||requestAnimationFrame((async()=>{var t;this.duplicateBucket.delete(null===(t=this.actionHashMapper.map(e))||void 0===t?void 0:t.toString())}))}}async produceByParams(e,t,s){let i=await this.syncActionsRepository.getActionsByActionSrc(e,t,s);if((i.data.length<=0||i.data.length>0&&!1===i.hasMore)&&await this.syncActionMediator.publish(new er(new qn(e))),!(i.data.length<=0||null==i)&&i.data)for(let[n,r]of i.data.entries())try{if(!this.syncDownloadDataValidator.validateSyncDownloadData(r))throw new Zn;const e=this.actionHashMapper.map(r);if(this.syncDownloadDataValidator.validateDuplicateSyncDownloadData(e))throw new Yn;this.duplicateBucket.add(e.toString());const t=await this.messageRepository.getMessageByCliMsgId(r.clientMsgId,r.convId);let{code:s,msgType:a}=ir.a.validateMessage(t);if(s&&a==(null==t?void 0:t.msgType))continue;if(!this.messageValidator.validateMessage(t))throw new Kn;const o=this.topicMapper.map(r,t);if(!this.topicValidator.validateTopic(o))throw new Qn;this.syncQueueRepository.addByTopic(o.toString(),{action:r,message:t,lastClientMsgId:i.lastClientMsgId,reproduce:0==n&&!1!==i.hasMore}),await this.syncActionMediator.publish(new tr(o))}catch(a){nr.zsymb(23,"mhocbu",["produce error {}","AlnQiX"],a),a instanceof Yn||requestAnimationFrame((async()=>{var e;this.duplicateBucket.delete(null===(e=this.actionHashMapper.map(r))||void 0===e?void 0:e.toString())}))}}})||sr)||sr)||sr)||sr)||sr)||sr)||sr)||sr)||sr)||sr)||sr)||sr)||sr)||sr;var or;let cr=Object(i.injectable)()(or=function(e,t){return Object(i.inject)(ar.i)(e,void 0,0)}(or=Reflect.metadata("design:type",Function)(or=Reflect.metadata("design:paramtypes",[Object])(or=class{constructor(e){this.duplicateBucket=e}validateSyncDownloadData(e){return!!e&&(!(!e.clientMsgId||Number.isNaN(e.clientMsgId))&&(!(!e.actionSource||Number.isNaN(e.actionSource))&&!(!e.convId||!e.fromId)))}validateDuplicateSyncDownloadData(e){return!!this.duplicateBucket.has(e.toString())}})||or)||or)||or)||or;var lr,dr=s("Y58e");let hr=Object(i.injectable)()(lr=function(e,t){return Object(i.inject)(dr.a)(e,void 0,0)}(lr=Reflect.metadata("design:type",Function)(lr=Reflect.metadata("design:paramtypes",[void 0===dr.a?Object:dr.a])(lr=class{constructor(e){this.config=void 0,this.config=e}validateTopic(e){if(!e.actionSrc)return!1;return!!this.config.get("syncDownload.topics").includes(e.toString())}})||lr)||lr)||lr)||lr;const ur=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger("tri-log",["queue add"]);class gr{constructor(){this.maps=new Map}unshiftByTopic(e,t){var s;Array.isArray(this.maps.get(e))?null===(s=this.maps.get(e))||void 0===s||s.unshift(t):this.maps.set(e,[t])}addByTopic(e,t){var s;ur.zsymb(23,"Co1M9t",["queue add topic {}, {}","1h_4kl"],e,t),Array.isArray(this.maps.get(e))?null===(s=this.maps.get(e))||void 0===s||s.push(t):this.maps.set(e,[t])}popByTopic(e){var t;return null===(t=this.maps.get(e))||void 0===t?void 0:t.pop()}lengthByTopic(e){var t;return(null===(t=this.maps.get(e))||void 0===t?void 0:t.length)||0}infosByTopic(e){return[...this.maps.get(e)]}}var mr=s("jkDV");class pr{constructor(e){this.topic=e}}class fr{constructor(e,t,s){this.topic=e,this.syncData=t,this.reproduce=s}}const vr=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger("downloadSyncActions",["downloadSyncActions"]);class _r{constructor(e,t){this.topic=e,this.DltSyncData=t}}const br=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger("tri-log",["queue consume"]);class yr{constructor(e,t,s,i,a,n,r,o){this.duplicateBucket=e,this.actionHashMapper=t,this.cachedDTORepository=s,this.DTOMapper=i,this.syncQueueRepository=a,this.mediator=n,this.syncActionMediator=r,this.topic=o}async consume(){vr.zsymb(23,"sq6RKA",["DownloadSyncActionConsumerService consume entry","m59vS7"]);const e=this.syncQueueRepository.popByTopic(this.topic.toString()),t=null==e?void 0:e.action,s=null==e?void 0:e.message,i=null==e?void 0:e.reproduce;try{const e=this.DTOMapper.map(t,s);this.cachedDTORepository.setDTO(`${t.clientMsgId}.${this.topic.toString()}`,e),br.zsymb(23,"kSQGQe",["actionSrc {}, cliMsgId {}, globalMsgId {}, start download","oj2QFt"],t.actionSource,t.clientMsgId,t.globalMsgId);const i=await e.run();if(null!=i&&i.downloadError||null==i||!i.savePath)throw br.zsymb(23,"5uMiSZ",["actionSrc {}, cliMsgId {}, globalMsgId {}, downloadError {}, savePath {}, done retry download","s6Zr_9"],t.actionSource,t.clientMsgId,t.globalMsgId,null==i?void 0:i.downloadError,null==i?void 0:i.savePath),new Xn;br.zsymb(23,"17-6B0",["actionSrc {}, cliMsgId {}, globalMsgId {}, isCache {}, done download","2TgfhS"],t.actionSource,t.clientMsgId,t.globalMsgId,i.isCached),this.cachedDTORepository.deleteDTO(`${t.clientMsgId}_${this.topic.toString()}`),await this.syncActionMediator.publish(new mr.c(t.actionSource,t.fromId,t.convId,t.clientMsgId,{isCached:Boolean(i.isCached)}))}catch(a){t&&s&&(br.zsymb(23,"aStT9I",["actionSrc {}, cliMsgId {}, globalMsgId {}, isCache {}, fail download go to retry","UeBpL0"],t.actionSource,t.clientMsgId,t.globalMsgId),await this.syncActionMediator.publish(new _r(new qn(this.topic.actionSrc,this.topic.msgType,this.topic.convType,"dlt"),{action:t,message:s,retry:0})))}requestAnimationFrame((async()=>{var e;this.duplicateBucket.delete(null===(e=this.actionHashMapper.map(t))||void 0===e?void 0:e.toString()),await this.mediator.publish(new pr(this.topic)),await this.mediator.publish(new fr(this.topic,t,i))}))}}class Ir{constructor(e){this.topic=e}}const Sr=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger("tri-log",["queue retry consume"]);class Cr{constructor(e,t,s,i,a,n,r,o,c){this.duplicateBucket=e,this.actionHashMapper=t,this.cachedDTORepository=s,this.DTOMapper=i,this.syncQueueDLTRepository=a,this.mediator=n,this.syncActionMediator=r,this.DltValidator=o,this.topic=c}async consume(){vr.zsymb(23,"YiMqKF",["DownloadSyncActionDltConsumer consume entry","f7j9iZ"]);const e=this.syncQueueDLTRepository.popByTopic(this.topic.toString()),t=null==e?void 0:e.action,s=null==e?void 0:e.message;try{if(!this.DltValidator.validateDlt(e))throw new $n;const i=this.DTOMapper.map(t,s);this.cachedDTORepository.setDTO(`${e.action.clientMsgId}_${this.topic.toString()}`,i),Sr.zsymb(23,"XfwTVd",["actionSrc {}, cliMsgId {}, globalMsgId {}, retry count {}, start retry download","9SagHx"],t.actionSource,t.clientMsgId,t.globalMsgId,e.retry);const a=await i.run();if(null!=a&&a.downloadError||null==a||!a.savePath)throw Sr.zsymb(23,"zT9xDa",["actionSrc {}, cliMsgId {}, globalMsgId {}, downloadError {}, savePath {}, done retry download","s6Zr_9"],t.actionSource,t.clientMsgId,t.globalMsgId,null==a?void 0:a.downloadError,null==a?void 0:a.savePath),new Xn;Sr.zsymb(23,"9q1XEP",["actionSrc {}, cliMsgId {}, globalMsgId {}, isCache {}, done retry download","a_ZCvv"],t.actionSource,t.clientMsgId,t.globalMsgId,a.isCached),this.cachedDTORepository.deleteDTO(`${t.clientMsgId}_${this.topic.toString()}`),await this.syncActionMediator.publish(new mr.c(t.actionSource,t.fromId,t.convId,t.clientMsgId,{isCached:Boolean(a.isCached)}))}catch(a){if(t&&s)if(a instanceof $n);else if(this.DltValidator.isRetriesExceeded(e)){var i;await this.mediator.publish(new mr.b(t.actionSource,t.fromId,t.convId,t.clientMsgId,null==a||null===(i=a.downloadError)||void 0===i?void 0:i.name))}else await this.mediator.publish(new _r(this.topic,{action:t,message:s,retry:e.retry+1})),Sr.zsymb(23,"hYmdG8",["actionSrc {}, cliMsgId {}, globalMsgId {}, retry count {}, fail download increase retry","QOq6e7"],t.actionSource,t.clientMsgId,t.globalMsgId,e.retry)}requestAnimationFrame((async()=>{var e;this.duplicateBucket.delete(null===(e=this.actionHashMapper.map(t))||void 0===e?void 0:e.toString()),await this.mediator.publish(new pr(this.topic)),await this.mediator.publish(new Ir(this.topic))}))}}var Er;let Or=Object(i.injectable)()(Er=function(e,t){return Object(i.inject)(ar.i)(e,void 0,0)}(Er=function(e,t){return Object(i.inject)(ar.b)(e,void 0,1)}(Er=function(e,t){return Object(i.inject)(ar.a)(e,void 0,2)}(Er=function(e,t){return Object(i.inject)(ar.e)(e,void 0,3)}(Er=function(e,t){return Object(i.inject)(ar.p)(e,void 0,4)}(Er=function(e,t){return Object(i.inject)(ar.o)(e,void 0,5)}(Er=function(e,t){return Object(i.inject)(ar.g)(e,void 0,6)}(Er=function(e,t){return Object(i.inject)(ar.l)(e,void 0,7)}(Er=function(e,t){return Object(i.inject)(ar.f)(e,void 0,8)}(Er=Reflect.metadata("design:type",Function)(Er=Reflect.metadata("design:paramtypes",[Object,Object,Object,Object,Object,Object,void 0===Hn.IMediator?Object:Hn.IMediator,void 0===Hn.IMediator?Object:Hn.IMediator,Object])(Er=class{constructor(e,t,s,i,a,n,r,o,c){this.duplicateBucket=e,this.cachedDTORepository=t,this.actionHashMapper=s,this.DTOMapper=i,this.syncQueueRepository=a,this.syncQueueDltRepository=n,this.mediator=r,this.syncActionMediator=o,this.dltValidator=c,this.services=new Map,this.dltTopics=new Map}createByTopic(e){let t=this.services.get(e),s=this.services.get(this.dltTopics.get(e)||"");if(t&&s)return[t,s];let i=e.split(".");return t=new yr(this.duplicateBucket,this.actionHashMapper,this.cachedDTORepository,this.DTOMapper,this.syncQueueRepository,this.mediator,this.syncActionMediator,new qn(Number(i[0]),i[1],i[2])),s=new Cr(this.duplicateBucket,this.actionHashMapper,this.cachedDTORepository,this.DTOMapper,this.syncQueueDltRepository,this.mediator,this.syncActionMediator,this.dltValidator,new qn(Number(i[0]),i[1],i[2],"dlt")),this.services.set(t.topic.toString(),t),this.services.set(s.topic.toString(),s),[t,s]}deleteByTopic(e){this.services.delete(e)}getByTopic(e){return this.services.get(e)}getAll(){return Array.from(this.services.values())}})||Er)||Er)||Er)||Er)||Er)||Er)||Er)||Er)||Er)||Er)||Er)||Er;const Tr={[W.MSG_PHOTO]:"photo",[W.MSG_PHOTO_2]:"photo",[W.MSG_GIF]:"photo",[W.MSG_FILE]:"file",[W.MSG_VOICE]:"voice",[W.MSG_VIDEO]:"video",[W.MSG_CONTACT]:"link"};var Mr;let Rr=Object(i.injectable)()(Mr=function(e,t){return Object(i.inject)(dr.a)(e,void 0,0)}(Mr=Reflect.metadata("design:type",Function)(Mr=Reflect.metadata("design:paramtypes",[void 0===dr.a?Object:dr.a])(Mr=class{constructor(e){this.config=void 0,this.config=e}map(e,t){let s=Tr[t.msgType]||"";const i=this.config.get("syncDownload.topics");return i.includes(`${e.actionSource}`)?new qn(e.actionSource):i.includes(`${e.actionSource}.${s}`)?new qn(e.actionSource,s):void 0}})||Mr)||Mr)||Mr)||Mr;var wr;let Lr=Object(i.injectable)()(wr=function(e,t){return Object(i.inject)(dr.a)(e,void 0,0)}(wr=Reflect.metadata("design:type",Function)(wr=Reflect.metadata("design:paramtypes",[void 0===dr.a?Object:dr.a])(wr=class{constructor(e){this.config=void 0,this.config=e}validateDlt(e){return!!e}isRetriesExceeded(e){const t=this.config.get("syncDownload.dlt_max_retry");return!!(Number.isNaN(e.retry)||e.retry>=t)}})||wr)||wr)||wr)||wr;class Fr{constructor(e,t){this.actionSrc=void 0,this.clientMsgId=void 0,this.actionSrc=e,this.clientMsgId=t}toString(){return`${this.actionSrc}.${this.clientMsgId}`}}class Dr{constructor(e,t,s){this.cliMsgId=e,this.fromUid=t,this.toUid=s}toString(){return`${this.cliMsgId}.${this.fromUid}.${this.toUid}`}}i.ModuleContainer.register(ar.j,class{constructor(){this.DB=void 0,this.DB=Vn.default.getInstance()}async getMessageByCliMsgId(e,t){return await this.DB.Core.Message.get(`${e}`,{index:"cliMsgIdIndex",partition:t})}}),i.ModuleContainer.register(ar.m,class{constructor(){}async getActions(){return[]}getActionsByActionSrc(e){return Object(xn.f)("SyncActionsRepository",e)}}),i.ModuleContainer.registerSingleton(ar.o,gr),i.ModuleContainer.registerSingleton(ar.p,gr),i.ModuleContainer.registerSingleton(ar.b,class{constructor(){this.cache=new Map}getDTO(e){return this.cache.get(e)}setDTO(e,t){this.cache.set(e,t)}deleteDTO(e){this.cache.delete(e)}}),i.ModuleContainer.registerSingleton(ar.i,class{constructor(){this.bucket=new Set}add(e){e&&this.bucket.add(e)}has(e){return this.bucket.has(e)}delete(e){this.bucket.delete(e)}}),i.ModuleContainer.register(ar.n,cr),i.ModuleContainer.register(ar.k,class{validateMessageByCompositeKey(e,t){return e.toString()==t.toString()}validateMessage(e){return!!e&&(!(!e.msgType||e.msgType==W.MSG_UNDO)&&(!(!e.status||e.status>W.MSG_AFTER_READ)&&!!(e.msgId&&e.cliMsgId&&e.fromUid&&e.toUid)))}}),i.ModuleContainer.register(ar.s,hr),i.ModuleContainer.register(ar.f,Lr),i.ModuleContainer.register(ar.e,class{map(e,t){var s,i;const a=Object(zn.getDataFromMessage)(t),n=Object(zn.getTypeByMsg)(t),r=Object(zn.getUserId)();let o;xn.a.FromServer==e.actionSource&&(o=Gn.a.srcAction.SyncAuto),xn.a.MsgFlow!=e.actionSource&&xn.a.FromTransfer!=e.actionSource||(o=Gn.a.srcAction.Auto);const c={type:n,data:Object(T.a)(Object(T.a)({},a),{},{userId:r,localPath:void 0}),options:{srcAction:o,showProgress:{progressBar:!1,taskBar:!1},caching:!0,duplicate:!1}};return t.msgType!=W.MSG_PHOTO&&t.msgType!=W.MSG_GIF||(c.options.saveDir=Object(re.getZaloDownloadsPictureDirSync)(a.conversationId,r)),t.msgType==W.MSG_FILE&&(c.data.fileName=c.data.checksum),t.msgType==W.MSG_VOICE&&(c.data.fileName=null===(s=c.data.fileName)||void 0===s?void 0:s.replace(".aac","")),t.msgType==W.MSG_CONTACT&&"object"==typeof t.message&&"recommened.link"===(null==t||null===(i=t.message)||void 0===i?void 0:i.action)&&(c.options.saveDir=Object(re.getZaloDownloadsRichThumbDirSync)(r,a.conversationId)),new Bn.default(c)}}),i.ModuleContainer.register(ar.r,Rr),i.ModuleContainer.register(ar.a,class{map(e){if(e)return new Fr(e.actionSource,e.clientMsgId)}}),i.ModuleContainer.register(ar.c,class{mapByMessage(e){var t,s;let i=null!==(t=e.toUid)&&void 0!==t&&t.startsWith(W.GROUPID_PREFIX)?null===(s=e.toUid)||void 0===s?void 0:s.slice(W.GROUPID_PREFIX.length):null==e?void 0:e.toUid;return new Dr(e.cliMsgId,e.fromUid,i)}mapByAction(e){var t,s;let i=null!==(t=e.convId)&&void 0!==t&&t.startsWith(W.GROUPID_PREFIX)?null===(s=e.convId)||void 0===s?void 0:s.slice(W.GROUPID_PREFIX.length):null==e?void 0:e.convId,a=Z.default.getUidMe()==e.fromId?"0":e.fromId;return new Dr(e.clientMsgId,a,i)}}),i.ModuleContainer.registerSingleton(ar.q,class{constructor(){this.maps=new Map}pauseByTopic(e){this.maps.get(e).enable=!1}resumeByTopic(e){this.maps.get(e).enable=!0}loadConfig(e,t){this.maps.set(e,Object(T.a)(Object(T.a)({enable:!0},this.maps.get(e)),{},{capacity:t,tokens:t}))}addByTopic(e){const t=this.maps.get(e);(null==t?void 0:t.tokens)<(null==t?void 0:t.capacity)&&(t.tokens+=1)}takeByTopic(e){const t=this.maps.get(e);return!!t.enable&&((null==t?void 0:t.tokens)>0&&(t.tokens-=1,!0))}}),i.ModuleContainer.registerSingleton(ar.h,rr),i.ModuleContainer.registerSingleton(ar.d,Or),i.ModuleContainer.registerSingleton(ar.g,Hn.Mediator);const Ar=i.ModuleContainer.resolve(dr.a),Nr=i.ModuleContainer.resolve(ar.q),kr=Ar.get("syncDownload.topics");for(let PF of kr)Nr.loadConfig(PF,2),Nr.loadConfig(`${PF}.dlt`,2);const Pr=i.ModuleContainer.resolve(dr.a).get("syncDownload.topics"),jr=i.ModuleContainer.resolve(ar.d);for(let PF of Pr)jr.createByTopic(PF);var Ur;Object(Hn.NotificationHandler)(pr,1)(Ur=Reflect.metadata("design:type",Function)(Ur=Reflect.metadata("design:paramtypes",[])(Ur=class{constructor(){this.tokenBucket=void 0,this.tokenBucket=i.ModuleContainer.resolve(ar.q)}async handle(e){this.tokenBucket.addByTopic(e.topic.toString())}})||Ur)||Ur);var Br;const Gr=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger("tri-log",["queue"]);Object(Hn.NotificationHandler)(er,1)(Br=Reflect.metadata("design:type",Function)(Br=Reflect.metadata("design:paramtypes",[])(Br=class{constructor(){this.tokenBucket=void 0,this.consumerServiceFactory=void 0,this.consumerServiceFactory=i.ModuleContainer.resolve(ar.d),this.tokenBucket=i.ModuleContainer.resolve(ar.q)}async handle(e){vr.zsymb(23,"zsDPPQ",["AllActionsConsumedEvent entry","qrqTCn"]);const t=e.topic;Gr.zsymb(23,"pgn9Re",["queue {}, done download","epVz_N"],e.topic.toString());let s=this.consumerServiceFactory.getAll();s=s.filter((e=>e.topic.actionSrc==t.actionSrc)).filter((e=>e.topic.dlt));for(let i of s)i&&(this.tokenBucket.resumeByTopic(i.topic.toString()),this.tokenBucket.takeByTopic(i.topic.toString())&&i.consume())}})||Br)||Br);var zr;Object(Hn.NotificationHandler)(fr,1)(zr=Reflect.metadata("design:type",Function)(zr=Reflect.metadata("design:paramtypes",[])(zr=class{constructor(){this.tokenBucket=void 0,this.consumerServiceFactory=void 0,this.syncQueue=void 0,this.producer=void 0,this.syncActionMediator=void 0,this.consumerServiceFactory=i.ModuleContainer.resolve(ar.d),this.producer=i.ModuleContainer.resolve(ar.h),this.tokenBucket=i.ModuleContainer.resolve(ar.q),this.syncQueue=i.ModuleContainer.resolve(ar.p),this.syncActionMediator=i.ModuleContainer.resolve(ar.g)}async handle(e){vr.zsymb(23,"x9NQ11",["PullDownloadCommand entry","65XZlL"]);const t=this.consumerServiceFactory.getByTopic(e.topic.toString());var s;if(this.syncQueue.lengthByTopic(e.topic.toString())<=0)e.reproduce?this.producer.produceByParams(e.topic.actionSrc,void 0,null===(s=e.syncData)||void 0===s?void 0:s.lastClientMsgId):await this.syncActionMediator.publish(new er(new qn(e.topic.actionSrc)));else for(;t&&this.tokenBucket.takeByTopic(e.topic.toString());)t.consume()}})||zr)||zr);var xr;Object(Hn.NotificationHandler)(tr,1)(xr=Reflect.metadata("design:type",Function)(xr=Reflect.metadata("design:paramtypes",[])(xr=class{constructor(){this.tokenBucket=void 0,this.consumerServiceFactory=void 0,this.consumerServiceFactory=i.ModuleContainer.resolve(ar.d),this.tokenBucket=i.ModuleContainer.resolve(ar.q)}async handle(e){vr.zsymb(23,"vhLn2Q",["PushDownloadCommand entry","rAvQCE"]);const t=`${e.topic}.dlt`;this.tokenBucket.pauseByTopic(t);const s=this.consumerServiceFactory.getByTopic(e.topic.toString());s&&this.tokenBucket.takeByTopic(e.topic.toString())&&s.consume()}})||xr)||xr);var Vr;Object(Hn.NotificationHandler)(_r,1)(Vr=Reflect.metadata("design:type",Function)(Vr=Reflect.metadata("design:paramtypes",[])(Vr=class{constructor(){this.syncQueueDLTRepository=void 0,this.syncQueueDLTRepository=i.ModuleContainer.resolve(ar.o)}async handle(e){vr.zsymb(23,"9zO3l7",["DeadLetterUnshiftCommandHandler entry","aQ9FaV"]),this.syncQueueDLTRepository.unshiftByTopic(e.topic.toString(),e.DltSyncData)}})||Vr)||Vr);var Hr;const qr=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger("tri-log",["queue retry"]);Object(Hn.NotificationHandler)(Ir,1)(Hr=Reflect.metadata("design:type",Function)(Hr=Reflect.metadata("design:paramtypes",[])(Hr=class{constructor(){this.tokenBucket=void 0,this.consumerServiceFactory=void 0,this.syncDltQueue=void 0,this.consumerServiceFactory=i.ModuleContainer.resolve(ar.d),this.tokenBucket=i.ModuleContainer.resolve(ar.q),this.syncDltQueue=i.ModuleContainer.resolve(ar.o)}async handle(e){vr.zsymb(23,"3ywBU2",["PullDownloadCommandDlt entry","2dtEDm"]);const t=this.consumerServiceFactory.getByTopic(e.topic.toString());if(this.syncDltQueue.lengthByTopic(e.topic.toString())<=0)return qr.zsymb(23,"u0wJZd",["retry queue {}, done download","wq0Qzl"],e.topic.toString()),void this.tokenBucket.pauseByTopic(e.topic.toString());for(;t&&this.tokenBucket.takeByTopic(e.topic.toString());)t.consume()}})||Hr)||Hr);var Wr,Zr=s("Xvw2"),Kr=s("5uwv"),Qr=s("lCn6"),$r=s("kg13"),Yr=s("dJFb");const Jr=2,Xr={userId:"",friendRequestType:Jr,friendRequestSource:85};var eo=function(e){return e.SUGGEST="suggest",e.REQUEST="request",e.UNREADREQ="unread-req",e}(eo||{});Object(ie.b)(Zr.b)(Wr=Reflect.metadata("design:type",Function)(Wr=Reflect.metadata("design:paramtypes",[])(Wr=class extends De.b{constructor(){super(),this.sugguestList=void 0,this.requestList=void 0,this.unreadFRList=void 0,this._ebFriendRequestSend=e=>{const t=this.unreadFRList.filter((t=>t!==e));t.length!==this.unreadFRList.length&&(_t.default.changeFriendsToStranger(e),A.default.logCoreError("[reddot-check] SEND_FRIEND_REQUEST: "+JSON.stringify(e)),this.unreadFRList=t,Object(Zs.h)(this.name,eo.UNREADREQ))},this._ebFriendFetch=e=>{for(let t in e)if(e.hasOwnProperty(t)){const e=this.requestList.slice();for(let s=0;s<e.length;s++)if(e[s]===t){e.splice(s,1);break}e.length!==this.requestList.length&&(this.requestList=e,Object(Zs.h)(this.name,eo.REQUEST))}},this._ebFrReqFetch=e=>{A.default.log("friendNotificationAction: friend requests fetched",e);const t=this.requestList.reduce(((e,t)=>(e[t]||(e[t]=!0),e)),{}),s=this.requestList.slice();for(let i of e)t[i.userId]||s.unshift(i);this.requestList=s,Object(Zs.h)(this.name,eo.REQUEST)},this._ebFrReqRemove=e=>{A.default.log("friendNotificationAction: friend requests removed",e);const t=this.requestList.filter((t=>-1===e.indexOf(t)));t.length!==this.requestList.length&&(this.requestList=t,Object(Zs.h)(this.name,eo.REQUEST)),this.onFriendListNotificationsChange({action:"remove",ids:e})},this.name=Zr.a,this.data=new Map,this.key="userId",this.sugguestList=[],this.requestList=[],this.unreadFRList=[],this.listenEvents()}listenEvents(){N.default.subscribe(((e,t)=>{switch(e){case P.ChatBoxActions.SEND_FRIEND_REQUEST:this._ebFriendRequestSend(t);break;case P.FetchActions.FRIENDS_FETCHED:this._ebFriendFetch(t);break;case P.FetchActions.FRIEND_REQUESTS_FETCHED:this._ebFrReqFetch(t);break;case P.FetchActions.FRIEND_REQUESTS_REMOVED:this._ebFrReqRemove(t)}}))}onAddFriend(e){$r.a.removeSuggest(e.userId),this.onFriendListNotificationsChange({action:"remove",ids:[e.userId]})}onReceiveFriendRequests(e){if(!e||e.length<1)return;for(let s=0;s<e.length;s++){let t=e[s];t&&$r.a.removeSuggest(t.userId)}Yr.d.setUnreadRequest(1);for(let s=0;s<e.length;s++)e[s]&&ye.p.addNewFriendItem(e[s].userId);Q.a.UnreadDataManager.updateUnreadCount(W.FAKE_CONVERSATION_ID.FRIEND_CENTER,Yr.d.getUnreadRequest());let t=e.map((e=>({dataInfo:Object(T.a)(Object(T.a)({},e),{},{recommInfo:{message:e.friendRequestMsg,source:e.friendRequestSource},recommType:Jr}),recommItemType:e.friendRequestType})));$r.a.addRequest(t),this.broadcastEvent(Kr.b.ReceiveRequest,"",{uids:e.map((e=>e.userId))})}onRemoveSuggest(e,t,s){return $r.a.removeSuggestFriend(e,t,s).then((t=>{this.broadcastEvent(Kr.b.RemoveSuggest,e)}))}onPromoteFriends(){Q.a.UnreadDataManager.updateUnreadCount(W.FAKE_CONVERSATION_ID.FRIEND_CENTER,1)}onFriendRequestFetched(){}onFriendListNotificationsChange(e){if(!e.ids||!e.ids.length)return void("clear"===e.action&&(this.unreadFRList=[],Object(Zs.h)(this.name,eo.UNREADREQ)));let t=this.unreadFRList;if("remove"===e.action)t=t.filter((t=>-1===e.ids.indexOf(t)));else if("add"===e.action){const s=[];for(let i of e.ids)-1===t.indexOf(i)&&s.push(i);s.length&&(t=t.concat(s))}t.length!==this.unreadFRList.length&&(this.unreadFRList=t,Object(Zs.h)(this.name,eo.UNREADREQ))}acceptFriendRequest(e,t=yt.c){return new Promise(((s,i)=>{const a=this.data.get(e);if(!a)return Qi.a.acceptAddFriend(e).then((i=>{ft.ModalManagerV2.openModal({windowId:t,name:W.ModalIdentitiesDefine.BLOCK_STORIES,params:{userId:e,windowId:t}}),s(!0)})).catch(i);let n;if(a.friendRequestType===W.FRIEND_REQUEST_TYPE_SUGGEST){if(a.requested)return n=104097,fe.default.logAction(n),s(!1);const r=ni.default.trans("STR_MSG_DEFAULT_REQ_ADD_FR",Z.default.getMiniProfileMe().zaloName);Qi.a.requestAddFriend(e,r,a.friendRequestSource).then((()=>{ft.ModalManagerV2.openModal({windowId:t,name:W.ModalIdentitiesDefine.BLOCK_STORIES,params:{userId:e,windowId:t}}),_t.default.changeFriendsToStranger(e),$r.a.removeSuggest(e);const i=Object(T.a)(Object(T.a)({},a),{},{requested:!0});this.broadcastEvent(Kr.b.SentFriendReq,e),this.data.set(e,i),this.onFriendListNotificationsChange({action:"remove",ids:[e]}),s(!0)})).catch((e=>{this.handleFailureFriendRq(e),i(e)})),n=104096}else Qi.a.acceptAddFriend(e).then((()=>{this.data.delete(e),Object(Zs.e)(this.name,e),this.onFriendListNotificationsChange({action:"remove",ids:[e]}),this.broadcastEvent(Kr.b.AcceptRequest,e),Qr.a.getUser(e).then((t=>{N.default.send(P.FetchActions.FRIENDS_FETCHED,{[e]:Object(T.a)(Object(T.a)({},A.default.reformatConversationFromFriend(t)),{},{isFr:1})})})),_t.default.getAcceptNewFriend(a),ft.ModalManagerV2.openModal({windowId:t,name:W.ModalIdentitiesDefine.BLOCK_STORIES,params:{userId:e,windowId:t}}),s(!0)})).catch((e=>{this.handleFailureFriendRq(e),i(e)})),n=104095;n&&fe.default.logAction(n)}))}async rejectFriendRequest(e){const t=this.data.get(e),s=()=>{ai.a.createSuccess(ni.default.str("STR_TOAST_REJECT_REQUEST")),_t.default.changeFriendsToStranger(e),$r.a.removeSuggest(e),this.broadcastEvent(Kr.b.RejectRequest,e)},i=e=>{A.default.logCoreError(e),e&&e.error_message&&ai.a.createError(e.error_message)};t&&t.friendRequestSource?Ni.default.removeRecommendedFriend(e,t.friendRequestSource).then(s).catch(i):Qi.a.rejectRequestAddFriend(e).then(s).catch(i),this.data.delete(e),this.onFriendListNotificationsChange({action:"remove",ids:[e]}),fe.default.logAction(104094)}undoRequestFriend(e){e&&Qi.a.undoRequestAddFriend(e).catch((e=>{e.error_message&&ai.a.createError(e.error_message)}))}clearUnreadFriendRequest(){Q.a.UnreadDataManager.updateUnreadCount(W.FAKE_CONVERSATION_ID.FRIEND_CENTER,0),this.unreadFRList=[],Object(Zs.h)(this.name,eo.UNREADREQ)}getAllFriendRequests(){return new Promise(((e,t)=>{const s=$r.a.getRecommendedFriendsV2(!1,!1);if(!s)return e({});e(this.filterFriendRequest(s))}))}getAllFriendRequestsSync(){const e=$r.a.getRecommendedFriendsSync();return e?this.filterFriendRequest(e):{}}init(){_t.default.getFriends(null,!0).then((e=>{if(e){const t=_t.default.getLastContactListOpenTime(),s=e.filter((e=>e&&e.friendRequestFetchTime>t)).map((e=>e.userId));s.length&&this.onFriendListNotificationsChange({action:"add",ids:s})}}))}getItem(e){return Xr}getList(e){return e.key===eo.UNREADREQ?this.unreadFRList:[]}onGetItemFailure(e){}onGetListFailure(e){}handleFailureFriendRq(e){if(A.default.logCoreError(e),e&&e.error_message){let t=e.error_message;[224,251].includes(e.error_code)&&(t=ni.default.trans(`STR_FRIEND_REQUEST_FAIL_${e.error_code}`,[""+U.default.limitFriends])),ai.a.createMessage(t,3e3)}}filterFriendRequest(e){const t={};for(let s in e)if(e.hasOwnProperty(s)){let i=e[s];i&&i.dataInfo.recommType===Jr&&(t[s]=i,t[s].friendRequestType=i.dataInfo.recommType)}return t}broadcastEvent(e,t,s){this.dispatchEvent(new Kr.a(e,t,s)),this.dispatchEvent(new Kr.a(Kr.b.FriendCenterChange,t,Object(T.a)(Object(T.a)({},s),{},{act:e})))}})||Wr)||Wr);const to=Object(i.define)("cloud-segment-repository"),so=Object(i.define)("cloud-segment-manager"),io=Object(i.define)("cloud-message-manager");class ao{constructor(e){this.entity=e}get conversationId(){return this.entity.conversationId}get cloudFirstSmsLocalId(){return this.entity.cloudFirstSmsLocalId}get cloudSegmentCheck(){return this.entity.cloudSegmentCheck}get hasMore(){return this.entity.hasMore}get lastCloudVerifiedDttm(){return this.entity.lastCloudVerifiedDttm}get lastDeletedMsgID(){return this.entity.lastDeletedMsgID}get lastGetMaxRecentTs(){return this.entity.lastGetMaxRecentTs}get maxCloudMsgId(){return this.entity.maxCloudMsgId}}var no;let ro=i.ModuleContainer.injectable()(no=Reflect.metadata("design:type",Function)(no=Reflect.metadata("design:paramtypes",[])(no=class{constructor(){}get(e){return Os.a.getSegmentByConvId(e)}})||no)||no)||no;var oo,co=s("D8Ji");let lo=i.ModuleContainer.injectable()(oo=function(e,t){return i.ModuleContainer.inject(to)(e,void 0,0)}(oo=Reflect.metadata("design:type",Function)(oo=Reflect.metadata("design:paramtypes",[void 0===to?Object:to])(oo=class{constructor(e){this.segmentRepository=e}get(e){return this.segmentRepository.get(e).then((e=>e&&new ao(e))).catch((e=>{}))}async createOrExtendSegment(e,t){const s=await this.segmentRepository.get(e);s.cloudSegmentCheck=co.a.mergeNewSegment(t.verifiedRange,null==s?void 0:s.cloudSegmentCheck),s.maxCloudMsgId=Math.max(s.maxCloudMsgId||0,t.verifiedRange[1]),Os.a.setSegmentCacheByConvId(e,s),await Es.b.updateSegmentDB(e,s)}})||oo)||oo)||oo)||oo;class ho extends Error{constructor(e,t,s){super(s),this.code=e,this.data=t}}var uo;let go=i.ModuleContainer.injectable()(uo=function(e,t){return i.ModuleContainer.inject(dr.a)(e,void 0,0)}(uo=Reflect.metadata("design:type",Function)(uo=Reflect.metadata("design:paramtypes",[void 0===dr.a?Object:dr.a])(uo=class{constructor(e){this.config=e}get settings(){return this.config.get("cloud.auto_download")}async crawlMissingMessage(e,t={nRetry:0,count:50}){let s=e.conversationId;s.startsWith("g")&&(s=s.slice(1));const i=`${s}_${e.requestMsgId}`;let a=this.settings.limit.minMsgDttm,n=this.settings.limit.maxMsgFirstSegment;const r={groupId:s,fromMsgId:e.requestMsgId,globalMsgIds:e.globalMsgIds,curTotalMsgs:e.curTotalMsgs,tsJoinGroup:e.tsJoinGroup,minMsgTs:a,maxTotalSyncMsg:n};return await rs.default.crawlMissingMessage(i,r,{requestTimeout:this.settings.fetching.timeout,count:t.count,nRetry:t.nRetry,usePostApi:!0}).then((e=>Object(os.a)(e))).then((e=>{try{return JSON.parse(e)}catch(t){throw{error_code:-1,error_message:"invalid response"}}})).then((e=>{const t=e[s];if(t.error>0)throw{error_code:t.error,error_message:"inner error"};return t})).catch((e=>{if("number"==typeof e.error_code){let s=e.data;try{s=JSON.parse(s)}catch(t){}throw new ho(e.error_code,s,e.error_message)}throw e}))}})||uo)||uo)||uo)||uo;var mo,po=s("yEZN"),fo=s("EO3V"),vo=s("enz2");const _o={totalMsgCount:0,fetchedMsgCount:0,serverMsgCount:0,newMsgCount:0,phaseDone:!1,isFilteredByTimeJoin:!1,done:!0,tsJoinGroup:"0"};let bo=i.ModuleContainer.injectable()(mo=function(e,t){return i.ModuleContainer.injectToken(go)(e,void 0,0)}(mo=function(e,t){return i.ModuleContainer.inject(so)(e,void 0,1)}(mo=function(e,t){return i.ModuleContainer.inject(po.c)(e,void 0,2)}(mo=function(e,t){return i.ModuleContainer.inject(po.b)(e,void 0,3)}(mo=function(e,t){return i.ModuleContainer.inject(B.ZLoggerFactory)(e,void 0,4)}(mo=Reflect.metadata("design:type",Function)(mo=Reflect.metadata("design:paramtypes",[void 0===go?Object:go,void 0===so?Object:so,void 0===po.c?Object:po.c,void 0===po.b?Object:po.b,void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory])(mo=class{constructor(e,t,s,i,a){this.api=e,this.segmentManager=t,this.messageRepository=s,this.messageManager=i,this.logger=void 0,this.logger=a.createZLogger("cld-msg",["manager"])}async crawlMissingMessage(e,t,s){const i=await this.segmentManager.get(e),a=(()=>{var e;let t=s.minMsgId&&Number.parseInt(s.minMsgId);return i&&i.lastDeletedMsgID&&(t=t?Math.max(i.lastDeletedMsgID,t):i.lastDeletedMsgID),null===(e=t)||void 0===e?void 0:e.toString()})(),n="0"!==t,r=n?s.count+1:s.count;if(n&&t<=a)return _o;const o=await this.messageManager.findPrevMessagesFromMsgId(e,{maxMsgId:"0"!==t?t:void 0,minMsgId:a,limit:r}).then((e=>e.map((e=>e.entity)))),c=new Set;o.forEach((e=>{try{const t=Number.parseInt(e.msgId);Number.isInteger(t)&&c.add(t.toString())}catch(t){}}));const l=Array.from(c.values()),d=await this.api.crawlMissingMessage({conversationId:e,requestMsgId:t,globalMsgIds:l,curTotalMsgs:s.curTotalMsgs,tsJoinGroup:s.tsJoinGroup},{nRetry:s.nRetry,count:s.count});if(0===d.groupMsgs.length&&"0"===d.maxMsgId)return _o;let h=fo.a.checkDupMessageFromCloud(e,d.groupMsgs);a&&a>"0"&&(h=h.filter((e=>e.msgId>a)));const u=[...o,...h];if(0===u.length)return _o;const g=Number.parseInt(d.lastMsgId,10);let m=Number.parseInt(t);const p=fo.a.findMinMaxGroupMsg(u,m,g,null==i?void 0:i.lastDeletedMsgID),{groupMsgsToView:f,groupMsgsAddDb:v,groupMsgsSearch:_}=vo.a.findMsgsAddDb(t,h,[],o,Object(T.a)({apiType:2,conversationId:e},p));v.forEach((e=>{e.src=W.MSG_SRC.AUTO_LOADER})),await this.messageRepository.saveMessages(e,v),await vo.a.updateSearchV3(_,e);const b=!!d.isFilteredByPhase,y=d.maxMsgId;p.minMsgId&&p.maxMsgId&&await this.segmentManager.createOrExtendSegment(e,{verifiedRange:[p.minMsgId,p.maxMsgId]});let I="0";Number.isInteger(Number.parseInt(d.tsJoinGroup))?I=d.tsJoinGroup:this.logger.zsymb(18,"23qTNN",(()=>["api res invalid ts join group",{tsJoinGroup:d.tsJoinGroup}]));const S=!!d.isFilteredByTimeJoin,C={totalMsgCount:f.length,fetchedMsgCount:v.length,serverMsgCount:h.length,newMsgCount:v.length,phaseDone:b,isFilteredByTimeJoin:S,done:!(b||!S&&d.hasMore),minMsgId:a,maxMsgId:y.toString(),tsJoinGroup:I};return this.logger.zsymb(3,"vz-ZnT",["[auto-dl-msg] crawl result","7lpe7Q"],C),C}})||mo)||mo)||mo)||mo)||mo)||mo)||mo)||mo;i.ModuleContainer.registerSingleton(to,ro),i.ModuleContainer.registerSingleton(so,lo),i.ModuleContainer.registerSingleton(io,bo);var yo,Io=s("KP/S"),So=s("wiGx"),Co=s("ttnr");const Eo={screen:So.a.Hidden,error:Io.c.NO_ERROR,progress:0,totalProgress:0,numOfSyncedConv:0,popupVisible:!1,startSyncTime:0,closing:!1,syncingConversation:null};Object(ie.b)(So.b)(yo=Reflect.metadata("design:type",Function)(yo=Reflect.metadata("design:paramtypes",[])(yo=class{constructor(){this.progressRecording=void 0,this.downloadBackupTime=void 0,this.state=Object(T.a)({},Eo),this.name="sync-message-ui",this.key="window_id",this.progressRecording=new Map,this.initialRecordProgress(),this.downloadBackupTime=null}initialRecordProgress(){this.progressRecording.set(So.a.DownloadingBackup,0),this.progressRecording.set(So.a.DecryptingBackup,0),this.progressRecording.set(So.a.SyncInProgress,0)}recordProgress(e){const t=this.state.screen,s=e=>e>100?100:e;switch(t){case So.a.DownloadingBackup:this.progressRecording.set(t,s(e));break;case So.a.DecryptingBackup:this.progressRecording.set(So.a.DownloadingBackup,100),this.progressRecording.set(t,s(e));break;case So.a.SyncInProgress:this.progressRecording.set(So.a.DownloadingBackup,100),this.progressRecording.set(So.a.DecryptingBackup,100),this.progressRecording.set(t,s(e))}}calculateTotalProgressTransfer(){const e=this.state.screen,t=this.progressRecording.get(So.a.DownloadingBackup)||0,s=this.progressRecording.get(So.a.DecryptingBackup)||0,i=this.progressRecording.get(So.a.SyncInProgress)||0,a=(e,t)=>{let s=0;switch(t){case So.a.DownloadingBackup:s=Co.a.getPercentDownload();break;case So.a.DecryptingBackup:s=Co.a.getPercentDecrypt();break;case So.a.SyncInProgress:s=Co.a.getPercentRestore()}return Math.round(e*s/100)};switch(e){case So.a.DownloadingBackup:return a(t,e);case So.a.DecryptingBackup:return a(t,So.a.DownloadingBackup)+a(s,e);case So.a.SyncInProgress:return a(t,So.a.DownloadingBackup)+a(s,So.a.DecryptingBackup)+a(i,e);default:return 0}}showPopup(){this.setState((e=>{e.popupVisible=!0}))}setSyncingConversation(e){this.setState((t=>{t.syncingConversation=e}))}hidePopup(){this.setState((e=>{e.popupVisible=!1}))}hideAllUI(){this.setState((e=>{e.screen=So.a.Hidden,e.closing=!1}))}showError(e){this.setState((t=>{t.error=e,t.screen=So.a.Error,t.syncingConversation=null}))}showSuggestNewSync(e){this.setState((t=>{t.screen=So.a.SuggestNewSync,t.popupVisible=e}))}showSuggestResume(){this.setState((e=>{e.screen=So.a.SuggestResume,e.popupVisible=!1}))}showSyncGuide(){this.setState((e=>{e.screen=So.a.SyncGuide,e.popupVisible=!0}))}showWaitForBackup(){this.setState((e=>{e.screen=So.a.WaitForBackup}))}showMobileIdleInBackup(){this.setState((e=>{e.screen=So.a.MobileIdleInBackup}))}showDownloadingBackup(){this.setDownloadBackupTime(performance.now()),this.setState((e=>{e.screen=So.a.DownloadingBackup,e.progress=0,e.totalProgress=this.calculateTotalProgressTransfer()}))}showDecryptingBackup(){this.setState((e=>{e.screen=So.a.DecryptingBackup,e.progress=0,e.totalProgress=this.calculateTotalProgressTransfer()}))}showInProgress(){this.setState((e=>{e.screen=So.a.SyncInProgress,e.progress=0,e.totalProgress=this.calculateTotalProgressTransfer()}))}showCloseNotice(){this.setState((e=>{e.closing=!0}))}showSuccessMessage(){this.setState((e=>{e.screen=So.a.SyncSuccess,e.syncingConversation=null}))}showWaitForNetwork(){this.setState((e=>{e.screen=So.a.WaitForNetwork}))}setProgress(e){this.recordProgress(e),this.setState((t=>{t.progress=e,t.totalProgress=this.calculateTotalProgressTransfer()}))}setNumOfSyncedConv(e){this.setState((t=>{t.numOfSyncedConv=e}))}resetStartSyncTime(){this.setState((e=>{e.startSyncTime=Date.now()}))}clearError(){this.setState((e=>{e.error=Io.c.NO_ERROR}))}getStartSyncTime(){return this.state.startSyncTime}getCurrentError(){return this.state.error}getCurrentScreen(){return this.state.screen}getPopupVisible(){return this.state.popupVisible}setDownloadBackupTime(e){this.downloadBackupTime=e}getDownloadBackupTime(){return this.downloadBackupTime}init(){}getItem(){return this.state}getList(){return[]}onGetItemFailure(){}onGetListFailure(){}setState(e){const t=Object(kt.a)(this.state,e);this.state!==t&&(this.state=t,Object(Zs.g)(this.name,"current"))}})||yo)||yo);class Oo{constructor(e,t,s){this._issuedAt=void 0,this._ttl=void 0,this._publicKey=void 0,this._privateKey=void 0,this._publicKey=e,this._privateKey=t,this._ttl=s,this._issuedAt=Date.now()}get valid(){return Date.now()-this._issuedAt<this._ttl}get publicKey(){return this._publicKey}get privateKey(){return this._privateKey}}const To=Object(i.define)("sync-message-key-generator");var Mo;const Ro=$znode.crypto;let wo=i.ModuleContainer.injectable()(Mo=class{generate(){return this.generateKey()}decryptKey(e,t,s){return Ro.privateDecrypt(s.privateKey,Ro.constants.RSA_PKCS1_PADDING,e,{input:"base64",output:t})}generateKey(){const e=Ro.generateKeyPairSync("rsa",{modulusLength:2048,publicKeyEncoding:{type:"spki",format:"der"},privateKeyEncoding:{type:"pkcs1",format:"pem"}},{publicKey:"base64",privateKey:""}),t=U.default.cross_setting.timeoutKey*W.ONE_HOUR_MS;return new Oo(e.publicKey,e.privateKey,t)}})||Mo;i.ModuleContainer.registerSingleton(To,wo);const Lo=Object(i.define)("ui-helper");i.ModuleContainer.register(Lo,class{async showUserConfirm(e={}){return new Promise((t=>{let s=e.message;"string"==typeof s&&(s=ni.default.trans(s)),ye.p.dispatch({type:P.PopupActions.TOGGLE_CONFIRM,payload:{headerText:ni.default.trans(e.header||"STR_ZALO_CONFIRM"),callback:(e,s)=>{const i=!!s&&s.dontAskAgain;t([e,i])},buttons:{confirm:e.confirm&&ni.default.trans(e.confirm),cancel:e.cancel&&ni.default.trans(e.cancel),type:e.primaryButtonType||"primary"},message:s,usePrimaryForConfirm:!1,width:e.width||450,options:e.remember?[{title:e.remember,key:"dontAskAgain"}]:[]}})}))}async showUserConfirmV2(e={}){return new Promise((t=>{ri.ConfirmManagerV2.openConfirm({windowId:e.windowId||yt.c,name:W.MODAL_CONFIRM.confirmIdentities,params:{title:ni.default.str(e.header||"STR_CONFIRM"),message:ni.default.str(e.message||""),okText:ni.default.str(e.confirm||"STR_OK"),cancelText:ni.default.str(e.cancel||"STR_CANCEL"),okType:e.primaryButtonType,width:e.width,onOk:()=>{t(!0)},onCancel:()=>{t(!1)}}})}))}closeUserCOnfrimV2(e){ri.ConfirmManagerV2.isVisible({windowId:(null==e?void 0:e.windowId)||yt.c,name:W.MODAL_CONFIRM.confirmIdentities})&&ri.ConfirmManagerV2.closeConfirm({windowId:(null==e?void 0:e.windowId)||yt.c,name:W.MODAL_CONFIRM.confirmIdentities})}});var Fo=s("cPHW");const Do=Object(i.define)("sync-message-service");var Ao=s("LLK0");class No{constructor(){this.interpreter=void 0}create(e){this.interpreter=new Ao.a(this.createMachine(e),e)}get status(){var e;return(null===(e=this.interpreter)||void 0===e?void 0:e.status)||Ao.b.NotStarted}start(){var e;null===(e=this.interpreter)||void 0===e||e.start()}stop(){var e;null===(e=this.interpreter)||void 0===e||e.stop()}send(e){return this.interpreter.send(e)}onChange(e){this.interpreter.onChange(e)}onTransition(e){this.interpreter.onTransition(e)}onStop(e){this.interpreter.onStop(e)}onDone(e){this.interpreter.onDone(e)}off(e){var t,s;null===(t=this.interpreter)||void 0===t||null===(s=t.off)||void 0===s||s.call(t,e)}}var ko=s("lgMn"),Po=s("qKtC"),jo=s("FQFD"),Uo=s("+Mel");let Bo=function(e){return e[e.RESTORE_CONVERSATIONS=0]="RESTORE_CONVERSATIONS",e[e.RESTORE_MESSAGES=1]="RESTORE_MESSAGES",e[e.UPDATE_MESSAGES_CACHE=2]="UPDATE_MESSAGES_CACHE",e}({});const Go=Object(i.define)("sync-message-storage");class zo{constructor(){this.key=""}load(){if(""!==this.key)throw new Error("SyncStorage already initialized");this.key="sync_cross_state"}read(e,t){const s=n.default.getInstance();e=`${this.key}_${e}`;const i=s.getItemForCurrentUser(e);if(i){const a=JSON.parse(i);if(a.version===t)return a.value;s.removeItemForCurrentUser(e)}return null}write(e,t,s){const i=n.default.getInstance();if(null!==s)return e=`${this.key}_${e}`,void i.setItemForCurrentUser(e,JSON.stringify({version:t,value:s}));this.remove(e)}remove(e){const t=n.default.getInstance();e=`${this.key}_${e}`,t.removeItemForCurrentUser(e)}}class xo{constructor(e){this.adapter=e,this._state=void 0}get step(){if(!this._state)throw new Error("SyncStateStore not initialized");return this._state.step}get isStarted(){return!!this._state&&this._state.started}get isSyncing(){return!!this._state&&this._state.isSyncing}set isSyncing(e){if(!this._state)throw new Error("SyncStateStore not initialized");this._state=Object(T.a)(Object(T.a)({},this._state),{},{isSyncing:e}),this.save()}get checkpoint(){if(!this._state)throw new Error("SyncStateStore not initialized");if(!this._state.checkpoint)throw new Error("Reset checkpoint before using");return this._state.checkpoint}set checkpoint(e){if(!this._state)throw new Error("SyncStateStore not initialized");if(!e)throw new Error("checkpoint should not be null");this._state=Object(T.a)(Object(T.a)({},this._state),{},{checkpoint:e}),this.save()}load(){this._state=this.adapter.read("sync-state",1)}resetCheckpoint(e,t,s){if(!this._state)throw new Error("SyncStateStore not initialized");if(0===e)this._state=Object(T.a)(Object(T.a)({},this._state),{},{checkpoint:{format:0,syncedConversations:0,updatedConversation:0,importedMessages:0,syncedMessages:0,minSeq:t,maxSeq:s,currentSeq:Number.MAX_SAFE_INTEGER}});else{if(1!==e)throw new Error("checkpoint.format must be 0 or 1");this._state=Object(T.a)(Object(T.a)({},this._state),{},{checkpoint:{format:1,syncedConversations:0,updatedConversation:0,importedMessages:0,syncedMessages:0,minSeq:t,maxSeq:s,currentSeq:{},priorities:[],syncingConversation:null}})}}nextStep(){if(!this._state)throw new Error("SyncStateStore not initialized");const e=this._state.step+1;if(e>Bo.UPDATE_MESSAGES_CACHE)throw new Error("already at the last step");this._state=Object(T.a)(Object(T.a)({},this._state),{},{step:e}),this.save()}reset(){this._state={step:Bo.RESTORE_CONVERSATIONS,started:!0,isSyncing:!1},this.save()}clear(){this._state=null,this.adapter.remove("sync-state")}save(){this._state?this.adapter.write("sync-state",1,this._state):this.adapter.remove("sync-state")}}class Vo{constructor(e){this.adapter=e,this._backup=void 0}load(){this._backup=this.adapter.read("backup",1)}get(){if(void 0===this._backup)throw new Error("BackupStore not initialized");return this._backup}save(e){return this._backup=e,this.adapter.write("backup",1,this._backup),e}clear(){this._backup=null,this.adapter.remove("backup")}}class Ho{constructor(e){this.adapter=e,this._value=void 0}load(){this._value=this.adapter.read("src",1)}get(){if(void 0===this._value)throw new Error("SyncSourceStore not initialized");return this._value}save(e){this._value=e,this.adapter.write("src",1,this._value)}clear(){this._value=null,this.adapter.remove("src")}}class qo{constructor(e){this.adapter=e,this._value=void 0,this._arrivalTimestamp=void 0,this._arrivalTimestamp=0}load(){this._value=this.adapter.read("tempKeySource",1)}setArrivalTimestamp(e){this._arrivalTimestamp=e}getArrivalTimestamp(){return this._arrivalTimestamp}get(){return void 0===this._value?Io.m.SERVER:this._value}save(e){this._value=e,this.adapter.write("tempKeySource",1,this._value)}clear(){this._value=null,this.adapter.remove("tempKeySource")}}i.ModuleContainer.registerSingleton(Go,class{constructor(){this._adapter=void 0,this._syncStateStore=void 0,this._syncSourceStore=void 0,this._backupStore=void 0,this._tempKeySourceStore=void 0,this._adapter=new zo,this._syncStateStore=new xo(this._adapter),this._syncSourceStore=new Ho(this._adapter),this._backupStore=new Vo(this._adapter),this._tempKeySourceStore=new qo(this._adapter)}load(e){this.migrate(),this._adapter.load(),this._syncSourceStore.load(),this._syncStateStore.load(),this._backupStore.load(),this._tempKeySourceStore.load()}clear(e){e||(this._syncSourceStore.clear(),this._syncStateStore.clear()),this._backupStore.clear()}get syncState(){return this._syncStateStore}get backup(){return this._backupStore}get syncSource(){return this._syncSourceStore}get tempKeySource(){return this._tempKeySourceStore}migrate(){}});var Wo,Zo=s("6D/Z"),Ko=s("U+wf");const Qo=Object(i.define)("sync-message-metrics");let $o=Object(i.injectable)()(Wo=function(e,t){return Object(i.inject)(B.ZLoggerFactory)(e,void 0,0)}(Wo=Reflect.metadata("design:type",Function)(Wo=Reflect.metadata("design:paramtypes",[void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory])(Wo=class{constructor(e){this.startTime=-1,this.lastMilestone=-1,this.lastSyncSource=Io.j.MANUAL,this.logger=void 0,this.logger=e.createZLogger("msg-sync",["metrics"])}get storage(){return i.ModuleContainer.resolve(Go)}get uiState(){return i.ModuleContainer.resolve(Zo.b)}get setting(){return i.ModuleContainer.resolve(jo.a)}get entriesTransferManager(){return i.ModuleContainer.resolve(Po.b)}get messageReadinessChecker(){return i.ModuleContainer.resolve(Ko.a)}setLastSyncSource(e){this.lastSyncSource=e}getLastSyncSource(){return this.lastSyncSource}onStartTransferAfterLogin(){this.actionLog(Io.l.NORMAL),this.entriesTransferManager.missingMessageEventList.includes(Io.j.E2EE_MISSING_MESSAGE)&&this.onTransferAfterLoginWithChangeDeviceEvent(),this.entriesTransferManager.missingMessageEventList.includes(Io.j.OVERFLOW)&&this.onTransferAfterLoginWithOverflowQueueEvent(),this.setLastSyncSource(Io.j.TRANSFER_WHEN_LOGIN)}onTransferAfterLoginWithChangeDeviceEvent(){this.actionLog(Io.l.WITH_E2EE_MISSING_MESSAGE)}onTransferAfterLoginWithOverflowQueueEvent(){this.actionLog(Io.l.WITH_OVERFLOW_QUEUE)}onCheckSyncSuggestion(e){switch(e){case Io.j.FIRST_TIME_LOGIN:break;case Io.j.OVERFLOW:this.actionLog(2090208)}}onShowSyncSuggestion(){switch(this.storage.syncSource.get()){case Io.j.FIRST_TIME_LOGIN:this.actionLog(2090101);break;case Io.j.OVERFLOW:case Io.j.E2EE_MISSING_MESSAGE:this.actionLog(2090201)}}onShowErrorModal(){this.uiState.getCurrentError()===Io.c.USER_DONT_CONFIRM&&this.actionLog(2090801)}onSyncFailed(e){const t=this.lastSyncSource,s=this.storage.backup.get(),i=this.getSyncDuration(),a=JSON.stringify({format:(null==s?void 0:s.format)||void 0,src:t,import:this.storage.syncState.checkpoint.importedMessages,transfer:(null==s?void 0:s.numberOfMessagesCount)||void 0});Si.default.increaseFailed(Io.f.GENERAL,0,i,e,Date.now(),[a]),this.logger.zsymb(0,"pzqtTw",`onSyncFailed ${e} ${a}`),e===Io.c.USER_DONT_CONFIRM&&this.actionLog(2090903),t===Io.j.TRANSFER_WHEN_LOGIN&&this.actionLog(Io.l.FAILED)}onCloseBanner(){const e=this.uiState.getCurrentError(),t=this.uiState.getPopupVisible(),s=this.uiState.getCurrentScreen();if(!t){if(this.actionLog(2090301),s===Zo.a.SyncGuide)this.actionLog(2090701);e!==Io.c.NO_ERROR&&(t||this.actionLog(2090402),e===Io.c.USER_DONT_CONFIRM&&this.actionLog(2090901))}}onClosePopup(){const e=this.uiState.getCurrentError();this.uiState.getCurrentScreen()===Zo.a.SyncGuide&&this.actionLog(2090601),e===Io.c.USER_DONT_CONFIRM&&this.actionLog(2090803),e!==Io.c.NO_ERROR&&this.actionLog(2091406)}onCloseSyncSuggestion(){switch(this.storage.syncSource.get()){case Io.j.FIRST_TIME_LOGIN:this.actionLog(2090101);break;case Io.j.OVERFLOW:case Io.j.E2EE_MISSING_MESSAGE:this.actionLog(2090203)}}clickResend(){this.actionLog(2090602)}clickCacnelInCloseSyncSuggestionConfirmModal(){switch(this.storage.syncSource.get()){case Io.j.FIRST_TIME_LOGIN:break;case Io.j.OVERFLOW:this.actionLog(2090206)}}clickConfirmSync(){switch(this.storage.syncSource.get()){case Io.j.MANUAL:this.setting.value().dontSuggest?this.actionLog(2091001):this.actionLog(2091002);break;case Io.j.SETTING:this.setting.value().dontSuggest?this.actionLog(2090502):this.actionLog(2090501);break;case Io.j.FIRST_TIME_LOGIN:this.actionLog(2090102);break;case Io.j.OVERFLOW:case Io.j.E2EE_MISSING_MESSAGE:this.actionLog(2090202)}}clickRejectSuggestion(){this.actionLog(2090103)}clickContinueInRejectSuggestionConfirmModal(){switch(this.storage.syncSource.get()){case Io.j.FIRST_TIME_LOGIN:break;case Io.j.OVERFLOW:this.setting.value().dontSuggest?this.actionLog(2090205):this.actionLog(2090204)}}clickCancelInRejectSuggestionConfirmModal(){}clickCancelSync(){switch(this.uiState.getCurrentScreen()){case Zo.a.SyncGuide:this.actionLog(2090304);break;case Zo.a.WaitForBackup:this.actionLog(2090305)}}clickCancelInCancelSyncConfirmModal(){this.actionLog(2090302)}clickConfirmCancelSyncConfirmModal(){const e=this.uiState.getCurrentScreen(),t=this.storage.syncSource.get();e===Zo.a.SyncGuide&&this.actionLog(2090311),t===Io.j.TRANSFER_WHEN_LOGIN&&this.onUserTerminateTransferAfterLogin(),this.actionLog(2090303)}onUserTerminateTransferAfterLogin(){this.actionLog(Io.l.USER_TERMINATE_TRANSFER_WHEN_LOGIN)}terminateTransferWhenLogin(){this.actionLog(Io.l.AUTO_TERMINATE_TRANSFER_WHEN_LOGIN)}waitingForNoMissingMessageEventsTimeout(){this.actionLog(Io.l.WAITING_FOR_NO_MISSING_MESSAGE_EVENTS_TIMEOUT)}clickRetrySync(){const e=this.uiState.getCurrentError(),t=this.uiState.getPopupVisible();e!==Io.c.NO_ERROR&&(this.actionLog(2090401),t&&this.actionLog(2091407),e===Io.c.USER_DONT_CONFIRM&&(t?this.actionLog(2090802):this.actionLog(2090902)))}clickViewGuide(){this.actionLog(2090702)}resetSyncStartTime(){this.startTime=fi.a.now(),this.lastMilestone=fi.a.now()}onSyncSuccess(e,t,s,i={}){const a=this.lastSyncSource;this.actionLog(2091101);const n=this.getSyncDuration(),r=JSON.stringify({format:e,src:a,import:t,transfer:s,trackInfo:i});Si.default.increaseSuccess(Io.f.GENERAL,0,n,[r]),a===Io.j.TRANSFER_WHEN_LOGIN&&this.actionLog(Io.l.SUCCESS),this.logger.zsymb(0,"i7SETB",`ph7 onSyncSuccess ${r}, ${n}`)}onReqBackupSuccess(e){const t=this.getMilestoneDuration(!0);Si.default.increaseSuccess(Io.f.REQ_BACKUP,0,t,[JSON.stringify({format:e})])}onReqBackupFailure(e,t){Si.default.increaseFailed(Io.f.REQ_BACKUP,e,this.getMilestoneDuration(),t,Date.now())}onDownloadBackupSuccess(){const e=this.getMilestoneDuration(!0);Si.default.increaseSuccess(Io.f.DOWNLOAD_BACKUP,0,e)}onDownloadBackupFailure(e,t){Si.default.increaseFailed(Io.f.DOWNLOAD_BACKUP,e,this.getMilestoneDuration(),t,Date.now())}onDecryptBackupSuccess(){const e=this.getMilestoneDuration(!0);Si.default.increaseSuccess(Io.f.DECRYPT_BACKUP,0,e)}onDecryptBackupFailure(e){const t=this.getMilestoneDuration();Si.default.increaseFailed(Io.f.DECRYPT_BACKUP,0,t,e,Date.now())}onRestoreDataSuccess(){const e=this.getMilestoneDuration(!0);Si.default.increaseSuccess(Io.f.RESTORE_TASK,0,e),this.logger.zsymb(0,"qLB8UD","ph7 restore success",e)}onRestoreDataFailure(e){const t=this.getMilestoneDuration();Si.default.increaseFailed(Io.f.RESTORE_TASK,Io.g.SELF_DEFINE,t,e,Date.now())}clickConfirmCancelSyncConfirmModalFromCounterModal(){this.uiState.getCurrentScreen()===Zo.a.SyncGuide&&this.actionLog(2090311),this.actionLog(2090303)}onErrorTimeoutWaitingMobileConfirm(){this.actionLog(2090312)}clickCloseSynGuidePopup(){this.actionLog(2090601)}onShowSyncGuidePopup(){this.actionLog(2090604)}onConfirmSyncFromMobile(){this.actionLog(2090605)}onRejectSyncFromMobile(){this.actionLog(2090606)}onErrorPopupWaitingMobileConfirm(e){if(this.uiState.getPopupVisible())switch(this.actionLog(2091401),e){case Io.c.NO_NETWORK:this.actionLog(2091402);break;case Io.c.USER_DONT_CONFIRM:this.actionLog(2091403);break;case Io.c.BUSY_RESTORING:this.actionLog(2091404);break;case Io.c.CLIENT_NOT_SUPPORT:this.actionLog(2091405)}}onShowSyncSuggestionWithoutResume(){this.actionLog(2090209)}onMobileIdle(){this.actionLog(Io.e)}logMissingMessageEventsTimeSinceGetLoginInfo(){const e=e=>e>0?(e-t)/1e3:-1,t=this.messageReadinessChecker.getGetLoginInfoTimestamp(),s=this.messageReadinessChecker.getDoneCheckOverflowTimestamp(),i=this.messageReadinessChecker.getE2eeSessionChangedTimestamp(),a=this.storage.tempKeySource.getArrivalTimestamp(),n=this.messageReadinessChecker.getApplicationReadyTimestamp();let r=e(s),o=e(i),c=e(a),l=e(n);t<=0&&(r=o=c=l=-1);this.actionLogInfoV2(fe.FeaturesInfo.MessageReadinessStatus,2,{temp_key:c,queue_evict:r,change_device_e2ee:o,application_ready:l})}actionLogInfoV2(e,t,s,i,a){fe.default.logActionInfoV2(e,t,s,i,a)}actionLog(e){fe.default.logAction(e)}getSyncDuration(){return this.startTime>0?fi.a.now()-this.startTime:0}getMilestoneDuration(e=!1){const t=this.lastMilestone>0?fi.a.now()-this.lastMilestone:0;return e&&(this.lastMilestone=fi.a.now()),t}})||Wo)||Wo)||Wo)||Wo;i.ModuleContainer.registerSingleton(Qo,$o);var Yo=s("G15u"),Jo=s("4ZNH"),Xo=s("Fbac");function ec(e){const t={retryCount:-1,canRetry:0!==e.maxRetry};return Object(Yo.a)({context:t,initial:"running",states:{running:{entry:Xo.a.assign({retryCount:e=>e.retryCount+1}),invoke:{src:t=>e.action(t.retryCount),onError:[{cond:(t,s)=>!(!t.canRetry||"function"==typeof e.canRetryError&&!e.canRetryError(s.data)),target:"retry"},{actions:(e,t)=>{e.error=t.data},target:"failure"}],onDone:{target:"final"}}},retry:{invoke:{src:()=>t=>{const s=e.autoRetry||0;if(s>0){const e=setTimeout((()=>{t({type:"RETRY"})}),s);return()=>clearTimeout(e)}return()=>{}}},on:{RETRY:{actions:Xo.a.assign({canRetry:t=>-1===e.maxRetry||t.retryCount<e.maxRetry}),target:"running"},ABORT:{target:"final"}}},failure:{type:"final",data:e=>({success:!1,error:e.error})},final:{type:"final",data:{success:!0}}}})}function tc(e,t,s,i){return Object(Yo.a)({strict:!0,context:{},initial:"running",states:{running:{initial:"prepare",states:{prepare:{entry:()=>{e.zsymb(3,"bKq4t8",["prepare","C22bF_"])},invoke:{src:async()=>t.prepareNewSync(),onDone:"request_backup",onError:{actions:()=>{Si.default.increaseFailed(98102,0,0,0,Date.now()),s.showError(Io.c.PREPARE_NEW_SYNC_FAILED)},target:"failure"}}},request_backup:{entry:()=>{Q.a.SyncMessageController.setRequestBackupTimeout(!1),e.zsymb(3,"ypCvSs",["send_request","tbPHpH"]),s.clearError(),s.showSyncGuide()},invoke:{id:"request_backup_api",src:ec({action:async e=>t.request(e),maxRetry:2,autoRetry:5e3,canRetryError:e=>e.code===W.NetWorkError.NO_NETWORK?(i.onReqBackupFailure(Io.g.SELF_DEFINE,Io.h.NO_NET),!1):211===e.error_code||-69===e.error_code?(i.onReqBackupFailure(Io.g.EXTERNAL,e.error_code),!1):(i.onReqBackupFailure(Io.g.EXTERNAL,e.error_code||-1),!0)}),onDone:[{cond:(e,t)=>t.data.success,target:"wait_for_user_confirm"},{cond:(e,t)=>{var s;return(null===(s=t.data.error)||void 0===s?void 0:s.code)===W.NetWorkError.NO_NETWORK},target:"#wait_for_network"},{actions:(e,t)=>{var a;211===(null===(a=t.data.error)||void 0===a?void 0:a.error_code)?(s.showError(Io.c.CLIENT_NOT_SUPPORT),i.onErrorPopupWaitingMobileConfirm(Io.c.CLIENT_NOT_SUPPORT)):s.showError(Io.c.REQUEST_BACKUP_FAILED)},target:"failure"}],onError:{actions:()=>{s.showError(Io.c.REQUEST_BACKUP_FAILED)},target:"failure"}},on:{SUCCESS:{target:"wait_for_user_confirm"},ERR_TIMEOUT:{actions:()=>{s.showError(Io.c.BACKUP_TIMEOUT),Co.a.isEnableUXConfirmTransferRevamp()&&Q.a.SyncMessageController.closeCancelSyncInSuggestingPopup()},target:"failure"},ERROR:{actions:()=>{s.showError(Io.c.REQUEST_BACKUP_FAILED),Co.a.isEnableUXConfirmTransferRevamp()&&Q.a.SyncMessageController.closeCancelSyncInSuggestingPopup()},target:"failure"},ERR_CLIENT_NOT_SUPPORT:{actions:()=>{s.showError(Io.c.CLIENT_NOT_SUPPORT),i.onErrorPopupWaitingMobileConfirm(Io.c.CLIENT_NOT_SUPPORT),Co.a.isEnableUXConfirmTransferRevamp()&&Q.a.SyncMessageController.closeCancelSyncInSuggestingPopup()},target:"failure"},USER_CONFIRM:{actions:()=>{e.zsymb(3,"aQNHm4",["user_confirm","QlGN-J"]),s.hidePopup(),Co.a.isEnableUXConfirmTransferRevamp()&&Q.a.SyncMessageController.closeCancelSyncInSuggestingPopup()},target:"wait_for_backup"},USER_REJECT:{actions:()=>{s.showError(Io.c.USER_REJECT_BACKUP),s.hidePopup(),Co.a.isEnableUXConfirmTransferRevamp()&&Q.a.SyncMessageController.closeCancelSyncInSuggestingPopup()},target:"failure"},ERR_BACKUP_FAIL:{actions:()=>{s.showError(Io.c.BACKUP_FAILED),Co.a.isEnableUXConfirmTransferRevamp()&&Q.a.SyncMessageController.closeCancelSyncInSuggestingPopup()},target:"failure"}}},wait_for_user_confirm:{entry:()=>{e.zsymb(3,"mYWkj4",["wait_for_user_confirm","pOs1M9"]),s.clearError(),s.showSyncGuide(),i.onShowSyncGuidePopup()},on:{USER_CONFIRM:{actions:()=>{e.zsymb(3,"HajPUx",["user_confirm","QlGN-J"]),s.hidePopup(),i.onConfirmSyncFromMobile(),Co.a.isEnableUXConfirmTransferRevamp()&&Q.a.SyncMessageController.closeCancelSyncInSuggestingPopup()},target:"wait_for_backup"},USER_REJECT:{actions:()=>{s.showError(Io.c.USER_REJECT_BACKUP),s.hidePopup(),i.onRejectSyncFromMobile(),Co.a.isEnableUXConfirmTransferRevamp()&&Q.a.SyncMessageController.closeCancelSyncInSuggestingPopup()},target:"failure"},ERR_TIMEOUT:{actions:()=>{i.onReqBackupFailure(Io.g.SELF_DEFINE,Io.h.CONFIRM_TIMEOUT),i.onErrorTimeoutWaitingMobileConfirm(),i.onErrorPopupWaitingMobileConfirm(Io.c.USER_DONT_CONFIRM),s.showError(Io.c.USER_DONT_CONFIRM),Co.a.isEnableUXConfirmTransferRevamp()&&Q.a.SyncMessageController.closeCancelSyncInSuggestingPopup()},target:"failure"},ERR_INVALID_BACKUP:{actions:()=>{s.showError(Io.c.REQUEST_BACKUP_FAILED),Co.a.isEnableUXConfirmTransferRevamp()&&Q.a.SyncMessageController.closeCancelSyncInSuggestingPopup()},target:"failure"},ERR_BUSY_RESTORING:{actions:()=>{i.onReqBackupFailure(Io.g.SELF_DEFINE,Io.h.BUSY_RESTORING),s.showError(Io.c.BUSY_RESTORING),i.onErrorPopupWaitingMobileConfirm(Io.c.BUSY_RESTORING),Co.a.isEnableUXConfirmTransferRevamp()&&Q.a.SyncMessageController.closeCancelSyncInSuggestingPopup()},target:"failure"},ERR_BACKUP_FAIL:{actions:()=>{i.onReqBackupFailure(Io.g.SELF_DEFINE,Io.h.BACKUP_FAILED),s.showError(Io.c.BACKUP_FAILED),Co.a.isEnableUXConfirmTransferRevamp()&&Q.a.SyncMessageController.closeCancelSyncInSuggestingPopup()},target:"failure"}}},wait_for_backup:{entry:()=>{e.zsymb(3,"HBqxkb",["wait_for_backup","KhCYwv"]),Q.a.SyncMessageController.setRequestBackupTimeout(!0),s.showWaitForBackup()},on:{SUCCESS:{target:"download_backup"},ERR_TIMEOUT:{actions:()=>{i.onReqBackupFailure(Io.g.SELF_DEFINE,Io.h.BACKUP_TIMEOUT),s.showError(Io.c.BACKUP_TIMEOUT)},target:"failure"},ERR_BACKUP_FAIL:{actions:()=>{s.showError(Io.c.BACKUP_FAILED)},target:"failure"},INVALID_BACKUP_INFO:{actions:()=>{i.onReqBackupFailure(Io.g.SELF_DEFINE,Io.h.INVALID_BACKUP),s.showError(Io.c.INVALID_BACKUP_INFO)},target:"failure"},INVALID_BACKUP_ENCRYPT_FORMAT:{actions:()=>{i.onReqBackupFailure(Io.g.SELF_DEFINE,Io.h.INVALID_BACKUP),s.showError(Io.c.INVALID_BACKUP_ENCRYPT_FORMAT)},target:"failure"}}},download_backup:{entry:()=>{e.zsymb(3,"k1FV0A",["download_backup","5BoljT"]),Q.a.SyncMessageController.clearRequestBackupTimeout(),s.showDownloadingBackup()},invoke:{strict:!0,src:ec({action:async e=>t.download(e),maxRetry:2,autoRetry:5e3,canRetryError:e=>{var t;if(e.code===W.NetWorkError.NO_NETWORK)return i.onDownloadBackupFailure(Io.g.SELF_DEFINE,Io.h.NO_NET),!1;if(211===e.error_code||-69===e.error_code)return i.onDownloadBackupFailure(Io.g.EXTERNAL,e.error_code),!1;const s=(null===(t=e.downloadError)||void 0===t?void 0:t.name)||e.name||"";if("string"==typeof s&&s.includes("ENOSPC"))return i.onDownloadBackupFailure(Io.g.SELF_DEFINE,Io.b.ENOSPC),!1;const a=e.code||e.error_code,n=a?Io.g.EXTERNAL:Io.g.SELF_DEFINE;return i.onDownloadBackupFailure(n,a||Io.b.UNKNOW_ERR),!0}}),onDone:[{cond:(e,t)=>t.data.success,actions:()=>{i.onDownloadBackupSuccess()},target:"decrypt_backup"},{cond:(e,t)=>{var s;return(null===(s=t.data.error)||void 0===s?void 0:s.code)===W.NetWorkError.NO_NETWORK},target:"#wait_for_network"},{actions:(e,t)=>{var a;i.onDownloadBackupFailure(Io.g.SELF_DEFINE,Io.b.DOWNLOAD_BACKUP_ERR);const n=(null===(a=t.data.error)||void 0===a?void 0:a.downloadError)||t.data.error,r=(null==n?void 0:n.name)||"Error";"string"==typeof r&&r.includes("ENOSPC")?s.showError(Io.c.LOW_STORAGE):s.showError(Io.c.DOWNLOAD_FAILED)},target:"failure"}],onError:{actions:()=>{s.showError(Io.c.DOWNLOAD_FAILED)},target:"failure"}}},decrypt_backup:{entry:()=>{e.zsymb(3,"Qolh2U",["decrypt_backup","DUi5fF"]),s.showDecryptingBackup()},invoke:{src:async()=>t.decrypt(),onDone:{actions:()=>{i.onDecryptBackupSuccess()},target:"#success"},onError:{actions:(t,a)=>{const n=a.data;e.zsymb(18,"GSGAIy",(()=>["decrypt_backup error",{error:n}])),i.onDecryptBackupFailure(n.error_code),s.showError(Io.c.DECRYPT_FAILED)},target:"failure"}}},failure:{entry:[()=>{e.zsymb(3,"xwAHYO",["failure","kvY0W6"]),Q.a.SyncMessageController.onSyncFailed()},"signalDone"],on:{RETRY_SYNC:{target:"prepare"},START_SYNC:{target:"prepare"},USER_CONFIRM:{actions:()=>{e.zsymb(0,"dCGhIg","user_confirm"),s.clearError(),s.hidePopup()},target:"wait_for_backup"},SUCCESS:{actions:()=>{e.zsymb(0,"o0MQek","received success event"),s.clearError(),s.hidePopup()},target:"download_backup"}}},hist:{history:"shallow",type:"history"}}},success:{id:"success",type:"final"},wait_for_network:{id:"wait_for_network",entry:()=>{e.zsymb(3,"0EhcvA",["wait_for_network","9Ol1ii"]),s.showWaitForNetwork(),i.onErrorPopupWaitingMobileConfirm(Io.c.NO_NETWORK),Q.a.SyncMessageController.onNetworkError()},on:{START_SYNC:{target:"running.prepare"},ONLINE:{target:"running.hist"},RETRY_SYNC:{target:"running.hist"}}}}})}var sc,ic=s("VBs7");function ac(e,t,s,i,a){return Object(Yo.a)({context:{canRetry:!1},initial:"running",states:{running:{entry:()=>{e.zsymb(3,"I7iK4E",["restoring","zFrDbZ"]),s.setProgress(0)},invoke:{id:"restore_backup",src:ec({action:async e=>t.restore(e),maxRetry:5,autoRetry:2e3,canRetryError:e=>"WorkerInterrupted"===e.name}),onDone:[{cond:(e,t)=>t.data.success,target:"cleanup"},{actions:e=>{s.showError(Io.c.SYNC_FAILED)},target:"failure"}],onError:{actions:e=>{s.showError(Io.c.SYNC_FAILED)},target:"failure"}}},cleanup:{entry:()=>{e.zsymb(3,"65LQe7",["cleanup","Qd33C4"])},invoke:{src:async()=>{t.clean()},onDone:"success",onError:"success"}},wait_for_network:{entry:()=>{e.zsymb(3,"7BNhso",["wait_for_network","9Ol1ii"]),s.showWaitForNetwork()},on:{START_SYNC:{actions:()=>{Q.a.SyncMessageController.restartSync()}},ONLINE:{target:"running"}}},failure:{entry:[()=>{Q.a.SyncMessageController.onSyncFailed()},"signalDone"],on:{START_SYNC:{actions:()=>{Q.a.SyncMessageController.restartSync()}},RETRY_SYNC:[{target:"running",cond:e=>e.canRetry},{actions:()=>{e.zsymb(3,"COVIsg",["restart sync","TF24bQ"]),Q.a.SyncMessageController.restartSync()}}]}},success:{entry:[async()=>{await Object(Co.c)(s),e.zsymb(3,"3DEmf8",["success","qbPFMA"]),s.showSuccessMessage(),Q.a.SyncMessageController.onSyncSuccess(),Q.a.SyncMessageController.setAutoCloseSuccessTimeout()},"signalDone"],on:{START_SYNC:{actions:()=>{Q.a.SyncMessageController.restartSync()}},AUTO_CLOSE:{target:"done",actions:()=>s.hideAllUI()}}},done:{type:"final"}}},{actions:{signalDone:()=>{i.emit({topic:ic.a.Done})}}})}function nc(e,t,s,i){return Object(Yo.a)({strict:!0,initial:"running",states:{running:{initial:"holding_temp_key",states:{holding_temp_key:{entry:()=>{Q.a.SyncMessageController.setNoMissingMessageEventsTimeout(),t.getEnableLogEventsArrivalTimeConfig()&&setTimeout((()=>{i.logMissingMessageEventsTimeSinceGetLoginInfo()}),t.getEventsArrivalTimeSubmitLogTimeout()),t.getSuccessBannerWhenDropTransferWhenLoginConfig()&&s.showWaitForBackup(),e.zsymb(0,"hxp8Zc","holding temp key")},always:[{cond:"shouldTransferGuard",target:"prepare"},{cond:"shouldTerminateGuard",target:"#terminate_transfer_when_login"}],on:{HAVE_MISSING_MESSAGE_EVENTS:{target:"prepare"},WAITING_FOR_NO_MISSING_MESSAGE_EVENTS_TIMEOUT:{actions:()=>i.waitingForNoMissingMessageEventsTimeout(),target:"prepare"},HAVE_NO_MISSING_MESSAGE_EVENT:{cond:"shouldTerminateConfigGuard",target:"#terminate_transfer_when_login"}}},prepare:{entry:()=>Q.a.SyncMessageController.startTransferAfterHoldingTempKey(),invoke:{src:async()=>t.prepareNewSync(),onDone:[{cond:(e,t)=>""!==e.tempKey,target:"request_backup"},{cond:(e,t)=>""===e.tempKey,actions:()=>s.showError(Io.c.PREPARE_NEW_SYNC_FAILED),target:"failure"}],onError:{actions:()=>{Si.default.increaseFailed(98102,0,0,0,Date.now()),s.showError(Io.c.PREPARE_NEW_SYNC_FAILED)},target:"failure"}}},request_backup:{entry:()=>{Q.a.SyncMessageController.setRequestBackupTimeout(!1),e.zsymb(3,"cFzIEy",["send_request","tbPHpH"]),s.clearError()},invoke:{id:"request_backup_api",src:(e,s)=>ec({action:async s=>t.request(s,void 0,e.tempKey),maxRetry:2,autoRetry:5e3,canRetryError:e=>e.code===W.NetWorkError.NO_NETWORK?(i.onReqBackupFailure(Io.g.SELF_DEFINE,Io.h.NO_NET),!1):211===e.error_code||-69===e.error_code?(i.onReqBackupFailure(Io.g.EXTERNAL,e.error_code),!1):(i.onReqBackupFailure(Io.g.EXTERNAL,e.error_code||-1),!0)}),onDone:[{cond:(e,t)=>t.data.success,actions:Object(Jo.b)((e=>({tempKey:""}))),target:"wait_for_user_confirm"},{cond:(e,t)=>{var s;return(null===(s=t.data.error)||void 0===s?void 0:s.code)===W.NetWorkError.NO_NETWORK},target:"#wait_for_network"},{actions:(e,t)=>{var a;211===(null===(a=t.data.error)||void 0===a?void 0:a.error_code)?(s.showError(Io.c.CLIENT_NOT_SUPPORT),i.onErrorPopupWaitingMobileConfirm(Io.c.CLIENT_NOT_SUPPORT)):s.showError(Io.c.REQUEST_BACKUP_FAILED)},target:"failure"}],onError:{actions:()=>{s.showError(Io.c.REQUEST_BACKUP_FAILED)},target:"failure"}},on:{SUCCESS:{target:"wait_for_user_confirm"},ERR_TIMEOUT:{actions:()=>s.showError(Io.c.BACKUP_TIMEOUT),target:"failure"},ERROR:{actions:()=>s.showError(Io.c.REQUEST_BACKUP_FAILED),target:"failure"},ERR_CLIENT_NOT_SUPPORT:{actions:()=>{s.showError(Io.c.CLIENT_NOT_SUPPORT),i.onErrorPopupWaitingMobileConfirm(Io.c.CLIENT_NOT_SUPPORT)},target:"failure"},ERR_BACKUP_FAIL:{actions:()=>s.showError(Io.c.BACKUP_FAILED),target:"failure"}}},wait_for_user_confirm:{entry:()=>{Q.a.SyncMessageController.setMobileTransferConfirmTimeout()},on:{USER_CONFIRM:{actions:()=>{e.zsymb(3,"iH1U97",["user_confirm (transfer after login)","vbxUJf"]),Q.a.SyncMessageController.clearMobileTransferConfirmTimeout()},target:"wait_for_backup"},MOBILE_CONFIRM_TIMEOUT:{actions:()=>{Co.a.isEnableSyncIdleMobileState()&&s.showMobileIdleInBackup()}},ERR_TIMEOUT:{actions:()=>{s.showError(Io.c.REQUEST_BACKUP_FAILED)},target:"failure"},ERR_INVALID_BACKUP:{actions:()=>{s.showError(Io.c.REQUEST_BACKUP_FAILED)},target:"failure"},ERR_BUSY_RESTORING:{actions:()=>{i.onReqBackupFailure(Io.g.SELF_DEFINE,Io.h.BUSY_RESTORING),s.showError(Io.c.BUSY_RESTORING),i.onErrorPopupWaitingMobileConfirm(Io.c.BUSY_RESTORING)},target:"failure"},ERR_BACKUP_FAIL:{actions:()=>{i.onReqBackupFailure(Io.g.SELF_DEFINE,Io.h.BACKUP_FAILED),s.showError(Io.c.REQUEST_BACKUP_FAILED)},target:"failure"}}},wait_for_backup:{entry:()=>{e.zsymb(3,"7_Ix4Z",["wait_for_backup","KhCYwv"]),Q.a.SyncMessageController.setRequestBackupTimeout(!0),s.showWaitForBackup()},on:{SUCCESS:{target:"download_backup"},ERR_TIMEOUT:{actions:()=>{i.onReqBackupFailure(Io.g.SELF_DEFINE,Io.h.BACKUP_TIMEOUT),s.showError(Io.c.BACKUP_TIMEOUT)},target:"failure"},ERR_BACKUP_FAIL:{actions:()=>{s.showError(Io.c.BACKUP_FAILED)},target:"failure"},INVALID_BACKUP_INFO:{actions:()=>{i.onReqBackupFailure(Io.g.SELF_DEFINE,Io.h.INVALID_BACKUP),s.showError(Io.c.INVALID_BACKUP_INFO)},target:"failure"},INVALID_BACKUP_ENCRYPT_FORMAT:{actions:()=>{i.onReqBackupFailure(Io.g.SELF_DEFINE,Io.h.INVALID_BACKUP),s.showError(Io.c.INVALID_BACKUP_ENCRYPT_FORMAT)},target:"failure"}}},download_backup:{entry:()=>{e.zsymb(3,"2w4cPA",["download_backup","5BoljT"]),Q.a.SyncMessageController.clearRequestBackupTimeout(),s.showDownloadingBackup()},invoke:{strict:!0,src:ec({action:async e=>t.download(e),maxRetry:2,autoRetry:5e3,canRetryError:e=>{var t;if(e.code===W.NetWorkError.NO_NETWORK)return i.onDownloadBackupFailure(Io.g.SELF_DEFINE,Io.h.NO_NET),!1;if(211===e.error_code||-69===e.error_code)return i.onDownloadBackupFailure(Io.g.EXTERNAL,e.error_code),!1;const s=(null===(t=e.downloadError)||void 0===t?void 0:t.name)||e.name||"";if("string"==typeof s&&s.includes("ENOSPC"))return i.onDownloadBackupFailure(Io.g.SELF_DEFINE,Io.b.ENOSPC),!1;const a=e.code||e.error_code,n=a?Io.g.EXTERNAL:Io.g.SELF_DEFINE;return i.onDownloadBackupFailure(n,a||Io.b.UNKNOW_ERR),!0}}),onDone:[{cond:(e,t)=>t.data.success,actions:()=>{i.onDownloadBackupSuccess()},target:"decrypt_backup"},{cond:(e,t)=>{var s;return(null===(s=t.data.error)||void 0===s?void 0:s.code)===W.NetWorkError.NO_NETWORK},target:"#wait_for_network"},{actions:(e,t)=>{var a;i.onDownloadBackupFailure(Io.g.SELF_DEFINE,Io.b.DOWNLOAD_BACKUP_ERR);const n=(null===(a=t.data.error)||void 0===a?void 0:a.downloadError)||t.data.error,r=(null==n?void 0:n.name)||"Error";"string"==typeof r&&r.includes("ENOSPC")?s.showError(Io.c.LOW_STORAGE):s.showError(Io.c.DOWNLOAD_FAILED)},target:"failure"}],onError:{actions:()=>{s.showError(Io.c.DOWNLOAD_FAILED)},target:"failure"}}},decrypt_backup:{entry:()=>{e.zsymb(3,"mOyYdk",["decrypt_backup","DUi5fF"]),s.showDecryptingBackup()},invoke:{src:async()=>t.decrypt(),onDone:{actions:()=>{i.onDecryptBackupSuccess()},target:"#success"},onError:{actions:(t,a)=>{const n=a.data;e.zsymb(18,"kDk3q2",(()=>["decrypt_backup error",{error:n}])),i.onDecryptBackupFailure(n.error_code),s.showError(Io.c.DECRYPT_FAILED)},target:"failure"}}},failure:{entry:[()=>{e.zsymb(3,"ucO5sg",["failure","kvY0W6"]),Q.a.SyncMessageController.onSyncFailed()},"signalDone",Object(Jo.b)((e=>({tempKey:""})))],on:{USER_CONFIRM:{actions:()=>{e.zsymb(3,"6tNRgp",["user_confirm (transfer after login)","vbxUJf"]),s.clearError(),s.hidePopup()},target:"wait_for_backup"},SUCCESS:{actions:()=>{e.zsymb(0,"M58N-I","received success event"),s.clearError(),s.hidePopup()},target:"download_backup"}}},hist:{history:"shallow",type:"history"}}},terminate_transfer_when_login:{id:"terminate_transfer_when_login",type:"final",entry:()=>Q.a.SyncMessageController.terminateTransferWhenLogin(),data:()=>({terminate_transfer_when_login:!0})},success:{id:"success",type:"final"},wait_for_network:{id:"wait_for_network",entry:[()=>{e.zsymb(3,"lZVGJ2",["wait_for_network","9Ol1ii"]),s.showWaitForNetwork(),i.onErrorPopupWaitingMobileConfirm(Io.c.NO_NETWORK)},Object(Jo.b)((e=>({tempKey:""})))],on:{START_AUTO_SYNC:{target:"running.prepare"},ONLINE:{target:"running.hist"}}}}},{guards:{shouldTransferGuard:()=>{if(!t.getEnabledDropTransferWhenLoginFlowConfig())return!0;const e=t.isAtLeastOneMissingMessageEventArrived(),s=t.shouldTransferWhenLogin();return e||s},shouldTerminateGuard:()=>{if(!t.getEnabledDropTransferWhenLoginFlowConfig())return!1;const s=t.isNoMissingMessageEventsArrived();return e.zsymb(0,"6drQ60",`shouldTerminate: ${s}`),s},shouldTerminateConfigGuard:()=>t.getEnabledDropTransferWhenLoginFlowConfig()}})}let rc=Object(i.injectable)()(sc=Object(i.singleton)()(sc=function(e,t){return Object(i.inject)(B.ZLoggerFactory)(e,void 0,0)}(sc=function(e,t){return Object(i.inject)(Do)(e,void 0,1)}(sc=function(e,t){return Object(i.inject)(Go)(e,void 0,2)}(sc=function(e,t){return Object(i.inject)(Zo.b)(e,void 0,3)}(sc=function(e,t){return Object(i.inject)(Qo)(e,void 0,4)}(sc=function(e,t){return Object(i.inject)(ko.b)(e,void 0,5)}(sc=Reflect.metadata("design:type",Function)(sc=Reflect.metadata("design:paramtypes",[void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory,void 0===Do?Object:Do,void 0===Go?Object:Go,void 0===Zo.b?Object:Zo.b,void 0===Qo?Object:Qo,void 0===ko.b?Object:ko.b])(sc=class extends No{constructor(e,t,s,i,a,n){super(),this.loggerFactory=e,this.service=t,this.storage=s,this.ui=i,this.metrics=a,this.zmq=n}createMachine(){return e=this.loggerFactory.createZLogger("msg-sync",["state"]),t=this.metrics,s=this.service,i=this.storage,a=this.ui,n=this.zmq,Object(Yo.a)({strict:!0,id:"message-sync",context:{},initial:"idle",states:{idle:{entry:()=>e.zsymb(3,"-MHzkq",["idle","xuudyx"]),on:{SUGGEST_NEW_SYNC:"suggest_new_sync",SUGGEST_RESUME:"suggest_resume",START_AUTO_SYNC:"run.auto_backup",START_SYNC:{actions:()=>{t.clickConfirmSync()},target:"run"}}},suggest_new_sync:{entry:(s,n)=>{e.zsymb(0,"U3Te-v",(()=>["suggest_new_sync",{src:Object(Io.t)(n.src)}])),i.syncSource.save(n.src),t.onShowSyncSuggestion(),a.showSuggestNewSync(n.shouldShowSyncGuide)},on:{START_SYNC:{actions:()=>{t.clickConfirmSync()},target:"run"},START_AUTO_SYNC:"run.auto_backup",CLOSE_SUGGEST:{actions:()=>a.hideAllUI(),target:"idle"}}},suggest_resume:{entry:()=>{e.zsymb(3,"FrdGO6",["suggest_resume","0sAxfh"]),a.showSuggestResume()},on:{START_SYNC:"run",START_AUTO_SYNC:"run.auto_backup",RESUME_SYNC:"#restore_backup",CLOSE_SUGGEST:{actions:()=>a.hideAllUI(),target:"idle"}}},run:{initial:"request_backup",states:{request_backup:{entry:()=>e.zsymb(3,"L8qQaf",["request_backup","l9CfVX"]),invoke:{id:"request_backup",src:tc(e,s,a,t),onDone:"restore_backup"},on:{SUCCESS:{actions:Object(Jo.i)("request_backup")},USER_REJECT:{actions:Object(Jo.i)("request_backup")},USER_CONFIRM:{actions:Object(Jo.i)("request_backup")},RETRY_SYNC:{actions:Object(Jo.i)("request_backup")},ERR_INVALID_BACKUP:{actions:Object(Jo.i)("request_backup")},ERR_BACKUP_FAIL:{actions:Object(Jo.i)("request_backup")},ERR_BUSY_RESTORING:{actions:Object(Jo.i)("request_backup")},ERR_TIMEOUT:{actions:Object(Jo.i)("request_backup")},START_SYNC:{actions:[Object(Jo.i)("request_backup"),()=>{t.clickConfirmSync()}]}}},auto_backup:{entry:()=>{e.zsymb(3,"Q6OWYa",["auto_backup","JI0IYr"]),t.onStartTransferAfterLogin(),i.syncSource.save(Io.j.TRANSFER_WHEN_LOGIN)},invoke:{id:"auto_backup",src:nc(e,s,a,t),data:(e,t)=>({tempKey:t.tempKey}),onDone:[{cond:(e,t)=>{var s;return null===(s=t.data)||void 0===s?void 0:s.terminate_transfer_when_login},target:"terminate_transfer_when_login"},{cond:(e,t)=>{var s;return!(null!==(s=t.data)&&void 0!==s&&s.terminate_transfer_when_login)},target:"restore_backup"}]},on:{SUCCESS:{actions:Object(Jo.i)("auto_backup")},RETRY_SYNC:{target:"#message-sync.run",actions:()=>{const e=Io.j.MANUAL;i.syncSource.save(e),t.setLastSyncSource(e)}},USER_CONFIRM:{actions:Object(Jo.i)("auto_backup")},ERR_INVALID_BACKUP:{actions:Object(Jo.i)("auto_backup")},ERR_BACKUP_FAIL:{actions:Object(Jo.i)("auto_backup")},ERR_BUSY_RESTORING:{actions:Object(Jo.i)("auto_backup")},MOBILE_CONFIRM_TIMEOUT:{actions:Object(Jo.i)("auto_backup")},ERR_TIMEOUT:{actions:Object(Jo.i)("auto_backup")},START_AUTO_SYNC:{actions:Object(Jo.i)("auto_backup")},TERMINATE_TRANSFER_WHEN_LOGIN:{actions:Object(Jo.i)("auto_backup")},WAITING_FOR_NO_MISSING_MESSAGE_EVENTS_TIMEOUT:{actions:Object(Jo.i)("auto_backup")},HAVE_MISSING_MESSAGE_EVENTS:{actions:Object(Jo.i)("auto_backup")},HAVE_NO_MISSING_MESSAGE_EVENT:{actions:Object(Jo.i)("run.auto_backup")}}},restore_backup:{id:"restore_backup",entry:()=>{a.showInProgress(),a.setProgress(0)},invoke:{id:"restore_backup_machine",src:ac(e,s,a,n),onDone:"done"},on:{RESTART_SYNC:{actions:()=>{t.clickConfirmSync()},target:"request_backup"},START_SYNC:{actions:Object(Jo.i)("restore_backup_machine")},RETRY_SYNC:{actions:Object(Jo.i)("restore_backup_machine")},AUTO_CLOSE:{actions:Object(Jo.i)("restore_backup_machine")}}},terminate_transfer_when_login:{entry:[async()=>{e.zsymb(2,"IVLPky","Successfully terminate transfer when login"),Q.a.SyncMessageController.onTerminateTransferWhenLoginSuccess(),s.getSuccessBannerWhenDropTransferWhenLoginConfig()&&(a.showSuccessMessage(),Q.a.SyncMessageController.setAutoCloseSuccessTimeout())}],always:[{cond:"shouldFinishTerminateFlow",target:"done"}],on:{AUTO_CLOSE:{target:"done",actions:()=>a.hideAllUI()}}},done:{type:"final"}},onDone:"idle"}},on:{CANCEL:{target:"idle",actions:()=>{a.hideAllUI(),Q.a.SyncMessageController.onSyncCanceled()}},RESET:{target:"idle",actions:()=>a.hideAllUI()}}},{guards:{shouldFinishTerminateFlow:()=>!s.getSuccessBannerWhenDropTransferWhenLoginConfig()}});var e,t,s,i,a,n}canSuggestNewSync(){var e;const t=null===(e=this.interpreter)||void 0===e?void 0:e.state;if(!t)return!1;if(t.matches("idle"))return!0;let s;return t.children.request_backup&&(s=t.children.request_backup.getSnapshot()),t.children.auto_backup&&(s=t.children.auto_backup.getSnapshot()),t.children.restore_backup_machine&&(s=t.children.restore_backup_machine.getSnapshot()),!s||(s.matches("success")||s.matches("failure")||s.matches("running.failure"))}canStartNewSync(){var e;const t=null===(e=this.interpreter)||void 0===e?void 0:e.state;return!!t&&(!!(t.matches("idle")||t.matches("suggest_new_sync")||t.matches("suggest_resume"))||this.canSuggestNewSync())}isMachineIdle(){var e;const t=null===(e=this.interpreter)||void 0===e?void 0:e.state;return!t||t.matches("idle")}})||sc)||sc)||sc)||sc)||sc)||sc)||sc)||sc)||sc)||sc;var oc,cc=s("fg6f"),lc=s("RxLg"),dc=s("HaJU"),hc=s("svq+"),uc=s("rrDN"),gc=s("lANr");Object(m.j)()(oc=Object(m.f)()(oc=Object(m.h)()(oc=Object(i.singleton)(Fo.a)(oc=Object(i.injectable)()(oc=function(e,t){return Object(i.inject)(dr.a)(e,void 0,0)}(oc=function(e,t){return Object(i.inject)(B.ZLoggerFactory)(e,void 0,1)}(oc=function(e,t){return Object(i.inject)(jo.a)(e,void 0,2)}(oc=function(e,t){return Object(i.inject)(Do)(e,void 0,3)}(oc=function(e,t){return Object(i.inject)(Zo.b)(e,void 0,4)}(oc=function(e,t){return Object(i.inject)(Go)(e,void 0,5)}(oc=function(e,t){return Object(i.inject)(Lo)(e,void 0,6)}(oc=function(e,t){return Object(i.inject)(Qo)(e,void 0,7)}(oc=function(e,t){return Object(i.inject)(Po.b)(e,void 0,8)}(oc=function(e,t){return Object(i.inject)(F.b)(e,void 0,9)}(oc=function(e,t){return Object(i.inject)(Ko.a)(e,void 0,10)}(oc=Reflect.metadata("design:type",Function)(oc=Reflect.metadata("design:paramtypes",[void 0===dr.a?Object:dr.a,void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory,void 0===jo.a?Object:jo.a,void 0===Do?Object:Do,void 0===Zo.b?Object:Zo.b,void 0===Go?Object:Go,void 0===Lo?Object:Lo,void 0===Qo?Object:Qo,void 0===Po.b?Object:Po.b,void 0===F.ISystemTime?Object:F.ISystemTime,Object])(oc=class extends De.b{constructor(e,t,s,a,n,r,o,c,l,d,h){super(),this.initialized=!1,this.currentUserId="",this.currentUserUIN="",this.isSyncRunning=!1,this.requestedSuggestSync=null,this.requestBackupTimeout=null,this.mobileTransferConfirmTimeout=null,this.waitingForMissingMessageEventsTimeout=null,this.autoCloseSuccessTimeout=null,this.logger=void 0,this.config=void 0,this.setting=void 0,this.service=void 0,this.storage=void 0,this.machine=void 0,this.systemTime=void 0,this.ui=void 0,this.helper=void 0,this.entriesTransferManager=void 0,this.messageReadinessChecker=void 0,this.metricts=void 0,this.suggestSync=async(e,t=!0,s=!1)=>{this.initialized?(this.machine.send({type:"SUGGEST_NEW_SYNC",src:e,shouldShowSyncGuide:t}),s||this.metricts.onShowSyncSuggestionWithoutResume()):this.logger.zsymb(18,"TADfsF","suggest sync but not ready")},this.suggestResume=async()=>{this.initialized?this.machine.send("SUGGEST_RESUME"):this.logger.zsymb(18,"90PUkJ","suggest resume but not ready")},this.sync=async e=>{this.isSyncRunning=!0,"number"==typeof e?this.storage.syncSource.save(e):e=this.storage.syncSource.get()||Io.j.MANUAL,this.metricts.setLastSyncSource(e),this.metricts.resetSyncStartTime(),this.logger.zsymb(0,"WoJct3","start new sync"),e===Io.j.FIRST_TIME_LOGIN&&(this.setting.setMaxSeq(0),this.setting.setMinSeq(0)),this.machine.send("START_SYNC"),this.setting.value().showSharedWorkerWhenSync&&this.showSharedWorker(),this.dispatchEvent(new Uo.d)},this.resume=async()=>{this.isSyncRunning=!0,this.logger.zsymb(0,"WJ6MbJ","resume last sync");const e=this.storage.backup.get();this.storage.syncSource.save(Io.j.RESUME),this.metricts.setLastSyncSource(Io.j.RESUME),this.metricts.resetSyncStartTime();const t=e&&this.storage.syncState.isSyncing,s=this.entriesTransferManager.getSyncSource();if(t&&!s){const t=await this.service.getBackupFolderPath(e);t!==e.outputPath&&(e.outputPath=t,this.storage.backup.save(e),this.logger.zsymb(0,"TsYqO5","backup output changed over the last session")),this.machine.send("RESUME_SYNC")}else this.machine.send("START_SYNC");this.setting.value().showSharedWorkerWhenSync&&this.showSharedWorker(),this.dispatchEvent(new Uo.b)},this.startTransferAfterHoldingTempKey=()=>{this.isSyncRunning=!0,this.dispatchEvent(new Uo.d),this.clearNoMissingMessageEventsTimeout(),this.metricts.resetSyncStartTime(),this.logger.zsymb(0,"EwBF9O","start transfer after holding temp key")},this.cancel=async e=>{if(this.metricts.onCloseBanner(),this.metricts.clickCancelSync(),this.setting.value().dontConfirmCancel)return this.metricts.onUserTerminateTransferAfterLogin(),this.logger.zsymb(0,"9EVYpM","cancel sync"),this.machine.send("CANCEL"),this.service.cancelTransferMobile(),void(await this.service.clean());let t,s,i;this.logger.zsymb(0,"qXzbFA","prompt cancel sync"),e?(t="STR_CONFIRM_SKIP_SYNC_DB_MSG_TITLE",s="STR_CONFIRM_SKIP_SYNC_DB_MSG_TEXT",i="STR_CONFIRM_SKIP_SYNC_DB_MSG_CONFIRM"):(t="STR_SETTING_MSG_SYNC_POPUP_HEADER",s="STR_SETTING_MSG_SYNC_POPUP_BODY",i="STR_SETTING_MSG_SYNC_POPUP_OK");const[a,n]=await this.helper.showUserConfirm({header:t,message:s,confirm:i,cancel:"STR_SETTING_MSG_SYNC_POPUP_CANCEL",remember:"STR_SETTING_MSG_SYNC_POPUP_DONTASK",primaryButtonType:"secondary-danger"});a?(this.metricts.clickConfirmCancelSyncConfirmModal(),this.logger.zsymb(0,"NOb5qa",(()=>["user confirm cancel sync",{dontAskAgain:n}])),n&&this.setting.setDontConfirmCancel(n),this.machine.send("CANCEL"),this.service.cancelTransferMobile(),await this.service.clean()):this.metricts.clickCancelInCancelSyncConfirmModal()},this.confirmCancelSyncInSuggestingPopup=async()=>{this.metricts.clickCloseSynGuidePopup();await this.helper.showUserConfirmV2({header:"STR_CONFIRM_SYNC_DB_CONFRIM_STOP_TITLE",message:"STR_CONFIRM_SYNC_DB_CONFRIM_STOP_DES",confirm:"STR_CONFIRM_SYNC_DB_CONFRIM_STOP_BTN_OKE",cancel:"STR_CONFIRM_SYNC_DB_CONFRIM_STOP_BTN_CANCEL",primaryButtonType:"secondary-danger",width:410})&&(this.metricts.clickConfirmCancelSyncConfirmModalFromCounterModal(),this.machine.send("CANCEL"),this.service.cancelTransferMobile(),await this.service.clean())},this.cleanupInMobileBusyBackup=async()=>{this.machine.send("CANCEL"),await this.service.clean()},this.closeCancelSyncInSuggestingPopup=async()=>{this.helper.closeUserCOnfrimV2()},this.reset=()=>{this.machine.send("RESET"),this.metricts.onCloseBanner(),this.ui.clearError(),this.clearAutoCloseSuccessTimeout(),this.clearRequestBackupTimeout(),this.service.clean()},this.pause=async()=>{throw new Error("Method not implemented.")},this.retry=async()=>{this.metricts.clickRetrySync(),this.logger.zsymb(0,"gRutNj","retry sync"),this.machine.send("RETRY_SYNC"),this.dispatchEvent(new Uo.c)},this.showSuggestPopup=()=>{this.ui.showPopup()},this.closeSuggestPopup=()=>{this.metricts.onClosePopup(),this.ui.hidePopup()},this.rejectSuggest=async()=>{this.metricts.onCloseBanner(),this.logger.zsymb(0,"yB6iuC","prompt user reject suggest sync");const[e,t]=await this.helper.showUserConfirm({header:"STR_SETTING_MSG_SYNC_POPUP_HEADER_START",message:"STR_SETTING_MSG_SYNC_POPUP_BODY_START",confirm:"STR_SETTING_MSG_SYNC_POPUP_OK_START",cancel:"STR_SETTING_MSG_SYNC_POPUP_CANCEL_START",remember:"STR_SETTING_MSG_SYNC_POPUP_DONTSHOW",primaryButtonType:"primary"});e?(this.logger.zsymb(0,"tjmvVu","user confirm reject suggest sync"),t&&(this.logger.zsymb(0,"vLwBtr","user check dont suggest again"),this.setting.setDontSuggest(!0)),this.metricts.clickContinueInRejectSuggestionConfirmModal(),this.machine.send("CLOSE_SUGGEST"),this.storage.syncSource.clear(),this.setting.setLastCloseSuggest(this.systemTime.getTimeNow())):(this.metricts.clickCacnelInCloseSyncSuggestionConfirmModal(),this.ui.hidePopup(),this.logger.zsymb(0,"uA5cTg","user cancel"))},this.hideProgress=async()=>{this.setting.value().hideProgress||this.setting.toggleHideProgress(),this.helper.showUserConfirm({width:353,header:"STR_SETTING_MSG_SYNC_NOTICE_HEADER",confirm:"STR_SETTING_MSG_SYNC_NOTICE_OK",primaryButtonType:"neutral",message:ut.a.createElement("span",null,ut.a.createElement(mt.a,{textKey:"STR_HIDE_DB_TOAST",tagName:"div"}),ut.a.createElement("i",{className:"fa fa-tab-setting internal-icon"}),ut.a.createElement(mt.a,{textKey:"STR_SETTING_MSG_SYNC_NOTICE_BODY_BOLD",style:{fontWeight:500}}))})},this.setRequestBackupTimeout=e=>{this.ui.resetStartSyncTime(),this.clearRequestBackupTimeout(),this.requestBackupTimeout=setTimeout((()=>{this.logger.zsymb(0,"j0wnFJ","request backup timeout"),this.machine.send("ERR_TIMEOUT")}),this.service.getRequestBackupTimeout(e))},this.setMobileTransferConfirmTimeout=()=>{this.ui.resetStartSyncTime(),this.clearMobileTransferConfirmTimeout();const e=this.service.getMobileTransferConfirmTimeout();e>0?this.mobileTransferConfirmTimeout=setTimeout((()=>{this.logger.zsymb(0,"1TYyGZ","mobile auto confirm timeout"),this.machine.send("MOBILE_CONFIRM_TIMEOUT")}),e):this.machine.send("MOBILE_CONFIRM_TIMEOUT")},this.setNoMissingMessageEventsTimeout=()=>{this.clearNoMissingMessageEventsTimeout();const e=this.service.getNoMissingMessageEventsTimeout();e>0?this.waitingForMissingMessageEventsTimeout=setTimeout((()=>{this.logger.zsymb(0,"22e4f1","waiting for no missing events timeout"),this.machine.send("WAITING_FOR_NO_MISSING_MESSAGE_EVENTS_TIMEOUT")}),e):this.machine.send("WAITING_FOR_NO_MISSING_MESSAGE_EVENTS_TIMEOUT")},this.clearRequestBackupTimeout=()=>{this.requestBackupTimeout&&(clearTimeout(this.requestBackupTimeout),this.requestBackupTimeout=null)},this.clearMobileTransferConfirmTimeout=()=>{this.mobileTransferConfirmTimeout&&(clearTimeout(this.mobileTransferConfirmTimeout),this.mobileTransferConfirmTimeout=null)},this.clearNoMissingMessageEventsTimeout=()=>{this.waitingForMissingMessageEventsTimeout&&(clearTimeout(this.waitingForMissingMessageEventsTimeout),this.waitingForMissingMessageEventsTimeout=null)},this.setAutoCloseSuccessTimeout=()=>{this.autoCloseSuccessTimeout=setTimeout((()=>{this.logger.zsymb(0,"ZyN_3-","auto close success timeout"),this.machine.send("AUTO_CLOSE")}),this.service.getCloseSuccessTimeout())},this.clearAutoCloseSuccessTimeout=()=>{this.autoCloseSuccessTimeout&&(clearTimeout(this.autoCloseSuccessTimeout),this.autoCloseSuccessTimeout=null)},this.resendRequest=async()=>this.service.request(0,1),this.handleCtrlEvents=e=>{const t=this.service.session;if(!t)return this.logger.zsymb(18,"OcGpqv","received control event but no session"),void this.metricts.onReqBackupFailure(Io.g.SELF_DEFINE,Io.h.NO_SESSION);for(const a of e){if(Uo.a.isUserConfirm(t,a))return void this.machine.send({type:"USER_CONFIRM"});if(Uo.a.isUserReject(t,a))return void this.machine.send({type:"USER_REJECT"});if(Co.a.isEnableSyncIdleMobileState()&&Uo.a.isMobileIdle(t,a))return this.metricts.onMobileIdle(),void this.ui.showMobileIdleInBackup();if(Co.a.isEnableSyncIdleMobileState()&&Uo.a.isMobileActive(t,a))return void this.ui.showWaitForBackup();if(Uo.a.isBackupSuccess(t,a)){var s;let e;try{e=JSON.parse(a.data.db_info)}catch(i){return this.logger.zsymb(18,"NGyNzJ",(()=>["parse db info fail",{error:i.message}])),this.metricts.onReqBackupFailure(Io.g.SELF_DEFINE,Io.h.CANT_PASE_DB_INFO),void this.machine.send("ERR_INVALID_BACKUP")}let t=0,n=0;try{e.backup_db&&(t=e.backup_db.msg_thread,n=e.backup_db.msg_total),e.origin_db&&(t=e.origin_db.msg_thread,n=e.origin_db.msg_total)}catch(i){return this.logger.zsymb(18,"AI1KAQ",(()=>["parse db info fail",{error:i.message}])),this.metricts.onReqBackupFailure(Io.g.SELF_DEFINE,Io.h.CANT_PASE_DB_INFO),void this.machine.send("ERR_INVALID_BACKUP")}const r=null!==(s=e.db_format)&&void 0!==s?s:0;this.metricts.onReqBackupSuccess(r);const o=this.storage.syncSource.get();this.metricts.setLastSyncSource(o),this.storage.backup.save({rawUid:a.data.uid,userId:this.currentUserId,uin:this.currentUserUIN,fromSeqId:a.data.from_seq_id,isFull:!!a.data.is_full_transfer,name:a.data.file_name,url:a.data.url,checksum:a.data.checksum_code||a.data.checksum||"",publicKey:a.data.public_key,encryptedKey:a.data.encrypted_key,privateKey:"",format:r,inputPath:"",outputPath:"",numberOfConversationsCount:t,numberOfMessagesCount:n,conversations:[]});const c=this.setting.value();return this.storage.syncState.resetCheckpoint(r,c.minSeq,c.maxSeq),this.logger.zsymb(0,"ELWuwB",(()=>["received backup",{format:r,msgCount:n,threadCount:t}])),void this.machine.send("SUCCESS")}if(Uo.a.isBackupFail(t,a))return void this.machine.send("ERR_BACKUP_FAIL");if(Uo.a.isMobileRestoring(t,a))return void this.machine.send("ERR_BUSY_RESTORING");Si.default.increaseFailed(Io.f.REQ_BACKUP,0,0,Io.h.UNKNOWN_EVENT,Date.now()),this.logger.zsymb(18,"UvuUmE",(()=>["unknown control event",{event:a}]))}},this.handleTransferAfterLoginCtrlEvents=e=>{if(!this.shouldProcessTransferAfterLogin())return;const t=this.validateTransferWhenLoginEvents(e);t&&this.processTransferWhenLogin(t)},this.shouldProcessTransferAfterLogin=()=>{const e=!i.ModuleContainer.resolve(La.b).didBlockApp;return this.logger.zsymb(0,"eZX1BK",`should process transfer after login: ${e}`),e},this.validateTransferWhenLoginEvents=e=>{try{const t=e.filter((e=>Uo.a.isTransferAfterLoginControlEvent(e)));if(0===t.length)return null;t.sort(((e,t)=>e.ts-t.ts)),this.logger.zsymb(0,"taJZbE",(()=>["sorted and filtered transfer events",t]));const s=t[t.length-1];if(this.systemTime.getTimeNow()-s.ts<=Io.k)return s;this.logger.zsymb(0,"KwGp4D","No valid temp key in this control batch")}catch(t){this.logger.zsymb(0,"Wl5yh3","failed to validate transfer when login events",t)}return null},this.processTransferWhenLogin=e=>{this.logger.zsymb(0,"o64pKr","tempKey for transfer when login arrived",e),this.logTempKeyArrivalTimestamp(),cc.j.GetManager().setIsTransferAfterLogin(!0),cc.j.GetManager().hideTransferMessagesModal();let t=e.data.temp_key;switch(this.storage.tempKeySource.get()){case Io.m.ARBITRARY:t="arbitrary temp key";break;case Io.m.EMPTY:t=""}this.machine.send({type:"START_AUTO_SYNC",tempKey:t})},this.registerEventListenerForTransferWhenLogin=()=>{this.messageReadinessChecker.addEventListener(gc.c.NO_MISSING_MESSAGE_EVENTS_ARRIVED,this.handleNoMissingMessageEvents),N.default.subscribe(this.handleOverFlowQueue)},this.handleNoMissingMessageEvents=()=>{this.logger.zsymb(0,"-Z7pQ4","No missing message events, send event HAVE_NO_MISSING_MESSAGE_EVENT"),this.machine.send("HAVE_NO_MISSING_MESSAGE_EVENT"),this.messageReadinessChecker.removeEventListener(gc.c.NO_MISSING_MESSAGE_EVENTS_ARRIVED,this.handleNoMissingMessageEvents)},this.handleOverFlowQueue=(e,t)=>{if(e===P.FetchActions.CHECK_OVERFLOW_QUEUE_BY_FLAG){if(!t.queueId)return;this.machine.send("HAVE_MISSING_MESSAGE_EVENTS"),N.default.unsubscribe(this.handleOverFlowQueue)}},this.logTempKeyArrivalTimestamp=()=>{try{var e;this.storage.tempKeySource.setArrivalTimestamp(null!==(e=D.default.getSystemTimeNow())&&void 0!==e?e:0)}catch(t){}},this.machine=i.ModuleContainer.resolveToken(rc),this.logger=t.createZLogger(Ss.ZLoggerNametags.msgSync,[Ss.ZLoggerNametags.controller,"daivd"]),this.config=e,this.service=a,this.setting=s,this.storage=r,this.ui=n,this.helper=o,this.metricts=c,this.systemTime=d,this.entriesTransferManager=l,this.messageReadinessChecker=h}isEnable(){const e=this.config.get("cross_setting.offFeature"),t=this.config.get("cross_setting.enable");return!e&&t}isEnableBySrc(e){if(this.metricts.onCheckSyncSuggestion(e),!this.isEnable())return!1;switch(e){case Io.j.FIRST_TIME_LOGIN:return this.config.get("cross_setting.enableFirstTimeUse");case Io.j.MANUAL:return this.config.get("cross_setting.enableManual");case Io.j.OVERFLOW:return this.config.get("cross_setting.enableOverQueue");case Io.j.E2EE_MISSING_MESSAGE:return this.config.get("notify_missing_e2ee_message.enable")}return!0}isEnableResume(){return!!this.isEnable()&&this.config.get("cross_setting.enableResume")}canSync(e){return this.isEnableBySrc(e)?this.machine.canStartNewSync()?Io.a.OK:Io.a.INVALID_STATE:Io.a.DISABLED}isThisSessionSyncing(){return this.isSyncRunning}onStart(){if(this.isEnable()){this.logger.zsymb(0,"_UDyUX","initialize");try{this.machine.create(),this.machine.start()}catch(e){return void this.logger.zsymb(18,"PHrqiF",(()=>["start error",{error:e}]))}this.initialized=!0,""!==this.currentUserId&&this.checkSuggestWhenReady(),this.registerEventListenerForTransferWhenLogin(),i.ModuleContainer.resolve(uc.AFMC_TModule).get(uc.AFMC_TController).addEventListener(hc.a.SHOW_SYNC_MESSAGE_SUGGESTION,(e=>{const t=e.queueId;if(!t)return;if(this.setting.value().dontSuggest)return void this.logger.zsymb(3,"THfG4Z",["queue is full, but user has already disable sync suggestion","KREyyl"]);if(!this.isEnableBySrc(Io.j.OVERFLOW))return void this.logger.zsymb(0,"_wb1HT","sync when overflow is not enable");const s=this.config.get("cross_setting.timeBetweenSync")||0,i=this.setting.value().lastSync;if(s>0&&i>0){const e=i+60*s*1e3;if(e>Date.now())return void this.logger.zsymb(0,"UBu3ou",`queue is full, but user has already sync in time. next sync: ${new Date(e).toLocaleString()}`)}const a=this.config.get("msg_sync.overflow_queue");if(a){if(a.some((e=>t==e)))return void this.delayedSuggestSync(Io.j.OVERFLOW,!1)}else this.logger.zsymb(0,"UsUKGE","queue evict is not set")})),this.entriesTransferManager.addEventListener(lc.a.NotifyE2eeConvChangeDevice,(e=>{if(e.type===lc.a.NotifyE2eeConvChangeDevice){if(this.machine.send({type:"HAVE_MISSING_MESSAGE_EVENTS"}),this.setting.value().dontSuggest)return void this.logger.zsymb(3,"Umns4g",["Change device and has e2ee convs, but user has already disable sync suggestion","Fp89Gb"]);if(!this.isEnableBySrc(Io.j.E2EE_MISSING_MESSAGE))return void this.logger.zsymb(0,"PXXeTO","Sync when change device and has e2ee convs is not enable");const e=this.config.get("cross_setting.timeBetweenSync")||0,t=this.setting.value().lastSync;if(e>0&&t>0){const s=t+60*e*1e3;if(s>Date.now())return void this.logger.zsymb(0,"keou00",`Change device and has e2ee convs, but user has already sync in time. next sync: ${new Date(s).toLocaleString()}`)}this.entriesTransferManager.getSyncSource()===Io.j.E2EE_MISSING_MESSAGE&&(this.logger.zsymb(0,"m_FVQO","Suggest sync by [NotifyE2eeConvChangeDevice] event"),this.delayedSuggestSync(Io.j.E2EE_MISSING_MESSAGE,!1))}}))}else this.logger.zsymb(0,"HsI6sD","feature is not enable")}onAuthenticated(e){this.storage.load(e.getSession().userId),this.setting.load(e.getSession().userId),this.currentUserId=e.getSession().userId,this.currentUserUIN=e.getSession().UIN||"",setTimeout((()=>{if(!this.isThisSessionSyncing()){vi.a.getInstance().resumeIdx()}}),5e3),this.initialized&&setTimeout(this.checkSuggestWhenReady.bind(this),1e3)}onDispose(){this.service.abortRestore(),this.machine.status===Ao.b.Running&&this.machine.stop()}delayedSuggestSync(e,t=!0,s=!1){setTimeout((()=>this.suggestSync(e,t,s)),dc.a.transfer_when_login.time_wait_for_temp_key)}delayedSuggestResume(e){setTimeout((()=>this.suggestResume()),e)}terminateTransferWhenLogin(){this.service.clean(),this.clearNoMissingMessageEventsTimeout(),this.logger.zsymb(0,"K664tN","cleaning for terminate transfer when login")}prepareSearchAfterSync(){const e=vi.a.getInstance();e.resumeIdx(),setTimeout((()=>{e.isEnableSearchSqlite&&i.ModuleContainer.resolve(Ci.b).loadOldestTime()}),500)}onTerminateTransferWhenLoginSuccess(){this.isSyncRunning=!1,this.metricts.terminateTransferWhenLogin()}onSyncSuccess(){this.isSyncRunning=!1,this.prepareSearchAfterSync(),this.dispatchEvent(new Uo.g)}onSyncFailed(){const e=this.ui.getCurrentError();e&&this.metricts.onSyncFailed(e),this.isSyncRunning=!1,this.prepareSearchAfterSync(),this.dispatchEvent(new Uo.f)}onSyncCanceled(){this.isSyncRunning=!1,this.dispatchEvent(new Uo.f),this.prepareSearchAfterSync()}onNetworkError(){this.dispatchEvent(new Uo.f)}async restartSync(){this.metricts.resetSyncStartTime(),this.machine.send("RESTART_SYNC")}get tempKeySource(){return this.storage.tempKeySource.get()}set tempKeySource(e){this.storage.tempKeySource.save(e)}makeMobileActive(){this.ui.showWaitForBackup()}makeMobileIdle(){this.ui.showMobileIdleInBackup()}currentSyncSource(){return this.storage.syncSource.get()}getCurrentSyncScreenState(){return this.ui.getCurrentScreen()}async checkSuggestWhenReady(){this.logger.zsymb(0,"D03GkB","checking for sync suggestion"),this.setting.value().dontSuggest?this.logger.zsymb(0,"nOholf","user don't want to suggest sync"):await this.checkForSuggestFirstLogin().catch((e=>(this.logger.zsymb(18,"wCvxfo",(()=>["checkForSuggestFirstLogin failed",e])),!1)))||await this.checkLastStateForSuggestResumeOrNewSync().catch((e=>(this.logger.zsymb(18,"FlnXeR",(()=>["checkLastStateForSuggestResumeOrNewSync failed",e])),!1)))||await this.checkPendingRequestSync().catch((e=>(this.logger.zsymb(18,"nbgejF",(()=>["checkPendingRequestSync failed",e])),!1)))||await this.checkStateForSuggestSyncFromOtherEntries().catch((e=>(this.logger.zsymb(18,"HnfVx9",(()=>["checkStateForSuggestSyncFromOtherEntries failed",e])),!1)))||this.logger.zsymb(3,"r3W2Wa",["no sync suggestion","6ia-Qg"])}async checkForSuggestFirstLogin(){const e=n.default.getInstance();let t=e.getItem("z_needSyncMsg");if(t&&JSON.parse(t)){if(e.removeItem("z_needSyncMsg"),this.isEnableBySrc(Io.j.FIRST_TIME_LOGIN)&&!cc.j.GetManager().isEnabledFeature())return this.delayedSuggestSync(Io.j.FIRST_TIME_LOGIN),!0;this.logger.zsymb(0,"N7SWEO","first login sync is disabled")}return!1}showSharedWorker(){$zsharedWorker.show()}async checkPendingRequestSync(){if(!this.initialized)return this.logger.zsymb(18,"X5caWe","check pending request sync but not ready"),!1;if(this.requestedSuggestSync){const e=this.requestedSuggestSync;if(this.requestedSuggestSync=null,this.isEnableBySrc(e))return this.delayedSuggestSync(e),!0;this.logger.zsymb(0,"MDb7dq",`${e} sync is disabled`)}return!1}async checkLastStateForSuggestResumeOrNewSync(){if(this.storage.syncState.isStarted)return this.isEnableResume()?this.delayedSuggestResume(dc.a.transfer_when_login.time_wait_for_temp_key):(this.logger.zsymb(0,"mZRGpk","resume sync is disabled"),this.storage.clear()),!0;const e=this.storage.syncSource.get();return"number"==typeof e&&(this.requestedSuggestSync=null,this.isEnableBySrc(e)?this.delayedSuggestSync(e,!1,!0):(this.logger.zsymb(0,"LE6Tkp",`${e} sync is disabled`),this.storage.clear()),!0)}async checkStateForSuggestSyncFromOtherEntries(){if(this.storage.syncState.isStarted)return this.isEnableResume()?this.delayedSuggestResume(dc.a.transfer_when_login.time_wait_for_temp_key):(this.logger.zsymb(0,"9cPqk8","resume sync is disabled"),this.storage.clear()),!0;const e=this.entriesTransferManager.getSyncSource();return"number"==typeof e&&(this.requestedSuggestSync=null,this.isEnableBySrc(e)?(this.logger.zsymb(0,"oHMc2K","Suggest sync with cached entry transfer before"),this.delayedSuggestSync(e,!1)):(this.logger.zsymb(0,"f4mzCW",`${e} sync is disabled`),this.storage.clear()),!0)}})||oc)||oc)||oc)||oc)||oc)||oc)||oc)||oc)||oc)||oc)||oc)||oc)||oc)||oc)||oc)||oc)||oc);var mc=s("JprO"),pc=s("3jnX"),fc=s("nhJq");class vc{constructor(e,t,s){this.hostName=void 0,this.key=void 0,this.keyDecryptor=void 0,this.folderBackupName=void 0,this.hostName=e,this.key=t,this.keyDecryptor=s,this.folderBackupName=this.createFolderBackupName()}get publicKey(){return this.key.publicKey}get sessionFolderBackupName(){return this.folderBackupName}createFolderBackupName(){return`blob_${Object(Co.b)()}`}isSame(e){return this.hostName===e.hostName&&this.key===e.key}decryptKey(e,t){return this.keyDecryptor(e,t,this.key)}static create(e,t){return new vc(e,t.generate(),t.decryptKey.bind(t))}}class _c extends pc.b{constructor(e){super({type:"DECRYPT_BACKUP",params:e})}}class bc extends pc.b{constructor(e,t){super({type:"RESTORE_MESSAGES",params:e,checkpoint:t}),this.handleEventBusMessage=(e,t)=>{if("SELECT_CONVERSATION"===e){const e=t.userId;this.params.meta.viewingConversation!==e&&this.changeParams({meta:Object(T.a)(Object(T.a)({},this.params.meta),{},{viewingConversation:e})})}}}run(){return this.startListenEventBus(),this.addEventListenerOnce(pc.c.Finalized,(()=>{this.stopListenEventBus()})),super.run()}startListenEventBus(){this.stopListenEventBus(),N.default.subscribe(this.handleEventBusMessage)}stopListenEventBus(){N.default.unsubscribe(this.handleEventBusMessage)}}class yc extends pc.b{constructor(e){super({type:"RESTORE_CONVERSATIONS",params:e})}}var Ic,Sc=s("qUG6"),Cc=s("6Sr9"),Ec=s("1erv");const Oc=$znode.path;Object(i.injectable)()(Ic=Object(i.singleton)(Do)(Ic=Object(Cc.f)()(Ic=Object(Cc.e)()(Ic=function(e,t){return Object(i.inject)(Go)(e,void 0,0)}(Ic=function(e,t){return Object(i.inject)(jo.a)(e,void 0,1)}(Ic=function(e,t){return Object(i.inject)(Zo.b)(e,void 0,2)}(Ic=function(e,t){return Object(i.inject)(To)(e,void 0,3)}(Ic=function(e,t){return Object(i.inject)(B.ZLoggerFactory)(e,void 0,4)}(Ic=function(e,t){return Object(i.inject)(Qo)(e,void 0,5)}(Ic=function(e,t){return Object(i.inject)(Ko.a)(e,void 0,6)}(Ic=Reflect.metadata("design:type",Function)(Ic=Reflect.metadata("design:paramtypes",[void 0===Go?Object:Go,void 0===jo.a?Object:jo.a,void 0===Zo.b?Object:Zo.b,void 0===To?Object:To,void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory,void 0===Qo?Object:Qo,Object])(Ic=class{constructor(e,t,s,i,a,n,r){this.session=void 0,this.hostName=void 0,this.keyGenerator=void 0,this.storage=void 0,this.setting=void 0,this.ui=void 0,this.logger=void 0,this._currentTask=null,this.metricts=void 0,this.messageReadinessChecker=void 0,this.logger=a.createZLogger(Ss.ZLoggerNametags.msgSync,[Ss.ZLoggerNametags.service]),this.storage=e,this.setting=t,this.ui=s,this.keyGenerator=i,this.hostName=$znode.os.hostname(),this.session=null,this.metricts=n,this.messageReadinessChecker=r}get currentSession(){return this.session||(this.session=this.newSession()),this.session}get queueIndexSearch(){return!1}onSessionExpired(){this.logger.zsymb(0,"C5iUzv","onSessionExpired"),this.session&&this.cancelTransferMobile(),this.cleanUrgent(!0)}onDispose(){this.logger.zsymb(0,"3P_pxz","onDispose"),ti.g.isRememberMe()||this.cleanUrgent()}isNoMissingMessageEventsArrived(){return this.messageReadinessChecker.isNoMissingMessageEventsArrived()}isAtLeastOneMissingMessageEventArrived(){return this.messageReadinessChecker.isAtLeastOneMissingMessageEventArrived()}shouldTransferWhenLogin(){let e=n.default.getInstance().getItem("z_needSyncMsg");const t=this.storage.syncState.isStarted,s="number"==typeof this.storage.syncSource.get(),i=this.messageReadinessChecker.isMessageReady(),a=e&&JSON.parse(e)||t||s||!i;return this.logger.zsymb(0,"DMRPhU",`shouldTransfer: ${a}, isMessageReady: ${i}, needSync: ${e}, isStarted: ${t}, syncSrc : ${this.storage.syncSource.get()}`),a}async prepareNewSync(){var e;await this.abortRestore(),null!==(e=U.default.cross_setting)&&void 0!==e&&e.enable_break_folder_db_as_session||await this.cleanupTempFiles(),this.session=null,this.storage.syncState.reset();const t=this.setting.value();this.storage.syncState.resetCheckpoint(0,t.minSeq,t.maxSeq)}request(e=0,t=0,s=""){this.setting.checkDatabaseCorruption();const i=this.currentSession.publicKey,a=this.setting.value(),n=a.maxSeq,r=a.minSeq,o=ms.a.newReq();return this.logger.zsymb(0,"d7DZWM",(()=>["sent request backup",{id:o,max:n,min:r,retry:e,resend:t,key:i}])),rs.default.pullMobileMsg(i,n,o,t,r,s).then(os.a).catch((s=>{throw this.logger.zsymb(0,"EyITDm",(()=>["failed to send request backup",{id:o,max:n,min:r,retry:e,resend:t,error:s}])),e>0&&(this.session=null),s}))}async clean(){this.logger.zsymb(0,"C9mW4c","abort current task"),await this.abortRestore(),this.logger.zsymb(0,"2xe-7E","clean storage"),await this.cleanupTempFiles(),this.storage.clear(),this.logger.zsymb(0,"XEN171","clean session"),this.session=null,this.logger.zsymb(0,"TflMll","cleanup done")}async download(e=0){this.logger.zsymb(0,"xzRF4y",(()=>["downloading backup",{retry:e}]));const t=this.storage.backup.get();if(!t)return this.metricts.onDownloadBackupFailure(Io.g.SELF_DEFINE,Io.b.BACKUP_NOT_FOUND),Promise.reject("No backup found");await mc.a.run({type:mc.a.constants.DownloadType.File,data:{fileName:t.name,url:t.url,checksum:t.checksum},options:{saveDir:await this.getBackupDirFolderPath(),caching:!0,duplicate:!1,srcAction:mc.a.constants.srcAction.Dev,showProgress:{taskBar:!1,progressBar:!0,progressChannel:"UPDATE_CHANNEL_CROSS_DB",progressChannelId:t.checksum},onProgress:(e=>{e>0&&this.ui.setProgress(e)}).bind(this),noiseDownload:!1,timeOut:1e4,cookies:!0,preventTransform:!0}}),this.ui.setProgress(100);const s=Oc.join(await this.getBackupDirFolderPath(),t.name);t.inputPath=s,this.storage.backup.save(t)}async decrypt(){const e=this.storage.backup.get();if(!e)return Promise.reject("no backup found");if(0===e.numberOfMessagesCount)return;const t=e.format?"hex":"base64",s=e.encryptedKey,a=this.currentSession.decryptKey(s,t),n=await this.getBackupFolderPath(e);e.outputPath=n,e.sessionOutputFolder=this.currentSession.sessionFolderBackupName,e.privateKey=a,this.storage.backup.save(e);const r=new _c({inputPath:e.inputPath,outputPath:e.outputPath,privateKey:e.privateKey,format:1===e.format?1:0,numberOfConversationsCount:e.numberOfConversationsCount});(async()=>{let e=0,t=setInterval((()=>{e+=5,this.ui.getCurrentScreen()===Zo.a.DecryptingBackup?this.ui.setProgress(e):clearInterval(t),100===e&&clearInterval(t)}),2e3)})(),this._currentTask=r,await i.ModuleContainer.resolve(La.b).waitMigrateRelease(),i.ModuleContainer.resolveToken(rc).isMachineIdle()?this.logger.zsymb(0,"ATgYZ8","Skip decrypt, transfer flow is aborded!"):await r.run()}async restore(e){vi.a.getInstance().pauseIdx(),this.logger.zsymb(0,"YOOyOs",(()=>["restoring backup",{retry:e}]));const t=this.storage.backup.get();if(!t||0===t.numberOfMessagesCount)return void this.ui.setNumOfSyncedConv(0);const s=this.storage.syncState.step;s<=Bo.RESTORE_CONVERSATIONS&&(this.storage.syncState.isSyncing=!0,await this._restoreConversations().catch((e=>{throw this.logger.zsymb(18,"Tbs3nq",(()=>["restore conversations failed",{error:e}])),this.metricts.onRestoreDataFailure(Io.i.RESTORE_CONV_ERR),e})),this.storage.syncState.nextStep());let i={trackInfo:{}};if(s<=Bo.RESTORE_MESSAGES&&(i=await this.restoreMessages().catch((e=>{throw this.logger.zsymb(18,"K2IngV",(()=>["restore messages failed",{error:e}])),this.metricts.onRestoreDataFailure(Io.i.RESTORE_MSGS_ERR),e})),this.storage.syncState.nextStep()),s<=Bo.UPDATE_MESSAGES_CACHE)return this.setting.setLastSync(Date.now()),this.metricts.onRestoreDataSuccess(),void this.metricts.onSyncSuccess(t.format,this.storage.syncState.checkpoint.importedMessages,t.numberOfMessagesCount,i.trackInfo);throw new Error("unknown step")}async getBackupDirRootFolderPath(){const e=await Object(re.getuserDataDir)();return Oc.join(e,"blob")}async getBackupDirSessionFolderPath(e){const t=e||this.currentSession.sessionFolderBackupName;return Oc.join(await this.getBackupDirRootFolderPath(),t)}async getBackupDirFolderPath(e){return U.default.cross_setting.enable_break_folder_db_as_session?await this.getBackupDirSessionFolderPath(e):await this.getBackupDirRootFolderPath()}async getBackupFolderPath(e){return Oc.join(await this.getBackupDirFolderPath(e.sessionOutputFolder),e.name+"_tmp")}async restoreMessages(){this.logger.zsymb(0,"NvzcOS","restore messages");const e=this.storage.backup.get(),t=i.ModuleContainer.resolve(Ks.SidebarController),s=new bc({backupPath:e.outputPath,plainUserId:e.rawUid,noiseUserId:e.userId,password:e.uin,format:e.format,conversations:e.conversations,shouldUseNewMediaDBFlowConfig:Object(Ec.a)(),meta:{queueIndexSearch:this.queueIndexSearch,viewingConversation:t.getSelectedId(),cachedRanges:{},numberOfMessages:e.numberOfMessagesCount,numberOfConversations:e.numberOfConversationsCount}},this.storage.syncState.checkpoint);if(s.addEventListener(pc.c.Progress,(e=>{e.progress>0&&this.ui.setProgress(e.progress);const t=e.checkpoint;t&&(this.storage.syncState.checkpoint=t)})),s.addEventListenerOnce(pc.c.Completed,(()=>{if(0==e.format)this.ui.setNumOfSyncedConv(e.numberOfConversationsCount);else{const t=e.numberOfConversationsCount,s=this.storage.syncState.checkpoint.updatedConversation;this.ui.setNumOfSyncedConv(s),this.logger.zsymb(0,"GO9ocf","completed sync",s,t)}this.setting.setMinSeq(this.storage.syncState.checkpoint.minSeq),this.setting.setMaxSeq(this.storage.syncState.checkpoint.maxSeq)})),this._currentTask=s,await i.ModuleContainer.resolve(La.b).waitMigrateRelease(),!i.ModuleContainer.resolveToken(rc).isMachineIdle())return s.run();this.logger.zsymb(0,"UTazQc","Skip restore message, transfer flow is aborded!")}async _restoreConversations(){this.logger.zsymb(0,"bhzOGi","restore conversations");let e=this.storage.backup.get();const t=new yc({backupPath:e.outputPath,format:e.format,plainUserId:e.rawUid,noiseUserId:e.userId,password:e.uin,shouldUseNewMediaDBFlowConfig:Object(Ec.a)(),meta:{queueIndexSearch:this.queueIndexSearch}});if(this._currentTask=t,await i.ModuleContainer.resolve(La.b).waitMigrateRelease(),i.ModuleContainer.resolveToken(rc).isMachineIdle())return void this.logger.zsymb(0,"FrBlwL","Skip restore conversation, transfer flow is aborded!");const s=await t.run(),a=(await this._validateConversations(s)).filter((e=>!e.shouldIgnore)),n=a.filter((e=>!e.isExist)),r=a.filter((e=>!!e.lastMessage));if(n.length>0&&await this._createNewImportConversations(n).catch((e=>{this.logger.zsymb(18,"WNIgaZ",(()=>["create new import conversations failed. but continue",{error:e}]))})),r.length>0){const e=r.map((e=>e.lastMessage));this._updatePreviewOfConversations(e)}e=this.storage.backup.save(Object(T.a)(Object(T.a)({},e),{},{conversations:a.map((e=>({plainId:e.plainId,noiseId:e.noiseId,isGroup:e.isGroup,hasPreviewMsg:!!e.lastMessage,shouldIgnore:e.shouldIgnore})))}));const o=this.storage.syncState.checkpoint;if(1===o.format){const e=Object(T.a)({},o);let t=a.filter((e=>!!e.lastMessage)).sort(((e,t)=>t.lastMessage.localDttm-e.lastMessage.localDttm)).map((e=>e.plainId));t=t.concat(a.filter((e=>!e.lastMessage)).map((e=>e.plainId))),e.priorities=t,e.currentSeq={},this.storage.syncState.checkpoint=e}}_updatePreviewOfConversations(e){new Sc.a(e).run()}async _createNewImportConversations(e){const t=i.ModuleContainer.resolve(ze.b);await Promise.all(e.map((e=>{var s,i;t.addIfNotExistsConv(e.noiseId,e.isGroup,null===(s=e.lastMessage)||void 0===s?void 0:s.msgId,null===(i=e.lastMessage)||void 0===i?void 0:i.msgId,ts.b.isMyMessage(e.lastMessage),1)})))}async _validateConversations(e){const t=[],s=[];for(const o of e)o.isGroup?s.push(o.noisedId):t.push(o.noisedId);const[i,a]=await Promise.all([Z.default.getProfileFriendByIds(t).catch((e=>(this.logger.zsymb(18,"lMw-RQ",(()=>["validate friend error",{error:e}])),{}))),Fe.default.getGroupsByIds(s).catch((e=>(this.logger.zsymb(18,"-_tv7R",(()=>["validate group error",{error:e}])),{})))]),n=e.map((e=>({plainId:e.plainId,noiseId:e.noisedId,isExist:!!Q.a.ConvInfoDataManager.getConvByIdSync(e.noisedId),isGroup:e.isGroup,hasPreview:!!e.lastMessage,lastMessage:e.lastMessage,shouldIgnore:!i[e.noisedId]&&!a[e.noisedId]}))),r=n.filter((e=>!e.shouldIgnore)).length;return this.logger.zsymb(0,"iRKdHJ",(()=>["validate conversations done",{total:e.length,valid:r}])),n}async cleanUrgent(e){this.abortRestore(),this.logger.zsymb(0,"122dJk","abort restore"),this.storage.clear(e),this.logger.zsymb(0,"kpTxaV","clean storage"),this.session=null,this.logger.zsymb(0,"nOP08t","clean session"),$zdb.abortSyncMsg({reason:"session-expired",path:await this.getBackupDirRootFolderPath()})}cancelTransferMobile(){const e=this.currentSession.publicKey,t=ms.a.newReq();this.logger.zsymb(0,"k-TclM",(()=>["cancel request backup",{id:t,key:e}])),rs.default.cancelTransferMessage(t,e).then(os.a).then((e=>{this.logger.zsymb(0,"a6qOFa",(()=>["success to cancel request backup",{id:t,res:e}]))})).catch((s=>{throw this.logger.zsymb(0,"U6wZv7",(()=>["failed to cancel request backup",{id:t,key:e,error:s}])),s}))}async abortRestore(){this._currentTask&&await this._currentTask.abort(),this._currentTask=null}getRequestBackupTimeout(e){if(e)return 1e3*U.default.cross_setting.waitDbTimeout;const t=1e3*U.default.cross_setting.cfTimeout;return Math.max(0,t-(Date.now()-this.ui.getStartSyncTime()))}getMobileTransferConfirmTimeout(){let e=dc.a.transfer_when_login.mobile_transfer_confirm_timeout;const t=U.default.transfer_when_login.mobile_transfer_confirm_timeout;return"number"==typeof t&&t>=0&&(e=t),e}getNoMissingMessageEventsTimeout(){let e=dc.a.transfer_when_login.no_missing_message_events_timeout;const t=U.default.transfer_when_login.no_missing_message_events_timeout;return"number"==typeof t&&t>=0&&(e=t),e}getEnabledDropTransferWhenLoginFlowConfig(){let e=dc.a.transfer_when_login.enable_drop_flow;const t=U.default.transfer_when_login.enable_drop_flow;return"boolean"==typeof t&&(e=t),e}getSuccessBannerWhenDropTransferWhenLoginConfig(){let e=dc.a.transfer_when_login.success_banner_when_drop;const t=U.default.transfer_when_login.success_banner_when_drop;return"boolean"==typeof t&&(e=t),e}getEnableLogEventsArrivalTimeConfig(){let e=dc.a.transfer_when_login.enable_log_events_arrival_time;const t=U.default.transfer_when_login.enable_log_events_arrival_time;return"boolean"==typeof t&&(e=t),e}getEventsArrivalTimeSubmitLogTimeout(){return dc.a.transfer_when_login.timeout_submit_events_arrival_time_log}getCloseSuccessTimeout(){return 1e3*U.default.cross_setting.closeSuccessTimeout||1e4}async cleanupTempFiles(){this.logger.zsymb(0,"FA5Qrp","remove temp files"),await fc.b(await this.getBackupDirRootFolderPath()).catch((e=>{this.logger.zsymb(18,"hOtSpT",(()=>["remove temp failed",{err:e}]))}))}newSession(){return vc.create(this.hostName,this.keyGenerator)}getHardcodeError(e){return 0}})||Ic)||Ic)||Ic)||Ic)||Ic)||Ic)||Ic)||Ic)||Ic)||Ic)||Ic)||Ic);var Tc,Mc;const Rc=new Map;Object(m.j)()(Tc=Object(i.injectable)()(Tc=function(e,t){return Object(i.inject)(B.ZLoggerFactory)(e,void 0,0)}(Tc=Reflect.metadata("design:type",Function)(Tc=Reflect.metadata("design:paramtypes",[void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory])(Tc=class extends pc.a{constructor(e){super(),this.logger=void 0,this.logger=e.createZLogger("sync-message",["noise-id-handler"])}async execute({params:e}){const t=e.uids.length+e.gids.length;return 0===t?[]:t>1e4?Promise.all([this.getNoiseIdFromServer(e.uids,[]),this.getNoiseIdFromServer([],e.gids)]).then((([e,t])=>[...e,...t])):this.getNoiseIdFromServer(e.uids,e.gids)}async getNoiseIdFromServer(e,t){let s=e.map((e=>Number.parseInt(e))),i=t.map((e=>Number.parseInt(e)));const a=await rs.default.getnuid(s,i).then(os.a).catch((s=>{this.logger.zsymb(18,"TC8xOH",(()=>["get noise id from server error",s]));const i=s.code||s.error_code;if(i===W.NetWorkError.NO_NETWORK||-69===i)throw Si.default.increaseFailed(Io.f.REQ_NOISE_ID,0,0,Io.d.NO_NET_OR_TOO_MUCH_REQ,Date.now()),s;return this.logger.zsymb(0,"WBov1Z",(()=>["return empty result for ids:",{uids:e,gids:t}])),Si.default.increaseFailed(Io.f.REQ_NOISE_ID,0,0,s.error_code,Date.now()),{fids:[],gids:[]}}));if(s.length>0&&s.length!==a.fids.length)throw this.logger.zsymb(18,"uhSPbA",`data mismatch: uids: ${s.length}, fids: ${a.fids.length}`),Si.default.increaseFailed(Io.f.REQ_NOISE_ID,0,0,Io.d.U_MIS_MATCH,Date.now()),new Error("data mismatch reason:uids");if(i.length>0&&i.length!==a.gids.length)throw this.logger.zsymb(18,"9xPXHM",`data mismatch: gids: ${i.length}, gids: ${a.gids.length}`),Si.default.increaseFailed(Io.f.REQ_NOISE_ID,0,0,Io.d.G_MIS_MATCH,Date.now()),new Error("data mismatch reason:gids");let n=[];return a.gids&&a.gids.forEach(((e,s)=>{e=e.startsWith("g")?e:`g${e}`,n.push([t[s],e]),Rc.set(t[s],e)})),a.fids&&a.fids.forEach(((t,s)=>{const i=`g${t}`;Fe.default.getGroupByIdSync(i)?(n.push([e[s],i]),Rc.set(e[s],i)):(n.push([e[s],t]),Rc.set(e[s],t))})),n}getType(){return"REQUEST_NOISE_ID"}getHardcodeError(e){return 0}})||Tc)||Tc)||Tc)||Tc),Object(m.j)()(Mc=Object(i.injectable)()(Mc=class extends pc.a{async execute(){return Array.from(Rc.entries())}getType(){return"REQUEST_ALL_NOISE_ID"}})||Mc);var wc;Object(m.j)()(wc=Object(i.injectable)()(wc=class extends pc.a{async execute({params:e}){const t=i.ModuleContainer.resolve(ze.i);await t.onReceiveNewMessages("sync-db",e)}getType(){return"UPDATE_CONVERSATION_PREVIEW"}})||wc);var Lc;Object(m.j)()(Lc=Object(i.injectable)()(Lc=function(e,t){return Object(i.inject)(B.ZLoggerFactory)(e,void 0,0)}(Lc=Reflect.metadata("design:type",Function)(Lc=Reflect.metadata("design:paramtypes",[void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory])(Lc=class extends pc.a{constructor(e){super(),this.logger=void 0,this.logger=e.createZLogger("feat",["sync-message","reload-msg-handler"])}async execute({params:e}){if(!Wt.b.messageCache)return;Wt.b.messageCache.deleteConversation(e.convId);const t=Zt.a.getExistConvIds();this.logger.zsymb(0,"Qj6e7F",`ReloadMessagehandle ${t.includes(e.convId)} ${e.convId}`),t.includes(e.convId)&&Kt.a.getLastMessagesForConversation(e.convId,{})}getType(){return"RELOAD_MESSAGE"}})||Lc)||Lc)||Lc)||Lc);var Fc,Dc=s("1KLq"),Ac=s("nuPU");Object(m.j)()(Fc=Object(i.injectable)()(Fc=function(e,t){return Object(i.inject)(Dc.b)(e,void 0,0)}(Fc=Reflect.metadata("design:type",Function)(Fc=Reflect.metadata("design:paramtypes",[void 0===Dc.IMediaEventEmitter?Object:Dc.IMediaEventEmitter])(Fc=class extends pc.a{constructor(e){super(),this._mediaEventEmitter=void 0,this._mediaEventEmitter=e}async execute({params:e}){this._mediaEventEmitter.emit(Ac.a.RELOAD_MEDIA_OF_CONV,e)}getType(){return"RELOAD_MEDIA"}})||Fc)||Fc)||Fc)||Fc);var Nc=s("Erqw");const{setTimeoutUnlimited:kc,clearTimeoutUnlimited:Pc}=function(e={}){var t,s;const i=null!==(t=e.step)&&void 0!==t&&t?1e4:36e5,a=null!==(s=e.registry)&&void 0!==s?s:{};return{setTimeoutUnlimited:(e,t,...s)=>{const n=(e=>{var t;const s=e.step,i=e.registry;let a=null!==(t=e.timeout)&&void 0!==t?t:0;const n=e.callback,r=e.args,o=performance.now()+a;let c;function l(){let e=Math.min(o-performance.now(),s);return performance.now()>o?i[c]=setTimeout(n,0,r):i[c]=setTimeout(l,e),i[c]}return function(){let e=Math.min(o-performance.now(),s);return c=setTimeout(l,e),i[c]=c,c}()})({step:i,registry:a,callback:e,timeout:t,args:s});return n},clearTimeoutUnlimited:e=>{(e=>{const t=e.id,s=e.registry;clearTimeout(s[t]),delete s[t]})({id:e,registry:a})}}}({registry:{}});var jc,Uc=s("1p+n"),Bc=s("UYft"),Gc=s("AULX");Object(i.injectable)()(jc=Object(i.singleton)(Gc.a)(jc=Object(m.h)()(jc=Object(m.f)()(jc=function(e,t){return Object(i.inject)(o)(e,void 0,0)}(jc=function(e,t){return Object(i.inject)(B.ZLoggerFactory)(e,void 0,1)}(jc=Reflect.metadata("design:type",Function)(jc=Reflect.metadata("design:paramtypes",[void 0===r?Object:r,void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory])(jc=class{constructor(e,t){this.kvCacheFactory=e,this.loggerFactory=t,this._logger=void 0,this._authEvent=void 0,this.__cache=void 0,this._renewRegistry={},this.updateEmitter=new Uc.a,this._logger=this.loggerFactory.createZLogger("feat",["group-link"])}onAuthenticated(e){this._authEvent=e}_makeCache(){if(!this._authEvent)throw new Error("Not authenticated");return this.kvCacheFactory.createCache(`group-link-v3-${this._authEvent.getSession().userId}`,{maxSize:50})}get _cache(){return this.__cache||(this.__cache=this._makeCache()),this.__cache}_scheduleRenew(e,t){if(this._clearRenewSchedule(e),!t.enabled)return this;if(!U.default.groupLink.enableScheduleRenew)return this._logger.debug(["_scheduleRenew skipped, enableScheduleRenew:",U.default.groupLink.enableScheduleRenew]),this;let s=t.expirationDate-D.default.getTimeNow(),i=kc((()=>{this._clearRenewSchedule(e),this._emitGroupLinkUpdated(e,!0)}),s);return this._renewRegistry[e]=()=>{Pc(i),delete this._renewRegistry[e]},this}_clearRenewSchedule(e){var t,s;return null===(t=(s=this._renewRegistry)[e])||void 0===t||t.call(s),this}onDispose(){this._authEvent=void 0,this.__cache=void 0}async _getFromCache(e){if(!U.default.groupLink.enableCache)return void this._logger.debug(["cache skipped, enableCache:",U.default.groupLink.enableCache]);e=zc(e);let t=await this._cache.getItem(e);if(t){if(function(e){if(!e)return!1;let{data:t,meta:s}=e;if(!t)return!1;if(!s)return!1;if(Nc.a.isOverflowAtTime(s.ts))return!1;const i=D.default.getTimeNow();if(s.ts+U.default.groupLink.maxCacheDuration<i)return!1;if(t.enabled&&t.expirationDate<i)return!1;return!0}(t))return t.data;await this._cache.removeItem(e)}}async _fetchAndPutToCache(e,t){const s=D.default.getTimeNow(),i=await t(),a={enabled:i.enabled,expirationDate:i.expiration_date,link:i.link};let n={ts:s};return await this._cache.setItem(e,{data:a,meta:n}),a}async _deleteCache(e){await this._cache.removeItem(e)}async getGroupLinkDetail(e,t=!1){this._logger.zsymb(12,"mSRxHE",["getting",e]);let s=zc(e),i=await this._getFromCache(s);if(i&&!t)return this._logger.zsymb(12,"bTZAfv",["cache hit",s]),this._scheduleRenew(s,i),i;this._logger.zsymb(12,"qE2-r4",["fetching",s]);let a=A.default.getRawGroupId(s);let n=await this._fetchAndPutToCache(s,(()=>Ni.default.getGroupLinkDetail(a))).catch(Bc.a.catch((e=>this._logger.zsymb(18,"S28Tyr",["get failed",s,e]))));return this._scheduleRenew(s,n),t&&await this._emitGroupLinkUpdated(e),this._logger.zsymb(12,"2KqD3e",["done",s]),n}async renewGroupLink(e){this._logger.zsymb(12,"k81KKT",["renewing",e]);let t=zc(e),s=A.default.getRawGroupId(t);let i=await this._fetchAndPutToCache(t,(()=>Ni.default.renewGroupLink(s))).catch(Bc.a.catch((e=>this._logger.zsymb(18,"konlnk",["renew failed",t,e]))));return this._scheduleRenew(t,i),await this._emitGroupLinkUpdated(t),this._logger.zsymb(12,"1ZJdFw",["renew done",e]),i}async disableGroupLink(e){this._logger.zsymb(12,"Wl0uPU",["disabling",e]);let t=zc(e),s=A.default.getRawGroupId(t);await Ni.default.disableGroupLink(s).catch(Bc.a.catch((e=>this._logger.zsymb(18,"G5V3I8",["disable failed",t,e])))),await this._emitGroupLinkUpdated(t,!0),this._logger.zsymb(12,"t3bTPw",["disable done",e])}async _emitGroupLinkUpdated(e,t=!1){const s=zc(e);t&&await this._deleteCache(s),this.updateEmitter.emit(s,s),this.updateEmitter.emit("*",s)}async emitGroupLinkUpdated(e){return await this._emitGroupLinkUpdated(e,!0)}})||jc)||jc)||jc)||jc)||jc)||jc)||jc);function zc(e){return W.GROUPID_PREFIX+A.default.getRawGroupId(e)}var xc,Vc=s("TO4U");const Hc={loading:!0};Object(ie.b)(Vc.a)(xc=function(e,t){return Object(i.inject)(Gc.a)(e,void 0,0)}(xc=Reflect.metadata("design:type",Function)(xc=Reflect.metadata("design:paramtypes",[void 0===Gc.a?Object:Gc.a])(xc=class e{constructor(e){this._groupLink=e,this.type=void 0,this.name="group-link-ui",this.key="group-link-ui",this._cache=new h.default({maxSize:50}),this._handleUpdate=e=>{const t=qc(e);this._cache.delete(t),this._startFetchAndSetToSession(t)},this._groupLink.updateEmitter.on("*",this._handleUpdate)}init(){}getItem(e,t){if(!e.key.startsWith(W.GROUPID_PREFIX))return;const s=qc(e.key);this._startFetchAndSetToSession(s);let i=this._cache.get(s);return i||Hc}static shouldSignal(e,t){var s,i,a,n,r,o;return!e||(null==e||e.error,null==t||t.error,null==t||null===(s=t.data)||void 0===s||s.enabled,null==t||null===(i=t.data)||void 0===i||i.enabled,null!=e&&null!==(a=e.data)&&void 0!==a&&a.enabled&&null!=t&&null!==(n=t.data)&&void 0!==n&&n.enabled&&(null==e||null===(r=e.data)||void 0===r||r.link,null==t||null===(o=t.data)||void 0===o||o.link),!1)}signalIfNeeded(t,s,i){e.shouldSignal(s,i)&&Object(Zs.g)(this.name,t)}_startFetchAndSetToSession(e){const t=this._cache.get(e);setTimeout((()=>{this._groupLink.getGroupLinkDetail(e).then((s=>{const i={loading:!1,data:s};this._cache.set(e,i),this.signalIfNeeded(e,t,i)})).catch((s=>{const i={loading:!1,error:s};this._cache.set(e,i),this.signalIfNeeded(e,t,i)}))}),0)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||xc)||xc)||xc);function qc(e){return W.GROUPID_PREFIX+A.default.getRawGroupId(e)}var Wc=s("oOjv"),Zc=s("bB26"),Kc=s("lteq");const Qc={[yt.c]:{}};i.ModuleContainer.registerSingleton(Wc.b,class{constructor(){this.state=Qc,this.animationControllers=new Map,this._manuallyOff=!1,this.name=Wc.a,this.key="convId",this.isFeatEnabled=()=>!this._manuallyOff&&U.default.preview_msg_time.enable,this.state=Qc}offFeature(){this._manuallyOff=!0}enableFeature(){this._manuallyOff=!1}getAnimController(e){if(!this.isFeatEnabled())return null;if(!this.animationControllers.has(e)){const t=new Zc.a(e);this.animationControllers.set(e,t)}return this.animationControllers.get(e)||null}setScrollDirection(e,t){if(!this.isFeatEnabled())return;const s=this.getAnimController(e);null==s||s.setScrollDirection(t)}hasNewMsgInView(e,t){if(!this.isFeatEnabled())return;const s=this.getAnimController(e);null==s||s.hasNewMsgInView(t)}hasViewOverflowMsg(e,t){if(!this.isFeatEnabled())return;const s=this.getAnimController(e);null==s||s.hasViewOverflowMsg(t)}hitBottom(e,t){if(!this.isFeatEnabled())return;const s=this.getAnimController(e);null==s||s.hitBottom(t)}triggerActiveScroll(e,t){if(!this.isFeatEnabled())return;const s=this.getAnimController(e);null==s||s.triggerActiveScroll(t)}onChangeConversation(e){var t;const s=this.getAnimController(e);null==s||s.resetAnimation(),null===(t=Kc.a.getInViewController(e))||void 0===t||t.resetPreviewTimestamp(),Ti.a.onNewSession(e)}clearAnimations(e){const t=this.getAnimController(e);null==t||t.clearAnimations()}onMouseEnterPreviewTime(e,t){if(!this.isFeatEnabled()||!t)return;const s=this.getAnimController(e);(null==s?void 0:s.mountedPreviewTime)===t&&(null==s||s.pause())}onMouseLeavePreviewTime(e,t){if(!this.isFeatEnabled()||!t)return;const s=this.getAnimController(e);(null==s?void 0:s.mountedPreviewTime)===t&&(null==s||s.resume())}setTopMost(e,t,s){if(!this.isFeatEnabled())return;const i=this.getAnimController(e);null==i||i.setTopMost(t,s)}setSecondTopMost(e,t,s){if(!this.isFeatEnabled())return;const i=this.getAnimController(e);null==i||i.setSecondTopMost(t,s)}init(){}getItem(e){return this.state[e.key]}getList(e){return Object.keys(this.state)}onGetItemFailure(e){}onGetListFailure(e){}});var $c,Yc=s("px+z"),Jc=s("JRkD"),Xc=s("AqnK"),el=s("3Rxw"),tl=s("xwfN"),sl=s("qSdT"),il=s("V2fg"),al=s("RUx3");let nl=Object(i.injectable)()($c=class{constructor(){this.MAX_REGEN_TASKS=10,this.requests=[],this.availableTask=this.MAX_REGEN_TASKS,this.regenImageFromLocal=async e=>{try{await this.acquireTaskLock();try{const t=await this.regenImageFromLocalUsingNativelibs(e);return Si.default.increaseSuccess(al.a,0,0),Si.default.increaseSuccess(al.c,0,0),t}catch(t){Si.default.increaseFailed(al.a,0,0,Object(al.k)(),Date.now())}try{const t=await this.regenImageFromUrlUsingNativeElectron(e);return Si.default.increaseSuccess(al.c,0,0),t}catch(t){throw t}}catch(t){throw Si.default.increaseFailed(al.c,0,0,Object(al.i)(),Date.now()),t}finally{this.releaseTaskLock()}},this.regenImageFromLocalUsingNativelibs=async e=>{const{getSourcePath:t,getGenThumbPath:s,sizes:i={width:void 0,height:void 0},removeOriginalAfterGenerate:a=!1,priority:n=-1}=e;Object(Jc.a)(!!t,"ImageRegeneratorImpl: getSourcePath cannot be null"),Object(Jc.a)(!!s,"ImageRegeneratorImpl: getGenThumbPath cannot be null");const r=await s();if($znode.fs.existsSync(r))return Xc.k.Success({mediaURL:r});const o={width:i.width,height:i.height},c=await t(),l=$znode.path.extname(c);try{var d,h;const t=await $zFileManager.getFileArrayBuffer(c);il.b.log(null===(d=e.log)||void 0===d?void 0:d.clientId,{msgFormat:l,originalSize:t.byteLength});let s=new Blob([t],{type:".jxl"===l?"image/jxl":"image/jpeg"});s=await Object(el.a)(s,{width:o.width,height:o.height,priority:n});const i=$znode.path.dirname(r);await this.ensureDir(i),await $zFileManager.writeBufferToPath(r,await s.arrayBuffer()),il.b.endLog(null===(h=e.log)||void 0===h?void 0:h.clientId,{regenStatus:1,localSize:t.byteLength,hdSize:t.byteLength,normalSize:720===o.width?s.size:void 0,thumbSize:300===o.width?s.size:void 0})}catch(g){var u;throw il.b.endLog(null===(u=e.log)||void 0===u?void 0:u.clientId,{regenStatus:0}),g}if(a)try{$znode.fs.unlinkSync(c)}catch(m){}return Xc.k.Success({mediaURL:r})},this.regenImageFromUrlUsingNativeElectron=async e=>{const{getSourcePath:t,getGenThumbPath:s,sizes:i,removeOriginalAfterGenerate:a=!1,priority:n=-1}=e;Object(Jc.a)(!!t,"ImageRegeneratorImpl: getSourcePath cannot be null"),Object(Jc.a)(!!s,"ImageRegeneratorImpl: getGenThumbPath cannot be null");const r=await s();if($znode.fs.existsSync(r))return Xc.k.Success({mediaURL:r});const o={width:i.width||-1,height:i.height||-1},c=await t(),l=$znode.path.extname(c);let d=null,h=null;try{const e=await $zFileManager.getFileArrayBuffer(c);let t=new Blob([e],{type:".jxl"===l?"image/jxl":"image/jpeg"});d=URL.createObjectURL(t);const s=new Image;s.src=d,await new Promise(((e,t)=>{s.onload=e,s.onerror=t}));let i=o.width,a=o.height,n=s.width,u=s.height;if(-1==a&&-1==i)i=n,a=u;else if(-1==a||-1==i)-1==a?a=Math.min(Xc.f,n,i)*u/n:i=Math.min(Xc.f,a,u)*n/u;else{const{width:e,height:t}=Object(sl.a)(n,u,Xc.f,Xc.f);i=e,a=t}h=document.createElement("canvas"),h.width=i,h.height=a;const g=h.getContext("2d");null==g||g.drawImage(s,0,0,i,a);const m=await new Promise(((e,t)=>{h.toBlob((s=>{const i=new FileReader;i.onload=()=>{e(i.result)},i.onerror=t,i.readAsArrayBuffer(s)}),"image/jpeg",1)})),p=$znode.path.dirname(r);await this.ensureDir(p),await $zFileManager.writeBufferToPath(r,m)}catch(g){throw zconsole.error("[JXL]: regen erorr",g),g}finally{var u;d&&URL.revokeObjectURL(d);const e=null===(u=h)||void 0===u?void 0:u.getContext("2d");e&&e.clearRect(0,0,h.width,h.height),h&&(h.width=0,h.height=0)}if(a)try{$znode.fs.unlinkSync(c)}catch(m){}return Xc.k.Success({mediaURL:r})},this.ensureDir=e=>new Promise(((t,s)=>{$znode.fsExtra.ensureDir(e,1533,(e=>{if(e)return s(e);t()}))})),this.createDeferred=()=>{let e,t;return{promise:new Promise(((s,i)=>{e=s,t=i})),resolve:e,reject:t}},this.acquireTaskLock=async()=>{if(this.availableTask<=0){const e=this.createDeferred();this.requests.push(e),await e.promise}this.availableTask--},this.releaseTaskLock=()=>{if(this.availableTask=Math.min(this.MAX_REGEN_TASKS,this.availableTask+1),this.availableTask>0&&this.requests.length>0){this.requests.shift().resolve()}}}})||$c;i.ModuleContainer.registerSingleton(Yc.a,nl);var rl=s("tDXj"),ol=s("KweF");const cl=Object(i.define)("JIT_MEDIA_CODEC");var ll,dl=s("DhYn");let hl=Object(i.injectable)()(ll=class{constructor(){this._blobURLMapping=new Map,this._conversationCache=new Map}async preload(e,t,s){let i=e;if(this._isHttpURL(e))try{if(this._blobURLMapping.has(e))return Xc.k.Success({mediaURL:e});const t=Object(ol.i)().toString(),s=await Object(ol.h)(t,e,ol.a.dev,void 0,{useDiskCache:!1});if(s.error)return Xc.k.Failure({code:Xc.d.FAILURE_BY_FETCH,error:s.error});i=s.data}catch(a){return Xc.k.Failure({code:Xc.d.FAILURE_BY_FETCH,error:a})}else if(this._isBlobURL(e)){if(this._blobURLMapping.has(e))return Xc.k.Success({mediaURL:e});if(!(await this.isBlobURLAlive(e)))return Xc.k.Failure({code:Xc.d.FAILURE_BY_FETCH,error:"blob url expired"})}return this._cache(i,t,s),Xc.k.Success({mediaURL:i})}async isBlobURLAlive(e,t){const s=null!=t&&t.document?t.document.createElement("img"):new Image;s.src=e;try{return await s.decode(),!0}catch(i){return!1}}async preloadImageDOM(e,t){let s=0,a=null,n=1,r=t&&"async"!==(null==t?void 0:t.mode)&&"auto"!==(null==t?void 0:t.mode)?"sync":"async";const o=e.src,c=null==o?void 0:o.endsWith("jxl"),l=!!dl.a.jxl.enable_native_electron_jxl||!Object(tl.a)()&&dl.a.jxl.enable_native_electron_jxl;if(c&&!l)try{var d,h;const t=null===(d=e.rawSrc)||void 0===d||null===(h=d.replace("file://",""))||void 0===h?void 0:h.replace("zfile://",""),s=await i.ModuleContainer.resolve(cl).decodeLocalImage(t);if(!s)throw new Error("JXL decode failed. Empty url");e.src=s}catch(u){zconsole.zsymb(21,"YwQJs1",["Failed to decode JXL image","Jo2zEb"],u)}if("async"===r){n=2;try{return await this._preloadImageAsync(e)}catch(u){s++,a=u}}try{return await this.preloadImageSync(e)}catch(u){s++,a=u}if(s===n)throw new Error(`preloadImageDOM failed ${a}`);return null}async _preloadImageAsync(e){try{const t=new Image;t.draggable=!1;for(const s in e)s&&e[s]&&t.setAttribute(s,e[s]);return await t.decode(),t}catch(t){throw t}}async preloadImageSync(e){const t=new Image;t.draggable=!1;for(const a in e)a&&e[a]&&t.setAttribute(a,e[a]);const s=new Promise(((e,s)=>{t.onload=e,t.onerror=s}));try{return await s,t}catch(i){throw i}}_cache(e,t,s){if(this._blobURLMapping.set(e,{blobURL:e,cacheMode:t,convId:s}),s){const t=this._conversationCache.get(s)||[];t.push(e),this._conversationCache.set(s,t)}}_isHttpURL(e){return e.startsWith("http")||e.startsWith("https")}_isBlobURL(e){return e.startsWith("blob")}})||ll;i.ModuleContainer.registerSingleton(rl.a,hl);var ul=s("UeuQ"),gl=s("XDVU");function ml(e){return e.startsWith("http")||e.startsWith("https")}function pl(e){return e.startsWith("blob")}var fl=s("iD3V"),vl=s("tqrY");var _l,bl=s("Q8nW"),yl=s("Ageb"),Il=s("qvbK");let Sl=Object(i.injectable)()(_l=function(e,t){return Object(i.inject)(B.ZLoggerFactory)(e,void 0,0)}(_l=Reflect.metadata("design:type",Function)(_l=Reflect.metadata("design:paramtypes",[void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory])(_l=class{constructor(e){this.Logger=void 0,this.Logger=e.createZLogger(Ss.ZLoggerNametags.imageLoader,[Ss.ZLoggerNametags.mediaBlobFetcher])}async fetch(e){let{mediaId:t,source:s,options:i={}}=e;Object(gl.a)("string"==typeof s&&ml(s),`Media source must be a (http|https) URL. Got ${s}`);const a=Date.now();try{const e=Object(fl.a)(ol.h,{min:vl.a.image_loader.retryMin,max:vl.a.image_loader.retryMax,retries:3,lastTryDelayTime:{min:vl.a.image_loader.lastTryDelayTime.min,max:vl.a.image_loader.lastTryDelayTime.max},afterRetry:async({success:e,shouldRetry:t,nTry:s,duration:i})=>{e||this.Logger.zsymb(0,"xPcmAa",`MediaBlobFetcher: Try ${s}: failed. Should retry: ${t} after ${i}ms`),e||t||this.Logger.zsymb(0,"6DP9eo",`MediaBlobFetcher: Download failed after ${s} tries`)}});null!=i&&i.regenerateFromSource&&delete i.regenerateFromSource.getLocalPath;const c=Object(T.a)(Object(T.a)({cacheControl:"cache",useMemCache:!0,useDiskCache:!1},i),{},{convertible:Object(bl.g)(s)});if(null!=i&&i.regenerateFromSource){var n;c.regenerateJXL={outputWidth:null===(n=i.regenerateFromSource)||void 0===n?void 0:n.outputWidth};const e=i.regenerateFromSource.regenId;s=Object(bl.b)(i.regenerateFromSource.url,"regenw",i.regenerateFromSource.outputWidth.toString()),"cache"===c.cacheControl&&(c.useDiskCache="thumb"===e,c.useDiskCache&&(s=Object(yl.d)(s)))}const l=await e(Object(ol.i)().toString(),s,"dev",void 0,c,void 0,(e=>{if(!e)return null;const[t,s,i]=e.split(".");return{cliMsgId:t,fromUid:s,toUid:i}||null})(t),ol.c.IMAGE_COMPONENT);if(Object(bl.g)(s)&&l.data&&(Si.default.increaseSuccess(al.b,0,0),Si.default.increaseSuccess(al.a,0,0)),l.error||!l.data){var r;if(this.Logger.zsymb(0,"l_P_gP",`MediaBlobFetcher: fetch failed. ${t} ${s}. took: ${Date.now()-a}`,l.error,l.data,null==l||null===(r=l.error)||void 0===r?void 0:r.code),Object(Il.l)(l.error)){var o;const e=Object(Il.m)(null===(o=l.error)||void 0===o?void 0:o.code);if(e){const{qosCommand:t,errorCode:s}=e;Si.default.increaseFailed(t,0,0,s,a)}return Si.default.increaseFailed(al.a,0,0,Object(al.k)(),Date.now()),Xc.k.Failure({code:Xc.d.LIBJXL_ERROR,mediaURL:s,error:l.error})}return Xc.k.Failure({code:Xc.d.FAILURE_BY_FETCH,error:{mediaURL:s,error:l.error}})}return Xc.k.Success({mediaURL:l.data})}catch(c){return this.Logger.zsymb(0,"VlVnca",`MediaBlobFetcher: fetch caught error. ${t} ${s}. took: ${Date.now()-a}`,c,null==c?void 0:c.code),Xc.k.Failure({code:Xc.d.FAILURE_BY_FETCH,error:{mediaURL:s,error:c}})}}})||_l)||_l)||_l)||_l;i.ModuleContainer.registerSingleton(ul.a,Sl);var Cl,El=s("xQyS"),Ol=s("HOwT"),Tl=s("CI+W"),Ml=s("BDVO");const Rl=$znode.path;let wl=Object(i.injectable)()(Cl=class{constructor(){this._Logger=null,this._toJpeg=e=>".jxl"===$znode.path.extname(e)?e.replace(/\.jxl$/,".jpg"):e,this._downloadHandler=async e=>{const{localPath:t}=e,s=await Object(El.a)(Tl.loadPC,e),i=s.ok?t:"";if(s.ok)return{mediaURL:i,error:void 0};throw s.error},this._downloadWithRetry=Object(fl.a)(this._downloadHandler,{min:vl.a.image_loader.retryMin,max:vl.a.image_loader.retryMax,retries:3,lastTryDelayTime:{min:vl.a.image_loader.lastTryDelayTime.min,max:vl.a.image_loader.lastTryDelayTime.max},shouldRetryOnError:async({error:e})=>e instanceof Ol.NotReadyError||e instanceof Ol.TimeoutTTFB||e instanceof Ol.TimeoutError,afterRetry:async({success:e,shouldRetry:t,nTry:s,duration:i})=>{e||this.Logger.zsymb(0,"a8zTqc",`Try ${s}: failed. Should retry: ${t} after ${i}ms`),e||t||this.Logger.zsymb(0,"P2_pCD",`MediaDiskFetcher: Download failed after ${s} tries`)}})}get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger(Ss.ZLoggerNametags.imageLoader,[Ss.ZLoggerNametags.mediaDiskFetcher])),this._Logger}async fetch(e){let{mediaId:t,source:s,options:a}=e;Object(gl.a)(!!Rl,"Path module cannot be null"),Object(gl.a)("string"==typeof s&&ml(s),`Media source must be a http|https. Got ${s}`);const{entrySerial:n,savePath:r,regenerateFromSource:o}=a,c=!(".jxl"===$znode.path.extname(r)&&o);if(r&&Object(ne.a)(r)&&c)return Xc.k.Success({mediaURL:r});let l=!1,d="",h="";if(o){const{url:e,getLocalPath:t}=o;if(Object(gl.a)(!!t,"MediaDiskFetcher: regenerateFromSource.getLocalPath cannot be null"),Object(gl.a)(!!e,"MediaDiskFetcher: regenerateFromSource.url cannot be null"),d=await t(e),h=this._toJpeg(r),Object(ne.a)(h))return Xc.k.Success({mediaURL:h})}let u=null,g=null,m=null;try{const e=t.split(".");3===e.length&&(u=e[0],m=e[1],g=e[2])}catch(p){}if(o){const{url:e,getLocalPath:t,outputWidth:a,outputHeight:n}=o;if(Object(gl.a)(!!t,"MediaDiskFetcher: regenerateFromSource.getLocalPath cannot be null"),Object(gl.a)(!!e,"MediaDiskFetcher: regenerateFromSource.url cannot be null"),s=e,l=!0,d&&Object(ne.a)(d)){u&&il.b.log(u,{clientId:u,dest_id:g,srcId:m});const e=await i.ModuleContainer.resolve(Yc.a).regenImageFromLocal({priority:null==o?void 0:o.priority,getSourcePath:()=>Promise.resolve(d),getGenThumbPath:()=>Promise.resolve(h),sizes:{width:a,height:n},log:{clientId:u}});if("ERROR"!==e.type)return Xc.k.Success({mediaURL:e.data.mediaURL});this.Logger.zsymb(18,"pdT3wt","MediaDiskFetcher: regenerateFromSource failed",s,d,"->",r)}}try{let e={url:s,mediaId:t,localPath:l?d:r,entrySerial:n,sendDttm:null==a?void 0:a.sendDttm,noCacheRespFail:(null==a?void 0:a.sendDttm)&&Object(Ml.a)(null==a?void 0:a.sendDttm),options:{isLastFallbackUrl:a.isLastFallbackUrl}};!0===a.autoDownload&&(e.options=Object(T.a)(Object(T.a)({},e.options),{},{srcAction:mc.a.constants.srcAction.Auto})),this.Logger.zsymb(0,"Bd2DcQ",`MediaDiskFetcher: try fetch sendDttm:${e.sendDttm} ${e.url} -> ${e.localPath}. cacheFail:${e.noCacheRespFail}`),u&&il.a.log(u,{clientId:u,dest_id:g,srcId:m,msgFormat:$znode.path.extname(r)});const c=await this._downloadWithRetry(e);if(u&&il.a.endLog(u,{clientId:u}),c.error)return this.Logger.zsymb(18,"8s8wVv",`MediaDiskFetcher: error ${s} | ${e.localPath} -> ${JSON.stringify(c.error)}`),Xc.k.Failure({code:Xc.d.FAILURE_BY_FETCH,error:{mediaURL:s,error:c.error}});if(l){u&&il.b.log(u,{clientId:u,dest_id:g,srcId:m});const e=await i.ModuleContainer.resolve(Yc.a).regenImageFromLocal({priority:null==o?void 0:o.priority,getSourcePath:()=>Promise.resolve(d),getGenThumbPath:()=>Promise.resolve(h),sizes:{width:null==o?void 0:o.outputWidth,height:null==o?void 0:o.outputHeight},log:{clientId:u}});if("ERROR"!==e.type)return Xc.k.Success({mediaURL:e.data.mediaURL});this.Logger.zsymb(18,"S7V0PL","MediaDiskFetcher: regenerateFromSource failed",s,r,"->",r)}return Xc.k.Success({mediaURL:r})}catch(p){return this.Logger.zsymb(14,"5yGp0H",`MediaDiskFetcher: fetch throws unknown error ${s}`,p),Xc.k.Failure({code:Xc.d.FAILURE_BY_FETCH,error:{mediaURL:s,error:p}})}}})||Cl;var Ll;i.ModuleContainer.registerSingleton(ul.b,wl);let Fl=Object(i.injectable)()(Ll=class extends De.b{async fetch(e){const{mediaId:t,source:s,diskFetcherConfig:a,sendDttm:n,isLastFallbackUrl:r=!1,regenerateFromSource:o}=e;let c;Object(gl.a)("string"==typeof t,`MediaFetcherImpl: mediaId must be a string. Got ${t}`),Object(gl.a)("string"==typeof s,`MediaFetcherImpl: source must be a string. Got ${s}`),c=a&&a.savePath?Xc.i.DiskCache:Xc.i.MemoryCache;const l=ml(s),d=pl(s);if(!l&&d)return Xc.k.Success({mediaURL:s});if(!l&&!d){var h,u;const e=!d||["file://","zfile://"].some((e=>s.startsWith(e))),t=null==s||null===(h=s.replace("file://",""))||void 0===h?void 0:h.replace("zfile://","");if(e&&(null===(u=$znode.fs)||void 0===u?void 0:u.existsSync(t)))return Xc.k.Success({mediaURL:t});if(e)return Xc.k.Failure({code:Xc.d.FAILURE_BY_FETCH})}if(c===Xc.i.MemoryCache)try{return await i.ModuleContainer.resolve(ul.a).fetch({mediaId:t,source:s,options:{cacheControl:"cache",sendDttm:n,regenerateFromSource:o,isLastFallbackUrl:r,useDiskCache:!1,useMemCache:!0}})}catch(p){return Promise.reject(p)}Object(gl.a)("object"==typeof a&&"string"==typeof a.savePath&&!!a.downloadEntrySerial,`MediaFetcherImpl: invalid diskFetcherConfig. Got ${a}`);const{savePath:g,downloadEntrySerial:m}=a;return i.ModuleContainer.resolve(ul.b).fetch({mediaId:t,source:s,options:{entrySerial:m,savePath:g,sendDttm:n,regenerateFromSource:o,isLastFallbackUrl:r}})}async fetchSocialMediaStandalone(e){const{mediaId:t,source:s}=e;Object(gl.a)("string"==typeof t,`MediaFetcherImpl: mediaId must be a string. Got ${t}`),Object(gl.a)("string"==typeof s,`MediaFetcherImpl: source must be a string. Got ${s}`);const a=ml(s),n=pl(s);if(!a&&n)return Xc.k.Success({mediaURL:s});try{return await i.ModuleContainer.resolve(ul.a).fetch({mediaId:t,source:s,options:{cacheControl:"noCache"}})}catch(r){return Promise.reject(r)}}})||Ll;i.ModuleContainer.registerSingleton(ul.c,Fl);var Dl,Al=s("Evs5");let Nl=Object(i.injectable)()(Dl=class{constructor(){this.loadMedia=async(e,t)=>{const{mediaId:s,entry:i,qualityFallback:a,fetchStrategy:n}=e,{fetcher:r,diskCacheConfig:o,disableLocalCache:c}=n,l=null==t?void 0:t.onFirstAvailable;let d=a,h=null;const u=new Set;let g=!1;for(;d;){const t=d.data.url,a=d.data.getLocalPath;let p=d.data.regenerateFromSource;if(!t){d=d.nextOR||d.next;continue}const f=!d.nextOR&&!d.next;if(u.has(t)&&!f){d=d.nextOR||d.next;continue}g=!0;const v=await this._buildFetchConfig({mediaId:s,entry:i,source:t,getLocalPath:()=>null==a?void 0:a(t),downloadEntrySerial:null==o?void 0:o.downloadEntrySerial,autoDownload:!!h,sendDttm:e.sendDttm,isLastFallbackUrl:f,regenerateFromSource:p,disableLocalCache:c}),_=await r(v);if("ERROR"==_.type){if(_.data.error&&Object(Il.l)(_.data.error))return Xc.k.Failure({code:Xc.d.LIBJXL_ERROR,error:_.data.error});u.add(t),d=d.nextOR||d.next;continue}let b=null,y=null,I=null;try{const t=e.mediaId.split(".");3===t.length&&(b=t[0],y=t[1],I=t[2])}catch(m){}if(b&&il.c.log(b,{msgFormat:Object(bl.g)(t)?".jxl":".jpg"}),!h&&(h={mediaURL:_.data.mediaURL},null==l||l(Xc.k.Success(h)),!n.fetchAllAvailable))break;d=d.next}return g?null===h?Xc.k.Failure({code:Xc.d.FAILURE_BY_FETCH,error:s}):Xc.k.Success(h):Xc.k.Failure({code:Xc.d.EMPTY_SOURCE,error:s})},this._buildFetchConfig=async e=>{Object(gl.a)(!!e&&"object"==typeof e,`_buildDownloadConfig: config must be object, got ${e}`);const t=Object(e);Object(gl.a)("string"==typeof t.mediaId,`_buildDownloadConfig: mediaId must be string, got ${null==t?void 0:t.mediaId}`),Object(gl.a)(t.entry in Xc.j,`_buildDownloadConfig: entry must be MediaDisplayTarget, got ${null==t?void 0:t.entry}`),Object(gl.a)("string"==typeof t.source,`_buildDownloadConfig: source must be string, got ${null==t?void 0:t.source}`);const s={mediaId:t.mediaId,source:t.source,sendDttm:t.sendDttm,isLastFallbackUrl:t.isLastFallbackUrl,regenerateFromSource:t.regenerateFromSource,entry:t.entry};if(t.getLocalPath&&!t.disableLocalCache){const e=await t.getLocalPath();s.diskFetcherConfig={savePath:e,downloadEntrySerial:t.downloadEntrySerial,autoDownload:t.autoDownload}}return s}}abort(e,t){}})||Dl;i.ModuleContainer.registerSingleton(Al.a,Nl);var kl=s("UD1y"),Pl=s("OgkW"),jl=s.n(Pl);const Ul={FORWARD_MESSAGE:"FORWARD_MESSAGE",DOWNLOAD_MESSAGE:"DOWNLOAD_MESSAGE",ROTATE_LEFT:"ROTATE_LEFT",ROTATE_RIGHT:"ROTATE_RIGHT",ZOOM_IN:"ZOOM_IN",RESET_ZOOM:"RESET_ZOOM",MORE_MEDIA_ACTION:"MORE_MEDIA_ACTION",RELOAD_MEDIA:"RELOAD_MEDIA"};var Bl,Gl=s("fB1t"),zl=s("Ms/M"),xl=s("c3KS");class Vl{constructor(){this.aborted=void 0,this.aborted=!0}}class Hl{constructor(e,t=[]){this._task=e,this.args=t,this._abortController=void 0,this._aborted=!1,this._fulfilled=!1,this._promise=null,this._abortableTask=void 0,this.abort=()=>{this._abortController.abort()},this._abortController=new AbortController,this._abortableTask=(...e)=>new Promise(((t,s)=>{const i=()=>{this._aborted=!0,s(new Vl),this._abortController.signal.removeEventListener("abort",i)};this._abortController.signal.addEventListener("abort",i),this._task(...e).then(t).catch(s).finally((()=>{this._abortController.signal.removeEventListener("abort",i),this._fulfilled=!0}))}))}get aborted(){return this._aborted}get fulfilled(){return this._fulfilled}get promise(){return this._promise||(this._promise=this._abortableTask(...this.args)),this._promise}}function ql(e,...t){return new Hl(e,t)}class Wl{constructor(e,t){this.taskId=e,this.executor=t}}class Zl{constructor(e){this.limit=void 0,this.runningTasks=void 0,this.taskQueue=void 0,this.taskMap=void 0,this.isRunning=e=>this.runningTasks.has(e),this.abortTask=e=>{const t=this.taskMap.get(e);t&&(t.executor.abort(),this.removeTask(e))},this.limit=e,this.runningTasks=new Set,this.taskQueue=[],this.taskMap=new Map}addTask(e){this.runningTasks.has(e.taskId)||(this.taskMap.has(e.taskId)&&(this.taskQueue=this.taskQueue.filter((t=>t.taskId!==e.taskId))),this.taskQueue.push(e),this.taskMap.set(e.taskId,e),this._tryToRunTasks())}removeTask(e){this.runningTasks.has(e)||this.taskMap.has(e)&&(this.taskQueue=this.taskQueue.filter((t=>t.taskId!==e)),this.taskMap.delete(e))}_tryToRunTasks(){if(!(this.runningTasks.size>=this.limit))for(;this.runningTasks.size<this.limit&&this.taskQueue.length>0;){const e=this.taskQueue.pop();e&&(this.taskMap.delete(e.taskId),this._runTask(e))}}_runTask(e){this.runningTasks.add(e.taskId),e.executor.promise.then((()=>{this._taskFinished(e.taskId)})).catch((()=>{this._taskFinished(e.taskId)}))}_taskFinished(e){this.runningTasks.delete(e),this._tryToRunTasks()}}Object(i.injectable)()(Bl=Object(ie.b)(kl.b)(Bl=function(e,t){return Object(i.inject)(Al.a)(e,void 0,0)}(Bl=function(e,t){return Object(i.inject)(m.a)(e,void 0,1)}(Bl=function(e,t){return Object(i.inject)(ul.c)(e,void 0,2)}(Bl=Reflect.metadata("design:type",Function)(Bl=Reflect.metadata("design:paramtypes",[Object,void 0===m.a?Object:m.a,Object])(Bl=class{constructor(e,t,s){this.mediaPackageManager=e,this.application=t,this.mediaFetcher=s,this._revokedBlobURL=new Map,this._activeContextWindow=null,this._retryItems=new h.default({maxSize:1e3}),this.TaskQueue=new Zl(300),this._eventEmitter=new jl.a,this.MAX_RETRIES=4,this.setActiveWindowContext=e=>("WeakRef"in globalThis?this._activeContextWindow=new globalThis.WeakRef(e):this._activeContextWindow=e,this.removeActiveWindowContext),this.removeActiveWindowContext=()=>{this._activeContextWindow=null},this.getActiveWindowContext=()=>this._activeContextWindow instanceof globalThis.WeakRef?this._activeContextWindow.deref():this._activeContextWindow,this.manualRetry=async(e,t,s=!1)=>{var i,a,n;const r=this.data.get(e),o=`${e}-${t}`;(null==r||null===(i=r.failure)||void 0===i?void 0:i.code)===Xc.d.FORCE_EXPIRE||this.TaskQueue.isRunning(o)||(this._retryable(o)||s?r&&(s&&this._retryItems.set(o,0),this._handleRevokeURL({payload:{blobURL:null==r||null===(a=r.view[t])||void 0===a?void 0:a.actual,mediaId:e}}),this._handleRevokeURL({payload:{blobURL:null==r||null===(n=r.view[t])||void 0===n?void 0:n.expected,mediaId:e}}),null==r||delete r.view[t],null==r||delete r.failure,this.data.set(e,r),this.emit(Ul.RELOAD_MEDIA,{mediaId:e,entry:t,hotSwapSource:!0})):this.forceError(e,t))},this.forceError=(e,t)=>{const s=this.data.get(e)||{mediaId:e,view:{}},i=(null==s?void 0:s.view)||{};this.data.set(e,Object(T.a)(Object(T.a)({},s),{},{view:Object(T.a)(Object(T.a)({},i),{},{[t]:{failure:{code:Xc.d.FORCE_ERROR,message:"Force error"}}})})),this._signalRenderItem(this.name,e)},this.loadMedia=async(e,t={})=>{const s=ql(this._loadMedia,e,t),i=`${e.mediaId}-${e.entry}`,a=new Wl(i,s);this.TaskQueue.addTask(a)},this._loadMedia=async(e,t={})=>{var s,i,a;const{forceLoad:n=!1}=t,r=(e.mediaId,e.entry,this.data.get(e.mediaId));if(globalThis.__alwaysForcePhotoExpired)return this.forceExpire(e.mediaId);const o=this._revokedBlobURL.get(e.mediaId),c=null==r||null===(s=r.view)||void 0===s?void 0:s[e.entry],l=!(null==c||!c.actual||null!=o&&o.has(c.actual)),d=[Xc.e.EmptySource,Xc.e.ZaloSource,Xc.e.ExpiredSource];if(l&&d.some((e=>e===c.dataSrcId))||null!=r&&r.failure&&!1===n)return;if(this._mayInitState(e,!0),null!==(i=e.uploadSource)&&void 0!==i&&null!==(a=i.oriUrl)&&void 0!==a&&a.startsWith("blob:"))return void this._updateViewUpload(e.mediaId,e.entry,e.uploadSource);let h=null,u=null,g=null;try{const t=e.mediaId.split(".");3===t.length&&(h=t[0],u=t[1],g=t[2])}catch(m){}h&&il.c.log(h,{clientId:h,dest_id:g,srcId:u});try{let s=!1;const i=this.data.get(e.mediaId),a=Object(T.a)(Object(T.a)({},t),{},{expiryCheck:e.expiryCheck}),n=await this.mediaPackageManager.loadMedia(e,{hasHd:null==i?void 0:i.hasHd,skipHdCheck:null==i?void 0:i.hasHd,onFirstAvailable:t=>{s=!0,this._handleLoadResponse(e.mediaId,e.entry,t,a)}});s||this._handleLoadResponse(e.mediaId,e.entry,n,a)}catch(m){h&&il.c.endLog(h,{clientId:h,dest_id:g,srcId:u,renderStatus:0})}},this._retryable=e=>!((this._retryItems.get(e)||0)>=this.MAX_RETRIES||this.TaskQueue.isRunning(e)),this.runFullflow=(e,t)=>{var s;const i=this.data.get(e),a=`${e}-${t}`;if((null==i||null===(s=i.failure)||void 0===s?void 0:s.code)===Xc.d.FORCE_EXPIRE||this.TaskQueue.isRunning(a))return;if(!this._retryable(a))return void this.forceError(e,t);this.abanbonMedia(e,t);const n=this._retryItems.get(a)||0;this._retryItems.set(a,n+1),this.manualRetry(e,t)},this.loadDOMSuccess=(e,t)=>{try{const t=e.split(".");if(t.length){const e=t[0];il.c.endLog(e,{renderStatus:1})}}catch(s){}this._retryItems.delete(`${e}-${t}`)},this.loadDOMError=(e,t)=>{},this._signalRenderItem=(...e)=>{Object(Zs.g)(...e)},this._triggerError=e=>{0},this._triggerExpired=e=>{const t=Gl.a.get(e.mediaId);if(t){const s=e.mediaId.split(".");"0"==s[1]&&(s[1]=ye.p.getSessionUserId()),"0"==s[2]&&(s[2]=ye.p.getSessionUserId());const i=s.join("_"),a=Object(T.a)({metaId:i},t);zl.a.dispatchEvent(new xl.a(xl.b.WriteDB,{message:a,result:{isExpired:!0,autoDownloadPath:""}}))}},this._handleRevokeURL=e=>{const t=null==e?void 0:e.payload;Object(gl.a)(!!t,"ImageLoaderController: revoke event payload undefined");const{blobURL:s,mediaId:i}=t;s&&URL.revokeObjectURL(s)},this.listenEvents=()=>{this.application.addEventListener(m.b.Exit,this._cleanupEvents)},this._cleanupEvents=()=>{this.application.removeEventListener(m.b.Exit,this._cleanupEvents)},this.name=kl.a,this.data=new Map,this.key="mediaId",this.init=()=>{this.listenEvents(),this._eventEmitter.setMaxListeners(50)},this.init()}on(e,t){return this._eventEmitter.on(e,t),()=>this._eventEmitter.off(e,t)}off(e,t){this._eventEmitter.off(e,t)}emit(e,t){this._eventEmitter&&e in Ul&&this._eventEmitter.emit(e,t)}getViewState(e,t){var s,i;return null===(s=this.data.get(e))||void 0===s||null===(i=s.view)||void 0===i?void 0:i[t]}allowOutviewUpdate(e,t){const s=this.data.get(e),i=null==s?void 0:s.view[t];i&&(i.dataSrcId!==Xc.e.Upload||i.expected)?i.actual!==i.expected&&Boolean(i.expected)&&(this.data.set(e,Object(T.a)(Object(T.a)({},s),{},{view:Object(T.a)(Object(T.a)({},null==s?void 0:s.view),{},{[t]:Object(T.a)(Object(T.a)({},i),{},{actual:i.expected,dataSrcId:Xc.e.ZaloSource})})})),this._signalRenderItem(this.name,e),this._runCleanup(e,i.actual)):this.emit("RELOAD_MEDIA",{mediaId:e,entry:t,hotSwapSource:!0,forceLoad:!0})}forceExpire(e){var t;const s=this.data.get(e)||{mediaId:e,view:{}};(null==s||null===(t=s.failure)||void 0===t?void 0:t.code)!==Xc.d.FORCE_EXPIRE&&(this.data.set(e,Object(T.a)(Object(T.a)({},s),{},{failure:{code:Xc.d.FORCE_EXPIRE,message:"Force expire"},view:{}})),this._signalRenderItem(this.name,e))}abort(e){const t=this._retryItems.get(e)||0;this._retryItems.set(e,Math.max(t-1,0)),this.TaskQueue.abortTask(e)}rotateMedia(e,t){let s=this.data.get(e);if(!s)throw new Error(`rotateMedia failed with ${e}: ${t}`);let i=s.rotateDeg||0;i+=t,s=Object(T.a)(Object(T.a)({},s),{},{rotateDeg:i}),this.data.set(e,s),this._signalRenderItem(this.name,e)}abanbonMedia(e,t){if(!this.data.has(e))return;const s=this.data.get(e);null!=s&&s.view[t]&&(delete s.view[t],this.data.set(e,Object(T.a)({},s)),this._signalRenderItem(this.name,e))}clearItemData(e,t,s){const i=this.data.get(e);i&&(delete i.view[t],this.data.set(e,i),!0===(null==s?void 0:s.signalRenderItem)&&this._signalRenderItem(this.name,e))}_runCleanup(e,t){if(!t||!t.startsWith("blob:"))return;const s=this.data.get(e);if(!s)return void URL.revokeObjectURL(t);const i=s.view;Object.values(i).forEach((e=>{e.actual!==t&&e.expected})),URL.revokeObjectURL(t)}_mayInitState(e,t=!0){let s=this.data.get(e.mediaId);s||(s={mediaId:e.mediaId,view:{},rotateDeg:90*e.vOrient},this.data.set(e.mediaId,s)),t||this._signalRenderItem(this.name,e.mediaId)}_handleLoadResponse(e,t,s,i){switch(s.type){case"ERROR":this._handleLoadError(s,e,t,i);break;case"SUCCESS":this._handleLoadSuccess(s,e,t,i);break;default:throw new Error(`Unknown response type: ${e} ${t} got ${null==s?void 0:s.type}`)}}_handleLoadError(e,t,s,i={}){const a=e.data;switch(a.code){case Xc.d.FAILURE_BY_FETCH:{var n;const e=this.data.get(t);e.view=Object(T.a)(Object(T.a)({},e.view),{},{[s]:Object(T.a)(Object(T.a)({},e.view[s]),{},{failure:{code:a.code,message:a.error}})}),this.data.set(t,e);!0===(null==i||null===(n=i.expiryCheck)||void 0===n?void 0:n.call(i))?this._triggerExpired({mediaId:t}):this._triggerError({mediaId:t}),this._signalRenderItem(this.name,t);break}case Xc.d.FAILURE_BY_PRELOAD:{const e=this.data.get(t);e.view=Object(T.a)(Object(T.a)({},e.view),{},{[s]:Object(T.a)(Object(T.a)({},e.view[s]),{},{failure:{code:a.code,message:a.error}})}),this.data.set(t,e),this._signalRenderItem(this.name,t);break}case Xc.d.EMPTY_SOURCE:{const e=this.data.get(t);e.view=Object(T.a)(Object(T.a)({},e.view),{},{[s]:Object(T.a)(Object(T.a)({},e.view[s]),{},{failure:{code:a.code,message:a.error}})}),this.data.set(t,e),this._signalRenderItem(this.name,t);break}case Xc.d.LIBJXL_ERROR:this.forceError(t,s)}}async _updateViewUpload(e,t,s){var a,n,r,o,c,l,d;if(null==s||!s.oriUrl)return;let h=this.data.get(e);const u=await i.ModuleContainer.resolve(rl.a).isBlobURLAlive(s.oriUrl,this.getActiveWindowContext());let g=s.oriUrl;if(u||!s.file||null!==(a=h)&&void 0!==a&&null!==(n=a.view)&&void 0!==n&&null!==(r=n[t])&&void 0!==r&&r.actual){if(null!==(o=h)&&void 0!==o&&null!==(c=o.view)&&void 0!==c&&null!==(l=c[t])&&void 0!==l&&l.actual)return}else g=URL.createObjectURL(s.file);h?(null===(d=h.view[t])||void 0===d?void 0:d.actual)!==g&&Boolean(g)&&(h=Object(T.a)(Object(T.a)({},h),{},{view:Object(T.a)(Object(T.a)({},h.view),{},{[t]:{actual:g,expected:g,dataSrcId:Xc.e.Upload}})})):h={mediaId:e,view:{[t]:{actual:g,expected:g,dataSrcId:Xc.e.Upload}}},this.data.set(e,h),this._signalRenderItem(this.name,e)}_updateView(e,t,s,i){if(!s)return;const a=this.data.get(e),n=a.view[t],r=this._revokedBlobURL.get(e);if(!n||!Boolean(n.actual)||n.actual&&null!=r&&r.has(n.actual))a.view=Object(T.a)(Object(T.a)({},a.view),{},{[t]:{actual:s,expected:s,dataSrcId:Xc.e.ZaloSource}}),this.data.set(e,a);else if(Boolean(n.actual)&&n.actual!==s){const i=Object(T.a)(Object(T.a)({},n),{},{expected:s});a.view=Object(T.a)(Object(T.a)({},a.view),{},{[t]:i}),this.data.set(e,a)}if(null!=i&&i.hotSwapSource){var o;const i=this.data.get(e);this.data.set(e,Object(T.a)(Object(T.a)({},i),{},{view:Object(T.a)(Object(T.a)({},null==i?void 0:i.view),{},{[t]:Object(T.a)(Object(T.a)({},null==i||null===(o=i.view)||void 0===o?void 0:o[t]),{},{actual:s,expected:s,dataSrcId:Xc.e.ZaloSource})})}))}this._signalRenderItem(this.name,e)}_handleLoadSuccess(e,t,s,i){const a=e.data;this._updateView(t,s,a.mediaURL,i)}getItem(e){return this.data.get(e.key)}getList(e){return"all"===e.key?Array.from(this.data.keys()):[]}onGetItemFailure(e){}onGetListFailure(e){}})||Bl)||Bl)||Bl)||Bl)||Bl)||Bl);s("vUp1");var Kl,Ql=s("Mf7h"),$l=s("8c0e"),Yl=s("alF8");const Jl=new A.LocalId;Object(i.injectable)()(Kl=Object(i.singleton)($l.a)(Kl=class{constructor(){this._linkPreviewDatas=new Map,this._lastCheckLinks=new Map,this._listeners=new Map}addListenerAtConv(e,t){if(e&&"function"==typeof t){const s=this._listeners.get(e);this._listeners.set(e,[...s||[],t])}}removeListenerAtConv(e,t){let s=this._listeners.get(e);s&&s.length>0&&(s=s.filter((e=>e!==t)),this._listeners.set(e,s))}removeAllListenerAtConv(e){this._listeners.delete(e)}setLastCheckLinkByConvId(e,t){this._lastCheckLinks.set(e,t)}isLastCheckLinkOfConv(e,t){const s=this._lastCheckLinks.get(e);return!!s&&Yl.a.isEqualUrl(s,t)}getLinkPreviewDataByConvId(e){return this._linkPreviewDatas.get(e)||null}addLinkDataToConv(e,t){const s=this._prepareLinkPreviewData(e,t);this._linkPreviewDatas.set(e,Object(T.a)({},s));const i={action:P.LinkPreviewActions.NEW_LINK_PREVIEW,payload:{newLinkPreviewData:Object(T.a)({},s)}};this._notifyLinkPreviewDataChangeToConv(e,i),Ql.a.emit(P.LinkPreviewActions.NEW_LINK_PREVIEW,{newLinkPreviewData:Object(T.a)({},s)})}createLoadingLinkPreview(e,t){const s={id:Jl.next(),convId:e,content:{title:ni.default.str("STR_GETTING_LINK_INFO"),src:t,desc:"",thumb:"",loading:!0},link:t,shouldParseLinkOrContact:!0};e&&this._linkPreviewDatas.set(e,Object(T.a)({},s));const i={action:P.LinkPreviewActions.NEW_LINK_PREVIEW,payload:{newLinkPreviewData:Object(T.a)({},s)}};this._notifyLinkPreviewDataChangeToConv(e,i),Ql.a.emit(P.LinkPreviewActions.NEW_LINK_PREVIEW,{newLinkPreviewData:Object(T.a)({},s)})}removeLinkPreviewData(e){if(!e)return;this._linkPreviewDatas.delete(e);const t={action:P.LinkPreviewActions.HIDE_LINK_PREVIEW,payload:null};this._notifyLinkPreviewDataChangeToConv(e,t),Ql.a.emit(P.LinkPreviewActions.HIDE_LINK_PREVIEW,null)}_notifyLinkPreviewDataChangeToConv(e,t){const s=this._listeners.get(e);null==s||s.forEach((e=>{"function"==typeof e&&e({action:t.action,payload:t.payload})}))}_prepareLinkPreviewData(e,t){return{id:Jl.next(),convId:e,link:t.link,content:t.content,shouldParseLinkOrContact:!1}}})||Kl);var Xl,ed=s("iy3m"),td=s("twqL");Object(m.j)()(Xl=Object(i.singleton)(td.a)(Xl=Reflect.metadata("design:type",Function)(Xl=Reflect.metadata("design:paramtypes",[])(Xl=class{constructor(){this.changeTimeFlushNotiReactWhenResumeApp=this.changeTimeFlushNotiReactWhenResumeApp.bind(this),this.changeTimeFlushNotiReactWhenDisNetwork=this.changeTimeFlushNotiReactWhenDisNetwork.bind(this),this.changeTimeFlushNotiReactWhenStartApp=this.changeTimeFlushNotiReactWhenStartApp.bind(this)}onStart(e){this.changeTimeFlushNotiReactWhenStartApp()}changeTimeFlushNotiReactWhenResumeApp(){this.changeTimeFlushNotiReact(Object(ed.d)())}setupTimer(e){sn.b.TimeFlushNotiReact=e,sn.b.TimeMaxWaiting=Object(ed.a)(),sn.b.setupIntervalToFlushNotiReact(),sn.b.setupTimeoutToGoBackNormalCondition()}changeTimeFlushNotiReactWhenDisNetwork(e){if(e===Fn.a.CONNECTED){const e=Fn.b.getPreStateNetwork();e!==Fn.a.CONNECTED&&e!==Fn.a.NOT_SET&&this.changeTimeFlushNotiReact(Object(ed.b)())}}changeTimeFlushNotiReactWhenStartApp(){this.changeTimeFlushNotiReact(Object(ed.e)())}changeTimeFlushNotiReact(e){sn.b.notiReactTimeoutId?(sn.b.TimeFlushNotiReact!==e&&(sn.b.TimeFlushNotiReact=e,sn.b.setupIntervalToFlushNotiReact()),sn.b.TimeMaxWaiting!==Object(ed.a)()&&(sn.b.TimeMaxWaiting=Object(ed.a)(),sn.b.setupTimeoutToGoBackNormalCondition())):this.setupTimer(e)}})||Xl)||Xl)||Xl);var sd=s("5cla"),id=s("WV6O");class ad{static resetNewFriendList(){delete this.newListFriend,this.newListFriend=void 0}static addNewFriendUid(e){void 0===this.newListFriend&&this.getNewFriendList(),this.newListFriend.push(e)}static getNewFriendList(){_t.default.removeNewFriend("",!0);let e=[];try{const t=n.default.getInstance().getItemForCurrentUser("f_nf");t&&(e=JSON.parse(t))}catch(t){}this.newListFriend=e.map((e=>e.userId))}static getFriendList(e){const{userId:t}=e,s=[];return new Promise(((e,i)=>{Z.default.getFriends().then((i=>{if(i){const a=Boolean(ti.g.getConfigShowAllUser(t));for(let e=0;e<i.length;e++)(1===i[e].isFr||i[e].isFr||i[e].userId===U.default.supportPage)&&i[e].userId!=t&&i[e].isValid&&i[e].userId!=U.default.sendToMeId&&(a||i[e].isActive||i[e].isActivePC||i[e].isActiveWeb)&&s.push(i[e].userId);e(s)}else e([])})).catch((e=>i(e)))}))}static getFriendInfo(e){var t;const{userId:s}=e,i=Z.default.getProfileFriendSync(s);return i?(void 0===this.newListFriend&&this.getNewFriendList(),{userId:i.userId,avatar:i.avatar,displayName:i.displayName,isFr:i.isFr,zaloName:i.zaloName,bizPkg:i.bizPkg,bizInfo:i.bizInfo,isNewFriend:(null===(t=this.newListFriend)||void 0===t?void 0:t.includes(s))||!1,isBlocked:i.isBlocked}):null}}ad.newListFriend=void 0;class nd{static getGroupList(){return Fe.default.getGroupsList()}static getGroupInfo(e){const{userId:t}=e;return new Promise(((e,s)=>{Fe.default.getGroupById(t).then((t=>{e({userId:t.userId,avatar:t.avatar,displayName:t.displayName,topMember:t.topMember,totalMember:t.totalMember,creatorId:t.creatorId})})).catch(s)}))}static getGroupInfoSync(e){const{userId:t}=e,s=Fe.default.getGroupByIdSync(t);return s?{userId:s.userId,avatar:s.avatar,displayName:s.displayName,topMember:s.topMember,totalMember:s.totalMember,creatorId:s.creatorId}:null}}class rd{static getRecommendFriendList(){return new Promise(((e,t)=>{Ni.default.getRecommendedFriends().then((t=>e(t.recommItems))).catch(t)}))}static getRelatedGroup(e){return new Promise(((t,s)=>{Ni.default.getRelatedGroup(e).then(t).catch(s)}))}static getRequestedFriendList(){return new Promise(((e,t)=>{Ni.default.getRequestedFriends().then(e).catch(t)}))}static acceptAddFriend(e){return Qi.a.acceptAddFriend(e)}static rejectAddFriend(e){return Qi.a.rejectRequestAddFriend(e)}static makeUndoSentRequestFriend(e){return Qi.a.undoRequestAddFriend(e.userId)}static removeSuggestFriend(e){return new Promise(((t,s)=>{Ni.default.removeRecommendedFriendV2(e.uid,e.src,e.type).then(t).catch(s)}))}}var od;const cd={currentView:id.f.FRIEND_LIST,unread:{newFriendRequests:[],newGroupRequests:[],newGroupInvitations:new Set,isUnread:!1}},ld="1",dd="ctt_l_a",hd="ctt_l_r",ud="ctt_u_ginv";Object(ie.b)(sd.b)(od=Reflect.metadata("design:type",Function)(od=Reflect.metadata("design:paramtypes",[])(od=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.currentTab=void 0,this.data=new Map,this._Logger=void 0,this.name=sd.a,this.key=sd.a,this.data.set(ld,cd),this.currentTab=""}get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger(Ss.ZLoggerNametags.contactTabV2,[this.name])),this._Logger}_updateState(e,t=ld,s=!0){this.data.set(t,e),s&&Object(Zs.g)(this.name,t)}_getState(e=ld){return this.data.get(e)}_getAccessTime(){try{return JSON.parse(n.default.getInstance().getItemForCurrentUser(dd))}catch(e){return this.Logger.zsymb(18,"y81IdO","[_getAccessTime], error: "+JSON.stringify(e)),null}}_setAccessTime(e){n.default.getInstance().setItemForCurrentUser(dd,JSON.stringify(e))}_setLastRequestFriendTime(e,t,s){let i=[];try{i=JSON.parse(n.default.getInstance().getItemForCurrentUser(hd))||[]}catch(r){this.Logger.zsymb(18,"Gcy5c1","[_setLastRequestFriendTime], error: "+JSON.stringify(r))}let a=[];switch(e){case"NEW":i.find((e=>(null==e?void 0:e.userId)===s))?(a=i.filter((e=>e.userId!==s)),a=[{ts:t,userId:s},...i]):a=[{ts:t,userId:s},...i];break;case"REMOVE":a=i.filter((e=>e.userId!==s))}n.default.getInstance().setItemForCurrentUser(hd,JSON.stringify(a))}_setLastReceivedGroupInvitationTime(e,t,s){let i=[];try{const e=n.default.getInstance().getItemForCurrentUser(ud);i=e&&JSON.parse(e)||[]}catch(r){this.Logger.zsymb(18,"5N0nzt","[_setListReceivedGroupInvitationTime], error: "+JSON.stringify(r))}let a=[];switch(e){case"NEW":i.some((e=>(null==e?void 0:e.groupId)==s))&&(a=i.filter((e=>e.groupId!=s))),a=[{ts:t,groupId:s},...i];break;case"REMOVE":a=i.filter((e=>(null==e?void 0:e.groupId)!==s))}n.default.getInstance().setItemForCurrentUser(ud,JSON.stringify(a))}_getLastRequestAddFriendTime(){let e;try{e=JSON.parse(n.default.getInstance().getItemForCurrentUser(hd))}catch(t){this.Logger.zsymb(18,"pKFQXN","[_getLastRequestAddFriendTime], error: "+JSON.stringify(t))}return e?e[0]:null}_getLastReceivedGroupInvitationTime(){let e;try{const t=n.default.getInstance().getItemForCurrentUser(ud);e=t?JSON.parse(t):null}catch(t){this.Logger.zsymb(18,"jg45Md","[_getLastReceivedGroupInvitationTime], error: "+JSON.stringify(t))}return e?e[0]:null}_onChangeView(e){switch(i.ModuleContainer.resolve(Ks.SidebarController).updateSelectedId(null),e){case id.f.FRIEND_LIST:Object(xs.f)({type:P.SideBarActions.SELECT_FRIEND_LIST,payload:{userId:"999"}});break;case id.f.GROUP_LIST:Object(xs.f)({type:P.SideBarActions.SELECT_GROUP_CENTER,payload:{userId:"999"}});break;case id.f.FRIEND_REQUEST:Object(xs.f)({type:P.SideBarActions.SELECT_FRIEND_CENTER,payload:{userId:"999"}}),this._clearUnreadOnOpenView();break;case id.f.GROUP_INVITATION:Object(xs.f)({type:P.SideBarActions.SELECT_GROUP_INVITATION_CENTER,payload:{userId:"999"}}),this._clearUnreadOnOpenView()}}_onUpdateUnreadRequest(e,t){const s=this._getState();if(!s)return;let i=s.unread;switch(t){case"FRIEND":s.currentView!==id.f.FRIEND_REQUEST&&(i.newFriendRequests.push(e),i.isUnread=!0);break;case"GROUP":i.newGroupRequests.push(e);break;case"GROUP_INV":U.default.group_privacy.invitation_box.enable&&s.currentView!==id.f.GROUP_INVITATION&&(i.newGroupInvitations.add(e),i.isUnread=!0)}this._updateState(Object(T.a)(Object(T.a)({},s),{},{unread:i}),ld,!0)}_clearUnreadOnOpenView(){const e=this._getState();if(!e)return;let t=e.unread;if(e.currentView===id.f.GROUP_INVITATION){t.newGroupInvitations.size>0&&(t.isUnread=!1),t.newGroupInvitations.clear();const e=this._getLastReceivedGroupInvitationTime();e&&n.default.getInstance().setItemForCurrentUser(ud,JSON.stringify([e]))}else t.newFriendRequests.length+t.newGroupRequests.length>0&&(t.isUnread=!1),t.newFriendRequests=[],t.newGroupRequests=[];this._updateState(Object(T.a)(Object(T.a)({},e),{},{unread:t}),ld,!0)}_clearGroupInvitationUnreadItem(e){const t=this._getState();if(!t)return;let s=t.unread;s.newGroupInvitations.delete(e);0===s.newGroupInvitations.size+s.newFriendRequests.length+s.newGroupRequests.length&&(s.isUnread=!1),this._updateState(Object(T.a)(Object(T.a)({},t),{},{unread:s}),ld,!0)}_clearFriendRequestUnreadItem(){const e=this._getState();if(!e)return;let t=e.unread;t.newFriendRequests=[],t.newGroupRequests=[],0===t.newGroupInvitations.size&&(t.isUnread=!1),this._updateState(Object(T.a)(Object(T.a)({},e),{},{unread:t}),ld,!0)}init(e){throw new Error("Method not implemented.")}getItem(e,t){return this._getState(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}resetTabData(){this.currentTab="",ad.resetNewFriendList(),i.ModuleContainer.resolve(sd.b).resetData(),i.ModuleContainer.resolve(sd.f).resetData(),i.ModuleContainer.resolve(sd.e).resetData(),i.ModuleContainer.resolve(sd.k).resetData(),i.ModuleContainer.resolve(sd.i).resetData(),i.ModuleContainer.resolve(sd.n).resetData()}resetData(){const e=this._getState();e&&this._updateState(Object(T.a)(Object(T.a)({},e),{},{currentView:id.f.FRIEND_LIST}))}changeView(e){const t=this._getState();t&&this._updateState(Object(T.a)(Object(T.a)({},t),{},{currentView:e}),ld,!0),this.currentTab=e,this._onChangeView(e)}onClickContabTabEntry(){if(document.getElementById("ContactTabV2")){const e=this._getState(),t=(null==e?void 0:e.currentView)||cd.currentView;this._onChangeView(t)}}onContactTab(e){this._setAccessTime(e),this._clearUnreadOnOpenView()}getDefaultView(){if(this.currentTab)return this.currentTab;const e=this._getAccessTime(),t=this._getLastRequestAddFriendTime(),s=this._getLastReceivedGroupInvitationTime();if(!t)return U.default.group_privacy.invitation_box.enable&&s&&s.ts>=D.default.getTimeNow()-U.default.group_privacy.invitation_box.max_auto_focus_time?this.currentTab=id.f.GROUP_INVITATION:this.currentTab=id.f.FRIEND_LIST,this.currentTab;const i=!U.default.contactTabV2.enable_rule_last_view_friend_req||e&&t.ts<e,a=t.ts<D.default.getTimeNow()-864e5;return U.default.group_privacy.invitation_box.enable&&s&&s.ts>t.ts&&s.ts>=D.default.getTimeNow()-U.default.group_privacy.invitation_box.max_auto_focus_time?(this.currentTab=id.f.GROUP_INVITATION,this.currentTab):(this.currentTab=a&&i?id.f.FRIEND_LIST:id.f.FRIEND_REQUEST,this.currentTab)}onUpdateRequestTracking(e,t,s,i){switch("NEW"===t?this._onUpdateUnreadRequest(i,e):"REMOVE"===t&&(U.default.group_privacy.invitation_box.enable&&"GROUP_INV"===e&&i?this._clearGroupInvitationUnreadItem(i):this._clearFriendRequestUnreadItem()),e){case"FRIEND":this._setLastRequestFriendTime(t,s||0,i);break;case"GROUP":default:break;case"GROUP_INV":U.default.group_privacy.invitation_box.enable&&this._setLastReceivedGroupInvitationTime(t,s||0,i)}}onInitUnreadRequest(){const e=this._getState();let t=(null==e?void 0:e.unread)||cd.unread;const s=(null==e?void 0:e.currentView)||cd.currentView,i=this._getAccessTime(),a=this._getLastRequestAddFriendTime(),n=this._getLastReceivedGroupInvitationTime();a&&i&&(i<a.ts&&t.newFriendRequests.push(a.userId),U.default.group_privacy.invitation_box.enable&&i<n.ts&&t.newGroupInvitations.add(n.groupId),t.isUnread=t.newFriendRequests.length>0||t.newGroupInvitations.size>0,this._updateState({currentView:s,unread:t},ld,!0))}})||od)||od);var gd=s("iq5K");const md=(e,t)=>{const s=A.default.simpleStripVietnamese(t).split(" "),i=A.default.simpleStripVietnamese(e).split(" ");return(()=>{const e=[];for(const t of s){let s=!1;for(let a=0;a<i.length;++a)if(i[a].startsWith(t)&&!e.includes(a)){e.push(a),s=!0;break}if(!s)return!1}return!0})()},pd=e=>new Promise(((t,s)=>{if(!e)return t(e);setTimeout((()=>{t(e)}),e)}));var fd;Object(ie.b)(sd.f)(fd=Object(i.injectable)()(fd=function(e,t){return i.ModuleContainer.inject(sd.e)(e,void 0,0)}(fd=function(e,t){return i.ModuleContainer.inject(Ks.LabelDataManager)(e,void 0,1)}(fd=Reflect.metadata("design:type",Function)(fd=Reflect.metadata("design:paramtypes",[void 0===sd.e?Object:sd.e,void 0===Ks.LabelDataManager?Object:Ks.LabelDataManager])(fd=class{constructor(e,t){this.friendInfoManager=e,this.labelDataManager=t,this.type=void 0,this.name=void 0,this.key=void 0,this.listState=void 0,this.listFriend=void 0,this.initListFriend=void 0,this.currentPage=void 0,this.didSort=void 0,this.eventBusInstance=void 0,this._Logger=void 0,this.name=sd.d,this.key=sd.d,this.listState=gd.d,this.listFriend=[],this.initListFriend=[],this.currentPage=1,this.didSort=!1,this.eventBusInstance=null,this._onHandleConvRemoveLabel=this._onHandleConvRemoveLabel.bind(this),this._onHandleConvAddLabel=this._onHandleConvAddLabel.bind(this),this._onHandleRemoveLabel=this._onHandleRemoveLabel.bind(this)}get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger(Ss.ZLoggerNametags.contactTabV2,[this.name])),this._Logger}_signalRenderList(){Object(Zs.h)(this.name,"all")}_signalRenderItem(){Object(Zs.g)(this.name,"all")}_signalRenderBoth(){Object(Zs.g)(this.name,"all"),Object(Zs.h)(this.name,"all")}_onRemoveFriend(e){this.listFriend.includes(e.userId)&&(this.listFriend.splice(this.listFriend.indexOf(e.userId),1),this.initListFriend.splice(this.initListFriend.indexOf(e.userId),1),this.listState.totalRecord=this.listFriend.length,this._signalRenderBoth())}_onAddFriend(e){this.listFriend.includes(e.userId)||(this.listFriend.unshift(e.userId),this.initListFriend.unshift(e.userId),ad.addNewFriendUid(e.userId),this._signalRenderList())}_getItemInfo(e){return this.friendInfoManager.getItem({key:e,version:1,extraData:null},null)||this.friendInfoManager.loadInfoNotRender({userId:e})}_onBlockFriend(e){this.friendInfoManager.onLoadInfo({userId:e.userId})}_onUnBlockFriend(e){this.friendInfoManager.onLoadInfo({userId:e.userId})}_onEditAlias(e){this.friendInfoManager.onLoadInfo({userId:e.userId}),this.listFriend=this._handleFilter(this.listState.searching.searchText,this.listState.searching.sorter,this.listState.searching.filter,!this.isDidSort(),!1),this.listState.totalRecord=this.listFriend.length,this._signalRenderBoth()}_onUpdateTagConv(e,t="add"){let s=!1;e.convIds.forEach((i=>{if(this.friendInfoManager.onLoadInfo({userId:i}),this.listState.searching.filter.label.id&&this.listState.searching.filter.label.id===+e.labelId){const e=this.listFriend.findIndex((e=>e===i));"remove"===t&&-1!==e?(this.listFriend.splice(e,1),this.listState.totalRecord=Math.max(this.listState.totalRecord-1,0),s=!0):"add"===t&&-1===e&&(this.listFriend.push(i),this.listFriend=this._handleFilter(this.listState.searching.searchText,this.listState.searching.sorter,this.listState.searching.filter,!1,!1),this.listState.totalRecord=this.listFriend.length,s=!0)}})),s&&this._signalRenderBoth()}_onHandleConvAddLabel(e){this._onUpdateTagConv(e.payload,"add")}_onHandleConvRemoveLabel(e){this._onUpdateTagConv(e.payload,"remove")}_onHandleRemoveLabel(e){if(e.payload&&e.payload.convs&&e.payload.convs.length){for(const t of e.payload.convs)this.friendInfoManager.onLoadInfo({userId:t});this._signalRenderBoth()}}addComponentListeners(){Z.default.subscribeEventFriend(W.EventFriend.REMOVE_FRIEND,this._onRemoveFriend.bind(this)),Z.default.subscribeEventFriend(W.EventFriend.ADD_FRIEND,this._onAddFriend.bind(this)),Z.default.subscribeEventFriend(W.EventFriend.BLOCK_FRIEND,this._onBlockFriend.bind(this)),Z.default.subscribeEventFriend(W.EventFriend.UNBLOCK_FRIEND,this._onUnBlockFriend.bind(this)),this.eventBusInstance=N.default.on(P.FetchActions.UPDATE_NAME,this._onEditAlias.bind(this)),this.labelDataManager.addEventListener(Ks.LabelEvents.LabelAddConvs,this._onHandleConvAddLabel),this.labelDataManager.addEventListener(Ks.LabelEvents.LabelRemoveConvs,this._onHandleConvRemoveLabel),this.labelDataManager.addEventListener(Ks.LabelEvents.RemoveLabel,this._onHandleRemoveLabel)}removeComponentListeners(){Z.default.unsubscribeEventFriend(W.EventFriend.REMOVE_FRIEND,this._onRemoveFriend.bind(this)),Z.default.unsubscribeEventFriend(W.EventFriend.ADD_FRIEND,this._onAddFriend.bind(this)),Z.default.unsubscribeEventFriend(W.EventFriend.BLOCK_FRIEND,this._onBlockFriend.bind(this)),Z.default.unsubscribeEventFriend(W.EventFriend.UNBLOCK_FRIEND,this._onUnBlockFriend.bind(this)),this.eventBusInstance&&this.eventBusInstance.remove(),this.labelDataManager.removeEventListener(Ks.LabelEvents.LabelAddConvs,this._onHandleConvAddLabel),this.labelDataManager.removeEventListener(Ks.LabelEvents.LabelRemoveConvs,this._onHandleConvRemoveLabel),this.labelDataManager.removeEventListener(Ks.LabelEvents.RemoveLabel,this._onHandleRemoveLabel)}async onLoadList(e){try{const t=await ad.getFriendList(e);this.listFriend=t,this.initListFriend=t,this.listState.totalRecord=t.length,this.listFriend=this._handleFilter(gd.g.searching.searchText,gd.g.searching.sorter,gd.g.searching.filter,!0,!1),this.initListFriend=this._handleFilter(gd.g.searching.searchText,gd.g.searching.sorter,gd.g.searching.filter,!0,!0),this.listState.totalRecord=this.listFriend.length,this._signalRenderItem(),this._signalRenderList()}catch(t){this.Logger.zsymb(18,"Y5mZXg","[FriendListController] -> [onLoadList], error: "+JSON.stringify(t))}}onLoadMore(){this.currentPage++,this._signalRenderList()}onFilterByName(e){if(!e)return[...this.initListFriend];return[...this.initListFriend].filter((t=>{const s=this._getItemInfo(t);return md((null==s?void 0:s.displayName.toLowerCase())||"",e.toLowerCase())}))}onFilterByLabel(e,t){if(!e)return t;if(0===e.length)return[];return t.filter((t=>e.includes(t)))}onFilterAll(e){return e}onFilterHidden(e,t,s){return t||e?s:s.filter((e=>!Le.a.isThreadHidden(e)))}onSortAlpha(e,t){if(e===gd.p.DEFAULT)return t;return t.sort(((t,s)=>{const i=this._getItemInfo(t),a=this._getItemInfo(s);return((t,s)=>{const i=/^[a-zA-Z]/,a=i.test(A.default.simpleStripVietnamese(t)),n=i.test(A.default.simpleStripVietnamese(s));switch(e){case gd.p.ALPHA_INCREASE:return!a&&n?1:a&&!n?-1:t.localeCompare(s);case gd.p.ALPHA_DECREASE:return!a&&n?-1:a&&!n?1:s.localeCompare(t);default:return 0}})((null==i?void 0:i.displayName.toLowerCase())||(null==i?void 0:i.zaloName.toLowerCase())||"",(null==a?void 0:a.displayName.toLowerCase())||(null==a?void 0:a.zaloName.toLowerCase())||"")}))}onMovingNewFriend(e){let t=[],s=[];for(let i=e.length-1;i>=0;i--){const a=this._getItemInfo(e[i]);null!=a&&a.isNewFriend?t.unshift(null==a?void 0:a.userId):s.unshift(null==a?void 0:a.userId)}return[...t,...s]}_handleFilter(e,t,s,i,a){var n;let r=[];return r=this.onFilterByName(e),r=this.onFilterByLabel(null==s||null===(n=s.label)||void 0===n?void 0:n.convs,r),r=this.onFilterAll(r),r=this.onSortAlpha(t,r),r=this.onFilterHidden(a,e,r),i&&(r=this.onMovingNewFriend(r)),r}_checkDidSort(e){return e!==gd.p.ALPHA_INCREASE?this.didSort=!0:this.didSort=!1,this.didSort}isDidSort(){return this.didSort}_updateInitListFriendWithoutDockNewFriends(){this.initListFriend=this._handleFilter(gd.g.searching.searchText,gd.g.searching.sorter,gd.g.searching.filter,!1,!0),this.listState.totalRecord=this.listFriend.length}onFilter(e,t,s){const i=this._checkDidSort(t);i&&this._updateInitListFriendWithoutDockNewFriends(),this.listFriend=this._handleFilter(e,t,s,!i,!1),this.listState.totalRecord=this.listFriend.length,this._signalRenderItem(),this._signalRenderList()}init(e){throw new Error("Method not implemented.")}getItem(e,t){return this.listState}getList(e,t){return this.listFriend}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}setSearchText(e){this.listState.searching.searchText=e,this._signalRenderItem()}setSorter(e){this.listState.searching.sorter=e,this._signalRenderItem()}setFilter(e){this.listState.searching.filter=e,this._signalRenderItem()}getFilter(){return this.listState.searching.filter}getSorter(){return this.listState.searching.sorter}resetData(){this.listFriend=[],this.initListFriend=[]}resetState(){this.listState={totalRecord:0,searching:{searchText:"",sorter:gd.p.ALPHA_INCREASE,filter:{label:{convs:null,id:null},admin:"",all:!0}}},this.currentPage=1,this.didSort=!1}})||fd)||fd)||fd)||fd)||fd);var vd;Object(ie.b)(sd.e)(vd=Reflect.metadata("design:type",Function)(vd=Reflect.metadata("design:paramtypes",[])(vd=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this.name=sd.c,this.key=sd.c}init(e){throw new Error("Method not implemented.")}onLoadInfo(e){const t=ad.getFriendInfo(e);t&&(this.data.set(e.userId,t),Object(Zs.g)(this.name,e.userId))}loadInfoNotRender(e){const t=ad.getFriendInfo(e);return t?(this.data.set(e.userId,t),t):null}getItem(e,t){return this.data.get(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}resetData(){this.data.clear()}})||vd)||vd);var _d;Object(ie.b)(sd.k)(_d=Object(i.injectable)()(_d=function(e,t){return i.ModuleContainer.inject(sd.i)(e,void 0,0)}(_d=function(e,t){return i.ModuleContainer.inject(ze.i)(e,void 0,1)}(_d=function(e,t){return i.ModuleContainer.inject(Ks.LabelDataManager)(e,void 0,2)}(_d=Reflect.metadata("design:type",Function)(_d=Reflect.metadata("design:paramtypes",[void 0===sd.i?Object:sd.i,void 0===ze.i?Object:ze.i,void 0===Ks.LabelDataManager?Object:Ks.LabelDataManager])(_d=class{constructor(e,t,s){this.groupInfoManager=e,this.previewDataManager=t,this.labelDataManager=s,this.type=void 0,this.name=void 0,this.key=void 0,this.listState=void 0,this.listGroup=void 0,this.initListGroup=void 0,this.currentPage=void 0,this._Logger=void 0,this.name=sd.h,this.key=sd.h,this.listState=gd.e,this.listGroup=[],this.initListGroup=[],this.currentPage=1,this._onHandleConvRemoveLabel=this._onHandleConvRemoveLabel.bind(this),this._onHandleConvAddLabel=this._onHandleConvAddLabel.bind(this),this._onHandleRemoveLabel=this._onHandleRemoveLabel.bind(this)}get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger(Ss.ZLoggerNametags.contactTabV2,[this.name])),this._Logger}_signalRenderList(){Object(Zs.h)(this.name,"all")}_signalRenderItem(){Object(Zs.g)(this.name,"all")}_signalRenderBoth(){Object(Zs.g)(this.name,"all"),Object(Zs.h)(this.name,"all")}_getItemInfo(e){return this.groupInfoManager.getItem({key:e,version:1,extraData:null},null)||this.groupInfoManager.loadInfoNotRender({userId:e})}init(e){throw new Error("Method not implemented.")}getItem(e,t){return this.listState}async onLoadList(){try{const e=await nd.getGroupList(),t=e.map((e=>e.userId));this.listGroup=t,this.initListGroup=t,this.listState.totalRecord=t.length,this.groupInfoManager.setMultiGroupInfo(e),this.listGroup=this._handleFilter(gd.h.searching.searchText,gd.h.searching.sorter,gd.h.searching.filter,!1),this.initListGroup=this._handleFilter(gd.h.searching.searchText,gd.h.searching.sorter,gd.h.searching.filter,!0),this.listState.totalRecord=this.listGroup.length,this._signalRenderItem(),this._signalRenderList()}catch(e){this.Logger.zsymb(18,"oJN3J8","[GroupListController] -> [onLoadList], error: "+JSON.stringify(e))}}onLoadMore(){this.currentPage++,this._signalRenderList()}onFilterByName(e){if(!e)return[...this.initListGroup];return this.initListGroup.filter((t=>{const s=this._getItemInfo(t);return md((null==s?void 0:s.displayName.toLowerCase())||"",e.toLowerCase())}))}onFilterByLabel(e,t){if(!e)return t;if(0===e.length)return[];return t.filter((t=>e.includes(t)))}onFilterMyAdminGroup(e,t){if(!e)return t;return t.filter((t=>{const s=this._getItemInfo(t);return(null==s?void 0:s.creatorId)===e}))}onFilterAll(e){return e}onSortAlpha(e,t){return e===gd.p.DEFAULT||e===gd.p.ACTION_INCREASE||e===gd.p.ACTION_DECREASE?t:t.sort(((t,s)=>{const i=this._getItemInfo(t),a=this._getItemInfo(s),n=(null==i?void 0:i.displayName.toLowerCase())||"",r=(null==a?void 0:a.displayName.toLowerCase())||"";switch(e){case gd.p.ALPHA_INCREASE:return n.localeCompare(r);case gd.p.ALPHA_DECREASE:return r.localeCompare(n);default:return 0}}))}onFilterHidden(e,t,s){return t||e?s:s.filter((e=>!Le.a.isThreadHidden(e)))}onSortActionTime(e,t){return e===gd.p.DEFAULT||e===gd.p.ALPHA_INCREASE||e===gd.p.ALPHA_DECREASE?t:t.sort(((t,s)=>{var i,a;const n=(null===(i=this.previewDataManager.getPreviewByIDSync(t))||void 0===i?void 0:i.messageTime)||0,r=(null===(a=this.previewDataManager.getPreviewByIDSync(s))||void 0===a?void 0:a.messageTime)||0;switch(e){case gd.p.ACTION_DECREASE:if(r&&n){if(r>n)return 1;if(r<n)return-1}return r&&!n?1:!r&&n?-1:0;case gd.p.ACTION_INCREASE:if(r&&n){if(r<n)return 1;if(r>n)return-1}return!r&&n?1:r&&!n?-1:0;default:return 0}}))}_handleFilter(e,t,s,i){var a;let n=[];return n=this.onFilterByName(e),n=this.onFilterByLabel(null==s||null===(a=s.label)||void 0===a?void 0:a.convs,n),n=this.onFilterMyAdminGroup((null==s?void 0:s.admin)||"",n),n=this.onFilterAll(n),n=this.onSortAlpha(t,n),n=this.onSortActionTime(t,n),n=this.onFilterHidden(i,e,n),n}onFilter(e,t,s){this.listGroup=this._handleFilter(e,t,s,!1),this.listState.totalRecord=this.listGroup.length,this._signalRenderItem(),this._signalRenderList()}_onUpdateTagConv(e,t="add"){let s=!1;e.convIds.forEach((i=>{if(this.groupInfoManager.onLoadInfo({userId:i}),this.listState.searching.filter.label.id&&this.listState.searching.filter.label.id===+e.labelId){const e=this.listGroup.findIndex((e=>e===i));"remove"===t&&-1!==e?(this.listGroup.splice(e,1),this.listState.totalRecord=Math.max(this.listState.totalRecord-1,0),s=!0):"add"===t&&-1===e&&(this.listGroup.push(i),this.listGroup=this._handleFilter(this.listState.searching.searchText,this.listState.searching.sorter,this.listState.searching.filter,!1),this.listState.totalRecord=this.listGroup.length,s=!0)}})),s&&this._signalRenderBoth()}_onHandleConvAddLabel(e){this._onUpdateTagConv(e.payload,"add")}_onHandleConvRemoveLabel(e){this._onUpdateTagConv(e.payload,"remove")}_onHandleRemoveLabel(e){if(e.payload&&e.payload.convs&&e.payload.convs.length){for(const t of e.payload.convs)this.groupInfoManager.onLoadInfo({userId:t});this._signalRenderBoth()}}_onLeaveGroup(e){for(let t=0;t<e.length;t++){if(!this.listGroup.includes(e[t]))return;this.listGroup.splice(this.listGroup.indexOf(e[t]),1),this.initListGroup.splice(this.listGroup.indexOf(e[t]),1),this.listState.totalRecord=this.listGroup.length}this._signalRenderBoth()}addComponentListeners(){Fe.default.subscribeEventGroup(W.EventGroup.LEAVE_GROUP,this._onLeaveGroup.bind(this)),this.labelDataManager.addEventListener(Ks.LabelEvents.LabelAddConvs,this._onHandleConvAddLabel),this.labelDataManager.addEventListener(Ks.LabelEvents.LabelRemoveConvs,this._onHandleConvRemoveLabel),this.labelDataManager.addEventListener(Ks.LabelEvents.RemoveLabel,this._onHandleRemoveLabel)}removeComponentListeners(){Fe.default.unsubscribeEventGroup(W.EventGroup.LEAVE_GROUP,this._onLeaveGroup.bind(this)),this.labelDataManager.removeEventListener(Ks.LabelEvents.LabelAddConvs,this._onHandleConvAddLabel),this.labelDataManager.removeEventListener(Ks.LabelEvents.LabelRemoveConvs,this._onHandleConvRemoveLabel),this.labelDataManager.removeEventListener(Ks.LabelEvents.RemoveLabel,this._onHandleRemoveLabel)}getList(e,t){return this.listGroup}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}setSearchText(e){this.listState.searching.searchText=e,this._signalRenderItem()}setSorter(e){this.listState.searching.sorter=e,this._signalRenderItem()}setFilter(e){this.listState.searching.filter=e,this._signalRenderItem()}getFilter(){return this.listState.searching.filter}getSorter(){return this.listState.searching.sorter}resetData(){this.listGroup=[],this.initListGroup=[]}resetState(){this.listState={totalRecord:0,searching:{searchText:"",sorter:gd.p.ACTION_DECREASE,filter:{label:{convs:null,id:null},admin:"",all:!0}}},this.currentPage=1}})||_d)||_d)||_d)||_d)||_d)||_d);var bd;Object(ie.b)(sd.i)(bd=Reflect.metadata("design:type",Function)(bd=Reflect.metadata("design:paramtypes",[])(bd=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this.name=sd.g,this.key=sd.g}init(e){throw new Error("Method not implemented.")}async onLoadInfo(e){const t=nd.getGroupInfoSync(e);t&&(this.data.set(e.userId,t),Object(Zs.g)(this.name,e.userId))}loadInfoNotRender(e){const t=nd.getGroupInfoSync(e);return t?(this.data.set(e.userId,t),t):null}loadMultiGroupInfo(e){for(const t of e)this.loadInfoNotRender({userId:t})}setMultiGroupInfo(e){for(const t of e)this.data.set(t.userId,t)}openGroupMemberPopup(e){const t=this.data.get(e);ft.ModalManagerV2.openModal({windowId:"1",name:W.ModalIdentitiesDefine.FRIEND_PROFILE,params:{group_member:t}})}getItem(e,t){return this.data.get(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}resetData(){this.data.clear()}})||bd)||bd);let yd=function(e){return e[e.RECOMMEND=1]="RECOMMEND",e[e.RECEIVE=2]="RECEIVE",e}({});const Id=500,Sd=500;var Cd;Object(ie.b)(sd.n)(Cd=function(e,t){return i.ModuleContainer.inject(sd.b)(e,void 0,0)}(Cd=Reflect.metadata("design:type",Function)(Cd=Reflect.metadata("design:paramtypes",[void 0===sd.b?Object:sd.b])(Cd=class extends De.b{constructor(e){super(),this.contactTabController=e,this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this._Logger=void 0,this.name=sd.l,this.key=sd.l,this.data.set("all",{isLoadingRecommendFriendList:!1,isLoadingRequestedFriendList:!1,listFriendReceived:[],listFriendSent:[],listFriendSuggest:[],mapRelatedGroup:{}}),this.addPublicListeners()}get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger(Ss.ZLoggerNametags.contactTabV2,[this.name])),this._Logger}_signalRenderItem(){Object(Zs.g)(this.name,"all")}init(e){throw new Error("Method not implemented.")}getItem(e,t){return this.data.get(e.key)}_updateLoadingState(e,t){const{listFriendReceived:s=[],listFriendSuggest:i=[],listFriendSent:a=[]}=this.data.get("all")||{};let{isLoadingRecommendFriendList:n,isLoadingRequestedFriendList:r}=this.data.get("all")||{};if("RecommendFriendList"===e)switch(t){case"ON":n||0!==s.length||0!==i.length||(n=!0);break;case"OFF":n&&(n=!1)}if("RequestedFriendList"===e)switch(t){case"ON":r||0!==a.length||(r=!0);break;case"OFF":r&&(r=!1)}this.data.set("all",Object(T.a)(Object(T.a)({},this.data.get("all")),{},{isLoadingRecommendFriendList:n,isLoadingRequestedFriendList:r})),this._signalRenderItem()}async onLoadRequestedFriendList(){const e=Date.now();try{this._updateLoadingState("RequestedFriendList","ON");const t=await rd.getRequestedFriendList();Date.now()-e<Id&&await pd(Sd),this._updateLoadingState("RequestedFriendList","OFF");const s=Object.keys(t).map((e=>t[e])).sort(((e,t)=>{var s,i;const a=null===(s=e.fReqInfo)||void 0===s?void 0:s.time,n=null===(i=t.fReqInfo)||void 0===i?void 0:i.time;return n>a?1:n<a?-1:0})),{listFriendReceived:i=[],listFriendSuggest:a=[],mapRelatedGroup:n={}}=this.data.get("all")||{};this.data.set("all",Object(T.a)(Object(T.a)({},this.data.get("all")),{},{listFriendReceived:i,listFriendSent:s,listFriendSuggest:a,mapRelatedGroup:n})),this._signalRenderItem()}catch(t){Date.now()-e<Id&&await pd(Sd),this._updateLoadingState("RequestedFriendList","OFF"),this.Logger.zsymb(18,"3JeYbh","[InvitationController] -> [onLoadRequestedFriendList], error: "+JSON.stringify(t))}}async onLoadRecommendFriendList(){const e=Date.now();try{this._updateLoadingState("RecommendFriendList","ON");const t=await rd.getRecommendFriendList();if(Date.now()-e<Id&&await pd(Sd),this._updateLoadingState("RecommendFriendList","OFF"),Array.isArray(t)&&t.length>0){const e=t.filter((e=>{var t;return(null===(t=e.dataInfo)||void 0===t?void 0:t.recommType)===yd.RECEIVE})),s=t.filter((e=>{var t;return(null===(t=e.dataInfo)||void 0===t?void 0:t.recommType)===yd.RECOMMEND})),{listFriendSent:i=[],mapRelatedGroup:a={}}=this.data.get("all")||{};this.data.set("all",Object(T.a)(Object(T.a)({},this.data.get("all")),{},{listFriendReceived:e,listFriendSent:i,listFriendSuggest:s,mapRelatedGroup:a})),s.length>0&&this.dispatchEvent(new id.e(id.d.LoadRelatedGroups,"",{})),this._signalRenderItem()}}catch(t){Date.now()-e<Id&&await pd(Sd),this._updateLoadingState("RecommendFriendList","OFF"),this.Logger.zsymb(18,"4mhWgk","[InvitationController] -> [onLoadRecommendFriendList], error: "+JSON.stringify(t))}}_handleSortFriendSuggestList(e,t){return 0===e.length?e:e.sort(((e,s)=>{var i,a,n,r,o,c;const l=t[null===(i=e.dataInfo)||void 0===i?void 0:i.userId]&&t[null===(a=e.dataInfo)||void 0===a?void 0:a.userId].length,d=(null===(n=e.dataInfo)||void 0===n?void 0:n.displayName)||"",h=t[null===(r=s.dataInfo)||void 0===r?void 0:r.userId]&&t[null===(o=s.dataInfo)||void 0===o?void 0:o.userId].length,u=(null===(c=s.dataInfo)||void 0===c?void 0:c.displayName)||"";return l&&h?l===h?d.localeCompare(u):h>l?1:-1:l&&!h?-1:!l&&h?1:l||h?0:d.localeCompare(u)}))}async onLoadRelatedGroupList(){try{const{listFriendSuggest:e=[]}=this.data.get("all")||{},t=e.map((e=>{var t;return null==e||null===(t=e.dataInfo)||void 0===t?void 0:t.userId})),s=await rd.getRelatedGroup(t),{listFriendReceived:i=[],listFriendSent:a=[]}=this.data.get("all")||{},n=this._handleSortFriendSuggestList(e,s.groupRelateds);this.data.set("all",Object(T.a)(Object(T.a)({},this.data.get("all")),{},{listFriendReceived:i,listFriendSent:a,listFriendSuggest:n,mapRelatedGroup:s.groupRelateds||{}})),this._signalRenderItem()}catch(e){this.Logger.zsymb(18,"1Oyt5j","[InvitationController] -> [onLoadRelatedGroupList], error: "+JSON.stringify(e))}}handleFriendProfileChange(e){const{listFriendReceived:t=[],listFriendSuggest:s=[],listFriendSent:i=[]}=this.data.get("all")||{};Object.keys(e).forEach((e=>{const a=Z.default.getDName(e),n=t.findIndex((t=>t.dataInfo.userId===e));-1!==n&&(t[n].displayName=a);const r=s.findIndex((t=>t.dataInfo.userId===e));-1!==r&&(s[r].displayName=a);const o=i.findIndex((t=>t.userId===e));-1!==o&&(i[o].displayName=a)})),this._signalRenderItem()}handlePublicFriendEvents(e){const t=e.payload;if(t)for(let i=0;i<t.length;i++){var s;const a=t[i].ts,n="add"===t[i].act&&t[i].data||(null===(s=t[i].data)||void 0===s?void 0:s.fromUid),r=n===e.userId;if(a&&n&&!r&&"fr"===t[i].act_type)switch(t[i].act){case"req_v2":this.contactTabController.onUpdateRequestTracking("FRIEND","NEW",a,n);break;case"undo_req":this.contactTabController.onUpdateRequestTracking("FRIEND","REMOVE",a,n),this.dispatchEvent(new id.e(id.d.UndoAddFriendEvent,"",n));break;case"add":this.contactTabController.onUpdateRequestTracking("FRIEND","REMOVE",a,n),this.dispatchEvent(new id.e(id.d.AcceptAddFriendEvent,"",n));break;case"reject":this.contactTabController.onUpdateRequestTracking("FRIEND","REMOVE",a,n),this.dispatchEvent(new id.e(id.d.RejectAddFriendEvent,"",n))}}}handlePublicAddFriendEvent(e){let t=[];const s=e.payload;if(s){for(let e=0;e<s.length;e++){let i={};i.userId=s[e].userId,i.zaloName=s[e].zaloName,i.avatar=s[e].avatar,i.displayName=s[e].displayName,i.recommInfo={message:s[e].friendRequestMsg,source:s[e].friendRequestSource},i.recommTime=s[e].friendRequestFetchTime,i.recommType=s[e].friendRequestType,t.push({dataInfo:i,recommItemType:1})}this.dispatchEvent(new id.e(id.d.ReceiveAddFriendEvent,"",t))}}addPublicListeners(){this.addEventListener(id.d.PublicInvitationEvents,this.handlePublicFriendEvents.bind(this)),this.addEventListener(id.d.PublicReceiveAddFriendEvent,this.handlePublicAddFriendEvent.bind(this)),Z.default.connectSignalChangeDNameAndAvatar(this.handleFriendProfileChange.bind(this))}addComponentListeners(){}removeComponentListeners(){}_addFriendReceived(e){const{listFriendReceived:t=[],listFriendSent:s=[],listFriendSuggest:i=[],mapRelatedGroup:a={}}=this.data.get("all")||{},n=e.concat(t);this.data.set("all",Object(T.a)(Object(T.a)({},this.data.get("all")),{},{listFriendReceived:n,listFriendSent:s,listFriendSuggest:i,mapRelatedGroup:a})),this._signalRenderItem()}_removeFriendReceived(e){const{listFriendReceived:t=[],listFriendSent:s=[],listFriendSuggest:i=[],mapRelatedGroup:a={}}=this.data.get("all")||{},n=t.filter((t=>{var s;return(null===(s=t.dataInfo)||void 0===s?void 0:s.userId)!==e}));this.data.set("all",Object(T.a)(Object(T.a)({},this.data.get("all")),{},{listFriendReceived:n,listFriendSent:s,listFriendSuggest:i,mapRelatedGroup:a})),this._signalRenderItem()}onUpdateFriendRequests(e,t){switch(t){case"ADD":this._addFriendReceived(e);break;case"REMOVE":this._removeFriendReceived(e)}}async onRejectFriend(e){return new Promise(((t,s)=>{rd.rejectAddFriend(e).then((()=>{this._removeFriendReceived(e),t(e)})).catch((e=>{this.Logger.zsymb(18,"U-4hzS","[InvitationController] -> [onRejectFriend], error: "+JSON.stringify(e)),s(e)}))}))}async onAddFriend(e){return new Promise(((t,s)=>{rd.acceptAddFriend(e).then(t).catch((e=>{this.Logger.zsymb(18,"ssrdmz","[InvitationController] -> [onAddFriend], error: "+JSON.stringify(e)),s(e)}))}))}removeFriendSent(e){const{listFriendReceived:t=[],listFriendSent:s=[],listFriendSuggest:i=[],mapRelatedGroup:a={}}=this.data.get("all")||{},n=s.filter((t=>(null==t?void 0:t.userId)!==e));this.data.set("all",Object(T.a)(Object(T.a)({},this.data.get("all")),{},{listFriendReceived:t,listFriendSent:n,listFriendSuggest:i,mapRelatedGroup:a})),this._signalRenderItem()}onRemoveFriendSent(e){rd.makeUndoSentRequestFriend(e).then((()=>{this.removeFriendSent(e.userId)})).catch((e=>{this.Logger.zsymb(18,"8VDDY0","[InvitationController] -> [onRemoveFriendSent], error: "+JSON.stringify(e)),e&&301==e.error_code?ai.a.createError(ni.default.str("STR_UNDO_REQUEST_ERROR_301")):e&&"ERR_NO_NETWORK"===e.code?ai.a.createError(ni.default.str("STR_CHECK_NET")):ai.a.createError(ni.default.str("STR_UNDO_REQUEST_ERROR_UNKNOWN"))}))}_removeFriendSuggest(e){const{listFriendReceived:t=[],listFriendSent:s=[],listFriendSuggest:i=[],mapRelatedGroup:a={}}=this.data.get("all")||{},n=i.filter((t=>{var s;return(null==t||null===(s=t.dataInfo)||void 0===s?void 0:s.userId)!==e}));this.data.set("all",Object(T.a)(Object(T.a)({},this.data.get("all")),{},{listFriendReceived:t,listFriendSent:s,listFriendSuggest:n,mapRelatedGroup:a})),this._signalRenderItem()}onAddFriendSuggest(e){Qr.a.doAddFriend(e.uid,e.src,null,e.windowId).then((()=>{this._removeFriendSuggest(e.uid),this.onLoadRequestedFriendList()})).catch((e=>{this.Logger.zsymb(18,"3kpi3N","[InvitationController] -> [onAddFriendSuggest], error: "+JSON.stringify(e))}))}onRemoveFriendSuggest(e){rd.removeSuggestFriend(e).then((()=>{this._removeFriendSuggest(e.uid)})).catch((e=>{this.Logger.zsymb(18,"CzRbX9","[InvitationController] -> [onRemoveFriendSuggest], error: "+JSON.stringify(e))}))}openMutualGroupPopup(e){ft.ModalManagerV2.openModal({windowId:"1",name:W.ModalIdentitiesDefine.FRIEND_PROFILE,params:{userId:e,showMutualGroups:!0}})}resetData(){this.data.set("all",{isLoadingRecommendFriendList:!1,isLoadingRequestedFriendList:!1,listFriendReceived:[],listFriendSent:[],listFriendSuggest:[],mapRelatedGroup:{}})}makeExpiredReceivedFriendRequest(){let{listFriendReceived:e=[],listFriendSent:t=[],listFriendSuggest:s=[],mapRelatedGroup:i={}}=this.data.get("all")||{};if(0!==e.length){for(let t=0;t<e.length;t++)e[t].dataInfo.recommTime=-1,e[t].dataInfo.recommInfo.source=-1,e[t].dataInfo.recommInfo.message="";this.data.set("all",Object(T.a)(Object(T.a)({},this.data.get("all")),{},{listFriendReceived:e,listFriendSent:t,listFriendSuggest:s,mapRelatedGroup:i})),this._signalRenderItem()}}makeExpiredSentFriendSentRequest(){let{listFriendReceived:e=[],listFriendSent:t=[],listFriendSuggest:s=[],mapRelatedGroup:i={}}=this.data.get("all")||{};if(0!==t.length){for(let e=0;e<t.length;e++)t[e].fReqInfo.time=-1,t[e].fReqInfo.src=-1,t[e].fReqInfo.message="";this.data.set("all",Object(T.a)(Object(T.a)({},this.data.get("all")),{},{listFriendReceived:e,listFriendSent:t,listFriendSuggest:s,mapRelatedGroup:i})),this._signalRenderItem()}}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||Cd)||Cd)||Cd);var Ed,Od=s("2x/M"),Td=s("FhUL"),Md=s("zU/x"),Rd=s("dhU0"),wd=s("2e02"),Ld=s("HnA5");function Fd(e){return{avatar:e.avatar,displayName:Z.default.getDName(e.id)||e.dName||e.zaloName,userId:e.id,zaloName:e.zaloName,type:e.type}}Object(ie.b)(wd.b)(Ed=Reflect.metadata("design:type",Function)(Ed=Reflect.metadata("design:paramtypes",[])(Ed=class extends De.b{constructor(){super(),this.name=void 0,this.key=void 0,this._Logger=void 0,this.data=void 0,this.metadata=void 0,this.timer=void 0,this.isOpeningInvitationBox=void 0,this.handleNetworkStatusChange=e=>{e===Fn.a.CONNECTED&&0===this.data.size&&this.getReceivedInvitations({page:0})},this.name=wd.a,this.key="groupId",this.data=new Map,this.metadata={total:0,page:0,hasMore:!0,loading:!0},this.timer={instance:new M.b,intervalId:null},this.isOpeningInvitationBox=!1}init(){throw new Error("Method not implemented.")}getList(){return Array.from(this.data.keys())}getItem(e){const t=this.data.get(e.key);return t||this.Logger.zsymb(5,"g5ZkVz",["try to get item not exist in cache {}","iOXr3y"],e.key),t}onGetItemFailure(e){this.Logger.zsymb(18,"7NObAl","Get group invitation item failed with id",e)}onGetListFailure(e){this.Logger.zsymb(18,"t8iole","Get group invitation list failed",e)}signalUpdateList(){Object(Zs.h)(this.name,"all")}signalUpdateItem(e){Object(Zs.g)(this.name,e)}signalUpdateListMeta(){this.dispatchEvent(new id.c(id.a.UpdateUIListMetadata,this.metadata))}get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger(Ss.ZLoggerNametags.contactTabV2,[this.name])),this._Logger}async getCreatorInfos(e){const t=await Z.default.getProfileFriendForGroup(Object.fromEntries(e.map((e=>[e.creatorId||e,0]))));return new Map(e.map((e=>[e.groupId,t[e.creatorId]])))}async getCreatorInfoForGroup(e){return Z.default.getProfileFriendForGroup({[e]:0})}startTimer(){this.stopTimer(),this.timer.intervalId=window.setInterval((()=>this.timer.instance.publish(D.default.getTimeNow())),id.b.COUNT_INTERVAL)}stopTimer(){null!==this.timer.intervalId&&window.clearInterval(this.timer.intervalId),this.timer.intervalId=null}getTimer(){return this.timer.instance}isValidInvitation(e){var t;return!!(null!==(t=e.groupInfo)&&void 0!==t&&t.groupId&&e.grCreatorInfo&&e.inviterInfo)&&e.expiredTs-D.default.getTimeNow()>0}convertToGroupInvitation(e){const t=W.GROUPID_PREFIX+e.groupInfo.groupId,s=function(e){return{avatar:e.avt,creatorId:e.creatorId,displayName:e.name,name:e.name,setting:e.setting,adminIds:e.adminIds,totalMember:e.totalMember,userId:e.groupId,type:e.type,topMember:e.currentMems.map(Fd),isGroup:!0}}(e.groupInfo),i=Fd(e.inviterInfo),a=Fd(e.grCreatorInfo);return Object(T.a)(Object(T.a)({},e),{},{groupId:t,groupInfo:s,inviterInfo:i,grCreatorInfo:a})}async loadServerReceivedInvitations(){var e;const{invitations:t,hasMore:s,total:i}=await Ni.default.getGroupInvitationList(this.metadata.page,U.default.group_privacy.invitation_box.paging_limit,U.default.group_privacy.invitation_box.mcount_item,null===(e=this.metadata)||void 0===e?void 0:e.lastGroupId);this.metadata=Object(T.a)(Object(T.a)({},this.metadata),{},{hasMore:s,total:i});const a=await this.getCreatorInfos(t.map((e=>e.groupInfo))),n=[];for(let r=0;r<t.length;r++){const e=t[r];if(e.grCreatorInfo||(e.grCreatorInfo=a.get(e.groupInfo.groupId)),this.isValidInvitation(e)){const s=W.GROUPID_PREFIX+e.groupInfo.groupId,i=this.convertToGroupInvitation(e);n.push(i),r===t.length-1&&(this.metadata.lastGroupId=s)}}return n}onInvitationListUIAppear(){this.isOpeningInvitationBox=!0,this.startTimer(),this.getReceivedInvitations({page:0}).catch((e=>{this.Logger.zsymb(18,"GJ7Vbv","Init load invitation failed",e)})).finally((()=>{this.metadata.loading&&(this.metadata.loading=!1,setTimeout((()=>{this.signalUpdateListMeta()}),300))})),ye.p.listenEvent(ye.k,this.handleNetworkStatusChange)}onInvitationListUIDisappear(){this.stopTimer(),this.metadata={total:0,page:0,hasMore:!0,loading:!0},this.data.clear(),ye.p.removeListenEvent(ye.k,this.handleNetworkStatusChange),this.isOpeningInvitationBox=!1}getUIListMeta(){return this.metadata}async getReceivedInvitations(e={}){const{page:t=0}=e;if(!this.metadata.hasMore)return[];this.metadata.page=t,this.data=new Map(this.data);const s=await this.loadServerReceivedInvitations();return s.forEach((e=>{this.data.set(e.groupId,e)})),this.signalUpdateListMeta(),this.signalUpdateList(),s}async loadMoreReceivedInvitations(){const e=U.default.group_privacy.invitation_box.paging_limit,t=Math.trunc(this.data.size/e);return this.getReceivedInvitations({page:t})}handleNewInvitation(e,t){this.metadata.total+=1,this.data=new Map([[e,t],...Array.from(this.data.entries())]),this.signalUpdateListMeta(),this.signalUpdateList()}async acceptInvitation(e,t){try{if(e.type===Td.a.PENDING_REVIEW)throw{error_code:Md.a.WAITING_APPROVE};const t=A.default.getRawGroupId(e.groupId);await Ni.default.joinGroupFromInvitation(t),this.Logger.zsymb(2,"a-jmBi","Join group success",e.groupId),i.ModuleContainer.resolve(Ge.b).openConversation(e.groupId,Ge.d.fromGroupInvitation()),this.deleteInvitationsFromCache([e.groupId])}catch(s){this.Logger.zsymb(18,"wchLTh","Join group failed",e.groupId,s),this.handleJoinInvitationError(e,null==s?void 0:s.error_code,t)}}async rejectInvitation(e,t={}){try{if(e.type===Td.a.PENDING_REVIEW)throw{error_code:Md.a.WAITING_APPROVE};const s=A.default.getRawGroupId(e.groupId);await Ni.default.deleteGroupInvitation([{grid:s}],t.blockGroup),this.Logger.zsymb(2,"PFd6vc","Reject group invitation success",e.groupId,t),t.blockInviter&&Z.default.blockFriend(e.inviterInfo.userId,W.SET_BLOCK),this.deleteInvitationsFromCache([e.groupId]),ai.a.createInfo(ni.default.str(Ld.a.get("STR_GROUP_INVITATION_DELETED",e.groupInfo)))}catch(s){this.Logger.zsymb(18,"OWBmT_","Reject group invitation failed",e.groupId,s),ai.a.createError(ni.default.str("STR_ERROR_OCCUR"))}}async deleteInvitations(e){const t=e.map((e=>({grid:A.default.getRawGroupId(e.groupId)})));try{await Ni.default.deleteGroupInvitation(t,!1),this.Logger.zsymb(2,"AcAScL","Delete group invitations success",t),this.deleteInvitationsFromCache(e.map((e=>e.groupId)))}catch(s){this.Logger.zsymb(18,"a8l8LL","Delete group invitations failed",t,s),ai.a.createError(ni.default.str("STR_ERROR_OCCUR"))}}deleteInvitationsFromCache(e){let t=0;for(const s of e)this.data.has(s)&&(this.data.delete(s),t+=1);0!==t&&(this.metadata.total=Math.max(this.metadata.total-t,0),this.signalUpdateListMeta(),this.signalUpdateList(),this.metadata.hasMore&&this.data.size<U.default.group_privacy.invitation_box.paging_limit&&this.loadMoreReceivedInvitations())}getInvitationSync(e){return this.data.get(e)||null}getInvitation(e){return new Promise((t=>{const s=A.default.getRawGroupId(e);Ni.default.getGroupInvitationInfo(s).then((e=>{e.grCreatorInfo?t(this.convertToGroupInvitation(e)):this.getCreatorInfoForGroup(e.groupInfo.creatorId).then((s=>{e.grCreatorInfo=s,t(this.convertToGroupInvitation(e))})).catch((()=>t(null)))})).catch((s=>{this.Logger.zsymb(18,"jI9j6A","Get invitation info failed",e,s),t(null)}))}))}updateInvitationFromCache(e){const{groupId:t}=e;this.data.has(t)&&this.data.set(t,e)}updateInvitationStatus(e,t){const s=this.data.get(e);if(s){const i=Object(T.a)(Object(T.a)({},s),{},{type:t});this.updateInvitationFromCache(i),this.data.set(e,i),this.signalUpdateItem(e)}}onReceivedInvitationEvents(e,t){const s=t.groupId;if(!s)return;const a=W.GROUPID_PREFIX+s;switch(this.Logger.zsymb(0,"pEIOK6","Received new event",e,a),e){case Od.b.NEW_INVITATION:this.isOpeningInvitationBox&&this.getInvitation(a).then((e=>{e&&this.handleNewInvitation(a,e)})).catch((e=>{this.Logger.zsymb(18,"kV_VOg","Load new invitation item by event failed",a,e)})),i.ModuleContainer.resolve(Rd.b).onUpdateRequestTracking("GROUP_INV","NEW",D.default.getTimeNow(),a);break;case Od.b.UPDATE_INVITATION:const e=this.data.get(a);"number"==typeof t.invitationType&&(null==e?void 0:e.type)!==t.invitationType&&this.updateInvitationStatus(a,t.invitationType);break;case Od.b.REMOVE_INVITATION:this.deleteInvitationsFromCache([a]),i.ModuleContainer.resolve(Rd.b).onUpdateRequestTracking("GROUP_INV","REMOVE",D.default.getTimeNow(),a)}}handleJoinInvitationError(e,t,s){switch(t){case Md.a.WAITING_APPROVE:this.updateInvitationStatus(e.groupId,Td.a.PENDING_REVIEW),ai.a.createInfo(ni.default.str(Ld.a.get("STR_GROUP_INVITATION_JOIN_ERR_240",e.groupInfo)));break;case Md.a.EXCEED_MAX_GROUP:case Md.a.CANNOT_CHANGE:case Md.a.BANNED:case Md.a.NOT_PERMITTED:ai.a.createInfo(ni.default.str(Ld.a.get("STR_GROUP_INVITATION_JOIN_ERR_"+t,e.groupInfo)));break;case Md.a.NOT_EXIST:case Md.a.ALREADY_MEMBER:case Md.a.EXPIRED:this.deleteInvitationsFromCache([e.groupId]),ai.a.createInfo(ni.default.str(Ld.a.get("STR_GROUP_INVITATION_JOIN_ERR_"+t,e.groupInfo)));break;case W.GROUP_MEMBER_ERROR.REACHED_LIMIT_MEMBER_GROUP:case W.GROUP_MEMBER_ERROR.OWNER_NEED_VERIFY_PROFILE:U.default.group_privacy.community.enable_upgrade?i.ModuleContainer.resolve(Ma.e).onReceivedCommunityError({errorCode:t,windowId:s,groupId:e.groupId}):ai.a.createError(ni.default.str("STR_ERROR_OCCUR"));break;default:ai.a.createError(ni.default.str("STR_ERROR_OCCUR"))}}})||Ed)||Ed);var Dd=s("akSd"),Ad=s("fqRP"),Nd=s("L904"),kd=s("EiAw"),Pd=s("IoRb"),jd=s("CzFt");let Ud;class Bd{static get instance(){return Ud||(Ud=new Bd),Ud}get _eventStore(){return this.__eventStore||(this.__eventStore=s("emRR").default),this.__eventStore}constructor(){this.__eventStore=void 0,this._emitConversationDeleted=e=>{let t,s,i=[];if(e.ok?({conversation:t,toUid:s,allItems:i}=e.value):({conversation:t,toUid:s,allItems:i}=e.error),t)return;if(i.length&&i.every((e=>e.ttlType===an.a.Quote)))return;const a={type:P.FetchActions.DELETE_CONVERSATION,payload:s};this._eventStore.dispatch(a),jd.a.dispatch(a),N.default.send(a.type,a.payload)},this._emitDeletedMsgs=e=>{let t,s;e.ok?({allItems:s,conversation:t}=e.value):({allItems:s,conversation:t}=e.error);const i=s.filter((e=>e.ttlType===an.a.Message)),a=i.map((e=>e.msgId));Object(kd.a)({msgId:a,conversation:t,messages:i.map((e=>JSON.parse(JSON.stringify(e)))),trackingSource:"ttlPrune"})},this._emitUpdateUnread=(e,t)=>{let s,i=[];e.ok?({toUid:s,allItems:i}=e.value):({toUid:s,allItems:i}=e.error),Q.a.UnreadDataManager.updateUnreadTTLConversation(s,i,null==t?void 0:t.get(s))},this.emitPerConversation=async(e,t)=>{let s=await Object(El.a)(this._emitConversationDeleted,e);s.ok||Object(Pd.a)("_emitConversationDeleted failed",s.error),s=await Object(El.a)(this._emitDeletedMsgs,e),s.ok||Object(Pd.a)("_emitDeletedMsgs failed",s.error),s=await Object(El.a)(this._emitUpdateUnread,e,t),s.ok||Object(Pd.a)("_emitUpdateUnread failed",s.error)}}}var Gd,zd=s("LA52"),xd=s("GSaP");const Vd=e=>null==e?void 0:e.toUid,Hd=e=>null!=e&&e.ok?"success":"error";Object(i.singleton)(zd.a)(Gd=Reflect.metadata("design:type",Function)(Gd=Reflect.metadata("design:paramtypes",[])(Gd=class{constructor(){this._pruning=!1,this._task=void 0,this._ttl=i.ModuleContainer.resolve(Ad.a),this._logger=void 0,this.dispose=()=>{},this.prune=async()=>this._pruning?await this._task:(this._pruning=!0,this._task=this._pruneFromDB(),this._pruning=!1,this._task),this._pruneFromDB=async()=>{const e=D.default.getTimeNow();this._logger.zsymb(0,"_cuJgT","Pruner execute task",e);const t=await Object(El.b)(this._ttl.getExpireItemsBefore,e);if(!t.ok)return this._logger.zsymb(18,"5k1ZRN","Pruner getExpireItemsBefore failed",t.error),{ok:!1,error:null};const s=t.ok?t.value:[];return await this._pruneTTLItems(s)},this._pruneByMsgsBatch=[],this.pruneByMsgs=async e=>{const t=Object(j.a)(e);this._pruneByMsgsBatch.push(...t),setTimeout((()=>{const e=this._pruneByMsgsBatch;this._pruneByMsgsBatch=[],e.length&&(this._logger.zsymb(15,"9c6cYA",["running a batch {}","kujoPA"],e.length),this._pruneByMsgs(e))}),2e3)},this._pruneByMsgs=async e=>{const t=D.default.getTimeNow();this._logger.zsymb(15,"6-iyHT",["deriving {}","jXmS6J"],e.length);let s=xd.a.createFromCurrentSession().deriveTTLItems(e);this._logger.zsymb(15,"BGyvnG",["ttlItems count: {}","CRNE_P"],s.length),s=s.filter((e=>{const s=+e.expireOn+U.default.ttl.enable_delete_on_filter_minimum_overtime;return!isNaN(s)&&s<t})),this._logger.zsymb(15,"OYGPwP",["expired count: {}","4F5zOk"],s.length),s=s.filter((e=>!this._hasPruneMsgCache(e))),s.forEach((e=>{this._setPruneMsgCache(e)})),this._logger.zsymb(15,"J4hnjw",["no cache count: {}","P0sgpv"],s.length),s.length?(this._logger.zsymb(3,"wMYJgr",["pruning {}, {}","678p3S"],s.length,s),await this._deleteMsgsAndEmit(s)):this._logger.zsymb(15,"kex1ti",["no items to prune","7SSPlP"])},this._pruneMsgCache=new h.default({maxSize:1e4}),this._pruneTTLItems=async e=>{const t=e.map((e=>[e.msgId,e.ttlType]));this._logger.zsymb(3,"rOerVE",["pruning {} items: {}","DrUgbv"],t.length,t),await this._deleteMsgsAndEmit(e);const s=await Object(El.b)(this._ttl.deletes,t);return s.ok||this._logger.zsymb(18,"Os8uid","Pruner deletes ttl failed",s.error),s},this._retryErrorMsgsIfNeeded=e=>{for(const s of e){var t;if(s.ok)continue;const{errorItems:e,toUid:i}=s.error;this._logger.zsymb(0,"tnJtfS","_retryErrorDelete "+i,null==e||null===(t=e[0])||void 0===t?void 0:t.msgId),setTimeout((()=>{Object(El.b)(this._deleteMsgsBelongToTTLItems,e)}),5e3)}},this._retryErrorDelete=e=>setTimeout((async()=>{const t=await this._ttl.getMappedMsgsByConvIdFromTTLItems(e),s=await Object(El.b)(this._deleteMsgsBelongToTTLItems,e);!s.ok&&this._logger.zsymb(18,"gYIFg5","Pruner _retryErrorDelete",s.error),s.ok&&this._emitPruneResult(s.value,t)}),5e3),this._emitPruneResult=async(e,t)=>{for(const s of e)await Object(El.b)(Bd.instance.emitPerConversation,s,t)},this._deletePerConversation=async(e,t=[])=>{var s,i,a,n,r,o,c,l,d;const h=await Object(El.b)(Ua.b.vanishMessages,e,t);if(!h.ok)return{ok:!1,error:{toUid:e,allItems:[],errorItems:t,successItems:[]}};const u=null===(s=h.value.vanish)||void 0===s?void 0:s[0],g=null===(i=h.value.quote)||void 0===i?void 0:i[0];if(!u&&!g)return{ok:!1,error:{toUid:e,conversation:{},allItems:[],errorItems:t,successItems:[]}};const m=null===(a=h.value.vanish)||void 0===a||null===(n=a[0])||void 0===n||null===(r=n.conv)||void 0===r?void 0:r.conversation;let p=[...null!==(o=null===(c=h.value.vanish)||void 0===c?void 0:c.map((e=>e.res)).flat())&&void 0!==o?o:[],...null!==(l=null===(d=h.value.quote)||void 0===d?void 0:d.flat())&&void 0!==l?l:[]];p=p.filter((e=>e));const{success:f=[],error:v=[]}=Object(Nd.a)(p,Hd),_=f.map((e=>e.info)),b=v.map((e=>e.info)),y=[..._,...b];return b.length?{ok:!1,error:{toUid:e,conversation:m,allItems:y,successItems:_,errorItems:b}}:{ok:!0,value:{toUid:e,conversation:m,allItems:y,successItems:_}}},this._deleteMsgsBelongToTTLItems=async e=>{const t=Object(Nd.a)(e,Vd),s=Object.keys(t).map((async e=>(Object(El.b)(this._sideEffect,e,t[e]),this._deletePerConversation(e,t[e]))));return await Promise.all(s)},this._sideEffect=async(e,t=[])=>setTimeout((async()=>{const s=await Object(El.b)(this._cancelSendingPerConversation,e,t);s.ok||this._logger.zsymb(18,"jB5n3d","cancelSendingPerConversation failed",s.error);const i=await Object(El.b)(this._syncDeletePerConversation,e,t);i.ok||this._logger.zsymb(18,"Ghp47C","syncDeletePerConversation failed",i.error)}),0),this._cancelSendingPerConversation=async(e,t=[])=>{t.forEach((t=>Object(El.b)((()=>{}),e,null==t?void 0:t.cliMsgId)))},this._syncDeletePerConversation=async(e,t=[])=>{if(!U.default.ttl.enable_sync_delete)return;const s=t=>{+t.msgId&&Object(Dd.e)(e,{cliMsgId:t.cliMsgId,msgId:t.msgId,sendDttm:t.sendDttm,toUid:e,fromUid:t.fromUid})};t.forEach((e=>Object(El.b)(s,e)))},this._pruning=!1,this._logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger("utils",["ttl","destructor","pruner"])}_getPruneMsgKey(e){return e?`${e.msgId}|${e.ttlType}`:""}_hasPruneMsgCache(e){return this._pruneMsgCache.has(this._getPruneMsgKey(e))}_setPruneMsgCache(e){this._pruneMsgCache.set(this._getPruneMsgKey(e),void 0)}async _deleteMsgsAndEmit(e){const t=await this._ttl.getMappedMsgsByConvIdFromTTLItems(e),s=await Object(El.b)(this._deleteMsgsBelongToTTLItems,e);s.ok||(this._logger.zsymb(18,"75OfFk","Pruner","deleteMessages failed"),this._retryErrorDelete(e)),s.ok&&this._retryErrorMsgsIfNeeded(s.value),s.ok&&this._emitPruneResult(s.value,t)}})||Gd)||Gd);s("Ceyj");var qd,Wd=s("K0f4"),Zd=s("buT3"),Kd=s("wudS");Object(m.j)()(qd=Object(m.f)()(qd=class{onAuthenticated(e){const{userId:t}=e.getSession();if(t){const e=Object(Kd.d)(t),s=`${e}_${Wd.m}`,i=Zd.a.getItem(s);if(!(null!==i))return;const a=97124,n="1"===i,r=`${e}_${Wd.g}`,o=+(Zd.a.getItem(r)||"-1"),c=isNaN(o)?-1:o,l=`${e}_${Wd.i}`,d=+(Zd.a.getItem(l)||"-1"),h=isNaN(d)?-1:d;if(n)Si.default.increaseSuccess(a,0,c,[h]);else{const t=`${e}_${Wd.c}`,s=Zd.a.getItem(t),i=Number(s);Si.default.increaseFailed(a,0,c,i,Date.now(),[h])}Zd.a.removeItem(s),Zd.a.removeItem(r),Zd.a.removeItem(l)}}onStart(){const e=Wd.l,t=Zd.a.getItem(e);if(!(null!==t))return;const s="1"===t,i=Wd.f,a=+(Zd.a.getItem(i)||"-1"),n=isNaN(a)?-1:a,r=Wd.h,o=+(Zd.a.getItem(r)||"-1"),c=isNaN(o)?-1:o;if(s)Si.default.increaseSuccess(97123,0,n,[c]);else{const e=Zd.a.getItem(Wd.b),t=Number(e);Si.default.increaseFailed(97123,0,n,t,Date.now(),[c])}Zd.a.removeItem(e),Zd.a.removeItem(i),Zd.a.removeItem(r)}})||qd);var Qd,$d=s("l9L4"),Yd=s("CDcE");Object(m.d)()(Qd=Object(i.injectable)()(Qd=Object(i.singleton)($d.a)(Qd=function(e,t){return Object(i.inject)(B.ZLoggerFactory)(e,void 0,0)}(Qd=Reflect.metadata("design:type",Function)(Qd=Reflect.metadata("design:paramtypes",[void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory])(Qd=class{constructor(e){this._isFirstLoginMap=new Map,this._firstLoginTimeMap=new Map,this._logger=void 0,this._logger=e.createZLogger("utils",["first-login-checker"])}getFirstLoginTime(e){if(this.firstLoginTimeMap.has(e))return this.firstLoginTimeMap.get(e)||this.getDefaultFirstLoginTime();try{const t=n.default.getInstance().getItemForCurrentUser(W.FirstLoginLocalStorageKeys.FIRST_LOGIN_TIME);null!=t&&this.firstLoginTimeMap.set(e,parseInt(t))}catch(t){this.logger.zsymb(21,"rlkO84",["getFirstLoginTime error {} - {}","_6QXZ5"],e,Object(Yd.f)(t,2))}return this.firstLoginTimeMap.get(e)||this.getDefaultFirstLoginTime()}isFirstLogin(e){return!!this._isFirstLoginMap.get(e)}onApplicationReady(e){this.removeFirstLoginFlag()}setFirstLogin(e,t){this._isFirstLoginMap.set(e,t)}setFirstLoginTime(e,t){this.firstLoginTimeMap.set(e,t);try{n.default.getInstance().setItemForCurrentUser(W.FirstLoginLocalStorageKeys.FIRST_LOGIN_TIME,t&&t.toString()||"")}catch(s){this.logger.zsymb(21,"cJVWCW",["setFirstLoginTime error {} - {} - {}","wFKFx7"],e,t,Object(Yd.f)(s,2))}}removeFirstLoginFlag(){const e=Z.default.getUidMe(),t=n.default.getInstance();t.getItem(W.FirstLoginLocalStorageKeys.IS_FIRST_LOGIN)===e&&t.removeItem(W.FirstLoginLocalStorageKeys.IS_FIRST_LOGIN)}getDefaultFirstLoginTime(){return D.default.getTimeNow()}get firstLoginTimeMap(){return this._firstLoginTimeMap}get logger(){return this._logger}})||Qd)||Qd)||Qd)||Qd)||Qd);const Jd=Object(i.define)("offline-detector"),Xd=Object(i.define)("event-bus");let eh=function(e){return e.USER_OFFLINE="USER_OFFLINE",e}({});class th extends De.a{constructor(){super(eh.USER_OFFLINE)}}var sh,ih=s("uGvo"),ah=s("cHDa");Object(ns.e)()(sh=Object(ns.g)([{token:Xd.token,useFactory:()=>N.default}])(sh=Object(ie.b)(Jd)(sh=function(e,t){return Object(i.inject)(Xd)(e,void 0,0)}(sh=function(e,t){return i.ModuleContainer.inject(m.a)(e,void 0,1)}(sh=Reflect.metadata("design:type",Function)(sh=Reflect.metadata("design:paramtypes",[void 0===ih.IEventBus?Object:ih.IEventBus,"undefined"==typeof BaseApplication?Object:BaseApplication])(sh=class extends De.b{constructor(e,t){super(),this.eventBus=e,this.prevNetworkState=void 0,this.onUserOffline=()=>{this.dispatchEvent(new th)},this.onUserActiveChanged=e=>{e===ah.c.LOCK_SCREEN&&this.onUserOffline()},this.onNetworkStatusChanged=e=>{e!==this.prevNetworkState&&(this.prevNetworkState=e,e===Fn.a.DISCONNECT&&this.onUserOffline())},this.prevNetworkState=null,this.registerListener(t)}registerListener(e){this.eventBus.subscribe(((e,t)=>{switch(e){case P.GeneralActions.NETWORK_STATUS:return this.onNetworkStatusChanged(t);case P.GeneralActions.USER_ACTIVE_CHANGED:return this.onUserActiveChanged(t)}})),e.addEventListener(m.b.Exit,this.onUserOffline),e.addEventListener(m.b.BeforeUnload,this.onUserOffline),e.addEventListener(m.b.LogOut,this.onUserOffline)}})||sh)||sh)||sh)||sh)||sh)||sh);const nh=Object(i.define)("transfer-data-suggestion-loader");var rh=s("cgeJ"),oh=s("XVri"),ch=s("bAqL");var lh=class{constructor(e){this._logger=void 0,this._moduleName=void 0,this._moduleName=e}log(){this.Logger.zsymb(0,"5PaeEe",this.moduleTagName,...arguments)}logError(e,t){const s=null==t?"":this.stringifyDepthLevel(t);this.Logger.zsymb(18,"6Z2nzY",this.moduleTagName,e,s)}stringifyDepthLevel(e){return Object(ch.d)(e,Object(ch.a)())}get Logger(){return this._logger||(this._logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger("msg-sync",[oh.a])),this._logger}get moduleTagName(){return this._moduleName+" - "}};var dh,hh=class{constructor(e){this.moduleName=e,this._logger=void 0,this._logger=new lh(this.moduleName)}get Logger(){return this._logger}};function uh(e){try{return JSON.stringify(e)}catch(t){return""}}function gh(e){return JSON.parse(e)}Object(i.injectable)()(dh=Object(i.singleton)(nh)(dh=Reflect.metadata("design:type",Function)(dh=Reflect.metadata("design:paramtypes",[])(dh=class extends hh{constructor(){super(rh.e.LOADER),this._friendManager=void 0,this._groupManager=void 0}async loadLastCloseBannerDownloadPC(){const e=this.getSecureLocalStorageDB();if(!e)return this.Logger.logError("Load last close banner download pc failed cause invalid storage"),Promise.reject();try{const t=await e.getItemForCurrentUserAsync(rh.b);return null!=t?gh(t):(this.Logger.logError("Load last close banner download pc failed null"),null)}catch(t){return this.Logger.logError("Load last close banner download pc failed",t),t}}async loadListConversationsFromDB(){const e=this.getSecureLocalStorageDB();if(!e)return this.Logger.logError("Load list conversations from DB failed cause invalid storage"),Promise.reject([]);try{const t=await e.getItemForCurrentUserAsync(rh.d);return null!=t?gh(t):(this.Logger.logError("Load list conversations from DB failed null"),[])}catch(t){return this.Logger.logError("Load list conversations from DB failed",t),[]}}async loadListFriends(){const e=this.getFriendManagerModule();if(e)try{return await e.getFriends()}catch(t){return this.Logger.logError("Load list friends failed",t),[]}return this.Logger.log("Load list friends empty"),[]}async loadListGroups(){const e=this.getGroupManagerModule();if(e)try{return await e.getGroupsList()}catch(t){return this.Logger.logError("Load list groups failed",t),[]}return this.Logger.log("Load list groups empty"),[]}async loadRegisteredData(){const e=this.getSecureLocalStorageDB();if(!e)return this.Logger.logError("Load registered data failed cause invalid storage"),Promise.reject();try{let t=e.getItemForCurrentUser(W.RegisterLocalStorageKeys.IS_REGISTERED_ON_THIS_DEVICE);return null!=t?{isRegisteredOnThisDevice:gh(t)}:(this.Logger.log("Load registered data null"),null)}catch(t){return this.Logger.logError("Load registered data failed",t),t}}async loadSyncMessagesData(){const e=this.getSecureLocalStorageDB();if(!e)return this.Logger.logError("Load sync messages data failed cause invalid storage"),Promise.reject();try{const t=e.getItemForCurrentUser("sync_cross_settings");return t?gh(t):(this.Logger.log("Load sync messages data null"),null)}catch(t){return this.Logger.logError("Load sync messages data failed",t),t}}async loadTransferMessagesData(){const e=this.getSecureLocalStorageDB();if(!e)return this.Logger.logError("Load transfer messages data failed cause invalid storage"),Promise.reject();try{const t=await e.getItemForCurrentUserAsync(rh.l);return t?gh(t):(this.Logger.logError("Load transfer messages data failed null"),null)}catch(t){return this.Logger.logError("Load transfer messages data failed",t),t}}async setLastCloseBannerDownloadPC(e){const t=this.getSecureLocalStorageDB();return t?await t.setItemForCurrentUserAsync(rh.b,uh(e)):Promise.reject("Invalid storage")}async setLastCloseFirstLoginTransferModal(e){const t=this.getSecureLocalStorageDB();return t?await t.setItemForCurrentUserAsync(rh.c,uh(e)):Promise.reject("Invalid storage")}async setListConversationsFirstLoginToDB(e){const t=this.getSecureLocalStorageDB();return t?await t.setItemForCurrentUserAsync(rh.d,uh(e)):Promise.reject("Invalid storage")}async updateTransferMessagesData(e){const t={lastTransferSuccessTime:e.lastTransferSuccessTime||Date.now()};try{return await this.getSecureLocalStorageDB().setItemForCurrentUserAsync(rh.l,uh(t))}catch(s){return s}}getFriendManagerModule(){var e;this._friendManager||(this._friendManager=null===(e=s("UiPd"))||void 0===e?void 0:e.default);return this._friendManager}getGroupManagerModule(){var e;this._groupManager||(this._groupManager=null===(e=s("Gm1y"))||void 0===e?void 0:e.default);return this._groupManager}getSecureLocalStorageDB(){return n.default.getInstance()}})||dh)||dh)||dh);var mh=s("n09q"),ph=s("31cx"),fh=s("a1r1"),vh=s("BO4k");var _h,bh=class extends hh{constructor(e,t){super(oh.c.MANAGER),this._eventMap=new Map,this._fistLoginTime=void 0,this._listConversationsBeforeLogin=[],this._isTransferAfterLogin=void 0,this._moduleLoader=void 0,this._moduleUIManager=void 0,this._moduleLoader=e,this._moduleUIManager=t,this._isTransferAfterLogin=!1,this.handleUpdateConfigs=this.handleUpdateConfigs.bind(this),this.isDisplayedBannerDownloadPCSuggestion=this.isDisplayedBannerDownloadPCSuggestion.bind(this),this.isDisplayedBubbleInfoEcard=this.isDisplayedBubbleInfoEcard.bind(this),this.isDisplayedCloseButtonBannerDownloadPC=this.isDisplayedCloseButtonBannerDownloadPC.bind(this),this.isDisplayedConversationFooter=this.isDisplayedConversationFooter.bind(this),this.isDisplayedGlobalSearchFooter=this.isDisplayedGlobalSearchFooter.bind(this),this.isDisplayedSearchInConversationFooter=this.isDisplayedSearchInConversationFooter.bind(this),this.isDisplayedMilestoneInPreviewMedia=this.isDisplayedMilestoneInPreviewMedia.bind(this),this.isDisplayedSuggestionInMediaList=this.isDisplayedSuggestionInMediaList.bind(this),this.isDisplayedTransferModal=this.isDisplayedTransferModal.bind(this),this.isValidForTransferMessages=this.isValidForTransferMessages.bind(this)}addEventListeners(e,t){this.eventMap.set(e,[...this.eventMap.get(e)||[],t])}callTransferMessages(e){}closeBannerDownloadPCSuggestion(){}getConversationFooterRendererHeight(){return this.isDisplayedConversationFooter()?oh.b.CONVERSATION:0}getFirstLoginTime(){return this.firstLoginTime}getGlobalSearchFooterRendererHeight(){return this.isDisplayedConversationFooter()?oh.b.GLOBAL_SEARCH:0}getLogger(){return this.Logger}getUrlDownloadPC(){return""}getIsTransferAfterLogin(){return this.isTransferAfterLogin}hasConversationBeforeFirstLogin(e){return this._listConversationsBeforeLogin.includes(e)}hideTransferMessagesModal(){}async initialize(){this.firstLoginTime=i.ModuleContainer.resolve(fh.a).getFirstLoginTime(this.getUserId()),this.handleUpdateConfigs(vh.a()),this.registerSubscriptions(),await this.initializeListConversationsBeforeFirstLogin()}isDisplayedBannerDownloadPCSuggestion(){return!!this.isEnabledFeature()&&vh.e()}isDisplayedBubbleInfoEcard(e){return!!this.isEnabledFeature()&&(!!vh.f()&&this.hasConversationBeforeFirstLogin(e))}isDisplayedCloseButtonBannerDownloadPC(){return!!this.isEnabledFeature()&&vh.i()}isDisplayedConversationFooter(){return!!this.isEnabledFeature()&&vh.j()}isDisplayedCTADownloadPC(){return!!this.isEnabledFeature()&&vh.g()}isDisplayedCTATransferMessages(){return!!this.isEnabledFeature()&&vh.h()}isDisplayedGlobalSearchFooter(){return!!this.isEnabledFeature()&&vh.k()}isDisplayedSearchInConversationFooter(e){return!!this.isEnabledFeature()&&(!!vh.n()&&this.hasConversationBeforeFirstLogin(e))}isDisplayedMilestoneInPreviewMedia(e){return!!this.isEnabledFeature()&&(!!vh.m()&&this.hasConversationBeforeFirstLogin(e))}isDisplayedSuggestionInMediaList(e){return!!this.isEnabledFeature()&&(!!vh.l()&&this.hasConversationBeforeFirstLogin(e))}isDisplayedTransferModal(){return!!this.isEnabledFeature()&&vh.o()}isEnabledFeature(){return vh.p()}isValidSupportDownloadPC(){return!1}isValidForTransferMessages(){return this.isEnabledFeature()}needTransferMessages(){}removeEventListeners(e,t){const s=this.eventMap.get(e);if(Array.isArray(s)){const e=s.findIndex((e=>e===t));-1!==e&&s.splice(e,1)}}setFirstLoginTime(e){this.firstLoginTime=e}setIsTransferAfterLogin(e){this.isTransferAfterLogin=e}shouldTransferMessages(){return!1}showTransferMessagesModal(){}registerSubscriptions(){U.$AppConfig.subscribe(this.handleUpdateConfigs)}isFirstLogin(){return i.ModuleContainer.resolve(fh.a).isFirstLogin(this.getUserId())}async initializeListConversationsBeforeFirstLogin(){this._listConversationsBeforeLogin=await this.loadListConversationsBeforeFirstLogin()}handleUpdateConfigs(e={}){const{data_content:t}=vh.b(e),{first_time_login_device:s}=e;t&&this.UIManager.updateDataContent(Object(ph.a)(t)),null!=s&&(this.firstLoginTime=s)}async loadListConversations(){const e=[],t=await this.loaderModule.loadListFriends();Array.isArray(t)&&t.forEach((t=>{e.push(t.userId)}));const s=await this.loaderModule.loadListGroups();return Array.isArray(s)&&s.forEach((t=>{e.push(t.userId)})),e}async loadListConversationsBeforeFirstLogin(){let e;if(this.isFirstLogin())e=await this.loadListConversations(),this.loaderModule.setListConversationsFirstLoginToDB(e);else{const t=await this.loaderModule.loadListConversationsFromDB();e=t,(t||[]).length||(e=await this.loadListConversations(),this.loaderModule.setListConversationsFirstLoginToDB(e))}return e}notifyEvent(e,...t){const s=this.eventMap.get(e);Array.isArray(s)&&s.forEach((e=>Promise.resolve((()=>e(...t)))))}get firstLoginTime(){return this._fistLoginTime}set firstLoginTime(e){this._fistLoginTime=e}get isTransferAfterLogin(){return this._isTransferAfterLogin}set isTransferAfterLogin(e){this._isTransferAfterLogin=e}get eventMap(){return this._eventMap}get loaderModule(){return this._moduleLoader}get UIManager(){return this._moduleUIManager}getUserId(){const e=i.ModuleContainer.resolve(m.a),{userId:t}=e.getSession()||{};return t||""}},yh=s("mgoj"),Ih=s("JCvM"),Sh=s("Vp9m"),Ch=s("y4fj");Object(i.injectable)()(_h=Object(m.d)()(_h=Object(i.singleton)(mh.a)(_h=function(e,t){return Object(i.inject)(nh)(e,void 0,0)}(_h=function(e,t){return Object(i.inject)(yh.a)(e,void 0,1)}(_h=function(e,t){return Object(i.inject)(Fo.a)(e,void 0,2)}(_h=Reflect.metadata("design:type",Function)(_h=Reflect.metadata("design:paramtypes",[Object,void 0===Ih.ITransferDataSuggestionUIManager?Object:Ih.ITransferDataSuggestionUIManager,void 0===Fo.a?Object:Fo.a])(_h=class extends bh{constructor(e,t,s){super(e,t),this._moduleSyncMessages=void 0,this._isImportedMessages=!1,this._isRegisteredOnThisDevice=!1,this._shouldTransferMessages=!1,this._transferMessagesData={lastTransferSuccessTime:void 0},this._moduleSyncMessages=s}callTransferMessages(e){this.Logger.log("call transfer messages",e);switch(this.syncMessagesModule.getCurrentSyncScreenState()){case Zo.a.Hidden:case Zo.a.SuggestNewSync:return void this.syncMessagesStartSync(e);case Zo.a.SuggestResume:return void this.syncMessagesResume();case Zo.a.SyncGuide:return this.syncMessagesModule.metricts.clickViewGuide(),void this.syncMessagesModule.showSuggestPopup();case Zo.a.WaitForBackup:case Zo.a.DownloadingBackup:case Zo.a.DecryptingBackup:case Zo.a.SyncInProgress:case Zo.a.ClearData:case Zo.a.SyncSuccess:return void this.syncMessagesShowToast();case Zo.a.WaitForNetwork:case Zo.a.Error:return void this.syncMessagesStartSync(e);default:return}}async initialize(){await super.initialize(),await this.loadTransferMessagesData(),await this.loadSyncMessagesData(),await this.loadRegisteredData(),this.loadImportMessagesData()}hideTransferMessagesModal(){const e=D.default.getTimeNow();this.UIManager.hideTransferMessagesModal(),this._moduleLoader.setLastCloseFirstLoginTransferModal(e)}isDisplayedBannerDownloadPCSuggestion(){return!1}isDisplayedBubbleInfoEcard(e){return!!super.isDisplayedBubbleInfoEcard(e)&&(!this.isTransferredMessages()&&!this.isImportedMessages())}isDisplayedConversationFooter(){return!!super.isDisplayedConversationFooter()&&(!this.isTransferredMessages()&&!this.isImportedMessages())}isDisplayedGlobalSearchFooter(){return!!super.isDisplayedConversationFooter()&&(!this.isTransferredMessages()&&!this.isImportedMessages())}isDisplayedMilestoneInPreviewMedia(e){return!!super.isDisplayedMilestoneInPreviewMedia(e)&&(!this.isTransferredMessages()&&!this.isImportedMessages())}isDisplayedSearchInConversationFooter(e){return!!super.isDisplayedSearchInConversationFooter(e)&&(!this.isTransferredMessages()&&!this.isImportedMessages())}isDisplayedSuggestionInMediaList(e){return!!super.isDisplayedSuggestionInMediaList(e)&&(!this.isTransferredMessages()&&!this.isImportedMessages())}shouldTransferMessages(){return this._shouldTransferMessages}isValidForTransferMessages(){return!0}needTransferMessages(){this._shouldTransferMessages=!0}onApplicationReady(e){this.delayedCheckTransferMessagesSuggestionOnApplicationReady(),this.isEnabledFeature()&&(this.isRegisteredOnThisDevice()&&this.UIManager.turnOffDisplayingEntryPoints(),this.isTransferredMessages()||this.isImportedMessages()||this.isRegisteredOnThisDevice()||Ch.a.logAction(Ch.a.Common.DISPLAYED_NOT_ENOUGH_DATA_MESSAGE))}showTransferMessagesModal(){Ch.a.logAction(Ch.a.Modal.DISPLAYED),this.UIManager.showTransferMessagesModal()}checkTransferMessagesSuggestionOnApplicationReady(){!this.getIsTransferAfterLogin()&&this.isEnabledFeature()&&this.isFirstLogin()&&!this.isTransferredMessages()&&this.shouldTransferMessages()&&this.isDBCorruptionNotDetected()&&this.showTransferMessagesModal()}delayedCheckTransferMessagesSuggestionOnApplicationReady(){setTimeout((()=>this.checkTransferMessagesSuggestionOnApplicationReady()),dc.a.transfer_when_login.time_wait_for_temp_key)}handleEvents(e,t){if(e===Bi.c.EXPORT_IMPORT_FINISHED){const{type:e,error:s}=t;e!==Bi.g.IMPORT_TYPE||s||this.handleImportMessagesSuccess()}}handleImportMessagesSuccess(){this._isImportedMessages=!0,this.UIManager.turnOffDisplayingEntryPoints(),i.ModuleContainer.resolve(Ks.ConvListController).rerenderList()}handleSyncMessagesSuccess(){this.transferMessagesData={lastTransferSuccessTime:D.default.getTimeNow()},this.loaderModule.updateTransferMessagesData(this.transferMessagesData),this.UIManager.turnOffDisplayingEntryPoints(),i.ModuleContainer.resolve(Ks.ConvListController).rerenderList()}isImportedMessages(){return this._isImportedMessages}isRegisteredOnThisDevice(){return this._isRegisteredOnThisDevice}isTransferredMessages(){return Boolean(this.transferMessagesData&&null!=this.transferMessagesData.lastTransferSuccessTime)}isDBCorruptionNotDetected(){return!ye.p.getIsDBCorruptionDetected()}loadImportMessagesData(){const e=s("XSmZ").default;if(e){const t=e.getExportImportInformation();t&&null!=t.lastTimeImportSuccess&&(this._isImportedMessages=!0)}}async loadRegisteredData(){const e=await this.loaderModule.loadRegisteredData();e&&null!=e.isRegisteredOnThisDevice&&(this._isRegisteredOnThisDevice=e.isRegisteredOnThisDevice)}async loadSyncMessagesData(){try{const e=await this.loaderModule.loadSyncMessagesData();e&&e.lastSync&&0!=e.lastSync&&this.updateLastTransferSuccessTime(e.lastSync)}catch(e){}}async loadTransferMessagesData(){try{const e=await this.loaderModule.loadTransferMessagesData();e&&(this.transferMessagesData=e,this.UIManager.turnOffDisplayingEntryPoints())}catch(e){}}updateLastTransferSuccessTime(e){this.transferMessagesData.lastTransferSuccessTime=e}registerSubscriptions(){super.registerSubscriptions(),this.syncMessagesModule.addEventListener(Uo.e.ON_SUCCESS,this.handleSyncMessagesSuccess.bind(this)),N.default.subscribe(this.handleEvents.bind(this))}syncMessagesShowToast(){Sh.default.show({textKey:"STR_TRANSFERRING_MSG_TOAST",type:Sh.TOAST_TYPE.INFO,noBackground:!0,duration:vh.d()})}syncMessagesStartSync(e){let t;switch(e){case oh.j.CONVERSATION:t=Io.j.CSC_LIST;break;case oh.j.BUBBLE_CSC:t=Io.j.CSC;break;case oh.j.SEARCH_IN_CONVERSATION:case oh.j.GLOBAL_SEARCH:t=Io.j.SEARCH;break;default:t=Io.j.FIRST_TIME_LOGIN}this.syncMessagesModule.sync(t)}syncMessagesResume(){this.syncMessagesModule.resume()}get syncMessagesModule(){return this._moduleSyncMessages}get transferMessagesData(){return this._transferMessagesData}set transferMessagesData(e){this._transferMessagesData=e}})||_h)||_h)||_h)||_h)||_h)||_h)||_h);var Eh,Oh=class extends hh{constructor(){super(oh.c.UI),this.key=Ih.c,this.name=Ih.c,this.dataState=Object(T.a)({},oh.f),this.UIState=Object(T.a)({},oh.g)}closeBannerDownloadPCSuggestion(){}hideTransferMessagesModal(){}init(e){}initialize(){const{data_content:e}=Object(vh.b)(Object(vh.a)());this.handleUpdateContent(e)}getItem(e,t){return e.key===oh.e?this.dataState:e.key===oh.h?this.UIState:{}}getList(e,t){return[]}turnOffDisplayingEntryPoints(){this.handleUpdateRenderer({isDisplayedEntryPoints:!1})}onGetItemFailure(e,t){}onGetListFailure(e,t){}showTransferMessagesModal(){}updateDataContent(e){this.handleUpdateContent(e)}setDataState(e){const t=Object(kt.a)(this.dataState,e);this.dataState!==t&&(this.dataState=t,Object(Zs.g)(this.name,oh.e))}setUIState(e){const t=Object(kt.a)(this.UIState,e);this.UIState!==t&&(this.UIState=t,Object(Zs.g)(this.name,oh.h))}handleUpdateContent(e){this.setDataState((t=>{t.version=e.version,t.content=e.content}))}handleUpdateRenderer(e){this.setUIState((t=>{for(const s in e)t[s]=e[s]}))}};Object(ie.b)(Ih.b)(Eh=class extends Oh{hideTransferMessagesModal(){this.setUIState((e=>{e[rh.k.TRANSFER_MODAL].isDisplayed=!1}))}getItem(e,t){const s=super.getItem(e,t);if(!s)return;let i={};if(e.key===rh.g){const{content:e={}}=s;for(const t in e){const s=e[t];if(s)for(const e in s){var a;i[t]||(i[t]={}),i[t][e]=null===(a=s[e])||void 0===a?void 0:a.pc}}}else i=s;return i}showTransferMessagesModal(){this.setUIState((e=>{e[rh.k.TRANSFER_MODAL].isDisplayed=!0}))}});var Th=Object(i.define)("forward-message-pool-factory"),Mh=s("oAAg");var Rh=class{createPool(e,t){return Object(Mh.createPool)(e,t)}};i.ModuleContainer.register(Th,Rh);var wh=s("iuM+"),Lh=s("WOYD"),Fh=s("qWd+");function Dh(e){const t={success:[],failed:[]};for(const s of e)s.success&&s.success.length&&t.success.push(...s.success),s.failed&&s.failed.length&&t.failed.push(...s.failed);return t}function Ah(e){let t=[],s=[],i="";return e.forEach((e=>{e===U.default.sendToMeId?i=e:e.startsWith(W.GROUPID_PREFIX)?t.push(e):s.push(e)})),{groups:t,oneOnes:s,sendToMe:i}}function Nh(e,t=50){let s=[];for(let i=0;i<e.length;i+=t)s.push(e.slice(i,i+t));return s}function kh(e,t,s,a){const{userId:n}=i.ModuleContainer.resolve(m.a).getSession()||{};let r=A.default.getMsgIdSendingFromCliMsgId(t),o=e.startsWith(W.GROUPID_PREFIX);const c=new ea.b(n,e,r,t,s,o,a);return ta.a.instance().isOnE2ee(e)&&(c.e2eeStatus=W.MSG_E2EE),c}var Ph=s("Eyfw");var jh=async function(e,t,s){const i=Ki.default.getChatBoxControllerByWindowId(yt.c);if(s.failed.length){const a=s.failed[0].error,n=s.failed[0].clientId;i._handleForwardedMessageFailure(a,{toUid:t.userId,message:e,clientId:n},t)}};const Uh={USER:3,GROUP:6,OA:5};function Bh(e){let t=e;return t&&t.startsWith(W.GROUPID_PREFIX)&&(t=t.substr(W.GROUPID_PREFIX.length)),t}function Gh(e,t,s){if(!(e.fromUid&&e.cliMsgId&&e.msgId&&e.sendDttm&&t))return{};if(s!==U.default.sendToMeId)return{};let i=e.toUid||e.userId,a=function(e){if(!e)return!1;let t=e.userId||e.id;return"string"==typeof t&&!t.startsWith(W.GROUPID_PREFIX)&&e.type>=1}({userId:s})?Uh.OA:i.startsWith(W.GROUPID_PREFIX)?Uh.GROUP:Uh.USER;return{tId:Bh(i),srcType:a,srcId:"0"==e.fromUid?t:e.fromUid,cmi:e.cliMsgId,gmi:e.msgId,ts:e.sendDttm+""}}function zh(e){const t=Ki.default.getChatBoxControllerByWindowId(yt.c)._getConversationInfo(e);if(!t){if(e.startsWith(W.GROUPID_PREFIX)){return Fe.default.getGroupByIdSync(e)}return Z.default.getProfileFriendByIdSync(e)}return t}var xh=async function(e,t,s){const i=(null==s?void 0:s.retry)||!1,a=i?e.cliMsgId:Xi.a.next(),n=(i&&e.msgId,Ph.a.preprocessMessage(a+"",e,void 0,!1,null)),r=zh(t),o={success:[],failed:[]};try{const e=await Ph.a.forward(a+"",n,r);if(e){const s=e.msgId||e.minGlobalMsgId;o.success.push({clientId:a+"",msgId:s+"",minGlobalMsgId:e.minGlobalMsgId+"",toUid:t})}else o.failed.push({clientId:a+"",error:"invalid response",toUid:t})}catch(c){o.failed.push({clientId:a+"",error:c,toUid:t})}return jh(n,r,o),o},Vh=s("/5+7"),Hh=s("sANj"),qh=s("UyAE");var Wh=async function(e,t,s=[],a=!1){const n={},r={},o=a?e.msgId:"";for(let c=0;c<t.length;c++){let a=s[c]||Xi.a.next();const l=t[c];n[l]=a;const d=kh(l,a,W.MSG_FILE,Object(T.a)({},e.message));d.localPath=e.localPath,d.folderPath=e.folderPath,r[l]=d;const h=Ki.default.getChatBoxControllerByWindowId(yt.c),u=zh(l);if(U.default.forward_messages.enable_tracking_log){i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger("forward-log",["track forward file"]).zsymb(18,"hiicRt","call _showLocalMessage: ",JSON.stringify(d))}h._showLocalMessage(d,u,null,o,W.MSG_CHECKING_EXIST);const g=`${a}_${ye.p.getSessionUserId()}_${t[c]}`;Vh.a.dispatch(Hh.FileActionType.ExtraInfo,{fileKey:Vh.a.getFileKey(g),extraInfo:{sendFileError:void 0}}),qh.a.set(null==a?void 0:a.toString(),{localPath:e.localPath,folderPath:e.folderPath})}return{localMsgs:r}},Zh=s("D5jy");var Kh=async function(e,t){const s=Ki.default.getChatBoxControllerByWindowId(yt.c),i={};for(const a in e)e[a]&&e[a].clientId&&(i[e[a].clientId]=e[a]);t.success.length&&t.success.forEach((e=>{s&&s._sentMessage(i[e.clientId],e)})),t.failed.length&&t.failed.forEach((e=>{!async function(e,t,s){const i=t.error;i===W.FORWARD_ERR_CODE.EXPIRED||i===Zh.a.FILE_EXPIRED||i===W.FORWARD_ERR_CODE.SERVER_YAWNING||W.FORWARD_ERR_CODE.SEND_FAIL,s._handleForwardedMessageFailure(i,e,zh(e.conversationId))}(i[e.clientId],e,s)}))};var Qh=async function(e,t,s){const i={success:[],failed:[]},a=null!=s&&s.retry?parseInt(e.cliMsgId):Xi.a.next(),{localMsgs:n}=await Wh(e,[t],[a],null==s?void 0:s.retry);try{const s=await Ni.default.forwardMessage(t,e,a,W.RETRY_MSG_TIMEOUT_DEFAULT,!1,n[t],null);if(s){const e=s.msgId||s.minGlobalMsgId;i.success.push({clientId:a+"",msgId:e+"",minGlobalMsgId:s.minGlobalMsgId+"",toUid:t})}else i.failed.push({clientId:a+"",error:"invalid response",toUid:t})}catch(r){i.failed.push({clientId:a+"",error:r,toUid:t})}return await Kh(n,i),i},$h=function(e){return async function(e,t,s={}){const i=Fh.a.checkIsMessageFileE2ee(e),a=[];for(let n=0;n<t.length;n++){const r=ta.a.instance().isOnE2ee(t[n]);Fh.a.checkIsForwardCrossConversation(i,r)?a.push(xh(e,t[n],s)):a.push(Qh(e,t[n],s))}return Dh(await Promise.all(a))}(e.message,e.toUids,e.options)},Yh=s("dm9D"),Jh=s("iEwR");var Xh=async function(e,t,s={}){const{userId:a}=i.ModuleContainer.resolve(m.a).getSession()||{},n={},r={},o=(null==s?void 0:s.retry)||!1,c=o?e.msgId:"";for(let i=0;i<t.length;i++){let s=o?e.cliMsgId:Xi.a.next();const l=t[i],d=Gh(e,a||"",l);r[l]=d;const h=kh(l,s,W.MSG_PHOTO,Object(T.a)({},e.message));h.updateMessageProp("properties",e.properties),h.updateMessageProp("localPath",e.localPath),n[l]=h;const u=Ki.default.getChatBoxControllerByWindowId(yt.c),g=zh(l);u._showLocalMessage(h,g,null,c,W.MSG_CHECKING_EXIST)}return{localMsgs:n,additionalList:r}};var eu=async function(e,t){const s=Ki.default.getChatBoxControllerByWindowId(yt.c),i={};for(const a in e)e[a]&&e[a].clientId&&(i[e[a].clientId]=e[a]);t.success.length&&t.success.forEach((e=>{s&&s._sentMessage(i[e.clientId],e)})),t.failed.length&&t.failed.forEach((e=>{!async function(e,t,s){const i=t.error;if(i===W.FORWARD_ERR_CODE.EXPIRED||i===Zh.a.FILE_EXPIRED);else{if(i===W.FORWARD_ERR_CODE.SERVER_YAWNING)return;if(i===W.FORWARD_ERR_CODE.SEND_FAIL)return}s._handleForwardedMessageFailure(i,e,zh(e.conversationId))}(i[e.clientId],e,s)}))};var tu=async function(e,t,s){const{localMsgs:a,additionalList:n}=await Xh(e,t,s),r={success:[],failed:[]},o=i.ModuleContainer.resolve(Jh.TAIStickerMessageAppService);for(let i=0;i<t.length;i++){const s=a[t[i]].clientId,l=Object(T.a)({},e);ta.a.instance().isOnE2ee(t[i])&&(l.e2eeStatus=W.MSG_E2EE);try{const e=await o.forwardAIStickerMessage(t[i],s,l,{retryTimeout:W.RETRY_MSG_TIMEOUT_DEFAULT,lowPriority:!1,fwAdditional:n[t[i]]});r.success.push(Object(T.a)(Object(T.a)({},e),{},{clientId:s+"",toUid:t[i]}))}catch(c){r.failed.push({clientId:s+"",error:c,toUid:t[i]})}}return await eu(a,r),r},su=s("Ullg");var iu=async function(e,t,s){const{localMsgs:i,additionalList:a}=await Xh(e,t,s),n={success:[],failed:[]};for(let o=0;o<t.length;o++){const s=t[o],c=i[s].clientId,l=Object(T.a)({},e);ta.a.instance().isOnE2ee(s)&&(l.e2eeStatus=W.MSG_E2EE);try{const e=await su.a.Helper.forwardPhotoSticker(s,l,c,W.RETRY_MSG_TIMEOUT_DEFAULT,!1,a[s]);n.success.push(Object(T.a)(Object(T.a)({},e),{},{toUid:s,clientId:c+""}))}catch(r){n.failed.push({clientId:c+"",error:r,toUid:s})}}return await eu(i,n),n};var au=async function(e,t,s){const a=(null==s?void 0:s.retry)||!1?e.cliMsgId:Xi.a.next(),n=Ph.a.preprocessMessage(a+"",e,s.photoBundle),r=zh(t),o=async function(e,t){const{userId:s}=i.ModuleContainer.resolve(m.a).getSession()||{};return Gh(e,s||"",t)}(e,t),c={success:[],failed:[]};try{const e=await Ph.a.forward(a+"",n,r,o);if(e){let s=e.msgId||e.minGlobalMsgId;c.success.push({clientId:a+"",msgId:s+"",minGlobalMsgId:e.minGlobalMsgId+"",toUid:t})}else c.failed.push({clientId:a+"",error:"invalid response",toUid:t})}catch(l){c.failed.push({clientId:a+"",error:l,toUid:t})}return jh(n,r,c),c};var nu=async function(e,t,s){var i;const a={success:[],failed:[]};let n=A.default.safeParseJson(null==e||null===(i=e.message)||void 0===i?void 0:i.params)||{};null!=n&&n.group_layout_id&&(delete n.group_layout_id,delete n.id_in_group,delete n.is_group_layout,delete n.total_item_in_group),s.photoBundle&&Object.assign(n,{is_group_layout:1,group_layout_id:s.photoBundle.groupLayoutId,id_in_group:s.photoBundle.idInGroup,total_item_in_group:s.photoBundle.totalItemInGroup});const r=Object(T.a)({},e.message);r.params=JSON.stringify(n);const o=Object(T.a)(Object(T.a)({},e),{},{message:r}),{localMsgs:c,additionalList:l}=await Xh(o,[t],s),d=c[t].clientId+"";try{let i=!1;s.photoBundle&&(i=Object(T.a)(Object(T.a)({},s.photoBundle),{},{clientId:d}));const n=await Ni.default.forwardMessage(t,Object(T.a)(Object(T.a)({},e),{},{message:r,forwardInGroup:i}),d,W.RETRY_MSG_TIMEOUT_DEFAULT,!1,c[t],l[t]);if(n){let e=n.msgId||n.minGlobalMsgId;a.success.push({clientId:d,msgId:e+"",minGlobalMsgId:n.minGlobalMsgId+"",toUid:t,thumbUrl:n.thumbUrl,oriUrl:n.oriUrl||n.hdUrl||n.rawUrl,hdUrl:n.hdUrl})}else a.failed.push({clientId:d,error:"invalid response",toUid:t})}catch(h){a.failed.push({clientId:d,error:h,toUid:t})}return await eu(c,a),a};var ru=async function(e,t,s){const i=Fh.a.checkIsMessageFileE2ee(e),a=[];for(let n=0;n<t.length;n++){const r=ta.a.instance().isOnE2ee(t[n]);Fh.a.checkIsForwardCrossConversation(i,r)?a.push(au(e,t[n],s)):a.push(nu(e,t[n],s))}return Dh(await Promise.all(a))},ou=function(e){return async function(e,t,s={}){return Object(Yh.a)(e)?await tu(e,t,s):A.default.isPhotoStickerMessage(e)?await iu(e,t,s):await ru(e,t,s)}(e.message,e.toUids,e.options)};var cu=async function(e,t,s){const i={success:[],failed:[]},a=(null==s?void 0:s.retry)||!1?e.cliMsgId:Xi.a.next(),n=Ph.a.preprocessMessage(a+"",e,s.photoBundle),r=zh(t);try{const e=await Ph.a.forward(a+"",n,r);if(e){const s=e.msgId||e.minGlobalMsgId;i.success.push({clientId:a+"",msgId:s+"",minGlobalMsgId:e.minGlobalMsgId+"",toUid:t})}else i.failed.push({clientId:a+"",error:"invalid response",toUid:t})}catch(o){i.failed.push({clientId:a+"",error:o,toUid:t})}return jh(n,r,i),i};var lu=async function(e,t,s){const i=(null==s?void 0:s.retry)||!1,a=i?e.msgId:"",n=i?e.cliMsgId:Xi.a.next(),r=Ph.a.preprocessMessage(n+"",e,s.photoBundle),o=kh(t,n,W.MSG_VIDEO,Object(T.a)({},r.message));o.localPath=e.localPath;const c=Ki.default.getChatBoxControllerByWindowId(yt.c),l=zh(t);return c._showLocalMessage(o,l,null,a,W.MSG_CHECKING_EXIST),[o,r]};var du=async function(e,t){const s=Ki.default.getChatBoxControllerByWindowId(yt.c),i={};for(const a in e)e[a]&&e[a].clientId&&(i[e[a].clientId]=e[a]);t.success.length&&t.success.forEach((e=>{s&&s._sentMessage(i[e.clientId],e)})),t.failed.length&&t.failed.forEach((e=>{!async function(e,t,s){const i=t.error;i===W.FORWARD_ERR_CODE.EXPIRED||i===Zh.a.FILE_EXPIRED||i===W.FORWARD_ERR_CODE.SERVER_YAWNING||W.FORWARD_ERR_CODE.SEND_FAIL,s._handleForwardedMessageFailure(i,e,zh(e.conversationId))}(i[e.clientId],e,s)}))};var hu=async function(e,t,s){const i={success:[],failed:[]},[a,n]=await lu(e,t,s),r=a.clientId+"";let o=!1;s.photoBundle&&(o=Object(T.a)(Object(T.a)({},s.photoBundle),{},{clientId:r}));try{const e=await Ni.default.forwardMessage(t,n,r,W.RETRY_MSG_TIMEOUT_DEFAULT,!1,a,null);if(e){const s=e.msgId||e.minGlobalMsgId;i.success.push({clientId:r,msgId:s+"",minGlobalMsgId:e.minGlobalMsgId+"",toUid:t,_msgObject:e._msgObject||null})}else i.failed.push({clientId:r,error:"invalid response",toUid:t})}catch(c){i.failed.push({clientId:r,error:c,toUid:t})}return await du({[t]:a},i),i};var uu=async function(e,t,s={}){const i=[];for(let a=0;a<t.length;a++){const n=t[a],r=ta.a.instance().isOnE2ee(n),o=Fh.a.checkIsMessageFileE2ee(e);Fh.a.checkIsForwardCrossConversation(o,r)?i.push(cu(e,t[a],s)):i.push(hu(e,t[a],s))}return Dh(await Promise.all(i))};var gu=async function(e){return uu(e.message,e.toUids,e.options)};var mu=async function(e,t,s={}){const i=e.message,a=[];for(let n=0;n<t.length;n++){const e=t[n];let r=Xi.a.next();for(let t=0;t<i.length;t++){const n=i[t],o={isGroupLayout:1,groupLayoutId:r,totalItemInGroup:i.length,idInGroup:t};s.photoBundle=o,n.msgType===W.MSG_VIDEO?a.push(gu({message:n,toUids:[e],options:s})):a.push(ou({message:n,toUids:[e],options:s}))}}return Dh(await Promise.all(a))},pu=function(e){return mu(e.message,e.toUids,e.options)},fu=s("Hllb"),vu=s("KZut");var _u=async function(e,t,s={}){var i;const a=e.message&&"object"==typeof e.message&&"rtf"===e.message.action,n=A.default.getSubtypeMessage(e);let r=null;const o=(null==s?void 0:s.retry)||!1,c=o?e.msgId:"",l={},d={};let h=A.default.ZSafeFunction((()=>-1==n||n==W.MSG_SUBTYPE_LINK||a?A.default.stripInvalidChar(e.message):e.message&&"object"==typeof e.message?e.message.title:""),"");if(!h)throw Object(fu.createForwardError)("Empty message",fu.ForwardErrorCode.EmptyString,e);let u=ts.b.findFirstUrl(h,!0,!1);u&&vu.a.checkValidSuffix(u)&&e.shouldParseLinkOrContact&&(e.containType=2),a&&"object"==typeof e.message&&null!==(i=e.message)&&void 0!==i&&i.params&&(l.rtfProps=function(e){if("string"==typeof e)return e;try{return JSON.stringify(e)}catch(t){return""}}(e.message.params),l.styles=l.rtfProps);for(let g=0;g<t.length;g++){const s=t[g];const i=kh(s,(o?e.cliMsgId:Xi.a.next())+"",W.MSG_TEXT);a&&"object"==typeof e.message?(i.updateMessageContentProp(ea.a.RTF,e.message),i.updateMessageContentProp(ea.a.TEXT,e.message.title)):i.updateMessageContentProp(ea.a.TEXT,h),e.containType&&(i.containType=e.containType,i.shouldParseLinkOrContact=e.shouldParseLinkOrContact),d[s]=i;const n=Ki.default.getChatBoxControllerByWindowId(yt.c),l=zh(s);if(n._showLocalMessage(i,l,null,c),u&&e.shouldParseLinkOrContact){const t=Bs.c.create(u).withTimeout(Q.a.ParserConfig.get("max_delay_send_message"));Q.a.ParserConfig.get("enable_upload_thumb_for_delay_send")?t.do("full-process",[Bs.a.SHARE_MESSAGE,s]):t.do("parse",[Bs.a.SHARE_MESSAGE]);const a=await t.exec().toPromise();a&&(i.type=W.MSG_LINK_CLIENT,i.updateMessageContentProp(ea.a.LINK,Object(T.a)({},a)),d[s]=i,r=i.convertToUIMessageObject(),n._showLocalMessage(i,l,null,c)),Bs.b.getInstance().report({key:null==e?void 0:e.msgId,href:u,entry:Bs.a.SHARE_MESSAGE,preview:a})}}return{localMsgs:d,additional:l,updatedForwardMsgItem:r}};async function bu(e,t){const s=Ki.default.getChatBoxControllerByWindowId(yt.c),i={};for(const a in e)e[a]&&e[a].clientId&&(i[e[a].clientId]=e[a]);t.success.length&&t.success.forEach((e=>{s&&s._sentMessage(i[e.clientId],e)})),t.failed.length&&t.failed.forEach((e=>{if(s){const t=i[e.clientId],a=t.conversationId;_t.default.deleteMessageById(A.default.getMsgIdSendingFromCliMsgId(e.clientId),a),s._handleForwardedMessageFailure(e.error,t,zh(a))}}))}const yu={USER:3,GROUP:6,OA:5};function Iu(e){let t=e;return t&&t.startsWith(W.GROUPID_PREFIX)&&(t=t.substr(W.GROUPID_PREFIX.length)),t}function Su(e,t){if(!(t&&e.fromUid&&e.cliMsgId&&e.msgId&&e.sendDttm))return{};let s=e.toUid||t,i=yu.USER;s.startsWith(W.GROUPID_PREFIX)?i=yu.GROUP:function(e){if(!e)return!1;const t=Z.default.getProfileFriendSync(e);return t&&t.type>=1}(t)&&(i=yu.OA);let a=e.fromUid;return"0"==a&&(a=Z.default.getProfileMeSync().userId),{tId:Iu(s),srcType:i,srcId:a,cmi:e.cliMsgId,gmi:e.msgId+"",ts:e.sendDttm}}async function Cu(e,t,s){const i=U.default.sendToMeId||"";let a=Su(e,i),n=s?Object(T.a)(Object(T.a)({},s),a):a,r=t.clientId;const o={success:[],failed:[]};try{const t=await Ni.default.forwardMultiMessage([{clientId:r,toUid:i}],e,!1,1e4,!1,n);t.success&&t.success.length&&t.success.forEach((e=>{o.success.push(Object(T.a)(Object(T.a)({},e),{},{toUid:i}))})),t.failed&&t.failed.length&&t.failed.forEach((e=>{o.failed.push(Object(T.a)(Object(T.a)({},e),{},{toUid:i}))}))}catch(c){o.failed.push({clientId:""+r,error:c,toUid:i})}return o}async function Eu(e,t,s,i){const a=[],n=[],r={success:[],failed:[]};if(t.forEach((e=>{const t=Fe.default.getGroupByIdSync(e);var i;t&&t.totalMember>=U.default.forward_group_limit_mem?n.push(e):a.push({clientId:(null===(i=s[e])||void 0===i?void 0:i.clientId)||Xi.a.next(),grid:Iu(e)})})),n.length)for(let c=0;c<n.length;c++){const e=n[c];try{const t=await Ni.default.sendMsgObject(s[e],null,null,W.RETRY_MSG_TIMEOUT_DEFAULT,!1,i);r.success.push({clientId:s[e].clientId,msgId:t.msgId,toUid:W.GROUPID_PREFIX+e})}catch(o){r.failed.push({clientId:s[e].clientId,error:o,toUid:W.GROUPID_PREFIX+e})}}if(a.length){const t=Nh(a),s={};a.forEach((e=>{s[e.clientId]=e.grid}));try{for(let a=0;a<t.length;a++){const n=await Ni.default.forwardMultiMessage(t[a],e,!0,1e4,!1,i);n.success&&n.success.length&&n.success.forEach((e=>{r.success.push(Object(T.a)(Object(T.a)({},e),{},{toUid:W.GROUPID_PREFIX+s[e.clientId]}))})),n.failed&&n.failed.length&&n.failed.forEach((e=>{r.failed.push(Object(T.a)(Object(T.a)({},e),{},{toUid:W.GROUPID_PREFIX+s[e.clientId]}))}))}}catch(o){for(let e=0;e<a.length;e++)r.failed.push({clientId:""+a[e].clientId,error:o,toUid:W.GROUPID_PREFIX+a[e].grid})}}return r}async function Ou(e,t,s,i){const a=[];t.forEach((e=>{var t;a.push({clientId:(null===(t=s[e])||void 0===t?void 0:t.clientId)||Xi.a.next(),toUid:e})}));const n={success:[],failed:[]},r=Nh(a),o={};a.forEach((e=>{o[e.clientId]=e.toUid}));for(let l=0;l<r.length;l++){const t=r[l];try{const s=await Ni.default.forwardMultiMessage(t,e,!1,1e4,!1,i);s.success&&s.success.length&&s.success.forEach((e=>{n.success.push(Object(T.a)(Object(T.a)({},e),{},{toUid:o[e.clientId]}))})),s.failed&&s.failed.length&&s.failed.forEach((e=>{n.failed.push(Object(T.a)(Object(T.a)({},e),{},{toUid:o[e.clientId]}))}))}catch(c){for(let e=0;e<t.length;e++)n.failed.push({clientId:""+t[e].clientId,error:c,toUid:t[e].toUid})}}return n}var Tu=async function(e,t,s={}){const{groups:i,oneOnes:a,sendToMe:n}=Ah(t),{localMsgs:r,additional:o,updatedForwardMsgItem:c}=await _u(e,t,s),l=c||e,d=[];if(n){const e=await Cu(l,r[n],o);d.push(e)}if(i.length){const e=await Eu(l,i,r,o);d.push(e)}if(a.length){const e=await Ou(l,a,r,o);d.push(e)}const h=({success:[],failed:[]}=Dh(d));return await bu(r,h),h};var Mu=async function(e){return Tu(e.message,e.toUids,e.options)};var Ru=async function(e,t,s={}){const a={},n={},{userId:r}=i.ModuleContainer.resolve(m.a).getSession()||{},o=Ki.default.getChatBoxControllerByWindowId(yt.c),c=(null==s?void 0:s.retry)||!1,l=c?e.msgId:"";for(let i=0;i<t.length;i++){const s=t[i];const a=kh(s,c?e.cliMsgId:Xi.a.next(),W.MSG_STICKER);a.updateMessageContentProp(ea.a.STICKER,e.message),n[s]=a;const r=zh(s);o._showLocalMessage(a,r,null,l)}for(let i=0;i<t.length;i++){const s=Gh(e,r||"",t[i]);a[t[i]]=s}return{localMsgs:n,additionalList:a}};var wu=async function(e,t,s={}){const{groups:i,oneOnes:a,sendToMe:n}=Ah(t),{localMsgs:r,additionalList:o}=await Ru(e,t,s),c=[];if(n){const t=await Cu(e,r[n]);c.push(t)}if(i.length){const t=await Eu(e,i,r);c.push(t)}if(a.length){const t=await Ou(e,a,r);c.push(t)}const l=({success:[],failed:[]}=Dh(c));return await bu(r,l),l};var Lu=async function(e){return wu(e.message,e.toUids,e.options)};var Fu=async function(e,t,s={}){const[i,a]=ts.b.shouldReparseLink(e),n=Ki.default.getChatBoxControllerByWindowId(yt.c),r=(null==s?void 0:s.retry)||!1,o=r?e.msgId:"";let c={localMsgs:{},preview:null};c=i&&s.isForwardSingleMsg?await async function(e,t,s,i){var a;const n=ts.b.isLongUrl(e||""),r=Q.a.LinkPreviewRespository.getKey("meta-data",[e]),o=null===(a=Q.a.LinkPreviewRespository.metaData.get(r))||void 0===a?void 0:a.value,c={localMsgs:{},preview:null};for(let g=0;g<s.length;g++){const a=s[g],r=kh(a,i?t.cliMsgId:Xi.a.next(),W.MSG_LINK_CLIENT);o&&!n?(r.updateMessageContentProp(ea.a.TEXT,t.message.title),r.updateMessageContentProp(ea.a.LINK,o)):(r.updateMessageContentProp(ea.a.TEXT,t.message.title||t.message.href),r.type=W.MSG_TEXT);let m=new Promise((e=>e(null)));if(n){Bs.b.getInstance().report({key:null==t?void 0:t.msgId,href:e,entry:Bs.a.SHARE_MESSAGE,preview:null}),c.localMsgs[a]=r;continue}if(o){let t=!1;const s=Bs.c.create(e);if(Q.a.ParserConfig.get("enable_upload_thumb_for_delay_send")){var l,d;const i=Q.a.LinkPreviewRespository.getKey("meta-data",[e]);t=!(null===(l=Q.a.LinkPreviewRespository.metaData.get(i))||void 0===l||null===(d=l.value)||void 0===d||!d.thumbOrigin),t&&s.do("download-thumb")}else{var h,u;const s=Q.a.LinkPreviewRespository.getKey("thumb-local",[e]);t=!(null===(h=Q.a.LinkPreviewRespository.thumbLocal.get(s))||void 0===h||null===(u=h.value)||void 0===u||!u.thumbLocal)}t&&(m=s.do("upload-thumb",[a]).exec().toPromise())}else if(null!==o){const t=Bs.c.create(e).withTimeout(Q.a.ParserConfig.get("max_delay_send_message"));Q.a.ParserConfig.get("enable_upload_thumb_for_delay_send")?t.do("full-process",[Bs.a.SHARE_MESSAGE,a]):t.do("parse",[Bs.a.SHARE_MESSAGE]),m=t.exec().toPromise()}const p=await m;Bs.b.getInstance().report({key:null==t?void 0:t.msgId,href:e,entry:Bs.a.SHARE_MESSAGE,preview:p}),p&&(r.type=W.MSG_LINK_CLIENT,r.updateMessageContentProp(ea.a.LINK,as.e.clone(p)),c.preview=p),c.localMsgs[a]=r}return c}(a||"",e,t,r):await async function(e,t,s,i){const a={localMsgs:{},preview:null},n=ts.b.isLongUrl(e||""),[,r]=as.e.safeParseJson(t.message.params);for(let o=0;o<s.length;o++){const c=i?t.cliMsgId:Xi.a.next(),l=s[o],d=kh(l,c,W.MSG_TEXT);n||(d.type=W.MSG_LINK_CLIENT,d.updateMessageContentProp(ea.a.LINK,{width:r.width,height:r.height,desc:t.message.description,href:t.message.href,src:r.src,media:r,thumb:t.message.thumb,title:r.mediaTitle})),Bs.b.getInstance().report({key:null==t?void 0:t.msgId,href:e,entry:Bs.a.SHARE_MESSAGE,preview:null}),t.message.title&&d.updateMessageContentProp("text",t.message.title),a.localMsgs[l]=d}return a}(a||"",e,t,r);for(let l in c.localMsgs){const e=c.localMsgs[l],t=zh(l);n._showLocalMessage(e,t,null,o)}return c};var Du=async function(e,t,s={}){const{localMsgs:i,preview:a}=await Fu(e,t,s),n=Object(T.a)({},e);var r;a&&(n.message={action:"recommened.link",childnumber:0,description:a.desc||"",href:a.href,params:JSON.stringify(a.media||{})||"",thumb:a.thumb||"",title:e.message.title,type:(null===(r=a.media)||void 0===r?void 0:r.type)||""});const{groups:o,oneOnes:c,sendToMe:l}=Ah(t),d=[];if(l){const e=await Cu(n,i[l]);d.push(e)}if(o.length){const e=await Eu(n,o,i);d.push(e)}if(c.length){const e=await Ou(n,c,i);d.push(e)}const h=({success:[],failed:[]}=Dh(d));return await bu(i,h),h};var Au=async function(e){return Du(e.message,e.toUids,e.options)};var Nu=async function(e,t,s){const i={localMsgs:{}},a=Ki.default.getChatBoxControllerByWindowId(yt.c),n=(null==s?void 0:s.retry)||!1,r=n?e.msgId:"";for(let o=0;o<t.length;o++){const s=t[o];const c=kh(s,(n?e.cliMsgId:Xi.a.next())+"",e.msgType,e.message);i.localMsgs[s]=c;const l=zh(s);a._showLocalMessage(c,l,null,r)}return i};var ku=async function(e,t,s={}){const{localMsgs:i}=await Nu(e,t,s),a={success:[],failed:[]};for(let r=0;r<t.length;r++){const s=t[r],o=i[s];try{const i=await Ni.default.forwardMessage(t[r],e,o.clientId,W.RETRY_MSG_TIMEOUT_DEFAULT,!1,o,null);a.success.push({clientId:o.clientId+"",msgId:(i.msgId||i.minGlobalMsgId)+"",minGlobalMsgId:i.minGlobalMsgId+"",toUid:s})}catch(n){a.failed.push({clientId:o.clientId+"",error:n,toUid:s})}}return await bu(i,a),a};var Pu=async function(e){return ku(e.message,e.toUids,e.options)};var ju=async function(e,t,s={}){const i=[];for(let n=0;n<t.length;n++){const r={success:[],failed:[]},o=s.retry?e.cliMsgId:Xi.a.next(),c=Ph.a.preprocessMessage(o+"",e,null),l=zh(t[n]);try{const e=await Ph.a.forward(o+"",c,l);e?r.success.push({clientId:o+"",msgId:(e.msgId||e.minGlobalMsgId)+"",minGlobalMsgId:e.minGlobalMsgId+"",toUid:t[n]}):r.failed.push({clientId:o+"",error:"invalid response",toUid:t[n]})}catch(a){r.failed.push({clientId:o+"",error:a,toUid:t[n]})}jh(c,l,r),i.push(r)}return Dh(i)};var Uu=async function(e){return ju(e.message,e.toUids,e.options)};var Bu=async function(e,t,s={}){const i={},a=Ki.default.getChatBoxControllerByWindowId(yt.c),n=(null==s?void 0:s.retry)||!1,r=n?e.msgId:"";for(let o=0;o<t.length;o++){const s=t[o];const c=kh(s,n?e.cliMsgId:Xi.a.next(),W.MSG_GIF);let{oriUrl:l,normalUrl:d,params:h}=e.message;if(h){let e=Vh.a.utils.safeParseJSON(h);const{width:t=0,height:s=0}=e,i={};l&&(i.original={width:t,height:s,url:l}),d&&(i.normal={width:t,height:s,url:d}),c.updateMessageContentProp(ea.a.GIF,i)}i[s]=c;const u=zh(s);a._showLocalMessage(c,u,null,r)}return{localMsgs:i}};var Gu=async function(e,t,s={}){const i={success:[],failed:[]},{localMsgs:a}=await Bu(e,t,s);for(let r=0;r<t.length;r++){const s=t[r],o=a[s];try{const t=await Ni.default.forwardMessage(s,e,o.clientId,W.RETRY_MSG_TIMEOUT_DEFAULT,!1,o,null);t?i.success.push({clientId:o.clientId+"",msgId:(t.msgId||t.minGlobalMsgId)+"",minGlobalMsgId:t.minGlobalMsgId+"",toUid:s}):i.failed.push({clientId:o.clientId+"",error:"invalid response",toUid:s})}catch(n){i.failed.push({clientId:o.clientId+"",error:n,toUid:s})}}return await bu(a,i),i};var zu=async function(e){return Gu(e.message,e.toUids,e.options)};var xu=async function(e,t,s,i={}){const{localMsgs:a,additionalList:n}=s,r={success:[],failed:[]};for(let c=0;c<t.length;c++){const s=t[c],i=a[s];try{const a=await Ni.default.forwardMessage(t[c],e,i.clientId,W.RETRY_MSG_TIMEOUT_DEFAULT,!1,i,n[s]);r.success.push({clientId:i.clientId+"",msgId:(a.msgId||a.minGlobalMsgId)+"",minGlobalMsgId:a.minGlobalMsgId+"",toUid:s})}catch(o){r.failed.push({clientId:i.clientId+"",error:o,toUid:s})}}return r};var Vu=class{constructor(e,t,s){this.message=e,this.toUids=t,this.options=s,this.preprocessResult=void 0,this.result=void 0,this.preprocessResult={},this.result={success:[],failed:[]}}async execute(){return this.preprocessResult=await this.preprocess(),this.result=await this.process(),this.postprocess(),this.result}};var Hu=async function(e,t,s){const i={localMsgs:{},additionalList:{}},a=Ki.default.getChatBoxControllerByWindowId(yt.c),n=(null==s?void 0:s.retry)||!1,r=n?e.msgId:"";for(let o=0;o<t.length;o++){const s=t[o];const c=kh(s,(n?e.cliMsgId:Xi.a.next())+"",e.msgType,e.message);i.localMsgs[s]=c;const l=zh(s);a._showLocalMessage(c,l,null,r)}return i};class qu extends Vu{async preprocess(){return Hu(this.message,this.toUids,this.options)}async process(){return xu(this.message,this.toUids,this.preprocessResult,this.options)}async postprocess(){return bu(this.preprocessResult.localMsgs,this.result)}}var Wu=async function(e){return new qu(e.message,e.toUids,e.options).execute()};Lh.a.registerHandler(wh.a.PHOTO,ou),Lh.a.registerHandler(wh.a.FILE,$h),Lh.a.registerHandler(wh.a.VIDEO,gu),Lh.a.registerHandler(wh.a.TEXT,Mu),Lh.a.registerHandler(wh.a.STICKER,Lu),Lh.a.registerHandler(wh.a.LINK,Au),Lh.a.registerHandler(wh.a.CONTACT,Pu),Lh.a.registerHandler(wh.a.VOICE,Uu),Lh.a.registerHandler(wh.a.GIF,zu),Lh.a.registerHandler(wh.a.GROUP_PHOTO,pu),Lh.a.registerHandler(wh.a.DEFAULT,Wu);class Zu{constructor(e){this._state=Zu.PENDING,this._resolve=void 0,this._reject=void 0,this._promise=void 0,this._reject=void 0,this._promise=new e(((e,t)=>{this._resolve=e,this._reject=t}))}reject(e){this._state===Zu.PENDING&&(this._state=Zu.REJECTED,this._reject(e))}resolve(e){this._state===Zu.PENDING&&(this._state=Zu.FULFILLED,this._resolve(e))}get state(){return this._state}get promise(){return this._promise}}Zu.PENDING="PENDING",Zu.FULFILLED="FULFILLED",Zu.REJECTED="REJECTED";var Ku=Zu;const Qu={cancelledReason:"Task cancelled",timeoutReason:"Task timeout"};class $u extends Ku{constructor(e,t=void 0,s=Qu){super(Promise),this.executor=e,this.ttl=t,this.options=s,this._events=new Map,this._creationTimestamp=0,this._timeout=0,this.creationTimestamp=performance.now(),this.timeout=0,void 0!==t&&this.setTimeout()}addEventListener(e,t){let s=this.events.get(e);s||(s=[],this.events.set(e,s)),s.push(t)}cancel(){this.reject(this.getOptions().cancelledReason)}execute(...e){return this.executor.apply(this,e).then(this.resolve.bind(this)).catch(this.reject.bind(this)),this.promise}removeEventListener(e,t){const s=this.events.get(e);if(!s)return;this.events.set(e,s.filter((e=>e!==t)))}getOptions(){return Object(T.a)(Object(T.a)({},Qu),this.options)}removeTimeout(){this.timeout&&clearTimeout(this.timeout),this.timeout=0}setTimeout(){if(this.state!==$u.PENDING)return;if(isNaN(this.ttl)||this.ttl<=0)throw new Error("delay must be a positive int");const e=performance.now()-this.creationTimestamp;this.timeout&&this.removeTimeout(),this.timeout=window.setTimeout((()=>this.reject(this.getOptions().timeoutReason)),Math.max(this.ttl-e,0))}get events(){return this._events}get creationTimestamp(){return this._creationTimestamp}set creationTimestamp(e){this._creationTimestamp=e}get timeout(){return this._timeout}set timeout(e){this._timeout=e}}var Yu=$u,Ju=s("gOiJ"),Xu=s("1OYu");var eg=function(e){const t=e.msgType;return t===W.MSG_PHOTO_GROUP?[wh.a.GROUP_PHOTO,Lh.a.getHandler(wh.a.GROUP_PHOTO)]:t===W.MSG_PHOTO||t===W.MSG_PHOTO_2||t===W.MSG_DOODLE?[wh.a.PHOTO,Lh.a.getHandler(wh.a.PHOTO)]:t===W.MSG_FILE?[wh.a.FILE,Lh.a.getHandler(wh.a.FILE)]:t===W.MSG_VIDEO?[wh.a.VIDEO,Lh.a.getHandler(wh.a.VIDEO)]:t===W.MSG_TEXT?[wh.a.TEXT,Lh.a.getHandler(wh.a.TEXT)]:t===W.MSG_STICKER?[wh.a.STICKER,Lh.a.getHandler(wh.a.STICKER)]:t===W.MSG_CONTACT&&"recommened.link"==e.message.action||"link"===e.type?[wh.a.LINK,Lh.a.getHandler(wh.a.LINK)]:t!==W.MSG_CONTACT||"recommened.user"!=e.message.action&&"recommened.vip"!=e.message.action?t===W.MSG_VOICE?[wh.a.VOICE,Lh.a.getHandler(wh.a.VOICE)]:t===W.MSG_GIF?[wh.a.GIF,Lh.a.getHandler(wh.a.GIF)]:[wh.a.DEFAULT,Lh.a.getHandler(wh.a.DEFAULT)]:[wh.a.CONTACT,Lh.a.getHandler(wh.a.CONTACT)]};var tg,sg=class{constructor(e,t){this.messages=e,this.toUids=t,this.startTime=0,this._Logger=void 0}get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger("forward-log",["track forward message"])),this._Logger}startForward(){this.startTime=performance.now()}endForward(e){for(let t=0;t<e.length;t++)this.logForMsg(this.messages[t],e[t]);this.logForwardDone()}logForwardDone(){let e=0,t=0,s=0,i=0;for(let a=0;a<this.toUids.length;a++){const n=this.toUids[a];n.startsWith(W.GROUPID_PREFIX)?e++:n===U.default.sendToMeId?i++:(t++,Z.default.isFriend(n)||s++)}for(let a=0;a<this.messages.length;a++){const n=this.messages[a];fe.default.logActionInfoV2(fe.FeaturesInfo.ForwardMessage,0,{src_id:n.toUid||n.userId,msgType:n.msgType,gapTime:Date.now()-+n.sendDttm,duration:performance.now()-this.startTime,totalConv:this.toUids.length,chatgroup:e,chat11:t,stranger:s,mycloud:i})}}logForMsg(e,t){t.success.length>0&&this.logSuccess(e,t.success),t.failed.length>0&&this.logFail(e,t.failed)}logSuccess(e,t){}logFail(e,t){const s=e.toUid||e.userId,i=ta.a.instance().isOnE2ee(s);for(let a=0;a<t.length;a++){const{error:n,toUid:r}=t[a],o=ta.a.instance().isOnE2ee(r);let c=0;c=i||o?i&&o?1:2:0;let l=1;r.startsWith(W.GROUPID_PREFIX)?l=2:r===U.default.sendToMeId&&(l=3);let d=0;d="string"==typeof n||"number"==typeof n?n:(null==n?void 0:n.code)||(null==n?void 0:n.errorCode)||(null==n?void 0:n.error_code);const h={fail_error:d,e2ee:c,msgtype:e.msgType,src_id:s,chat_type:l,duration:performance.now()-this.startTime,number_conversation:this.toUids.length};U.default.forward_messages.enable_tracking_log?this.Logger.zsymb(21,"y7gsh8",["forwardMessageFromLocal fail : {} {}","tZ0OgW"],JSON.stringify(h),e):this.Logger.zsymb(21,"kaQpy6",["forwardMessageFromLocal fail : {}","rgsyeB"],JSON.stringify(h)),fe.default.logActionInfoV2(fe.FeaturesInfo.ForwardMsgFail,0,h)}}};Object(i.injectable)()(tg=Object(i.singleton)(Xu.a)(tg=function(e,t){return Object(i.inject)(Th)(e,void 0,0)}(tg=Reflect.metadata("design:type",Function)(tg=Reflect.metadata("design:paramtypes",[Object])(tg=class{constructor(e){this.poolFactory=e,this._pool=void 0}async forwardMessages(e,t,s={}){this.pool||this.initializePool(),e.forEach((e=>{e.toUid||(e.toUid=e.userId)}));const i=this.buildTask(e,t,s||{});return this.pool.use(i).then((e=>Promise.resolve(e)))}async retryForwardMessages(e,t={}){const s=Object(T.a)(Object(T.a)({},t),{},{retry:!0});this.pool||this.initializePool();const i=e.map((e=>e.toUid)),a=this.buildTask(e,i,s);return this.pool.use(a).then((e=>Promise.resolve(e)))}buildTask(e,t,s){return async()=>{try{return await this.runTaskInSerialization(e,t,s)}catch(i){return Promise.reject(i)}}}cleanUp(){this.pool&&this.pool.drain(),this.pool=void 0}initializePool(){const e={max:Object(Ju.getMaximumPoolSize)(),min:Object(Ju.getMinimumPoolSize)(),autostart:!0};this.pool=this.poolFactory.createPool({create:async()=>({}),destroy:async()=>{}},e)}async runSubTask(e,t,s){const[i,a]=eg(e);if(null==a)return Promise.reject("Invalid handler");try{const i=new Yu(a,Object(Ju.getForwardMessageTaskTimeout)());return await i.execute({message:e,toUids:t,options:s})}catch(n){return Promise.reject(n)}}async runTaskInSerialization(e,t,s){const i=[];e.forEach((e=>{i.push(this.runSubTask.bind(null,Object(T.a)(Object(T.a)({},e),{},{mentions:null}),t,s))}));const a=new sg(e,t);a.startForward();const n=await async function(e){if(!Array.isArray(e))return Promise.reject("Params functions is invalid");const t=[...e],s=[];for(const a of t)try{const e=await a();s.push({isSuccess:!0,data:e})}catch(i){s.push({isSuccess:!1,error:i})}return s}(i);try{const e=n.map(((e,t)=>e.data));a.endForward(e)}catch(o){}const r=n.map(((t,s)=>({id:e[s].msgId,isSuccess:t.isSuccess,data:t.data,error:t.error})));return Promise.resolve(r)}get pool(){return this._pool}set pool(e){this._pool=e}})||tg)||tg)||tg)||tg);var ig=Object(i.define)("pin-topic-message-loader");var ag=Object(i.define)("pin-topic-storage"),ng=ag,rg=s("UIHX"),og=s("0URt"),cg=s("DRpF");function lg(e){return!(-1===Object(og.g)().indexOf(e.msgType))&&!Object(cg.a)(e)}var dg=s("3ZdV");var hg=s("YYsv");function ug(e,t,s){return s===e?1:s<t?0:-1}function gg(e){const t={needFetch:!1,reason:""};if(null==e||null==e||!e.lastFetch)return t.needFetch=!0,t.reason="empty",t;const{lastFetch:s}=e,i=function(e){return Nc.a.isOverflowAtTime(e)}(s);if(i)return t.needFetch=!0,t.reason="overflow",t;const a=function(e){return Date.now()-e>Object(dg.e)()}(s);if(a)return t.needFetch=!0,t.reason="expired",t;const r=function(e){const t=n.default.getInstance().getItemForCurrentUser(hg.g.FORCE_FETCH_MILESTONE);return!(!t||isNaN(+t))&&e<+t}(s);return r?(t.needFetch=!0,t.reason="forcedByServer",t):t}function mg(e){const t=[];return e.forEach((e=>{t.push({topicId:e.id,topicType:e.type})})),t}function pg(e){var t;return(null===(t=e.params)||void 0===t?void 0:t.client_msg_id)||""}function fg(e){var t;return(null===(t=e.params)||void 0===t?void 0:t.global_msg_id)||""}function vg(e,t,s){let i=t;const{topics:a}=s;if(!Array.isArray(a))return i;switch(e){case rg.a.ADD:{const{index:e}=s;i=null==e?[...a,...t]:[...t.slice(0,e),...a,...t.slice(e)];break}case rg.a.REMOVE:{const e={};a.forEach((t=>{e[t.id]=t.type})),i=[],t.forEach((t=>{(!e.hasOwnProperty(t.id)||e.hasOwnProperty(t.id)&&e[t.id]!==t.type)&&i.push(t)}));break}}return i}function _g(e){const t=e=>{if(!Array.isArray(e))return e;const t=[];for(let s=0;s<e.length;s++){const i=e[s];i&&(null!=i.id&&(i.id=i.id.toString()),null!=i.topicId&&(i.topicId=i.topicId.toString()),null!=i.type&&(i.type=parseInt(i.type)),null!=i.topicType&&(i.topicType=parseInt(i.topicType)),t.push(i))}return t},s=Object(T.a)({},e);return null!=s.oldTopic&&(s.oldTopic=t([s.oldTopic])[0]),null!=s.topic&&(s.topic=t([s.topic])[0]),null!=s.topics&&(s.topics=t(s.topics)),s}function bg(e){let t={};if(!e.params)return e;try{t=JSON.parse(e.params)}catch(s){return}if(t.extra&&t.extra.constructor===String)try{t.extra=JSON.parse(t.extra)}catch(s){return}return e.params=t,e}var yg,Ig=function(){const e={};return{clear:()=>{for(const t in e)delete e[t]},get:t=>e[t],getCache:()=>e,set:(t,s)=>{e[t]=s},has:t=>e.hasOwnProperty(t),remove:t=>{delete e[t]}}};var Sg=Object(i.injectable)()(yg=function(e,t){return Object(i.inject)(ng)(e,void 0,0)}(yg=Reflect.metadata("design:type",Function)(yg=Reflect.metadata("design:paramtypes",[Object])(yg=class{constructor(e){this.storage=e,this.clientMsgCache=void 0,this.globalMsgCache=void 0,this.globalMsgCache=Ig(),this.clientMsgCache=Ig()}clear(e){switch(e){case rg.g.GLOBAL:return void this.globalMsgCache.clear();case rg.g.CLIENT:return void this.clientMsgCache.clear();default:return this.globalMsgCache.clear(),void this.clientMsgCache.clear()}}loadMessages(e,t){return new Promise(((s,i)=>{t&&0!==t.length||i("Invalid topics");const a=t.length;for(let n=0;n<a;n++){const s=t[n];if(!s)continue;let a=fg(s);if(a&&"0"!==a)this.getMessage(e,rg.g.GLOBAL,a).then().catch((e=>{i(e)}));else{let t=pg(s);if(t){let a=s.params&&s.params.senderUid;this.getMessage(e,rg.g.CLIENT,t,{userId:a}).then().catch((e=>{i(e)}))}}}s()}))}getMessageFromTopic(e){if(e.type!==rg.i.MESSAGE||!e.params)return{};let t=fg(e);if(this.globalMsgCache&&this.globalMsgCache.has(t))return this.globalMsgCache.get(t)||{};let s=pg(e);return this.clientMsgCache&&this.clientMsgCache.has(s)&&this.clientMsgCache.get(s)||{}}removeMessages(e){Array.isArray(e)&&e.forEach((e=>{const t=fg(e),s=pg(e);this.globalMsgCache.remove(t),this.clientMsgCache.remove(s)}))}getMessage(e,t,s,i={}){return new Promise(((a,n)=>{switch(t){case rg.g.GLOBAL:{let i=this.globalMsgCache.get(s);i?a(i):this.storage.getMessagesByIds(e,[s]).then((e=>{e?(this.setMessage(t,s,e),a(e)):n("Not found")})).catch((e=>{n(e)}));break}case rg.g.CLIENT:{const{userId:r}=i;let o=this.clientMsgCache.get(s);o?a(o):this.storage.getMessageByCliMsgId(e,s,{myUID:Z.default.getUidMe(),userId:r}).then((e=>{e?(this.setMessage(t,s,e),a(e)):n("Not found")})).catch((e=>{n(e)}));break}default:n("Unknown")}}))}setMessage(e,t,s){switch(e){case rg.g.GLOBAL:return void this.globalMsgCache.set(t,s);case rg.g.CLIENT:return void this.clientMsgCache.set(t,s);default:return}}})||yg)||yg)||yg)||yg;i.ModuleContainer.register(ig,Sg);var Cg=Object(i.define)("pin-topic-data-repository"),Eg=s("ZsEe"),Og=s("vSga");var Tg=function(){const e={},t=t=>e[t]||null;return{clear:()=>{for(const t in e)delete e[t]},get:t,getAll:()=>e,getLastFetch:e=>{var s;return(null===(s=t(e))||void 0===s?void 0:s.lastFetch)||0},getLastModified:e=>{var s;return(null===(s=t(e))||void 0===s?void 0:s.lastModified)||0},getTopics:e=>{var s;return(null===(s=t(e))||void 0===s?void 0:s.topics)||[]},getVersion:e=>{var s;return(null===(s=t(e))||void 0===s?void 0:s.version)||0},has:t=>!!e[t],remove:t=>{delete e[t]},set:(t,s)=>{e[t]=s}}};var Mg=function(e){const t=[];let s=!1;const i=e||(()=>{}),a=()=>t.length,n=e=>{s=e},r=()=>{if(s)return;if(!a())return void i();const e=t.shift();e&&(n(!0),e().then((()=>{n(!1),r()})).catch((()=>{n(!1),r()})))};return{enqueue:e=>{t.push(e),r()},dequeue:r,getLength:a}};var Rg=function(){const e=[];let t;const s=()=>e.length,i=(a,n)=>{if(n&&(t=n),!s())return t&&t(a);const r=e.shift();r&&((e,t)=>{const{callback:s}=e;let a;"function"==typeof s&&(a=s(e.data,t)),i(a)})(r,a)};return{enqueue:t=>{e.push(t)},dequeue:i,getLength:s}},wg=s("u+F0");var Lg=Object(i.define)("pin-topic-request-handler");function Fg(e){return new Promise((t=>{let s=0,i=0,a={};for(let n in e)s++,e[n].then((e=>{a[n]=e,i++,i===s&&t(a)})).catch((()=>{a[n]=null,i++,i===s&&t(a)}));0===s&&t({})}))}function Dg(e,t){return Object(Yd.f)(e,Number.isInteger(+t)?t:1/0)}var Ag=class{constructor(e,t){this.moduleName=e,this.instanceNames=t,this.instanceMap=new Map}error(e,...t){const s=this.getLogger(e);void 0!==s&&s.zsymb(18,"K3B7Ot",...t)}info(e,...t){const s=this.getLogger(e);void 0!==s&&s.zsymb(0,"18wbzp",...t)}getLogger(e){if(this.instanceNames.includes(e)&&void 0===this.instanceMap.get(e)){const t=this.LoggerFactory.createZLogger(Ss.ZLoggerNametags.pinTopic,[this.moduleName,e]);this.instanceMap.set(e,t)}return this.instanceMap.get(e)}get LoggerFactory(){return i.ModuleContainer.resolve(B.ZLoggerFactory)}},Ng=function(e){return e.CONTROL="control",e.CREATE="create",e.FETCH="fetch",e.LOAD="load",e.REORDER="reorder",e.UNPIN="unpin",e}(Ng||{});var kg,Pg=class extends Ag{constructor(){super(rg.f.DataRepository,[Ng.CONTROL,Ng.CREATE,Ng.FETCH,Ng.LOAD,Ng.REORDER,Ng.UNPIN])}infoControl(...e){this.logInfo(Ng.CONTROL,...e)}infoCreate(...e){this.logInfo(Ng.CREATE,...e)}infoFetch(...e){this.logInfo(Ng.FETCH,...e)}infoLoad(...e){this.logInfo(Ng.LOAD,...e)}infoReorder(...e){this.logInfo(Ng.REORDER,...e)}infoUnpin(...e){this.logInfo(Ng.UNPIN,...e)}errorControl(...e){this.logError(Ng.CONTROL,...e)}errorCreate(...e){this.logError(Ng.CREATE,...e)}errorFetch(...e){this.logError(Ng.FETCH,...e)}errorLoad(...e){this.logError(Ng.LOAD,...e)}errorReorder(...e){this.logError(Ng.REORDER,...e)}errorUnpin(...e){this.logError(Ng.UNPIN,...e)}logInfo(e,...t){this.isEnableLog()&&super.info(e,...t)}logError(e,...t){this.isEnableLog()&&super.error(e,...t)}isEnableLog(){return Object(dg.h)()}};var jg=Object(i.injectable)()(kg=function(e,t){return Object(i.inject)(ng)(e,void 0,0)}(kg=function(e,t){return Object(i.inject)(Lg)(e,void 0,1)}(kg=Reflect.metadata("design:type",Function)(kg=Reflect.metadata("design:paramtypes",[Object,Object])(kg=class{constructor(e,t){this.storage=e,this.fetcher=t,this.cache=void 0,this.eventQueue=void 0,this.logger=void 0,this.pendingWhenLoadQueue=void 0,this.requestID=void 0,this.cache=Tg(),this.eventQueue={},this.pendingWhenLoadQueue={},this.logger=new Pg,this.requestID=new Eg.a}clear(){this.cache.clear();for(const e in this.pendingWhenLoadQueue)delete this.pendingWhenLoadQueue[e];for(const e in this.eventQueue)delete this.eventQueue[e]}clearPinTopicsForConversation(e,t=!1){this.cache.remove(e),delete this.pendingWhenLoadQueue[e],delete this.eventQueue[e],this.Storage.clearTopics(e,t)}createPinTopic(e,t,s={}){return new Promise(((i,a)=>{const n=this.getRequestID();this.Logger.infoCreate(n,`call cId:${e}`),this.loadDataFromCacheOrDB(e).then((r=>{const{checkEnableToCreate:o}=s||{};let c=null;if(o){const{enable:s,oldTopic:i}=o(e,t,r);if(!s)return this.Logger.infoCreate(n,`cId:${e} react limit`),a({code:wg.a.PINBOARD_OVER_MAXIMUM,message:"",data:{cache:r}});i&&(c=i)}const{version:l}=r;this.Logger.infoCreate(n,`cId:${e}`,l),this.Fetcher.createTopic(e,t,l).then((t=>{this.Logger.infoCreate(n,`cId:${e}, create topic success`);let s=t.response.data;s.oldVersion=l,c&&(s.oldTopic={topicId:c.id,topicType:c.type}),s=_g(s),this.enqueueEvent(e,this.addTopic.bind(this,e,s,(e=>i(e))))})).catch((t=>{const s=t.error;s.data=Object(T.a)(Object(T.a)({},null==s?void 0:s.data),{},{cache:r}),this.Logger.errorCreate(n,`cId:${e}, create topic fail`,Dg(t,Object(dg.b)())),a(s)}))}))}))}getEntryPointPromotionalTooltipShowedStatus(){return this.Storage.getEntryPointPromotionalTooltipShowedStatus()}handleReceivingEvent(e,t){return new Promise(((s,i)=>{if(this.Logger.infoControl(`call ${e}`,Dg(t,Object(dg.b)())),e===rg.c.FORCE_SYNC){const{conversationIds:e}=t;if(!Array.isArray(e))return i("Invalid conversationIds for force all");if(0===e.length)this.Storage.setForcedFetchMilestone(Date.now());else for(let t=0;t<e.length;t++){var a;const n=null===(a=e[t])||void 0===a?void 0:a.toString();n&&(this.clearPinTopicsForConversation(n),this.fetchTopics(n).then((e=>{s(e)})).catch(i))}}else{const{conversationId:a}=t;this.loadDataFromCacheOrDB(a).then((a=>{this.processEventControl(e,t,a,s,i)}))}}))}loadPinTopics(e,t){return new Promise(((s,i)=>{e||i({status:rg.h.ERROR,error:{code:wg.a.INVALID_PARAMETERS,message:"ConversationId not valid"}});const a=this.getRequestID();if(this.Logger.infoLoad(a,`call cId:${e}`),t&&t!==rg.d.NONE)return this.Logger.infoLoad(a,`force fetch cId:${e}`,t),this.fetchTopics(e).then((e=>{s(e)}));this.loadDataFromCacheOrDB(e).then((n=>{if(this.Logger.infoLoad(a,`cId:${e}`),t===rg.d.NONE)return s(n);this.doCheckAndFetchData(n).then((e=>{s(e)})).catch(i)}))}))}reorderPinTopics(e,t){return new Promise(((s,i)=>{const a=this.getRequestID();this.Logger.infoReorder(a,`call cId:${e}`),this.loadDataFromCacheOrDB(e).then((n=>{const{version:r}=n,o=mg(t);this.Logger.infoReorder(a,`cId:${e}`,r),this.Fetcher.reorderTopics(e,o,r).then((i=>{this.Logger.infoReorder(a,`cId:${e}, reorder topic success`);let n=i.response.data;n.oldVersion=r,n.topics=t,n=_g(n),this.enqueueEvent(e,this.setTopics.bind(this,e,n,(e=>s(e))))})).catch((t=>{this.Logger.errorReorder(a,`cId:${e}, reorder topic fail`,Dg(t,Object(dg.b)())),i(t.error)}))}))}))}setEntryPointPromotionalTooltipShowedStatus(e){this.Storage.setEntryPointPromotionalTooltipShowedStatus(e)}unpinTopics(e,t){return new Promise(((s,i)=>{const a=this.getRequestID();this.Logger.infoUnpin(a,`call cId:${e}`),this.loadDataFromCacheOrDB(e).then((n=>{const{version:r}=n,o=mg(t);this.Logger.infoUnpin(a,`cId:${e}`,r),this.Fetcher.unpinTopics(e,o,r).then((i=>{this.Logger.infoUnpin(a,`cId:${e} unpin topic success`);let n=i.response.data;n.oldVersion=r,n.topics=t,n=_g(n),this.enqueueEvent(e,this.removeTopics.bind(this,e,n,(e=>s(e))))})).catch((t=>{this.Logger.errorUnpin(a,`cId:${e}, unpin topic fail`,Dg(t,Object(dg.b)())),i(t.error)}))}))}))}setPendingQueue(e,t){t&&!this.pendingWhenLoadQueue[e]?this.pendingWhenLoadQueue[e]=Rg():delete this.pendingWhenLoadQueue[e]}isInPending(e){return!!this.pendingWhenLoadQueue[e]}openPendingQueue(e){this.setPendingQueue(e,!0)}closePendingQueue(e){this.setPendingQueue(e,!1)}enqueuePending(e,t){this.pendingWhenLoadQueue[e]&&this.pendingWhenLoadQueue[e].enqueue(t)}loadTopicsFromDB(e){this.openPendingQueue(e);return new Promise((t=>{const s=this.getRequestID();this.Logger.infoLoad(s,`DB call cId:${e}`),this.Storage.loadTopics(e).then((i=>{const a=this.handleLoadDBFinish(e,i);this.Logger.infoLoad(s,`DB cId:${e} success`),t({status:rg.h.SUCCESS,response:{data:a}})})).catch((i=>{const a=this.handleLoadDBFinish(e,null);this.Logger.errorLoad(s,`DB cId:${e} fail`,Dg(null==i?void 0:i.error,Object(dg.b)())),t({status:rg.h.ERROR,response:{data:a}})}))}))}getRequestID(){return this.requestID.next()}handleLoadDBFinish(e,t){var s;let i;var a;t&&(i={conversationId:(a=t).conversationId,topics:a.topics,version:a.boardVersion,lastFetch:a.lastFetch,lastModified:Date.now()}),t&&(null===(s=i)||void 0===s?void 0:s.conversationId)===e||(i=function(e){return{conversationId:e,topics:[],version:0,lastFetch:0,lastModified:0}}(e));let n=i;if(!gg(n).needFetch&&this.isInPending(e)){const t=e=>{e&&(n=e)};this.pendingWhenLoadQueue[e].dequeue(i,t)}return this.closePendingQueue(e),n}fetchTopics(e,t=0){this.openPendingQueue(e);return new Promise(((s,i)=>{const a=this.getRequestID();this.Logger.infoFetch(a,`call cId:${e}`,t),this.Fetcher.fetchTopics(e,t).then((t=>{this.Logger.infoFetch(a,`cId:${e} success`),this.closePendingQueue(e);const{response:i}=t,n=i.data.topics;for(let e=0;e<n.length;e++)n[e]=bg(n[e]);this.loadExtraDataForTopics(n).then((t=>{const a={conversationId:e,topics:t,version:i.data.version,lastFetch:Date.now(),lastModified:Date.now()};this.setToCache(e,a),this.setTopicsToDB(a),s(a)}))})).catch((t=>{this.Logger.errorFetch(a,`cId:${e} fail`,Dg(t,Object(dg.b)())),this.closePendingQueue(e)}))}))}doCheckAndFetchData(e){return new Promise(((t,s)=>{const i=gg(e);if(this.Logger.infoFetch(`cId:${e.conversationId} needFetch:${i.needFetch} reason:${i.reason}`),!i.needFetch)return t(e);this.fetchTopics(e.conversationId).then((s=>{t(s||e)})).catch(s)}))}getDataInPendingQueueAfterMutation(e,t){if(e.conversationId!==t.conversationId)return t;if(e.oldVersion!=t.version)return t;return{topics:vg(e.type,t.topics,{index:e.index,topics:e.topics}),version:e.version,conversationId:e.conversationId,lastModified:Date.now(),lastFetch:t.lastFetch}}setToCache(e,t){return null==t.lastModified&&(t.lastModified=Date.now()),this.cache.set(e,t),t}addToCache(e,t,s=0){const i=this.getCache(e),{topic:a,version:n}=t;let r=Date.now(),o=[];i?(o=vg(rg.a.ADD,i.topics,{topics:[a],index:s}),r=i.lastFetch):o.push(a),t.lastFetch&&(r=t.lastFetch);const c={conversationId:e,topics:o,version:n,lastModified:Date.now(),lastFetch:r};return this.setToCache(e,c)}removeInCache(e,t,s=0){if(!this.cache.has(e))return null;const i=this.getCache(e),{topics:a}=i;if(t.topic)for(let r=0;r<a.length;r++){const e=a[r];if(e.id===t.topic.id&&e.type===t.topic.type){a.splice(r,1);break}}else a.splice(s,1);const n={conversationId:e,topics:a,version:t.version,lastModified:Date.now(),lastFetch:i.lastFetch};return this.setToCache(e,n)}enqueueEvent(e,t){if(!this.eventQueue[e]){const t=()=>{delete this.eventQueue[e]};this.eventQueue[e]=Mg(t)}this.eventQueue[e].enqueue(t)}addTopic(e,t,s){return new Promise(((i,a)=>{if(this.isInPending(e)){const s={data:{type:rg.a.ADD,conversationId:e,oldTopic:t.oldTopic,topics:[t.topic],version:t.version,oldVersion:t.oldVersion,index:t.index},callback:this.getDataInPendingQueueAfterMutation};return this.enqueuePending(e,s),i()}const n=a=>{const{oldVersion:n,version:r}=t,o=ug(n,r,a.version);if(this.Logger.infoCreate(`add call cId:${e} actCode:${o}`,n,r,a.version),1===o){const{oldTopic:a,index:n,topic:o}=t;a&&a.topicId&&this.removeInCache(e,{topic:{id:a.topicId,type:a.topicType},version:r}),bg(o),this.loadExtraDataForTopics([o]).then((a=>{const r={topic:a[0],version:t.version},o=this.addToCache(e,r,n);this.setTopicsToDB(o),i(),s&&s(this.getCache(e))})).catch((()=>{i()}))}else 0===o?this.fetchTopics(e).then((e=>{s&&s(e),i()})).catch((()=>{s&&s(this.getCache(e)),i()})):i()};this.loadDataFromCacheOrDB(e).then((e=>{n(e)}))}))}removeTopics(e,t,s){return new Promise((i=>{if(this.isInPending(e)){const s={data:{type:rg.a.REMOVE,conversationId:e,topics:t.topics,version:t.version,oldVersion:t.oldVersion},callback:this.getDataInPendingQueueAfterMutation};return this.enqueuePending(e,s),i()}const a=a=>{const{oldVersion:n,version:r}=t,o=ug(n,r,a.version);if(this.Logger.infoUnpin(`remove call cId:${e} actCode:${o}`,n,r,a.version),1===o){const{topics:n}=t;let o=a;for(let t=0;t<n.length;t++)o=this.removeInCache(e,{topic:n[t],version:r});return this.setTopicsToDB(o),s&&s(this.getCache(e)),i()}0===o?this.fetchTopics(e).then((e=>{s&&s(e),i()})).catch((()=>{s&&s(this.getCache(e)),i()})):i()};this.loadDataFromCacheOrDB(e).then((e=>{a(e)}))}))}setTopics(e,t,s){return new Promise((i=>{if(this.isInPending(e)){const s={data:{type:rg.a.REORDER,conversationId:e,topics:t.topics,version:t.version,oldVersion:t.oldVersion},callback:this.getDataInPendingQueueAfterMutation};return this.enqueuePending(e,s),i()}const a=a=>{const{oldVersion:n,version:r}=t,o=ug(n,r,a.version);if(this.Logger.infoReorder(`set call cId:${e} actCode:${o}`,n,r,a.version),1===o){const n=a.topics,r=[];for(let e=0;e<t.topics.length;e++){const s=t.topics[e],i=n.find((e=>e.id===s.id&&e.type===s.type));i&&r.push(i)}const o={conversationId:e,topics:r,version:t.version,lastModified:Date.now(),lastFetch:(null==a?void 0:a.lastFetch)||0};return this.setToCache(e,o),this.setTopicsToDB(o),s&&s(this.getCache(e)),i()}0===o?this.fetchTopics(e).then((e=>{s&&s(e),i()})).catch((()=>{s&&s(this.getCache(e)),i()})):i()};this.loadDataFromCacheOrDB(e).then((e=>{a(e)}))}))}loadDataFromCacheOrDB(e){return new Promise((t=>{const s=this.getCache(e);s?t(s):this.loadTopicsFromDB(e).then((s=>{const i=s.response.data;this.setToCache(e,i),t(i)}))}))}setTopicsToDB(e){return new Promise(((t,s)=>{const i={conversationId:e.conversationId,boardVersion:e.version,topics:e.topics,lastFetch:e.lastFetch};this.Storage.setTopics(i).then(t).catch(s)}))}processEventControl(e,t,s,i,a){const{conversationId:n}=t;let r={oldVersion:t.oldVersion,version:t.version};const o=_g(t);switch(e){case rg.c.CREATE:r=Object(T.a)(Object(T.a)({},r),{},{oldTopic:o.oldTopic,topic:o.topic,index:0}),this.enqueueEvent(n,this.addTopic.bind(this,n,r,(e=>i(e))));break;case rg.c.UNPIN:{const e=o.topic,t=[];e&&null!=e.topicId&&null!=e.topicType&&t.push({id:e.topicId,type:e.topicType}),r=Object(T.a)(Object(T.a)({},r),{},{topics:t}),this.enqueueEvent(n,this.removeTopics.bind(this,n,r,(e=>i(e))));break}case rg.c.REORDER:{var c;const e=[],t=(null===(c=o.topics)||void 0===c?void 0:c.length)||0;for(let i=0;i<t;i++){var l;const t=null===(l=o.topics)||void 0===l?void 0:l[i];if(t&&null!=t.topicId&&null!=t.topicType){const i=s.topics.find((e=>e.id===t.topicId&&e.type===t.topicType));i&&e.push(i)}}r=Object(T.a)(Object(T.a)({},r),{},{topics:e}),this.enqueueEvent(n,this.setTopics.bind(this,n,r,(e=>i(e))));break}}}loadStickerThumb(e){const t=e=>`${e.id}_${e.type}`;return new Promise((s=>{const i={};for(let o=0;o<e.length;o++){var a,n;const s=e[o];if((null===(a=s.params)||void 0===a?void 0:a.msg_type)===W.MSG_STICKER||(null===(n=s.params)||void 0===n?void 0:n.msg_type)===W.CLI_MSG_TYPE_STICKER){var r;const e=null===(r=s.params)||void 0===r?void 0:r.extra;e&&null!=e.catId&&null!=e.id&&(i[t(s)]=this.StickerManager.getStickerIfNotExist(e.catId,e.id))}}Object.keys(i).length>0?Fg(i).then((i=>{for(let s=0;s<e.length;s++){const a=e[s],n=i[t(a)];n&&n.id===parseInt(a.params.extra.id)&&n.cateId===parseInt(a.params.extra.catId)&&(a.params.thumb=n.stickerUrl||"",e[s]=a)}s(e)})):s(e)}))}loadExtraDataForTopics(e){return new Promise((t=>{this.loadStickerThumb(e).then((e=>{t(e)}))}))}getCache(e){return this.cache.get(e)}get Fetcher(){return this.fetcher}get Logger(){return this.logger}get StickerManager(){return Og.g}get Storage(){return this.storage}})||kg)||kg)||kg)||kg)||kg;i.ModuleContainer.register(Cg,jg);var Ug=class{createOneOnOneTopic(e="",t,s=0,i="vi"){let a={conversationId:e,topic:t,version:s,lang:i};A.default.logCoreInfo("[PinTopic] - createOneOnOneTopic params: ",a);const n=w.b.getFriendBoardDomain()+"/api/friendboard/create?"+this.getCommonParams()+"&params="+this.getEncodedParams(a);return this.getRequest(n,null,12067)}getListOneOnOnePinTopics(e="",t=0){let s={conversationId:e,version:t};A.default.logCoreInfo("[PinTopic] - getListOneOnOnePinTopics params: ",s);const i=w.b.getFriendBoardDomain()+"/api/friendboard/list?"+rs.default._getCommonParams()+"&params="+this.getEncodedParams(s);return this.getRequest(i,null,12065)}reorderOneOnOnePinTopics(e="",t,s=0,i="vi"){let a={conversationId:e,topics:t,version:s,lang:i};A.default.logCoreInfo("[PinTopic] - reorderOneOnOnePinTopics params: ",a);const n=w.b.getFriendBoardDomain()+"/api/friendboard/reorder?"+this.getCommonParams()+"&params="+this.getEncodedParams(a);return this.getRequest(n,null,12068)}unpinOneOnOneTopics(e="",t,s=0,i="vi"){let a={conversationId:e,topics:t,version:s,lang:i};A.default.logCoreInfo("[PinTopic] - unpinOneOnOneTopics params: ",a);const n=w.b.getFriendBoardDomain()+"/api/friendboard/multi_unpin?"+this.getCommonParams()+"&params="+this.getEncodedParams(a);return this.getRequest(n,null,12069)}getCommonParams(){return rs.default._getCommonParams()}getEncodedParams(e){return rs.default.getEncodedParams(e)}getRequest(e,t,s,i,a,n,r,o,c){return rs.default._get(e,t,s,i,a,n,r,o,c)}};var Bg=function(){let e;function t(){return e||(e=new Ug),e}const s=e=>new Promise(((t,s)=>{e.then(os.a).then(t).catch(s)}));return{createOneOnOneTopic:(e,i,a=0)=>{const n=Object(T.a)({},i),{params:r}=n;r&&r.extra&&r.extra.constructor===Object&&(r.extra=JSON.stringify(r.extra)),r&&(n.params=JSON.stringify(r)),null==n.src&&(n.src=-1),null==n.pinAct&&(n.pinAct=1);const o=ni.default.getCurrentLanguageName();return s(t().createOneOnOneTopic(e,n,a,o))},getListOneOnOnePinTopics:(e,i=0)=>s(t().getListOneOnOnePinTopics(e,i)),reorderOneOnOnePinTopics:(e,i,a=0)=>{const n=ni.default.getCurrentLanguageName();return s(t().reorderOneOnOnePinTopics(e,i,a,n))},unpinOneOnOneTopics:(e,i,a=0)=>{const n=ni.default.getCurrentLanguageName();return s(t().unpinOneOnOneTopics(e,i,a,n))}}},Gg=function(e){return e.CREATE="create",e.FETCH="fetch",e.REORDER="reorder",e.UNPIN="unpin",e}(Gg||{});var zg=class extends Ag{constructor(){super(rg.f.Network,[Gg.CREATE,Gg.FETCH,Gg.REORDER,Gg.UNPIN])}infoCreate(...e){this.logInfo(Gg.CREATE,...e)}infoFetch(...e){this.logInfo(Gg.FETCH,...e)}infoReorder(...e){this.logInfo(Gg.REORDER,...e)}infoUnpin(...e){this.logInfo(Gg.UNPIN,...e)}errorCreate(...e){this.logError(Gg.CREATE,...e)}errorFetch(...e){this.logError(Gg.FETCH,...e)}errorReorder(...e){this.logError(Gg.REORDER,...e)}errorUnpin(...e){this.logError(Gg.UNPIN,...e)}logInfo(e,...t){this.isEnableLog()&&super.info(e,...t)}logError(e,...t){this.isEnableLog()&&super.error(e,...t)}isEnableLog(){return Object(dg.i)()}};var xg,Vg=class{constructor(){this.apiClient=void 0,this.logger=void 0,this.requestID=void 0,this.apiClient=Bg(),this.logger=new zg,this.requestID=new Eg.a}async fetchTopics(e,t=0){const s=this.getRequestId();this.Logger.infoFetch(s,`call cId:${e}`,t);try{const i=await this.apiClient.getListOneOnOnePinTopics(e,t);return this.Logger.infoFetch(s,`cId:${e} success`,i.version),{status:rg.h.SUCCESS,response:{data:{topics:i.data,version:i.version}}}}catch(i){return this.Logger.errorFetch(s,`cId:${e} fail`,Dg(i,Object(dg.d)())),Promise.reject({status:rg.h.ERROR,error:{code:i.code||i.error_code,message:i.error_message}})}}async createTopic(e,t,s=0){const i=this.getRequestId();this.Logger.infoCreate(i,`call cId:${e}`,s);try{const a=await this.apiClient.createOneOnOneTopic(e,t,s);return this.Logger.infoCreate(i,`cId:${e} success`,a.version),{status:rg.h.SUCCESS,response:{data:{topic:a.data,version:a.version}}}}catch(a){return this.Logger.errorCreate(i,`cId:${e} fail`,Dg(a,Object(dg.d)())),Promise.reject({status:rg.h.ERROR,error:{code:a.code||a.error_code,message:a.error_message}})}}async unpinTopics(e,t,s=0){const i=this.getRequestId();this.Logger.infoUnpin(i,`call cId:${e}`,s);try{const a=await this.apiClient.unpinOneOnOneTopics(e,t,s);return this.Logger.infoUnpin(i,`cId:${e} success`,a.version),{status:rg.h.SUCCESS,response:{data:a}}}catch(a){return this.Logger.errorUnpin(i,`cId:${e} fail`,Dg(a,Object(dg.d)())),Promise.reject({status:rg.h.ERROR,error:{code:a.code||a.error_code,message:a.error_message}})}}async reorderTopics(e,t,s=0){const i=this.getRequestId();this.Logger.infoReorder(i,`call cId:${e}`,s);try{const a=await this.apiClient.reorderOneOnOnePinTopics(e,t,s);return this.Logger.infoReorder(i,`cId:${e} success`,a.version),{status:rg.h.SUCCESS,response:{data:a}}}catch(a){return this.Logger.errorUnpin(i,`cId:${e} fail`,Dg(a,Object(dg.d)())),Promise.reject({status:rg.h.ERROR,error:{code:a.code||a.error_code,message:a.error_message}})}}getRequestId(){return this.requestID.next()}get Logger(){return this.logger}};i.ModuleContainer.register(Lg,Vg);var Hg=Object(i.singleton)(ag)(xg=class{constructor(){this._storage=void 0}async clearTopics(e,t=!1){try{let s;if(t)s=this.storage.removeConversationTopics(e);else{const t={conversationId:e,topics:[]},i=["topics"];s=this.storage.updateGroupTopic(t,i)}return await s,e}catch(s){return Promise.reject(s)}}async loadTopics(e){try{return(await this.loadTopicsFromDB(e)).response.data}catch(t){return Promise.reject(t)}}async setTopics(e){try{return await this.setTopicsToDB(e)}catch(t){return Promise.reject(t)}}getEntryPointPromotionalTooltipShowedStatus(){const e=n.default.getInstance().getItemForCurrentUser(rg.e.ONE_ON_ONE_ENTRY_POINT_PROMOTIONAL_TOOLTIP_SHOWED);if(null===e)return null;try{return JSON.parse(e)}catch(t){return!1}}async getMessagesByIds(e,t){try{const s=await this.storage.getMessagesByIds(e,t);let i;t&&t.length>0&&(i=t[0]);let a=null;return i&&(a=s[i]),a||Promise.reject("Not found")}catch(s){return Promise.reject(s)}}async getMessageByCliMsgId(e,t,s={}){try{const{myUID:i,userId:a}=s;if(a){let s=a;i==a&&(s="0");const n=await this.storage.getMessageByCliMsgIdOwnerId(e,t,s);return n||Promise.reject("Not found")}const n=await this.storage.getMessageByCliMsgId(t,e);if(!n||!n.length)return Promise.reject("Not found");n.length;const r=n&&n[0];return r||Promise.reject("Not found")}catch(i){return Promise.reject(i)}}setEntryPointPromotionalTooltipShowedStatus(e){n.default.getInstance().setItemForCurrentUser(rg.e.ONE_ON_ONE_ENTRY_POINT_PROMOTIONAL_TOOLTIP_SHOWED,JSON.stringify(e))}setForcedFetchMilestone(e){n.default.getInstance().setItemForCurrentUser(rg.e.FORCE_FETCH_MILESTONE,e.toString())}async loadTopicsFromDB(e){try{const t=await this.storage.getGroupTopic(e);return{status:rg.h.SUCCESS,response:{data:t}}}catch(t){return Promise.reject({status:rg.h.ERROR,error:{code:null==t?void 0:t.code,message:(null==t?void 0:t.message)||(null==t?void 0:t.error_message),data:t}})}}async setTopicsToDB(e){return await this.storage.setGroupTopic(e)}get storage(){return this._storage||(this._storage=s("XS0u").default),this._storage}})||xg;i.ModuleContainer.register(ng,Hg);var qg=s("+3r3");var Wg=Object(i.define)("pin-topic-one-on-one-controller"),Zg=function(e){return e.CONTROL="control",e.CREATE="create",e.LOAD="load",e.REORDER="reorder",e.UNPIN="unpin",e}(Zg||{});var Kg,Qg=class extends Ag{constructor(){super(rg.f.OneOnOneController,[Zg.CONTROL,Zg.CREATE,Zg.LOAD,Zg.REORDER,Zg.UNPIN])}infoControl(...e){this.logInfo(Zg.CONTROL,...e)}infoCreate(...e){this.logInfo(Zg.CREATE,...e)}infoLoad(...e){this.logInfo(Zg.LOAD,...e)}infoReorder(...e){this.logInfo(Zg.REORDER,...e)}infoUnpin(...e){this.logInfo(Zg.UNPIN,...e)}errorControl(...e){this.logError(Zg.CONTROL,...e)}errorCreate(...e){this.logError(Zg.CREATE,...e)}errorLoad(...e){this.logError(Zg.LOAD,...e)}errorReorder(...e){this.logError(Zg.REORDER,...e)}errorUnpin(...e){this.logError(Zg.UNPIN,...e)}logInfo(e,...t){this.isEnableLog()&&super.info(e,...t)}logError(e,...t){this.isEnableLog()&&super.error(e,...t)}isEnableLog(){return Object(dg.g)()}};Object(i.injectable)()(Kg=Object(i.singleton)(Wg)(Kg=function(e,t){return Object(i.inject)(Cg)(e,void 0,0)}(Kg=function(e,t){return Object(i.inject)(ig)(e,void 0,1)}(Kg=Reflect.metadata("design:type",Function)(Kg=Reflect.metadata("design:paramtypes",[Object,Object])(Kg=class{constructor(e,t){this.dataRepository=e,this.messageLoader=t,this.events={},this.logger=void 0,this.requestID=void 0,this.initialize(),this.logger=new Qg,this.requestID=new Eg.a}getPinTopic(e,t,s){return new Promise(((i,a)=>{this.loadPinTopics(e).then((e=>{const{topics:n}=e,r=n.find((e=>e.id===(null==t?void 0:t.toString())&&e.type===s));r?i(r):a(null)})).catch(a)}))}getMessageFromTopic(e){return this.MessageLoader.getMessageFromTopic(e)}displayEntryPointPromotionalTooltip(){this.DataRepository.setEntryPointPromotionalTooltipShowedStatus(!0)}isDisplayedEntryPointPromotionalTooltip(){if(!Object(dg.l)())return!0;const e=this.DataRepository.getEntryPointPromotionalTooltipShowedStatus();return null!==e&&Boolean(e)}async loadPinTopics(e,t=!1){if(!Object(dg.k)())return Promise.reject({code:hg.c.OFF_FEATURE,message:""});const s=this.getRequestID();try{var i;let a;t&&(a=hg.e.OPEN_DIALOG),this.Logger.infoLoad(s,`call cId:${e}`,t);const n=await this.DataRepository.loadPinTopics(e,a);return this.Logger.infoLoad(s,`res cId:${e}`,!!n,n.conversationId,null===(i=n.topics)||void 0===i?void 0:i.length),{conversationId:n.conversationId,topics:n.topics}}catch(a){return this.Logger.errorLoad(s,`err cId:${e}`,Dg(a,Object(dg.a)())),Promise.reject(a)}}addEventListener(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)}removeEventListener(e,t){const s=this.events[e],i=(this.events[e]||[]).length;for(let a=0;a<i;a++)if(s[a]===t){s.splice(a,1);break}0===s.length&&delete this.events[e]}removeEventListeners(e){delete this.events[e]}handleEventControl(e){if(!Object(dg.k)())return;const t=this.getRequestID();this.Logger.infoControl(t,"recv",e.act,Dg(e.data,Object(dg.a)())),this.DataRepository.handleReceivingEvent(e.act,e.data).then((s=>{if(this.Logger.infoControl(t,"res",e.act,Dg(s,Object(dg.a)())),e.act===hg.d.UNPIN){let t=[];if(Array.isArray(e.data.topics)&&e.data.topics.forEach((e=>{s.topics.find((t=>t.id===e.topicId&&t.type===e.topicType))||t.push({topicId:e.topicId,topicType:e.topicType})})),t.length>0){const s={};t.forEach((t=>{s[`${t.topicId}_${t.topicType}`]=this.getPinTopic(e.data.conversationId,t.topicId,t.topicType)})),Fg(s).then((e=>{const t=Object.keys(e).map((t=>e[t]));this.MessageLoader.removeMessages(t)}))}}this.MessageLoader.loadMessages(s.conversationId,s.topics),this.notifyChangeEvent(s.conversationId,s.topics)})).catch((s=>{this.Logger.errorControl(t,"err",e.act,Dg(s,Object(dg.a)()))}))}async createPinTopic(e,t,s=2){if(!Object(dg.k)())return Promise.reject({code:hg.c.OFF_FEATURE,message:""});const i=this.getRequestID();try{var a;if(this.Logger.infoCreate(i,`call cId:${e}`,!!t,s),!this.isValidNetwork())return Promise.reject({code:hg.c.NO_NETWORK,message:"STR_CHECK_NET"});const n=await this.retryable(s,(()=>this.processCreatePinTopic(e,t,s)));return this.Logger.infoCreate(i,`res cId:${e}`,!!n,null==n?void 0:n.conversationId,null==n||null===(a=n.topics)||void 0===a?void 0:a.length),n}catch(n){return this.Logger.errorCreate(i,`err cId:${e}`,Dg(n,Object(dg.a)())),Promise.reject(n)}}async reorderPinTopics(e,t,s=2){if(!Object(dg.k)())return Promise.reject({code:hg.c.OFF_FEATURE,message:""});const i=this.getRequestID();try{var a;if(this.Logger.infoReorder(i,`call cId:${e}`,t.length,s),!this.isValidNetwork())return Promise.reject({code:hg.c.NO_NETWORK,message:"STR_CHECK_NET"});const n=await this.retryable(s,(()=>this.processReorderPinTopics(e,t,s)));return this.Logger.infoReorder(i,`res cId:${e}`,!!n,null==n?void 0:n.conversationId,null==n||null===(a=n.topics)||void 0===a?void 0:a.length),n}catch(n){return this.Logger.errorReorder(i,`err cId:${e}`,Dg(n,Object(dg.a)())),Promise.reject(n)}}async unpinPinTopics(e,t,s=2){if(!Object(dg.k)())return Promise.reject({code:hg.c.OFF_FEATURE,message:""});const i=this.getRequestID();try{var a;if(this.Logger.infoUnpin(i,`call cId:${e}`,t.length,s),!this.isValidNetwork())return Promise.reject({code:hg.c.NO_NETWORK,message:"STR_CHECK_NET"});const n=await this.retryable(s,(()=>this.processUnpinPinTopics(e,t,s)));return this.Logger.infoUnpin(i,`res cId:${e}`,!!n,null==n?void 0:n.conversationId,null==n||null===(a=n.topics)||void 0===a?void 0:a.length),n}catch(n){return this.Logger.errorUnpin(i,`err cId:${e}`,Dg(n,Object(dg.a)())),Promise.reject(n)}}isMessagePinnable(e){return function(e){return lg(e)}(e)}initialize(){this.FriendManager.subscribeEventFriend(W.EventFriend.REMOVE_FRIEND,(e=>{const{userId:t}=e;t&&this.clearTopics(t)})),Object(qg.b)(this.clear)}clear(){this.DataRepository.clear(),this.MessageLoader.clear()}checkEnableToCreate(e,t,s){const i=(()=>{if(t.type===hg.i.MESSAGE){const i=s.topics,a=t.params.global_msg_id,n=t.params.client_msg_id,r=t.params.senderUid;for(let t=0;t<i.length;t++){const s=i[t];if(s.type===hg.i.MESSAGE){const t=this.MessageLoader.getMessageFromTopic(s);if(null!=t&&null!=a&&t.msgId===a)return s;if(null!=t&&null!=n&&t.cliMsgId===n&&t.fromUid===r&&t.toUid===e)return s}}}return null})();return s.topics.length<Object(dg.c)()||i?{enable:!0,oldTopic:i}:{enable:!1,oldTopic:null}}clearTopics(e){this.DataRepository.loadPinTopics(e,hg.e.NONE).then((t=>{this.DataRepository.clearPinTopicsForConversation(e,!0),this.MessageLoader.removeMessages(t.topics),this.notifyChangeEvent(e,[])})).catch()}getRequestID(){return this.requestID.next()}async fetchTopicsForHandleTopLevelErrors(e,t){return await this.DataRepository.loadPinTopics(e,t)}async handleTopLevelErrorInvalidBoardVersion(e,t,s){const{conversationId:i}=t;try{const e=await this.fetchTopicsForHandleTopLevelErrors(i,hg.e.OUT_OF_DATE);return s?await s():e}catch(a){return Promise.reject(e)}}async handleTopLevelErrorRolledData(e,t){const{conversationId:s}=t;try{const t=await this.fetchTopicsForHandleTopLevelErrors(s,hg.e.ROLLED_DATA);return this.notifyChangeEvent(t.conversationId,t.topics),Promise.reject({code:hg.c.TOPIC_NOT_IN_PIN_LIST,message:e.message||"STR_PIN_GENERAL_ERROR"})}catch(i){return Promise.reject(e)}}async handleTopLevelErrorUserBlockFriend(e){return Promise.reject({code:hg.c.USER_BLOCK_FRIEND,message:e.message||"STR_TOAST_BLOCK"})}async handleTopLevelErrorUserNonFriend(e){return Promise.reject({code:hg.c.USER_NON_FRIEND,message:e.message||"STR_PIN_NOT_ZALO_FRIEND"})}async handleTopLevelErrors(e,t,s){return e.code===hg.c.INVALID_BOARD_VERSION?await this.handleTopLevelErrorInvalidBoardVersion(e,t,s):e.code===hg.c.TOPIC_NOT_IN_PIN_LIST?await this.handleTopLevelErrorRolledData(e,t):e.code===hg.c.USER_BLOCK_FRIEND?await this.handleTopLevelErrorUserBlockFriend(e):e.code===hg.c.USER_NON_FRIEND?await this.handleTopLevelErrorUserNonFriend(e):Promise.reject(e)}isValidNetwork(){return Fn.b.getStateNetwork()===Fn.a.CONNECTED}notifyEvent(e,...t){const s=this.events[e],i=(this.events[e]||[]).length;for(let a=0;a<i;a++)"function"==typeof s[a]&&s[a](...t)}notifyChangeEvent(e,t){this.notifyEvent("onchange",e,t)}notifyExceedEvent(e,t,s){this.notifyEvent("onexceed",e,t,s)}async processCreatePinTopic(e,t,s=2){if(!this.FriendManager.isFriend(e))return Promise.reject({code:hg.c.USER_NON_FRIEND,message:"STR_PIN_NOT_ZALO_FRIEND"});if(this.FriendManager.isBlocked(e))return Promise.reject({code:hg.c.USER_BLOCK_FRIEND,message:"STR_TOAST_BLOCK"});try{const s=await this.DataRepository.createPinTopic(e,t,{checkEnableToCreate:this.checkEnableToCreate.bind(this)});return this.MessageLoader.loadMessages(e,s.topics),this.notifyChangeEvent(s.conversationId,s.topics),{conversationId:s.conversationId,topics:s.topics}}catch(a){try{const i=await this.handleTopLevelErrors(a,{conversationId:e},this.createPinTopic.bind(this,e,t,s-1));return{conversationId:i.conversationId,topics:i.topics}}catch(n){if(n.code===hg.c.PINBOARD_OVER_MAXIMUM){var i;const s=null==n||null===(i=n.data)||void 0===i?void 0:i.cache;this.notifyExceedEvent(e,(null==s?void 0:s.topics)||[],t)}return Promise.reject(n)}}}async processReorderPinTopics(e,t,s=2){try{const s=await this.DataRepository.reorderPinTopics(e,t);return this.notifyChangeEvent(s.conversationId,s.topics),{conversationId:s.conversationId,topics:s.topics}}catch(i){try{const a=await this.handleTopLevelErrors(i,{conversationId:e},this.reorderPinTopics.bind(this,e,t,s-1));return{conversationId:a.conversationId,topics:a.topics}}catch(a){return Promise.reject(a)}}}async processUnpinPinTopics(e,t,s=2){try{const s=await this.DataRepository.unpinTopics(e,t);return this.MessageLoader.removeMessages(t),this.notifyChangeEvent(s.conversationId,s.topics),{conversationId:s.conversationId,topics:s.topics}}catch(i){try{const a=await this.handleTopLevelErrors(i,{conversationId:e},this.unpinPinTopics.bind(this,e,t,s-1));return{conversationId:a.conversationId,topics:a.topics}}catch(a){return Promise.reject(a)}}}async retryable(e,t){return null!=e&&e<0?Promise.reject({code:hg.c.STOP_RETRY_CLIENT,message:"STR_PIN_GENERAL_ERROR"}):await t()}get DataRepository(){return this.dataRepository}get FriendManager(){return Z.default}get Logger(){return this.logger}get MessageLoader(){return this.messageLoader}})||Kg)||Kg)||Kg)||Kg)||Kg);var $g,Yg=s("74m0");Object(i.injectable)()($g=Object(i.singleton)(Yg.a)($g=function(e,t){return Object(i.inject)(Wg)(e,void 0,0)}($g=Reflect.metadata("design:type",Function)($g=Reflect.metadata("design:paramtypes",[Object])($g=class{constructor(e){this.oneOnOneController=e}addEventListener(e,t){this.OneOnOneController.addEventListener(e,t)}createPinTopic(e,t){return Object(cg.d)(e)?Promise.resolve():this.OneOnOneController.createPinTopic(e,t)}displayOneOnOneEntryPointPromotionalTooltip(){return this.OneOnOneController.displayEntryPointPromotionalTooltip()}getPinTopic(e,t,s){return Object(cg.d)(e)?Promise.resolve():this.OneOnOneController.getPinTopic(e,t,s)}getMessageFromTopic(e,t){if(!Object(cg.d)(e))return this.OneOnOneController.getMessageFromTopic(t)}handleEventControl(e){}handleOneOnOneEventsControl(e){this.OneOnOneController.handleEventControl(e)}isDisplayedOneOnOneEntryPointPromotionalTooltip(){return this.OneOnOneController.isDisplayedEntryPointPromotionalTooltip()}isEnablePinTopicOneOnOneFeature(){return dg.k()}isEnablePinTopicOneOnOneEntryPoint(){return dg.j()}isMessagePinnable(e,t){return!!this.isMessagePinnableForAllConversations(e)&&(t!==W.CONVERSATION_TYPE.FRIEND||this.OneOnOneController.isMessagePinnable(e))}loadPinTopics(e,t){return Object(cg.d)(e)?Promise.resolve():this.OneOnOneController.loadPinTopics(e,t)}removeEventListener(e,t){this.OneOnOneController.removeEventListener(e,t)}removeEventListeners(e){this.OneOnOneController.removeEventListeners(e)}reorderPinTopics(e,t){return Object(cg.d)(e)?Promise.resolve():this.OneOnOneController.reorderPinTopics(e,t)}unpinPinTopics(e,t){return Object(cg.d)(e)?Promise.resolve():this.OneOnOneController.unpinPinTopics(e,t)}isMessagePinnableForAllConversations(e){return lg(e)}get OneOnOneController(){return this.oneOnOneController}})||$g)||$g)||$g)||$g);var Jg,Xg=s("CPou"),em=s("MnxE"),tm=s("NDwn");Object(ie.b)(Ta.b)(Jg=Reflect.metadata("design:type",Function)(Jg=Reflect.metadata("design:paramtypes",[])(Jg=class{get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger(Ss.ZLoggerNametags.onlyAdminChatSettings,[this.name])),this._Logger}constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.settings=new Map,this.me="",this._Logger=void 0,this.name=Ta.a,this.key=Ta.a,1===U.default.only_admin_chat_setting.enable_only_admin_chat_setting&&this._addPublicGroupSettingEventListener(),this._addPublicFriendEventListener(),tm.a||em.a.signalCallback(this.onSettingsUpdate.bind(this))}_filterSettingKeys(e,t,s){let i={lockSendMsg:!1};for(let a in e)Object.keys(Xg.a).includes(a)&&a===Xg.a.lockSendMsg&&(i[Xg.a.lockSendMsg]=!t&&!s&&Boolean(e[Xg.a.lockSendMsg]));return i}_onUpdateSettings(e,t,s,i){this.me||(this.me=Z.default.getUidMe());const a=this.me===t,n=this._filterSettingKeys(i,a,s);return this.settings.set(e,n),Object(Zs.g)(this.name,e),n}showNoti(e){if("TOAST"===e.type)Sh.ZToastManagerHolder.getZToastManagerByWindowId(e.windowId||yt.c).show(Object(T.a)({},e.config))}verifySetting(e){const{convId:t,field:s,showNoti:i}=e,a=this.settings.get(t);return a?(i&&i.triggerValue===a[s]&&this.showNoti(i),a&&a[s]):null}onSettingsUpdate(e,t){let s=this.settings.get(e)||{lockSendMsg:!1};for(let i in t)Object.keys(Xg.a).includes(i)&&(s[i]=t[i]);this.settings.set(e,s),Object(Zs.g)(this.name,e)}_addPublicGroupSettingEventListener(){Fe.default.subscribeEventGroup(W.EventGroup.CHANGE_OWNER,(e=>{const{groupId:t}=e;t&&this.onLoadGroupSetting(t)})),Fe.default.subscribeEventGroup(W.EventGroup.ADD_ADMIN,(e=>{const{groupId:t}=e;t&&this.onLoadGroupSetting(t)})),Fe.default.subscribeEventGroup(W.EventGroup.REMOVE_ADMIN,(e=>{const{groupId:t}=e;t&&this.onLoadGroupSetting(t)})),Fe.default.subscribeEventGroup(W.EventGroup.GROUP_INFO_CHANGED,(e=>{if(null!=e&&e.length)for(let t=0;t<e.length;t++)this.onLoadGroupSetting(e[t])})),Ki.default.subscribe(yt.a.CHILD_WINDOW_ALIVE,(e=>{null!=e&&e.windowId&&this.onLoadSetting(e.windowId)})),N.default.subscribe(((e,t)=>{switch(e){case P.FetchActions.UPDATE_GROUP_SETTING:{var s,i;const e=null!=t&&null!==(s=t.data)&&void 0!==s&&null!==(i=s.groupId)&&void 0!==i&&i.startsWith("g")?t.data.groupId:"g"+t.data.groupId;e&&this.onLoadGroupSetting(e);break}}}))}updateFriendBLockSetting(e,t){const s=t||Z.default.isBlocked(e),i=1===U.default.block_msg_call_setting.enable_block_msg_call_setting;this.onSettingsUpdate(e,{[Xg.a.lockSendMsg]:Boolean(s)&&i})}_addPublicFriendEventListener(){Z.default.subscribeEventFriend(W.EventFriend.BLOCK_FRIEND,(e=>{this.updateFriendBLockSetting(e.userId,!0)})),Z.default.subscribeEventFriend(W.EventFriend.UNBLOCK_FRIEND,(e=>{this.updateFriendBLockSetting(e.userId,!1)})),N.default.subscribe(((e,t)=>{if(e===P.FriendsAction.FRIENDS_CHANGE_INFO)t&&Array.isArray(t)&&t.forEach((({userId:e})=>{this.updateFriendBLockSetting(e)}))}))}_checkGroupAdmin(e){var t;return this.me||(this.me=Z.default.getUidMe()),(null==e||null===(t=e.topMember)||void 0===t?void 0:t.filter((e=>e.id===this.me&&e.isAdmin)).length)>0}onLoadGroupSetting(e){return new Promise(((t,s)=>{Fe.default.getFullInfoGroupById(e).then((s=>{if(!s)return this.Logger.zsymb(18,"YWHSIR","[GroupSetting]: Load GroupInfo from manager faily "+s+", GroupId: "+e),t(null);const i=s.setting,a=s.creatorId,n=this._checkGroupAdmin(s),r=this._onUpdateSettings(e,a,n,i);i&&!i.hasOwnProperty("lockSendMsg")&&this.Logger.zsymb(18,"Jj9hmI","[GroupSetting]: Dont have field lockSendMsg in setting data"),t(r)})).catch((s=>{this.Logger.zsymb(18,"1waAzE","[GroupSetting]: Have error in loadiing GroupInfo from manager: "+JSON.stringify(s)+", GroupId: "+e),t(null)}))}))}async onLoadSetting(e){return e.startsWith("g")?1!==U.default.only_admin_chat_setting.enable_only_admin_chat_setting?null:await this.onLoadGroupSetting(e):(this.updateFriendBLockSetting(e),tm.a?null:void em.a.signalIfUnlock(e))}init(e){throw new Error("Method not  .")}getCurrentItem(e){return this.settings.get(e)}getItem(e,t){return this.settings.get(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||Jg)||Jg);var sm=s("OMsT"),im=s("Rw5y"),am=s("7FSS"),nm=s("xOOu"),rm=s.n(nm),om=s("5FGm");const cm=/^(((main|login|photo|render|shared-worker|preload-shared-worker|utility-process-sqlite|preload-sqlite)\.(zlog|log|module|meta|dmeta|calf|txt))|(voip\.old|voip)\.log|((zavi|crash)\.dmp))$/;var lm;const dm=$znode.fs,hm=$znode.path,um=$znode.os;let gm=Object(i.injectable)()(lm=class{constructor(){this.appdataFolder=null}clientDeviceInfo(){const e=um.platform(),t=um.release(),s=um.hostname(),i=um.type();return JSON.stringify({name:s,model:i,os:e,osVersion:t})}async getLogDir(){return this.appdataFolder||(this.appdataFolder=await Object(re.getuserDataDir)()),this.appdataFolder}async prepareLogBlob(e){return new Promise(((t,s)=>{let i="";this.getLogDir().then((e=>{const t=om.b;i=hm.join(e,t);return{main:{fn:im.a,args:[{fs:dm},i]},other:{fn:$zFileManager.scandirLog,args:[i]}}.other})).then((e=>e.fn(...e.args))).then((t=>{var s,a;let n=[],r=[];return r=t.filter((e=>{const t=cm.test(e),s=e.endsWith(".zlog")||e.endsWith(".calf")||e.endsWith(".module")||e.endsWith(".meta");return!!cm.test(e)&&(t&&s)})).map((e=>hm.join(this.appdataFolder,e))),r.push(...e.extraFiles),r.forEach((e=>{n.push(this.readFile(e))})),n=(null===(s=r)||void 0===s?void 0:s.map((e=>this.readFile(hm.join(i,e)))))||[],null==e||null===(a=e.extraFiles)||void 0===a||a.forEach((e=>{var t;n.push((t=e,new Promise((e=>{$zFileManager.getExtraLogFiles(t).then((s=>{e({name:hm.basename(t),data:s})})).catch((s=>{e({name:hm.basename(t),data:new ArrayBuffer(0)})}))}))))})),n})).then((e=>Promise.all(e))).then((e=>{const t=new rm.a;e.forEach((e=>{e&&e.data.byteLength>0&&t.file(e.name,e.data)}));{const e="device.zinfo",s=new TextEncoder;t.file(e,s.encode(this.clientDeviceInfo()).buffer)}return t.generateAsync({type:"arraybuffer",compression:"DEFLATE"})})).then((s=>{let i=e.viewerKey;if(!i){i=_t.default.getLastViewKey()||"";try{var a;i=null===(a=i)||void 0===a?void 0:a.split(".")[0]}catch{}}const n=`zlog_${i}_${Date.now()}.zip`;if(e.bareContent)t({name:n,data:new Uint8Array(s)});else{const e=new Blob([new Uint8Array(s)]);e.name=n,t(e)}})).catch((e=>{am.a.error("[ZLL]: failed to prepare log for sending log",e),s(e)}))}))}async readFile(e){const t=hm.basename(e);let s;try{s=await $zFileManager.readZLog(t)}catch{s=new ArrayBuffer(0)}return{name:t,data:s}}})||lm;i.ModuleContainer.registerSingleton(sm.a,gm);var mm=s("t5n0"),pm=s("aQZC");var fm,vm=new class{constructor(){this.focusManager=void 0,this.focusStatus=void 0,this.focusService=void 0}get FSV(){return this.focusService||(this.focusService=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger(Ss.ZLoggerNametags.appStatus,[Ss.ZLoggerNametags.focusDetectorManager])),this.focusService}get FM(){return this.focusManager||(this.focusManager=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger(Ss.ZLoggerNametags.appStatus,[Ss.ZLoggerNametags.focusDetectorManager])),this.focusManager}get FSTT(){return this.focusStatus||(this.focusStatus=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger(Ss.ZLoggerNametags.appStatus,[Ss.ZLoggerNametags.focusStatus])),this.focusStatus}};let _m=Object(i.injectable)()(fm=Object(m.f)()(fm=function(e,t){return Object(i.inject)(dr.a)(e,void 0,0)}(fm=Reflect.metadata("design:type",Function)(fm=Reflect.metadata("design:paramtypes",[void 0===dr.a?Object:dr.a])(fm=class extends De.b{constructor(e){super(),this.config=e,this.detectors=void 0,this.lostFocusHandler=void 0,this.reFocusHandler=void 0,this.lastFirer=void 0,this.enableLog=void 0,this.listenDetector=(e,t)=>{t&&(this.detectors.set(e,t),this.lostFocusHandler.set(e,(()=>{this.onLostFocus(e)})),this.reFocusHandler.set(e,(()=>{this.onRefocus(e)})),t.idle(this.lostFocusHandler.get(e)),t.wakeup(this.reFocusHandler.get(e)))},this.disposeDetector=e=>{const t=this.detectors.get(e);this.enableLog&&vm.FM.zsymb(0,"91zqse","disposeDetector",e,!!t),t&&(t.removeIdle(this.lostFocusHandler.get(e)),t.removeWakeup(this.reFocusHandler.get(e)),t.ifvisible=null,t._window=null,t.removeAllIpc(),this.lostFocusHandler.delete(e),this.reFocusHandler.delete(e),this.detectors.delete(e))},this.onLostFocus=e=>{this.lastFirer&&(clearTimeout(this.lastFirer),this.lastFirer=null),this.lastFirer=setTimeout((()=>{this.enableLog&&vm.FM.zsymb(0,"VajPAW","onlostFocus",e);let t=!0,s=Number.MAX_SAFE_INTEGER,i="unknown";this.detectors.forEach((e=>{if(e.isActive())t=!1;else{const t=e.getIdleInfo();t.idleFor<s&&(s=t.idleFor,i=t.idleByTimeout?"no-action-timeout":"unknown")}})),t&&this.dispatchEvent(new mm.a(mm.b.LostFocus,{scope:"app",reason:i})),this.lastFirer=null}),200)},this.onRefocus=e=>{this.lastFirer&&(clearTimeout(this.lastFirer),this.lastFirer=null),this.lastFirer=setTimeout((()=>{this.enableLog&&vm.FM.zsymb(0,"dFVJ5H","onRefocus",e),this.dispatchEvent(new mm.a(mm.b.Focus,e)),this.lastFirer=null}),200)},this.detectors=new Map,this.lostFocusHandler=new Map,this.reFocusHandler=new Map,this.enableLog=!0}onAuthenticated(e){const{userId:t}=e.getSession();this.enableLog&&vm.FM.zsymb(0,"U1fMjN","onAuthenticated",t),this.init()}acquire(e,t,s){if(!e||e==yt.c)return pm.b;if(this.detectors.has(e))return vm.FM.zsymb(0,"Q9KtWw","acquire exists",e),this.detectors.get(e);this.enableLog&&vm.FM.zsymb(0,"nM2TRv","acquire new",e);const i=new pm.a(e,t,s);return this.listenDetector(e,i),i}release(e){this.disposeDetector(e)}getAppIdleTime(){let e=Number.MAX_SAFE_INTEGER;return this.detectors.forEach((t=>{const s=t.getIdleInfo();s.idleFor<e&&(e=s.idleFor)})),e}updateIdleTimeout(e){this.detectors.forEach((t=>{t.setIdleTimeout(e)}))}isAppFocus(){let e=!1;return this.detectors.forEach((t=>{t.isActive()&&(e=!0)})),e}init(){this.listenDetector(yt.c,pm.b)}})||fm)||fm)||fm)||fm)||fm;const bm=Object(i.define)("lost-focus-service"),ym=Object(i.define)("active-service");var Im,Sm=function(e){return e[e.Focus=0]="Focus",e[e.LostFocus=1]="LostFocus",e}(Sm||{});let Cm=Object(i.injectable)()(Im=Object(m.f)()(Im=function(e,t){return Object(i.inject)(dr.a)(e,void 0,0)}(Im=function(e,t){return Object(i.inject)(bm)(e,void 0,1)}(Im=Reflect.metadata("design:type",Function)(Im=Reflect.metadata("design:paramtypes",[void 0===dr.a?Object:dr.a,void 0===bm?Object:bm])(Im=class{constructor(e,t){this.config=e,this.service=t,this.enableLog=void 0,this.currentState=void 0,this.enableLog=!0,this.currentState=Sm.LostFocus}onAuthenticated(e){const{userId:t}=e.getSession();this.enableLog&&vm.FSTT.zsymb(0,"3DEzrG","onAuthenticated",t),this.init()}init(){const e=i.ModuleContainer.resolve(mm.c);e.addEventListener(mm.b.LostFocus,(e=>{const{scope:t,reason:s}=e.payload;this.currentState==Sm.Focus&&"app"===t&&(this.service.notiLostFocus(),this.config.get("online_configs.enable_focus_manager")&&ah.b.setAppStatus(ah.a.BACKGROUND),this.currentState=Sm.LostFocus)})),e.addEventListener(mm.b.Focus,(e=>{this.currentState==Sm.LostFocus&&this.config.get("online_configs.enable_focus_manager")&&ah.b.setAppStatus(ah.a.FOREGROUND),this.currentState=Sm.Focus}))}})||Im)||Im)||Im)||Im)||Im)||Im;var Em;let Om=Object(i.injectable)()(Em=function(e,t){return Object(i.inject)(dr.a)(e,void 0,0)}(Em=Reflect.metadata("design:type",Function)(Em=Reflect.metadata("design:paramtypes",[void 0===dr.a?Object:dr.a])(Em=class{constructor(e){this.config=e}notiLostFocus(){this.config.get("online_configs.enable_lost_focus")?rs.default.lostFocus().then(os.a).then((()=>{vm.FSV.zsymb(0,"-mQtEC","send noti lost success")})).catch((e=>{vm.FSV.zsymb(0,"SHiE16","send noti lost fail",JSON.stringify(e))})):vm.FSV.zsymb(0,"oD4bdd","call send noti lost but feat disable")}})||Em)||Em)||Em)||Em;var Tm,Mm=s("a8HX");let Rm=Object(i.injectable)()(Tm=function(e,t){return Object(i.inject)(B.ZLoggerFactory)(e,void 0,0)}(Tm=function(e,t){return Object(i.inject)(ym)(e,void 0,1)}(Tm=Reflect.metadata("design:type",Function)(Tm=Reflect.metadata("design:paramtypes",[void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory,void 0===ym?Object:ym])(Tm=class extends No{constructor(e,t){super(),this.loggerFactory=e,this.service=t}createMachine(){return e=this.loggerFactory.createZLogger(Ss.ZLoggerNametags.activeDeactive,[Ss.ZLoggerNametags.stateMachine]),t=this.service,Object(Yo.a)({strict:!0,id:"active-deactive",context:{},initial:"unset",states:{unset:{entry:()=>e.zsymb(3,"dO3XYp",["unset","5l_fCN"]),on:{FOCUS:{actions:()=>{e.zsymb(3,"XIHDus",["start life cycle normal case!","5TLqeQ"])},target:"foreground_active"},APP_UNLOCK:{actions:()=>{e.zsymb(3,"yk5n40",["start life cycle app auto lock case!","uI_G7J"])},target:"foreground_active"},LOST_FOCUS:{actions:()=>{e.zsymb(3,"Z6GA_K",["start life cycle lost focus case!","MCVqRL"])},target:"background_active"}}},foreground_active:{entry:s=>{e.zsymb(3,"x7UaFK",["state: foreground_active","shayUP"]),t.startForegroundMode()},on:{IDLE:{actions:()=>{},target:"background_deactive"},LOST_FOCUS:{actions:()=>{},target:"background_active"},INAPP_INTERACT:{actions:()=>{t.keepForegroundMode()}},OUTAPP_INTERACT:{actions:(e,s)=>{t.activeInBackground(s.isOsEvt)}},APP_LOCK:{target:"background_deactive"},APP_UNLOCK:{actions:()=>{t.startForegroundMode()}},LOG_OFF:{target:"background_deactive"},OUTAPP_IDLE:{target:"background_deactive"}}},background_active:{entry:s=>{e.zsymb(3,"mWfQiw",["state: background_active","6d_oft"]),t.startBackgroundMode()},on:{FOCUS:{target:"foreground_active"},OUTAPP_INTERACT:{actions:(e,s)=>{t.activeInBackground(s.isOsEvt)}},OUTAPP_IDLE:{target:"background_deactive"},APP_LOCK:{target:"background_deactive"},LOG_OFF:{target:"background_deactive"}}},background_deactive:{entry:(s,i)=>{e.zsymb(3,"64cLLU",["state: background_deactive","w2HSHe"],i.status),t.startDeactive(i.status)},on:{FOCUS:{actions:()=>{},target:"foreground_active"},OUTAPP_INTERACT:{actions:(e,s)=>{t.activeInBackground(s.isOsEvt)},target:"background_active"},APP_UNLOCK:{target:"foreground_active"}}}},on:{RESET:{target:"unset",actions:()=>{}}}});var e,t}isUnset(){var e;return"unset"===(null===(e=this.interpreter)||void 0===e?void 0:e.state.value)}onceDeactive(e){var t;if("background_deactive"===(null===(t=this.interpreter)||void 0===t?void 0:t.state.value))e();else{let t=()=>{var s,i;"background_deactive"===(null===(s=this.interpreter)||void 0===s?void 0:s.state.value)&&(null===(i=this.interpreter)||void 0===i||i.off(t),e())};this.onChange(t)}}})||Tm)||Tm)||Tm)||Tm)||Tm;var wm,Lm=s("4zJP");const Fm=new Map([["0","LOCK_SCREEN"],["1","UNLOCK_SCREEN"],["2","LOG_ON"],["3","LOG_OFF"],["4","SLEEP"],["5","RESUME"]]);let Dm=Object(i.injectable)()(wm=Object(m.j)()(wm=Object(m.h)()(wm=Object(i.singleton)(Mm.a)(wm=function(e,t){return Object(i.inject)(dr.a)(e,void 0,0)}(wm=function(e,t){return Object(i.inject)(B.ZLoggerFactory)(e,void 0,1)}(wm=function(e,t){return Object(i.inject)(ym)(e,void 0,2)}(wm=Reflect.metadata("design:type",Function)(wm=Reflect.metadata("design:paramtypes",[void 0===dr.a?Object:dr.a,void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory,void 0===ym?Object:ym])(wm=class{constructor(e,t,s){this.config=e,this.service=s,this.logger=void 0,this.machine=void 0,this.authenticated=void 0,this.appLocked=void 0,this.isRunning=void 0,this.lastConfig=void 0,this.onAppLock=()=>{this.logger.zsymb(0,"2vf5jr","app locked",this.authenticated),this.appLocked=!0,this.authenticated&&(this.machine.send({type:"APP_LOCK",status:2}),$zInAppPayment.closeInAppPayment())},this.onAppUnLock=()=>{this.logger.zsymb(0,"ePWhOU","app unlocked",this.authenticated),this.appLocked=!1,this.authenticated&&this.machine.send({type:"APP_UNLOCK",status:0})},this.onConfigChanged=e=>{U.default.stagingAccount&&(window._activeController=this),e&&this.config.set("online_configs",e);const t=this.isConfigsReallyChanged();if(this.logger.zsymb(0,"aNL4zJ","onConfigChanged",t),!t)return;this.lastConfig=this.config.get("online_configs");const s=this.config.get("online_configs.idle_time");i.ModuleContainer.resolve(mm.c).updateIdleTimeout(s/1e3),this.service.onConfigUpdated(),this.isEnable()?this.setup():this.onDispose()},this.onLostFocus=async e=>{const{scope:t,reason:s}=e.payload;"app"===t&&(this.logger.zsymb(0,"PzPkeg","lost focus",s),"no-action-timeout"!=s||await this.service.isUserHasAction(this.idleTime)?this.machine.send({type:"LOST_FOCUS"}):this.machine.send({type:"IDLE",status:0}))},this.onFocus=e=>{this.isUsingApp()&&(this.logger.zsymb(0,"6vFJx1","active-deactive focus"),this.machine.send({type:"FOCUS"}))},this.onActiveFromBackground=(e,t)=>{this.logger.zsymb(0,"uULaws","onActiveFromBackground",t),this.isUsingApp()&&this.machine.send({type:"OUTAPP_INTERACT",isOsEvt:t})},this.onDeactiveFromBackground=(e,t)=>{this.logger.zsymb(0,"gq4lx8","onDeactiveFromBackground",t),this.isUsingApp()&&this.machine.send({type:"OUTAPP_IDLE",status:t})},this.machine=i.ModuleContainer.resolveToken(Rm),this.logger=t.createZLogger(Ss.ZLoggerNametags.activeDeactive,[Ss.ZLoggerNametags.controller]),this.config=e,this.service=s,this.authenticated=!1,this.appLocked=!1,this.isRunning=!1,this.lastConfig={},ye.p.listenEvent(ye.m,this.onConfigChanged);try{this.machine.create()}catch(a){return void this.logger.zsymb(18,"g8y7g4",(()=>["create error",{error:a}]))}}createMachine(){}onStart(){this.isEnable()||this.logger.zsymb(0,"bkgU84","feature is not enable")}setup(){if(this.logger.zsymb(0,"ZFP_Oz","setup",this.isRunning),this.clearBackgroundTracking(),this.isEnableBackgroundTrack()&&this.setupBackgroundTracking(),this.isRunning)return;this.isRunning=!0,this.machine.start();const e=i.ModuleContainer.resolve(mm.c);this.machine.isUnset()&&(e.isAppFocus()?this.machine.send({type:"FOCUS"}):this.machine.send({type:"LOST_FOCUS"})),e.addEventListener(mm.b.LostFocus,this.onLostFocus),e.addEventListener(mm.b.Focus,this.onFocus),this.appLocked=ye.p.getAppLock(),Lm.b.on(Lm.a.APP_LOCKED,this.onAppLock),Lm.b.on(Lm.a.APP_UNLOCKED,this.onAppUnLock)}onAuthenticated(){this.authenticated=!0,this.isEnable()&&this.service.onLogin()}onDispose(){if(!this.isRunning)return;this.isRunning=!1,this.machine.stop();const e=i.ModuleContainer.resolve(mm.c);e.removeEventListener(mm.b.LostFocus,this.onLostFocus),e.removeEventListener(mm.b.Focus,this.onFocus),Lm.b.off(Lm.a.APP_LOCKED,this.onAppLock),Lm.b.off(Lm.a.APP_UNLOCKED,this.onAppUnLock),this.clearBackgroundTracking()}isConfigsReallyChanged(){for(const e in this.config.get("online_configs"))if(e&&this.lastConfig[e]!==this.config.get(`online_configs.${e}`))return!0;return!1}setupBackgroundTracking(){$zFeatures.activeDeactive.setup({delta:U.default.online_configs.idle_interval_check,inactiveTime:U.default.online_configs.idle_time,trackActive:U.default.online_configs.track_inactive_alive_back,currStatus:this.service.getStatus(),backgroundTracking:U.default.online_configs.enable_background_tracking,fullBgTracking:this.isEnableFullBackgroundTrack()}),$zsub.$zFeatures.activeDeactive.onActiveFromBackground(this.onActiveFromBackground),$zsub.$zFeatures.activeDeactive.onDeactiveFromBackground(this.onDeactiveFromBackground)}clearBackgroundTracking(){$zFeatures.activeDeactive.clearTimer(this.isEnableBackgroundTrack()),$zsub.$zFeatures.activeDeactive.offActiveFromBackground(this.onActiveFromBackground),$zsub.$zFeatures.activeDeactive.offDeactiveFromBackground(this.onDeactiveFromBackground)}onUserSendMessage(){this.isEnable()&&this.machine.send("INAPP_INTERACT")}onUserLogOff(){return new Promise((e=>{if(!this.isEnable()||!this.isUsingApp())return e(!1);this.machine.onceDeactive((()=>{e(!0)})),this.machine.send({type:"LOG_OFF",status:3}),this.onDispose(),setTimeout((()=>{e(!0)}),1e3)}))}onOSEvent(e){if(!this.isEnable())return;const t=Fm.get(e);N.default.send(P.GeneralActions.USER_ACTIVE_CHANGED,t),this.logger.zsymb(3,"fslx4a",["handle event os ","BoHr2b"],t)}isUsingApp(){const e=this.appLocked||ye.p.getWaitRestart();return this.authenticated&&!e}isEnable(){return this.config.get("online_configs.enable_active_deactive_v2")}isEnableBackgroundTrack(){return this.config.get("online_configs.enable_background_tracking")}isEnableFullBackgroundTrack(){return this.config.get("online_configs.enable_full_bg_tracking")}get pingInterval(){return this.config.get("online_configs.update_action_interval")}get idleTime(){return this.config.get("online_configs.idle_time")}})||wm)||wm)||wm)||wm)||wm)||wm)||wm)||wm)||wm;var Am,Nm=s("8RMw"),km=s("UkBb"),Pm=s("oQzU"),jm=function(e){return e[e.ActiveBackground=0]="ActiveBackground",e[e.KeepActiveForeground=1]="KeepActiveForeground",e[e.FirstActiveForeground=2]="FirstActiveForeground",e[e.ToBackground=3]="ToBackground",e[e.KeepActiveBackground=4]="KeepActiveBackground",e}(jm||{}),Um=function(e){return e[e.Idle=0]="Idle",e[e.ComputerLock=1]="ComputerLock",e[e.AppLock=2]="AppLock",e[e.LogOff=3]="LogOff",e}(Um||{}),Bm=function(e){return e[e.Foreground=0]="Foreground",e[e.BackgroundActive=1]="BackgroundActive",e[e.BackgroundDeactive=2]="BackgroundDeactive",e}(Bm||{});const Gm={[Bm.Foreground]:jm.KeepActiveForeground,[Bm.BackgroundActive]:jm.KeepActiveBackground};let zm=Object(i.injectable)()(Am=function(e,t){return Object(i.inject)(dr.a)(e,void 0,0)}(Am=function(e,t){return Object(i.inject)(B.ZLoggerFactory)(e,void 0,1)}(Am=function(e,t){return Object(i.inject)(mm.c)(e,void 0,2)}(Am=Reflect.metadata("design:type",Function)(Am=Reflect.metadata("design:paramtypes",[void 0===dr.a?Object:dr.a,void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory,void 0===mm.c?Object:mm.c])(Am=class{constructor(e,t,s){this.config=e,this.focusManager=s,this.logger=void 0,this.pingTimer=void 0,this.deactiveTimer=void 0,this.status=void 0,this.configChanged=void 0,this.countPingWssFail=0,this.logger=t.createZLogger(Ss.ZLoggerNametags.activeDeactive,[Ss.ZLoggerNametags.service]),this.status=Bm.Foreground,this.configChanged=!1}get pingInterval(){return this.config.get("online_configs.update_action_interval")}get deactiveTimeout(){return this.config.get("online_configs.idleTime")}get enableSendDeactiveOnBgIdle(){return this.config.get("online_configs.enable_deact_on_bg_idle")}get enableSendDeactiveOnFgIdle(){return this.config.get("online_configs.enable_deact_on_fg_idle")}get enSendActiveToKeepAlive(){return this.config.get("online_configs.send_active_to_keep_live")}get enActiveUsingSocket(){return this.config.get("online_configs.send_active_using_socket")}get enableBackgroundTracking(){return this.config.get("online_configs.enable_background_tracking")}get enableFeature(){return this.config.get("online_configs.enable_active_deactive_v2")}get enableFullBackgroundTrack(){return this.config.get("online_configs.enable_full_bg_tracking")}onLogin(){this.sendActiveToServer(jm.ActiveBackground)}startTrackIdle(e=!0){this.enableBackgroundTracking?(this.logger.zsymb(0,"oIt4xf","startTrackIdle"),$zFeatures.activeDeactive.createTimer(e)):this.logger.zsymb(0,"7C0Mth","in startTrackIdle but flag off")}stopTrackIdle(){this.logger.zsymb(0,"rPjJo4","stopTrackIdle"),$zFeatures.activeDeactive.clearTimer(this.enableBackgroundTracking)}startForegroundMode(){this.status=Bm.Foreground,this.sendActiveToServer(jm.FirstActiveForeground),this.clearPingTimer(),this.createPingTimer(),this.enableFullBackgroundTrack||this.stopTrackIdle()}keepForegroundMode(){this.sendActiveToServer(jm.KeepActiveForeground,{additionText:"[Send Msg] "})}startBackgroundMode(){this.status=Bm.BackgroundActive,this.enableBackgroundTracking||this.clearPingTimer(),this.enableBackgroundTracking&&this.createPingTimer(),this.startTrackIdle()}activeInBackground(e){const t=e?jm.ActiveBackground:jm.KeepActiveBackground;this.pingTimer?this.logger.zsymb(0,"kyNm20","user action bg but dont need ping because in ping interval"):this.sendActiveToServer(t)}startDeactive(e){let t=-1;switch(e){case 0:t=Um.Idle;break;case 1:t=Um.ComputerLock;break;case 2:t=Um.AppLock;break;case 3:t=Um.LogOff}this.clearPingTimer(),-1!==t&&this.canSendDeactive(t)&&this.sendDeactiveToServer(t),this.status===Bm.Foreground&&t==Um.Idle&&this.startTrackIdle(!1),t!=Um.ComputerLock&&t!=Um.AppLock||this.stopTrackIdle(),this.status=Bm.BackgroundDeactive}onConfigUpdated(){this.configChanged=!0,this.enableFeature||this.clearPingTimer()}getStatus(){return this.status}createPingTimer(){!this.pingTimer&&this.enableFeature&&(this.logger.zsymb(0,"4CL5Fm","createPingTimer"),this.configChanged=!1,this.pingTimer=setInterval((()=>{const e=Gm[this.status];e?this.sendPingActive(e):this.logger.zsymb(0,"wEzFDs","call ping invalid state!"),this.configChanged&&(this.clearPingTimer(),this.createPingTimer())}),this.pingInterval))}clearPingTimer(){this.logger.zsymb(0,"fW3zjZ","clearPingTimer"),clearInterval(this.pingTimer),this.pingTimer=null}async isUserHasAction(e){let t=this.focusManager.getAppIdleTime();{const e=await $zFeatures.activeDeactive.getIdleTime();t=Math.min(t,e)}return t<e}canSendDeactive(e){return e!==Um.Idle||(this.status===Bm.Foreground&&this.enableSendDeactiveOnFgIdle||this.status===Bm.BackgroundActive&&this.enableSendDeactiveOnBgIdle)}async sendPingActive(e){await this.isUserHasAction(this.pingInterval)?this.sendActiveToServer(e):this.logger.zsymb(3,"2Kv6g0",["call ping but discard, because the user don't have action!","rW55RL"])}sendActiveToServer(e,t={additionText:""}){const{additionText:s}=t;if(!this.enActiveUsingSocket||km.default.getMsgSrcType()!==W.MsgSources.SOCKET)return Si.default.increaseFailed(88888,0,0,e,Date.now()),this.sendActiveViaHttp(e,s).then((e=>(e&&(this.countPingWssFail=0),e)));let i=null;return i=this.enSendActiveToKeepAlive?Nm.default.pingActiveViaKeepAlive(e):Pm.a.instance().pingActive(e),i.then((()=>(this.countPingWssFail=0,this.logger.zsymb(3,"ZABQsU",["{}Call active app SUCCESS: socket - {}","CoPJ4V"],s,e),!0))).catch((t=>(this.logger.zsymb(21,"NrkkIo",["{}Call active fail: socket - {} - {}","PKVT2W"],s,e,JSON.stringify(t)),this.countPingWssFail++,Si.default.increaseFailed(88888,1,0,e,Date.now()),this.sendActiveViaHttp(e).then((t=>(t&&this.countPingWssFail>=3&&(this.countPingWssFail=0,Si.default.increaseFailed(88888,2,0,e,Date.now())),t))))))}sendActiveViaHttp(e,t=""){return new Promise((s=>{rs.default.active(e).then(os.a).then((()=>{this.logger.zsymb(3,"4dpQM4",["{}Call active app SUCCESS: http - {}","Ee5Oaq"],t,e),s(!0)})).catch((i=>{this.logger.zsymb(21,"l5t_eR",["{}Call active fail: http - {} - {}","yMCR2x"],t,e,JSON.stringify(i)),s(!1)}))}))}sendDeactiveToServer(e){return rs.default.deactiveV2().then(os.a).then((()=>(this.logger.zsymb(3,"vhEHdw",["Call deactive app SUCCESS {}","42qs-K"],e),!0))).catch((e=>(this.logger.zsymb(21,"4EVfQ7",["Call deactive fail: ","rnvPWY"],JSON.stringify(e)),!1)))}})||Am)||Am)||Am)||Am)||Am)||Am;i.ModuleContainer.registerSingleton(bm,Om),i.ModuleContainer.registerSingleton(mm.c,_m),i.ModuleContainer.registerSingleton(ym,zm),i.ModuleContainer.resolve(mm.c),i.ModuleContainer.resolveToken(Cm),i.ModuleContainer.resolveToken(Dm);s("rBRb");var xm,Vm=s("jbAT"),Hm=s("zLd2"),qm=s("5txd");Object(i.injectable)()(xm=Object(i.singleton)(Hm.c)(xm=function(e,t){return Object(i.inject)(Vm.b)(e,void 0,0)}(xm=function(e,t){return Object(i.inject)(B.ZLoggerFactory)(e,void 0,1)}(xm=Reflect.metadata("design:type",Function)(xm=Reflect.metadata("design:paramtypes",[void 0===Vm.a?Object:Vm.a,void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory])(xm=class{constructor(e,t){this._utilsMediaAppService=void 0,this._logger=void 0,this._log=void 0,this._utilsMediaAppService=e,Q.a.ConvInfoDataManager.addEventListener(Ys.b.DeleteConv,this._onDeleteConversation.bind(this)),Q.a.ConvInfoDataManager.addEventListener(Ys.b.EmptyConv,this._onEmptyConversation.bind(this)),this._logger=t.createZLogger(Hm.b,["manage-utils-media-in-ui"]),this._log=Object(qm.a)(this._logger)}create(e){return this._utilsMediaAppService.create(e)}createOrUpdate(e){return this._utilsMediaAppService.createOrUpdate(e)}async createOrUpdateFromMedias(e){return this._utilsMediaAppService.createOrUpdateFromMedias(e)}_onDeleteConversation(e){const{convId:t}=e;this._utilsMediaAppService.deleteUtilsMediasByConvId(t)}_onEmptyConversation(e){const{convId:t}=e;this._utilsMediaAppService.deleteUtilsMediasByConvId(t)}})||xm)||xm)||xm)||xm)||xm);s("37f1");var Wm,Zm=s("lT2C"),Km=s("C8zZ"),Qm=s("wmCV");let $m=Object(ie.b)(Km.GroupPollManager)(Wm=function(e,t){return i.ModuleContainer.inject(ze.b)(e,void 0,0)}(Wm=Reflect.metadata("design:type",Function)(Wm=Reflect.metadata("design:paramtypes",[void 0===ze.b?Object:ze.b])(Wm=class{constructor(e){this.convDataManager=e,this._Logger=void 0,this.pollCache=void 0,this.pollCache=new h.default({maxSize:1e4}),this.setUpEvent()}get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger(Ss.ZLoggerNametags.pollV3,[Ss.ZLoggerNametags.groupPollManager])),this._Logger}updatePollCache(e,t){this.pollCache.set(e,t)}removePollCacheBelongsToConv(e){Array.from(this.pollCache.entriesAscending()).forEach((([t,s])=>{s.group_id===A.default.getGroupIdFromConversationId(e)&&this.pollCache.delete(t)}))}setUpEvent(){this.convDataManager.addEventListener(Ys.b.DeleteConv,(e=>{this.removePollCacheBelongsToConv(e.convId)})),this.convDataManager.addEventListener(Ys.b.EmptyConv,(e=>{this.removePollCacheBelongsToConv(e.convId)})),this.convDataManager.addEventListener(Ys.b.LeaveGroup,(e=>{this.removePollCacheBelongsToConv(e.convId)}))}isAdmin(e,t){var s;const i=Fe.default.getGroupByIdSync(e);if(!i)return!1;if(t===i.creatorId)return!0;let a=!1;return null===(s=i.topMember)||void 0===s||s.forEach((e=>{e.id===t&&e.isAdmin&&(a=!0)})),a}isAllowSetTopic(e){var t;const s=Fe.default.getGroupByIdSync(e);return!!s&&!(!U.default.group_topics.enable||null!==(t=s.setting)&&void 0!==t&&t.setTopicOnly)}isEnablePin(e){return this.isAdmin(e,Z.default.getUidMe())||this.isAllowSetTopic(e)}isEnableClose(e,t){const s=Z.default.getUidMe();return this.isAdmin(e,s)||s===t}createPollRequestData(e){const{pollData:t,groupId:s,src:i}=e,a={question:t.question,options:t.options,expired_time:t.expiredTime,pinAct:t.pinAct,allow_multi_choices:t.allowMultiChoices,allow_add_new_option:t.allowAddNewOption,is_hide_vote_preview:t.isHideVotePreview,is_anonymous:t.isAnonymous,poll_type:t.pollType};return{groupId:A.default.getGroupIdFromConversationId(s),pollData:a,src:i}}async createPoll(e){const t=e.pollData.pinAct,{groupId:s,pollData:i,src:a}=this.createPollRequestData(e);try{const n=await Ni.default.createPoll(s,i,a);t&&this.pinPoll(n.poll_id,e.groupId,n.question)}catch(n){throw this.Logger.zsymb(18,"bGrMnn",n),n}}getPollDetailSync(e){return this.pollCache.get(e)}async getPollDetail(e,t){let s=this.getPollDetailSync(e);if(s)return s;if(s=await _t.default.getPollInfo(e),!s){if(t)return this.getPollDetailFromServer(e);throw Error("Poll isn't existed in DB")}return this.pollCache.set(e,s),s}async getPollDetailFromServer(e,t){const s=await Ni.default.getPollDetail(t,e,!1);if(!s)throw Error("Poll isn't existed in Server");return this.pollCache.set(e,s),s}async pinPoll(e,t,s){let i=s;if(!i){let t=this.getPollDetailSync(e);if(t||(t=await this.getPollDetail(e)),!t)throw Error("Poll isn't existed");i=t.question}Qm.a.pinFromBoard({userId:t},{poll_id:e,isPoll:!0,question:i},null,null,Zt.a.getWinIdByConvId(t))}unpinPoll(e,t){Qm.a.unpinFromBoard(t,{poll_id:e,isPoll:!0})}async lockPoll(e){const t=this.getPollDetailSync(e);if(!t||!t.closed)try{Ni.default.lockPoll(e)}catch(s){this.Logger.zsymb(18,"IkbnzX","[lockPoll] ",e,s)}}async sharePollInGroup(e){try{Ni.default.sharePoll(e)}catch(t){this.Logger.zsymb(18,"AVjdp6","[sharePollInGroup] ",e,t)}}async votePoll(e){const{newOptions:t,pollId:s,votedOptionIds:i}=e,a=A.default.getGroupIdFromConversationId(e.groupId);try{t.length>0?await Ni.default.addNewOptionPoll(a,s,JSON.stringify(t),i):await Ni.default.vote(a,s,i)}catch(n){throw this.Logger.zsymb(18,"BVywt1","[votePoll] ",n,s),n}}})||Wm)||Wm)||Wm)||Wm;var Ym,Jm=s("ILDi");let Xm=Object(ie.b)(Km.GroupPollInfoManager)(Ym=Reflect.metadata("design:type",Function)(Ym=Reflect.metadata("design:paramtypes",[])(Ym=class{constructor(){this.updateEmitter=void 0,this.viewedMoreFromMsgIds=void 0,this.updateEmitter=new Uc.a,this.viewedMoreFromMsgIds=new Set}getPollParams(e){let t=null;try{var s;t=JSON.parse(null==e||null===(s=e.message)||void 0===s?void 0:s.params)}catch(i){t={}}return t}getLastMessagePoll(e,t,s){let i=t;return s.forEach((s=>{s.msgType!==t.msgType||this.getPollParams(s).pollId!==e||(i=s)})),i}getContinuosPollInfoSection(e,t){const s=[];let i=0;return t.forEach((t=>{var a;t.msgType===W.MSG_POLL&&this.getPollParams(t).pollId===e?(s[i]||(s[i]=[]),s[i].push(t)):null!==(a=s[i])&&void 0!==a&&a[0]&&(i+=1)})),s.filter((e=>e.length>U.default.groupPoll.max_info_msg_display))}isShowPollCard(e,t,s){const i=this.getLastMessagePoll(e,t,s);return Va.b.isSameMsg(t,i)}getPollInfoShowStatus(e,t,s){const i=this.getContinuosPollInfoSection(e,s);for(const a of i)for(let e=a.length-1;e>=0;e--)if(Va.b.isSameMsg(t,a[e]))return e!==a.length-1?"HIDE":a[e-1]&&this.viewedMoreFromMsgIds.has(a[e-1].msgId)?"SHOW":"SHOW_VIEW_MORE";return"SHOW"}viewMore(e,t,s){let i=[];const a=this.getContinuosPollInfoSection(e,s);for(const n of a)if(n[n.length-1].msgId===t){i=n.map((e=>e.msgId));break}this.updateEmitter.emit("EXPAND_MSG_INFO",{msgIds:i}),this.viewedMoreFromMsgIds.add(t)}clearViewedMoreHistory(e){this.viewedMoreFromMsgIds.delete(e)}})||Ym)||Ym)||Ym;i.ModuleContainer.registerSingleton(Zm.a,$m),i.ModuleContainer.registerSingleton(Jm.a,Xm);var ep,tp,sp=s("qLo6");Object(m.f)()(ep=class{onAuthenticated(e){U.default.e2ee.enable_wasm&&sp.AesGcmWasmFactory.instance.installAndTestWasm().then((()=>{})).catch((e=>{}))}}),Object(m.f)()(tp=class{onAuthenticated(e){try{WebAssembly.validate(new Uint8Array([0,97,115,109,1,0,0,0,1,5,1,96,0,1,123,3,2,1,0,10,10,1,8,0,65,0,253,15,253,98,11]))?Si.default.increaseSuccess(97136,0,0):Si.default.increaseFailed(97136,0,0,0,0)}catch{Si.default.increaseFailed(97136,0,0,1,0)}}});var ip=s("3+ZU"),ap=s("MEZx");i.ModuleContainer.registerSingleton(ip.a,class{getDebugMenu(){return U.default.mediaStatus.debug.enable?{type:ap.MENU_ITEM_TYPE.SUBMENU,text:"Media Status",items:[{text:"Disable expired soon status",onclick:()=>{U.default.mediaStatus.enable_expired_soon=!U.default.mediaStatus.enable_expired_soon},checked:!U.default.mediaStatus.enable_expired_soon},{text:"Revert media status",onclick:()=>{U.default.mediaStatus.enable_media_status=!U.default.mediaStatus.enable_media_status},checked:!U.default.mediaStatus.enable_media_status},{text:"Disable view in folder for auto download",onclick:()=>{U.default.mediaStatus.enable_view_folder_option_for_auto_download=!U.default.mediaStatus.enable_view_folder_option_for_auto_download},checked:!U.default.mediaStatus.enable_view_folder_option_for_auto_download},{text:"Disable inview file download",onclick:()=>{U.default.mediaStatus.enable_file_inview_download=!U.default.mediaStatus.enable_file_inview_download},checked:!U.default.mediaStatus.enable_file_inview_download},{text:"Open Media Status Debugger Modal",onclick:()=>{const e=s("h0sc");e&&e.ModalManagerV2&&e.ModalManagerV2.openModal({windowId:"1",name:W.ModalIdentitiesDefine.MEDIA_STATUS_DEBUGGER,params:{show:!0}})}},{text:"Enable force expired photo",onclick:()=>{globalThis.__alwaysForcePhotoExpired=!globalThis.__alwaysForcePhotoExpired},checked:1==globalThis.__alwaysForcePhotoExpired},{text:"Enable force expired voice",onclick:()=>{globalThis.__alwaysForceVoiceExpired=!globalThis.__alwaysForceVoiceExpired},checked:1==globalThis.__alwaysForceVoiceExpired}]}:null}});var np,rp=s("tw7i");let op=Object(i.injectable)()(np=function(e,t){return Object(i.inject)(rp.e)(e,void 0,0)}(np=Reflect.metadata("design:type",Function)(np=Reflect.metadata("design:paramtypes",[Object])(np=class{constructor(e){this.queue=e}push(e,t,s){const i={convId:e,msgId:t,action:s};this.queue.push(i)}})||np)||np)||np)||np;class cp extends Error{constructor({message:e,name:t,options:s}){super(e),this.code=void 0,this.name=void 0,this.name=t,s&&s.code&&(this.code=s.code),s&&s.stack&&(this.stack=(new Error).stack),Object.setPrototypeOf(this,cp.prototype)}}var lp=(e,t)=>{const s={code:e.code,stack:t};return new cp({name:e.name,options:s,message:e.message})};const dp={name:"CANNOT_GET_MSG_FROM_DB",code:1,message:"Cannot get message from Message Core database"},hp={name:"QUEUE_TASK_EMPTY",code:2,message:"Action log info queue is empty"},up={name:"TASK_IS_RUNNING",code:3,message:"Media action log info queue has task is running"},gp={name:"TEMP_DISABLE_LOG_PHOTO_SUBTYPE_2",code:4,message:"Temporary disable actionlog info for photo in subType 2"};var mp=s("JJxn"),pp=s("tmLI"),fp=s("UQla"),vp=s("jjJf"),_p=s("eZ5W");function bp(e){return e===W.MSG_E2EE?mp.e.YES:mp.e.NO}function yp(e){return"0"!=e?mp.f.RECEIVER:mp.f.SENDER}var Ip=s("HPXo");class Sp{build(e,t){var s,i;const a={msg_type:mp.l[e.msg.msgType],entry_point:e.entryPoint,size:e.size,sent_time:e.msg.sendDttm,is_e2ee:bp(null===(s=e.msg)||void 0===s?void 0:s.e2eeStatus),is_sender:yp(null===(i=e.msg)||void 0===i?void 0:i.fromUid),conv_type:mp.j[e.convType],sync_source:mp.k[e.msg.src],is_zCloud:e.isZCloud,msg_id:e.msg.msgId};switch(null!=e&&e.groupSize&&(a.group_size=e.groupSize),t){case mp.p.MediaExpiredWhenAction:a.original_status=Ip.a.get(e.msg.msgId);break;case mp.p.MediaStatusInView:null!=e&&e.forceStatus?a.file_status=null==e?void 0:e.forceStatus:a.file_status=null==e?void 0:e.mediaStatus}return a}}class Cp{build(e,t){var s,i;const a={msg_type:mp.l[e.msg.msgType],entry_point:e.entryPoint,size:e.size,sent_time:e.msg.sendDttm,is_e2ee:bp(null===(s=e.msg)||void 0===s?void 0:s.e2eeStatus),is_sender:yp(null===(i=e.msg)||void 0===i?void 0:i.fromUid),conv_type:mp.j[e.convType],sync_source:mp.k[e.msg.src],is_zCloud:e.isZCloud};switch(null!=e&&e.groupSize&&(a.group_size=e.groupSize),t){case mp.p.MediaExpiredWhenAction:a.original_status=Ip.a.get(e.msg.msgId);break;case mp.p.MediaStatusInView:a.file_status=null==e?void 0:e.forceStatus}return a}}class Ep{build(e,t){var s,i;const a={msg_type:mp.l[e.msg.msgType],entry_point:e.entryPoint,size:e.size,sent_time:e.msg.sendDttm,is_e2ee:bp(null===(s=e.msg)||void 0===s?void 0:s.e2eeStatus),is_sender:yp(null===(i=e.msg)||void 0===i?void 0:i.fromUid),conv_type:mp.j[e.convType],sync_source:mp.k[e.msg.src],is_zCloud:e.isZCloud,msg_id:e.msg.msgId};switch(null!=e&&e.groupSize&&(a.group_size=e.groupSize),t){case mp.p.MediaExpiredWhenAction:a.original_status=Ip.a.get(e.msg.msgId);break;case mp.p.MediaStatusInView:a.file_status=e.mediaStatus}return a}}class Op{build(e,t){var s,i;const a={msg_type:mp.l[e.msg.msgType],entry_point:e.entryPoint,size:e.size,sent_time:e.msg.sendDttm,is_e2ee:bp(null===(s=e.msg)||void 0===s?void 0:s.e2eeStatus),is_sender:yp(null===(i=e.msg)||void 0===i?void 0:i.fromUid),conv_type:mp.j[e.convType],sync_source:mp.k[e.msg.src],is_zCloud:e.isZCloud,msg_id:e.msg.msgId};switch(null!=e&&e.groupSize&&(a.group_size=e.groupSize),t){case mp.p.MediaExpiredWhenAction:a.original_status=Ip.a.get(e.msg.msgId);break;case mp.p.MediaStatusInView:a.file_status=e.mediaStatus}return a}}class Tp{constructor(){this.msg=void 0,this.subType=void 0,this.entryPoint=void 0,this.convType=void 0,this.mediaStatus=void 0,this.forceStatus=void 0,this.isZCloud=void 0}withMessage(e){return this.msg=e,this}withSubType(e){return this.subType=e,this}withEntryPoint(e){return this.entryPoint=e,this}withStatus(e){return this.mediaStatus=e&&function(e){var t,s,i,a,n,r,o;let c="";var l,d,h,u,g,m;return null!==(t=e)&&void 0!==t&&t.isExpired&&(c=fp.s.Expired),null!==(s=e)&&void 0!==s&&s.isExpiredSoon&&(c=fp.s.ExpiredSoon),Object(vp.b)().isEnableViewPCloudFileStatus()&&null!==(i=e)&&void 0!==i&&i.personalCloud&&null!==(l=e)&&void 0!==l&&null!==(d=l.personalCloud)&&void 0!==d&&null!==(h=d.status)&&void 0!==h&&h.isUncloud&&e===fp.s.ExpiredSoon&&(e=fp.s.ExpiredSoon),Object(vp.b)().isEnableViewPCloudFileStatus()&&null!==(a=e)&&void 0!==a&&a.personalCloud&&null!==(u=e)&&void 0!==u&&null!==(g=u.personalCloud)&&void 0!==g&&null!==(m=g.status)&&void 0!==m&&m.isClouded&&(c=fp.q.CloudSaved),null!==(n=e)&&void 0!==n&&n.autoDownloadPath&&(c=fp.s.DownloadedAuto),(null!==(r=e)&&void 0!==r&&r.localPath||null!==(o=e)&&void 0!==o&&o.folderPath)&&(c=fp.s.DownloadedManual),c}(e),this}withForceStatus(e=""){return this.forceStatus=e,this}withZCloud(e=0){return this.isZCloud=e?1:0,this}build(){var e,t;const s=function(e){const t=Object(pp.n)(null==e?void 0:e.params)||"";return t?(null==t?void 0:t.fileSize)&&+t.fileSize/1024:-1}(this.msg.message),i=(null===(e=this.msg)||void 0===e?void 0:e.toUid)&&(a=null===(t=this.msg)||void 0===t?void 0:t.toUid,A.default.isOAType(Z.default.getProfileFriendSync(a))?mp.a.OA:A.default.getConversationType(a));var a;const n=i===mp.a.GROUP&&function(e){let t;const s=Fe.default.getGroupByIdSync(e);return null!=s&&s.topMember&&(null==s?void 0:s.topMember.length)>0&&(t=null==s?void 0:s.topMember.length),t}(this.msg.toUid),r=i===mp.a.CLOUD?function(e,t){let s=e;return e!==fp.q.DownloadedAuto&&e!==fp.q.DownloadedManual&&t<=_p.b.getCloudLimitBigFileInBytes()&&(s=fp.q.CloudSaved),s}(this.mediaStatus,s):this.mediaStatus;let o={};const c={msg:this.msg,size:s,isZCloud:this.isZCloud,mediaStatus:r,convType:i,forceStatus:this.forceStatus,entryPoint:this.entryPoint,groupSize:n};switch(this.msg.msgType){case W.MSG_PHOTO:case W.MSG_PHOTO_2:o=(new Cp).build(c,this.subType);break;case W.MSG_FILE:o=(new Sp).build(c,this.subType);break;case W.MSG_VIDEO:o=(new Ep).build(c,this.subType);break;case W.MSG_VOICE:o=(new Op).build(c,this.subType)}return o}}var Mp=class{verify(e){return!!e.file_status&&(!!Object.values(mp.e).includes(e.is_e2ee)&&(!!Object.values(mp.f).includes(e.is_sender)&&(!!Object.values(mp.f).includes(e.is_sender)&&(!!Object.values(mp.j).includes(e.conv_type)&&(!!Object.values(mp.k).includes(e.sync_source)&&!!Object.values(mp.l).includes(e.msg_type))))))}},Rp=s("a4lh"),wp=s("o1u6"),Lp=s("lJL2");const Fp=[W.MSG_FILE,W.MSG_VIDEO,W.MSG_VOICE],Dp=[W.MSG_PHOTO,W.MSG_PHOTO_2];var Ap;let Np=Object(i.injectable)()(Ap=function(e,t){return Object(i.inject)(rp.e)(e,void 0,0)}(Ap=function(e,t){return Object(i.inject)(B.ZLoggerFactory)(e,void 0,1)}(Ap=function(e,t){return Object(i.inject)(rp.b)(e,void 0,2)}(Ap=Reflect.metadata("design:type",Function)(Ap=Reflect.metadata("design:paramtypes",[Object,void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory,Object])(Ap=class{constructor(e,t,s){this.queue=e,this.mediaActionLogInfoCronToGroupData=s,this.logger=void 0,this.DB=void 0,this.isRunning=void 0,this.logger=t.createZLogger(Ss.ZLoggerNametags.mediaStatus,["action-log-consumer"]),this.DB=Vn.default.getInstance(),this.isRunning=!1}async run(){if(!(this.queue.length<=0)){if(this.isRunning)return lp(up);this.isRunning=!0,requestAnimationFrame((async()=>{try{const e=this.queue.pop();if(!e)return lp(hp);const t=e.msgId,s=e.action,i=e.convId,a=await this.DB.Core.Message.get(t,{partition:i});let n;if(!a)return lp(dp);if((a.msgType===W.MSG_PHOTO||a.msgType===W.MSG_PHOTO_2)&&!U.default.mediaStatus.actionLogInfo.enable_sub_type_2_for_photo&&s.subType===mp.p.MediaStatusInView)return gp;if(null==s||!s.forceStatus){let e=t;a.msgType!==W.MSG_FILE&&(e=a),n=Fp.includes(a.msgType)&&(Lp.a.get(t)||await wp.a.status(e,[]))}const r=(new Tp).withEntryPoint(s.entryPoint).withSubType(s.subType).withMessage(a).withStatus(n).withForceStatus((null==s?void 0:s.forceStatus)||"").withZCloud((null==s?void 0:s.isZCloud)||0).build();if((new Mp).verify(r))if(Dp.includes(a.msgType)){const e=Object(T.a)({},r);delete e.sent_time,delete e.size;const t=JSON.stringify(e);this.mediaActionLogInfoCronToGroupData.runCron({key:t,data:Object(T.a)(Object(T.a)({},r),{},{subType:s.subType})})}else Rp.a.LogActionInfo(s.subType,r)}catch(e){this.logger.zsymb(3,"mKbf4C",["error {}","I7Hj2K"],JSON.stringify(e))}finally{this.isRunning=!1,this.run()}}))}}})||Ap)||Ap)||Ap)||Ap)||Ap)||Ap;var kp;let Pp=Object(i.injectable)()(kp=function(e,t){return Object(i.inject)(rp.d)(e,void 0,0)}(kp=function(e,t){return Object(i.inject)(rp.a)(e,void 0,1)}(kp=Reflect.metadata("design:type",Function)(kp=Reflect.metadata("design:paramtypes",[Object,Object])(kp=class{constructor(e,t){this.producer=e,this.consumer=t}run(e,t,s){(s.subType!==mp.p.MediaExpiredWhenAction||U.default.mediaStatus.actionLogInfo.enable_sub_type_1)&&(s.subType!==mp.p.MediaStatusInView||U.default.mediaStatus.actionLogInfo.enable_sub_type_2)&&(this.producer.push(e,t,s),this.consumer.run())}})||kp)||kp)||kp)||kp)||kp;var jp=s("z97J");const Up=new class{constructor(e){this.lru=void 0,this.lru=new h.default({maxSize:e.maxSize()})}set(e,t){if(t)if(this.has(e)){const s=this.lru.get(e);s.sent_time=`${parseInt(s.sent_time)+parseInt(t.sent_time)}`,s.size&&t.size&&(s.size=`${parseInt(s.size)+parseInt(t.size)}`),++s.count,this.lru.set(e,s)}else this.lru.set(e,Object(T.a)(Object(T.a)({},t),{},{count:1}))}get(e){return this.lru.get(e)}has(e){return this.lru.has(e)}delete(e){return this.lru.delete(e)}getAll(){return[...this.lru.values()]}clear(){this.lru.clear()}}({maxSize:()=>U.default.maxSizeMemCacheMediaStatusPhotoActionLogInfo});i.ModuleContainer.registerSingleton(rp.e,class{constructor(){this.queue=void 0,this.queue=[]}push(e){this.queue.push(e)}pop(){return this.queue.pop()}get length(){return this.queue.length}}),i.ModuleContainer.registerSingleton(rp.d,op),i.ModuleContainer.registerSingleton(rp.b,class{constructor(){this.startCron=void 0,this.startCron=!1}setStart(){this.startCron||(this.startCron=!0)}isStartCron(){return this.startCron}runCron(e){const t=new jp.CronJob(U.default.mediaStatus.actionLogInfo.time_to_log_photo,(()=>{const e=Up.getAll();if(e.length){for(const s of e){var t;const e=s.subType;delete s.subType,s.sent_time=Math.round(s.sent_time/s.count),s.size=(null!==(t=s.size)&&void 0!==t?t:0)/s.count,Rp.a.LogActionInfo(e,s)}Up.clear()}}));this.isStartCron()?Up.set(e.key,e.data):(Up.set(e.key,e.data),t.start(),this.setStart())}}),i.ModuleContainer.registerSingleton(rp.a,Np),i.ModuleContainer.registerSingleton(rp.c,Pp);var Bp=s("imbw"),Gp=s("1EWQ");const zp=1,xp=2,Vp=3;let Hp=function(e){return e[e.TEXT=0]="TEXT",e[e.STICKER=1]="STICKER",e[e.PHOTO=2]="PHOTO",e[e.LINK=3]="LINK",e[e.FILE=4]="FILE",e[e.GIF=5]="GIF",e[e.CONTACT=6]="CONTACT",e}({}),qp=function(e){return e[e.CHAT_11=1]="CHAT_11",e[e.CHAT_GROUP=2]="CHAT_GROUP",e[e.MY_CLOUD=3]="MY_CLOUD",e}({}),Wp=function(e){return e[e.SINGLE=0]="SINGLE",e[e.GROUP=1]="GROUP",e}({}),Zp=function(e){return e[e.CONTEXT_MENU=0]="CONTEXT_MENU",e[e.BUBBLE=1]="BUBBLE",e}({}),Kp=function(e){return e[e.RESEND=1]="RESEND",e[e.DELETE=2]="DELETE",e}({}),Qp=function(e){return e[e.NO_RESEND=1]="NO_RESEND",e[e.RESEND_SINGLE=2]="RESEND_SINGLE",e[e.RESEND_ALL=3]="RESEND_ALL",e}({}),$p=function(e){return e[e.NO_DELETE=1]="NO_DELETE",e[e.DELETE_SINGLE=2]="DELETE_SINGLE",e[e.DELETE_ALL=3]="DELETE_ALL",e}({});var Yp;let Jp=Object(ie.b)(Bp.a)(Yp=Reflect.metadata("design:type",Function)(Yp=Reflect.metadata("design:paramtypes",[])(Yp=class{constructor(){this.lastNetworkBannerAppearTime=void 0,this.logger=void 0,this.lastNetworkBannerAppearTime=null}get Logger(){return this.logger||(this.logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger("auto-retry",["action-log"])),this.logger}logAction999(e){const{type:t,payload:s}=e;let i;switch(t){case"ShowManualRetry":i=zp;break;case"InteractManualRetry":i=xp;break;case"ShowBannerNetwork":i=Vp}fe.default.logActionInfoV2(fe.FeaturesInfo.AutoRetry,i,s)}getChatTypeFromConvId(e){return A.default.isGroup(e)?qp.CHAT_GROUP:Gp.a.isSendToMe(e)?qp.MY_CLOUD:qp.CHAT_11}getRetryMsgType(e){switch(e){case W.MSG_TEXT:return Hp.TEXT;case W.MSG_GIF:return Hp.GIF;case W.MSG_FILE:case W.MSG_VIDEO:return Hp.FILE;case W.MSG_PHOTO:case W.MSG_PHOTO_GROUP:return Hp.PHOTO;case W.MSG_CONTACT:return Hp.CONTACT;case W.MSG_STICKER:case W.MSG_STICKER_GROUP:case W.MSG_STICKER_2:return Hp.STICKER;case W.MSG_LINK_CLIENT:return Hp.LINK;default:return}}getMsgCombineType(e){return[W.MSG_PHOTO_GROUP,W.MSG_STICKER_GROUP].includes(e)?Wp.GROUP:Wp.SINGLE}showManualRetryReport(e){const t=this.getRetryMsgType(e.msgType);void 0!==t&&this.logAction999({type:"ShowManualRetry",payload:{msg_type:t,chat_type:this.getChatTypeFromConvId(e.conversationId),error_id:e.errorCode,is_groupping:this.getMsgCombineType(e.msgType)}})}networkBannerAppearCapture(){this.lastNetworkBannerAppearTime=D.default.getTimeNow()}networkBannerDisappearReport(){const e=D.default.getTimeNow();if(null===this.lastNetworkBannerAppearTime)return;const t=e-this.lastNetworkBannerAppearTime;t<=0||(this.logAction999({type:"ShowBannerNetwork",payload:{showed_time:this.lastNetworkBannerAppearTime,off_time:e,duration:t}}),this.lastNetworkBannerAppearTime=null)}resendErrorMessageReport(e){const t=this.getRetryMsgType(e.msgType);void 0!==t&&this.logAction999({type:"InteractManualRetry",payload:{msg_type:t,chat_type:this.getChatTypeFromConvId(e.conversationId),is_groupping:this.getMsgCombineType(e.msgType),is_entrypoint:Zp[e.source],is_resend:this.getMsgCombineType(e.msgType)===Wp.GROUP?Qp.RESEND_ALL:Qp.RESEND_SINGLE,is_deleted:$p.NO_DELETE,action_type:Kp.RESEND}})}deleteErrorMessageReport(e){const t=this.getRetryMsgType(e.msgType);void 0!==t&&this.logAction999({type:"InteractManualRetry",payload:{msg_type:t,chat_type:this.getChatTypeFromConvId(e.conversationId),is_groupping:this.getMsgCombineType(e.msgType),is_entrypoint:Zp[e.source],is_resend:Qp.NO_RESEND,is_deleted:this.getMsgCombineType(e.msgType)===Wp.GROUP?$p.DELETE_ALL:$p.DELETE_SINGLE,action_type:Kp.DELETE}})}})||Yp)||Yp)||Yp;i.ModuleContainer.registerSingleton(Bp.a,Jp);var Xp,ef=s("Z1oQ"),tf=s("QbTC"),sf=s("xtzN"),af=s("n32m"),nf=s("hKna");let rf=Object(ie.b)(af.RetryErrorController)(Xp=Reflect.metadata("design:type",Function)(Xp=Reflect.metadata("design:paramtypes",[])(Xp=class{constructor(){this.logger=void 0,this.errNetworkCounterMap=void 0,this.errNetworkCounterMap=new Map}get Logger(){return this.logger||(this.logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger(Ss.ZLoggerNametags.autoRetry,["retry-error-controller"])),this.logger}getErrNetworkRetryCount(e){if(!e)return 0;const t=this.errNetworkCounterMap.get(e);if(void 0!==t)return 0===t?(this.errNetworkCounterMap.delete(e),0):t;const s=U.default.retryConfig.max_err_network_retry_count;return this.errNetworkCounterMap.set(e,s),s}decreaseErrNetworkRetryCount(e){if(!e)return;const t=this.getErrNetworkRetryCount(e);t>0?this.errNetworkCounterMap.set(e,t-1):this.errNetworkCounterMap.delete(e)}deleteErrNetworkRetryCountItem(e){e&&this.errNetworkCounterMap.delete(e)}logRetryError(e,t){this.Logger.zsymb(18,"jvuabW",e,t)}shouldRetry(e,t,s){if(!e||nf.a.includes(e.code))return!1;if(!nf.c.includes(e.code))return!1;const i=nf.d.NO_NETWORK_ERROR_CODE.includes(e.code);if(i&&(!U.default.retry_err_no_network||Fn.b.getStateNetwork()!==Fn.a.CHECKING&&Fn.b.getStateNetwork()!==Fn.a.DISCONNECT))return!1;const a=this.getRetryErrorCodeGroupName(e.code);if(a&&this.getRetryErrorCodeMapping()[a].off)return!1;const n=i&&this.getErrNetworkRetryCount(s)>0;if(0===t.count&&!n)return!1;const r=this.getRetryTimeout(t);return!!(r&&D.default.getTimeNow()-t.timestamp<r)&&(t.count&&!i&&t.count--,i&&this.decreaseErrNetworkRetryCount(s),!0)}getRetryTimeout(e){let t=0;return U.default.retryConfig&&U.default.retryConfig.setting_feature&&e.timestamp&&e.timeout&&(e.timeout===W.RETRY_MSG_TIMEOUT_DEFAULT?t=U.default.retryConfig.time_retry_default:e.timeout===W.RETRY_MSG_TIMEOUT_LONG&&(t=U.default.retryConfig.time_retry_long)),t}getRetryErrorCodeGroupName(e){return Object.keys(nf.d).find((t=>nf.d[t].includes(e)))}getNoRetryErrorCodeGroupName(e){return Object.keys(nf.b).find((t=>nf.b[t].includes(e)))}getRetryErrorCodeMapping(){return U.default.retryConfig.retry_strategy&&"object"==typeof U.default.retryConfig.retry_strategy?Object.keys(U.default.retryConfig.retry_strategy).reduce(((e,t)=>(e[t.toUpperCase()]=U.default.retryConfig.retry_strategy[t],e)),{}):nf.e}})||Xp)||Xp)||Xp;var of,cf=s("yoj5"),lf=s("Qtro");let df=Object(ie.b)(tf.a)(of=Reflect.metadata("design:type",Function)(of=Reflect.metadata("design:paramtypes",[])(of=class{constructor(){this.logger=void 0,this.waitingSocketOpenQueue=void 0,this.retryCountMapping=void 0,this.isDoneOffline=void 0,this.handleWaitingConnectionRetry=()=>{const e=[...this.waitingSocketOpenQueue];this.waitingSocketOpenQueue=[];for(const t of e){const e=cf.getGapTime();window.requestIdleCallback((()=>{t()}),{timeout:e})}},this.unlockProcessOffline=()=>{this.isDoneOffline=!0,Nm.default.getSocketState()===nf.g.OPEN&&this.handleWaitingConnectionRetry()},this.waitingSocketOpenQueue=[],this.retryCountMapping=new Map,this.isDoneOffline=!1,N.default.subscribe(((e,t)=>{if(e===P.WebsocketActions.CONNECTION_STATE_CHANGE){const{state:e,prevState:s}=t;void 0!==s&&e===nf.g.OPEN&&this.isDoneOffline&&this.handleWaitingConnectionRetry()}})),Nm.default.getChatHandler().subcribe(lf.b.ON_DONE_OFFLINE,this.unlockProcessOffline)}get Logger(){return this.logger||(this.logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger("auto-retry-socket",["retry-error-controller"])),this.logger}getRetryTimeout(e){let t=0;return U.default.retryConfig&&U.default.retryConfig.setting_feature&&e.timestamp&&e.timeout&&(e.timeout===W.RETRY_MSG_TIMEOUT_DEFAULT?t=U.default.retryConfig.time_retry_default:e.timeout===W.RETRY_MSG_TIMEOUT_LONG&&(t=U.default.retryConfig.time_retry_long)),t}getErrorCode(e){let t=e.code;return e.code===nf.f.ERR_CONNECTION_TIMED_OUT&&Fn.b.getStateNetwork()!==Fn.a.CONNECTED&&(t=nf.f.ERR_NO_NETWORK),t}shouldRetry(e,t,s){if(!e||!t||!s||s.count<=0)return!1;let i=this.getErrorCode(e);if(i===nf.f.ERR_CONNECTION_TIMED_OUT||i===nf.f.ERR_SOCKET_CLOSED||i===nf.f.ERR_NO_NETWORK){var a;const e=null!==(a=this.retryCountMapping.get(t))&&void 0!==a?a:0;let n=U.default.retryConfig.max_retry_count;if(i===nf.f.ERR_SOCKET_CLOSED&&(n=U.default.retryConfig.max_err_network_retry_count),void 0!==e&&e<n){const e=this.getRetryTimeout(s);return!!(e&&D.default.getTimeNow()-s.timestamp<e)&&(s.count&&s.count--,!0)}return!1}return!1}pushToRetryQueue(e,t,s){const a=i.ModuleContainer.resolve(ef.a).getRetryErrorCodeMapping();this.logRetryError(e.code,s);const n=this.getErrorCode(e);if(n!==nf.f.ERR_CONNECTION_TIMED_OUT){var r;if(n===nf.f.ERR_SOCKET_CLOSED||n===nf.f.ERR_NO_NETWORK)return this.retryCountMapping.set(s,null!==(r=this.retryCountMapping.get(s))&&void 0!==r?r:1),void this.waitingSocketOpenQueue.push(t)}else{var o,c;const e=(null!==(o=this.retryCountMapping.get(s))&&void 0!==o?o:0)+1,i=(null!==(c=a.CONNECTION_TIMED_OUT_ERROR_CODE.delay)&&void 0!==c?c:3e4)*e+cf.getGapTime();setTimeout((()=>{this.retryCountMapping.set(s,e),t()}),i)}}logRetryError(e,t){this.Logger.zsymb(18,"dCar-f",e,t)}cleanUpItemQueue(e){this.retryCountMapping.delete(e)}})||of)||of)||of;i.ModuleContainer.registerSingleton(ef.a,rf),i.ModuleContainer.registerSingleton(tf.a,df),i.ModuleContainer.registerSingleton(sf.a,class{constructor(){this.waitingNetworkQueue=void 0,this.waitingCheckStatusQueue=void 0,this.waitingTimeout=void 0,this.onConnectionBack=()=>{const e=[...this.waitingNetworkQueue];this.waitingNetworkQueue=[];for(const t of e){const e=cf.getGapTime();window.requestIdleCallback((()=>{t()}),{timeout:e})}},this.clearWaitingStatusTimeout=()=>{null!==this.waitingTimeout&&(window.clearTimeout(this.waitingTimeout),this.waitingTimeout=null)},this.moveWaitingCheckStatusToWaitingConnection=()=>{this.clearWaitingStatusTimeout(),this.waitingNetworkQueue.push(...this.waitingCheckStatusQueue),this.waitingCheckStatusQueue=[]},this.processWaitingCheckStatus=()=>{this.clearWaitingStatusTimeout();const e=[...this.waitingCheckStatusQueue];this.waitingCheckStatusQueue=[];for(const t of e){const e=cf.getGapTime();window.requestIdleCallback((()=>{t()}),{timeout:e})}},this.waitingNetworkQueue=[],this.waitingCheckStatusQueue=[],this.waitingTimeout=null,ye.p.listenEvent(ye.k,(e=>{e===Fn.a.CONNECTED?(this.processWaitingCheckStatus(),this.onConnectionBack()):e===Fn.a.DISCONNECT&&this.moveWaitingCheckStatusToWaitingConnection()}))}pushToRetryQueue(e){Fn.b.getStateNetwork()===Fn.a.CONNECTED?(this.waitingCheckStatusQueue.push(e),null===this.waitingTimeout&&(this.waitingTimeout=window.setTimeout((()=>{this.waitingTimeout=null,this.processWaitingCheckStatus()}),U.default.retryConfig.max_waiting_check_status_time))):this.waitingNetworkQueue.push(e)}});class hf{static getMinNumberOfE2eeConvs(){var e;return null===(e=U.default.notify_missing_e2ee_message.conditions)||void 0===e?void 0:e.min_number_of_e2ee_convs}static isEnableEntryTransferFromE2ee(){return!0===U.default.notify_missing_e2ee_message.enable}}var uf;const gf=Object(i.define)("entries-transfer-metrics");let mf=Object(i.injectable)()(uf=class{receiveChangeDeviceOnE2eeConvsSignal(){this.logAction(2090211)}receiveOverqueueMsgSignal(){this.logAction(2090210)}logAction(e){fe.default.logAction(e)}logActionInfo(e){}})||uf;var pf;i.ModuleContainer.registerSingleton(gf,mf);Object(m.f)()(pf=Object(i.injectable)()(pf=Object(ie.b)(Po.b)(pf=function(e,t){return Object(i.inject)(gf)(e,void 0,0)}(pf=Reflect.metadata("design:type",Function)(pf=Reflect.metadata("design:paramtypes",[void 0===gf?Object:gf])(pf=class extends De.b{get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger(Ss.ZLoggerNametags.entriesTransferManager,[Ss.ZLoggerNametags.e2eeNotifyMissingMsg])),this._Logger}constructor(e){super(),this.name=void 0,this.syncSourceQueueForSuggestTransfer=void 0,this._missingMessageEventList=void 0,this._Logger=void 0,this.metricts=void 0,this.name=Po.a,this.syncSourceQueueForSuggestTransfer=[],this._missingMessageEventList=[],this.metricts=e}get missingMessageEventList(){return this._missingMessageEventList}enSyncSourceQueueForSuggestTransfer(e){this.syncSourceQueueForSuggestTransfer.includes(e)||this.syncSourceQueueForSuggestTransfer.push(e),this.Logger.zsymb(0,"WdwMvD","[enSyncSourceQueueForSuggestTransfer] Push entry transfer in queue: "+JSON.stringify(e))}isEmptySyncSourceQueueForSuggestTransfer(){return 0===this.syncSourceQueueForSuggestTransfer.length}deSyncSourceQueueForSuggestTransfer(){return this.syncSourceQueueForSuggestTransfer.shift()}detectEntryTransferFromE2ee(){const e=hf.isEnableEntryTransferFromE2ee();try{const t=ta.a.instance().getListUserE2ee();if(t&&t.length>=hf.getMinNumberOfE2eeConvs())return e&&(this.enSyncSourceQueueForSuggestTransfer(Io.j.E2EE_MISSING_MESSAGE),this.dispatchEvent(new lc.b(lc.a.NotifyE2eeConvChangeDevice))),this.dispatchEvent(new lc.b(lc.a.HasE2eeConvChangeDevice)),this.metricts.receiveChangeDeviceOnE2eeConvsSignal(),void this._missingMessageEventList.push(Io.j.E2EE_MISSING_MESSAGE);this.dispatchEvent(new lc.b(lc.a.NoE2eeConvChangeDevice))}catch(t){}}detectEntryTransferOverQueue(){const e=U.default.cross_setting.enableOverQueue;this._missingMessageEventList.push(Io.j.OVERFLOW),e&&(this.enSyncSourceQueueForSuggestTransfer(Io.j.OVERFLOW),this.dispatchEvent(new lc.b(lc.a.NotifyOverqueue))),this.metricts.receiveOverqueueMsgSignal()}handlePublicEvents(e){switch(e.type){case lc.a.NotifyE2eeSessionChange:{var t;const s=null===(t=e.payload)||void 0===t?void 0:t.hasChanged;this.Logger.zsymb(0,"7VdTnL",`[handlePublicEvents] Receive notify e2e session change. isE2eeKeyChanged ${s}`),s?(this.Logger.zsymb(0,"FpYAiF","[handlePublicEvents] Event change device"),this.detectEntryTransferFromE2ee()):this.dispatchEvent(new lc.b(lc.a.NoE2eeConvChangeDevice));break}}}handleEventShowSuggestion(){this.detectEntryTransferOverQueue(),this.Logger.zsymb(0,"JYr4Ex","")}addPublicListeners(){this.addEventListener(lc.a.NotifyE2eeSessionChange,this.handlePublicEvents.bind(this)),i.ModuleContainer.resolve(uc.AFMC_TModule).get(uc.AFMC_TController).addEventListener(hc.a.SHOW_SYNC_MESSAGE_SUGGESTION,this.handleEventShowSuggestion.bind(this))}onAuthenticated(e){this.addPublicListeners()}getSyncSource(){const e=this.deSyncSourceQueueForSuggestTransfer();return e&&this.Logger.zsymb(0,"ASRMK_","[getSyncSource] Get sync source in queue: "+JSON.stringify(e)),e}})||pf)||pf)||pf)||pf)||pf);var ff=s("dhS6"),vf=s("WzIS"),_f=s("sLvT");const bf=e=>new Promise(((t,s)=>{setTimeout((()=>{t(e||3e3)}),e||3e3)}));var yf;let If=Object(ie.b)(ff.a)(yf=Reflect.metadata("design:type",Function)(yf=Reflect.metadata("design:paramtypes",[])(yf=class{get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger(Ss.ZLoggerNametags.uiBannerController,[Ss.ZLoggerNametags.uiBannerQueue])),this._Logger}constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.queue=void 0,this.uiState=new Map,this.isFirtTriggerShowOnQueueCycle=void 0,this.timeoutNextBanner=void 0,this._Logger=void 0,this.name=ff.b,this.key="convId",this.queue=[],this.isFirtTriggerShowOnQueueCycle=!0,this.timeoutNextBanner=null}enBannerQueue(e,t){const s=this.queryBannerQueueItem(e.key);switch(s&&this.doRemoveBannerQueueItem(s.key),t){case vf.a.NORMAL:this.queue.push(e);break;case vf.a.HIGH:this.queue.unshift(e)}}isEmptySyncSourceQueue(){return 0===this.queue.length}deBannerQueue(){return this.queue.shift()}removeBannerQueueItem(e){this.queue=[...this.queue].filter((t=>t.key!==e))}doRemoveBannerQueueItem(e){this.removeBannerQueueItem(e),0===this.queue.length&&(this.isFirtTriggerShowOnQueueCycle=!0)}queryBannerQueueItem(e){return this.queue.find((t=>t.key===e))}handleShowUIBanner(e,t){Object(_f.b)().isEnableSingleUIBanner()?this.showSingleUI(e,t):this.showMultiUI(e,t)}isExistingShow(){try{const e=Object.fromEntries(this.uiState);for(const t in e)if(e[t])return t;return null}catch(e){return null}}async showSingleUI(e,t){let s;this.enBannerQueue({key:e,priority:t},t);const i=this.isExistingShow();if(i&&(s=this.queryBannerQueueItem(i)),Object(_f.b)().isEnableForceCloseNormalBanner()&&i&&t===vf.a.HIGH&&s)return this.uiState.set(s.key,!1),Object(Zs.g)(this.name,s.key),this.uiState.set(e,!0),void Object(Zs.g)(this.name,e);i||(this.uiState.set(e,!0),Object(Zs.g)(this.name,e),this.Logger.zsymb(0,"wf8OCH","[showSingleUI] Dont have displaying banner so show: "+e+", current queue = "+JSON.stringify(this.queue)))}showMultiUI(e,t){this.enBannerQueue({key:e,priority:t},t),this.uiState.set(e,!0),Object(Zs.g)(this.name,e)}handleHideUIBanner(e){Object(_f.b)().isEnableSingleUIBanner()?this.hideSingleUI(e):this.hideMultiUI(e)}hideSingleUI(e){this.doRemoveBannerQueueItem(e),this.uiState.get(e)&&(this.uiState.set(e,!1),Object(Zs.g)(this.name,e),this.timeoutNextBanner&&clearTimeout(this.timeoutNextBanner),this.timeoutNextBanner=setTimeout((()=>{const e=this.queue[0];e&&!this.isExistingShow()&&(this.uiState.set(e.key,!0),Object(Zs.g)(this.name,e.key),this.Logger.zsymb(0,"Um5ate","[hideSingleUI] Pop next banner to show: "+e.key+", current queue = "+JSON.stringify(this.queue)))}),Object(_f.b)().getTimeDelayOnNextBanner()))}hideMultiUI(e){this.doRemoveBannerQueueItem(e),this.uiState.set(e,!1),Object(Zs.g)(this.name,e)}async onShowBanner(e,t,s){s&&await bf(s);const i=Object(_f.b)().getTimeDelayOnStartApp();this.isFirtTriggerShowOnQueueCycle&&i?(await bf(i),this.handleShowUIBanner(e,t)):this.handleShowUIBanner(e,t),this.isFirtTriggerShowOnQueueCycle=!1}async onHideBanner(e,t){t&&await bf(t),this.handleHideUIBanner(e)}getBannerList(){return this.queue}init(e){throw new Error("Method not implemented.")}getItem(e,t){return this.uiState.get(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||yf)||yf)||yf;i.ModuleContainer.registerSingleton(ff.a,If);var Sf=s("kZZr"),Cf=s("VteK"),Ef=s("zNPY"),Of=s("UwMY"),Tf=s("YbKq"),Mf=s("85uQ"),Rf=s("Ilka"),wf=s("bWos"),Lf=s("/YHU");class Ff{constructor(e){var t,s,i,a,n,r;this.noiseId=void 0,this.zCloudKey=void 0,this.size=void 0,this.ts=void 0,this.extraInfo=void 0,this.message=void 0,this.isDuplicated=void 0,this.noiseId=e.noiseId,this.zCloudKey=wf.a.getZCloudKeyFromCloudItem(e),this.size=e.mediaInfo.mediaSize,this.ts=e.msgInfo.ts,this.isDuplicated=e.isDuplicated||!1;const o=(null==e||null===(t=e.msgInfo)||void 0===t?void 0:t.destId)==U.default.sendToMeId?null===(s=e.mediaInfo)||void 0===s||null===(i=s.mediaExtInfo)||void 0===i?void 0:i.data:null===(a=e.mediaInfo)||void 0===a||null===(n=a.mediaExtInfo)||void 0===n?void 0:n.decryptedData;if(o){const e=Object(Lf.a)(o);e&&(this.extraInfo={title:e.title,thumbUrl:e.thumbUrl,params:o})}const c=A.default.normalizeMessageType(e.msgInfo.msgType);var l;(this.message={cliMsgId:e.msgInfo.cliMsgId+"",fromUid:e.msgInfo.srcId+"",toUid:wf.a.getConversationIdFromCloudItem(e,_t.default.getUserId()),msgType:c,msgId:e.msgInfo.glbMsgId+"",isE2EE:!!e.msgInfo.isE2EE},null!==(r=this.extraInfo)&&void 0!==r&&r.thumbUrl)&&(this.message.message={thumbUrl:null===(l=this.extraInfo)||void 0===l?void 0:l.thumbUrl})}static transfer(e){const t=new Ff(e);return Object.assign({},t)}}var Df,Af=s("JP/W"),Nf=s("na98"),kf=s("Qf4l"),Pf=s("lGS6"),jf=s("iA9X"),Uf=s("4LiO"),Bf=s("oG6Z");const Gf="cloud",zf={verifyQueueDone:!1,cloudItems:null,displayData:null,selectedItems:{},lastClickSelectItem:null,currentFilter:Tf.e.ALL,currentSort:Tf.g.SIZE_DESCENDING,status:null,cloud:{total:0,usageServer:null,myCloudUsage:null,myCloudAllTypesUsage:null,used:{all:0,photo:0,video:0,file:0,voice:0},plan:-1,remove_ts:0,service_usage:{cloud_media:0,message_backup:0,my_cloud:0}},fetching:!1,fetchLimit:null,hasMore:!1,lastItemInfo:null,queryError:null};Object(i.injectable)()(Df=Object(i.singleton)(Sf.b)(Df=Object(ie.b)(Sf.b)(Df=function(e,t){return Object(i.inject)(Ef.a)(e,void 0,0)}(Df=function(e,t){return Object(i.inject)(Ef.b)(e,void 0,1)}(Df=Reflect.metadata("design:type",Function)(Df=Reflect.metadata("design:paramtypes",[void 0===Ef.a?Object:Ef.a,void 0===Ef.b?Object:Ef.b])(Df=class extends Pt{constructor(e,t){super(),this.zCloudConversationController=e,this.zCloudSideBarController=t,this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this.cloudViewItems=void 0,this.name=Sf.a,this.key=Sf.a,this.data.set(Gf,zf),this.cloudViewItems=null}_getState(e=Gf){return this.data.get(e)}async _sort(e){this.updateItem((t=>{t.currentSort=e}),Gf)}_filter(e){try{this.updateItem((t=>{t.currentFilter=e}),Gf)}catch(t){}}_getCurrentSort(){const{currentSort:e}=this._getState();return e}get isInZCloudScope(){if(!Object(vp.b)().isEnableUserPCloud())return!1;return[kf.b.MEDIA_TYPE,kf.b.CONVERSATION,kf.b.MY_CLOUD].includes(this.zCloudSideBarController.getCurrentView())}_getSettledUsage(e,t){return t?"fulfilled"===e.status&&e.value[t]?e.value[t]:0:"fulfilled"===e.status&&null!==(s=e.value)&&void 0!==s?s:0;var s}async _getAllCloudTypeUsage(e){try{const t=Of.a.map((t=>Cf.a.getCloudUsageByType(t,e||"")));return t.push(Cf.a.getCloudUsage()),await Promise.allSettled(t)}catch(t){throw t}}_getCloudInfoFromUsage(e){var t,s;if(!e)return null;const[i,a,n,r,o,c,l]=e,d={used:{photo:this._getSettledUsage(i)+this._getSettledUsage(a)+this._getSettledUsage(n),video:this._getSettledUsage(r),file:this._getSettledUsage(o),voice:this._getSettledUsage(c)},total:this._getSettledUsage(l,"quota")||0},h=this._getSettledUsage(l,"usage"),u=this._getSettledUsage(l,"plan"),g=this._getSettledUsage(l,"abuse_info"),m=this._getSettledUsage(l,"service_usage");d.used.all=d.used.photo+d.used.video+d.used.file+d.used.voice,d.usageServer=h,d.plan=u,d.remove_ts=null!=g&&g.remove_ts?g.remove_ts:0;const p=(null===(t=this._getState())||void 0===t||null===(s=t.cloud)||void 0===s?void 0:s.myCloudUsage)||0,f={message_backup:(null==m?void 0:m.message_backup)||0,my_cloud:p,cloud_media:h-p-((null==m?void 0:m.message_backup)||0)};return d.service_usage=f,d}async _getCloudUsage(e){try{const{cloud:r}=this._getState(),o=await this._getAllCloudTypeUsage(e);((...e)=>{Object(Af.a)("[cloud-item-list-controller]",...e)})("usageResult: ",o);const c=this._getCloudInfoFromUsage(o);if(!c||null==c||!c.used)return;if(e)return void this.updateItem((e=>{e.cloud=Object(T.a)(Object(T.a)({},e.cloud),c)}),Gf);const l=e=>"number"==typeof e&&e>=0?e:0;var t,s,i,a,n;if(null!=r&&r.myCloudAllTypesUsage)c.used.all=l(c.used.all-r.myCloudAllTypesUsage.total),c.used.photo=l(c.used.photo-((null===(t=r.myCloudAllTypesUsage.type)||void 0===t?void 0:t[W.MSG_PHOTO])||0)-((null===(s=r.myCloudAllTypesUsage.type)||void 0===s?void 0:s[W.MSG_PHOTO_2])||0)),c.used.video=l(c.used.video-((null===(i=r.myCloudAllTypesUsage.type)||void 0===i?void 0:i[W.MSG_VIDEO])||0)),c.used.file=l(c.used.file-((null===(a=r.myCloudAllTypesUsage.type)||void 0===a?void 0:a[W.MSG_FILE])||0)),c.used.voice=l(c.used.voice-((null===(n=r.myCloudAllTypesUsage.type)||void 0===n?void 0:n[W.MSG_VOICE])||0));this.updateItem((e=>{e.cloud=Object(T.a)(Object(T.a)({},e.cloud),c)}),Gf)}catch(r){throw Error(r)}}_calculateStatusFromUsage(){let e=Mf.a.NORMAL;const t=this._getState(),s=(null==t?void 0:t.cloud)||{},i=(null==s?void 0:s.total)||0,a=(null==s?void 0:s.usageServer)||0;if(i&&a){const t=i-a,n=Object(Rf.m)(),r=Object(Rf.j)();a>n&&(e=Mf.a.NEARY_FULL),t>0&&t<=r&&(e=Mf.a.ALMOST_FULL),t<=0&&(e=null!=s&&s.remove_ts?Mf.a.DELETE_SOON:Mf.a.FULL)}return e}_getCurrentCloudStatus(){const e=this._calculateStatusFromUsage();this.updateItem((t=>{t.status=e}),Gf)}_isInCloudViewItems(e){if(!Array.isArray(this.cloudViewItems))return!1;const t=wf.a.getZCloudKeyFromQueryItem(e);return!!this.cloudViewItems.find((e=>e.zCloudKey===t))}isSortedBySize(e){return[Tf.g.SIZE_ASCENDING,Tf.g.SIZE_DESCENDING].includes(e)}isSortedByTime(e){return[Tf.g.TIME_ASCENDING,Tf.g.TIME_DESCENDING].includes(e)}getMappingTypeFromFilter(e){switch(e){case Tf.e.ALL:return[W.MSG_PHOTO,W.MSG_PHOTO_2,W.MSG_DOODLE,W.MSG_VIDEO,W.MSG_FILE,W.MSG_VOICE];case Tf.e.PHOTO:return[W.MSG_PHOTO,W.MSG_PHOTO_2,W.MSG_DOODLE];case Tf.e.VIDEO:return[W.MSG_VIDEO];case Tf.e.FILE:return[W.MSG_FILE];case Tf.e.VOICE:return[W.MSG_VOICE]}}isSameFilterType(e){const{currentFilter:t}=this._getState(),s=this.getMappingTypeFromFilter(t),i=A.default.normalizeMessageType(e.msgInfo.msgType);return s&&Array.isArray(s)&&s.includes(i)}getConsideredItems(e){if(!e||!Array.isArray(e))return null;let t=[...e];this.zCloudSideBarController.getCurrentView()!==kf.b.MY_CLOUD&&(t=t.filter((e=>e.zConv!==U.default.sendToMeId)));const s=this.zCloudConversationController.getCurrentSelectedConvId();return s&&(t=t.filter((e=>e.zConv===s))),t=t.filter((e=>!Le.a.isThreadHidden(e.zConv))),t=t.filter((e=>this.isSameFilterType(e))),t}checkIsInRange(e,t,s){return e>=t&&e<=s}addCloudItemSizeDescending(e){const{viewPortItemInfo:t,displayData:s}=this._getState();if(!s||!Array.isArray(s))return;let i;if(0===s.length)i=e;else{const a=s[0].size,n=s[s.length-1].size;i=e.filter((e=>{const s=e.size;return!!this.checkIsInRange(s,n,a)||(s>a||!!(null!=t&&t.isStopIndex&&s<n))}))}if(!i||!Array.isArray(i)||0===i.length)return;const a=[...s,...i].sort(((e,t)=>{const s=e.size;return t.size-s}));this.updateItem((e=>{e.displayData=a}),Gf)}addCloudItemSizeAscending(e){const{viewPortItemInfo:t,displayData:s}=this._getState();if(!s||!Array.isArray(s))return;let i;if(0===s.length)i=e;else{const a=s[0].size,n=s[s.length-1].size;i=e.filter((e=>{const s=e.size;return!!this.checkIsInRange(s,a,n)||(s<a||!!(null!=t&&t.isStopIndex&&s>n))}))}if(!i||!Array.isArray(i)||0===i.length)return;const a=[...s,...i].sort(((e,t)=>{const s=e.size;return-(t.size-s)}));this.updateItem((e=>{e.displayData=a}),Gf)}addCloudItemTimeDescending(e){const{viewPortItemInfo:t,displayData:s}=this._getState();if(!s||!Array.isArray(s))return;let i;if(0===s.length)i=e;else{const a=s[0].ts,n=s[s.length-1].ts;i=e.filter((e=>{const s=e.ts;return!!this.checkIsInRange(s,n,a)||(s>a||!!(null!=t&&t.isStopIndex&&s<n))}))}if(!i||!Array.isArray(i)||0===i.length)return;const a=[...s,...i].sort(((e,t)=>{const s=e.ts;return t.ts-s}));this.updateItem((e=>{e.displayData=a}),Gf)}addCloudItemTimeAscending(e){const{viewPortItemInfo:t,displayData:s}=this._getState();if(!s||!Array.isArray(s))return;let i;if(0===s.length)i=e;else{const a=s[0].ts,n=s[s.length-1].ts;i=e.filter((e=>{const s=e.ts;return!!this.checkIsInRange(s,a,n)||(s<a||!!(null!=t&&t.isStopIndex&&s>n))}))}if(!i||!Array.isArray(i)||0===i.length)return;const a=[...s,...i].sort(((e,t)=>{const s=e.ts;return-(t.ts-s)}));this.updateItem((e=>{e.displayData=a}),Gf)}filter(e){this._filter(e)}sort(e){this._sort(e)}getCurrentFilter(){const{currentFilter:e}=this._getState();return e}async getCloudUsage(e){await this.getOnlyMyCloudUsageClient(),this.isInZCloudScope&&await this.getMyCloudAllTypesUsageByClient();const t=this.zCloudConversationController.getCurrentSelectedConvId();await this._getCloudUsage(null!=e?e:t),this._getCurrentCloudStatus()}async getMyCloudAllTypesUsageByClient(){try{var e;const t=await Cf.a.getClientUsage();if(null==t||null===(e=t.usageByConversation)||void 0===e||!e[U.default.sendToMeId+""])return;this.updateItem((e=>{e.cloud.myCloudAllTypesUsage=t.usageByConversation[U.default.sendToMeId+""]}),Gf)}catch(t){throw t}}setVerifyQueueDone(e){this.updateItem((t=>{t.verifyQueueDone=e}),Gf)}setViewPortItemInfo(e){this.updateItem((t=>{t.viewPortItemInfo=e}),Gf)}async addCloudItems(e){const{currentSort:t}=this._getState();let s=this.getConsideredItems(e);if(!s||!Array.isArray(s))return;Object(vp.b)().isEnableSubmitExtraInfoEntry("view_on_quota_tool")&&Cf.a.updateExtMediaInfo(s),i.ModuleContainer.resolve(vp.c).calculateZCloudStatusByCloudItems(s);const a=s.map((e=>Ff.transfer(e)));t===Tf.g.SIZE_DESCENDING?this.addCloudItemSizeDescending(a):t===Tf.g.SIZE_ASCENDING?this.addCloudItemSizeAscending(a):t===Tf.g.TIME_DESCENDING?this.addCloudItemTimeDescending(a):t===Tf.g.TIME_ASCENDING&&this.addCloudItemTimeAscending(a)}updateCloudItems(e){const{displayData:t}=this._getState();if(!t||!Array.isArray(t))return;const s=this.getConsideredItems(e);if(!s||!Array.isArray(s))return;const i=t.flatMap((t=>{const i=s.findIndex((e=>wf.a.getZCloudKeyFromCloudItem(e)===t.zCloudKey));return-1===i?t:Ff.transfer(e[i])}));i&&Array.isArray(i)&&this.updateItem((e=>{e.displayData=i}),Gf)}removeCloudItems(e){if(!e||!Array.isArray(e))return;const{displayData:t}=this._getState();if(!t||!Array.isArray(t))return;const s=e;Object(Af.b)("removeCloudItems | displayData before remove: ",t);const i=t.filter((e=>!s.includes(e.zCloudKey)));this.updateItem((e=>{e.displayData=i}),Gf),Object(Af.b)("removeCloudItems | displayData after remove: ",t)}async getOnlyMyCloudUsageClient(){try{const e=await Cf.a.getCloudUsageByConversation(U.default.sendToMeId);this.updateItem((t=>{t.cloud.myCloudUsage=e}),Gf)}catch(e){throw Error(e)}}getCurrentQueryIdentity(){const e=this.zCloudSideBarController.getCurrentView(),{currentFilter:t,currentSort:s}=this._getState();return`${e||e+""}_${t}_${s}`}async getAllByTypeSizeOrDate(e,t,s,i,a=!0){try{const{currentSort:n,currentFilter:r,lastItemInfo:o}=this._getState(),c=r===Tf.e.ALL;let l=null;switch(n){case Tf.g.SIZE_DESCENDING:l=c?await Cf.a.getAllByTypeSize("",a?Nf.c:t,s,i,Yt.CursorDirection.PREV,o?o.offset:0):await Cf.a.getAllByTypesSize(e,a?Nf.c:t,s,i,Yt.CursorDirection.PREV,o?o.offset:0);break;case Tf.g.SIZE_ASCENDING:l=c?await Cf.a.getAllByTypeSize("",t,s,i,Yt.CursorDirection.NEXT,o?o.offset:0):await Cf.a.getAllByTypesSize(e,t,s,i,Yt.CursorDirection.NEXT,o?o.offset:0);break;case Tf.g.TIME_DESCENDING:l=c?await Cf.a.getAllByTypeDate("",a?Nf.b:t,s,i,Yt.CursorDirection.PREV,o?o.offset:0):await Cf.a.getAllByTypesDate(e,a?Nf.b:t,s,i,Yt.CursorDirection.PREV,o?o.offset:0);break;case Tf.g.TIME_ASCENDING:l=c?await Cf.a.getAllByTypeDate("",t,s,i,Yt.CursorDirection.NEXT,o?o.offset:0):await Cf.a.getAllByTypesDate(e,t,s,i,Yt.CursorDirection.NEXT,o?o.offset:0);break;default:l=null}return{result:l,identity:this.getCurrentQueryIdentity()}}catch(n){throw{error:n,identity:this.getCurrentQueryIdentity()}}}async getAllConvByTypeSizeOrDate(e,t,s,i,a,n=!0){try{const{currentFilter:r,currentSort:o,lastItemInfo:c}=this._getState(),l=r===Tf.e.ALL;let d=null;switch(o){case Tf.g.SIZE_DESCENDING:d=l?await Cf.a.getAllByConversationTypeSize(e,"",n?Nf.c:s,i,a,Yt.CursorDirection.PREV,c?c.offset:0):await Cf.a.getAllByConversationTypesSize(e,t,n?Nf.c:s,i,a,Yt.CursorDirection.PREV,c?c.offset:0);break;case Tf.g.SIZE_ASCENDING:d=l?await Cf.a.getAllByConversationTypeSize(e,"",s,i,a,Yt.CursorDirection.NEXT,c?c.offset:0):await Cf.a.getAllByConversationTypesSize(e,t,s,i,a,Yt.CursorDirection.NEXT,c?c.offset:0);break;case Tf.g.TIME_DESCENDING:d=l?await Cf.a.getAllByConversationTypeDate(e,"",n?Nf.b:s,i,a,Yt.CursorDirection.PREV,c?c.offset:0):await Cf.a.getAllByConversationTypesDate(e,t,n?Nf.b:s,i,a,Yt.CursorDirection.PREV,c?c.offset:0);break;case Tf.g.TIME_ASCENDING:d=l?await Cf.a.getAllByConversationTypeDate(e,"",s,i,a,Yt.CursorDirection.NEXT,c?c.offset:0):await Cf.a.getAllByConversationTypesDate(e,t,s,i,a,Yt.CursorDirection.NEXT,c?c.offset:0);break;default:d=null}return{result:d,identity:this.getCurrentQueryIdentity()}}catch(r){throw{error:r,identity:this.getCurrentQueryIdentity()}}}updateLastItemInfo(e,t){if(!e)return;const s=this._getCurrentSort();this.updateItem((i=>{i.lastItemInfo={type:e.zType,sizeOrDate:this.isSortedBySize(s)?e.zSize:e.zDate,noiseId:e.noiseId,offset:t}}),Gf)}setLastItemFromQueryData(e){if(!e||!Array.isArray(e))return;const t=e[e.length-1];Object(Af.b)("currLastItem: ",t);const{lastItemInfo:s}=this._getState();(null==t?void 0:t.noiseId)!==(null==s?void 0:s.noiseId)&&this.updateLastItemInfo(t,((null==s?void 0:s.offset)||0)+e.length)}checkHasMoreCloudMedia(e,t){return e&&Array.isArray(e)&&e.length>=t}setHasMoreFromQueryData(e,t){if(!e||!Array.isArray(e))return;const s=this.checkHasMoreCloudMedia(e,t);Object(Af.b)("hasMore: ",s),this.updateItem((e=>{e.hasMore=s}),Gf)}filterNonMyCloudMediaItem(e){return e&&Array.isArray(e)?e.filter((e=>e.zConv!==U.default.sendToMeId)):null}filterInvalidCloudItems(e){if(!e||!Array.isArray(e))return null;let t;t=e.filter((e=>!Le.a.isThreadHidden(e.zConv)));return this.zCloudSideBarController.getCurrentView()!==kf.b.MY_CLOUD&&(t=this.filterNonMyCloudMediaItem(t)),t}setDisplayDataFromQueryData(e,t,s){if(!e||!Array.isArray(e))return;const i=e,{displayData:a}=this._getState();!t&&a&&Array.isArray(a)?this.updateItem((e=>{e.displayData=[...a,...i]}),Gf):this.updateItem((e=>{e.displayData=i}),Gf)}filterDuplicatedItems(e){if(!e||e.length<=0)return e;let t={},s=[];for(let i=0;i<e.length;i++){let a=e[i];if(!a)continue;let{zKey:n}=a;if(n)if(t.hasOwnProperty(n)){let{index:e}=t[n],{actionType:i}=a;Object(jf.b)("found dup item",n,a,e),i===Of.c.add_new?s.splice(e,1,Object(T.a)(Object(T.a)({},a),{},{isDuplicated:!0})):s[e].isDuplicated=!0}else s.push(a),t[n]=Object(T.a)(Object(T.a)({},a),{},{index:s.length-1})}return s}async fetchAllCloudMedia(e,t,s,a,n,r=!1,o=-1){try{var c;const l=this.zCloudSideBarController.getCurrentView();this.updateItem((e=>{e.fetching=!0,e.fetchLimit=n,e.queryError=null,r&&(e.selectedItems={}),a||(e.lastItemInfo=null)}),Gf);let d=null;if(l===kf.b.MEDIA_TYPE?d=await this.getAllByTypeSizeOrDate(t,s,a,n,r):l===kf.b.CONVERSATION?d=await this.getAllConvByTypeSizeOrDate(e+"",t,s,a,n,r):l===kf.b.MY_CLOUD&&(d=await this.getAllConvByTypeSizeOrDate(U.default.sendToMeId+"",t,s,a,n,r)),Object(Af.b)("fetchAllCloudMedia | data from db: ",d),!d)return void this.updateItem((e=>{e.fetching=!1}),Gf);let{result:h,identity:u}=d;if(!h||!Array.isArray(h))return void this.updateItem((e=>{e.fetching=!1}),Gf);if(this.setHasMoreFromQueryData(h,n),this.setLastItemFromQueryData(h),h=this.filterInvalidCloudItems(h),l!==kf.b.CONVERSATION&&(h=this.filterDuplicatedItems(h)),!h||!Array.isArray(h))return void this.updateItem((e=>{e.fetching=!1}),Gf);Object(vp.b)().isEnableSubmitExtraInfoEntry("view_on_quota_tool")&&Cf.a.updateExtMediaInfo(h),i.ModuleContainer.resolve(vp.c).calculateZCloudStatusByCloudItems(h);const g=h.map((e=>Ff.transfer(e)));this.setDisplayDataFromQueryData(g,r,u),-1==o?o=g.length:o+=g.length,null!==(c=this._getState())&&void 0!==c&&c.hasMore&&o<n?this.handleFetchMore(n,o):this.updateItem((e=>{e.fetching=!1}),Gf)}catch(l){this.updateItem((e=>{e.fetching=!1,r&&(e.queryError=l)}),Gf)}}forceGetCloudMedia(){const{currentFilter:e,fetchLimit:t}=this._getState(),s=this.zCloudConversationController.getCurrentSelectedConvId();if(!e||null===s||!t)return;const i=Pf.a.getCurrentMappingQueryType(e);this.fetchAllCloudMedia(s,i,0,"",t,!0)}handleFetchMore(e,t=-1){const{currentFilter:s,lastItemInfo:i,hasMore:a,fetching:n}=this._getState(),r=Pf.a.getCurrentMappingQueryType(s),o=this.zCloudConversationController.getCurrentSelectedConvId();Object(Af.b)("call fetch more... ",i),n&&-1===t||!i||!a||this.fetchAllCloudMedia(o,r,i.sizeOrDate,i.noiseId,e,!1,t)}isSelectedAll(){const{displayData:e,selectedItems:t}=this._getState();return Object.keys(t).length===(null==e?void 0:e.length)}handleSelectAll(){const{displayData:e,selectedItems:t}=this._getState();if(!e)return;const s=Object(T.a)({},t);e.forEach((e=>{const t=e.zCloudKey;s[t]||(s[t]=e)})),this.updateItem((e=>{e.selectedItems=s}),Gf)}handleDeselectAll(){this.resetSelectedItem()}handleToggleSelectAll(){this.isSelectedAll()?this.handleDeselectAll():this.handleSelectAll()}handleSelectItem(e){const{selectedItems:t,currentFilter:s}=this._getState(),i=Object(T.a)({},t);let a;const n=e.zCloudKey;if(i[n])delete i[n],a=null,Object(vp.b)().isEnableUserPCloud()&&Uf.a.logClickUncheckItem({unselect_type:"single_unselect"});else{var r;if((null===(r=Object.keys(i))||void 0===r?void 0:r.length)>U.default.max_msg_per_del-1)return void ai.a.createSuccess(ni.default.trans("STR_MY_CLOUD_MAX_SELECTED_ITEMS",[U.default.max_msg_per_del.toString()]));if(i[n]=e,a=e,Object(vp.b)().isEnableUserPCloud()){var o;const{extension:t}=Object(Bf.b)((null==e||null===(o=e.extraInfo)||void 0===o?void 0:o.title)||"");Uf.a.logClickCheckItem({tab_filter:s,file_extension:t,file_size:e.size})}}this.updateItem((e=>{e.selectedItems=i,e.lastClickSelectItem=a}),Gf)}resetSelectedItem(){this.updateItem((e=>{e.selectedItems={}}),Gf)}resetAllStates(){this.data.set(Gf,zf),Object(Zs.g)(this.name,Gf)}init(e){throw new Error("Method not implemented.")}getItem(e,t){return this._getState(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||Df)||Df)||Df)||Df)||Df)||Df);var xf,Vf=s("tP1L"),Hf=s("9XoL"),qf=s("bO3J"),Wf=s("cCVI"),Zf=s("k+eZ"),Kf=s("CBkG");const Qf="1",$f="zcloud-promo",Yf={showPromoTooltip:!1,showPromoPopover:!1,showTip:!1,showEntry:!1};Object(i.injectable)()(xf=Object(i.singleton)(Zf.b)(xf=Object(ie.b)(Zf.b)(xf=function(e,t){return Object(i.inject)(Hf.b)(e,void 0,0)}(xf=function(e,t){return Object(i.inject)(Wf.a)(e,void 0,1)}(xf=function(e,t){return Object(i.inject)(Ks.SidebarController)(e,void 0,2)}(xf=Reflect.metadata("design:type",Function)(xf=Reflect.metadata("design:paramtypes",[void 0===Hf.b?Object:Hf.b,void 0===Wf.a?Object:Wf.a,void 0===Ks.SidebarController?Object:Ks.SidebarController])(xf=class extends Pt{constructor(e,t,s){super(),this.eventsResolver=e,this.onboardEventsResolver=t,this.sidebarController=s,this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this.name=Zf.a,this.key=Zf.a,this.data.set(Qf,Yf),this.blockOnboardingHandler=this.blockOnboardingHandler.bind(this),this.triggerOnboardingHandler=this.triggerOnboardingHandler.bind(this),this.pcDoneOnboardingHandler=this.pcDoneOnboardingHandler.bind(this),this.offPlanHandler=this.offPlanHandler.bind(this),this.upgradePlanHandler=this.upgradePlanHandler.bind(this),this.receiveKeyHandler=this.receiveKeyHandler.bind(this)}save(){n.default.getInstance().setItemForCurrentUser($f,JSON.stringify(this.getState()))}load(){let e=n.default.getInstance().getItemForCurrentUser($f);e&&this.data.set(Qf,JSON.parse(e))}getLocal(){let e=n.default.getInstance().getItemForCurrentUser($f);return e?JSON.parse(e):void 0}getState(e=Qf){return this.data.get(e)}blockOnboardingHandler(e){this.updateItem((e=>{e.showEntry=!1,e.showTip=!1}),Qf),this.save()}triggerOnboardingHandler(e){if(Object(Af.a)("trigger onboarding event: ",e),e.type===qf.b.MOBILE_COMPLETED_BEFORE)this.updateItem((e=>{e.showEntry=!0,e.showTip=!0}),Qf),this.save()}pcDoneOnboardingHandler(e){this.updateItem((e=>{e.showEntry=!0,e.showTip=!1}),Qf),this.save()}offPlanHandler(e){Object(Af.a)("off plan | current: FREE"),this.sidebarController.changeTab(Ks.SidebarTab.MESSAGE_TAB),this.sidebarController.updateSelectedId(null),this.removeSubmitOnboaringDoneKey(),this.updateItem((e=>{e.showEntry=!1,e.showTip=!1,e.showPromoTooltip=Object(vp.b)().isEnablePromoTooltip()&&Object(vp.b)().isInFreePlan(),e.showPromoPopover=Object(vp.b)().isEnablePromoPopover()&&Object(vp.b)().isInFreePlan()}),Qf),this.save()}upgradePlanHandler(e){Object(Af.a)("upgrade plan | current: PAID"),this.updateItem((e=>{e.showPromoTooltip=!1,e.showPromoPopover=!1}),Qf),this.save()}receiveKeyHandler(e){Object(Af.a)("receive zCloud key"),this.updateItem((e=>{e.showEntry=!0,e.showTip=!0}),Qf),this.save()}doesSubmitOnboardingDoneBefore(){return!!n.default.getInstance().getItemForCurrentUser("zcl_sm_ob")}setSubmitOnboardingDone(){n.default.getInstance().setItemForCurrentUser("zcl_sm_ob","true")}removeSubmitOnboaringDoneKey(){n.default.getInstance().removeItemForCurrentUser("zcl_sm_ob")}setShowPromoTooltip(e){this.updateItem((t=>{t.showPromoTooltip=e}),Qf),this.save()}setShowPromoPopover(e){this.updateItem((t=>{t.showPromoPopover=e}),Qf),this.save()}initPromoStates({showPromoTooltip:e,showPromoPopover:t}){this.updateItem((s=>{s.showPromoTooltip=e,s.showPromoPopover=t}),Qf),this.save()}initShouldShowEntry(e){Object(Af.a)("init check zcloud user: ",e),this.updateItem((t=>{t.showEntry=e}),Qf),this.save()}addListener(){this.onboardEventsResolver.addEventListener(qf.b.MOBILE_COMPLETED_BEFORE,this.triggerOnboardingHandler),this.onboardEventsResolver.addEventListener(qf.b.PC_COMPLETED_BEFORE,this.pcDoneOnboardingHandler),this.eventsResolver.addEventListener(Kf.a.UPGRADE_ZCLOUD_PLAN,this.upgradePlanHandler),this.eventsResolver.addEventListener(Kf.a.HAVE_KEY,this.receiveKeyHandler),this.eventsResolver.addEventListener(Kf.g.HAVE_KEY,this.receiveKeyHandler),this.eventsResolver.addEventListener(Kf.a.OFF_PERSONAL_CLOUD_PLAN,this.offPlanHandler)}removeListener(){this.onboardEventsResolver.removeEventListener(qf.b.MOBILE_COMPLETED_BEFORE,this.triggerOnboardingHandler),this.onboardEventsResolver.removeEventListener(qf.b.PC_COMPLETED_BEFORE,this.pcDoneOnboardingHandler),this.eventsResolver.removeEventListener(Kf.a.UPGRADE_ZCLOUD_PLAN,this.upgradePlanHandler),this.eventsResolver.removeEventListener(Kf.a.HAVE_KEY,this.receiveKeyHandler),this.eventsResolver.removeEventListener(Kf.g.HAVE_KEY,this.receiveKeyHandler),this.eventsResolver.removeEventListener(Kf.a.OFF_PERSONAL_CLOUD_PLAN,this.offPlanHandler)}onDoneOnboarding(){this.submitDoneOnboarding(),this.updateItem((e=>{e.showTip=!1}),Qf),this.save()}async submitDoneOnboarding(){Object(Af.a)("submit done onboarding");try{if(this.doesSubmitOnboardingDoneBefore())return;await Vf.a.submitOnboardingInfo(),this.setSubmitOnboardingDone()}catch(e){}}})||xf)||xf)||xf)||xf)||xf)||xf)||xf);var Jf,Xf=s("NoK8");const ev="1",tv={currentView:null,pageStack:[]};Object(i.injectable)()(Jf=Object(i.singleton)(Xf.b)(Jf=Object(ie.b)(Xf.b)(Jf=Reflect.metadata("design:type",Function)(Jf=Reflect.metadata("design:paramtypes",[])(Jf=class extends Pt{constructor(){super(),this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this.lastMediaView=void 0,this.name=Xf.a,this.key=Xf.a,this.data.set(ev,tv),this.lastMediaView=null}_getState(e=ev){return this.data.get(e)}setInitView(e){this.updateItem((t=>{t.currentView=e}),ev)}changeView(e){this.updateItem((t=>{t.currentView=e}),ev),e!==kf.b.SETTING&&(this.lastMediaView=e)}closeSetting(){this.changeView(this.lastMediaView||kf.b.MEDIA_TYPE)}getCurrentView(){const{currentView:e}=this._getState();return e}getPageStack(){const{pageStack:e}=this._getState();return e}pushPageStack(e){const{pageStack:t}=this._getState();this.updateItem((s=>{s.pageStack=[...t,e]}),ev)}setPageStack(e){e&&Array.isArray(e)&&this.updateItem((t=>{t.pageStack=e}),ev)}popPageStack(){const{pageStack:e}=this._getState(),t=[...e];t.pop(),this.updateItem((e=>{e.pageStack=t}),ev)}})||Jf)||Jf)||Jf)||Jf);var sv,iv=s("/wRJ");const av="1",nv={currentSelectedConvId:null,currentConversationInfo:null,forceBackToConvList:!1,convUsageData:null,sorter:Tf.d.SIZE_DESCENDING,searchText:"",lastScrollTopOffset:null};Object(i.injectable)()(sv=Object(i.singleton)(iv.b)(sv=Object(ie.b)(iv.b)(sv=function(e,t){return Object(i.inject)(ze.i)(e,void 0,0)}(sv=Reflect.metadata("design:type",Function)(sv=Reflect.metadata("design:paramtypes",[void 0===ze.i?Object:ze.i])(sv=class extends Pt{constructor(e){super(),this.previewDataManager=e,this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this.originalConvList=void 0,this.name=iv.a,this.key=iv.a,this.data.set(av,nv),this.originalConvList=[]}_getState(e=av){return this.data.get(e)}_getMiniInfo(e){const t=Wa.a.isGroup(e),s=t?Fe.default.getMiniInfoGroup(e):Z.default.getMiniInfo(e);return Object(T.a)(Object(T.a)({},s),{},{isGroup:t,convName:t?null==s?void 0:s.displayName:null==s?void 0:s.dName})}_getNormalizedList(e){return e&&Array.isArray(Object.keys(e))&&Object.keys(e).flatMap((t=>{var s;return t===U.default.sendToMeId||Le.a.isThreadHidden(t)||0===(null===(s=e[t])||void 0===s?void 0:s.total)?[]:{convId:t,miniInfo:this._getMiniInfo(t),usage:e[t].total}}))}_getNormalizedListWithEmptyConversation(e){return e&&Array.isArray(Object.keys(e))&&Object.keys(e).flatMap((t=>t===U.default.sendToMeId||Le.a.isThreadHidden(t)?[]:{convId:t,miniInfo:this._getMiniInfo(t),usage:e[t].total}))}_getFilteredList(e,t){let s=[];return s=this._search([...this.originalConvList],e),s=this._sort(s,t),s}_search(e,t){if(!t)return e;return e.filter((e=>{var s;return md((null==e||null===(s=e.miniInfo)||void 0===s?void 0:s.convName)||"",t.toLowerCase())}))}_sort(e,t){if(!t)return e;switch(t){case Tf.d.SIZE_ASCENDING:case Tf.d.SIZE_DESCENDING:return e.sort(((e,s)=>{const i=e.usage,a=s.usage-i;return t===Tf.d.SIZE_DESCENDING?a:-a}));case Tf.d.ACTIVIY_ASCENDING:case Tf.d.ACTIVIY_DESCENDING:return e.sort(((e,s)=>{var i,a;const n=+((null===(i=this.previewDataManager.getPreviewByIDSync(e.convId))||void 0===i?void 0:i.messageTime)||0),r=+((null===(a=this.previewDataManager.getPreviewByIDSync(s.convId))||void 0===a?void 0:a.messageTime)||0)-n;return t===Tf.d.ACTIVIY_DESCENDING?r:-r}))}}async loadAllConversationUsage(e=!1){try{const{searchText:t,sorter:s,currentSelectedConvId:i}=this._getState(),a=await Cf.a.getClientUsage();if(!a||null==a||!a.usageByConversation)return;Object(Af.b)("original conv list: ",a.usageByConversation);const n=this._getNormalizedList(a.usageByConversation);Object(Af.b)("normalized conv list: ",n),this.originalConvList=n;const r=this._getFilteredList(t,s);if(this.updateItem((e=>{e.convUsageData=r}),av,e),!i)return;const o=this._getNormalizedListWithEmptyConversation(a.usageByConversation).find((e=>e.convId===i));if(!o)return void this.updateItem((e=>{e.currentSelectedConvId=null,e.currentConversationInfo=null,e.forceBackToConvList=!0}),av);this.updateItem((e=>{e.currentConversationInfo=o}),av)}catch(t){}}setSearchText(e){"string"==typeof e&&this.updateItem((t=>{t.searchText=e}),av)}setSorter(e){e&&this.updateItem((t=>{t.sorter=e}),av)}setSelectedConversation(e){this.updateItem((t=>{t.currentSelectedConvId=e}),av)}setLastScrollTopOffset(e){this.updateItem((t=>{t.lastScrollTopOffset=e}),av)}setForceBackToConvList(e){this.updateItem((t=>{t.forceBackToConvList=e}),av)}getConversationList(){const{convUsageData:e}=this._getState();return e}getCurrentSelectedConvId(){const{currentSelectedConvId:e}=this._getState();return e}updateCurrentConversationInfo(e){const{currentSelectedConvId:t}=this._getState();if(!t||!e)return;const s=this._getNormalizedListWithEmptyConversation(e).find((e=>e.convId===t));s?this.updateItem((e=>{e.currentConversationInfo=s}),av):this.updateItem((e=>{e.currentSelectedConvId=null,e.forceBackToConvList=!0}),av)}filterList(e,t){const s=this._getFilteredList(e,t);this.updateItem((e=>{e.convUsageData=s}),av)}resetStates(){this.data.set(av,nv)}})||sv)||sv)||sv)||sv)||sv);var rv=s("5y3u");i.ModuleContainer.registerSingleton(rv.a,rv.b);var ov=s("iyDo"),cv=s("UDME"),lv=s("A9no"),dv=s("bKXo"),hv=s("tIXy");var uv=class{constructor(){this.data=void 0,this.data=new Map}startCapture(e,t={}){this.data.set(e,{start:D.default.getTimeNow(),end:null,params:t})}finishCapture(e,t={}){const s=this.data.get(e);if(s){const i=Object(T.a)(Object(T.a)({},s),{},{end:D.default.getTimeNow(),params:Object(ph.a)(s.params,t)});return this.data.set(e,i),i}return s}getItem(e){return this.data.get(e)}clearItem(e){this.data.delete(e)}};let gv=function(e){return e[e.NORMAL=0]="NORMAL",e[e.SILENTLY=1]="SILENTLY",e[e.BLOCKING=2]="BLOCKING",e[e.SILENTLY_BLOCKING=3]="SILENTLY_BLOCKING",e}({}),mv=function(e){return e[e.OFF=0]="OFF",e[e.ON=1]="ON",e}({}),pv=function(e){return e[e.MEMBER=0]="MEMBER",e[e.OWNER=1]="OWNER",e[e.ADMIN=2]="ADMIN",e}({}),fv=function(e){return e[e.CHAT_11=1]="CHAT_11",e[e.CHAT_GROUP=2]="CHAT_GROUP",e[e.MY_CLOUD=3]="MY_CLOUD",e}({}),vv=function(e){return e[e.MANUAL=0]="MANUAL",e[e.DEFAULT=1]="DEFAULT",e[e.NOT_SILENTLY=-1]="NOT_SILENTLY",e}({}),_v=function(e){return e[e.LEAVE_GROUP=1]="LEAVE_GROUP",e[e.CHANGE_HIDE_MEMBER_SETTING=1]="CHANGE_HIDE_MEMBER_SETTING",e[e.CLICK_GROUP_LINK=1]="CLICK_GROUP_LINK",e[e.UPGRADE_COMMUNITY=1]="UPGRADE_COMMUNITY",e[e.VERIFY_ACCOUNT=2]="VERIFY_ACCOUNT",e[e.CLICK_LEARN_MORE=3]="CLICK_LEARN_MORE",e[e.ENTER_UPGRADE_FLOW=4]="ENTER_UPGRADE_FLOW",e[e.ENTER_KYC_FLOW=5]="ENTER_KYC_FLOW",e}({});i.ModuleContainer.registerSingleton(ov.a,class{constructor(){this.upgradeCommunityCapture=void 0,this.verificationCapture=void 0,this.upgradeCommunityCapture=new uv,this.verificationCapture=new uv}logAction999(e){const{type:t,payload:s,noisedIds:i}=e;let a;switch(t){case"LEAVE_GROUP":a=_v.LEAVE_GROUP,fe.default.logActionInfoV2(fe.FeaturesInfo.LeaveGroupSilently,a,s,i);break;case"CHANGE_HIDE_MEMBER_SETTING":a=_v.CHANGE_HIDE_MEMBER_SETTING,fe.default.logActionInfoV2(fe.FeaturesInfo.HideMemberPresence,a,s,i);break;case"CLICK_GROUP_LINK":a=_v.CLICK_GROUP_LINK,fe.default.logActionInfoV2(fe.FeaturesInfo.ClickGroupLink,a,s,i);break;case"UPGRADE_COMMUNITY":a=_v.UPGRADE_COMMUNITY,fe.default.logActionInfoV2(fe.FeaturesInfo.Community,a,s,i);break;case"VERIFY_ACCOUNT":a=_v.VERIFY_ACCOUNT,fe.default.logActionInfoV2(fe.FeaturesInfo.Community,a,s,i);break;case"CLICK_LEARN_MORE":a=_v.CLICK_LEARN_MORE,fe.default.logActionInfoV2(fe.FeaturesInfo.Community,a,s,i);break;case"ENTER_KYC_FLOW":a=_v.ENTER_KYC_FLOW,fe.default.logActionInfoV2(fe.FeaturesInfo.Community,a,s,i);break;case"ENTER_UPGRADE_FLOW":a=_v.ENTER_UPGRADE_FLOW,fe.default.logActionInfoV2(fe.FeaturesInfo.Community,a,s,i)}}getChatTypeFromConvId(e){return A.default.isGroup(e)?fv.CHAT_GROUP:Gp.a.isSendToMe(e)?fv.MY_CLOUD:fv.CHAT_11}getMemberRole(e,t){return cv.GroupSettingHelper.isOwner(e,t)?pv.OWNER:cv.GroupSettingHelper.isAdmin(e,t)?pv.ADMIN:pv.MEMBER}isDefaultLeaveSilently(e){return!(!U.default.group_privacy.hide_member.enable||!cv.GroupSettingHelper.isLockViewMember(e))||!(!U.default.group_privacy.leave_group_silently.enable||!lv.isCommunity(e))}getLeaveGroupSilentlyType(e,t){return this.isDefaultLeaveSilently(e)?vv.DEFAULT:"SILENTLY"===t?vv.MANUAL:vv.NOT_SILENTLY}changeHideMemberSettingReport(e){const t=A.default.getGroupIdFromConversationId(e.groupId),s=Z.default.getUidMe();this.logAction999({type:"CHANGE_HIDE_MEMBER_SETTING",payload:{mode:e.value?mv.ON:mv.OFF,des_id:t,src_id:s},noisedIds:[t,s]})}clickGroupLinkReport(e){const t=A.default.getGroupIdFromConversationId(e.groupId),s=Z.default.getUidMe();this.logAction999({type:"CLICK_GROUP_LINK",payload:{chat_type:e.conversationId?this.getChatTypeFromConvId(e.conversationId):null,src_id:s,des_id:t,lobby_version:U.default.group_privacy.hide_member.enable?1:0},noisedIds:[s,t]})}leaveGroupReport(e){let t=e.groupId;t.startsWith(W.GROUPID_PREFIX)||(t=W.GROUPID_PREFIX+t);const s=A.default.getGroupIdFromConversationId(e.groupId),a=Z.default.getUidMe(),n=this.getMemberRole(t,a);this.logAction999({type:"LEAVE_GROUP",payload:{des_id:s,src_id:a,user_role:n,status:this.isDefaultLeaveSilently(t)?gv.SILENTLY:gv[e.leaveType],silent_default:this.getLeaveGroupSilentlyType(t,e.leaveType)},noisedIds:[s,a]}),i.ModuleContainer.resolve(dv.b).onLeaveGroup({groupId:t,actorId:a,memberId:a,leaveType:e.leaveType,memberRole:n})}openPopupUpgradeCommunityReport(e){const{groupId:t,entryPoint:s}=e;this.upgradeCommunityCapture.startCapture(t,{entryPoint:s})}getVerificationStatusLogNumber(e){switch(e){case hv.b.NEED_VERIFY:return 0;case hv.b.VERIFIED:return 1;default:return 3}}closePopupUpgradeCommunityReport(e){const{groupId:t,verificationStatus:s,upgradeStatus:i,errorCode:a}=e,n=this.upgradeCommunityCapture.finishCapture(t);if(!n)return;const r=A.default.getGroupIdFromConversationId(t);this.logAction999({type:"UPGRADE_COMMUNITY",payload:{des_id:r,upgrade_status:i,fail_error:a,duration:n.end-n.start,is_kyc:this.getVerificationStatusLogNumber(s),entrypoint:n.params.entryPoint,action:a?"confirm_upgrade":"close"},noisedIds:[r]}),this.upgradeCommunityCapture.clearItem(t)}openPopupVerificationReport(e){const{groupId:t,entryPoint:s}=e;this.verificationCapture.startCapture(t,{entryPoint:s})}closePopupVerificationReport(e){const{groupId:t,verificationStatus:s,action:i}=e,a=this.verificationCapture.finishCapture(t);if(!a)return;const n=A.default.getGroupIdFromConversationId(t);this.logAction999({type:"VERIFY_ACCOUNT",payload:{des_id:n,duration:a.end-a.start,is_kyc:this.getVerificationStatusLogNumber(s),entrypoint:a.params.entryPoint,action:i||"close"},noisedIds:[n]}),this.verificationCapture.clearItem(t)}clickCommunityLearnMoreReport(e){const{groupId:t,entryPoint:s}=e,i=A.default.getGroupIdFromConversationId(t);this.logAction999({type:"CLICK_LEARN_MORE",payload:{des_id:i,entrypoint:s},noisedIds:[i]})}mapGroupEntryToCommunity(e){switch(e){case"gr_add_member":return"comm_add_member";case"gr_member_approval":return"comm_member_approval";case"message_info":return"msg_info";default:return e}}openPreventAddMemberReport(e){const{entryPoint:t,groupId:s,type:i}=e,a=A.default.getGroupIdFromConversationId(s);this.logAction999({type:"need_kyc"===i?"ENTER_KYC_FLOW":"ENTER_UPGRADE_FLOW",payload:{des_id:a,entrypoint:this.mapGroupEntryToCommunity(t)},noisedIds:[a]})}});var bv=s("sEfC"),yv=s.n(bv);var Iv,Sv=class{constructor(e){this.key=void 0,this._data=void 0,this.key=e}get data(){if(!this._data){const e=n.default.getInstance().getItemForCurrentUser(this.key);let t=[];if(null!==e){try{t=JSON.parse(e)}catch{t=[]}Array.isArray(t)||(t=[])}this._data=new Set(t)}return this._data}addItem(e){this.data.has(e)||(this.data.add(e),n.default.getInstance().setItemForCurrentUser(this.key,JSON.stringify(Array.from(this.data.values()))))}removeItem(e){this.data.has(e)&&(this.data.delete(e),n.default.getInstance().setItemForCurrentUser(this.key,JSON.stringify(Array.from(this.data.values()))))}clear(){this.data.clear(),n.default.getInstance().removeItemForCurrentUser(this.key)}hasItem(e){return this.data.has(e)}};Object(i.injectable)()(Iv=Object(m.j)()(Iv=Object(m.h)()(Iv=Object(ie.b)(Ma.e)(Iv=function(e,t){return Object(i.inject)(Ma.h)(e,void 0,0)}(Iv=Reflect.metadata("design:type",Function)(Iv=Reflect.metadata("design:paramtypes",[void 0===Ma.h?Object:Ma.h])(Iv=class{constructor(e){this.onboardController=e,this.name=void 0,this.key=void 0,this.logger=void 0,this.data=void 0,this.verification=void 0,this.hiddenChatBoxBannerGroups=void 0,this.handleUpdateDataItemImmediately=({groupId:e})=>{const t={groupId:e,bannerStatus:this.getBannerStatusForItem(e)};this.data.set(e,t),this.signalUpdateItem(e)},this.handleUpdateDataItem=yv()(this.handleUpdateDataItemImmediately,300,{leading:!1,trailing:!0}),this.handleUsagedGroupInfoChange=({groupId:e},t)=>{if(!t&&!cv.GroupSettingHelper.isOwner(e,Z.default.getUidMe()))return;const s=Ki.default.isOpenChildWindowByConvId(e),a=e==i.ModuleContainer.resolve(Ks.SidebarController).getCurrMainConvId();(s||a)&&(this.shouldLoadVerificationStatus(e)?(this.getAccountVerificationStatus((()=>{this.handleUpdateDataItem({groupId:e})})),this.verification.loaded=!0):this.handleUpdateDataItem({groupId:e}))},this.handleChangeOwnnerEvent=({groupId:e,ownerId:t})=>{(t==Z.default.getUidMe()||this.data.has(e))&&this.handleUsagedGroupInfoChange({groupId:e},!0)},this.handleMultiGroupInfoChange=e=>{for(const t of e)this.handleUsagedGroupInfoChange({groupId:t})},this.handleProfileVerificationChange=e=>{this.verification={loaded:!0,status:e};const t=[];this.data.forEach((e=>{t.push([e.groupId,Object(T.a)(Object(T.a)({},e),{},{bannerStatus:this.getBannerStatusForItem(e.groupId)})])})),this.data=new Map(t),this.signalUpdateAllItems()},this.handleLeaveGroupEvent=e=>{for(const t of e)this.data.delete(t),this.hiddenChatBoxBannerGroups.removeItem(t)},this.name=Ma.a,this.key="groupId",this.data=new Map,this.verification={loaded:!1,status:null},this.hiddenChatBoxBannerGroups=new Sv(Ma.c)}init(){throw new Error("Method not implemented.")}onStart(){Fe.default.subscribeEventGroup(W.EventGroup.LEAVE_GROUP,this.handleLeaveGroupEvent),Fe.default.subscribeEventGroup(W.EventGroup.UPGRADE_COMMUNITY,this.handleUsagedGroupInfoChange),Fe.default.subscribeEventGroup(W.EventGroup.CHANGE_OWNER,this.handleChangeOwnnerEvent),Fe.default.subscribeEventGroup(W.EventGroup.SIZE_CHANGE,this.handleUsagedGroupInfoChange),Fe.default.subscribeEventGroup(W.EventGroup.GROUP_INFO_CHANGED,this.handleMultiGroupInfoChange),Z.default.subscribeEventFriend(W.EventFriend.PROFILE_VERIFICATION_CHANGE,this.handleProfileVerificationChange)}onDispose(){Fe.default.unsubscribeEventGroup(W.EventGroup.LEAVE_GROUP,this.handleLeaveGroupEvent),Fe.default.unsubscribeEventGroup(W.EventGroup.UPGRADE_COMMUNITY,this.handleUsagedGroupInfoChange),Fe.default.unsubscribeEventGroup(W.EventGroup.CHANGE_OWNER,this.handleUsagedGroupInfoChange),Fe.default.unsubscribeEventGroup(W.EventGroup.SIZE_CHANGE,this.handleUsagedGroupInfoChange),Fe.default.unsubscribeEventGroup(W.EventGroup.GROUP_INFO_CHANGED,this.handleMultiGroupInfoChange),Z.default.unsubscribeEventFriend(W.EventFriend.PROFILE_VERIFICATION_CHANGE,this.handleProfileVerificationChange)}getList(){return Array.from(this.data.keys())}signalUpdateItem(e){Object(Zs.g)(this.name,e)}signalUpdateAllItems(){this.data.forEach((e=>{this.signalUpdateItem(e.groupId)}))}get Logger(){return this.logger||(this.logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger(Ss.ZLoggerNametags.community,[this.name])),this.logger}getItem(e){return this.data.get(e.key)}onGetItemFailure(e){this.Logger.zsymb(20,"lwq84e","Get community data item failed with id",e)}onGetListFailure(e){this.Logger.zsymb(20,"l1_EWE","Get community data list failed",e)}getOwnedCommunities(){const e=Fe.default.getGroupsListSync(),t=Z.default.getUidMe(),s=[];for(const i of e)i.creatorId===t&&Ma.q.isCommunityFromInfo(i)&&s.push(i);return s}getJoinedCommunities(){const e=Fe.default.getGroupsListSync(),t=[];for(const s of e)Ma.q.isCommunityFromInfo(s)&&t.push(s);return t}getProfileVerificationStatus(){return this.verification.status}getBannerStatusForItem(e){if(null===this.verification.status)return{show:!1};const t=Fe.default.getGroupByIdSync(e);if("number"!=typeof(null==t?void 0:t.totalMember)||t.creatorId!=Z.default.getUidMe())return{show:!1};const s=Ma.q.isCommunityFromInfo(t);let i,a=!1;const n=new Set([Ma.f.CHAT_BOX,Ma.f.RIGHT_BAR]);return this.verification.status===hv.b.VERIFIED?(a=!s&&t.totalMember>=U.default.group_privacy.community.grouptype_threshold,i=Ma.g.REACHED_UPGRADE):(a=s||t.totalMember>=U.default.group_privacy.community.minimum_warn_upgrade,i=s?Ma.g.UPGRADED_VERIFY:t.totalMember>=U.default.group_privacy.community.grouptype_threshold?Ma.g.REACHED_VERIFY:Ma.g.NEARLY_REACH_VERIFY),this.hiddenChatBoxBannerGroups.hasItem(e)&&n.delete(Ma.f.CHAT_BOX),{show:a,type:i,position:n}}getAccountVerificationStatus(e){Z.default.getVerificationStatusMe().then((t=>{this.verification.status=t,null==e||e(t)})).catch((e=>{this.Logger.zsymb(18,"RWTkJQ","Get account verification status failed",e)}))}upgradeToCommunity(e){return new Promise(((t,s)=>{Ni.default.upgradeGroupToCommunity(e).then((()=>{this.Logger.zsymb(18,"_ALeOc","Upgrade community succeed",e),t()})).catch((t=>{this.Logger.zsymb(18,"HN1EyW","Upgrade community failed",e,t),s(t)}))}))}shouldLoadVerificationStatus(e){if(this.verification.loaded&&this.verification.status===hv.b.VERIFIED)return!1;const t=Fe.default.getGroupByIdSync(e);return"number"==typeof(null==t?void 0:t.totalMember)&&(Ma.q.isCommunityFromInfo(t)||t.totalMember>=U.default.group_privacy.community.minimum_warn_upgrade)}onConversationDidOpen(e){this.onboardController.onConversationDidOpen(e),Wa.a.isGroup(e)&&cv.GroupSettingHelper.isOwner(e,Z.default.getUidMe())&&(this.shouldLoadVerificationStatus(e)?(this.getAccountVerificationStatus((()=>{this.handleUpdateDataItemImmediately({groupId:e})})),this.verification.loaded=!0):this.data.has(e)||this.handleUpdateDataItemImmediately({groupId:e}))}onReceivedCommunityError({groupId:e,errorCode:t,windowId:s,src:a}){switch(t){case W.GROUP_MEMBER_ERROR.OWNER_NEED_VERIFY_PROFILE:case W.GROUP_MEMBER_ERROR.REACHED_LIMIT_MEMBER_GROUP:ft.ModalManagerV2.openModal({windowId:s,name:W.ModalIdentitiesDefine.COMMUNITY_PREVENT_ADD_MEMBER,params:{groupId:e,errorCode:t,src:a}}),a&&cv.GroupSettingHelper.isOwner(e,Z.default.getUidMe())&&i.ModuleContainer.resolve(Ma.p).openPreventAddMemberReport({groupId:e,type:t==W.GROUP_MEMBER_ERROR.OWNER_NEED_VERIFY_PROFILE?"need_kyc":"need_upgrade",entryPoint:a})}}closeChatBoxBanner(e){this.hiddenChatBoxBannerGroups.addItem(e),this.handleUpdateDataItemImmediately({groupId:e})}async checkCommunityQuota(e){const t=await Ni.default.getQuotaCommunity(e);if(t&&t.canUpgr)return!0;throw{data:t}}async checkCommunityMemberQuota(e,t){try{const s=await Ni.default.checkQuotaCommunityMember(e,t);this.Logger.zsymb(0,"fQoFmT","check member quota ok",e,t,s);const i={isQualified:s.canUpgr,content:s.content};if(s.canUpgr||s.othersCanUpgr)return i;throw{data:i}}catch(s){throw this.Logger.zsymb(18,"0OqsF-","check member quota fail",e,t,s),s}}})||Iv)||Iv)||Iv)||Iv)||Iv)||Iv);var Cv,Ev=s("7Ull");Object(m.j)()(Cv=Object(m.h)()(Cv=Object(i.singleton)(Ma.h)(Cv=Reflect.metadata("design:type",Function)(Cv=Reflect.metadata("design:paramtypes",[])(Cv=class{constructor(){this.onboardedGroups=void 0,this.lastOnboardedGroupId=void 0,this.onboardingCounter=void 0,this.status=void 0,this.emitter=void 0,this.recentUpgradedGroups=void 0,this.closeOnboard=e=>{this.status[e]&&(this.status=Object(T.a)(Object(T.a)({},this.status),{},{[e]:!1}),this.emitter.emit("change",this.status))},this.isCanShowOnboard=e=>{const t=this.onboardingCounter.getItem(e);return"number"!=typeof t||t<U.default.group_privacy.community.max_onboard_times},this.handleGroupUpgradeEvent=({groupId:e})=>{this.recentUpgradedGroups.add(e);const t=Ki.default.isOpenChildWindowByConvId(e),s=e==i.ModuleContainer.resolve(Ks.SidebarController).getCurrMainConvId();U.default.group_privacy.community.enable_ui&&(t||s)&&(cv.GroupSettingHelper.isOwner(e,Z.default.getUidMe())?(this.status=Object(T.a)(Object(T.a)({},this.status),{},{popup:!0,tip:!1}),this.emitter.emit("change",this.status),this.onDoneNewOnboardingLevel(e,Ma.i.POPUP)):this.isCanShowOnboard(Ma.i.TIP)&&(this.status=Object(T.a)(Object(T.a)({},this.status),{},{tip:!0,popup:!1}),this.emitter.emit("change",this.status),setTimeout((()=>{this.closeOnboard("tip")}),U.default.group_privacy.community.onboard_tip_time),this.onDoneNewOnboardingLevel(e,Ma.i.TIP)))},this.handleLeaveGroupEvent=e=>{for(const t of e)this.recentUpgradedGroups.delete(t)},this.handleOpenChildWindow=({windowId:e})=>{const t=Ki.default.getConvIdFromWindowId(e);this.onConversationDidOpen(t)},this.onboardedGroups=new Set,this.lastOnboardedGroupId=null,this.onboardingCounter=new Ev.a(Ma.d),this.status={tip:!1,popup:!1},this.recentUpgradedGroups=new Set,this.emitter=new Uc.a}onStart(){Fe.default.subscribeEventGroup(W.EventGroup.LEAVE_GROUP,this.handleLeaveGroupEvent),Fe.default.subscribeEventGroup(W.EventGroup.UPGRADE_COMMUNITY,this.handleGroupUpgradeEvent),Ki.default.subscribe(yt.a.CHILD_WINDOW_ALIVE,this.handleOpenChildWindow)}onDispose(){Fe.default.unsubscribeEventGroup(W.EventGroup.LEAVE_GROUP,this.handleLeaveGroupEvent),Fe.default.unsubscribeEventGroup(W.EventGroup.UPGRADE_COMMUNITY,this.handleGroupUpgradeEvent),Ki.default.unsubscribe(yt.a.CHILD_WINDOW_ALIVE,this.handleOpenChildWindow),this.recentUpgradedGroups.clear()}getStatus(){return this.status}hasOnboardedGroupId(e){return this.onboardedGroups.has(e)}getLastOnboardedGroupId(){return this.lastOnboardedGroupId}isDoneOnboard(){return!Object.values(Ma.i).some(this.isCanShowOnboard)}getStatusForGroup(e){return this.recentUpgradedGroups.has(e)?{tip:!1,popup:this.isCanShowOnboard(Ma.i.POPUP)}:{tip:this.isCanShowOnboard(Ma.i.TIP),popup:!1}}onConversationDidOpen(e){U.default.group_privacy.community.enable_ui&&Wa.a.isGroup(e)&&Ma.q.isCommunity(e)&&!this.onboardedGroups.has(e)&&(this.status=this.getStatusForGroup(e),this.status.tip&&(this.emitter.emit("change",this.status),setTimeout((()=>{this.closeOnboard("tip")}),U.default.group_privacy.community.onboard_tip_time),this.onDoneNewOnboardingLevel(e,Ma.i.TIP)),this.status.popup&&(this.emitter.emit("change",this.status),this.onDoneNewOnboardingLevel(e,Ma.i.POPUP)))}onDoneNewOnboardingLevel(e,t){if(this.isDoneOnboard())return;this.lastOnboardedGroupId=e,e&&this.onboardedGroups.add(e);let s=this.onboardingCounter.getItem(t);"number"!=typeof s&&(s=0),this.onboardingCounter.setItem(t,s+1)}resetOnboardFlagFromLocal(){this.lastOnboardedGroupId=null,this.onboardedGroups.clear(),this.onboardingCounter.clear()}})||Cv)||Cv)||Cv)||Cv);var Ov,Tv=s("eCBG");Object(m.h)()(Ov=Object(m.j)()(Ov=Object(i.singleton)(Ma.o)(Ov=Reflect.metadata("design:type",Function)(Ov=Reflect.metadata("design:paramtypes",[])(Ov=class extends De.b{constructor(){super(),this.cachedGroupOwnerInfo=void 0,this.logger=void 0,this.onOpenConvChildWindow=e=>{const t=Ki.default.getConvIdFromWindowId(e);this.onOpenConversation(t)},this.cachedGroupOwnerInfo=new Set}get Logger(){return this.logger||(this.logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger(Ss.ZLoggerNametags.community,[Ma.k])),this.logger}handlePreloadOwnerInfo(e){const t=Fe.default.getMiniInfoGroup(e);null!=t&&t.creatorId&&!this.cachedGroupOwnerInfo.has(e)&&i.ModuleContainer.resolve(Tv.b).getUserInfo(t.creatorId).then((t=>{this.cachedGroupOwnerInfo.add(e),this.dispatchEvent(new Ma.m("done-preload-owner-info",e,{info:t}))})).catch((e=>{this.Logger.zsymb(18,"XDzBCT","Load owner info fail",t,e)}))}onStart(){Ki.default.subscribe(yt.a.CHILD_WINDOW_ALIVE,this.onOpenConvChildWindow)}onDispose(){Ki.default.unsubscribe(yt.a.CHILD_WINDOW_ALIVE,this.onOpenConvChildWindow),this.cachedGroupOwnerInfo.clear()}onOpenConversation(e){A.default.isGroup(e)&&U.default.group_privacy.group_created_by_oa&&this.handlePreloadOwnerInfo(e)}})||Ov)||Ov)||Ov)||Ov);const Mv=["groupId","memberId","actorId"],Rv=["groupId","memberId","actorId"];var wv;Object(i.singleton)(Ma.l)(wv=Reflect.metadata("design:type",Function)(wv=Reflect.metadata("design:paramtypes",[])(wv=class{constructor(){this.name=void 0,this.logger=void 0,this.name=Ma.j}get Logger(){return this.logger||(this.logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger(Ss.ZLoggerNametags.group,[this.name])),this.logger}onAppointAdmin(e){const{groupId:t,memberId:s,actorId:i}=e;this.Logger.zsymb(0,"gB-lSd",`add admin group=${t} mem=${s} actor=${i}`)}onRemoveAdmin(e){const{groupId:t,memberId:s,actorId:i}=e;this.Logger.zsymb(0,"BKF7lP",`remove admin group=${t} mem=${s} actor=${i}`)}onLeaveGroup(e){const{groupId:t,memberId:s,actorId:i}=e,a=Object(he.a)(e,Mv);this.Logger.zsymb(0,"IfbEQv",`leave group=${t} mem=${s} actor=${i}`,a)}onRemoveMember(e){const{groupId:t,memberId:s,actorId:i}=e,a=Object(he.a)(e,Rv);this.Logger.zsymb(0,"WRecdF",`kickout group=${t} mem=${s} actor=${i}`,a)}})||wv)||wv);var Lv=s("P+Nn");let Fv=function(e){return e[e.SEND_FSS=4]="SEND_FSS",e[e.SEND_CARD=5]="SEND_CARD",e}({}),Dv=function(e){return e[e.CHAT_11=1]="CHAT_11",e[e.CHAT_GROUP=2]="CHAT_GROUP",e[e.MY_CLOUD=3]="MY_CLOUD",e}({});var Av=s("nmtd");i.ModuleContainer.registerSingleton(Lv.a,class{logAction999(e){const{type:t,payload:s,noisedIds:i}=e;switch(t){case Av.a.CARD:fe.default.logActionInfoV2(fe.FeaturesInfo.SendFSS,Fv.SEND_CARD,s,i);break;case Av.a.STICKER:fe.default.logActionInfoV2(fe.FeaturesInfo.SendFSS,Fv.SEND_FSS,s,i)}}getChatTypeFromConvId(e){return A.default.isGroup(e)?Dv.CHAT_GROUP:Gp.a.isSendToMe(e)?Dv.MY_CLOUD:Dv.CHAT_11}getRawDestinationId(e,t){return t===Dv.CHAT_GROUP?A.default.getGroupIdFromConversationId(e):e}sendCardReport(e){const t=this.getChatTypeFromConvId(e.toUid),s=this.getRawDestinationId(e.toUid,t),i=Z.default.getUidMe();this.logAction999({type:Av.a.CARD,payload:{src_id:i,des_id:s,chat_type:t,group_id:t===Dv.CHAT_GROUP?s:null,ecard:{background_id:e.backgroundId,char_count:e.charCount,list_title_id:e.listTitleId,tagline_id:e.taglineId}},noisedIds:[i,s]})}sendFSSReport(e){const t=this.getChatTypeFromConvId(e.toUid),s=this.getRawDestinationId(e.toUid,t),i=Z.default.getUidMe();this.logAction999({type:Av.a.STICKER,payload:{src_id:i,des_id:s,chat_type:t,cate_id:e.categoryId,sticker_id:e.stickerId,group_id:t===Dv.CHAT_GROUP?s:null},noisedIds:[i,s]})}});var Nv=s("yQd5");const kv=`${Nv.b}-network-manager`;var Pv=Object(i.define)(kv),jv=s("DPHK");var Uv=class{constructor(){}updateMyAvatar(e,t,s,i={},a=!1){return Z.default.updateMyAvatar(e,s,t,i)}updateGroupAvatar(e,t,s,i,a){let n=Nv.a.w,r=Nv.a.h;return a&&(a.originWidth&&(n=a.originWidth),a.originHeight&&(r=a.originHeight)),this.resolveRequest(rs.default.updateAvatar(e,t,i,s,n,r))}updateAvatar(e,t,s=120,i={},a=!1){const n=e+jv.a.getFullTimeFromMilisecond((new Date).getTime());return A.default.isGroup(e)?this.updateGroupAvatar(e,s,t,n,i):this.updateMyAvatar(s,t,n,i,a)}async reuseAvatar(e,t){let s={photoId:e,isPostSocial:t?1:0};const i=w.b.getProfileDomain()+"/api/social/reuse-avatar?"+this._getCommonParams()+"&params="+this.getEncodedParams(s);return this.resolveRequest(this._get(i,null,12453))}async getAvatarHistory(e,t,s,i){let a={page:e,albumId:s,count:i};t&&(a.photoId=t);const n=w.b.getProfileDomain()+"/api/social/avatar-list?"+this._getCommonParams()+"&params="+this.getEncodedParams(a);return this.resolveRequest(this._get(n,null,12451))}deleteAvatarHistory(e){let t={delPhotos:JSON.stringify(e.map((e=>({photoId:e.toString()}))))};const s=w.b.getProfileDomain()+"/api/social/del-avatars?"+this._getCommonParams()+"&params="+this.getEncodedParams(t);return this.resolveRequest(this._get(s,null,12452))}_get(e,t,s){return rs.default._get(e,t,s)}_getCommonParams(){return rs.default._getCommonParams()}getEncodedParams(e){return rs.default.getEncodedParams(e)}resolveRequest(e){return new Promise(((t,s)=>{e.then(os.a).then(t).catch(s)}))}};i.ModuleContainer.register(Pv,class{get api(){return this._api||(this._api=new Uv),this._api}constructor(){this._api=void 0,this._logger=void 0,this._logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger(Nv.b,["network-manager"])}async updateAvatar(e,t,s,i,a){this._logger.zsymb(0,"NH4ejW",`updateAvatar [convId: ${e}], [s: ${t.size}] [share: ${a}] [meta:`,i);try{return await this.api.updateAvatar(e,t,s,i,a),Promise.resolve(!0)}catch(n){return this._logger.zsymb(18,"3ZDh5_",`updateAvatar [convId: ${e}], [err:`,n),Promise.reject(n)}}async getAvatarHistory(e,t,s,i){return this._logger.zsymb(0,"R4dGiA",`getAvatarHistory [p:${e}], [pId:${t}], [aId:${s}], [c:${i}]`),this.api.getAvatarHistory(e,t,s,i)}async reuseAvatar(e,t){return this._logger.zsymb(0,"ZGn8Q5",`reuseAvatar [photoId: ${e}], [isPostSocial:`,t,"]"),this.api.reuseAvatar(e,t)}async deleteAvatarHistory(e){this._logger.zsymb(0,"9_DMi0","deleteAvatarHistory [photoIds: ",e);try{return await this.api.deleteAvatarHistory(e),Promise.resolve(!0)}catch(t){return Promise.reject(t)}}});const Bv=`${Nv.b}-repository`;var Gv=Object(i.define)(Bv);const zv=`${Nv.b}-storage`;var xv,Vv=Object(i.define)(zv),Hv=s("nKYX"),qv=s("dVwc");let Wv=Object(i.injectable)()(xv=function(e,t){return Object(i.inject)(Vv)(e,void 0,0)}(xv=function(e,t){return Object(i.inject)(Pv)(e,void 0,1)}(xv=Reflect.metadata("design:type",Function)(xv=Reflect.metadata("design:paramtypes",[Object,Object])(xv=class{constructor(e,t){this.storage=e,this.fetcher=t}reuseAvatar(e,t){return this.fetcher.reuseAvatar(e,t)}updateAvatar(e,t,s,i,a){return this.fetcher.updateAvatar(e,t,s,i,a)}async getAvatarHistory(e=0,t="",s="0",i=50){try{const a=await this.fetcher.getAvatarHistory(e,t,s,i);return this.mapApiDataToBackup(a),this.mapApiDataToModel(a)}catch(a){let e=Hv.a.ERR_GET_AVA_HISTORY;return a&&a.code&&(e=a.code),Promise.reject({code:e,message:(null==a?void 0:a.message)||a})}}deleteAvatarHistory(e){return this.fetcher.deleteAvatarHistory(e)}mapApiDataToBackup(e){e.photos.length&&e.photos.forEach((({url:e,bkUrl:t})=>{qv.a.getInstance().setBackup(e,t)}))}mapApiDataToModel(e){return{albumId:e.albumId,hasMore:Boolean(e.hasMore),nextPhotoId:e.nextPhotoId,photos:e.photos.length?e.photos.map((e=>({photoId:e.photoId,thumb:e.thumbnail,url:e.url}))):[]}}})||xv)||xv)||xv)||xv)||xv;i.ModuleContainer.register(Gv,Wv);var Zv;i.ModuleContainer.register(Vv,class{constructor(){this._storage=void 0,this._logger=void 0}get storage(){return this._storage||(this._storage=Vn.default.getInstance()),this._storage}get logger(){return this._logger||(this._logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger(Nv.b,["storage"])),this._logger}async getAvatarHistory(){return new Promise((async(e,t)=>{try{e(await this.storage.Core.AvaHistory.getAll())}catch(s){return this.logger.zsymb(18,"ohtYCx","getAvatarHistory",s),t(s)}}))}addNewAvatarToHistory(e){const t=(new Date).getTime();return this.storage.Core.AvaHistory.insert(Object(T.a)(Object(T.a)({},e),{},{submit_dttm:t}),{replace:!0})}deleteAvatarHistory(e){return this.storage.Core.AvaHistory.delete(e)}});let Kv=Object(i.injectable)()(Zv=function(e,t){return Object(i.inject)(Gv)(e,void 0,0)}(Zv=Reflect.metadata("design:type",Function)(Zv=Reflect.metadata("design:paramtypes",[Object])(Zv=class{get logger(){return this._logger||(this._logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger(Nv.b,[Ss.ZLoggerNametags.controller])),this._logger}constructor(e){this.repository=e,this._logger=void 0,this._avatarHistoryMeta={page:1,photoId:"",albumId:"0",hasMore:!0},this._historyAvatars=[],this._retryLoadMore=1}getFrameList(e){return e?U.default.operation_frame_list.group:U.default.operation_frame_list.personal}getDefaultAvatarList(){var e,t;return(null===U.default||void 0===U.default||null===(e=U.default.settings)||void 0===e||null===(t=e.group)||void 0===t?void 0:t.avt_group_template)||null}async getInitialAvatarHistory(e=50){return this._avatarHistoryMeta={page:1,photoId:"",albumId:"0",hasMore:!0},this._retryLoadMore=1,await this.getAvatarHistory(e)}async loadMoreAvatarHistory(){if(this._avatarHistoryMeta.hasMore&&this._retryLoadMore<3)try{return await this.getAvatarHistory()}catch(e){return this.logger.zsymb(0,"Su3QZH","loadMoreAvatarHistory error",e),this.logger.zsymb(0,"ve5Sr9","retry loadmore",this._retryLoadMore),this._retryLoadMore++,this.loadMoreAvatarHistory()}return[]}async getAvatarHistory(e){if(!this.isValidNetwork())return Promise.reject({code:Hv.a.ERR_NO_NETWORK,message:""});try{const t=await this.repository.getAvatarHistory(this._avatarHistoryMeta.page,this._avatarHistoryMeta.photoId,this._avatarHistoryMeta.albumId,e||50);return this._avatarHistoryMeta={albumId:t.albumId,page:this._avatarHistoryMeta.page+1,photoId:t.nextPhotoId,hasMore:t.hasMore},Array.prototype.push.apply(this._historyAvatars,t.photos),t.photos}catch(t){return this.logger.zsymb(18,"UPqK6P","Error getting avatar history",t),Promise.reject({code:Hv.a.ERR_GET_AVA_HISTORY,message:(null==t?void 0:t.msg)||(null==t?void 0:t.message)})}}async deleteAvatarHistory(e){if(!this.isValidNetwork())return Promise.reject({code:Hv.a.ERR_NO_NETWORK,message:""});try{return await this.repository.deleteAvatarHistory([e]),this._historyAvatars=this._historyAvatars.filter((t=>t.photoId!==e)),!0}catch(t){if(this.logger.zsymb(18,"a_6Zls","deleteAvatarHistory",t),t&&t.errMap){const s=t.errMap;return Promise.reject({code:s[e],message:""})}return Promise.reject({code:Hv.a.DELETE_AVATAR_ERROR,message:""})}}updateAvatar(e,t,s,i,a){return this.isValidNetwork()?this.repository.updateAvatar(e,t,s,i,a):Promise.reject({code:Hv.a.ERR_NO_NETWORK,message:""})}async reuseAvatar(e,t){try{await this.repository.reuseAvatar(e,t);const s=this._historyAvatars.find((t=>t.photoId===e));return s&&(this._historyAvatars=this._historyAvatars.filter((t=>t.photoId!==e)),this._historyAvatars.unshift(s)),!0}catch(s){return Promise.reject(!1)}}isValidNetwork(){return Fn.b.getStateNetwork()===Fn.a.CONNECTED}})||Zv)||Zv)||Zv)||Zv;var Qv=s("TGcW").a;i.ModuleContainer.registerSingleton(Qv,Kv);var $v,Yv=s("Vh8h"),Jv=s("kEG/");function Xv(){return"number"==typeof U.default.async_forward.checked_url_cache_expiration_time?U.default.async_forward.checked_url_cache_expiration_time:36e5}function e_(){return!U.default.async_forward.disable_cache_check_exist}function t_(){return fi.a.now()}var s_=Object(i.injectable)()($v=function(e,t){return Object(i.inject)(B.ZLoggerFactory)(e,void 0,0)}($v=Reflect.metadata("design:type",Function)($v=Reflect.metadata("design:paramtypes",[void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory])($v=class{constructor(e){this._checkedMap=new Map,this._currentCheckingRequestAmount=0,this._urlChangedMap=new Map,this._logger=void 0,this._isQueueExecuting=!1,this._queue=[],ye.p.listenEvent(ye.k,this.onNetworkChange.bind(this)),this.Logger=e.createZLogger("utils",["share-file-handler"])}check(e){return new Promise(((t,s)=>{e_()&&this.checkedMap.has(e)&&t_()-this.checkedMap.get(e)<Xv()?(t(!0),this.executeQueue()):this.enqueueExecution(e,t,s)}))}getNewUrl(e){return this.urlChangedMap.get(e)||e}updateFileUrl(e,t){this.urlChangedMap.set(e,t),this.checkedMap.set(t,t_())}decreaseRequestAmount(){this._currentCheckingRequestAmount--}enqueueExecution(e,t,s,i=!0){this.executionQueue.push({url:e,resolve:t,reject:s,shouldRetry:i}),this.executeQueue()}executeQueue(){if(!this.isQueueExecuting()){for(this.setExecutionQueueWorking();this.getCurrentNetworkStatus()!==Fn.a.DISCONNECT&&this.getCurrentRequestAmount()<=("number"==typeof U.default.async_forward.maximum_requests_in_a_while?U.default.async_forward.maximum_requests_in_a_while:5)&&this.executionQueue.length>0;){let e=this.executionQueue.shift();this.increaseRequestAmount(),this.processCheckingRequest(e).then((()=>{this.handleResponse(e,!0,null)})).catch((t=>{var s;this.handleResponse(e,!1,null===(s=t.data)||void 0===s?void 0:s.status)}))}this.setExecutionQueueFree()}}getCurrentNetworkStatus(){return Fn.b.getStateNetwork()}getCurrentRequestAmount(){return this._currentCheckingRequestAmount}increaseRequestAmount(){this._currentCheckingRequestAmount++}isQueueExecuting(){return this._isQueueExecuting}onNetworkChange(){this.getCurrentNetworkStatus()===Fn.a.CONNECTED&&(this.Logger.zsymb(21,"sE6mjt",["network was connected, start executing check-exist queue","xinVk1"]),this.executeQueue())}setExecutionQueueFree(){this._isQueueExecuting=!1}setExecutionQueueWorking(){this._isQueueExecuting=!0}handleResponse(e,t,s){this.decreaseRequestAmount(),t?(this.checkedMap.set(e.url,t_()),this.executeQueue()):s===Jv.b.ClientError.RequestTimeout&&e.shouldRetry?this.enqueueExecution(e.url,e.resolve,e.reject,!1):(this.checkedMap.set(e.url,0),this.executeQueue()),e.resolve(t)}tryToLoadUrl(e){return new Promise(((t,s)=>{const i=91047;!function(e,t={}){const s=Date.now(),i=t_();let a=e.replace("http://","https://");a=A.default.removeE2eeProtocol(a);const{onabort:n=null,onerror:r=null,onload:o=null,ontimeout:c=null,timeout:l=1e4}=t,d=new XMLHttpRequest;d.open("HEAD",a),d.responseType="arraybuffer",d.timeout=l,Us.k||d.setRequestHeader("Cache-Control","no-cache");const h=()=>({duration:t_()-i,startTime:s});d.onload=e=>{o&&o(e,h())},d.onerror=e=>{r&&r(e,h())},d.ontimeout=e=>{c&&c(e,h())},d.onabort&&(d.onabort=e=>{n&&n(e,h())}),d.send()}(e,{onabort:(e,t)=>{Si.default.increaseFailed(i,0,t.duration,4,t.startTime),s(e.target.status)},onerror:(e,t)=>{this.Logger.zsymb(21,"d_hOFl",["check-exist error: {}","FA7_WN"],e),Si.default.increaseFailed(i,0,t.duration,2,t.startTime),s(e.target.status)},onload:(e,a)=>{e.target.status>=400?(Si.default.increaseFailed(i,0,a.duration,3,a.startTime),s(e.target.status)):e.target.responseURL&&e.target.responseURL.indexOf("default")>=0?(Si.default.increaseFailed(i,0,a.duration,5,a.startTime),s(e.target.status)):(Si.default.increaseSuccess(i,0,a.duration),t(!0))},ontimeout:(e,t)=>{Si.default.increaseFailed(i,0,t.duration,1,t.startTime),s(e.target.status)}})}))}async processCheckingRequest(e){if(!e)return Promise.reject({message:"Invalid request item",data:null});const{url:t}=e;if(e_()&&this.checkedMap.has(t)){let e=this.checkedMap.get(t);if(t_()-e<Xv())return Promise.resolve()}if(Us.k&&!A.default.isConnectSrc(t))try{return await Object(Yv.b)(t,"number"==typeof U.default.async_forward.checking_url_timeout?U.default.async_forward.checking_url_timeout:1e4),Promise.resolve()}catch(s){return Promise.reject({message:"",data:{status:0}})}try{return await this.tryToLoadUrl(t),Promise.resolve()}catch(s){return Promise.reject({message:"",data:{status:s}})}}get checkedMap(){return this._checkedMap}get executionQueue(){return this._queue}get urlChangedMap(){return this._urlChangedMap}get Logger(){return this._logger}set Logger(e){this._logger=e}})||$v)||$v)||$v)||$v,i_=s("vyPS");i.ModuleContainer.register(i_.a,s_);s("Ws6j");var a_=s("GaKD"),n_=s("Y65e"),r_=s("fc/q");const o_=i.ModuleContainer.resolve(r_.b),c_=(e,t)=>(s,i,a)=>{const n=a.value;a.value=function(...s){const i=performance.now(),a=n.apply(this,s);if(a instanceof Promise)return as.b.catchAsyncFn((()=>a)).then((([a,n])=>{const r=performance.now()-i,o=Object(T.a)({commandId:e,success:!a,errorCode:null==a?void 0:a.code,duration:r},null==t?void 0:t(s,[a,n],r));if(o_.log(o),a)throw a;return n}));{const n=performance.now()-i,r=Object(T.a)({commandId:e,success:!0,duration:n},null==t?void 0:t(s,[null,a],n));return o_.log(r),a}}};let l_=function(e){return e[e.CLIENT_PARSER=111026]="CLIENT_PARSER",e[e.SERVER_PARSER=111027]="SERVER_PARSER",e[e.NOOP_PARSER=111028]="NOOP_PARSER",e[e.DOWNLOAD_THUMB=111029]="DOWNLOAD_THUMB",e[e.UPLOAD_THUMB=111030]="UPLOAD_THUMB",e[e.PREVIEW_INTEGRITY=111031]="PREVIEW_INTEGRITY",e}({});var d_,h_,u_,g_,m_;let p_=(d_=c_(l_.NOOP_PARSER,(([e])=>({params:[e]}))),h_=Reflect.metadata("design:type",Function),u_=Reflect.metadata("design:paramtypes",[String]),m_=class e{constructor(){}static getInstance(){return null===e.instance&&(e.instance=new e),e.instance}isMatchParser(e){return!0}async parse(e){return null}},m_.instance=null,g_=m_,Object(n_.a)(g_.prototype,"parse",[d_,h_,u_],Object.getOwnPropertyDescriptor(g_.prototype,"parse"),g_.prototype),g_);var f_=s("G95d"),v_=s("dXzg");let __=function(e){return e[e.UNKNOWN_ERROR=100]="UNKNOWN_ERROR",e[e.URL_ERROR=101]="URL_ERROR",e[e.HTTP_STATUS_ERROR=102]="HTTP_STATUS_ERROR",e[e.REDIRECT_ERROR=103]="REDIRECT_ERROR",e[e.PARSE_XML_HEAD_ERROR=104]="PARSE_XML_HEAD_ERROR",e[e.HTTP_REQUEST_ERROR=105]="HTTP_REQUEST_ERROR",e[e.EMPTY_METADATA=106]="EMPTY_METADATA",e[e.PARSE_LINK_SERVER_ERROR=200]="PARSE_LINK_SERVER_ERROR",e[e.DOWNLOAD_THUMB_ERROR=300]="DOWNLOAD_THUMB_ERROR",e[e.THUMB_SIZE_ERROR=301]="THUMB_SIZE_ERROR",e[e.THUMB_TYPE_ERROR=302]="THUMB_TYPE_ERROR",e[e.WEBP_THUMB_TYPE_ERROR=303]="WEBP_THUMB_TYPE_ERROR",e[e.UPLOAD_THUMB_ERROR=400]="UPLOAD_THUMB_ERROR",e[e.COMPRESS_THUMB_ERROR=401]="COMPRESS_THUMB_ERROR",e[e.GET_PARSER_ERROR=500]="GET_PARSER_ERROR",e}({});const b_=(e,t)=>{if(e)throw t};class y_ extends Error{constructor(e,t,s,i=[]){super(s),this.code=void 0,this.qosParams=void 0,this.name=e,this.qosParams=[s,...i],this.code=t}setStack(e){const t=`${this.name}: ${this.message}`;this.stack=t+(e||"")}toObject(){return{name:this.name,code:this.code,message:this.message,stack:this.stack,qosParams:this.qosParams}}static createFromObject(e){const{name:t="UnknownError",code:s=__.UNKNOWN_ERROR,message:i,stack:a,qosParams:n=[]}=e,r=new y_(t,s,i,n);return r.setStack(a),r}}class I_ extends y_{constructor(e,t,s){super("ParseLinkServerError",__.PARSE_LINK_SERVER_ERROR,`Parse link server failed. Url: ${e}. Message: ${t}`,s)}}class S_ extends y_{constructor(e,t){super("UploadThumbError",__.UPLOAD_THUMB_ERROR,`Upload thumb failed. Message: ${e}`,t)}}class C_ extends y_{constructor(e,t){super("CompressThumbError",__.COMPRESS_THUMB_ERROR,`Compress thumb failed. Message: ${e}`,t)}}const E_=1048576,O_={GB:1073741824,MB:E_,KB:1024,byte:1};let T_;var M_;(M_=T_||(T_={})).sizeInByte=e=>{const t=/(\d+)(byte|KB|MB|GB)/g;let s,i=0;for(;s=t.exec(e);)i+=parseInt(s[1])*O_[s[2]];return i},M_.getFileSizeByHead=async(e,t)=>{const s=await fetch(e,{method:"HEAD"}),i=s.headers.get("content-length"),a=s.headers.get("content-type");if(t&&t!=a)throw new Error(`An error occurred when trying to get file size. Error: unexpected content-type.Content-type expectation is "${t}" but received Content-type is "${a}".`);return Number(null!=i?i:0)};var R_=function(e){return e[e.META_TITLE=0]="META_TITLE",e[e.META_DESCRIPTION=1]="META_DESCRIPTION",e[e.META_THUMB=2]="META_THUMB",e[e.DOCUMENT=3]="DOCUMENT",e}(R_||{}),w_=function(e){return e[e.NOT_FOUND=0]="NOT_FOUND",e[e.INVALID_FORMAT=1]="INVALID_FORMAT",e[e.DOWNLOAD_ERROR=2]="DOWNLOAD_ERROR",e}(w_||{});class L_{constructor(){}async fetch(e){const[t,s]=await as.b.catchAsyncFn((()=>this.fetchLinkInfoFromServer(e)));b_(!!t,t&&new I_(e,null==t?void 0:t.message));const[i,a]=await this.transformResponse(e,s);return b_(!!i,i),a}fetchLinkInfoFromServer(e){return rs.default.getLinkInformation(e).then(os.a)}async transformResponse(e,t){var s,a,n;if(i.ModuleContainer.resolve(v_.a).get("enable_verify_parse_link_server")&&as.e.isNotEmptyObject(t.error_maps))return[new I_(e,JSON.stringify(t.error_maps)),null];if((null===(s=t.error_maps)||void 0===s?void 0:s[R_.DOCUMENT])===w_.DOWNLOAD_ERROR)return[new I_(e,JSON.stringify(t.error_maps)),null];if(e.endsWith(".pdf")){var r;const s=await T_.getFileSizeByHead(e);return t.data=null!==(r=t.data)&&void 0!==r?r:{},t.data.title=Yl.a.getFileNameFromUrl(e),t.data.desc=A.default.sizeToString(s),t.data.thumb=A.DEFAULT_THUMB_URLS.ICON_PDF,[null,t.data]}return t.data.thumb&&!((null===(a=t.error_maps)||void 0===a?void 0:a[R_.META_THUMB])in w_)||t.data.thumb||t.data.title&&t.data.desc?((null===(n=t.error_maps)||void 0===n?void 0:n[R_.META_THUMB])in w_&&(t.data.thumb=""),[null,t.data]):[new I_(e,JSON.stringify(t)),null]}}var F_,D_,A_,N_,k_,P_=s("o2mE"),j_=s("/vDv");let U_=(F_=c_(l_.SERVER_PARSER,(([e],t,s)=>(i.ModuleContainer.resolve(P_.b).linkParser.zsymb(12,"j5gi5g","ParseLinkMetric",l_[l_.SERVER_PARSER],e,s),{params:[e]}))),D_=Reflect.metadata("design:type",Function),A_=Reflect.metadata("design:paramtypes",[String]),(k_=class e{constructor(){}static getInstance(){return null===e.instance&&(e.instance=new e),e.instance}isMatchParser(e,t){const s=i.ModuleContainer.resolve(v_.a);if(s.get("enable_force_parse_link_server"))return!0;if(!s.get("enable_parse_link_server"))return!1;const a=s.get("white_list_domain");for(const i of a)if(Yl.a.isHrefMatchDomain(e,i))return!0;if((null==t?void 0:t.entry)===f_.a.MESSAGE_WIDGET)return!0;if(!s.get("enable_parse_link_client")){if(null!=t&&t.convId){if(!j_.a.isE2eeConv(t.convId))return!0}if((null==t?void 0:t.entry)===f_.a.SHARE_MESSAGE)return!0}return!1}async parse(e){const[t,s]=await as.b.catchAsyncFn((()=>(new L_).fetch(e)));return b_(!!t,t),{typeParse:f_.b.SERVER,href:e,desc:null==s?void 0:s.desc,media:null==s?void 0:s.media,src:null==s?void 0:s.src,stream_icon:null==s?void 0:s.stream_icon,thumb:null==s?void 0:s.thumb,title:null==s?void 0:s.title}}}).instance=null,N_=k_,Object(n_.a)(N_.prototype,"parse",[F_,D_,A_],Object.getOwnPropertyDescriptor(N_.prototype,"parse"),N_.prototype),N_);var B_=s("poQk");let G_;var z_,x_,V_,H_,q_;!function(e){e.toSafeLowerCase=e=>"string"==typeof e?e.toLowerCase():e,e.toSafeUpperCase=e=>"string"==typeof e?e.toUpperCase():e,e.safeSplit=(e,...t)=>"string"==typeof e?e.split(...t):[];const t=e.trim=e=>e.trim().replace(/ +/g," ");e.truncateWord=(e,s)=>{const i=t(e);if(i.length<=s)return i;let a=s;for(;a>=0&&" "!==i[a];)a--;return a<=0?i.slice(0,s)+"…":i.slice(0,a)+"…"}}(G_||(G_={}));z_=c_(l_.CLIENT_PARSER,(([e],[t,s],a)=>{i.ModuleContainer.resolve(P_.b).linkParser.zsymb(12,"hkq9N-","ParseLinkMetric",l_[l_.CLIENT_PARSER],e,a);const n={params:[e]};return t||s||(n.success=!1,n.errorCode=__.EMPTY_METADATA),n})),x_=Reflect.metadata("design:type",Function),V_=Reflect.metadata("design:paramtypes",[String]),(q_=class e{constructor(){}static getInstance(){return null===e.instance&&(e.instance=new e),e.instance}isMatchParser(e,t){return!!i.ModuleContainer.resolve(v_.a).get("enable_parse_link_client")&&(null==t?void 0:t.entry)!==f_.a.MESSAGE_WIDGET}async parse(e){var t;const s=i.ModuleContainer.resolve(v_.a),a=s.get("max_redirect"),n=s.get("max_title_character"),r=s.get("max_desc_character"),{enable_log_metric:o,delay_parse_client:c}=s.get("debug"),l=globalThis.__configParseLinkTest__;t=null==l?void 0:l.mockRedirect,null==l||l.mockPreview;let d;{const t={};0;const[s,n]=await as.b.catchAsyncFn((()=>B_.b.exec("parseLink",[e,{maxRedirect:a},t],{priority:B_.a.HIGH})));if(b_(!!s,s&&y_.createFromObject(s)),[d]=n,o){const[t,s]=n;i.ModuleContainer.resolve(P_.b).linkParser.zsymb(12,"707RZL","ParseLinkMetric: ",l_[l_.CLIENT_PARSER],"DETAIL",e,{fetch:s.endFetch-s.startFetch,parse:s.endParseMetaData-s.startParseMetaData,total:s.endParseMetaData-s.startFetch,htmlSize:s.htmlSize})}}const h=this.sanitizeMetaData(d,{maxTitleLength:n,maxDescLength:r});return this.isMetaDataFailed(h)?null:{typeParse:f_.b.CLIENT,href:Yl.a.getUrlWithHttpProtocol(e),title:h.title,desc:h.desc,thumb:"",thumbOrigin:h.thumb,media:{},src:h.src}}isMetaDataFailed(e){return!(e.title||e.desc||e.thumb)}sanitizeMetaData(e,t){const{maxTitleLength:s,maxDescLength:i}=t,{title:a="",desc:n=""}=e,r=as.e.clone(e);return r.title=G_.truncateWord(a||"",s),r.desc=G_.truncateWord(n||"",i),r}}).instance=null,H_=q_,Object(n_.a)(H_.prototype,"parse",[z_,x_,V_],Object.getOwnPropertyDescriptor(H_.prototype,"parse"),H_.prototype);var W_,Z_,K_,Q_,$_;let Y_=(W_=c_(l_.CLIENT_PARSER,(([e],[t,s],a)=>{i.ModuleContainer.resolve(P_.b).linkParser.zsymb(12,"B1lcCE","ParseLinkMetric",l_[l_.CLIENT_PARSER],e,a);const n={params:[e]};return t||s||(n.success=!1,n.errorCode=__.EMPTY_METADATA),s&&i.ModuleContainer.resolve(r_.b).log({commandId:l_.PREVIEW_INTEGRITY,success:!!s.thumb,params:[e]}),n})),Z_=Reflect.metadata("design:type",Function),K_=Reflect.metadata("design:paramtypes",[String]),($_=class e{constructor(){}static getInstance(){return null===e.instance&&(e.instance=new e),e.instance}isMatchParser(e,t){return!!i.ModuleContainer.resolve(v_.a).get("enable_parse_link_client")&&(null==t?void 0:t.entry)!==f_.a.MESSAGE_WIDGET}async parse(e){const t=i.ModuleContainer.resolve(v_.a),s=t.get("max_redirect"),a=t.get("max_title_character"),n=t.get("max_desc_character"),{enable_log_metric:r}=t.get("debug"),[o,c]=await as.b.catchAsyncFn((()=>B_.b.exec("parseLink",[e,{maxRedirect:s}],{priority:B_.a.HIGH})));b_(!!o,o&&y_.createFromObject(o));const[l,d]=c;if(r){i.ModuleContainer.resolve(P_.b).linkParser.zsymb(12,"SICi9j","ParseLinkMetric",l_[l_.CLIENT_PARSER],"DETAIL",e,{fetch:d.endFetch-d.startFetch,parse:d.endParseMetaData-d.startParseMetaData,total:d.endParseMetaData-d.startFetch,htmlSize:d.htmlSize})}const h=this.sanitizeMetaData(l,{maxTitleLength:a,maxDescLength:n});return this.isMetaDataFailed(h)?null:{typeParse:f_.b.CLIENT,href:Yl.a.getUrlWithHttpProtocol(e),title:h.title,desc:h.desc,thumb:"",thumbOrigin:h.thumb,media:{},src:h.src}}isMetaDataFailed(e){return!(e.title||e.desc||e.thumb)}sanitizeMetaData(e,t){const{maxTitleLength:s,maxDescLength:i}=t,{title:a="",desc:n=""}=e,r=as.e.clone(e);return r.title=G_.truncateWord(a||"",s),r.desc=G_.truncateWord(n||"",i),r}}).instance=null,Q_=$_,Object(n_.a)(Q_.prototype,"parse",[W_,Z_,K_],Object.getOwnPropertyDescriptor(Q_.prototype,"parse"),Q_.prototype),Q_);var J_;Object(i.injectable)()(J_=Object(i.singleton)(a_.a)(J_=Reflect.metadata("design:type",Function)(J_=Reflect.metadata("design:paramtypes",[])(J_=class{constructor(){}getLinkParser(e,t){return U_.getInstance().isMatchParser(e,t)?U_.getInstance():Y_.getInstance().isMatchParser(e,t)?Y_.getInstance():p_.getInstance()}})||J_)||J_)||J_);var X_,eb,tb,sb,ib=s("TQME");class ab{constructor(){}static getInstance(){return ab.instance||(ab.instance=new ab),ab.instance}async process(e){return e}}ab.instance=null;let nb=(X_=c_(l_.DOWNLOAD_THUMB,(([e,t])=>({params:[e,t]}))),eb=Reflect.metadata("design:type",Function),tb=Reflect.metadata("design:paramtypes",[String,Number]),sb=class{async download(e,t=1/0){const[s,i]=await as.b.catchAsyncFn((()=>this.doDownload(e,t)));return b_(!!s,s&&this.transformError(s)),i}async doDownload(e,t){const[s,i]=await $zdownload.downloadThumbTemp(e,t);return b_(s,s),i}transformError(e){return y_.createFromObject(e)}},Object(n_.a)(sb.prototype,"download",[X_,eb,tb],Object.getOwnPropertyDescriptor(sb.prototype,"download"),sb.prototype),sb);class rb{constructor(){this.config=void 0,this.logger=void 0,this.logger=i.ModuleContainer.resolve(P_.b).linkParser,this.config=i.ModuleContainer.resolve(v_.a)}static getInstance(){return rb.instance||(rb.instance=new rb),rb.instance}async process(e){const t=null==e?void 0:e.thumbOrigin;if(t){const s=this.config.get("max_thumb_size"),[i,a]=await as.b.catchAsyncFn((()=>(new nb).download(t,s)));if(i&&this.logger.zsymb(18,"yqRNBP",`Download link failed. Url: ${e.href}. ThumbUrlOrigin: ${t}. Error: ${i}`),a){const t=as.e.clone(e);return t.thumbLocal=a,t}}return e}}rb.instance=null;var ob,cb,lb,db,hb=s("vPsb"),ub=s("1+6A"),gb=s("PTkj");class mb{constructor(e){this.localPath=e}async read(){const e=await $zFileManager.getFileArrayBuffer(this.localPath),t=$znode.path.basename(this.localPath);return new File([e],t)}}class pb{constructor(e){this.localPath=e}async compress(){try{const e=await new mb(this.localPath).read(),{blob:t,width:s,height:i,fileName:a}=await Object(gb.e)(e,e.name),n=this.calcNewSize(s,i),r=await Object(el.a)(t,{quality:.9,width:n.width,height:n.height});return new File([r],a)}catch(e){throw new C_(null==e?void 0:e.message)}}calcNewSize(e,t){const s=U.default.file_photo_limit.width,i=U.default.file_photo_limit.height;let a=e,n=t;return(e>s||t>i)&&(e-s>t-i?(a=s,n=Math.round(s/e*t)):(n=i,a=Math.round(i/t*e))),{width:a,height:n}}}let fb=(ob=c_(l_.UPLOAD_THUMB),cb=Reflect.metadata("design:type",Function),lb=Reflect.metadata("design:paramtypes",[String,String]),db=class{constructor(){}async upload(e,t){const s=i.ModuleContainer.resolve(P_.b).uploadThumb,[a,n]=await as.b.catchAsyncFn((()=>this.doCompress(e)));b_(a,a),s.zsymb(12,"Wh31Cm","Compress done");const[r,o]=await as.b.catchAsyncFn((()=>this.doUpload(n,t)));b_(r,r),s.zsymb(12,"au4koJ","Upload done");const[c,l]=this.transformResponse(o);return b_(c,c),l}async doCompress(e){return await new pb(e).compress()}async doUpload(e,t){try{const s=j_.a.isGroupConv(t),i=j_.a.isE2eeConv(t),a=await na.b.uploadFile({toUid:t,isGroup:s,rawFile:e,clientId:Xi.a.next(),extData:{uploadMainType:ub.c.PhotoThumb,fType:W.FILE_FTYPE.FILE,e2ee:i},feature:ub.a.SendMsg},{},{signalProgress:()=>{}});return i&&hb.b.enrichEncryptUrlV2(a),a}catch(s){throw this.transformUploadError(s)}}transformUploadError(e){const t=new S_(`Error: ${JSON.stringify(e)}.`);return null!=e&&e.stack&&t.setStack(null==e?void 0:e.stack),t}transformResponse(e){var t,s,i,a,n,r,o,c;const l=(null==e||null===(t=e.urlRes)||void 0===t||null===(s=t.fileAsync)||void 0===s?void 0:s.oriUrl)||(null==e||null===(i=e.urlRes)||void 0===i||null===(a=i.fileAsync)||void 0===a?void 0:a.hdUrl)||(null==e||null===(n=e.urlRes)||void 0===n||null===(r=n.fileAsync)||void 0===r?void 0:r.normalUrl)||(null==e||null===(o=e.urlRes)||void 0===o||null===(c=o.fileAsync)||void 0===c?void 0:c.thumbUrl);return l?[null,l]:[new S_(`Cannot get thumbUrl from response. Response ${e}`),null]}},Object(n_.a)(db.prototype,"upload",[ob,cb,lb],Object.getOwnPropertyDescriptor(db.prototype,"upload"),db.prototype),db);class vb{constructor(){this.logger=void 0,this.logger=i.ModuleContainer.resolve(P_.b).linkParser}static getInstance(){return vb.instance||(vb.instance=new vb),vb.instance}async process(e,t){const s=null==e?void 0:e.thumbLocal;if(s){const[i,a]=await as.b.catchAsyncFn((()=>(new fb).upload(s,t)));if(i&&this.logger.zsymb(18,"EWToA8",`Upload link failed. Url: ${e.href}. ConvId: ${t} ThumbUrlLocal: ${s}. Error: ${i}`),a){const t=as.e.clone(e);return t.thumb=a,t}}return e}}var _b;vb.instance=null;Object(i.injectable)()(_b=Object(i.singleton)(ib.a)(_b=class{getDownloadProcessor(e){switch(e){case f_.b.CLIENT:return rb.getInstance();case f_.b.SERVER:default:return ab.getInstance()}}getUploadProcessor(e){switch(e){case f_.b.CLIENT:return vb.getInstance();case f_.b.SERVER:default:return ab.getInstance()}}})||_b);const bb=Object(i.define)("parser-config-event-emitter");i.ModuleContainer.registerFactory(bb,ns.f((()=>new Uc.a)));var yb,Ib=s("LvDl"),Sb=s.n(Ib);Object(i.injectable)()(yb=Object(i.singleton)(v_.b)(yb=function(e,t){return Object(i.inject)(bb)(e,void 0,0)}(yb=Reflect.metadata("design:type",Function)(yb=Reflect.metadata("design:paramtypes",["undefined"==typeof IParserConfigEventEmitter?Object:IParserConfigEventEmitter])(yb=class{constructor(e){this.eventEmitter=e,this.config={}}setConfig(e){this.isConfigChange(e)&&(this.config=this.mergeConfig(e),this.eventEmitter.emit("on-config-change",this.config))}mergeConfig(e){return Object(T.a)(Object(T.a)({},this.config),e)}isConfigChange(e){return!new as.e.Comparer(this.config,e,!0).AND("enable_force_parse_link_server").AND("enable_parse_link_server").AND("enable_parse_link_client").AND("enable_auto_download_thumb").AND("enable_parse_link_receiver").AND("enable_parse_link_sender").AND("enable_upload_thumb_for_delay_send").AND("enable_download_partial_media_e2ee").AND("enable_verify_parse_link_server").AND("enable_show_loading_thumb").AND("white_list_domain",Sb.a.isEqual).AND("white_list_domain_mode").AND("max_time_reparse").AND("max_thumb_size").AND("max_age_cache_preview").AND("max_item_cache").AND("max_url_character").AND("max_title_character").AND("max_desc_character").AND("max_delay_send_message").AND("max_redirect").AND("debug",Sb.a.isEqual).exec()}})||yb)||yb)||yb)||yb);var Cb,Eb=s("XJ/a"),Ob=s("1e0e");const Tb={enable_force_parse_link_server:!0,enable_parse_link_server:!0,enable_parse_link_client:!0,enable_auto_download_thumb:!0,enable_parse_link_receiver:!0,enable_parse_link_sender:!1,enable_upload_thumb_for_delay_send:!1,enable_download_partial_media_e2ee:!0,enable_verify_parse_link_server:!1,enable_show_loading_thumb:!0,white_list_domain:[".zalo.me",".zaloapp.com","s120.avatar.talk.zdn.vn","cover.talk.zdn.vn","qr.talk.zdn.vn","f22.w640.photo.talk.zdn.vn","res-zalo.zadn.vn","vng.com.vn","stg-shop.zalo.me",".zingplay.me","zalopay.vn","kaka.me","api-internal.mp3.zalo","zstudio.io","123c.vn","adtimaserver.vn","adtima.vn","ad.zing.vn","baomoi.com","baomoi.vn","brand.zing.vn","chat-talk.zing.vn","click.123.vn","epi.com.vn","epi.vn","kakaapp.me","laban.vn","lab.zing.vn","mp3.zing.vn","m.zing.vn","news.zing.vn","nhatkyzalo.vn","playzing.vn","plo.com.vn","plo.vn","stc-tv.zing.vn","sukien.net.vn","tachthongtin.com","talk.zing.vn","trithuctructuyen.com.vn","trithuctructuyen.vn","tv.zing.vn","xdn.vn","xone.fm","zagoo.vn","zalo.ai","zalo.careers","zalochat.com","zalo.cx","zalo.gg","zalo.me","zalomusic.com","zalonews.net","zaloplus.vn","zalo-shop.vn","zalo.vn","zamoji.vn","zapps.vn","zavatar.vn","zavi.me","za.zdvn.vn","zdn.vn","zingmp3.com","zingmp3.vn","zingnews.com.vn","zingnews.vn","zingtv.vn","zstudio.io","zaloshop.me","dr.zapps.vn","hc.zalo.me"],white_list_domain_mode:"append",max_time_reparse:Ob.a.timeInMs("24h"),max_thumb_size:T_.sizeInByte("2MB"),max_age_cache_preview:Ob.a.timeInMs("24h"),max_item_cache:300,max_url_character:500,max_title_character:80,max_desc_character:200,max_delay_send_message:Ob.a.timeInMs("2s"),max_redirect:2,debug:{enable_log_metric:!1,delay_parse_client:Ob.a.timeInMs("0s")}};Object(i.injectable)()(Cb=Object(i.singleton)(v_.a)(Cb=Reflect.metadata("design:type",Function)(Cb=Reflect.metadata("design:paramtypes",[])(Cb=class{constructor(){this.config=void 0,this.configValidator=void 0,this.config=Tb,this.configValidator=new Eb.a({enable_force_parse_link_server:Eb.b.field().boolean(),enable_parse_link_server:Eb.b.field().boolean(),enable_parse_link_client:Eb.b.field().boolean(),enable_auto_download_thumb:Eb.b.field().boolean(),enable_parse_link_receiver:Eb.b.field().boolean(),enable_parse_link_sender:Eb.b.field().boolean(),enable_download_partial_media_e2ee:Eb.b.field().boolean(),enable_verify_parse_link_server:Eb.b.field().boolean(),enable_show_loading_thumb:Eb.b.field().boolean(),white_list_domain:Eb.b.field().array("string"),white_list_domain_mode:Eb.b.field().string().oneOf(["append","override"]),max_time_reparse:Eb.b.field().number().min(0),max_thumb_size:Eb.b.field().number().min(0),max_age_cache_preview:Eb.b.field().number().min(0),max_item_cache:Eb.b.field().number().min(0),max_url_character:Eb.b.field().number().min(0),max_title_character:Eb.b.field().number().min(0),max_desc_character:Eb.b.field().number().min(0),max_delay_send_message:Eb.b.field().number().min(0),max_redirect:Eb.b.field().number().min(0),debug:Eb.b.field().object({enable_log_metric:Eb.b.field().boolean(),delay_parse_client:Eb.b.field().number()})})}get(e,t){var s;return null!==(s=this.config[e])&&void 0!==s?s:t}setConfig(e){const t=this.configValidator.validateWithFallback(e,Tb);this.config=Object(T.a)(Object(T.a)(Object(T.a)({},this.config),t),this.mergeWhiteListDomainConfig(t))}mergeWhiteListDomainConfig(e){const t=e.white_list_domain_mode,s=e.white_list_domain,i=this.config.white_list_domain;switch(t){case"append":default:return{white_list_domain:i.concat(s)};case"override":return{white_list_domain:s}}}})||Cb)||Cb)||Cb);i.ModuleContainer.resolve(bb).on("on-config-change",(e=>{i.ModuleContainer.resolve(v_.a).setConfig(e)}));class Mb{constructor(e){this.maxAge=e,this.mapTsItemIsSet=void 0,this.mapTsItemIsSet=new Map}hookBeforeGet(e,t){const s=this.mapTsItemIsSet.get(e);if(!s)return;Date.now()-s>=this.maxAge&&t(e)}hookAfterSet(e){this.mapTsItemIsSet.set(e,Date.now())}hookAfterDelete(e){this.mapTsItemIsSet.delete(e)}hookAfterClear(){this.mapTsItemIsSet.clear()}}class Rb{constructor(e){this.maxItem=e,this.mapTsItemIsVisited=void 0,this.mapTsItemIsVisited=new Map}hookBeforeGet(e){this.mapTsItemIsVisited.set(e,{key:e,ts:Date.now()})}hookAfterSet(e,t){this.mapTsItemIsVisited.set(e,{key:e,ts:Date.now()});let s=Math.max(this.mapTsItemIsVisited.size-this.maxItem,0);if(s>0){Array.from(this.mapTsItemIsVisited.values()).sort(((e,t)=>t.ts>e.ts?-1:0)).slice(0,s).forEach((e=>t(e.key)))}}hookAfterDelete(e){this.mapTsItemIsVisited.delete(e)}hookAfterClear(){this.mapTsItemIsVisited.clear()}}class wb{constructor(...e){this.strategies=void 0,this.repository=void 0,this.repositoryDeadItem=void 0,this.markDeadItem=e=>{const t=this.repository.get(e);t&&(t.isAlive=!1,this.repositoryDeadItem.push(e))},this.strategies=e,this.repository=new Map,this.repositoryDeadItem=[]}get(e){this.beforeGet(e);const t=this.repository.get(e);return t&&t.isAlive?t.value:null}set(e,t){const s={isAlive:!0,key:e,value:t};this.repository.set(e,s),this.afterSet(e)}delete(e){this.repository.delete(e),this.afterDelete(e)}reset(){this.repository.clear(),this.afterClear()}beforeGet(e){this.strategies.forEach((t=>t.hookBeforeGet(e,this.markDeadItem))),this.doGC()}afterSet(e){this.strategies.forEach((t=>t.hookAfterSet(e,this.markDeadItem))),this.doGC()}afterDelete(e){this.strategies.forEach((t=>t.hookAfterDelete(e)))}afterClear(){this.strategies.forEach((e=>e.hookAfterClear()))}doGC(){this.repositoryDeadItem.length&&(this.repositoryDeadItem.forEach((e=>this.delete(e))),this.repositoryDeadItem=[])}}var Lb;Object(i.injectable)()(Lb=Object(i.singleton)(a_.c)(Lb=function(e,t){return Object(i.inject)(v_.a)(e,void 0,0)}(Lb=Reflect.metadata("design:type",Function)(Lb=Reflect.metadata("design:paramtypes",["undefined"==typeof IParserConfigConsumer?Object:IParserConfigConsumer])(Lb=class{constructor(e){this.metaData=void 0,this.thumbLocal=void 0,this.thumbLive=void 0;const t=e.get("max_item_cache"),s=e.get("max_age_cache_preview");this.metaData=new wb(new Rb(t),new Mb(s)),this.thumbLocal=new wb(new Rb(t),new Mb(s)),this.thumbLive=new wb(new Rb(t),new Mb(s))}getKey(e,t){switch(e){case"meta-data":case"thumb-local":{const[e]=t;return Yl.a.removeProtocol(e)}case"thumb-live":{const[e,s=""]=t;return[j_.a.getPrefixConv(s),j_.a.isE2eeConv(s)?"e2ee":"none-e2ee",Yl.a.removeProtocol(e)].join("_")}default:return t.join(".")}}})||Lb)||Lb)||Lb)||Lb);var Fb,Db=s("WOja");Object(i.injectable)()(Fb=Object(i.singleton)(a_.b)(Fb=function(e,t){return Object(i.inject)(P_.b)(e,void 0,0)}(Fb=function(e,t){return Object(i.inject)(a_.c)(e,void 0,1)}(Fb=function(e,t){return Object(i.inject)(a_.a)(e,void 0,2)}(Fb=function(e,t){return Object(i.inject)(v_.a)(e,void 0,3)}(Fb=Reflect.metadata("design:type",Function)(Fb=Reflect.metadata("design:paramtypes",[void 0===P_.IParserLogger?Object:P_.IParserLogger,"undefined"==typeof ILinkPreviewRepository?Object:ILinkPreviewRepository,"undefined"==typeof ILinkParserFactory?Object:ILinkParserFactory,void 0===Db.IParserConfigConsumer?Object:Db.IParserConfigConsumer])(Fb=class{constructor(e,t,s,i){this.repository=t,this.linkParserFactory=s,this.config=i,this.logger=void 0,this.logger=e.linkParser}parse(e){var t;const s=this.repository.getKey("meta-data",[e]);return(null===(t=this.repository.metaData.get(s))||void 0===t?void 0:t.value)||null}async preparseAsync(e,t){await this.parseAsync(e,t)}async parseAsync(e,t){if(!this.config.get("enable_parse_link_client")){const e=(null==t?void 0:t.entry)!==f_.a.SHARE_MESSAGE,s=j_.a.isE2eeConv((null==t?void 0:t.convId)||"");if(e&&s)return null}const s=this.repository.getKey("meta-data",[e]),i=this.repository.metaData.get(s);if(i&&null!==i.value)return i.promise;const a=new as.b.Container;this.repository.metaData.set(s,a);const[n,r]=await as.b.catchAsyncFn((()=>this.linkParserFactory.getLinkParser(e,t).parse(e)));return n&&this.logger.zsymb(18,"i3pYJN",`parse link failed ${n}`),a.resolve(r),a.promise}})||Fb)||Fb)||Fb)||Fb)||Fb)||Fb)||Fb);var Ab;Object(i.injectable)()(Ab=Object(i.singleton)(ib.b)(Ab=function(e,t){return Object(i.inject)(P_.b)(e,void 0,0)}(Ab=function(e,t){return Object(i.inject)(a_.c)(e,void 0,1)}(Ab=function(e,t){return Object(i.inject)(ib.a)(e,void 0,2)}(Ab=Reflect.metadata("design:type",Function)(Ab=Reflect.metadata("design:paramtypes",[void 0===P_.IParserLogger?Object:P_.IParserLogger,"undefined"==typeof ILinkPreviewRepository?Object:ILinkPreviewRepository,"undefined"==typeof IPreviewLinkProcessorFactory?Object:IPreviewLinkProcessorFactory])(Ab=class{constructor(e,t,s){this.repository=t,this.linkProcessorFactory=s,this.logger=void 0,this.logger=e.linkParser}async processDownload(e){var t;const s=this.repository.getKey("meta-data",[e]),i=this.repository.getKey("thumb-local",[e]),a=this.repository.thumbLocal.get(i);if(a&&null!==a.value){if(!a.value)return a.promise;{const e=a.value.thumbLocal;if(e){const[t,s]=await as.b.catchAsyncFn((()=>{var t,s;return null===(t=$znode)||void 0===t||null===(s=t.fsPromise)||void 0===s?void 0:s.stat(e)}));if(!t&&s)return a.promise}}}const n=new as.b.Container;this.repository.thumbLocal.set(i,n);const r=await(null===(t=this.repository.metaData.get(s))||void 0===t?void 0:t.promise)||null,o=await this.linkProcessorFactory.getDownloadProcessor(null==r?void 0:r.typeParse).process(r);return n.resolve(o),n.promise}async processUpload(e,t){var s;const i=this.repository.getKey("thumb-local",[e]),a=this.repository.getKey("thumb-live",[e,t]),n=this.repository.thumbLive.get(a);if(n&&null!==n.value)return n.promise;const r=new as.b.Container;this.repository.thumbLive.set(a,r);const o=await(null===(s=this.repository.thumbLocal.get(i))||void 0===s?void 0:s.promise)||null,c=await this.linkProcessorFactory.getUploadProcessor(null==o?void 0:o.typeParse).process(o,t);return r.resolve(c),r.promise}})||Ab)||Ab)||Ab)||Ab)||Ab)||Ab);var Nb=s("6e5J");class kb{constructor(){}async getDimension(e){const t={key:Date.now(),file:e,srcAction:3},[s,i]=await as.b.catchAsyncFn((()=>Nb.default.getDimension(t)));return b_(s,s&&this.transformError(s)),this.transformResponse(i)}transformError(e){return e}transformResponse(e){return{width:e.width,height:e.height,rotation:e.orientation}}}var Pb=s("8I6r"),jb=s("oSk7"),Ub=s("taJj");class Bb{constructor(){}async download(e){const[t,s]=A.default.parseE2eeProtocol(e),a=new Headers;if(t){let e="unsafe-flush";i.ModuleContainer.resolve(v_.a).get("enable_download_partial_media_e2ee")&&(a.set("Range",`bytes=0-${T_.sizeInByte("64KB")}`),e="safe-flush");const[n,r]=await as.b.catchAsyncFn((()=>fetch(s,{headers:a})));b_(n,n);const o=new jb.a(r.body).pipe(new Ub.a(T_.sizeInByte("1MB"))).pipe(new Gb(new Pb.b(t,"decrypt"),e)).getStream();return await new Response(o,{headers:r.headers}).blob()}a.set("Range",`bytes=0-${T_.sizeInByte("64KB")}`);const[n,r]=await as.b.catchAsyncFn((()=>fetch(e,{headers:a})));return b_(n,n),await r.blob()}}class Gb{constructor(e,t){this.zaes=e,this.modeFlush=t,this.transform=(e,t)=>{const s=this.zaes.update(e);t.enqueue(s)},this.flush=e=>{if("safe-flush"!==this.modeFlush)try{this.zaes.end()}catch(t){e.error(t)}}}}const zb={"image/gif":W.IMAGE_TYPE_GIF,"image/jpg":W.IMAGE_TYPE_JPEG,"image/jpeg":W.IMAGE_TYPE_JPEG,"image/png":W.IMAGE_TYPE_PNG};class xb{constructor(){}static getInstance(){return xb.instance||(xb.instance=new xb),xb.instance}isMatchParser(e){return Object.keys(zb).includes(e)}async parse(e){const[t,s]=await as.b.catchAsyncFn((()=>(new Bb).download(e)));b_(t,t);const[i,a]=await as.b.catchAsyncFn((()=>(new kb).getDimension(s)));return b_(i,i),Object(T.a)(Object(T.a)({},a),{},{type:this.transformType(s)})}transformType(e){return zb[e.type]}}xb.instance=null;class Vb{constructor(){}static getInstance(){return Vb.instance||(Vb.instance=new Vb),Vb.instance}isMatchParser(e){return!0}async parse(e){return null}}Vb.instance=null;const Hb={"application/pdf":W.LINK_TYPE_PDF};class qb{constructor(){}static getInstance(){return qb.instance||(qb.instance=new qb),qb.instance}isMatchParser(e){return Object.keys(Hb).includes(e)}async parse(e){try{const t=A.default.removeE2eeProtocol(e),s=(await fetch(t,{method:"HEAD"})).headers.get("content-length");return null===s?null:{size:Number(s),name:Yl.a.getFileNameFromUrl(e),type:Hb["application/pdf"]}}catch(t){throw t}}}var Wb;qb.instance=null;Object(i.singleton)(a_.d)(Wb=class{async getSizeParser(e){const[t,s]=await as.b.catchAsyncFn((()=>this.tryGetContentType(e)));return t||!s?Vb.getInstance():xb.getInstance().isMatchParser(s)?xb.getInstance():qb.getInstance().isMatchParser(s)?qb.getInstance():Vb.getInstance()}async tryGetContentType(e){if(!Yl.a.isBlobUrl(e)){const[t,s]=await as.b.catchAsyncFn((()=>this.tryGetContentTypeByHead(e)));if(!t)return s}return this.tryGetContentTypeByGet(e)}async tryGetContentTypeByHead(e){const t=A.default.removeE2eeProtocol(e);return(await fetch(t,{method:"HEAD"})).headers.get("content-type")}async tryGetContentTypeByGet(e){const t=A.default.removeE2eeProtocol(e),s=new AbortController,i=await fetch(t,{signal:s.signal});s.abort();return i.headers.get("content-type")}});var Zb;Object(i.injectable)()(Zb=Object(i.singleton)(a_.e)(Zb=function(e,t){return Object(i.inject)(P_.b)(e,void 0,0)}(Zb=function(e,t){return Object(i.inject)(a_.d)(e,void 0,1)}(Zb=Reflect.metadata("design:type",Function)(Zb=Reflect.metadata("design:paramtypes",[void 0===P_.IParserLogger?Object:P_.IParserLogger,"undefined"==typeof ISizeParserFactory?Object:ISizeParserFactory])(Zb=class{constructor(e,t){this.sizeParserFactory=t,this.cache=void 0,this.cacheDedupe=void 0,this.logger=void 0,this.cache=new wb(new Rb(300)),this.logger=e.mediaSizeLogger,this.cacheDedupe=new Map}parse(e){const t=this.getCacheKey(e);return this.cache.get(t)}async preparseAsync(e){await as.b.catchAsyncFn((()=>this.parseAsync(e)))}async parseAsync(e){const t=this.getCacheKey(e),s=this.cache.get(t);if(s)return s;const i=this.cacheDedupe.get(t);if(i)return i;const a=(await this.sizeParserFactory.getSizeParser(e)).parse(e);this.cacheDedupe.set(t,a);const[n,r]=await as.b.catchAsyncFn((()=>a));return this.cacheDedupe.delete(t),b_(null!==n,n),null===r?null:(this.cache.set(t,r),r)}getCacheKey(e){return e}})||Zb)||Zb)||Zb)||Zb)||Zb);var Kb,Qb=s("2fgy"),$b=s("dG4g"),Yb=s("DBGg"),Jb=s("bGlS");Object(ie.b)(Qb.b)(Kb=Object(i.injectable)()(Kb=Reflect.metadata("design:type",Function)(Kb=Reflect.metadata("design:paramtypes",[])(Kb=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.data=void 0,this.name=Qb.a,this.key=Qb.a,this.data={list:new Map,photoViewData:void 0}}initialize(){}destroy(){}async onChangeMessages(e,t){const s={};e.forEach((e=>{if(Object($b.b)(e)){let t=ts.b.isGroupPhoto(e);"number"==typeof t&&(t=t.toString()),e.msgId&&(s[e.msgId]=t||"")}})),await this.getDataFromCache(s,t)}onChangeReactionDataList(e,t,s){const i=(new Date).getTime(),a=i.toString();Object(Zs.i)(a),e.forEach(((e,n)=>{var r;const o=this.data.list.get(n);if((null===(r=this.data.photoViewData)||void 0===r?void 0:r.rMsgId)===n&&(this.data.photoViewData=Object(T.a)(Object(T.a)({},this.data.photoViewData),e),Object(Zs.f)(a,this.name,Jb.a)),!s&&!o)return;const c=Object.keys((null==o?void 0:o.reactions)||{}).length>Object.keys((null==e?void 0:e.reactions)||{}).length,l=!t||Object(Yb.a)(e.reactions)||c?0:i,d=Object(T.a)(Object(T.a)(Object(T.a)({},o),e),{},{lastUpdateEffects:l});this.data.list.set(n,d);const h=null==d?void 0:d.groupPhotoMsgId;h?(this.data.list.set(h,{isGroupPhotoMsg:!0,lastUpdate:i,lastUpdateEffects:l}),Object(Zs.f)(a,this.name,h),Object(Zs.f)(a,this.name,n)):Object(Zs.f)(a,this.name,n)})),Object(Zs.c)(a)}getReactedListFromMessage(e,t){if(t){if(!e.msgId||!this.data.photoViewData)return{};const t=new Map;return t.set(e.msgId,this.data.photoViewData),Object($b.d)(e,t)}return Object($b.d)(e,this.data.list)}removeReactionDataFromList(e){if(!e.msgId)return;const t=this.data.list.get(e.msgId);null!=t&&t.isGroupPhotoMsg&&this.data.list.forEach(((t,s)=>{t.groupPhotoMsgId===e.msgId&&this.data.list.delete(s)})),this.data.list.delete(e.msgId)}async onChangePhotoViewData(e){if(!e.msgId)return;const t=[e.msgId],s=await sn.b.get(t);s&&(this.data.photoViewData=s[e.msgId],Object(Zs.g)(this.name,Jb.a))}removePhotoViewData(){this.data.photoViewData=void 0}async resyncReactionData(){var e;const t={};null!==(e=this.data.photoViewData)&&void 0!==e&&e.rMsgId&&(t[this.data.photoViewData.rMsgId]=""),this.data.list.forEach(((e,s)=>{t[s]=e.groupPhotoMsgId||""})),await this.getDataFromCache(t)}async getDataFromCache(e,t){const s=Object.keys(e),i=await sn.b.get(s);if(!i)return;const a=new Map;for(const n in i)a.set(n,Object(T.a)(Object(T.a)({},i[n]),{},{groupPhotoMsgId:e[n]}));this.onChangeReactionDataList(a,!1,!0),null==t||t(Object.keys(i))}clearData(){this.data.list.clear()}getData(e){return this.data.list.get(e)}getItem(e,t){return e.key===Jb.a?this.data.photoViewData:this.data.list.get(e.key)}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||Kb)||Kb)||Kb);var Xb,ey=s("VhZi");function ty(e){return e||Jb.b.windowId}Object(ie.b)(ey.b)(Xb=Object(i.injectable)()(Xb=Object(i.singleton)()(Xb=Reflect.metadata("design:type",Function)(Xb=Reflect.metadata("design:paramtypes",[])(Xb=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this.name=ey.a,this.key=ey.a}initialize(e){const t=ty(e);ft.ModalManagerV2.addModal({windowId:t,name:Jb.b.name,altWindowId:void 0}),ft.ModalManagerV2.subscribeTriggers({windowId:t,name:Jb.b.name,trigger:e=>{}}),this.data.set(t,{message:void 0})}destroy(e){const t=ty(e);this.data.delete(t),ft.ModalManagerV2.delModal({windowId:t,name:Jb.b.name})}toggleReactionPopup(e,t){const s=ty(e);this.data.set(s,{message:t}),t?ft.ModalManagerV2.openModal(Object(T.a)(Object(T.a)({},Jb.b),{},{windowId:s,params:null})):ft.ModalManagerV2.closeModal(Object(T.a)(Object(T.a)({},Jb.b),{},{windowId:s})),Object(Zs.g)(this.name,s)}getItem(e,t){return this.data.get(e.key)}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||Xb)||Xb)||Xb)||Xb);var sy=s("NmZm"),iy=s("66W5"),ay=s("xU41");var ny;Object(i.injectable)()(ny=Object(i.singleton)()(ny=Object(ie.b)(sy.b)(ny=function(e,t){return Object(i.inject)(B.ZLoggerFactory)(e,void 0,0)}(ny=Reflect.metadata("design:type",Function)(ny=Reflect.metadata("design:paramtypes",[void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory])(ny=class{constructor(e){this.type=void 0,this.key=iy.c,this.name=sy.a,this._chatBoxInputDOMMap=new Map,this._chatBoxInputStateMap=new Map,this._logger=void 0,this._logger=e.createZLogger(Ss.ZLoggerNametags.cbiController,[Ss.ZLoggerNametags.controllCbi])}init(){}getItem(e,t){if((s=e.key)&&s.startsWith(iy.c))return this._getChatBoxInputState(e.key);var s}getList(e,t){return[]}onGetItemFailure(e,t){this._logger.zsymb(21,"APeFTt",["[onGetItemFailure] key: {}, error: {}","zmCQGW"],e,t.message)}onGetListFailure(e,t){this._logger.zsymb(21,"cS0Sme",["[onGetListFailure] key: {}, error: {}","Xtnsbf"],e,t.message)}setChatInputType(e,t,s,i=!0){if(!e||!t)return this._logger.zsymb(21,"ppW5Wn",["[setChatInputType] {} or {} isn't valid!","e7Wkxr"],e,t);if(!s)return this._logger.zsymb(21,"8wRyPD",["[setChatInputType] chatInputType isn't existed!","rvch9T"]);let a=this._getChatBoxInputState(Object(ay.a)(e,t));const n=Object(kt.a)(a,(e=>{e.chatInputType=Object(T.a)({},s)}));this._chatBoxInputStateMap.set(Object(ay.a)(e,t),n),i&&n!==a&&Object(Zs.g)(this.name,Object(ay.a)(e,t))}getChatInputType(e,t){return this._getChatBoxInputState(Object(ay.a)(e,t)).chatInputType}getDefaultChatInputType(){return{name:iy.g.NORMAL,info:{}}}getChatInputTypeInfo(e,t){return this._getChatBoxInputState(Object(ay.a)(e,t)).chatInputType.info}getChatInputTypeName(e,t){return this._getChatBoxInputState(Object(ay.a)(e,t)).chatInputType.name}bindChatInputScroller(e){return t=>{const s=this._getChatBoxInputDOM(e);s.chatInputScroller=t,this._chatBoxInputDOMMap.set(e,s)}}bindChatInputContent(e){return t=>{const s=this._getChatBoxInputDOM(e);s.chatInputContent=t,this._chatBoxInputDOMMap.set(e,s)}}bindChatBoxInputContainer(e){return t=>{const s=this._getChatBoxInputDOM(e);s.chatBoxInputContainer=t,this._chatBoxInputDOMMap.set(e,s)}}getChatInputScroller(e,t){if(e){var s;return null!==(s=this._getChatBoxInputDOM(e).chatInputScroller)&&void 0!==s?s:null==t?void 0:t.document.getElementById(iy.f)}return null}getChatInputContent(e){if(e){return this._getChatBoxInputDOM(e).chatInputContent}return null}getChatBoxInputContainer(e){if(e){return this._getChatBoxInputDOM(e).chatBoxInputContainer}return null}_getChatBoxInputState(e){let t=this._chatBoxInputStateMap.get(e);return t||(t=this._getDefaultChatBoxInputState(),this._chatBoxInputStateMap.set(e,t)),t}_getDefaultChatBoxInputState(){return{chatInputType:this.getDefaultChatInputType()}}_getChatBoxInputDOM(e){let t=this._chatBoxInputDOMMap.get(e);return t||(t=this._getDefaultChatBoxInputDOM(),this._chatBoxInputDOMMap.set(e,t)),t}_getDefaultChatBoxInputDOM(){return{chatBoxInputContainer:null,chatInputScroller:null,chatInputContent:null}}})||ny)||ny)||ny)||ny)||ny);var ry,oy=s("VO3D");const cy=()=>U.default.chat_box_input.use_new_cbi_2023;Object(i.injectable)()(ry=Object(m.d)()(ry=Object(i.singleton)(oy.a)(ry=function(e,t){return Object(i.inject)(B.ZLoggerFactory)(e,void 0,0)}(ry=Reflect.metadata("design:type",Function)(ry=Reflect.metadata("design:paramtypes",[void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory])(ry=class{constructor(e){this._currentFlag=cy(),this._newFlag=cy(),this._prevConvId="",this._isFlagChanged=!1,this._flagChangeListeners=[],this._logger=void 0,this._logger=e.createZLogger(Ss.ZLoggerNametags.auditCBIFlagCoordinator,[Ss.ZLoggerNametags.coordinateAuditCBIFlag]),this._handleUpdateFlag=this._handleUpdateFlag.bind(this)}onApplicationReady(e){this._currentFlag=cy(),this._newFlag=cy(),this._isFlagChanged=!1,this._logger.zsymb(0,"hKPhS7","[onApplicationReady] _currentFlag: ",this._currentFlag),U.$AppConfig.subscribe(this._handleUpdateFlag)}getFlag(){return this._currentFlag}listenConvChange(e){this._logger.zsymb(0,"fKy9oT","[listenConvChange] newConvId: ",e),this._prevConvId&&this._prevConvId===e||this._isFlagChanged&&(this._currentFlag=this._newFlag,this._isFlagChanged=!1,this._notifyFlagChanged()),this._prevConvId=e}addFlagChangeListener(e){return"function"!=typeof e||this._flagChangeListeners.includes(e)?()=>{}:(this._flagChangeListeners.push(e),()=>{this._flagChangeListeners=this._flagChangeListeners.filter((t=>t!==e))})}_handleUpdateFlag(e){const{use_new_cbi_2023:t}=this._getFlagConfig(e);this._logger.zsymb(0,"Gs4rut","[_handleUpdateFlag] newFlag: ",t),t!==this._currentFlag?this._isFlagChanged=!0:this._isFlagChanged=!1,this._newFlag!==t&&(this._newFlag=t)}_getFlagConfig(e){return e.chat_box_input||{}}_notifyFlagChanged(){this._flagChangeListeners.forEach(((e,t)=>{"function"==typeof e&&(this._logger.zsymb(0,"6Ujw0Z","[_notifyFlagChanged] _currentFlag: ",this._currentFlag,t),e(this._currentFlag))}))}})||ry)||ry)||ry)||ry)||ry);var ly=s("/ApO"),dy=s("DIKB"),hy=s("/wiu"),uy=s("WJhq");function gy(e,t){var s,i;const a=null!==(s=t.duration)&&void 0!==s?s:0,n=null!==(i=t.easing)&&void 0!==i?i:"ease",r=t.animId;return e.animate([{height:t.fromHeight},{height:t.toHeight}],{id:r,duration:a,fill:t.fill,easing:n})}var my=s("gn4y");let py=function(e){return e.NORMAL_TO_RTF="normal-to-rtf",e.RTF_TO_NORMAL="rtf-to-normal",e.MINI_TO_EXPAND="mini-to-expand",e.EXPAND_TO_MINI="expand-to-mini",e.RESIZE_WHEN_WINDOW_RESIZE="resize-when-window-resize",e.FADE_IN_RTF_TOOLBAR="fade-in-rtf-toolbar",e.FADE_OUT_RTF_TOOLBAR="fade-out-rtf-toolbar",e}({});var fy,vy=s("dZd7");const _y=new Eg.a(0);Object(i.injectable)()(fy=Object(i.singleton)(ly.a)(fy=function(e,t){return Object(i.inject)(B.ZLoggerFactory)(e,void 0,0)}(fy=Reflect.metadata("design:type",Function)(fy=Reflect.metadata("design:paramtypes",[void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory])(fy=class{constructor(e){this._chatBoxInputAnimsMap=new Map,this._logger=void 0,this._isDevelopment=void 0,this._logger=e.createZLogger(Ss.ZLoggerNametags.cbiAnimationController,[Ss.ZLoggerNametags.manageCBIAnimation]),this._isDevelopment=!1}applyChatInputType(e,t,s){this._isDevelopment&&this._logger.zsymb(0,"KPKCfq","(@=@)! >>>applyChatInputType<<<");const{windowId:i,convId:a,selfWindow:n,hasAnim:r}=s;if(this._isDevelopment&&this._logger.zsymb(3,"EU3G40",["from: {} to: {}","KxKrXV"],JSON.stringify(e),JSON.stringify(t)),hy.e(e,t)){if(hy.d(t))return this.switchNormalModeToRTFMode(i,a,n,r);if(hy.c(t))return this.switchRTFModeToNormalMode(i,a,n,r)}else if(hy.c(e)&&hy.d(t)){if(t.info.mode===iy.h.MINI)return this.switchNormalModeToRTFMode(i,a,n,r);t.info.mode,iy.h.EXPAND}else{if(hy.d(e)&&hy.c(t))return this.switchRTFModeToNormalMode(i,a,n,r);if(hy.d(e)&&hy.d(t)){if(e.info.mode===iy.h.EXPAND&&t.info.mode===iy.h.MINI)return this.switchExpandModeToMiniModeInRTFMode(i,a,n,r);if(e.info.mode===iy.h.MINI&&t.info.mode===iy.h.EXPAND)return this.switchMiniModeToExpandModeInRTFMode(i,a,n,r)}}this._isDevelopment&&this._logger.zsymb(3,"8iWq51",["Do not support this case!","pdy8S9"])}switchNormalModeToRTFMode(e,t,s,i=!0){if(this._isDevelopment&&this._logger.zsymb(0,"i7rLpo","(@=@)! >>>switchNormalModeToRTFMode<<<"),!e||!t)return;const a=null!=s?s:Ki.default.getWindow(e);if(!Object(my.a)(!!a,"window isn't existed."))return;const n=this._getChatInputContainerEl(a);if(!Object(my.a)(!!n,"chatInputContainerEl isn't existed."))return;const r=this._getRTFToolbarEl(a);if(!Object(my.a)(!!r,"rtfToolbarEl isn't existed."))return;const o=()=>{n.classList.add("--rtf-mode","--rtf-mini-mode"),r.classList.add("--visible"),this._chatBoxInputController.setChatInputType(e,t,{name:iy.g.RTF,info:{mode:iy.h.MINI}})};if(this._cancelAllAnimation(e,!0),!i)return o();const c=n.clientHeight,l=Math.round(2*uy.c.PADDING_TOP_BOTTOM+5.5*uy.e+uy.g+uy.b);this._isDevelopment&&this._logger.zsymb(3,"TEkt0B",["heights: {} {}","SLkEM0"],c,l);let d=this._getTransitionDuration(l,c);if(this._isDevelopment&&this._logger.zsymb(3,"D1-MJZ",["duration: {}","C34tWq"],d),d>0){const s=this._getChatInputContentEl(a);if(!Object(my.a)(!!s,"chatInputContentEl isn't existed."))return;const i=s.clientHeight/uy.e>=2;i||n.classList.add("--animate-from-smallest-height"),n.classList.add("--rtf-mode");const o=gy(n,{animId:`${py.NORMAL_TO_RTF}::${_y.next()}`,duration:d,easing:"ease",fromHeight:`${c}px`,toHeight:`${l}px`});this._setAnimationById(e,o.id,o),o.onfinish=()=>{this._isDevelopment&&this._logger.zsymb(3,"38DDPH",["finished: {}","JcdFA3"],o.id),i||n.classList.remove("--animate-from-smallest-height"),n.classList.add("--rtf-mini-mode"),o.cancel()},o.oncancel=()=>{this._isDevelopment&&this._logger.zsymb(3,"tvR4dl",["canceled: {}","QxUFsU"],o.id),i||n.classList.remove("--animate-from-smallest-height"),n.classList.add("--rtf-mini-mode"),this._deleteAnimationById(e,o.id),this._chatBoxInputController.setChatInputType(e,t,{name:iy.g.RTF,info:{mode:iy.h.MINI}})};const h=function(e,t){var s,i,a;const n=t.animId,r=null!==(s=t.duration)&&void 0!==s?s:0,o=null!==(i=t.delay)&&void 0!==i?i:0;return e.animate([{opacity:0},{opacity:1}],{id:n,duration:r,fill:t.fill,delay:o,easing:null!==(a=t.easing)&&void 0!==a?a:"ease"})}(r,{animId:`${py.FADE_IN_RTF_TOOLBAR}::${_y.next()}`,duration:d,easing:"ease"});this._setAnimationById(e,h.id,h),h.onfinish=()=>{this._isDevelopment&&this._logger.zsymb(3,"00WIRU",["finished: {}","JcdFA3"],h.id),r.classList.add("--visible"),h.cancel()},h.oncancel=()=>{this._isDevelopment&&this._logger.zsymb(3,"3nprJQ",["canceled: {}","QxUFsU"],h.id),r.classList.add("--visible"),this._deleteAnimationById(e,h.id)},this._chatBoxInputController.setChatInputType(e,t,{name:iy.g.SWITCHING,info:{inputType:iy.g.RTF,from:iy.g.NORMAL,to:iy.g.RTF}})}else o()}switchRTFModeToNormalMode(e,t,s,i=!0){if(this._isDevelopment&&this._logger.zsymb(0,"hIf4Ix","(@=@)! >>>switchRTFModeToNormalMode<<<"),!e||!t)return;const a=null!=s?s:Ki.default.getWindow(e);if(!Object(my.a)(!!a,"window isn't existed."))return;const n=this._getChatInputContainerEl(a);if(!Object(my.a)(!!n,"chatInputContainerEl isn't existed."))return;const r=this._getRTFToolbarEl(a);if(!Object(my.a)(!!r,"rtfToolbarEl isn't existed."))return;const o=this._getChatBoxInputContainerEl(a);if(!Object(my.a)(!!o,"chatBoxInputContainerEl isn't existed."))return;const c=()=>{n.classList.remove("--rtf-mode","--rtf-mini-mode"),r.classList.remove("--visible"),o.style.height="",this._chatBoxInputController.setChatInputType(e,t,{name:iy.g.NORMAL,info:{}})};if(this._cancelAllAnimation(e,!0),!i)return c();const l=this._getChatInputContentEl(a);if(!Object(my.a)(!!l,"chatInputContentEl isn't existed."))return;const d=l.clientHeight,h=n.clientHeight,u=d/uy.e>=2;let g=uy.c.SMALLEST_HEIGHT_IN_NORMAL,m=!1;u||(n.classList.add("--simple-normal-mode"),m=l.clientHeight/uy.e>=2,n.classList.remove("--simple-normal-mode")),g=u||m?Math.round((d>uy.d.NORMAL.MAX?uy.d.NORMAL.MAX:d)+uy.g+2*uy.c.PADDING_TOP_BOTTOM+uy.b):uy.c.SMALLEST_HEIGHT_IN_NORMAL,this._isDevelopment&&this._logger.zsymb(3,"1Hp-ce",["heights: {} {}","SLkEM0"],h,g);let p=this._getTransitionDuration(g,h);if(this._isDevelopment&&this._logger.zsymb(3,"WT3I0X",["duration: {}","C34tWq"],p),p>0){u||m||n.classList.add("--animate-to-smallest-height"),n.classList.add("--switching-rtf-to-normal-mode"),n.classList.remove("--rtf-mode","--rtf-mini-mode"),r.classList.remove("--visible"),o.style.height="";const s=gy(n,{animId:`${py.RTF_TO_NORMAL}::${_y.next()}`,duration:p,easing:"ease",fromHeight:`${h}px`,toHeight:`${g}px`});this._setAnimationById(e,s.id,s),s.onfinish=()=>{this._isDevelopment&&this._logger.zsymb(3,"Z0JHxV",["finished: {}","JcdFA3"],s.id),n.classList.remove("--switching-rtf-to-normal-mode","--animate-to-smallest-height"),s.cancel()},s.oncancel=()=>{this._isDevelopment&&this._logger.zsymb(3,"OX-qdL",["canceled: {}","QxUFsU"],s.id),n.classList.remove("--switching-rtf-to-normal-mode","--animate-to-smallest-height"),this._chatBoxInputController.setChatInputType(e,t,{name:iy.g.NORMAL,info:{}}),this._deleteAnimationById(e,s.id)};const i=function(e,t){var s,i,a;const n=t.animId,r=null!==(s=t.duration)&&void 0!==s?s:0,o=null!==(i=t.delay)&&void 0!==i?i:0;return e.animate([{opacity:1},{opacity:0}],{id:n,duration:r,fill:t.fill,delay:o,easing:null!==(a=t.easing)&&void 0!==a?a:"ease"})}(r,{animId:`${py.FADE_OUT_RTF_TOOLBAR}::${_y.next()}`,duration:Math.max(p-50,0),easing:"ease-in"});this._setAnimationById(e,i.id,i),i.onfinish=()=>{this._isDevelopment&&this._logger.zsymb(3,"mUZM6v",["finished: {}","JcdFA3"],i.id),i.cancel()},i.oncancel=()=>{this._isDevelopment&&this._logger.zsymb(3,"kfB_sp",["canceled: {}","QxUFsU"],i.id),this._deleteAnimationById(e,i.id)},this._chatBoxInputController.setChatInputType(e,t,{name:iy.g.SWITCHING,info:{inputType:iy.g.NORMAL,from:iy.g.RTF,to:iy.g.NORMAL}})}else c()}switchMiniModeToExpandModeInRTFMode(e,t,s,i=!0){var a,n;if(this._isDevelopment&&this._logger.zsymb(0,"dwpSQM","(@=@)! >>>switchMiniModeToExpandModeInRTFMode<<<"),!e||!t)return;const r=null!=s?s:Ki.default.getWindow(e);if(!Object(my.a)(!!r,"window isn't existed."))return;const o=this._getChatInputContainerEl(r);if(!Object(my.a)(!!o,"chatInputContainerEl isn't existed."))return;const c=this._getRTFToolbarEl(r);if(!Object(my.a)(!!c,"rtfToolbarEl isn't existed."))return;const l=this._getChatBoxInputContainerEl(r);if(!Object(my.a)(!!l,"chatBoxInputContainerEl isn't existed."))return;let d=l.clientHeight,h=Math.round((null!==(a=null===(n=this._getChatViewEl(r))||void 0===n?void 0:n.clientHeight)&&void 0!==a?a:0)*uy.a);const u=()=>{o.classList.replace("--rtf-mini-mode","--rtf-expand-mode"),l.style.height=`${h}px`,this._chatBoxInputController.setChatInputType(e,t,{name:iy.g.RTF,info:{mode:iy.h.EXPAND}})};if(this._cancelAllAnimation(e,!0),!i)return u();d>=h&&(h=d),this._isDevelopment&&this._logger.zsymb(3,"9jYxZM",["heights: {} {}","SLkEM0"],d,h);let g=this._getTransitionDuration(h,d);if(this._isDevelopment&&this._logger.zsymb(3,"p5zFyy",["duration: {}","C34tWq"],g),g>0){this._chatBoxInputController.setChatInputType(e,t,{name:iy.g.SWITCHING,info:{inputType:iy.g.RTF,from:iy.h.MINI,to:iy.h.EXPAND}}),o.classList.replace("--rtf-mini-mode","--rtf-expand-mode");const s=gy(l,{animId:`${py.MINI_TO_EXPAND}::${_y.next()}`,duration:g,fromHeight:`${d}px`,toHeight:`${h}px`});this._setAnimationById(e,s.id,s),s.onfinish=()=>{this._isDevelopment&&this._logger.zsymb(3,"aJ0doj",["finished: {}","JcdFA3"],s.id),l.style.height=`${h}px`,s.cancel()},s.oncancel=()=>{this._isDevelopment&&this._logger.zsymb(3,"5vlaxv",["canceled: {}","QxUFsU"],s.id),l.style.height=`${h}px`,this._deleteAnimationById(e,s.id),this._chatBoxInputController.setChatInputType(e,t,{name:iy.g.RTF,info:{mode:iy.h.EXPAND}})}}else u()}switchExpandModeToMiniModeInRTFMode(e,t,s,i=!0){if(this._isDevelopment&&this._logger.zsymb(0,"DYQep0","(@=@)! >>>switchExpandModeToMiniModeInRTFMode<<<"),!e||!t)return;const a=null!=s?s:Ki.default.getWindow(e);if(!Object(my.a)(!!a,"window isn't existed."))return;const n=this._getChatInputContainerEl(a);if(!Object(my.a)(!!n,"chatInputContainerEl isn't existed."))return;const r=this._getRTFToolbarEl(a);if(!Object(my.a)(!!r,"rtfToolbarEl isn't existed."))return;const o=this._getChatBoxInputContainerEl(a);if(!Object(my.a)(!!o,"chatBoxInputContainerEl isn't existed."))return;const c=()=>{n.classList.replace("--rtf-expand-mode","--rtf-mini-mode"),o.style.height="",this._chatBoxInputController.setChatInputType(e,t,{name:iy.g.RTF,info:{mode:iy.h.MINI}})};if(this._cancelAllAnimation(e,!0),!i)return c();const l=o.clientHeight,d=n.clientHeight,h=Math.round(l-d+uy.d.RTF.MIN+uy.g+2*uy.c.PADDING_TOP_BOTTOM+uy.b);this._isDevelopment&&this._logger.zsymb(3,"39eg7f",["heights: {} {}","SLkEM0"],l,h);let u=this._getTransitionDuration(h,l);if(this._isDevelopment&&this._logger.zsymb(3,"6guBAJ",["duration: {}","C34tWq"],u),u>0){this._chatBoxInputController.setChatInputType(e,t,{name:iy.g.SWITCHING,info:{inputType:iy.g.RTF,from:iy.h.EXPAND,to:iy.h.MINI}});const s=gy(o,{animId:`${py.EXPAND_TO_MINI}::${_y.next()}`,duration:u,fromHeight:`${l}px`,toHeight:`${h}px`});this._setAnimationById(e,s.id,s),s.onfinish=()=>{this._isDevelopment&&this._logger.zsymb(3,"nGFBLi",["finished: {}","JcdFA3"],s.id),n.classList.replace("--rtf-expand-mode","--rtf-mini-mode"),o.style.height="",s.cancel()},s.oncancel=()=>{this._isDevelopment&&this._logger.zsymb(3,"aG0AKG",["canceled: {}","QxUFsU"],s.id),n.classList.replace("--rtf-expand-mode","--rtf-mini-mode"),o.style.height="",this._deleteAnimationById(e,s.id),this._chatBoxInputController.setChatInputType(e,t,{name:iy.g.RTF,info:{mode:iy.h.MINI}})}}else c()}resizeChatBoxInputWhenWindowResize(e,t,s=!0){var i,a;if(this._isDevelopment&&this._logger.zsymb(0,"XUiN2P","(@=@)! >>>resizeChatBoxInputWhenWindowResize<<<"),!e)return;const n=null!=t?t:Ki.default.getWindow(e);if(!Object(my.a)(!!n,"window isn't existed."))return;const r=this._getChatBoxInputContainerEl(n);if(!Object(my.a)(!!r,"chatBoxInputContainerEl isn't existed."))return;const o=r.clientHeight,c=Math.round((null!==(i=null===(a=this._getChatViewEl(n))||void 0===a?void 0:a.clientHeight)&&void 0!==i?i:0)*uy.a),l=()=>{r.style.height=`${c}px`};if(this._cancelAllAnimation(e,!0),!s)return l();this._isDevelopment&&this._logger.zsymb(3,"R6yFcL",["heights: {} {}","SLkEM0"],o,c);let d=this._getTransitionDuration(c,o);if(this._isDevelopment&&this._logger.zsymb(3,"m9GCzi",["duration: {}","C34tWq"],d),d>0){const t=gy(r,{animId:`${py.RESIZE_WHEN_WINDOW_RESIZE}::${_y.next()}`,duration:d,fromHeight:`${o}px`,toHeight:`${c}px`});this._setAnimationById(e,t.id,t),t.onfinish=()=>{this._isDevelopment&&this._logger.zsymb(3,"9yfUaF",["finished: {}","JcdFA3"],t.id),r.style.height=`${c}px`,t.cancel()},t.oncancel=()=>{this._isDevelopment&&this._logger.zsymb(3,"_f2uvy",["canceled: {}","QxUFsU"],t.id),r.style.height=`${c}px`,this._deleteAnimationById(e,t.id)}}else l()}get _chatBoxInputController(){return i.ModuleContainer.resolve(dy.b)}_getChatInputContainerEl(e){return e.document.getElementById(iy.d)}_getRTFToolbarEl(e){return e.document.getElementById(iy.i)}_getChatBoxInputContainerEl(e){return e.document.getElementById(iy.b)}_getChatInputContentEl(e){return e.document.getElementById(iy.f)}_getChatViewEl(e){return e.document.getElementById(uy.f)}_getTransitionDuration(e=0,t=0){if(!e||e<=0||!t||t<=0)return 0;const s=Object(vy.a)(),i=Math.abs(e-t);return i<=1?0:Math.round(s*Math.log(i))}_getAnimationById(e,t){const s=this._chatBoxInputAnimsMap.get(e);if(s)return s[t]}_setAnimationById(e,t,s){if(!e||!t||!s)return;let i=this._chatBoxInputAnimsMap.get(e);i||(i={}),i[t]=s,this._chatBoxInputAnimsMap.set(e,i)}_deleteAnimationById(e,t){const s=this._chatBoxInputAnimsMap.get(e);s&&(delete s[t],this._chatBoxInputAnimsMap.set(e,s))}_cancelAnimation(e,t,s=!1){let i=this._chatBoxInputAnimsMap.get(e);if(!i)return;i=Object(T.a)({},i);const a=i[t];a&&(a.cancel(),s&&(delete i[t],this._chatBoxInputAnimsMap.set(e,i)))}_cancelAllAnimation(e,t=!1){const s=this._chatBoxInputAnimsMap.get(e);if(s&&0!==Object.keys(s).length){for(const e in s){var i;if(s[e])null===(i=s[e])||void 0===i||i.cancel(),t&&delete s[e]}this._chatBoxInputAnimsMap.set(e,s)}}})||fy)||fy)||fy)||fy);var by,yy=s("CkSj"),Iy=s("uUhV"),Sy=s("I9t9"),Cy=s("XoGZ");Object(i.singleton)(Iy.a)(by=Reflect.metadata("design:type",Function)(by=Reflect.metadata("design:paramtypes",[])(by=class{constructor(){this._chatBoxToolbarButtonsMap=new Map,this._registerChatBoxToolbarButtons()}_registerChatBoxToolbarButtons(){this._chatBoxToolbarButtonsMap.set(yy.b.SEND_STICKER_ITEM,(e=>ut.a.createElement(Sy.r,e))),this._chatBoxToolbarButtonsMap.set(yy.b.PICK_PHOTO_ITEM,(e=>ut.a.createElement(Sy.l,e))),this._chatBoxToolbarButtonsMap.set(yy.b.PICK_FILE_ITEM,(e=>ut.a.createElement(Sy.j,e))),this._chatBoxToolbarButtonsMap.set(yy.b.SCREEN_CAPTURE_ITEM,(e=>ut.a.createElement(Sy.n,e))),this._chatBoxToolbarButtonsMap.set(yy.b.SCREEN_CAPTURE_OPTIONS_ITEM,(e=>ut.a.createElement(Sy.p,e))),this._chatBoxToolbarButtonsMap.set(yy.b.SHARE_CONTACT_ITEM,(e=>ut.a.createElement(Sy.s,e))),this._chatBoxToolbarButtonsMap.set(yy.b.CREATE_REMINDER_ITEM,(e=>ut.a.createElement(Sy.d,e))),this._chatBoxToolbarButtonsMap.set(yy.b.CREATE_TODO_ITEM,(e=>ut.a.createElement(Sy.e,e))),this._chatBoxToolbarButtonsMap.set(yy.b.TOGGLE_RTF_MODE_ITEM,(e=>ut.a.createElement(Sy.u,e))),this._chatBoxToolbarButtonsMap.set(yy.b.MARK_IMPORTANT_MESSAGE_ITEM,(e=>ut.a.createElement(Sy.g,e))),this._chatBoxToolbarButtonsMap.set(yy.b.QUICK_MESSAGE_ITEM,(e=>ut.a.createElement(Cy.a,{conversationId:e.convId}))),this._chatBoxToolbarButtonsMap.set(yy.b.MORE_ITEM,(e=>ut.a.createElement(Sy.h,e)))}getChatBoxToolbarButton(e){return this._chatBoxToolbarButtonsMap.get(e)}})||by)||by);var Ey,Oy=s("RPT1"),Ty=s("TsEa"),My=s("Y25x"),Ry=s("7fvu");Object(ie.b)(Oy.b)(Ey=function(e,t){return Object(i.inject)(B.ZLoggerFactory)(e,void 0,0)}(Ey=Reflect.metadata("design:type",Function)(Ey=Reflect.metadata("design:paramtypes",[void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory])(Ey=class{constructor(e){this.type=void 0,this.key=Ry.a,this.name=Oy.a,this._chatBoxCommandUIStateMap=new Map,this._isSupportCommandModeMap=new Map,this._logger=void 0,this._logger=e.createZLogger(Ss.ZLoggerNametags.cbiCommandController,[Ss.ZLoggerNametags.cbiCommandMode])}init(){}getItem(e,t){if(!e.key)return;const s=this._chatBoxCommandUIStateMap.get(e.key);if(s)return s;if(Object(My.b)(e.key)){const t=this._initDefaultState();return this._chatBoxCommandUIStateMap.set(e.key,t),t}}getList(e,t){return[]}onGetItemFailure(e,t){this._logger.zsymb(21,"MzFPFu",["[onGetItemFailure] key: {}, error: {}","zmCQGW"],e,t.message)}onGetListFailure(e,t){this._logger.zsymb(21,"ggBr1J",["[onGetListFailure] key: {}, error: {}","Xtnsbf"],e,t.message)}getChatBoxCommandModeOfConv(e){if(!e){const t=`[getChatBoxCommandModeOfConv] ${e} is invalid!`;return this._logger.zsymb(18,"DavwBz",t),-1}let t=this._chatBoxCommandUIStateMap.get(Object(My.a)(e));return t||(t=this._initDefaultState(),this._chatBoxCommandUIStateMap.set(Object(My.a)(e),t)),t.currentMode}setNewChatBoxCommandModeOfConv(e,t){if(!t){const e=`[setNewChatBoxCommandModeOfConv] ${t} is invalid!`;return void this._logger.zsymb(18,"ZcqssN",e)}let s=this._chatBoxCommandUIStateMap.get(Object(My.a)(t));s||(s=this._initDefaultState());let i=Object(kt.a)(s,(t=>{t.currentMode=e}));i!==s&&(this._chatBoxCommandUIStateMap.set(Object(My.a)(t),i),Object(Zs.g)(this.name,Object(My.a)(t)))}resetChatBoxCommandModeToNormalModeOfConv(e){this.setNewChatBoxCommandModeOfConv(Ty.b.NORMAL,e)}getPlaceholderOfMode(e){if(!e||-1===e)return"";const t=Ty.c[e];return t.hasOwnProperty("placeholder")&&t.placeholder?t.placeholder:""}_initDefaultState(){return{currentMode:Ty.b.NORMAL}}})||Ey)||Ey)||Ey);var wy=s("u/Xa"),Ly=s("0EGn"),Fy=s("ETgL"),Dy=s("uP4a"),Ay=s("xHgQ"),Ny=s("3/Az");const ky="ROTATE_LEFT",Py="ROTATE_RIGHT";var jy,Uy,By,Gy,zy,xy,Vy,Hy,qy,Wy,Zy,Ky,Qy=s("pr8J");const $y={conversationId:"",showSlider:!0,items:[],selectedId:null,hasOlder:!0,hasNewer:!0,entry:Ny.i.Unknown};jy=Object(i.injectable)(),Uy=Object(ie.b)(wy.b),By=Reflect.metadata("design:type",Function),Gy=Reflect.metadata("design:paramtypes",[]),zy=function(e,t,s){const i=s.value;return s.value=async function(...e){const t=this.onFunctionDone||function(){};try{const s=await i.apply(this,e);return t(),s}catch(s){throw t(),s}},s},xy=Reflect.metadata("design:type",Function),Vy=Reflect.metadata("design:paramtypes",[void 0===Qy.LoadConfig?Object:Qy.LoadConfig,String,Boolean]),Hy=function(e,t,s){const i=s.value;return s.value=async function(...e){const t=this.onFunctionDone||function(){};try{const s=await i.apply(this,e);return t(),s}catch(s){throw t(),s}},s},qy=Reflect.metadata("design:type",Function),Wy=Reflect.metadata("design:paramtypes",[void 0===Qy.LoadConfig?Object:Qy.LoadConfig]),jy(Zy=Uy(Zy=By(Zy=Gy((Ky=class{constructor(){this._runningTasks=new Map,this._eventEmitter=new jl.a,this._abortedTask=new Set,this.dispose=()=>{this._runningTasks.forEach((e=>e.abort())),this._runningTasks.clear(),this._abortedTask.clear(),this._eventEmitter.removeAllListeners(),i.ModuleContainer.resolve(kl.b).removeActiveWindowContext()},this.toggleSlider=e=>{this.ensureInitState(e);let t=this.data.get(e);t=Object(T.a)(Object(T.a)({},t),{},{showSlider:!t.showSlider}),this.data.set(e,t),this._signalRenderItem(this.name,e)},this.ensureInitState=(e,t=!0)=>{this.data.get(e)||(this.data.set(e,Object(T.a)(Object(T.a)({},$y),{},{conversationId:e})),t||this._signalRenderItem(this.name,e))},this.getSelectedItem=e=>{const t=this.data.get(e);if(!t)return null;const s=t.selectedId;if(!s)return null;return t.items.find((e=>e.msgId===s||(null==e?void 0:e.fakeMsgId)===s))},this.manualDownload=(e,t,s,i)=>{$.a.emitWithKey(Y.d.userOnNewDeviceTracking,Y.d.mediaDownload);const a=this.getSelectedItem(s);if(Object(Jc.a)(!!a,`imageViewer: download item not found for ${s} ${i}`),fe.default.logActionPhotoViewer(1830904),Object(tl.a)()){const e=A.default.getConversationType(s);let t=new Dy.c(Dy.a.PhotoView).getBuilder().withMode(Dy.e.Manual).withConvType(Dy.b[e]).withType(Dy.f.Photo).withCode(Dy.d.PTVButton);a.constructor===String?mc.a.run({entry:t.build(),type:mc.a.constants.DownloadType.Photo,data:{url:a,msgId:Date.now()+""},options:{saveAs:!0,srcAction:mc.a.constants.srcAction.Manual,duplicate:!1,showProgress:{taskBar:!1,showProgress:!1}}}):((null==a?void 0:a.subType)==W.MSG_VIDEO&&t.withType(Dy.f.Video),mc.a.runByMsg(a,{entry:t.build(),options:{saveAs:!0,srcAction:mc.a.constants.srcAction.Manual,duplicate:!1,showProgress:{taskBar:!1,showProgress:!1}}}))}else{var n,r;const s="string"==typeof a?a:null!=a&&null!==(n=a.message)&&void 0!==n&&n.href?a.message.href:null==a||null===(r=a.message)||void 0===r?void 0:r.oriUrl;Object(Ay.a)(e,t.document,void 0,void 0,s,!1,{msgType:null==a?void 0:a.msgType})}},this.resetShowSlider=e=>{const t=this.data.get(e);t&&(this.data.set(e,Object(T.a)(Object(T.a)({},t),{},{showSlider:!0})),this._signalRenderItem(this.name,e))},this._signalRenderItem=(...e)=>{Object(Zs.g)(...e)},this._abortRunningTasks=(e,t=(()=>!1))=>{Array.from(this._runningTasks.keys()).filter((s=>s.startsWith(e)&&!t(s))).forEach((e=>{const t=this._runningTasks.get(e);null==t||t.abort(),this._runningTasks.delete(e),this._abortedTask.add(e)}))},this._isValidMessage=e=>(null==e?void 0:e.msgType)!==W.MSG_UNDO,this._filterDuplicatedImages=e=>{let t=new Map;return e.reduce(((e,s)=>{if(!s)return e;if(null==s.cliMsgId||null==s.fromUid){if(s.msgType&&!isNaN(s.msgType)){let t=+s.msgType;if(t<=0||[W.MSG_TODO,W.MSG_TODO_DONE,W.MSG_FRIEND_SENT_REQUEST,W.MSG_SUGGEST_IN_CHAT].includes(t))return e.push(s),e}return e.push(s),e}const i=`${s.cliMsgId}_${s.fromUid}`,a=`[${i}]|[${s.msgId}][${s.sendDttm}|${s.src}]`;if(t.has(i)){const{msg:a}=t.get(i);return a.src===W.MSG_SRC.SYNC_MOBILE_DB&&(s.fakeMsgId=a.msgId,Object.assign(a,s)),e}return t.set(i,{data:a,msg:s}),e.push(s),e}),[])},this._eventBusHandler=(e,t)=>{},this.name=wy.a,this.data=new Map,this.key="conversationId",this.init()}on(e,t){return this._eventEmitter.on(e,t),()=>this._eventEmitter.off(e,t)}off(e,t){this._eventEmitter.off(e,t)}emit(e,t){switch(e){case ky:{const e=null==t?void 0:t.mediaId;Object(Jc.a)("string"==typeof e,"payload must be an object with mediaId property"),i.ModuleContainer.resolve(kl.b).rotateMedia(e,-90);break}case Py:{const e=null==t?void 0:t.mediaId;Object(Jc.a)("string"==typeof e,"payload must be an object with mediaId property"),i.ModuleContainer.resolve(kl.b).rotateMedia(e,90);break}default:this._eventEmitter.emit(e,t)}}undoDeleteMulti(e,t){const s=this.data.get(e);if(!s||!t.length)return;const i=[...s.items,...t];let a=this._filterDuplicatedImages(i.sort(((e,t)=>+e.sendDttm-+t.sendDttm)));a=this._filterDeletingMessages(e,a),this.data.set(e,Object(T.a)(Object(T.a)({},s),{},{items:a})),this._signalRenderItem(this.name,e)}removeItem(e,t){var s;const i=this.data.get(e);if(!i||!t)return;let a=i.items.findIndex((e=>e.msgId===i.selectedId));const n=i.items.filter((e=>e.msgId!==t.msgId));a=Math.min(a,n.length-1);const r=null===(s=n[a])||void 0===s?void 0:s.msgId;this.data.set(e,Object(T.a)(Object(T.a)({},i),{},{items:n,selectedId:r})),0===n.length&&this.emit("CLOSE_VIEWER",{conversationId:e}),this._signalRenderItem(this.name,e)}removeMulti(e,t){var s;const i=this.data.get(e);if(!i||!t.length)return;let a=i.items.findIndex((e=>e.msgId===i.selectedId));const n=i.items.filter((e=>!t.includes(e.msgId)));a=Math.min(a,n.length-1);const r=null===(s=n[a])||void 0===s?void 0:s.msgId;this.data.set(e,Object(T.a)(Object(T.a)({},i),{},{items:n,selectedId:r})),0===n.length&&this.emit("CLOSE_VIEWER",{conversationId:e}),this._signalRenderItem(this.name,e)}async loadSlider(e){const{conversationId:t}=e;Object(Jc.a)("string"==typeof t,"conversationId must be provided");try{await this._refreshSliderData(e)}catch(s){}}async loadMore(e,t,s){const{conversationId:i,entry:a,isMessageConv:n}=e;Object(Jc.a)("string"==typeof i&&i.length>0,`conversationId must be provided. Got ${i}`),Object(Jc.a)("backward"===t||"forward"===t,`direction must be backward or forward. Got ${t}`);const r=this.data.get(i);if(Object(Jc.a)(!!r,"imageViewer: load more failed. SliderState must be initialized"),"backward"===t){let t=r.hasOlder||s;if(!t)return;const c=`${i}-${a}-backward`;var o;if(this._abortRunningTasks(i,(e=>e!==c)),this._runningTasks.has(c))return void(await(null===(o=this._runningTasks.get(c))||void 0===o?void 0:o.promise));this.onFunctionDone=()=>{this._runningTasks.delete(c),this._abortedTask.delete(c)};const l=ql(this._loadMore,{conversationId:i,limit:20,message:r.items[0],options:{backward:!0,forward:!1,isMessageConv:n}});this._runningTasks.set(c,l);let d=await l.promise;if(this._abortedTask.has(c))return void this._abortedTask.delete(c);e.isMessageConv&&(d=d.result||d);const h=d;let u=this._filterDuplicatedImages([...h,...r.items]);u=this._filterDeletingMessages(i,u),t=h.length>0,this.data.set(i,Object(T.a)(Object(T.a)({},r),{},{items:u,hasOlder:t})),this._signalRenderItem(this.name,i)}else{let t=r.hasNewer||s;if(!t)return;const o=`${i}-${a}-forward`;var c;if(this._abortRunningTasks(i,(e=>e!==o)),this._runningTasks.has(o))return void(await(null===(c=this._runningTasks.get(o))||void 0===c?void 0:c.promise));this.onFunctionDone=()=>{this._runningTasks.delete(o)};const l=ql(this._loadMore,{conversationId:i,limit:20,message:r.items[r.items.length-1],options:{backward:!1,forward:!0,isMessageConv:n}});this._runningTasks.set(o,l);let d=await l.promise;if(this._abortedTask.has(o))return void this._abortedTask.delete(o);e.isMessageConv&&(d=d.result||d);const h=d;let u=this._filterDuplicatedImages([...r.items,...h]);u=this._filterDeletingMessages(i,u),t=h.length>0,this.data.set(i,Object(T.a)(Object(T.a)({},r),{},{items:u,hasNewer:t})),this._signalRenderItem(this.name,i)}}selectPreviousItem(e){const t=this.data.get(e);Object(Jc.a)(!!t,"imageViewer: select previous item failed. SliderState must be initialized");const s=t.items.findIndex((e=>e.msgId===t.selectedId||(null==e?void 0:e.fakeMsgId)===t.selectedId));if(0===s||!t.items.length)return;const i=t.items[s-1],a=i.msgId;i.cliMsgId,i.fromUid;this.data.set(e,Object(T.a)(Object(T.a)({},t),{},{selectedId:a})),this._signalRenderItem(this.name,e)}selectNextItem(e){const t=this.data.get(e);Object(Jc.a)(!!t,"imageViewer: select next item failed. SliderState must be initialized");const s=t.items.findIndex((e=>e.msgId===t.selectedId||(null==e?void 0:e.fakeMsgId)===t.selectedId));if(s===t.items.length-1||!t.items.length)return;const i=t.items[s+1],a=i.msgId;i.cliMsgId,i.fromUid;this.data.set(e,Object(T.a)(Object(T.a)({},t),{},{selectedId:a})),this._signalRenderItem(this.name,e)}selectItem(e,t){const s=this.data.get(e);Object(Jc.a)(!!s,"imageViewer: select item failed. SliderState must be initialized"),this.data.set(e,Object(T.a)(Object(T.a)({},s),{},{selectedId:t})),this._signalRenderItem(this.name,e)}reset(e){Array.from(this._runningTasks.keys()).filter((t=>t.startsWith(e))).forEach((e=>{const t=this._runningTasks.get(e);null==t||t.abort(),this._runningTasks.delete(e)})),this._abortedTask.clear(),this.data.has(e)&&this.data.delete(e)}_secureSliderState(e){var t;let{conversationId:s,selectedId:i,defaultItems:a,entry:n}=e,r=this.data.get(e.conversationId);const o=null===(t=r)||void 0===t?void 0:t.items.some((e=>e.msgId===i||e.fakeMsgId===i));let c=!0;if(e.disableLoadMore)return n===Ny.i.Profile&&(a=a.slice().reverse()),r=Object(T.a)(Object(T.a)({},$y),{},{conversationId:s,items:a,selectedId:i,showSlider:!0,hasOlder:!1,hasNewer:!1,entry:e.entry}),this.data.set(e.conversationId,r),this._signalRenderItem(this.name,s),c;const l=this._filterDeletingMessages(s,a);return r&&o?i!==r.selectedId&&(r=Object(T.a)(Object(T.a)({},r),{},{selectedId:i,entry:e.entry}),c=!1):(r=Object(T.a)(Object(T.a)({},$y),{},{conversationId:s,items:l,selectedId:i,showSlider:!0,hasOlder:!0,hasNewer:!0,entry:e.entry}),c=!1),c||(this.data.set(e.conversationId,r),this._signalRenderItem(this.name,s)),c}async _refreshSliderData(e){const{conversationId:t,selectedId:s,isMessageConv:i,entry:a,defaultItems:n}=e;let r=this._secureSliderState(e);if(e.disableLoadMore)return;let o=this.data.get(e.conversationId);const c=o.items.findIndex((e=>e.msgId===s||e.fakeMsgId===s)),l=o.items[c],d=`${t}-${a}-${s}`;this._abortRunningTasks(t);let h=o.hasOlder,u=o.hasNewer;const g=c<10&&h,m=c>=o.items.length-10&&u;if(!g&&!m)return void(r||this._signalRenderItem(this.name,t));this.onFunctionDone=()=>{this._runningTasks.delete(d),this._abortedTask.delete(d)};const p=async t=>{const s=ql(this._loadMore,t);this._runningTasks.set(d,s);let i=await s.promise;if(e.isMessageConv&&(i=i.result||i),!this._abortedTask.has(d))return i;this._abortedTask.delete(d)};if(g){const e={conversationId:t,limit:10,message:l,options:{backward:!0,forward:!1,isMessageConv:i}},a=await p(e),n=this.data.get(t),o=n.items;let c=this._filterDuplicatedImages([...a,...o]);c=this._filterDeletingMessages(t,c),0==a.length&&(h=!1),this.data.set(t,Object(T.a)(Object(T.a)({},n),{},{selectedId:s,items:c,hasOlder:h,hasNewer:u})),r=!1}if(m){const e={conversationId:t,limit:10,message:l,options:{backward:!1,forward:!0,isMessageConv:i}},a=await p(e),n=this.data.get(t),o=n.items;let c=this._filterDuplicatedImages([...o,...a]);c=this._filterDeletingMessages(t,c),0==a.length&&(u=!1),this.data.set(t,Object(T.a)(Object(T.a)({},n),{},{selectedId:s,items:c,hasOlder:h,hasNewer:u})),r=!1}r||this._signalRenderItem(this.name,t)}async _loadMore(e){const{conversationId:t,message:s,limit:a,options:{forward:n=!0,backward:r=!1,filter:o=null,isMessageConv:c=!1}={}}=e,l=s.msgId;if(!1===c){let e;try{e=await i.ModuleContainer.resolve(Ly.a).getImageMessagesForPhotoViewer(t,l,a,n,r,o)}catch(d){}const s=Fy.b.getOneBannedGroup(t);return s&&(e=Fy.b.filterBannedMediaGroup(s.groupId,e)),e}return await _t.default.getImagesForPhotoViewerFromMessage(s.toUid||t,s.sendDttm,l,a,n,r)}_filterDeletingMessages(e,t){return t.filter((t=>!es.d.isDeleteMessage(e,t)&&this._isValidMessage(t)))}listenEvents(){N.default.subscribe(this._eventBusHandler)}init(){this.listenEvents()}getItem(e){return this.data.get(e.key)}getList(e){return"all"===e.key?Array.from(this.data.keys()):[]}onGetItemFailure(e){}onGetListFailure(e){}},Object(n_.a)(Ky.prototype,"loadMore",[zy,xy,Vy],Object.getOwnPropertyDescriptor(Ky.prototype,"loadMore"),Ky.prototype),Object(n_.a)(Ky.prototype,"_refreshSliderData",[Hy,qy,Wy],Object.getOwnPropertyDescriptor(Ky.prototype,"_refreshSliderData"),Ky.prototype),Zy=Ky))||Zy)||Zy)||Zy);var Yy=s("DRxf"),Jy=s("ftrm"),Xy=s("pDj3");const eI="zcloud-status-service",tI=Object(i.define)(eI),sI="zcloud-key-service",iI=Object(i.define)(sI),aI="zcloud-plan-service-key",nI=Object(i.define)(aI);var rI=s("2T8k"),oI=s("nTk7"),cI=s("/1VS");const lI=Object(i.define)("zcloud-status-manager");let dI=function(e){return e[e.ADD_CLOUDS=0]="ADD_CLOUDS",e[e.REMOVE_CLOUDS=1]="REMOVE_CLOUDS",e[e.ADD_TEMP_CLOUDS=2]="ADD_TEMP_CLOUDS",e[e.REMOVE_THREAD=3]="REMOVE_THREAD",e}({});class hI extends oI.a{constructor(e){super(),this.numberOfRunningTasks=void 0,this.queue=void 0,this.queue=e,this.numberOfRunningTasks=0}get cloudDataManager(){return cI.a}get controller(){return i.ModuleContainer.resolve(vp.c)}get openedConvs(){const e=Ki.default.getAllCurrentOpens();if(!e||0===e.length)return[];let t=e.map((e=>e===yt.c?i.ModuleContainer.resolve(Ks.SidebarController).getCurrMainConvId():Ki.default.getConvIdFromWindowId(e)));return t=t.filter((e=>!!e)),t}get inInCloudOrZCloudView(){return[kf.b.MEDIA_TYPE,kf.b.CONVERSATION,kf.b.MY_CLOUD].includes(i.ModuleContainer.resolve(Ef.b).getCurrentView())}calculateFromAddClouds(e){if(this.inInCloudOrZCloudView||(e=vp.d.filterCloudItemsStatus(this.openedConvs,e)),!e.length)return null;const t={},s=this.cloudDataManager.checkUpgraded()?null:{hasInvalidKey:!0};for(const i of e)if(i){const e=s,a=vp.d.transferCloudItemRes(!0,i,e),n=Object(vp.p)(i);n&&a&&(t[n]={personalCloud:a})}return t}calculateFromRemoveZCloudKeys(e){const t={};for(const s of e)if(s){s&&(t[s]={personalCloud:void 0})}return t}calculateFromTempClouds(e){if(this.inInCloudOrZCloudView||(e=vp.d.filterCloudItemsStatus(this.openedConvs,e)),!e.length)return null;const t={},s=this.cloudDataManager.checkUpgraded()?null:{hasInvalidKey:!0};for(const i of e)if(i){const e=i.msgInfo.isE2EE?null:s,a=vp.d.transferCloudItemRes(!1,i,e),n=Object(vp.p)(i);n&&a&&(t[n]={personalCloud:a})}return t}async run(){for(;this.queue.length>0&&this.numberOfRunningTasks<1;){const e=this.queue.shift();if(!e)break;this.numberOfRunningTasks++;const{data:t,resolve:s,reject:i}=e,{clouds:a=[],removeZCloudKeys:n=[],pCloudUpdate:r,updateSource:o}=t;let c=null;switch(o){case dI.ADD_CLOUDS:c=this.calculateFromAddClouds(a);break;case dI.ADD_TEMP_CLOUDS:c=this.calculateFromTempClouds(a);break;case dI.REMOVE_CLOUDS:c=this.calculateFromRemoveZCloudKeys(n)}c&&this.controller.onZCloudStatus(c),r&&this.controller.onZCloudStatus(r),s(),await new Promise((e=>setTimeout(e,100))),this.numberOfRunningTasks--,this.run()}}}const uI=[],gI=new oI.b(uI),mI=new hI(uI),pI=new class{constructor(e,t){this.provider=void 0,this.consumer=void 0,this.provider=e,this.consumer=t}splitIntoBatches(e,t){const s=[];for(let i=0;i<e.length;i+=t)s.push(e.slice(i,i+t));return s}async calculateStatus(e){const{clouds:t=[],removeZCloudKeys:s=[],pCloudUpdate:i,updateSource:a}=e,n=new Promise(((e,n)=>{const r={data:{clouds:t,removeZCloudKeys:s,pCloudUpdate:i,updateSource:a},resolve:e,reject:n};this.provider.send(r),this.consumer.run()}));return n.catch((()=>{})).finally((()=>{})),n}async syncStatus(e,t=!1){if(t)this.calculateStatus({pCloudUpdate:e});else for(const s in e){const t={};t[s]=e[s],this.calculateStatus({pCloudUpdate:t})}}}(gI,mI);i.ModuleContainer.registerValue(lI,pI);var fI,vI=pI;let _I=Object(m.d)()(fI=Object(i.injectable)()(fI=function(e,t){return Object(i.inject)(Xy.a)(e,void 0,0)}(fI=function(e,t){return Object(i.inject)(tI)(e,void 0,1)}(fI=function(e,t){return Object(i.inject)(iI)(e,void 0,2)}(fI=function(e,t){return Object(i.inject)(nI)(e,void 0,3)}(fI=Reflect.metadata("design:type",Function)(fI=Reflect.metadata("design:paramtypes",[void 0===Xy.a?Object:Xy.a,void 0===tI?Object:tI,void 0===iI?Object:iI,void 0===nI?Object:nI])(fI=class{get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger(Ss.ZLoggerNametags.zCloud,[Ss.ZLoggerNametags.zCloudStatusController])),this._Logger}constructor(e,t,s,i){this.metrics=e,this.statusService=t,this.keyService=s,this.planService=i,this.name=void 0,this.key=void 0,this._Logger=void 0,this.name=Yy.a,this.key=Yy.a}onApplicationReady(){}onBizConfigReady(){if(!Object(Jy.a)().isEnableUserPCloud())return this.Logger.zsymb(3,"EW7NKX",["requestRSAKey but no permission!","AMigbC"]),void this.keyService.removeRSAKey();this.metrics.setGetKeyAfterLoginTime(),this.keyService.requestRSAKey(Kf.c.LOGIN)}async calculateZCloudStatusByMessages(e,t){if(!Jy.b.shouldLoadInitStatus(t))return;let s=Jy.b.filterValidMsgs(e);if(s=Jy.b.normalizedMsgs(s),!s||!s.length)return;const i=await this.statusService.getStatusByMessages(s,t);vI.syncStatus(i,!0)}async calculateZCloudStatusByCloudItems(e){const t=await this.statusService.getStatusByCloudItems(e);vI.syncStatus(t,!0)}debug(e,t){Object(Jy.a)().isEnableShowToastDebug()&&Jy.c.showToastPCloudDebug(e,t)}getErrorPCloudHandler(e,t){const{error:s,msgIds:i,windowId:a,showNoti:n,type:r}=e;return s&&null!=s&&s.hasNoKey&&Object(Jy.a)().isEnableTriggerTransferKey()?()=>this.onInteractMediaWithoutKey({msgIds:i,windowId:a,showNoti:n,type:r},t):()=>{}}checkPCloudWithoutKey(e){return this.keyService.checkPCloudWithoutKey(e)}onZCloudStatus(e){if(Object(rI.d)(e))return;this.debug({},e);const t=Object.keys(e);this.statusService.syncCachePCloudInfo(e),this.statusService.signalUIPCloudInfo(e),this.statusService.syncMediaStatus(t),this.statusService.shareUpdatePCloudAction(e)}onHandleHaveKey(){const e=this.keyService.createPCloudUpdateWithValidRSAKey();this.keyService.shareHaveKeyPCloudAction(e),vI.syncStatus(e,!0)}async onInteractMediaWithoutKey(e,t){if(!Object(Jy.a)().isEnableTriggerTransferKey())return;if(this.keyService.showToastWarningNoKey(e),!Object(Jy.a)().isEnableUserPCloud())return void this.Logger.zsymb(3,"nt6z95",["requestRSAKey but no permission!","AMigbC"]);const s=t||Kf.c.RETRY;s===Kf.c.INVIEW?this.metrics.setGetKeyAfterInviewTime():s===Kf.c.RETRY&&this.metrics.setGetKeyAfterRetryTime(),this.keyService.requestRSAKey(s)}onZCloudFreePlan(){const e=this.statusService.createEmptyPCloudUpdate();this.keyService.removeRSAKey(),vI.syncStatus(e,!0),this.planService.shareOffPlanEvent()}onUpgradeZCloudPlan(){this.metrics.setGetKeyAfterChangePlanTime(),this.keyService.requestRSAKey(Kf.c.CHANGE_PLAN),this.planService.shareUpgradePlanEvent()}onGracePeriodPlan(){this.planService.shareGracePeriodPlanEvent()}onRemoveThreads(e){for(const t of e){const e=this.statusService.createEmptyGroupPCloudUpdate(t);vI.syncStatus(e)}}})||fI)||fI)||fI)||fI)||fI)||fI)||fI)||fI;var bI,yI=s("0VmO");const II={valid:!1,status:{isClouded:!0,isUncloud:!1},error:{hasNoKey:!0}},SI={valid:!1,status:{isClouded:!1,isUncloud:!0},error:null},CI={valid:!0,status:{isClouded:!0,isUncloud:!1},error:null};let EI=Object(m.d)()(bI=Object(i.injectable)()(bI=function(e,t){return Object(i.inject)(yI.a)(e,void 0,0)}(bI=Reflect.metadata("design:type",Function)(bI=Reflect.metadata("design:paramtypes",[void 0===yI.a?Object:yI.a])(bI=class extends De.b{get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger(Ss.ZLoggerNametags.zCloud,[Ss.ZLoggerNametags.zCloudStatusEventsResolver])),this._Logger}get controller(){return i.ModuleContainer.resolve(Yy.b)}get cloudDataManager(){return cI.a}constructor(e){super(),this.zaloCloudConfig=e,this.name=void 0,this.key=void 0,this.msgs=void 0,this.convId=void 0,this._Logger=void 0,this.name=Hf.a,this.key=Hf.a,this.msgs=[],this.convId=null}onApplicationReady(){(Object(Rf.e)()||Object(Jy.a)().isEnableBizPCloud())&&(this.addDataCloudListeners(),Object(Jy.a)().isEnableDebugTool()&&this.addTestListeners())}addTestListeners(){this.addEventListener(Kf.g.INIT_DATA,this.handleTestCloudEvents.bind(this)),this.addEventListener(Kf.g.NO_KEY,this.handleTestCloudEvents.bind(this)),this.addEventListener(Kf.g.HAVE_KEY,this.handleTestCloudEvents.bind(this)),this.addEventListener(Kf.g.NOT_YET_CLOUDED,this.handleTestCloudEvents.bind(this))}addDataCloudListeners(){this.cloudDataManager.addListener(Of.d.ADD_CLOUD_ITEMS,this.handleAddedCloudItems.bind(this)),this.cloudDataManager.addListener(Of.d.UPDATE_CLOUD_ITEMS,this.handleUpdatedCloudItems.bind(this)),this.cloudDataManager.addListener(Of.d.TEMP_CLOUD_ITEMS,this.handleTempCloudItems.bind(this)),this.cloudDataManager.addListener(Of.d.REMOVE_CLOUD_ITEMS,this.handleCloudRemoveItems.bind(this)),this.cloudDataManager.addListener(Of.d.UPDATE_CLOUD_KEY_STATUS,this.handleHaveCloudKey.bind(this)),this.cloudDataManager.addListener(Of.d.REMOVE_THREAD_CLOUD,this.handleCloudRemoveThread.bind(this))}async handleTestCloudEvents(e){const t={};switch(e.type){case Kf.g.INIT_DATA:for(const s of e.payload){t[Object(rI.h)(s)]={personalCloud:Object(T.a)({},CI)}}this.controller.onZCloudStatus(t);break;case Kf.g.NO_KEY:for(const s of e.payload){t[Object(rI.h)(s)]={personalCloud:Object(T.a)({},II)}}this.controller.onZCloudStatus(t);break;case Kf.g.HAVE_KEY:this.controller.onHandleHaveKey();break;case Kf.g.NOT_YET_CLOUDED:for(const s of e.payload){t[Object(rI.h)(s)]={personalCloud:Object(T.a)({},SI)}}this.controller.onZCloudStatus(t)}}handleAddedCloudItems(e){const t=vI.splitIntoBatches(e,10);for(let s=0;s<t.length;s++)vI.calculateStatus({clouds:t[s],updateSource:dI.ADD_CLOUDS})}handleUpdatedCloudItems(e){}handleTempCloudItems(e){const t=vI.splitIntoBatches(e,10);for(let s=0;s<t.length;s++)vI.calculateStatus({clouds:t[s],updateSource:dI.ADD_TEMP_CLOUDS})}handleCloudRemoveItems(e){const t=vI.splitIntoBatches(e,10);for(let s=0;s<t.length;s++)vI.calculateStatus({removeZCloudKeys:t[s],updateSource:dI.REMOVE_CLOUDS})}handleCloudRemoveThread(e){this.controller.onRemoveThreads(e)}handleHaveCloudKey(e){e&&(this.Logger.zsymb(3,"CvCc8c",["handleHaveCloudKey","P6a5Yw"]),this.controller.onHandleHaveKey())}bindMsg(e,t){Object(Jy.a)().isEnableDebugTool()&&(this.msgs=e,this.convId=t)}forceInitData(e){(e=e||this.msgs)&&0!==e.length&&this.convId&&this.dispatchEvent(new Kf.b(Kf.g.INIT_DATA,e))}forceOffPCloud(e){this.zaloCloudConfig.onUpdateUsage({plan:-1})}forceUpgrade(){this.dispatchEvent(new Kf.b(Kf.g.UPGRADE_ZCLOUD_PLAN,{})),this.dispatchEvent(new Kf.b(Kf.g.HAVE_KEY,{})),this.zaloCloudConfig.onUpdateUsage({plan:0})}forceGracePeriod(){this.dispatchEvent(new Kf.b(Kf.g.GRACE_PERIOD_ZCLOUD_PLAN,{})),this.zaloCloudConfig.onUpdateUsage({plan:100})}forceNoKey(e){if(!(e=e||this.msgs)||0===e.length||!this.convId)return;Object(Jy.a)().isSend2Me(this.convId)||this.dispatchEvent(new Kf.b(Kf.g.NO_KEY,e))}forceHaveKey(e){if(!(e=e||this.msgs)||0===e.length||!this.convId)return;Object(Jy.a)().isSend2Me(this.convId)||this.dispatchEvent(new Kf.b(Kf.g.HAVE_KEY,e))}forceNotYetClouded(e){(e=e||this.msgs)&&0!==e.length&&this.convId&&this.dispatchEvent(new Kf.b(Kf.g.NOT_YET_CLOUDED,e))}})||bI)||bI)||bI)||bI)||bI;var OI,TI=s("3+fW");let MI=Object(ie.b)(TI.a)(OI=Object(i.injectable)()(OI=function(e,t){return Object(i.inject)(Xy.a)(e,void 0,0)}(OI=Reflect.metadata("design:type",Function)(OI=Reflect.metadata("design:paramtypes",[void 0===Xy.a?Object:Xy.a])(OI=class{get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger(Ss.ZLoggerNametags.zCloud,[Ss.ZLoggerNametags.zCloudStatusController])),this._Logger}constructor(e){this.name=void 0,this.type=void 0,this.key=void 0,this.data=new Map,this.metrics=void 0,this._Logger=void 0,this.name=TI.b,this.key=TI.b,this.metrics=e}_getState(e){return this.data.get(e)}setPCloudInfo(e,t){e?this.data.set(t,e):this.data.delete(t)}signalUIPCloudInfo(e){Object(Zs.g)(this.name,e)}getListPCloudInfo(){return this.data.entries()}getPCloudBizState(e){var t,s,i;let a;a="string"==typeof e?e:Object(rI.h)(e);const n=this.data.get(a);return n&&n.status?{valid:n.valid,hasNoKey:(null===(t=n.error)||void 0===t?void 0:t.hasNoKey)||!1,isClouded:null===(s=n.status)||void 0===s?void 0:s.isClouded,isUncloud:null===(i=n.status)||void 0===i?void 0:i.isUncloud,error:n.error,isFreeCloudItem:n.isFreeCloudItem}:null}getPCloudInfo(e){let t;return t="string"==typeof e?e:Object(rI.h)(e),this._getState(t)}getItem(e){return this._getState(e.key)}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||OI)||OI)||OI)||OI)||OI;const RI="zcloud-repository",wI=Object(i.define)(RI);var LI;let FI=Object(i.injectable)()(LI=Reflect.metadata("design:type",Function)(LI=Reflect.metadata("design:paramtypes",[])(LI=class{get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger(Ss.ZLoggerNametags.zCloud,[Ss.ZLoggerNametags.zCloudStatusRepository])),this._Logger}constructor(){this.name=void 0,this.key=void 0,this._Logger=void 0,this.name=RI,this.key=RI}get cloudDataManager(){return cI.a}getZCloudList(e,t){return 0===t.length?Promise.resolve({cloudedItems:[],tempCloudItems:[]}):new Promise((e=>{this.cloudDataManager.getCloudItems(t).then((s=>{let i=[];for(const e of s)e&&i.push(e);const a=i,n=a.map((e=>Object(rI.i)(e))),r=t.filter((e=>!n.includes(Object(rI.h)(e))));e({cloudedItems:a,tempCloudItems:r})})).catch((t=>{this.Logger.zsymb(3,"025bAT",["getZCloudList, err:","dYqidy"],t),e({cloudedItems:[],tempCloudItems:[]})}))}))}})||LI)||LI)||LI;var DI;let AI=Object(i.injectable)()(DI=function(e,t){return Object(i.inject)(Xy.a)(e,void 0,0)}(DI=function(e,t){return Object(i.inject)(TI.a)(e,void 0,1)}(DI=function(e,t){return Object(i.inject)(Hf.b)(e,void 0,2)}(DI=function(e,t){return Object(i.inject)(wI)(e,void 0,3)}(DI=Reflect.metadata("design:type",Function)(DI=Reflect.metadata("design:paramtypes",[void 0===Xy.a?Object:Xy.a,void 0===TI.a?Object:TI.a,void 0===Hf.b?Object:Hf.b,void 0===wI?Object:wI])(DI=class{get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger(Ss.ZLoggerNametags.zCloud,[Ss.ZLoggerNametags.zCloudStatusServices])),this._Logger}get cloudDataManager(){return cI.a}constructor(e,t,s,i){this.name=void 0,this.key=void 0,this.metrics=void 0,this.zCloudInfo=void 0,this.eventsResolver=void 0,this.zCloudStatusRepository=void 0,this._Logger=void 0,this.name=eI,this.key=eI,this.metrics=e,this.zCloudInfo=t,this.eventsResolver=s,this.zCloudStatusRepository=i}async getStatusByMessages(e,t){const s={},{cloudedItems:i,tempCloudItems:a}=await this.zCloudStatusRepository.getZCloudList(t,e),n=this.cloudDataManager.checkUpgraded()?null:{hasInvalidKey:!0};for(const r of i){const e=r.msgInfo.isE2EE?null:n,t=Object(rI.i)(r);if(!this.zCloudInfo.getPCloudInfo(t)&&t){const i=Jy.b.transferCloudItemRes(!0,r,e);i&&(s[t]={personalCloud:i})}}for(const r of a){const e=Va.b.isMsgE2ee(r)?null:n,t=Object(rI.h)(r);if(!this.zCloudInfo.getPCloudInfo(t)&&t){const i=Jy.b.transferCloudItemRes(!1,r,e);i&&(s[t]={personalCloud:i})}}return Promise.resolve(s)}getStatusByCloudItems(e){const t={},s=this.cloudDataManager.checkUpgraded()?null:{hasInvalidKey:!0};for(const i of e){const e=i.msgInfo.isE2EE?null:s,a=Object(rI.i)(i);if(!this.zCloudInfo.getPCloudInfo(a)&&a){const s=Jy.b.transferCloudItemRes(!0,i,e);s&&(t[a]={personalCloud:s})}}return Promise.resolve(t)}syncCachePCloudInfo(e){for(const t in e){const s=e[t].personalCloud;this.zCloudInfo.setPCloudInfo(s,t)}}signalUIPCloudInfo(e){for(const t in e)this.zCloudInfo.signalUIPCloudInfo(t)}syncMediaStatus(e){if(!i.ModuleContainer.resolve(Yi.b).getConvId())return void this.Logger.zsymb(3,"KpcP1L",["syncMediaStatus: MediaStatus Calculator is not initilized to synup","SkYKU_"]);const t=this.zCloudInfo.getListPCloudInfo();for(let[s,i]of t){if(!s||!e.includes(s))continue;const t=Object(rI.e)(s);t&&_p.a.status(t,[],!0).then((()=>{})).catch((()=>{}))}}shareUpdatePCloudAction(e){this.eventsResolver.dispatchEvent(new Kf.b(Kf.a.UPDATE_STATUS,e))}createEmptyPCloudUpdate(){const e={},t=this.zCloudInfo.getListPCloudInfo();for(let[s,i]of t)s&&i&&(i.isFreeCloudItem||(e[s]={personalCloud:void 0}));return e}createEmptyGroupPCloudUpdate(e){const t={},s=this.zCloudInfo.getListPCloudInfo();for(let[i,a]of s)i&&a&&i.includes(e)&&(t[i]={personalCloud:void 0});return t}})||DI)||DI)||DI)||DI)||DI)||DI)||DI;var NI;let kI=Object(i.injectable)()(NI=function(e,t){return Object(i.inject)(Xy.a)(e,void 0,0)}(NI=function(e,t){return Object(i.inject)(TI.a)(e,void 0,1)}(NI=function(e,t){return Object(i.inject)(Hf.b)(e,void 0,2)}(NI=Reflect.metadata("design:type",Function)(NI=Reflect.metadata("design:paramtypes",[void 0===Xy.a?Object:Xy.a,void 0===TI.a?Object:TI.a,void 0===Hf.b?Object:Hf.b])(NI=class{get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger(Ss.ZLoggerNametags.zCloud,[Ss.ZLoggerNametags.zCloudKeyServices])),this._Logger}get cloudDataManager(){return cI.a}constructor(e,t,s){this.metrics=e,this.zCloudInfo=t,this.eventsResolver=s,this.name=void 0,this.key=void 0,this._Logger=void 0,this.name=sI,this.key=sI}removeRSAKey(){this.cloudDataManager.checkUpgraded()&&this.cloudDataManager.removeKey()}requestRSAKey(e){this.cloudDataManager.checkUpgraded()||(e!==Kf.c.LOGIN&&e!==Kf.c.CHANGE_PLAN||(this.cloudDataManager.updateZCloudKey(!1,e),this.metrics.onAutoRequestKey()),e===Kf.c.RETRY&&(this.cloudDataManager.updateZCloudKey(!0,e),this.metrics.onManualRequestKey()))}checkPCloudWithoutKey(e){var t;const s=this.zCloudInfo.getPCloudInfo(e);return Boolean(null==s||null===(t=s.error)||void 0===t?void 0:t.hasNoKey)}createPCloudUpdateWithValidRSAKey(){const e={},t=this.zCloudInfo.getListPCloudInfo();for(let[s,i]of t){if(!s||!i)continue;if(i.isFreeCloudItem)continue;const t=Object(T.a)(Object(T.a)({},i.error),{},{hasNoKey:!1}),a=i.status,n={valid:Jy.b.checkValidFromBizState(t,a),status:a,error:t};e[s]={personalCloud:n}}return e}shareHaveKeyPCloudAction(e){this.eventsResolver.dispatchEvent(new Kf.b(Kf.a.HAVE_KEY,e))}showToastWarningNoKey(e){const{showNoti:t=!0,windowId:s=yt.c,type:i="file"}=e,a=Sh.ZToastManagerHolder.getZToastManagerByWindowId(s);t&&a.show({noBackground:!0,textKey:"STR_PERSONAL_CLOUD_NO_KEY_TOAST",textArguments:[Object(Jy.d)(i),"\n"],type:Sh.TOAST_TYPE.INFO,duration:3e3,styles:{width:"400px"},styleText:{whiteSpace:"pre-line"}})}})||NI)||NI)||NI)||NI)||NI)||NI;var PI;let jI=Object(i.injectable)()(PI=function(e,t){return Object(i.inject)(Hf.b)(e,void 0,0)}(PI=Reflect.metadata("design:type",Function)(PI=Reflect.metadata("design:paramtypes",[void 0===Hf.b?Object:Hf.b])(PI=class{constructor(e){this.eventsResolver=e,this.name=void 0,this.key=void 0,this.name=aI,this.key=aI}shareUpgradePlanEvent(e){this.eventsResolver.dispatchEvent(new Kf.b(Kf.a.UPGRADE_ZCLOUD_PLAN,e||{}))}shareOffPlanEvent(e){this.eventsResolver.dispatchEvent(new Kf.b(Kf.a.OFF_PERSONAL_CLOUD_PLAN,e||{}))}shareGracePeriodPlanEvent(e){this.eventsResolver.dispatchEvent(new Kf.b(Kf.a.GRACE_PERIOD_ZCLOUD_PLAN,e||{}))}})||PI)||PI)||PI)||PI;var UI=s("MNOV");i.ModuleContainer.registerSingleton(Yy.b,_I),i.ModuleContainer.registerSingleton(Hf.b,EI),i.ModuleContainer.registerSingleton(TI.a,MI),i.ModuleContainer.registerSingleton(wI,FI),i.ModuleContainer.registerSingleton(tI,AI),i.ModuleContainer.registerSingleton(iI,kI),i.ModuleContainer.registerSingleton(nI,jI),i.ModuleContainer.registerSingleton(Xy.a,Xy.b),i.ModuleContainer.registerSingleton(UI.a,UI.b),i.ModuleContainer.registerSingleton(yI.a,yI.b);var BI,GI=s("WDlm"),zI=s("Ivja"),xI=s("3rJp"),VI=s("j+NN");let HI=Object(i.injectable)()(BI=Reflect.metadata("design:type",Function)(BI=Reflect.metadata("design:paramtypes",[])(BI=class{get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger(Ss.ZLoggerNametags.zCloud,[Ss.ZLoggerNametags.zCloudMediaExtInfoServices])),this._Logger}constructor(){this.name=void 0,this.key=void 0,this._Logger=void 0,this.name=GI.b,this.key=GI.b}async doVerify(e){const t=(null==e?void 0:e.length)&&!!zI.a.instance().isKeyAvailable(),{myCloudItems:s,decryptItems:i,submitItems:a,updateThumbUrlItems:n}=this.filter(e);let r=[];if(Object(vp.b)().isEnableSubmitExtraInfoConv("mycloud")&&s.length>0){const e=await this.updateMyCloudItems(s);r=[...r,...e]}if(Object(vp.b)().isEnableSubmitExtraInfoConv("other")&&t&&i.length>0){const e=await this.updatePCloudItems(i);r=[...r,...e]}if(Object(vp.b)().isEnableSubmitExtraInfoConv("e2ee")&&t&&a.length>0){const e=await this.submitAndUpdatePCloudItems(a);r=[...r,...e]}if(n.length>0){const e=await this.updateThumbUrl(n);r=[...r,...e]}return r}filter(e){const t=e,s=U.default.sendToMeId;if(0===t.length||!s)return{myCloudItems:[],decryptItems:[],submitItems:[],updateThumbUrlItems:[]};const i=[],a=[],n=[],r=[];for(let m=0;m<t.length;m++){var o,c,l,d,h,u,g;const e=t[m];if(!e)continue;const p=(null==e||null===(o=e.msgInfo)||void 0===o?void 0:o.destId)==s,f=null==e||null===(c=e.msgInfo)||void 0===c?void 0:c.isE2EE,v=(null===(l=e.mediaInfo)||void 0===l||l.mediaExtInfo,null===(d=e.mediaInfo)||void 0===d||null===(h=d.mediaExtInfo)||void 0===h?void 0:h.data),_=null===(u=e.mediaInfo)||void 0===u||null===(g=u.mediaExtInfo)||void 0===g?void 0:g.decryptedData;if(_){this.shouldUpdateThumbUrl(t[m],_)&&r.push(e)}else p?v||i.push(e):f?_||(v?a.push(e):n.push(e)):_||v&&a.push(e)}return{myCloudItems:i,decryptItems:a,submitItems:n,updateThumbUrlItems:r}}shouldUpdateThumbUrl(e,t){const s=A.default.normalizeMessageType(e.msgInfo.msgType);if(VI.a.includes(s))try{return!Object(Lf.a)(t).thumbUrl}catch(i){return!1}return!1}async updateThumbUrl(e){const t=Object(xI.a)(e),s=await Object(xI.g)(t);if(!s)return[];const i=[];if(s.forEach((t=>{for(let s=0;s<t.length;s++){const a=t[s],n=e.find((e=>wf.a.getZCloudKeyFromCloudItem(e)===wf.a.getZCloudKeyFromQueryItem(a)));if(!a||!n)continue;const r=Object(xI.f)(n,a);r&&i.push(r)}})),0===i.length)return[];try{return await cI.a.updateCloudQueue(i,["mediaInfo"]),this.Logger.zsymb(0,"tyUsPe","[updateThumbUrl] has success","updateClouds",i.length),i}catch(a){throw this.Logger.zsymb(18,"sAG-Uz","[updateThumbUrl] has error",a),a}}async updateMyCloudItems(e){const t=Object(xI.a)(e),s=await Object(xI.g)(t);if(!s)return[];const i=[];if(s.forEach((t=>{for(let s=0;s<t.length;s++){const a=t[s],n=e.find((e=>wf.a.getZCloudKeyFromCloudItem(e)===wf.a.getZCloudKeyFromQueryItem(a)));if(!a||!n)continue;const r=Object(xI.c)(n,a);r&&i.push(r)}})),0===i.length)return[];try{return await cI.a.updateCloudQueue(i,["mediaInfo"]),this.Logger.zsymb(0,"r5mDGD","[updateMyCloudItems] has success","updateClouds",i.length),i}catch(a){throw this.Logger.zsymb(18,"UgJml9","[updateMyCloudItems] has error",a),a}}decryptAndUpdateParams(e){return new Promise((async t=>{try{var s,i,a,n;const r=(null===(s=e.mediaInfo.mediaExtInfo)||void 0===s?void 0:s.data)||"",o=(null===(i=e.mediaInfo)||void 0===i||null===(a=i.mediaExtInfo)||void 0===a||null===(n=a.encryptInfo)||void 0===n?void 0:n.encryptKey)||"";let c=await zI.a.instance().decryptCloudInfo(r,o);if(c){const s=wf.a.getZCloudKeyFromCloudItem(e),i={};c=await this.updateDecryptedData(e,c),i[s]=c,t(i)}}catch(r){this.Logger.zsymb(18,"axRw9y","[updatePCloudItems] => [decryptAndUpdateParams], has error",r),t("")}}))}async updateDecryptedData(e,t){const s=A.default.normalizeMessageType(e.msgInfo.msgType);if(VI.a.includes(s)){if((t=Object(Lf.a)(t)).thumbUrl)return JSON.stringify(t);const s=Object(xI.a)([e]),a=await Object(xI.g)(s);if(a){const e=a.get(s[0].toUid);var i;if(e&&e[0])t=Object(T.a)(Object(T.a)({},t),{},{thumbUrl:null===(i=e[0].message)||void 0===i?void 0:i.thumbUrl}),t=JSON.stringify(t)}}return t}async updatePCloudItems(e){const t=[],s=[];let i={};e.forEach((e=>{s.push(this.decryptAndUpdateParams(e))}));try{return(await Promise.allSettled(s)).forEach((e=>{e.value&&(i=Object(T.a)(Object(T.a)({},i),e.value))})),e.forEach((e=>{const s=wf.a.getZCloudKeyFromCloudItem(e);let a=i[s];if(a){const s=Object(xI.d)(e,a);t.push(s)}})),0===t.length?[]:(await cI.a.updateCloudQueue(t,["mediaInfo"]),this.Logger.zsymb(0,"EfbZ4u","[updatePCloudItems] has success","updateClouds",t.length),t)}catch(a){throw this.Logger.zsymb(18,"bvE5Jk","[updatePCloudItems] has error",a),a}}encryptParams(e,t){return new Promise((async s=>{try{const i=await Object(xI.b)(e,t);s(i||"")}catch(i){this.Logger.zsymb(18,"_OPRC6","[submitAndUpdatePCloudItem] =>[encryptParams], has error",i),s("")}}))}async submitAndUpdatePCloudItems(e){const t=Object(xI.a)(e),s=await Object(xI.g)(t);if(!s)return[];const i=[],a=[];s.forEach((t=>{for(let s=0;s<t.length;s++){const a=t[s],n=e.find((e=>wf.a.getZCloudKeyFromCloudItem(e)===wf.a.getZCloudKeyFromQueryItem(a)));a&&n&&i.push(this.encryptParams(n,a))}}));try{const t=(await Promise.allSettled(i)).map((e=>e.value)).filter((e=>!!e)),s=t.map((e=>e.submit));if(0===s.length)return[];const n=await Vf.a.submitMediaExtInfo({info:s});return t.forEach((t=>{const s=e.find((e=>e.noiseId===t.submit.noiseId));n&&s&&!n.noiseIdsErr.includes(s.noiseId)&&a.push(Object(xI.e)(s,t))})),0===a.length?[]:(await cI.a.updateCloudQueue(a,["mediaInfo","encryptInfo"]),this.Logger.zsymb(0,"0icLKq","[submitAndUpdatePCloudItems] has success","updateClouds",a.length),a)}catch(n){throw this.Logger.zsymb(18,"KUhAEY","[submitAndUpdatePCloudItems] has error",n),n}}})||BI)||BI)||BI;var qI=s("LA5e");const WI="zcloud-queue-fetcher",ZI=Object(i.define)(WI),KI="zcloud-base-sync-queue";Object(i.define)(KI);var QI;let $I=Object(i.injectable)()(QI=Reflect.metadata("design:type",Function)(QI=Reflect.metadata("design:paramtypes",[])(QI=class{constructor(){this.name=void 0,this.key=void 0,this.name=KI,this.key=KI}groupFetchedCloudsByAction(e){const t=[],s=[],i=[];for(let a=e.length-1;a>=0;a--){let n=e[a];if(n){let{action:e}=n;switch(e){case Of.b.add:i.push(n);break;case Of.b.remove:s.push(n);break;case Of.b.del_thread:t.push(n)}}}return{delThreads:t,delClouds:s,addClouds:i}}})||QI)||QI)||QI;var YI=s("vNFC"),JI=s("FvOk");const XI="zcloud-update-queue-after-fetch-queue",eS=Object(i.define)(XI);var tS=s("ZL0F");const sS=["lastNoiseId"];var iS;let aS=Object(i.injectable)()(iS=function(e,t){return Object(i.inject)(ZI)(e,void 0,0)}(iS=function(e,t){return Object(i.inject)(eS)(e,void 0,1)}(iS=function(e,t){return Object(i.inject)(tS.a)(e,void 0,2)}(iS=Reflect.metadata("design:type",Function)(iS=Reflect.metadata("design:paramtypes",[void 0===ZI?Object:ZI,void 0===eS?Object:eS,void 0===tS.a?Object:tS.a])(iS=class extends $I{get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger(Ss.ZLoggerNametags.zCloud,[Ss.ZLoggerNametags.zCloudVerifyQueueServices])),this._Logger}constructor(e,t,s){super(),this.queueFetcher=e,this.updateQueueService=t,this.syncZCloudQueueUIState=s,this.name=void 0,this.key=void 0,this._Logger=void 0,this.name=qI.a,this.key=qI.a}get PCloudMetrics(){return i.ModuleContainer.resolve(vp.g)}async checkVerify(e){const{lastNoiseId:t,forceVerify:s,forceReset:i}=e.mycloudMedia;let a=await cI.a.getLastNoiseId();return i?{sourceForceVerify:YI.a.CMD_621_FORCE_RESET}:s?{sourceForceVerify:YI.a.CMD_621_FORCE_VERIFY}:a?t!==a?{sourceVerify:YI.b.CMD_621_VERIFY}:{}:{sourceForceVerify:YI.a.CMD_621_EMPTY_LAST_NOISEID}}async buildVerifyFetchReq(e){try{return{lastNoiseId:await cI.a.getLastNoiseId(),lastNoiseIds:[],loadType:Of.e.oldest_to_newest,trackingSource:e.trackingSource}}catch(t){throw t}}buildForceVerifyFetchReq(e){return{lastNoiseId:"",lastNoiseIds:[],loadType:Of.e.oldest_to_newest,trackingSource:e.trackingSource}}shouldCheckResetItem(e){return(null==e?void 0:e.sourceForceVerify)!==YI.a.CMD_620_RESET_CLOUD}async doFetch(e,t,s,i=!1){const a={lastNoiseId:"",cloudItems:[],hasMore:!1};let n=!0,r=!i&&this.shouldCheckResetItem(s);for(t===JI.a.VERIFY_PAGE&&(a.preventCheckResetItem=i);n;){var o;const{cloudItems:s,lastNoiseId:i,hasMore:c}=await this.queueFetcher.fetchQueueByPage(e),l=null!=i?i:null===(o=s[0])||void 0===o?void 0:o.noiseId;if(s.find((e=>e.action===Of.b.reset_cloud))&&this.Logger.zsymb(0,"eIgmZ9","doFetch ###### [DEV-DEBUG] ##### FOUND RESET ITEM ######"),r){s.find((e=>e.action===Of.b.reset_cloud))?(this.Logger.zsymb(0,"YeqR-3","doFetch, force verify from [found reset_item], sourceForceVerify",YI.a.VERIFY_FOUND_RESET_CLOUD),await cI.a.removeAll(),a.cloudItems=[],a.lastNoiseId="",e.lastNoiseId="",n=!0,r=!1,t===JI.a.VERIFY_PAGE&&(a.preventCheckResetItem=!0)):(a.cloudItems.unshift(...s),a.lastNoiseId=l,a.hasMore=!!c,e.lastNoiseId=l,n=!!c)}else a.cloudItems.unshift(...s),a.lastNoiseId=l,a.hasMore=!!c,e.lastNoiseId=l,n=!!c;if(t===JI.a.VERIFY_PAGE&&a.cloudItems.length>0)break}return a}async verify(e){const{data:t,syncStrategy:s,sourceSync:i,req:a,preventCheckResetItem:n}=e;try{const e=a||await this.buildVerifyFetchReq(t),{cloudItems:r,lastNoiseId:o,hasMore:c,preventCheckResetItem:l}=await this.doFetch(e,s,i,n),{delThreads:d,delClouds:h,addClouds:u}=this.groupFetchedCloudsByAction(r);return{delThreads:d,delClouds:h,addClouds:u,lastNoiseId:o,hasMore:c,preventCheckResetItem:l}}catch(r){throw r}}forceVerify(e){const{data:t,syncStrategy:s,sourceSync:i,req:a,preventCheckResetItem:n}=e,r=a||this.buildForceVerifyFetchReq(t);return Object(jf.d)("forceVerify",e),this.verify({data:t,syncStrategy:s,sourceSync:i,req:r,preventCheckResetItem:n})}async doVerifyWithSourceVerify(e,t,s){let i=null;return Object(jf.d)("doVerifyWithSourceVerify",e,t,s),i=await this.verify({data:{trackingSource:Of.k.Need_Verify_CMD},syncStrategy:e,sourceSync:{sourceVerify:t},preventCheckResetItem:s}),i}async doForceVerifyWithOtherForceVerify(e,t,s){let i=null;return this.syncZCloudQueueUIState.setForceSyncSource(t),this.Logger.zsymb(0,"QJO7js","syncQueueByVerify, otherForceVerify",t),await cI.a.removeAll(),i=await this.forceVerify({data:{trackingSource:Of.k.Need_Verify_CMD},syncStrategy:e,sourceSync:{sourceForceVerify:t},preventCheckResetItem:s}),i}async doVerifyWithServerCmd(e,t,s){let i=null;Object(jf.d)("doVerifyWithServerCmd:#0",e,t,s);const{sourceForceVerify:a,sourceVerify:n}=await this.checkVerify(e);return a===YI.a.CMD_621_FORCE_RESET||a===YI.a.CMD_621_FORCE_VERIFY||a===YI.a.CMD_621_EMPTY_LAST_NOISEID?(this.Logger.zsymb(0,"7ytR8b","syncQueueByVerify, sourceForceVerify",a),this.syncZCloudQueueUIState.setForceSyncSource(a),await cI.a.removeAll(),i=await this.forceVerify({data:{trackingSource:Of.k.Need_Verify_CMD},syncStrategy:t,sourceSync:{sourceForceVerify:a},preventCheckResetItem:s})):n===YI.b.CMD_621_VERIFY&&(this.Logger.zsymb(0,"kngK9g","syncQueueByVerify, sourceVerify",n),Object(jf.d)("doVerifyWithServerCmd#1"),i=await this.verify({data:{trackingSource:Of.k.Need_Verify_CMD},syncStrategy:t,sourceSync:{sourceVerify:n}})),i}async doVerify(e){const{data:t,syncStrategy:s,sourceVerify:i,otherForceVerify:a,preventCheckResetItem:n=!1}=e;let r=null;if(i?r=await this.doVerifyWithSourceVerify(s,i,n):a===YI.a.TOOL_CLIENT||a===YI.a.CMD_620_RESET_CLOUD?r=await this.doForceVerifyWithOtherForceVerify(s,a,n):t&&(r=await this.doVerifyWithServerCmd(t,s,n)),r){var o,c,l;const{lastNoiseId:e}=r,t=Object(he.a)(r,sS);this.Logger.zsymb(0,"k8u4zk","syncQueueByVerify, after fetched & filtered actions, ","added clouds",null===(o=t.addClouds)||void 0===o?void 0:o.length,"deleted clouds",null===(c=t.delClouds)||void 0===c?void 0:c.length,"deleted thread",null===(l=t.delThreads)||void 0===l?void 0:l.length),await this.updateQueueService.updateQueue(Object(T.a)(Object(T.a)({},t),{},{lastNoiseId:e})),this.Logger.zsymb(0,"Cj0HMD","syncQueueByVerify, done update db, lastNoiseId",e)}return r}async submitVerifyAction(e){try{await Vf.a.submitVerifyAction({type:e})}catch(t){this.Logger.zsymb(18,"153Xwh","submitVerifyAction",t)}}})||iS)||iS)||iS)||iS)||iS)||iS;var nS;let rS=Object(i.injectable)()(nS=Reflect.metadata("design:type",Function)(nS=Reflect.metadata("design:paramtypes",[])(nS=class extends $I{constructor(){super(),this.name=void 0,this.key=void 0,this.name=XI,this.key=XI}async updateQueue(e){const{delThreads:t,delClouds:s,addClouds:i,lastNoiseId:a}=e;return(null==i?void 0:i.length)>0&&await Cf.a.setCloudItems(i),(null==s?void 0:s.length)>0&&await Cf.a.removeCloudItems(s),(null==t?void 0:t.length)>0&&await Cf.a.delThreads(t),a&&await Cf.a.setLastNoiseId(a,Date.now(),{}),[]}})||nS)||nS)||nS;var oS;let cS=Object(i.injectable)()(oS=Reflect.metadata("design:type",Function)(oS=Reflect.metadata("design:paramtypes",[])(oS=class{constructor(){this.name=void 0,this.key=void 0,this.name=WI,this.key=WI}async fetchQueue(e){const{loadType:t,lastNoiseIds:s,trackingSource:i}=e;let{lastNoiseId:a}=e;const n={lastNoiseId:"",cloudItems:[]};let r=!0;for(;r;){var o;const{mediaItems:e,hasMore:c,lastNoiseId:l}=await Vf.a.verifyCloudMedia(a,t,s,i);Object(jf.g)("fetchQueue",l,null==e?void 0:e.length,c);const d=null!=l?l:null===(o=e[0])||void 0===o?void 0:o.noiseId,h=e.sort(((e,t)=>t.msgInfo.ts-e.msgInfo.ts));n.cloudItems.unshift(...h),n.lastNoiseId=d,a=d,r=c}return n}async fetchQueueByPage(e){var t;const{lastNoiseId:s,lastNoiseIds:i,loadType:a,trackingSource:n}=e,r={lastNoiseId:"",cloudItems:[],hasMore:0},{mediaItems:o,lastNoiseId:c,hasMore:l}=await Vf.a.verifyCloudMedia(s,a,i,n);Object(jf.g)("fetchQueueByPage",null==o?void 0:o.length,c,l);const d=null!=c?c:null===(t=o[0])||void 0===t?void 0:t.noiseId,h=o.sort(((e,t)=>t.msgInfo.ts-e.msgInfo.ts));return r.cloudItems=h,r.lastNoiseId=d,r.hasMore=l,r}})||oS)||oS)||oS;var lS=s("jqP8"),dS=s("Hvyc"),hS=s("Dr9L");const uS="zcloud-media-pc-fetcher",gS=Object(i.define)(uS),mS="zcloud-media-web-fetcher",pS=Object(i.define)(mS);var fS,vS=s("EW/s");let _S=Object(m.d)()(fS=Object(m.h)()(fS=Object(m.i)()(fS=Object(i.injectable)()(fS=function(e,t){return Object(i.inject)(gS)(e,void 0,0)}(fS=function(e,t){return Object(i.inject)(pS)(e,void 0,1)}(fS=Reflect.metadata("design:type",Function)(fS=Reflect.metadata("design:paramtypes",[void 0===gS?Object:gS,void 0===pS?Object:pS])(fS=class extends lS.a{constructor(e,t){super(),this.pcFetcher=e,this.webFetcher=t,this.name=void 0,this.key=void 0,this.cleanupTimeoutId=void 0,this.name=dS.b,this.key=dS.b,this.cleanupTimeoutId=null}onSessionExpired(){this.cleanup()}onDispose(){this.cleanup()}onApplicationReady(){this.cleanup()}doCleanupAfterTimeout(e){e&&(this.cleanupTimeoutId=setTimeout((()=>{this.cleanup()}),e))}clearCleanupTimeoutId(){this.cleanupTimeoutId&&clearTimeout(this.cleanupTimeoutId)}async getCloudItem(e){const t=this.getCloudQueryByMessage(e);return t?this.getCloudItemByCloudQuery(t):null}async getDownloadUrl(e,t,s){return this.getUrl(e,t,s)}async getDownloadHeaders(){return this.getHeaders()}async fetch(e){const{cloud:t,message:s,options:i}=e,{type:a}=i,n=await this.getDownloadUrl(t.cloud,null==s?void 0:s.e2eeSession,a),r=await this.getHeaders();if(!n||!r)throw hS.b.getError(Object(T.a)(Object(T.a)({},hS.a.INVALID_PARAMS),{},{message:"No cloud "+(n?"headers":"url")}));return this.pcFetcher.fetch({url:n,headers:r,cloud:t.cloud,options:i})}async cleanup(){const e=ye.p.getSessionUserId(),t=await Object(re.getUserZaloDownloadsDir)(e),s=Object(ne.h)(t,vS.a);s&&await fc.b(s).catch((e=>{}))}})||fS)||fS)||fS)||fS)||fS)||fS)||fS)||fS;var bS=s("BxiA");let yS;(yS||(yS={})).buildData=function(e){return A.default.normalizeMessageType(e.msgInfo.msgType),W.MSG_FILE,function(e){var t,s;const{zKey:i,msgInfo:a,mediaInfo:n}=e,{msgType:r,destId:o}=a,c=A.default.normalizeMessageType(r),l=Object(bS.a)(null!=i?i:wf.a.getZCloudKeyFromCloudItem(e),c),d=wf.a.getConversationIdFromCloudItem(e,_t.default.getUserId()),h=Object(Lf.a)(o===U.default.sendToMeId?null==n||null===(t=n.mediaExtInfo)||void 0===t?void 0:t.data:null==n||null===(s=n.mediaExtInfo)||void 0===s?void 0:s.decryptedData),{fileSize:u,checksum:g,fType:m,title:p,fileExt:f}=h,v=p||Gn.a.NoNameFile,_=f||v.split(".").pop();return{fileName:v,localPath:l,conversationId:d,msgType:c,fileSize:u,checksum:g,fType:m,ext:_}}(e)};var IS=yS;const SS=["options"];var CS;let ES=Object(i.injectable)()(CS=Reflect.metadata("design:type",Function)(CS=Reflect.metadata("design:paramtypes",[])(CS=class{constructor(){this.name=void 0,this.key=void 0,this.name=uS,this.key=uS}async fetch(e){const{url:t,headers:s,cloud:i,options:a}=e,{options:n}=a,r=Object(he.a)(a,SS),o=Object.assign(n,{headers:s}),c=Object.assign(IS.buildData(i),{url:t});return mc.a.run(Object(T.a)(Object(T.a)({},r),{},{options:o,data:c}))}})||CS)||CS)||CS;var OS;let TS=Object(i.injectable)()(OS=Reflect.metadata("design:type",Function)(OS=Reflect.metadata("design:paramtypes",[])(OS=class{constructor(){this.name=void 0,this.key=void 0,this.name=mS,this.key=mS}async fetch(e){const{url:t,options:s}=e,i=null!=s&&s.options?Object(T.a)(Object(T.a)({},null==s?void 0:s.options),{},{headers:e.headers}):{headers:e.headers},a=null==s?void 0:s.queueType,n=null==s?void 0:s.onProgress;return Object(ol.h)(Object(ol.i)().toString(),t,a,n,i)}})||OS)||OS)||OS;const MS="zcloud-photo-fetcher",RS=Object(i.define)(MS);var wS=s("LeFD");const LS=$znode.path,FS=e=>mc.a.run(e),DS=e=>new Promise((async(t,s)=>{try{var i;const{url:n,localPath:r,timeout:o=6e4,maxTTFB:c=2e4,signal:l,noCacheRespFail:d,disableCache:h,msgId:u,entrySerial:g,mediaId:m,options:p,sendDttm:f}=e,v=LS.basename(r),_=LS.dirname(r),b=Object(T.a)({srcAction:h?mc.a.constants.srcAction.Manual:mc.a.constants.srcAction.Dev,saveDir:_,caching:!0,cacheResp:{noCacheRespFail:d},error:{handleError:!0},maxTTFB:c,mediaId:m},p),y={entrySerial:g,type:mc.a.constants.DownloadType.Photo,data:{url:n,fileName:v,msgId:u,sendDttm:f},options:b},I=()=>{s(new wS.a)};if(null!=l&&l.aborted)return I();null==l||l.addEventListener("abort",I);const S=setTimeout((()=>{s(new wS.d)}),o),C=await Object(El.a)(FS,y);if(null==l||l.removeEventListener("abort",I),clearTimeout(S),C.ok)return t(null);const E=C.error;if(!E)return s(new wS.f);const O="string"==typeof(null==E?void 0:E.code)||"number"==typeof(null==E?void 0:E.code)?null==E?void 0:E.code:null==E||null===(i=E.downloadError)||void 0===i?void 0:i.code;if(isNaN(O))return s(new wS.f(E.name));if(O>=75e3&&O<76e3){const e=O-75e3;if(vl.a.image_loader.enable){var a;const t=null===(a=vl.a.image_loader.retryErrorCodes)||void 0===a?void 0:a.some((t=>t===e));if(!!f&&t&&Object(Ml.a)(f))return s(new Ol.NotReadyError)}return s(new wS.c(e))}return s(1010==O?new wS.d:new wS.f(O))}catch(n){const e=new wS.f("[LoadPhotoPC]"+(null==n?void 0:n.message));return null!=n&&n.stack&&(e.stack=n.stack),s(e)}}));var AS;let NS=Object(i.injectable)()(AS=function(e,t){return Object(i.inject)(dS.a)(e,void 0,0)}(AS=Reflect.metadata("design:type",Function)(AS=Reflect.metadata("design:paramtypes",[void 0===dS.a?Object:dS.a])(AS=class extends lS.a{constructor(e){super(),this.mediaZCloudFetcher=e,this._responsesCache=new Map,this._blobURLReserveMap=new Map,this.name=void 0,this.key=void 0,this._downloadHandler=async e=>{const{localPath:t}=e,s=await Object(El.a)(DS,e),i=s.ok?t:"";if(s.ok)return{mediaURL:i,error:void 0};throw s.error},this._downloadWithRetry=Object(fl.a)(this._downloadHandler,{min:vl.a.image_loader.retryMin,max:vl.a.image_loader.retryMax,retries:3,lastTryDelayTime:{min:vl.a.image_loader.lastTryDelayTime.min,max:vl.a.image_loader.lastTryDelayTime.max},shouldRetryOnError:async({error:e})=>e instanceof Yv.a.NotReadyError||e instanceof Yv.a.TimeoutTTFB||e instanceof Yv.a.TimeoutError}),this.name=MS,this.key=MS}async fetchOnWeb(e,t){Object(gl.a)("string"==typeof t&&ml(t),`Media source must be a (http|https) URL. Got ${t}`);const s=this._responsesCache.get(t);if(s&&!s.isRevoked)return Xc.k.Success({mediaURL:this._responsesCache.get(t).blobURL});try{const s=Object(ol.i)().toString(),i=Object(fl.a)(ol.h,{min:vl.a.image_loader.retryMin,max:vl.a.image_loader.retryMax,retries:3,lastTryDelayTime:{min:vl.a.image_loader.lastTryDelayTime.min,max:vl.a.image_loader.lastTryDelayTime.max}}),a=await this.mediaZCloudFetcher.getDownloadHeaders(),n=await i(s,t,ol.a.dev,void 0,{useDiskCache:!1,headers:a});if(n.error)return Xc.k.Failure({code:Xc.d.FAILURE_BY_FETCH,error:{mediaURL:t,error:n.error}});const r=this._responsesCache.get(t)||{};return this._cacheResponse(t,Object(T.a)(Object(T.a)({},r),{},{remoteURL:t,blobURL:n.data,mediaId:e,isRevoked:!1})),Xc.k.Success({mediaURL:n.data})}catch(i){return Xc.k.Failure({code:Xc.d.FAILURE_BY_FETCH,error:{mediaURL:t,error:i}})}}_cacheResponse(e,t){this._responsesCache.set(e,t),this._blobURLReserveMap.set(t.blobURL,e)}async fetchOnPC(e,t,s){const{entrySerial:i,savePath:a}=s;if(a&&Object(ne.a)(a))return Xc.k.Success({mediaURL:a});try{let n={url:t,mediaId:e,localPath:a,entrySerial:i,sendDttm:null==s?void 0:s.sendDttm,noCacheRespFail:(null==s?void 0:s.sendDttm)&&Object(Ml.a)(null==s?void 0:s.sendDttm)};const r=await this.mediaZCloudFetcher.getDownloadHeaders(),o=s.autoDownload?{srcAction:mc.a.constants.srcAction.Auto,headers:r}:{headers:r};n.options=o;const c=await this._downloadWithRetry(n);return c.error?Xc.k.Failure({code:Xc.d.FAILURE_BY_FETCH,error:{mediaURL:t,error:c.error}}):Xc.k.Success({mediaURL:a})}catch(n){return Xc.k.Failure({code:Xc.d.FAILURE_BY_FETCH,error:{mediaURL:t,error:n}})}}async fetch(e){const{mediaId:t,source:s,diskFetcherConfig:i}=e;let a;Object(gl.a)("string"==typeof t,`MediaFetcherImpl: mediaId must be a string. Got ${t}`),Object(gl.a)("string"==typeof s,`MediaFetcherImpl: source must be a string. Got ${s}`),a=i?Xc.i.DiskCache:Xc.i.MemoryCache;const n=ml(s),r=pl(s);if(!n&&r)return Xc.k.Success({mediaURL:s});if(!n&&!r){var o,c;const e=!r||["file://","zfile://"].some((e=>s.startsWith(e)));if(e&&(null===(o=$znode.fs)||void 0===o?void 0:o.existsSync(null==s||null===(c=s.replace("file://",""))||void 0===c?void 0:c.replace("zfile://",""))))return Xc.k.Success({mediaURL:s});if(e)return Xc.k.Failure({code:Xc.d.FAILURE_BY_FETCH})}if(a===Xc.i.MemoryCache)try{return await this.fetchOnWeb(t,s)}catch(h){return Promise.reject(h)}Object(gl.a)("object"==typeof i&&"string"==typeof i.savePath&&!!i.downloadEntrySerial,`MediaFetcherImpl: invalid diskFetcherConfig. Got ${i}`);const{savePath:l,downloadEntrySerial:d}=i;return this.fetchOnPC(t,s,{entrySerial:d,savePath:l})}})||AS)||AS)||AS)||AS;i.ModuleContainer.registerSingleton(GI.a,HI),i.ModuleContainer.registerSingleton(qI.b,aS),i.ModuleContainer.registerSingleton(eS,rS),i.ModuleContainer.registerSingleton(ZI,cS),i.ModuleContainer.registerSingleton(dS.a,_S),i.ModuleContainer.registerSingleton(gS,ES),i.ModuleContainer.registerSingleton(pS,TS),i.ModuleContainer.registerSingleton(RS,NS);var kS=s("v9wC"),PS=s("/078"),jS=s("Q8oB");const US=Object(i.define)("zcloud-offload-client-storage");class BS{constructor(){this.key=""}load(){if(""!==this.key)throw new Error("OffloadStorage already initialized");this.key="zcloud-offload-storage"}read(e,t){const s=n.default.getInstance();e=`${this.key}_${e}`;const i=s.getItemForCurrentUser(e);if(i){const a=JSON.parse(i);if(a.version===t)return a.value;s.removeItemForCurrentUser(e)}return null}write(e,t,s){const i=n.default.getInstance();if(null!==s)return e=`${this.key}_${e}`,void i.setItemForCurrentUser(e,JSON.stringify({version:t,value:s}));this.remove(e)}remove(e){const t=n.default.getInstance();e=`${this.key}_${e}`,t.removeItemForCurrentUser(e)}}const GS="state_store",zS={isOffloading:!1};class xS{constructor(e){this.adapter=e,this._state=void 0}get isOffloading(){return!!this._state&&this._state.isOffloading}set isOffloading(e){this._state||(this._state=zS),this._state=Object(T.a)(Object(T.a)({},this._state),{},{isOffloading:e}),this.save()}load(){this._state=this.adapter.read(GS,1)}clear(){this._state=null,this.save()}save(){this._state?this.adapter.write(GS,1,this._state):this.adapter.remove(GS)}}i.ModuleContainer.registerSingleton(US,class{constructor(){this._adapter=void 0,this._offloadStateStore=void 0,this._adapter=new BS,this._offloadStateStore=new xS(this._adapter)}load(){this._adapter.load(),this._offloadStateStore.load()}clear(){this._offloadStateStore.clear()}get offloadState(){return this._offloadStateStore}});var VS=s("QghK"),HS=s("LZ6X");const qS=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger(Ss.ZLoggerNametags.zCloud,[Ss.ZLoggerNametags.zCloudOffload]);function WS(...e){qS.zsymb(0,"bf4C41",...e)}function ZS(...e){qS.zsymb(18,"b3n7uG",...e)}var KS,QS,$S,YS,JS,XS,eC,tC,sC,iC,aC,nC,rC,oC,cC,lC,dC,hC,uC,gC,mC=function(e){return function(t,s,a){const n=a.value;return a.value=function(...t){const s=i.ModuleContainer.resolve(e).getState().zCloudStatus;if(s.hasKey&&s.isPaid)return n.apply(this,t);ZS("Not ready for offload: ",JSON.stringify(s))},a}},pC=s("7jQ8");let fC=(KS=Object(m.d)(),QS=Object(m.f)(),$S=Object(m.h)(),YS=Object(i.injectable)(),JS=function(e,t){return i.ModuleContainer.inject(PS.a)(e,void 0,0)},XS=function(e,t){return i.ModuleContainer.inject(jS.b)(e,void 0,1)},eC=function(e,t){return i.ModuleContainer.inject(US)(e,void 0,2)},tC=function(e,t){return i.ModuleContainer.inject(VS.a)(e,void 0,3)},sC=function(e,t){return i.ModuleContainer.inject(Wf.a)(e,void 0,4)},iC=function(e,t){return i.ModuleContainer.inject(vp.f)(e,void 0,5)},aC=Reflect.metadata("design:type",Function),nC=Reflect.metadata("design:paramtypes",[void 0===PS.a?Object:PS.a,void 0===jS.b?Object:jS.b,void 0===US?Object:US,void 0===VS.a?Object:VS.a,void 0===Wf.a?Object:Wf.a,void 0===vp.f?Object:vp.f]),rC=mC(jS.b),oC=Reflect.metadata("design:type",Function),cC=Reflect.metadata("design:paramtypes",[]),lC=mC(jS.b),dC=Reflect.metadata("design:type",Function),hC=Reflect.metadata("design:paramtypes",[]),KS(uC=QS(uC=$S(uC=YS(uC=JS(uC=XS(uC=eC(uC=tC(uC=sC(uC=iC(uC=aC(uC=nC((gC=class{constructor(e,t,s,i,a,n){this.OffloadConvsManager=e,this.uiController=t,this.storage=s,this.setting=i,this.OnboardingEventsResolver=a,this.EventsResolver=n,this.name=void 0,this.key=void 0,this.timeoutId=void 0,this.offloadAbortController=new AbortController,this.eventHandler=void 0,this.name=kS.b,this.key=kS.b,this.timeoutId=null,this.eventHandler=this.exportImportDBEventHandler.bind(this),N.default.subscribe(this.eventHandler)}abortOffloadIfPossible(e){this.offloadAbortController.abort(),this.offloadAbortController=new AbortController,this.storage.offloadState.clear(),e&&WS("aborted reason: ",e)}onDispose(){this.abortOffloadIfPossible("onDispose lifecycle"),this.clearTimeoutInAppSession(),N.default.unsubscribe(this.eventHandler),this.setting.reset()}onAuthenticated(e){this.onLoadingOffload(e)}onLoadingOffload(e){this.setting.load(e.getSession().userId),this.storage.load(e.getSession().userId),this.storage.offloadState.clear(),this.addPlanListeners(),this.addKeyListeners(),this.addMigrationListeners(),this.addVerifyQueueListeners(),this.addNetworkListeners()}onApplicationReady(){this.onStartingOffload()}onStartingOffload(){this.onInitZCloudStatus(),this.onTryCheckValidCondition()}onChangeEnableSetting(e){e?this.onEnablOffloadSettingChanged():this.onDisableSettingChanged()}onInitZCloudStatus(){const e=this.uiController.getState().zCloudStatus,t=cI.a.checkUpgraded(),s=Object(vp.b)().isUserPaid();WS("init status:",JSON.stringify(Object(T.a)(Object(T.a)({},e),{},{hasKey:t,isPaid:s}))),this.uiController.setZCloudStatus(Object(T.a)(Object(T.a)({},e),{},{hasKey:t,isPaid:s}))}addPlanListeners(){this.EventsResolver.addEventListener(vp.a.UPGRADE_ZCLOUD_PLAN,this.onHandleUpgradePlan.bind(this)),this.EventsResolver.addEventListener(vp.a.OFF_PERSONAL_CLOUD_PLAN,this.onHandleFreePlan.bind(this)),this.EventsResolver.addEventListener(vp.a.GRACE_PERIOD_ZCLOUD_PLAN,this.onHandleGracePeriod.bind(this))}addKeyListeners(){cI.a.addListener(Of.d.UPDATE_CLOUD_KEY_STATUS,this.onChangeCloudKeyStatus.bind(this))}addMigrationListeners(){this.OnboardingEventsResolver.addEventListener(qf.b.MOBILE_NOT_COMPLETED,this.onHavingMigrateStatus.bind(this)),this.OnboardingEventsResolver.addEventListener(qf.b.MOBILE_COMPLETED_BEFORE,this.onHavingMigrateStatus.bind(this)),this.OnboardingEventsResolver.addEventListener(qf.b.PC_COMPLETED_BEFORE,this.onHavingMigrateStatus.bind(this)),this.OnboardingEventsResolver.addEventListener(qf.b.MOBILE_JUST_MIGRATE_DONE,this.onMobileMigrated.bind(this))}addVerifyQueueListeners(){cI.a.addListener(Of.d.VERIFYING_QUEUE,this.onVerifyingQueue.bind(this)),cI.a.addListener(Of.d.SYNC_QUEUE_DONE,this.onQueueVerifiedDone.bind(this))}addNetworkListeners(){ye.p.listenEvent(ye.k,this.networkHandler.bind(this))}exportImportDBEventHandler(e,t){switch(e){case Bi.c.EXPORT_IMPORT_START:this.abortOffloadIfPossible("export-import running");break;case Bi.c.EXPORT_IMPORT_FINISHED:this.onTryCheckValidCondition()}}onHandleUpgradePlan(){this.setting.init();const e=this.uiController.getState().zCloudStatus;WS("onHandleUpgradePlan",JSON.stringify(e)),this.uiController.setZCloudStatus(Object(T.a)(Object(T.a)({},e),{},{isPaid:!0})),this.onTryCheckValidCondition()}onHandleGracePeriod(){this.abortOffloadIfPossible("grace period");const e=this.uiController.getState().zCloudStatus;WS("onHandleGracePeriod",JSON.stringify(e)),this.uiController.setZCloudStatus(Object(T.a)(Object(T.a)({},e),{},{isPaid:!1})),this.setting.resetNecessaryStates()}onHandleFreePlan(){this.abortOffloadIfPossible("free plan");const e=this.uiController.getState().zCloudStatus;WS("onHandleFreePlan",JSON.stringify(e)),this.uiController.setZCloudStatus(Object(T.a)(Object(T.a)({},e),{},{isPaid:!1})),this.setting.clear()}onHavingMigrateStatus(e){const t=this.uiController.getState().zCloudStatus;switch(e.type){case qf.b.MOBILE_NOT_COMPLETED:this.uiController.setZCloudStatus(Object(T.a)(Object(T.a)({},t),{},{isMigrated:!1}));break;case qf.b.MOBILE_COMPLETED_BEFORE:case qf.b.PC_COMPLETED_BEFORE:this.uiController.setZCloudStatus(Object(T.a)(Object(T.a)({},t),{},{isMigrated:!0})),this.onTryCheckValidCondition()}}onMobileMigrated(){const e=this.uiController.getState().zCloudStatus;this.uiController.setZCloudStatus(Object(T.a)(Object(T.a)({},e),{},{isMigrated:!0})),this.onTryCheckValidCondition()}onChangeCloudKeyStatus(e){const t=this.uiController.getState().zCloudStatus;this.uiController.setZCloudStatus(Object(T.a)(Object(T.a)({},t),{},{hasKey:e})),e&&this.onTryCheckValidCondition()}onVerifyingQueue(){this.abortOffloadIfPossible("verifying queue")}onQueueVerifiedDone(){this.onTryCheckValidCondition()}networkHandler(e){e===Fn.a.DISCONNECT?(WS("network disconnected"),this.abortOffloadIfPossible("network disconnected")):e===Fn.a.CONNECTED&&(WS("network reconnected"),this.onTryCheckValidCondition())}onTryCheckValidCondition(){this.checkBeforeOffload()}checkBeforeOffload(){this.shouldStartOffload()&&this.startOffload()}shouldStartOffload(){if(!this.setting.value())return WS("not start offload because this.setting.value() was not initialized"),!1;if(!this.setting.value().enableOffload)return WS("not start offload because enableOffload is falsy"),!1;if(this.storage.offloadState.isOffloading)return WS("not start offload because there is another offloading process"),!1;if(i.ModuleContainer.resolve(tS.a).isSyncing())return WS("not start offload because zcloud queue is verifying"),!1;const e=this.setting.value().lastOffloadTime;if(!e)return!0;const t=Object(HS.a)().getCycleOptions()[0],s=Date.now()-e;if(s<t){WS("not start offload because of no reach interval time");const e=t-s;this.setTimeoutForNextTimeOffload(e)}return s>=t}setTimeoutForNextTimeOffload(e){this.clearTimeoutInAppSession(),this.timeoutId=setTimeout((()=>{this.onTryCheckValidCondition()}),e)}clearTimeoutInAppSession(){this.timeoutId&&clearTimeout(this.timeoutId)}onEnablOffloadSettingChanged(){this.checkShouldRunRightNow()}checkShouldRunRightNow(){this.shouldRightNowOffload()&&this.startOffload()}shouldRightNowOffload(){return!this.storage.offloadState.isOffloading}onDisableSettingChanged(){Object(HS.a)().getAbortPermission()&&this.abortOffloadIfPossible("user off toggle button")}async startOffload(){this.abortOffloadIfPossible(),this.storage.offloadState.isOffloading=!0;try{WS("start offload time: ",Date.now());await this.OffloadConvsManager.offload(this.offloadAbortController.signal,this.onConvOffloaded.bind(this));Date.now()!==this.setting.value().lastOffloadTime&&(pC.a.logOffloadCompleted({offload_size:this.setting.value().offloadingConvSize}),this.setting.setItem("lastOffloadSize",this.setting.value().offloadingConvSize),this.setting.setItem("offloadingConvId",null),this.setting.setItem("offloadingConvSize",0),WS("end offload time: ",Date.now()),this.setting.setItem("lastOffloadTime",Date.now()),this.setting.setItem("isMarkedAsReadLastestOffloadPopup",!1),this.setting.setItem("isClickedZCloudOffloadCompletedTooltipMainAction",!1),this.setting.setItem("isClickedZCloudOffloadCompletedTooltipSkipAction",!1)),this.setTimeoutForNextTimeOffload(Object(HS.a)().getCycleOptions()[0])}catch(e){ZS("offload error: ",e)}finally{this.storage.offloadState.clear()}}onConvOffloaded(e,t){this.uiController.setOffloadingConv(e)}changeEnableOffload(e){this.setting.setItem("enableOffload",e)}},Object(n_.a)(gC.prototype,"onTryCheckValidCondition",[rC,oC,cC],Object.getOwnPropertyDescriptor(gC.prototype,"onTryCheckValidCondition"),gC.prototype),Object(n_.a)(gC.prototype,"onEnablOffloadSettingChanged",[lC,dC,hC],Object.getOwnPropertyDescriptor(gC.prototype,"onEnablOffloadSettingChanged"),gC.prototype),uC=gC))||uC)||uC)||uC)||uC)||uC)||uC)||uC)||uC)||uC)||uC)||uC)||uC);const vC="zcloud-offload-cloud-media-service",_C=Object(i.define)(vC);let bC=function(e){return e[e.PAGE_SIZE=20]="PAGE_SIZE",e}({});const yC={noiseId:"",zDate:Object(HS.a)().getMediaTTL(),offset:0};var IC;let SC=Object(i.injectable)()(IC=Reflect.metadata("design:type",Function)(IC=Reflect.metadata("design:paramtypes",[])(IC=class{constructor(){this.name=void 0,this.key=void 0,this.name=vC,this.key=vC}async fetchCloudMediaFromOldestToNewestByCOnv(e,t,s){const i=(null==t?void 0:t.zDate)||yC.zDate,a=(null==t?void 0:t.noiseId)||yC.noiseId,n=(null==t?void 0:t.offset)||yC.offset,r=(null==s?void 0:s.limit)||bC.PAGE_SIZE;try{const t=await cI.a.getAllByConversationTypeDate(e,"",i,a,r,Yt.CursorDirection.NEXT,n),s=Object(T.a)(Object(T.a)({},t[t.length-1]),{},{offset:n+t.length});return t.length<r?{cloudItems:t,hasMore:!1,lastItem:s}:{cloudItems:t,hasMore:!0,lastItem:s}}catch(o){return{cloudItems:[],hasMore:!1,lastItem:null}}}filterCloudMediaByCreatedTime(e){return e.filter((e=>{const t=e.msgInfo.ts,s=Object(HS.a)().getMediaTTL();return Date.now()-t>s}))}})||IC)||IC)||IC;const CC="zcloud-offload-conversation-service",EC=Object(i.define)(CC);let OC=function(e){return e[e.ACTIVE_DECREASE=0]="ACTIVE_DECREASE",e[e.ACTIVE_INCREASE=1]="ACTIVE_INCREASE",e}({});var TC;let MC=Object(i.injectable)()(TC=function(e,t){return i.ModuleContainer.inject(ze.i)(e,void 0,0)}(TC=Reflect.metadata("design:type",Function)(TC=Reflect.metadata("design:paramtypes",[void 0===ze.i?Object:ze.i])(TC=class{constructor(e){this.PreviewDataManager=e,this.name=void 0,this.key=void 0,this.name=CC,this.key=CC}onSortActionTime(e,t){return e.sort(((e,s)=>{var i,a;const n=(null===(i=this.PreviewDataManager.getPreviewByIDSync(e))||void 0===i?void 0:i.messageTime)||0,r=(null===(a=this.PreviewDataManager.getPreviewByIDSync(s))||void 0===a?void 0:a.messageTime)||0;switch(t){case OC.ACTIVE_DECREASE:if(r&&n){if(r>n)return 1;if(r<n)return-1}return r&&!n?1:!r&&n?-1:0;case OC.ACTIVE_INCREASE:if(r&&n){if(r<n)return 1;if(r>n)return-1}return!r&&n?1:r&&!n?-1:0;default:return 0}}))}async getConversationList(){const e=await Cf.a.getClientUsage(),t=null==e?void 0:e.usageByConversation;return t?Object.keys(t):[]}async getConvIdsByActiveAscending(){const e=await this.getConversationList();if(!e||!e.length)return[];return this.onSortActionTime(e,OC.ACTIVE_INCREASE)}})||TC)||TC)||TC)||TC;const RC="zcloud-offload-media-message-service",wC=Object(i.define)(RC);var LC=s("/7c0"),FC=s("C64z");async function DC(e,t=10){const s=[],i=new Set;for(const a of e)s.push(a),i.add(a),a.then((()=>i.delete(a))),i.size>=t&&await Promise.race(i);return Promise.allSettled(s)}var AC;const NC=s("IJ+6").FileRes;let kC=Object(i.injectable)()(AC=Reflect.metadata("design:type",Function)(AC=Reflect.metadata("design:paramtypes",[])(AC=class{constructor(){this.name=void 0,this.key=void 0,this.getMessagesByCloudQuery=async(e,t)=>{try{return await LC.a.messageDBHandler.getMessagesByCliIdsOwnerIds(e,t)}catch(s){return ZS("mapping messages error: ",s),null}},this.name=RC,this.key=RC}getCloudItemGroupByMsgType(e){let t={files:[],images:[],videos:[],voices:[],folders:[]};return e.forEach((e=>{switch(A.default.normalizeMessageType(e.msgInfo.msgType)){case W.MSG_PHOTO:case W.MSG_PHOTO_2:case W.MSG_DOODLE:t.images.push(e);break;case W.MSG_VIDEO:t.videos.push(e);break;case W.MSG_FILE:t.files.push(e);break;case W.MSG_VOICE:t.voices.push(e)}})),t}async isAllMsgRefsValid(e){try{const t=[];e.forEach((e=>{t.push(LC.a.messageDBHandler.getMessageByMsgId(e.msgId,e.convId))}));const s=(await Promise.allSettled(t)).flatMap((e=>"fulfilled"===e.status?e.value:[])),i=await Cf.a.getCloudItems(s);return i.every((e=>{if(!e)return WS("ref invalid because item is not clouded"),!1;const t=Date.now()-e.msgInfo.ts>Object(HS.a)().getMediaTTL();return t||WS("ref invalid because of not valid time",e.noiseId,e.msgInfo.ts),t}))}catch(t){return ZS("error in check all refs valid: ",t),!1}}async checkValidRefForOffload(e){try{var t;if(null==NC||!NC.cache||null===(t=NC.cache)||void 0===t||!t.getRefsByMessage)return!1;const s=await NC.cache.getRefsByMessage(e);return!(s&&Array.isArray(s)&&s.length>=2)||await this.isAllMsgRefsValid(s)}catch(s){return ZS("error check valid refs: ",s),!1}}async getValidTag(e){return{valid:await this.checkValidRefForOffload(e),item:e}}async filterValidFiles(e){const t=[],s=[];e.forEach((e=>{const t=this.getValidTag(e);s.push(t)}));return(await DC(s)).forEach((e=>{"fulfilled"===e.status&&e.value.valid&&t.push(e.value.item)})),t}async getMediaMessageGroupsByCloudMediaItems(e,t){const{files:s,images:i,videos:a,voices:n}=this.getCloudItemGroupByMsgType(e),r=Object(xI.a)(i),o=await this.getMessagesByCloudQuery(r,t),c=Object(xI.a)(a),l=await this.getMessagesByCloudQuery(c,t),d=Object(xI.a)(s),h=await this.getMessagesByCloudQuery(d,t),u=Object(xI.a)(n),g=await this.getMessagesByCloudQuery(u,t),m={files:[],images:[],videos:[],voices:[],folders:[]};return Array.isArray(o)&&(m.images=o),Array.isArray(l)&&(m.videos=l),Array.isArray(g)&&(m.voices=g),Array.isArray(h)&&h.forEach((e=>{var t,s;(null===(t=Object(FC.h)(null==e||null===(s=e.message)||void 0===s?void 0:s.params))||void 0===t?void 0:t.fType)===Gn.a.Ftype.Folder?m.folders.push(e):m.files.push(e)})),m.files=await this.filterValidFiles(m.files),m}})||AC)||AC)||AC;const PC="zcloud-offload-delete-local-media-service",jC=Object(i.define)(PC),UC=Object(i.define)("zcloud-offload-local-media-cleaner");let BC,GC;GC=$znode.path,BC=s("Dprd").default;class zC extends oI.a{constructor(e){super(),this.numberOfRunningTasks=void 0,this.queue=void 0,this.queue=e,this.numberOfRunningTasks=0}async clean(e){let t=0;const{data:s}=e,{convId:a,files:n=[],images:r=[],videos:o=[],voices:c=[],folders:l=[]}=s,d=[];n.length>0&&d.push(i.ModuleContainer.resolve(jC).deleteFiles(n,a)),r.length>0&&d.push(i.ModuleContainer.resolve(jC).deletePhotos(r,a)),o.length>0&&d.push(i.ModuleContainer.resolve(jC).deleteVideos(o,a)),c.length>0&&d.push(i.ModuleContainer.resolve(jC).deleteVoices(c,a)),l.length>0&&d.push(i.ModuleContainer.resolve(jC).deleteFolders(l,a));try{return(await Promise.allSettled(d)).forEach((e=>{"fulfilled"===e.status&&(t+=e.value)})),t}catch(h){return 0}}async run(){for(;this.queue.length>0&&this.numberOfRunningTasks<1;){const t=this.queue.shift();if(!t)break;this.numberOfRunningTasks++;const{data:s,resolve:i,reject:a}=t;try{i(await this.clean(s))}catch(e){a(e)}await new Promise((e=>setTimeout(e,Object(HS.a)().getDelayTimeBetweenCleanTask()))),this.numberOfRunningTasks--,this.run()}}}const xC=[],VC=new oI.b(xC),HC=new zC(xC),qC=new class{constructor(e,t){this.provider=void 0,this.consumer=void 0,this.provider=e,this.consumer=t}async clean(e){const{data:t}=e,s=new Promise(((e,s)=>{const i={data:{data:t},resolve:e,reject:s};this.provider.send(i),this.consumer.run()}));return s.catch((()=>{})).finally((()=>{})),s}}(VC,HC);i.ModuleContainer.registerValue(UC,qC);var WC=qC;const ZC="zcloud-offload-scan-local-media-service",KC=Object(i.define)(ZC),QC=Object(i.define)("zcloud-offload-local-media-cleaner");let $C,YC;YC=$znode.path,$C=s("Dprd").default;class JC extends oI.a{get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger(Ss.ZLoggerNametags.zCloud,[Ss.ZLoggerNametags.zCloudOffloadController])),this._Logger}constructor(e){super(),this.numberOfRunningTasks=void 0,this.queue=void 0,this._Logger=void 0,this.queue=e,this.numberOfRunningTasks=0}async run(){for(;this.queue.length>0&&this.numberOfRunningTasks<1;){const t=this.queue.shift();if(!t)break;this.numberOfRunningTasks++;const{data:s,resolve:a,reject:n}=t;try{const{files:e,images:t,videos:n,voices:r,folders:o}=s.data;let c=0;t&&(c+=await i.ModuleContainer.resolve(KC).calculatePhotoSize(t)),n&&(c+=await i.ModuleContainer.resolve(KC).calculateVideoSize(n)),e&&(c+=await i.ModuleContainer.resolve(KC).calculateFileSize(e)),r&&(c+=await i.ModuleContainer.resolve(KC).calculateVoiceSize(r)),o&&(c+=await i.ModuleContainer.resolve(KC).calculateFolderSize(o)),a(c)}catch(e){n(e)}await new Promise((e=>setTimeout(e,200))),this.numberOfRunningTasks--,this.run()}}}const XC=[],eE=new oI.b(XC),tE=new JC(XC),sE=new class{constructor(e,t){this.provider=void 0,this.consumer=void 0,this.provider=e,this.consumer=t}async scan(e){const{data:t}=e,s=new Promise(((e,s)=>{const i={data:{data:t},resolve:e,reject:s};this.provider.send(i),this.consumer.run()}));return s.catch((()=>{})).finally((()=>{})),s}}(eE,tE);i.ModuleContainer.registerValue(QC,sE);var iE=sE;var aE;let nE=Object(i.injectable)()(aE=function(e,t){return i.ModuleContainer.inject(EC)(e,void 0,0)}(aE=function(e,t){return i.ModuleContainer.inject(_C)(e,void 0,1)}(aE=function(e,t){return i.ModuleContainer.inject(wC)(e,void 0,2)}(aE=Reflect.metadata("design:type",Function)(aE=Reflect.metadata("design:paramtypes",[void 0===EC?Object:EC,void 0===_C?Object:_C,void 0===wC?Object:wC])(aE=class{constructor(e,t,s){this.ConversationService=e,this.CloudMediaService=t,this.MediaMessageService=s,this.name=void 0,this.key=void 0,this.name=PS.b,this.key=PS.b}get zCloudOffloadUIController(){return i.ModuleContainer.resolve(jS.b)}get zCloudOffloadSetting(){return i.ModuleContainer.resolve(VS.a)}async offloadByConvId(e,t){let s=0,i=!0,a=null;const n=Object(HS.a)().getDelayTimeBetweenConvQuery();let r=0;for(;i;){const o=Date.now();o-r<n&&await new Promise((e=>setTimeout(e,n-(o-r)))),r=Date.now();const c=await Promise.race([this.CloudMediaService.fetchCloudMediaFromOldestToNewestByCOnv(e,a,{limit:Object(HS.a)().getConvQueryLimit()}),t]);i=c.hasMore,a=c.lastItem;const l=await this.MediaMessageService.getMediaMessageGroupsByCloudMediaItems(this.CloudMediaService.filterCloudMediaByCreatedTime(c.cloudItems),e);let d;d=e.startsWith(W.GROUPID_PREFIX)?Fe.default.getDName(e):Z.default.getDName(e),WS("start clean","convId",e,"displayName",d);s+=await WC.clean({data:Object(T.a)(Object(T.a)({},l),{},{convId:e})})}return s}async scanOffloadByConvId(e,t){let s=0,i=!0,a=null;const n=Object(HS.a)().getDelayTimeBetweenConvQuery();let r=0;for(;i;){const o=Date.now();o-r<n&&await new Promise((e=>setTimeout(e,n-(o-r)))),r=Date.now();const c=await Promise.race([this.CloudMediaService.fetchCloudMediaFromOldestToNewestByCOnv(e,a,{limit:Object(HS.a)().getConvQueryLimit()}),t]);i=c.hasMore,a=c.lastItem;const l=await this.MediaMessageService.getMediaMessageGroupsByCloudMediaItems(this.CloudMediaService.filterCloudMediaByCreatedTime(c.cloudItems),e);s+=await iE.scan({data:Object(T.a)(Object(T.a)({},l),{},{convId:e})})}return s}async offload(e,t){const s=new Promise(((t,s)=>{const i=()=>{a(),s(new Error("abort offload!"))},a=()=>{e.removeEventListener("abort",i)};e.addEventListener("abort",i)})),i=await this.ConversationService.getConvIdsByActiveAscending();WS("list offload convId: ",i),this.zCloudOffloadUIController.setOffloadConvNum(0),this.zCloudOffloadUIController.setTotalOffloadConvNum(i.length),this.zCloudOffloadUIController.setInProgressOffloadSize(0);let a=0;const n=this.zCloudOffloadSetting.value()&&this.zCloudOffloadSetting.value().offloadingConvId,r="string"==typeof n?i.findIndex((e=>e===n)):0,o=-1!==r?r:0,c=this.zCloudOffloadSetting.value()&&this.zCloudOffloadSetting.value().offloadingConvSize;c&&"number"==typeof c&&(a=c);for(let l=o;l<i.length;l++){this.zCloudOffloadSetting.setItem("offloadingConvId",i[l]);const e=await this.offloadByConvId(i[l],s);a+=e,t(i[l],a),WS("done offload conv: ",i[l],e),this.zCloudOffloadUIController.setOffloadConvNum(l+1),this.zCloudOffloadUIController.setInProgressOffloadSize(a)}return a}async testScanOffload(e){const t=new Promise(((t,s)=>{const i=()=>{a(),s(new Error("abort offload!"))},a=()=>{e.removeEventListener("abort",i)};e.addEventListener("abort",i)}));let s=await this.ConversationService.getConvIdsByActiveAscending();const i=s.length;this.zCloudOffloadUIController.setTotalOffloadConvNum(i);let a=0;for(let n=0;n<i;n++){const e=await this.scanOffloadByConvId(s[n],t);this.zCloudOffloadUIController.setNewEstimatedSizeConv(s[n],e),a+=e}return a}})||aE)||aE)||aE)||aE)||aE)||aE;var rE,oE=s("KQkt");const cE=$znode.path,lE=s("Dprd").default;let dE=Object(i.injectable)()(rE=Reflect.metadata("design:type",Function)(rE=Reflect.metadata("design:paramtypes",[])(rE=class{constructor(){this.name=void 0,this.key=void 0,this.name=PC,this.key=PC}get zCloudOffloadSetting(){return i.ModuleContainer.resolve(VS.a)}isLikeFolderPath(e){return!!cE&&e.endsWith(null==cE?void 0:cE.join("~",cE.sep))}accumulateSize(e){if(!e||"number"!=typeof e)return;const t=this.zCloudOffloadSetting.value()&&this.zCloudOffloadSetting.value().offloadingConvSize;if("number"==typeof t){const s=t+e;this.zCloudOffloadSetting.setItem("offloadingConvSize",s)}}async deletePhoto(e,t){try{const s=await lE.isFile(e),i=(null==s?void 0:s.size)||0;return $znode.fs.unlinkSync(e),WS("deletePhoto item success: ",null==t?void 0:t.msgId,null==t?void 0:t.cliMsgId,e,i),this.accumulateSize(i),i}catch(s){return ZS("deletePhoto item error: ",null==t?void 0:t.msgId,null==t?void 0:t.cliMsgId,s),0}}async deletePhotos(e,t){try{let t=0;const s=ye.p.getSessionUserId(),i=[];for(const a of e){const e=oE.a.getPathsByMessageIfExistSync(s,a);Array.isArray(e)&&e.length&&e.forEach((e=>{const t=this.deletePhoto(e.path,a);i.push(t)}))}return(await DC(i)).forEach((e=>{"fulfilled"===e.status&&(t+=e.value)})),WS("deletePhotos totalSize: ",t),t}catch(s){return ZS("deletePhotos error",s),0}}async deleteVideo(e,t){try{const s=await lE.isFile(e),i=(null==s?void 0:s.size)||0;return $znode.fs.unlinkSync(e),WS("deleteVideo item success: ",null==t?void 0:t.msgId,null==t?void 0:t.cliMsgId,e,i),this.accumulateSize(i),i}catch(s){return ZS("deleteVideo item error : ",null==t?void 0:t.msgId,null==t?void 0:t.cliMsgId,s),0}}async deleteVideos(e,t){let s=0;const i=ye.p.getSessionUserId();try{const t=[];for(const s of e){const e=oE.a.getPathsByMessageIfExistSync(i,s);Array.isArray(e)&&e.length&&e.forEach((e=>{const i=this.deleteVideo(e.path,s);t.push(i)}))}return(await DC(t)).forEach((e=>{"fulfilled"===e.status&&(s+=e.value)})),WS("deleteVideos totalSize: ",s),s}catch(a){return ZS("deleteVideos error",a),0}}async deleteFile(e,t){try{const s=await lE.isFile(e),i=(null==s?void 0:s.size)||0;return $znode.fs.unlinkSync(e),WS("deleteFile item success: ",null==t?void 0:t.msgId,null==t?void 0:t.cliMsgId,e,i),this.accumulateSize(i),i}catch(s){return ZS("deleteFile item error: ",null==t?void 0:t.msgId,null==t?void 0:t.cliMsgId,s),0}}async deleteFiles(e,t){let s=0;const i=ye.p.getSessionUserId();try{const t=[];for(const s of e){const e=oE.a.getPathsByMessageIfExistSync(i,s);Array.isArray(e)&&e.length&&e.forEach((e=>{const i=this.deleteFile(e.path,s);t.push(i)}))}return(await DC(t)).forEach((e=>{"fulfilled"===e.status&&(s+=e.value)})),WS("deleteFiles totalSize: ",s),s}catch(a){return ZS("deleteFiles error",a),0}}async deleteVoice(e,t){try{const s=await lE.isFile(e),i=(null==s?void 0:s.size)||0;return $znode.fs.unlinkSync(e),WS("deleteVoice item success: ",null==t?void 0:t.msgId,null==t?void 0:t.cliMsgId,e,i),this.accumulateSize(i),i}catch(s){return ZS("deleteVoice item error: ",null==t?void 0:t.msgId,null==t?void 0:t.cliMsgId,s),0}}async deleteVoices(e,t){let s=0;const i=ye.p.getSessionUserId();try{const t=[];for(const s of e){const e=oE.a.getPathsByMessageIfExistSync(i,s);Array.isArray(e)&&e.length&&e.forEach((e=>{const i=this.deleteVoice(e.path,s);t.push(i)}))}return(await DC(t)).forEach((e=>{"fulfilled"===e.status&&(s+=e.value)})),WS("deleteVoices totalSize: ",s),s}catch(a){return ZS("deleteVoices error",a),0}}async deleteFolder(e,t){const s=this.isLikeFolderPath(e);try{let i=0;if(!s){const t=await lE.isFile(e);i=(null==t?void 0:t.size)||0}return await lE.deleteFolder(e),WS("deleteFolder item success: ",null==t?void 0:t.msgId,null==t?void 0:t.cliMsgId,e,i),this.accumulateSize(i),{size:i,isLikeFolder:s}}catch(i){return ZS("deleteFolder item error: ",null==t?void 0:t.msgId,null==t?void 0:t.cliMsgId,i),{size:0,isLikeFolder:s}}}async deleteFolders(e,t){try{let t=0;const s=ye.p.getSessionUserId(),i=[];for(const a of e){const e=oE.a.getPathsByMessageIfExistSync(s,a);Array.isArray(e)&&e.length&&e.forEach((e=>{const t=this.deleteFolder(e.path,a);i.push(t)}))}return(await DC(i)).forEach((e=>{"fulfilled"!==e.status||e.value.isLikeFolder||(t+=2*e.value.size)})),WS("deleteFolders totalSize: ",t),t}catch(s){return ZS("deleteFolders error",s),0}}})||rE)||rE)||rE;var hE;const uE=new(s("VIVm").a)({concurrency:400,interval:1e3});let gE,mE;mE=$znode.path,gE=s("Dprd").default;let pE=Object(i.injectable)()(hE=Reflect.metadata("design:type",Function)(hE=Reflect.metadata("design:paramtypes",[])(hE=class{constructor(){this.name=void 0,this.key=void 0,this.name=ZC,this.key=ZC}async calculatePhotoSize(e){const t=ye.p.getSessionUserId();let s=0;for(const i of e){const e=oE.a.getPathsByMessageIfExistSync(t,i);for(const t of e){if(await Q.a.ResCacheManager.hasCacheFile(t.path))s+=await Q.a.ResCacheManager.getCacheFile(t.path)||0;else{const{task:e}=uE.throttle(gE.isFile);s+=(await e(t.path,!1)).size}}}return s}async calculateVideoSize(e){const t=ye.p.getSessionUserId();let s=0;for(const i of e){const e=oE.a.getPathsByMessageIfExistSync(t,i);for(const t of e){if(await Q.a.ResCacheManager.hasCacheFile(t.path))s+=await Q.a.ResCacheManager.getCacheFile(t.path)||0;else{const{task:e}=uE.throttle(gE.isFile);s+=(await e(t.path,!1)).size}}}return s}async calculateFileSize(e){const t=ye.p.getSessionUserId();let s=0;for(const a of e){const e=oE.a.getPathsByMessageIfExistSync(t,a);for(const t of e)try{if(await Q.a.ResCacheManager.hasCacheFile(t.path))s+=await Q.a.ResCacheManager.getCacheFile(t.path)||0;else{const{task:e}=uE.throttle(gE.isFile);s+=(await e(t.path,!1)).size}}catch(i){}}return s}async calculateVoiceSize(e){const t=ye.p.getSessionUserId();let s=0;for(const i of e){const e=oE.a.getPathsByMessageIfExistSync(t,i);for(const t of e){if(await Q.a.ResCacheManager.hasCacheFile(t.path))s+=await Q.a.ResCacheManager.getCacheFile(t.path)||0;else{const{task:e}=uE.throttle(gE.isFile);s+=(await e(t.path,!1)).size}}}return s}async calculateFolderSize(e){const t=ye.p.getSessionUserId();let s=0;for(const i of e){const e=oE.a.getPathsByMessageIfExistSync(t,i);for(const t of e){if(await Q.a.ResCacheManager.hasCacheFile(t.path))s+=await Q.a.ResCacheManager.getCacheFile(t.path)||0;else{const{task:e}=uE.throttle(gE.isFile);s+=(await e(t.path,!1)).size}}}return s}})||hE)||hE)||hE;i.ModuleContainer.registerSingleton(kS.a,fC),i.ModuleContainer.registerSingleton(_C,SC),i.ModuleContainer.registerSingleton(EC,MC),i.ModuleContainer.registerSingleton(wC,kC),i.ModuleContainer.registerSingleton(PS.a,nE),i.ModuleContainer.registerSingleton(jC,dE),i.ModuleContainer.registerSingleton(KC,pE);var fE=s("GNMY"),vE=s("sGG0");var _E,bE=s("72EQ"),yE=s("v+vz"),IE=s("F1+M"),SE=s("XbxG"),CE=s("U/XY"),EE=s("1PLK");function OE(){if(!U.default.profile.cover.randomUrls.length)return"";const{randomUrls:e}=U.default.profile.cover;return e[Math.floor(Math.random()*e.length)]}Object(m.h)()(_E=Object(ie.b)(fE.a)(_E=Reflect.metadata("design:type",Function)(_E=Reflect.metadata("design:paramtypes",[])(_E=class{constructor(){this.name=fE.b,this.key="convId",this.didInit=!1,this.data=void 0,this._cachedFriendRequest={},this._dispatch=void 0,this._genMessageServer=void 0,this._randomCoverSrc=OE(),this._logger=void 0,this.type=void 0,this.data=new Map}get Logger(){return this._logger||(this._logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger(this.name,["personal-controller"])),this._logger}init(e){this.didInit||(this._fetchReceiveFriendList(),i.ModuleContainer.resolve(sd.n).addEventListener(sd.m.ReceiveAddFriendEvent,this.invitationEventHandler.bind(this)),i.ModuleContainer.resolve(sd.n).addEventListener(sd.m.UndoAddFriendEvent,this.invitationEventHandler.bind(this)),i.ModuleContainer.resolve(sd.n).addEventListener(sd.m.AcceptAddFriendEvent,this.invitationEventHandler.bind(this)),i.ModuleContainer.resolve(sd.n).addEventListener(sd.m.RejectAddFriendEvent,this.invitationEventHandler.bind(this)),i.ModuleContainer.resolve(sd.n).addEventListener(sd.m.UndoSentRequestFriendEvent,this.invitationEventHandler.bind(this)),this.didInit=!0)}onDispose(){qv.a.getInstance().removeAll()}bindDispatch(e){this._dispatch=e,N.default.subscribe(this.eventHandler.bind(this)),this._randomCoverSrc=OE()}unbind(){this._dispatch=null,this._genMessageServer=null,this.data.clear(),N.default.unsubscribe(this.eventHandler)}dispatch(e){this._dispatch?this._dispatch(e):this.Logger.zsymb(0,"A2ufOb","Lost dispatch")}bindGenMessageServer(e){this._genMessageServer=e}clearState(e){this.data.has(e)&&this.data.delete(e)}_signalUpdate(e){Object(Zs.g)(fE.b,e)}_updateData(e,t,s){const i=this.data.get(e);i?this.data.set(e,Object(T.a)(Object(T.a)({},i),{},{[t]:i&&i[t]?A.default.deepMerge(i[t],s):s})):this.data.set(e,{[t]:s,version:0}),this._signalUpdate(e)}_udapteInfoData(e,t,s=!0){var i;const a=this.data.get(e);return s&&null!=a&&null!==(i=a.info)&&void 0!==i&&i.avatar&&(t.avatar=a.info.avatar),this._updateData(e,"info",t)}_updateVersion(e){const t=this.data.get(e);t?this.data.set(e,Object(T.a)(Object(T.a)({},t),{},{version:t.version+1})):this.data.set(e,{version:0}),this._signalUpdate(e)}getCover(e){var t;const s=null===(t=this.data.get(e))||void 0===t?void 0:t.info;if(s){const e=s.cover;return e&&e==U.default.profile.cover.defaultUrl?this._randomCoverSrc||U.default.profile.cover.defaultUrl:e}return this._randomCoverSrc||U.default.profile.cover.defaultUrl}async getUserInfo(e,t=!1){const s=Object(T.a)({},Z.default.getProfileFriendByIdSync(e));this._udapteInfoData(e,s);const i=async()=>{try{const t=await Z.default.getProfileFriendById(e,W.SRC_GET_PROFILE.FORCE_GET);return Z.default.isFriend(e)||this.getStatusFriendRequest(e),t&&(yE.y(e)&&N.default.send(P.FetchActions.UDPATE_BUSINESS_INFO,{user:t}),this._udapteInfoData(e,t,!1)),this.getFullAvatar(e),t}catch(t){return this.Logger.zsymb(0,"jxVKLd","[getUserInfo]",t),Z.default.getProfileFriendByIdSync(e)}};return t||!this.data.has(e)||!s||Object.keys(s).length<=4?i():s}async getExtraInfo(e){try{const t=await Qr.a.getProfileExtra(e,Z.default.getUidMe());if(t){(e=>{if(e.bkPhotos&&e.photos&&e.photos.length)for(let t=0;t<e.photos.length;t++){const s=e.photos[t],i=e.bkPhotos[t];qv.a.getInstance().setBackup(s,i)}})(t);const s=(e=>{const t=e.photos?e.photos.map(((t,s)=>({url:t,meta:e.photoMetas&&e.photoMetas[s]}))):[];let s=[];return e.groupIds&&e.groupIds.length>0&&e.groupIds.forEach((e=>{Le.a.checkHiddenChatByPureGroupId(e)||s.push(e)})),{mutualGroups:s,photos:t}})(t);return this._updateData(e,"extra",s),!0===t.fetched&&this.dispatch({type:P.ConversationListActions.FORCE_UPDATE_MUTUAL_GROUP_ITEM,payload:e}),s}}catch(s){var t;this.Logger.zsymb(0,"wAVvuy","[getExtraInfo]",s),this._updateData(e,"extra",(null===(t=this.data.get(e))||void 0===t?void 0:t.extra)||{})}return null}async getFullAvatar(e,t=!1){const s=(t,s)=>{qv.a.getInstance().setBackup(t,s),this._updateData(e,"info",{fullAvatar:t})},i=async()=>{try{const t=await yE.k(e);t&&s(t.full_avatar,t.bk_full_avatar)}catch(t){if(this.Logger.zsymb(18,"0GcqCL","fetch full avatar error:",t),a){if(A.default.isWeb()){let e=a.url;return e&&s(e),e}{let e=a.path;if(await Object(bE.a)(e))return s("file://"+e),"file://"+e}}}};let a=_t.default.getProfileAvatar(e);if(t||!a)return i();{let e=a.ts;if(Date.now()-3e5>e)return i();if(A.default.isWeb()){let e=a.url;return s(e),e}{let e=a.path;Object(bE.a)(e).then((t=>t?(s("file://"+e),"file://"+e):i()))}}}async getProfileRank(e){try{const t=await Qr.a.getProfileRank(e,Z.default.getUidMe());return this._updateData(e,"rank",t),t}catch(s){var t;this.Logger.zsymb(0,"aSRFVj","[getProfileRank]",s),this._updateData(e,"rank",(null===(t=this.data.get(e))||void 0===t?void 0:t.rank)||{})}return null}async getStatusFriendRequest(e){const t=async()=>{try{await Qi.a.getStatusFriendRequest(e,!1)}catch(t){}};let s=ye.p.getFriendRequestStatus(e);if(s){let e=s.ts;e&&e>-1&&e<Date.now()-2e3&&t()}else t()}async _fetchReceiveFriendList(e=!1){let t=$r.a.getRecommendedFriendsSync();if(!Object.keys(t).length||e)try{t=await $r.a.getRecommendedFriendsV2(!0,!0)}catch(i){this.Logger.zsymb(0,"jtjKDs","_fetchReceiveFriendList [ERROR]",t)}const s=Object.keys(t);s.length&&s.forEach((e=>{var s,i,a;(null===(s=t[e])||void 0===s||null===(i=s.dataInfo)||void 0===i?void 0:i.recommType)===yd.RECEIVE&&(this._cachedFriendRequest[e]=null===(a=t[e])||void 0===a?void 0:a.dataInfo)}))}getRequestInfo(e){return this._cachedFriendRequest[e]}async toggleBlock(e,t){var s;const i=this.data.get(e),a=(null==i||null===(s=i.info)||void 0===s?void 0:s.isBlocked)||Z.default.isBlocked(e);fe.default.logAction(1460207);try{const s=await Z.default.blockFriend(e,a?W.UNSET_BLOCK:W.SET_BLOCK);return CE.c(t,a?"STR_UNBLOCK_USER_TOAST_SUCCESS":"STR_BLOCK_USER_TOAST_SUCCESS"),i&&this._updateData(e,"info",{isBlocked:!a}),a||fe.default.logAction(146020701),this.dispatch({type:P.ConversationListActions.BLOCK_CONVERSATION,payload:{blocked:!a,userId:e}}),s}catch(n){this.Logger.zsymb(18,"E5pKue","toggleBlock",n),CE.c(t,a?"STR_UNBLOCK_USER_TOAST_FAIL":"STR_BLOCK_USER_TOAST_FAIL")}}async toggleRemoveFriend(e,t){fe.default.logAction(1460206);try{const s=await yE.B(e);return _t.default.removeNewFriend(e),_t.default.removeFriend(e).then((t=>{N.default.send(P.PopupActions.TOGGLE_REMOVE_FRIEND,e)})),this.dispatch({type:P.FetchActions.FRIENDS_REMOVED,payload:e}),CE.c(t,"STR_DELETE_SUCCESS"),s}catch(s){this.Logger.zsymb(18,"oCLeI0","toggleRemoveFriend",s)}}async toggleShareContact(e,t){const s=this.data.get(e),i=await Object(IE.c)([e]);fe.default.logAction(1460205);let a="",n="";s&&s.info&&(a=s.info.avatar,n=s.info.displayName);let r={message:{action:"recommened.user",description:JSON.stringify({qrCodeUrl:i[e]}),params:e,thumb:a,title:n},msgType:W.MSG_CONTACT,windowId:t};N.default.send(P.PopupActions.SHARE_MSG,r)}showImage(e,t,s=Ny.i.ProfileAvatar){var i;let a=null===(i=this.data.get(e))||void 0===i?void 0:i.info;if(!a)return;const n={user:Z.default.getProfileMeSync(),userId:e,conversation:Object(T.a)({},a),isVideo:!1,selectedId:null,isProfileImg:!0,href:t,appConfig:Object(U.getPVConfigs)(),source:s};A.default.isWeb()||(n.appConfig={enable_feature_alias:U.default.enable_feature_alias,enable_stranger_alias:U.default.enable_stranger_alias}),Q.a.OpenPhoto.openPhotoViewer(n)}voiceCall(e,t){const s=this.data.get(e);if(fe.default.logAction(10643),fe.default.logActionInfo(fe.FeaturesInfo.BusinessAccount,1460203,[e,Z.default.isFriend(e)?0:1]),!aa.d.isSupport()||null==s||!s.info)return;if(aa.d.isCalling())return void CE.b(t,void 0,ni.default.trans(aa.c.IN_CALL));const i=s.info;var a;A.default.isWeb()||(a=e,_t.default.getConversation(a)).then((t=>{let s={lastSmsLocalId:t?t.lastSmsLocalId:null,displayName:i.displayName,userId:e},a=[s.userId];aa.d.makeCall(a,!1,!1,(e=>{this._genMessageServer&&this._genMessageServer(s,e),e.caller&&e.duration>0&&SE.b.updateLastActionTime(s.userId,this.dispatch,-1,SE.a.CALL)}))}))}jumpToConversation(e){let t=this.data.get(e);if(!t||!t.info)return;i.ModuleContainer.resolve(Ge.b).openConversation(e,Ge.d.fromProfileInfo(t.info));const s=Z.default.isFriend(e);fe.default.logActionInfo(fe.FeaturesInfo.BusinessAccount,1460204,[e,s?1:0]),ft.ModalManagerV2.closeAllModal()}async undoFriendRequest(e){fe.default.logAction(146020802);try{return await Qi.a.undoRequestAddFriend(e),i.ModuleContainer.resolve(sd.n).dispatchEvent(new sd.o(sd.m.UndoSentRequestFriendEvent,null,e)),this.getUserInfo(e),!0}catch(t){t&&t.error_message&&CE.a(t.error_message)}return!1}async addFriend(e,t){const s=this.data.get(e);return!(!s||!s.info||s.info.isBlocked)&&(Qi.a.isYouRequestMe(e)?(fe.default.logAction(146020801),i.ModuleContainer.resolve(Zr.b).acceptFriendRequest(e,t),_t.default.getAcceptNewFriend(s)):fe.default.logAction(1460208),!0)}async sendFriendRequest(e,t,s,i){const a=Qi.a.getFriendRequestSource(e);try{await Qi.a.requestAddFriend(e,s,a),this.dispatch({type:P.ChatBoxActions.SEND_FRIEND_REQUEST,payload:e}),N.default.send(P.SideBarActions.SENT_FRIEND_REQUEST,e),CE.c(t,"STR_REQ_FR_SUCCESS"),_t.default.setStrangerCache(e,1),vE.a.callUpdate(e,i)}catch(n){this.Logger.zsymb(18,"ThsFjM","sendFriendRequest",n),n&&n.error_message&&CE.a(t,n.error_message),_t.default.setStrangerCache(e,0)}}openLink(e){EE.b.open(e)}eventHandler(e,t){switch(e){case P.FetchActions.STATUS_BLOCKED_CHANGED:if(t){this.data.has(t)&&this._updateData(t,"info",{isBlocked:Z.default.isBlocked(t)})}break;case P.FetchActions.UPDATE_NAME:if(t)if(t.constructor===Object){this.data.has(t.userId)&&this.getUserInfo(t.userId)}else if(t.constructor===Array)for(const[e,s]of Object.entries(this.data)){t.includes(e)&&this.getUserInfo(e)}break;case P.FetchActions.USERID_FETCHED:case P.FetchActions.PROFILE_ME_FETCHED:{const e=Z.default.getUidMe();t&&this._udapteInfoData(e,Object(T.a)(Object(T.a)({},t),{},{isBlocked:!1,isFr:!0}),!this.data.has(t.userId)),this.data.has(t.userId)&&this.getFullAvatar(t.userId,!0);break}case P.FetchActions.FRIEND_REQUEST_UPDATE:t&&this.data.has(t.userId)&&this._updateVersion(t.userId);break;case P.ConversationListActions.BLOCK_CONVERSATION:t&&this.data.has(t.userId)&&this._updateData(t.userId,"info",{isBlocked:t.blocked});break;case P.FriendListActions.UPDATE_EXTRA_PROFILE_CACHE:t&&t.userId&&this.data.has(t.userId)&&this.getExtraInfo(t.userId);break;case P.GeneralActions.NETWORK_STATUS_CHANGED:break;case P.FriendsAction.FRIENDS_CHANGE_INFO:if(t)for(const e of t)this.data.has(e.userId)&&this.getUserInfo(e.userId)}}invitationEventHandler(e){switch(e.type){case sd.m.ReceiveAddFriendEvent:Array.isArray(e.payload)&&e.payload.forEach((e=>{const t=e.dataInfo.userId;e&&e.dataInfo&&(this._cachedFriendRequest[t]=e.dataInfo,this.data.has(t)&&this._updateVersion(t))}));break;case sd.m.UndoAddFriendEvent:case sd.m.AcceptAddFriendEvent:case sd.m.RejectAddFriendEvent:case sd.m.UndoSentRequestFriendEvent:this._cachedFriendRequest[e.payload]&&(delete this._cachedFriendRequest[e.payload],this.data.has(e.payload)&&this._updateVersion(e.payload))}}getItem(e,t){return this.data.get(e.key)}getList(e,t){return Array.from(this.data.keys())}onGetItemFailure(e,t){}onGetListFailure(e,t){}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||_E)||_E)||_E);var TE,ME=s("786D");Object(ie.b)(ME.a)(TE=Reflect.metadata("design:type",Function)(TE=Reflect.metadata("design:paramtypes",[])(TE=class{constructor(){this.name=ME.b,this.key="convId",this.didInit=!1,this.data=void 0,this._cachedFriendRequest={},this._dispatch=void 0,this._genMessageServer=void 0,this._connectClose=[],this._logger=void 0,this.type=void 0,this.data=new Map,this.eventHandler=this.eventHandler.bind(this)}get Logger(){return this._logger||(this._logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger(this.name,["group-controller"])),this._logger}init(e){this.didInit||(this.didInit=!0)}clearState(e){this.data.has(e)&&this.data.delete(e)}bindDispatch(e){this._dispatch=e,N.default.subscribe(this.eventHandler)}unbind(){this._dispatch=null,this._genMessageServer=null,this._connectClose=[],this.data.clear(),N.default.unsubscribe(this.eventHandler)}dispatch(e){this._dispatch?this._dispatch(e):this.Logger.zsymb(0,"o7SwC2","Lost dispatch")}bindGenMessageServer(e){this._genMessageServer=e}connectCloseModalCallback(e){this._connectClose.push(e)}_updateData(e,t,s){const i=this.data.get(e);i?this.data.set(e,Object(T.a)(Object(T.a)({},i),{},{[t]:i&&i[t]?A.default.deepMerge(i[t],s):s})):this.data.set(e,{[t]:s}),Object(Zs.g)(ME.b,e)}_udapteInfoData(e,t){var s;const i=this.data.get(e);return null!=i&&null!==(s=i.info)&&void 0!==s&&s.avatar&&(t.avatar=i.info.avatar),this._updateData(e,"info",t)}async getGroupInfo(e){const t=async()=>{try{const t=await Fe.default.getFullInfoGroupById(e,W.SRC_GET_PROFILE.FORCE_GET);return t&&this._udapteInfoData(e,t),t}catch(t){return this.Logger.zsymb(0,"eSyBAE","[getGroupInfo]",t),Fe.default.getGroupByIdSync(e,void 0)}},s=Fe.default.getGroupByIdSync(e,void 0);return this.data.has(e)?(this._udapteInfoData(e,s),s):(this._udapteInfoData(e,s),await t())}selectConversation(e){const t=this.data.get(e);if(t){fe.default.logAction(1460204),this.dispatch({type:P.ConversationListActions.SELECT_CONVERSATION,payload:t}),Qr.a.openConversation(e);const s=ye.p.getSelectConversationSource();s&&fe.default.logAction(s)}ft.ModalManagerV2.closeAllModal()}async addGroupAdmin(e,t,s){try{return await Fe.default.addGroupAdmin(t,s),!0}catch(i){if(this.Logger.zsymb(18,"xWGktV","[addGroupAdmin] error",i),!i)return;if(i.error_code){let s="";switch(i.error_code){case 161:s=ni.default.str(Ld.a.get("STR_GROUP_NO_EXIST",t));break;case 166:s=ni.default.str(Ld.a.get("STR_GROUP_NO_PERMISION",t));break;default:s=ni.default.str(Ld.a.get("STR_ADD_ADMIN_TOAST_UNSUCCESS",t))+" ("+i.error_code+")"}CE.a(e,void 0,s)}else i.code&&"ERR_NO_NETWORK"===i.code&&CE.a(e,"STR_CONNECTION_ERROR")}return!1}async changeGroupOwner(e,t,s,i=!1){var a;let n=!1;const r=(null===(a=Fe.default.getGroupByIdSync(t))||void 0===a?void 0:a.topMember)||[];for(const l of r)if(l.id===s){n=!0;break}if(!n)return void CE.b(ni.default.trans(Ld.a.get("STR_NO_LONGER_MEMBER_IN_GROUP",t),yE.h(s)));let o=t;o&&o.startsWith(W.GROUPID_PREFIX)&&(o=o.slice(1));try{return await Ni.default.changeGroupOwner(o,s),this._updateData(t,"info",{creatorId:s}),this.dispatch({type:P.ConversationListActions.UPDATE_GROUP_OWNER,payload:{userId:t,creatorId:s}}),i&&await this.leaveGroup(e,o),!0}catch(c){return CE.a(e,Ld.a.get("STR_CHANGE_GROUP_OWNER_FAIL",t)),!1}}async leaveGroup(e,t){try{await Ni.default.leaveGroup(t)}catch(s){s&&"ERR_NO_NETWORK"==s.code&&CE.a(e,"STR_CHECK_NET")}}eventHandler(e,t){switch(e){case P.FetchActions.UPDATE_NAME:t.constructor===Object&&this.data.has(t.userId)?this.getGroupInfo(t.userId):t.constructor===Array&&t.forEach((e=>{this.data.has(e)&&this.getGroupInfo(e)}));break;case P.FetchActions.GROUP_UPDATED:if(t){let{topMember:e=[],userId:i,isGroup:a}=t;const n=this.data.get(i);if(n&&a){var s;let t=null===(s=n.info)||void 0===s?void 0:s.topMember;(null==e?void 0:e.length)>0&&(t=e),this._updateData(i,"info",{topMember:t}),this.getGroupInfo(i)}}break;case P.FetchActions.UPDATE_GROUP_SETTING:if(t&&t.data){let e=t.data.groupId;if(e&&(e=W.GROUPID_PREFIX+e,this.data.has(e))){var i,a;const s=t.data.groupSetting||(null===(i=this.data.get(e))||void 0===i||null===(a=i.info)||void 0===a?void 0:a.setting);this._updateData(e,"info",{newSetting:s})}}break;case P.GroupsAction.GROUPS_CHANGE_INFO:t&&t.forEach((e=>{this.data.has(e)&&this.getGroupInfo(e)}));break;case P.FetchActions.DELETE_CONVERSATION:case P.FetchActions.GROUP_LEAVE:this.data.has(t)&&this._connectClose.forEach((e=>e()));break;case P.ConversationListActions.UPDATE_GROUP_OWNER:t&&this.data.has(t.userId)&&this._updateData(t.userId,"info",{creatorId:t.creatorId})}}getItem(e,t){return this.data.get(e.key)}getList(e,t){return Array.from(this.data.keys())}onGetItemFailure(e,t){}onGetListFailure(e,t){}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||TE)||TE);s("Ppsz");var RE,wE=s("o5gc");Object(ie.b)(wE.d)(RE=Reflect.metadata("design:type",Function)(RE=Reflect.metadata("design:paramtypes",[])(RE=class{constructor(){this.name=void 0,this.key=void 0,this.logger=void 0,this.data=void 0,this.genId=void 0,this.name=wE.a,this.key="userId",this.data=new Map,this.genId=new Eg.a}init(){throw new Error("Method not implemented.")}get Logger(){return this.logger||(this.logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger(Ss.ZLoggerNametags.reportV2,[this.name])),this.logger}getList(){return Array.from(this.data.keys())}getItem(e){return this.data.get(e.key)}onGetItemFailure(e){this.Logger.zsymb(20,"ZlkDhR","Get report abuse data item failed with id",e)}onGetListFailure(e){this.Logger.zsymb(20,"18HQCM","Get report abuse data list failed",e)}signalUpdateItem(e){Object(Zs.g)(this.name,e)}getOrCreateItem(e){let t=this.data.get(e);return t||(t={userId:e,expandAttachment:!1,selectedPhotos:[],selectedMessages:[]}),t}onOpenReport(e){U.default.report_v2.enable&&this.Logger.zsymb(0,"z8o2an","open report",e)}onReportDidOpen(e){if(U.default.report_v2.enable&&!this.data.has(e)){const t={userId:e,expandAttachment:!1,selectedPhotos:[],selectedMessages:[]};this.data.set(e,t),this.signalUpdateItem(e)}}onCloseReport(e){this.data.has(e)&&(this.cleanUpItem(e),Object(Zs.e)(this.name,e),this.Logger.zsymb(0,"l5WMib","close report",e))}cleanUpItem(e){const t=this.data.get(e);t&&(t.selectedPhotos.forEach((({url:e})=>{URL.revokeObjectURL(e)})),this.data.delete(e))}toggleAttachment(e){const t=this.getOrCreateItem(e);this.data.set(e,Object(T.a)(Object(T.a)({},t),{},{expandAttachment:!t.expandAttachment})),this.signalUpdateItem(e)}selectReason(e,t){const s=this.getOrCreateItem(e);this.data.set(e,Object(T.a)(Object(T.a)({},s),{},{reasonId:t})),this.signalUpdateItem(e)}onSelectedPhotos(e,t){const s=this.getOrCreateItem(e),i=t.map((({blob:e,filename:t,type:s})=>({blob:e,id:this.genId.next(),url:URL.createObjectURL(e),filename:t,type:s})));this.data.set(e,Object(T.a)(Object(T.a)({},s),{},{selectedPhotos:s.selectedPhotos.concat(i)})),this.signalUpdateItem(e)}onDeselectPhoto(e,t){const s=this.getOrCreateItem(e),i=[...s.selectedPhotos],a=i.findIndex((e=>e.id===t));if(a>=0){i.splice(a,1).forEach((({url:e})=>{URL.revokeObjectURL(e)})),this.data.set(e,Object(T.a)(Object(T.a)({},s),{},{selectedPhotos:i})),this.signalUpdateItem(e)}}clearAllAttachedPhotos(e){const t=this.getOrCreateItem(e);t.selectedPhotos.forEach((({url:e})=>{URL.revokeObjectURL(e)})),this.data.set(e,Object(T.a)(Object(T.a)({},t),{},{selectedPhotos:[]})),this.signalUpdateItem(e)}onSelectedMessages(e,t){const s=this.getOrCreateItem(e);this.data.set(e,Object(T.a)(Object(T.a)({},s),{},{selectedMessages:t})),this.signalUpdateItem(e)}clearAllAttachedMessages(e){const t=this.getOrCreateItem(e);this.data.set(e,Object(T.a)(Object(T.a)({},t),{},{selectedMessages:[]})),this.signalUpdateItem(e)}changeDescription(e,t){const s=this.getOrCreateItem(e);this.data.set(e,Object(T.a)(Object(T.a)({},s),{},{description:t})),this.signalUpdateItem(e)}})||RE)||RE);var LE,FE=s("7upJ");Object(i.singleton)(wE.e)(LE=Reflect.metadata("design:type",Function)(LE=Reflect.metadata("design:paramtypes",[])(LE=class{constructor(){this.logger=void 0,this.name=void 0,this.name=wE.b}get Logger(){return this.logger||(this.logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger(Ss.ZLoggerNametags.reportV2,[this.name])),this.logger}getRelatedStatus(e){return{blocked:Z.default.isBlocked(e),unfriended:!Z.default.isFriend(e)}}async blockAfterReport(e){try{await Z.default.blockFriend(e,W.SET_BLOCK)}catch(t){throw this.Logger.zsymb(18,"8wMqlg","block after report failed",e,t),t}}async unfriendAfterReport(e){try{await Z.default.removeFriend(e)}catch(t){throw this.Logger.zsymb(18,"jJSzMl","unfriend after report failed",e,t),t}}getReportReasonFromId(e,t){const s=FE.a.getSortedAbuseList(e);if(!Array.isArray(s))return null;const i=s.find((e=>e.id===t));return i?i[ni.default.getCurrentLanguageName()]:null}getContentMessageToReport(e){const{message:t,msgType:s}=e;if("object"==typeof t)switch(s){case W.MSG_LINK_CLIENT:case W.MSG_CONTACT:return t.title||t.href;case W.MSG_PHOTO:case W.MSG_PHOTO_2:case W.MSG_PHOTO_GROUP:case W.MSG_VIDEO:return t.oriUrl||t.title;case W.MSG_VOICE:return t.href;default:return t.title}return t}async submitReport(e){const t=new FormData,s={idTo:e.userId,objId:"person.profile",reason:String(e.reasonId),content:e.description};if(e.selectedPhotos.length){const i=e.selectedPhotos.map((e=>({filename:e.filename,type:e.type})));s.imgList=JSON.stringify(i),e.selectedPhotos.forEach((({blob:e},s)=>{t.append(`img${s}`,e)}))}if(e.selectedMessages.length){const t=e.selectedMessages.map((e=>({gmi:e.msgId,msg:this.getContentMessageToReport(e)}))).filter((({msg:e})=>!!e));s.msgList=JSON.stringify(t)}t.append("params",encodeURIComponent(A.default.encodeAES(JSON.stringify(s))));try{const s=await Ni.default.reportUserV2(t);this.Logger.zsymb(0,"rMoj6_","submit success",e.userId,s)}catch(i){throw this.Logger.zsymb(18,"QL3C2X","submit failed",e.userId,i),i}}})||LE)||LE);var DE=s("BpN3"),AE=s("UJhs");function NE(e){return"object"==typeof e&&!!e&&e.hasOwnProperty("loading")&&"boolean"==typeof e.loading&&e.type in AE.d&&e.hasOwnProperty("data")&&"object"==typeof e.data&&!!e.data}const kE="SEND_INPUT_PREVIEW",PE={[kE]:{feature:fe.FeaturesInfo.InputBoxPreview,subType:1}};var jE=function(e){return e[e.Chat=1]="Chat",e[e.Group=2]="Group",e[e.MyCloud=3]="MyCloud",e[e.OA=4]="OA",e}(jE||{});class UE{}UE.actionlogSendPreview=e=>{requestIdleCallback((()=>{try{var t;if(!e.length)return;const a=e.filter((e=>e.type===AE.d.PHOTO));if(!a.length)return;let n;const r=null==a||null===(t=a[0])||void 0===t?void 0:t.toUid;n=Object(yE.z)(r)?jE.OA:A.default.isGroup(r)?jE.Group:Object(yE.f)()===r?jE.MyCloud:jE.Chat;const o=e.length,c=[];for(let e=0;e<a.length;e++){var s,i;const t=a[e],n={photo_position:e+1,caption_length:(null==t||null===(s=t.caption)||void 0===s?void 0:s.length)||0,is_caption_form:null!=t&&null!==(i=t.caption)&&void 0!==i&&i.length?1:0};c.push(n)}const l={total_item_in_group:o,caption_info:c,chat_type:n};UE._actionlogSendInputPreview(kE,l)}catch(a){B.dangerouslyLogConsole.error("InputPreviewActionLog.logSendPreview",a)}}),{timeout:5e3})},UE._actionlogSendInputPreview=async(e,t)=>{const s=PE[e].feature,i=PE[e].subType;fe.default.logActionInfoV2(s,i,t)};var BE,GE=UE;Object(i.injectable)()(BE=Object(ie.b)(DE.b)(BE=class{constructor(){this._eventEmitter=new jl.a,this.addPreviewItem=e=>{var t;Object(Jc.a)(function(e){return NE(e)&&e.type!==AE.d.PLACEHOLDER}(e),"invalid item for input preview, must be InputPreviewData");const s=e,i=s.data,a=i.toUid,n=this.mayInitState(a),r=null!==(t=s.previewId)&&void 0!==t?t:i.clientId,o=n.oriItems.length>0?[...n.oriItems]:[...n.items],c=o.findIndex((e=>e.previewId===r)),l=s.data.clientId;(this.removedItems.get(a)||new Set).has(l)||(-1!==c?o[c]=Object(T.a)(Object(T.a)(Object(T.a)({},n.items[c]),s),{},{previewId:r}):o.push(s),this.data.set(a,Object(T.a)(Object(T.a)({},n),{},{items:o,oriItems:o})),Object(Zs.g)(this.name,a),this.emit("ON_ADD_INPUT_PREVIEW",{conversationId:a}))},this.getOrderedItemsForSending=e=>{const t=this.getOrderedItems(e).map((e=>e&&e.type===AE.d.GIF?Object(T.a)(Object(T.a)({},e),{},{type:AE.d.PHOTO}):e));return GE.actionlogSendPreview(t.map((e=>Object(T.a)({},e)))),t},this.removePreviewItemById=(e,t)=>{const s=this.data.get(e);if(!s)return;const i=s.items.filter((e=>e.data.clientId!==t)),a=s.oriItems.filter((e=>e.data.clientId!==t));this.data.set(e,Object(T.a)(Object(T.a)({},s),{},{items:i,oriItems:a})),Object(Zs.g)(this.name,e)},this.name=DE.a,this.data=new Map,this.removedItems=new Map,this.key="conversationId"}on(e,t){return this._eventEmitter.on(e,t),()=>this._eventEmitter.off(e,t)}off(e,t){this._eventEmitter.off(e,t)}emit(e,t){this._eventEmitter.emit(e,t)}hasPreviewItems(e){const t=this.data.get(e);return!!t&&t.items.length>0}selectItem(e,t){if(!e||!t)return;const s=this.mayInitState(e);this.data.set(e,Object(T.a)(Object(T.a)({},s),{},{selectedItem:t})),Object(Zs.g)(this.name,e)}selectPreviousItem(e){const t=this.mayInitState(e),s=t.items,i=t.selectedItem;if(!i)return;const a=s.findIndex((e=>e.data.clientId===i.cliMsgId));if(-1===a)return;const n=Math.max(a-1,0);this.data.set(e,Object(T.a)(Object(T.a)({},t),{},{selectedItem:s[n]})),Object(Zs.g)(this.name,e)}selectNextItem(e){const t=this.mayInitState(e),s=t.items,i=t.selectedItem;if(!i)return;const a=s.findIndex((e=>e.data.clientId===i.cliMsgId));if(-1===a)return;const n=Math.min(a+1,s.length-1);this.data.set(e,Object(T.a)(Object(T.a)({},t),{},{selectedItem:s[n]})),Object(Zs.g)(this.name,e)}addPlaceholder(e,t){Object(Jc.a)("string"==typeof e&&!!e,"conversationId must be string"),Object(Jc.a)("object"==typeof t&&!(null==t||!t.clientId),"invalid item for input preview placeholder");const s=this.mayInitState(e),i={loading:!0,type:AE.d.PLACEHOLDER,previewId:t.clientId,data:{clientId:t.clientId}};this.data.set(e,Object(T.a)(Object(T.a)({},s),{},{items:[...s.items,i],oriItems:[...s.oriItems,i]})),Object(Zs.g)(this.name,e)}getPreviewItemsCount(e){var t,s;return null!==(t=null===(s=this.data.get(e))||void 0===s?void 0:s.items.length)&&void 0!==t?t:0}getOrderedItems(e){const t=this.data.get(e);if(!t)return[];let s=[];const i=t.oriItems.filter((e=>{const t=e.type!==AE.d.PLACEHOLDER;return t&&s.push(e.data.clientId),t})).map((e=>{var s;const i=(null===(s=t.caption[e.data.clientId])||void 0===s?void 0:s.saved)||"",a=Object(T.a)(Object(T.a)({},e.data),{},{caption:i});return Object(T.a)(Object(T.a)({},e),{},{data:a})}));s=s.sort(((e,t)=>e-t));return i.map(((e,t)=>Object(T.a)(Object(T.a)({},e.data),{},{clientId:s[t]})))}getRawOrderedItems(e){const t=this.data.get(e);return t?t.oriItems:[]}updateOrder(e,t){const s=this.mayInitState(e);Object(Jc.a)(Array.isArray(t),`invalid items for input preview at ${e}`),this.data.set(e,Object(T.a)(Object(T.a)({},s),{},{oriItems:t})),Object(Zs.g)(this.name,e)}removePreviewItem(e,t){const s=this.data.get(e);if(!s)return;const i=[...s.items],a=[...s.oriItems],n=i[t];if(!n)return;const r=a.indexOf(n);i.splice(t,1),-1!==r&&a.splice(r,1),this.data.set(e,Object(T.a)(Object(T.a)({},s),{},{items:i,oriItems:a})),n.type===AE.d.PHOTO&&URL.revokeObjectURL(n.data.img),Object(Zs.g)(this.name,e),this.emit("ON_REMOVE_INPUT_PREVIEW",{conversationId:e})}removeAllItems(e,t=!1){const s=this.data.get(e);if(!s)return;const i=this.removedItems.get(e)||new Set;if(!t)for(let a of s.items)i.add(a.data.clientId),a.type===AE.d.PHOTO&&URL.revokeObjectURL(a.data.img);this.removedItems.set(e,i),this.data.delete(e),Object(Zs.g)(this.name,e),this.emit("ON_REMOVE_INPUT_PREVIEW",{conversationId:e})}saveDraft(e,t,s){const i="string"==typeof s?s.trimStart().trimEnd():"",a=this.mayInitState(e);Object(Jc.a)(!!a,`invalid state when saveDraft for conversationId ${e}`),Object(Jc.a)("string"==typeof i,`invalid draft for conversationId ${e}`);let n=a.caption[t]||{saved:"",draft:""};if(n.saved===i&&n.draft===i)return;n=Object(T.a)(Object(T.a)({},n),{},{draft:i});const r=Object(T.a)(Object(T.a)({},a.caption),{},{[t]:n}),o=new Set(a.unsavedChanges);n.saved!==n.draft?o.add(t):o.delete(t),this.data.set(e,Object(T.a)(Object(T.a)({},a),{},{caption:r,unsavedChanges:Array.from(o)})),Object(Zs.g)(this.name,e)}applyDraft(e,t){return Object(Jc.a)("string"==typeof e&&!!e,"InputCaption: conversationId must be string"),"number"==typeof t?this.applyDraftSingle(e,t):this.applyDraftMulti(e)}resetSelectedItem(e){if(!e)return;const t=this.mayInitState(e);this.data.set(e,Object(T.a)(Object(T.a)({},t),{},{selectedItem:null})),Object(Zs.g)(this.name,e)}applyDraftSingle(e,t){const s=this.mayInitState(e);Object(Jc.a)(!!s,`invalid state when addCaption for conversationId ${e}`);let i=s.caption[t];if(!i||i.saved===i.draft)return;const a=i.draft||"";i=Object(T.a)(Object(T.a)({},i),{},{saved:a});const n=Object(T.a)(Object(T.a)({},s.caption),{},{[t]:i}),r=new Set(s.unsavedChanges);r.delete(t),this.data.set(e,Object(T.a)(Object(T.a)({},s),{},{caption:n,unsavedChanges:Array.from(r)})),Object(Zs.g)(this.name,e)}applyDraftMulti(e){const t=this.mayInitState(e);Object(Jc.a)(!!t,`invalid state when addCaption for conversationId ${e}`);const s=Object(T.a)({},t.caption);Object.keys(s).forEach((e=>{const t=s[e];if(!t||t.saved===t.draft)return;const i=t.draft||"";s[e]=Object(T.a)(Object(T.a)({},t),{},{saved:i})}));const i=Object(T.a)(Object(T.a)({},t),{},{caption:s,unsavedChanges:[]});this.data.set(e,i),Object(Zs.g)(this.name,e)}discardDraftedCaption(e,t){return Object(Jc.a)("string"==typeof e&&!!e,"InputCaption: conversationId must be string"),"number"==typeof t?this.discardDraftedCaptionSingle(e,t):this.discardDraftedCaptionMulti(e)}discardDraftedCaptionSingle(e,t){const s=this.mayInitState(e);if(!s)return;const i=s.caption[t];if(!i||!i.draft)return;const a=s.caption[t],n=Object(T.a)(Object(T.a)({},s.caption),{},{[t]:Object(T.a)(Object(T.a)({},a),{},{draft:null==a?void 0:a.saved})}),r=new Set(s.unsavedChanges);r.delete(t),this.data.set(e,Object(T.a)(Object(T.a)({},s),{},{caption:n,unsavedChanges:Array.from(r)})),Object(Zs.g)(this.name,e)}discardDraftedCaptionMulti(e){let t=this.data.get(e);if(!t)return;const s=Object(T.a)({},t.caption);if(s)for(const i in s)s[i].draft=s[i].saved;t=Object(T.a)(Object(T.a)({},t),{},{caption:s,unsavedChanges:[]}),this.data.set(e,t),Object(Zs.g)(this.name,e)}getCaption(e,t){return this.mayInitState(e).caption[t]}_listenEvents(){}mayInitState(e){let t=this.data.get(e);return t||(t={conversationId:e,items:[],oriItems:[],selectedItem:null,caption:{},unsavedChanges:[]},this.data.set(e,t)),t}init(){this._listenEvents()}getItem(e){return this.data.get(e.key)}getList(e){return"all"===e.key?Array.from(this.data.keys()):[]}onGetItemFailure(e){}onGetListFailure(e){}})||BE);var zE=s("ONNR"),xE=s("1Q0E"),VE=s("kCjk");function HE(e,t){switch(t){case"byte-to-mb":return e/1024/1024;case"kb-to-mb":return e/1024;default:return}}function qE(e,t=""){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")+t}function WE(e){const t=new URL(e);return"/"!==t.pathname?t.pathname:t.hostname}var ZE=s("XnIt"),KE=s("CaBZ"),QE=s("mHfx");let $E,YE;try{$E=$znode.fs,YE=$znode.path}catch(kF){}async function JE(e){return new Promise((t=>{try{$E.readdir(e,(async(s,i)=>{if(s)return t(0);let a=0;for(let t=0;t<i.length;t++){const s=i[t],n=YE.join(e,s),r=$E.statSync(n);if(Object(QE.a)(r)){a+=await JE(n)}a+=r.size}t(a)}))}catch(s){t(0)}}))}var XE,eO=new class{constructor(){this.lastFrameTime=0,this.fps=0,this.pause=!0}loop(e){if(this.pause)return;const t=e;if(0===this.lastFrameTime)return this.lastFrameTime=t,void requestAnimationFrame(this.loop.bind(this));const s=t-this.lastFrameTime;s>0&&(this.fps=Math.round(1e3/s),this.lastFrameTime=t),requestAnimationFrame(this.loop.bind(this))}start(){this.pause=!1,requestAnimationFrame(this.loop.bind(this))}stop(){this.lastFrameTime=0,this.fps=0,this.pause=!0}get value(){return this.fps}};const tO="z_m_h_",sO="z_m_h_i___",iO={CPU:!0,GPU:!0,RAM:!0,FPS:!0,"JS Heap":!0,"Root Render":!0,LCP:!0};Object(ie.b)(xE.b)(XE=Object(i.injectable)()(XE=Object(i.singleton)()(XE=Reflect.metadata("design:type",Function)(XE=Reflect.metadata("design:paramtypes",[])(XE=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.isStarted=!1,this.userId=void 0,this.monitorItems=[],this.showMonitorItems=new Map,this.rootRenderInitTime=fi.a.now(),this.rootRenderNumber=1,this.lcpMetric=void 0,this.intervalCheck=void 0,this.intervalCheckSteps=0,this.data={isShowZPCHealth:!1,monitorItemForUIs:[]},this.usageMonitor=void 0,this.name=xE.a,this.key=xE.a}initialize(e){this.isStarted||(this.isStarted=!0,function(){const e=i.ModuleContainer.resolve(KE.b);e.registerMonitorItem({expectedOrderPosition:1,title:"Database",description:"Cache & IndexedDB",getValue:async()=>{var e,t,s;let i=(null===(e=await(null===(t=navigator.storage)||void 0===t||null===(s=t.estimate)||void 0===s?void 0:s.call(t)))||void 0===e?void 0:e.usage)||0;return i=Math.round(HE(i,"byte-to-mb")||0),i},getType:e=>e>=200&&e<=500?"medium":e>500?"high":"low",getContent:e=>qE(e," MB"),checkSteps:10}),e.registerMonitorItem({expectedOrderPosition:2,title:"DOM",description:"DOM nodes",getValue:()=>document.getElementsByTagName("*").length||0,getType:e=>e>=3e3&&e<=6e3?"medium":e>6e3?"high":"low",getContent:e=>qE(e," nodes"),checkSteps:2}),e.registerMonitorItem({expectedOrderPosition:3,title:"Temp Files",description:"ZaloTemp & zTemp",getValue:async()=>{try{const e=await Object(re.getZaloTempDir)(),t=await JE(e),s=await Object(re.getzTempDir)(),i=await JE(s);return Math.round(HE(t+i,"byte-to-mb")||0)}catch(e){return 0}},getType:e=>e>=50&&e<=100?"medium":e>100?"high":"low",getContent:e=>qE(e," MB"),checkSteps:100}),e.registerMonitorItem({expectedOrderPosition:6,title:"Custom Domains",description:"Count custom domains usage",getValue:async()=>{const e=i.ModuleContainer.resolve(ZE.a).getDomainConfig();let t=0;if(!e)return t;for(const s in e)e.hasOwnProperty(s)&&e[s].useDevDomain&&t++;return t},getType:e=>"low",getContent:e=>qE(e,""),checkSteps:2})}());const t=this.getStorage().getItem(tO);this.data.isShowZPCHealth="1"===t;const s=this.getStorage().getItem(sO);if(s){s.split(",").forEach((e=>{e&&this.showMonitorItems.set(e,1)}))}this.data.isShowZPCHealth&&Object(VE.b)()&&(Object(zE.a)((e=>{this.lcpMetric=e}),{reportAllChanges:!0}),this.userId=e,this.startHealthCheck())}destroy(){this.stopHealthCheck()}registerMonitorItem(e){const t=`${e.expectedOrderPosition||""}_${e.title.replace(" ","")}`,s=Object(T.a)(Object(T.a)({},e),{},{id:t});this.monitorItems.push(s),this.monitorItems=this.monitorItems.sort(((e,t)=>e.expectedOrderPosition&&t.expectedOrderPosition?e.expectedOrderPosition-t.expectedOrderPosition:0))}addRootRender(){this.data.isShowZPCHealth&&Object(VE.b)()&&this.rootRenderNumber++}resetRootRender(){this.rootRenderNumber=1}startHealthCheck(){this.intervalCheck||(eO.start(),this.getMonitorItems(this.userId),this.intervalCheck=setInterval((()=>{this.getMonitorItems(this.userId),this.intervalCheckSteps++}),VE.a.INTERVAL_CHECK_TIME))}stopHealthCheck(){eO.stop(),this.rootRenderNumber=1,this.intervalCheck&&(clearInterval(this.intervalCheck),this.intervalCheck=void 0,this.intervalCheckSteps=0)}toggleZPCHealth(){this.data.isShowZPCHealth=!this.data.isShowZPCHealth,this.getStorage().setItem(tO,this.data.isShowZPCHealth?"1":"0"),this.data.isShowZPCHealth||this.stopHealthCheck(),Object(Zs.g)(this.name,"")}getMonitorList(){return this.monitorItems.map((e=>({id:e.id,title:e.title,isShow:!(!this.showMonitorItems.get(e.id)&&!iO[e.title])})))}showZPCHealthItem(e,t){if(!e)return;t?this.showMonitorItems.set(e,1):this.showMonitorItems.delete(e);let s="";this.showMonitorItems.forEach(((e,t)=>{s+=t+","})),this.getStorage().setItem(sO,s),this.stopHealthCheck(),this.startHealthCheck()}async getMonitorItems(e){var t,s,i,a;const n=await $zperf.getCpuInfos();let r=0,o=0,c=0;null==n||n.forEach((e=>{var t,s;const i=(null==e||null===(t=e.cpu)||void 0===t?void 0:t.percentCPUUsage)||0,a=(null==e||null===(s=e.memory)||void 0===s?void 0:s.workingSetSize)||0;"GPU"!==e.type?(r+=i,c+=a):o+=i})),r=Math.round(r),o=Math.round(o),c=Math.round(HE(c,"kb-to-mb")||0);let l=(null===(t=performance.memory)||void 0===t?void 0:t.usedJSHeapSize)||0;l=Math.round(HE(l,"byte-to-mb")||0);const d=eO.value;let h=(null===(s=await(null===(i=navigator.storage)||void 0===i||null===(a=i.estimate)||void 0===a?void 0:a.call(i)))||void 0===s?void 0:s.usage)||0;h=Math.round(HE(h,"byte-to-mb")||0);const u=Math.round((fi.a.now()-this.rootRenderInitTime)/1e3/60)||1,g=Math.round(this.rootRenderNumber/u),m=[...[{id:"0_CPU",title:"CPU",description:"CPU usage",getValue:()=>r,getType:e=>e>=20&&e<=40?"medium":e>40?"high":"low",getContent:e=>qE(e," %"),checkSteps:2},{id:"0_GPU",title:"GPU",description:"GPU usage",getValue:()=>o,getType:e=>e>=10&&e<=30?"medium":e>30?"high":"low",getContent:e=>qE(e," %"),checkSteps:2},{id:"0_FPS",title:"FPS",description:"Frame Per Second",getValue:()=>d,getType:e=>e>=20&&e<=30?"medium":e<20?"high":"low",getContent:e=>qE(e),checkSteps:1},{id:"0_RAM",title:"RAM",description:"RAM usage",getValue:()=>c,getType:e=>e>=500&&e<=1e3?"medium":e>1e3?"high":"low",getContent:e=>qE(e," MB"),checkSteps:2},{id:"0_JSHeap",title:"JS Heap",description:"JS Heap usage",getValue:()=>l,getType:e=>e>=200&&e<=300?"medium":e>300?"high":"low",getContent:e=>qE(e," MB"),checkSteps:2},{id:"0_RootRender",title:"Root Render",description:"Root Render in minutes",getValue:()=>g,getType:e=>e>=10&&e<=20?"medium":e>20?"high":"low",getContent:e=>qE(e," times / minute"),checkSteps:2},{id:"0_LCP",title:"LCP",description:"Largest Contentful Paint",getValue:()=>{var e;return Math.round(((null===(e=this.lcpMetric)||void 0===e?void 0:e.value)||0)/1e3)},getType:e=>{var t;switch(null===(t=this.lcpMetric)||void 0===t?void 0:t.rating){case"poor":return"high";case"needs-improvement":return"medium";default:return"low"}},getContent:e=>qE(e," s"),checkSteps:2}],...this.monitorItems],p=[];for(let b=0;b<m.length;b++){const t=m[b];let s=!1;s=!(!this.showMonitorItems.get(t.id)&&!iO[t.title]);let i,a,n=0;var f,v,_;if(s)if(this.data.monitorItemForUIs[b]&&this.intervalCheckSteps%(t.checkSteps||1)!=0)i=this.data.monitorItemForUIs[b].type,a=this.data.monitorItemForUIs[b].content;else n=await(null===(f=t.getValue)||void 0===f?void 0:f.call(t,e))||0,i=null===(v=t.getType)||void 0===v?void 0:v.call(t,n),a=null===(_=t.getContent)||void 0===_?void 0:_.call(t,n);const r={id:t.id,title:t.title,description:t.description,type:i,content:a,isShow:s,checkTime:(t.checkSteps||1)*VE.a.INTERVAL_CHECK_TIME};p.push(r)}this.data.monitorItemForUIs=p,Object(Zs.g)(this.name,"")}getStorage(){return n.default.getInstance()}getItem(e,t){return this.data}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||XE)||XE)||XE)||XE);var aO=s("zdwi"),nO=s("E/Lo");const rO="1",oO={windowId:rO,name:"ZPC_HEALTH"},cO={windowId:rO,name:"METRICS"};var lO,dO=s("Igfx"),hO=s("noAy");const uO="z_m_h_f_",gO="z_m_h_r_",mO="z_m_h_r_w_";Object(ie.b)(aO.a)(lO=Object(i.injectable)()(lO=Object(i.singleton)()(lO=function(e,t){return Object(i.inject)(hO.b)(e,void 0,0)}(lO=Reflect.metadata("design:type",Function)(lO=Reflect.metadata("design:paramtypes",[void 0===hO.b?Object:hO.b])(lO=class{constructor(e){this.resourceWarning=e,this.type=void 0,this.name=void 0,this.key=void 0,this.data={isShow:!1,isShowRenderingDebugger:!1,isShowReactiveLogger:!1,isShowResourceWarning:!1},this.observeRendering=void 0,this.name=aO.b,this.key=aO.b}initialize(){if(!Object(VE.b)())return;this.observeRendering=this.observeRendering?this.observeRendering:Object(nO.b)(),ft.ModalManagerV2.addModal(Object(T.a)(Object(T.a)({},oO),{},{altWindowId:void 0})),ft.ModalManagerV2.subscribeTriggers({windowId:rO,name:oO.name,trigger:e=>{}});const e=this.getStorage().getItem(uO);var t;(this.data.isShowRenderingDebugger="1"===e,"1"===e)&&(null===(t=this.observeRendering)||void 0===t||t.observe());const s=this.getStorage().getItem(gO);this.data.isShowReactiveLogger="1"===s,this.data.isShowReactiveLogger?dO.a.enable():dO.a.disable();const i=this.getStorage().getItem(mO);this.data.isShowResourceWarning=null!==i?"1"===i:this.data.isShowResourceWarning,this.data.isShowResourceWarning?this.resourceWarning.enable():this.resourceWarning.disable(),Object(Zs.g)(this.name,"all")}destroy(){0}showZPCHealthPopup(e){Object(VE.b)()&&(e?ft.ModalManagerV2.openModal(Object(T.a)(Object(T.a)({},oO),{},{windowId:rO,params:null})):ft.ModalManagerV2.closeModal(Object(T.a)(Object(T.a)({},oO),{},{windowId:rO})),this.data.isShow=e,Object(Zs.g)(this.name,"all"))}setIsShowRenderingDebugger(e){var t,s;(this.data.isShowRenderingDebugger=e,this.getStorage().setItem(uO,e?"1":"0"),e)?null===(t=this.observeRendering)||void 0===t||t.observe():null===(s=this.observeRendering)||void 0===s||s.disconnect();Object(Zs.g)(this.name,"all")}setIsShowReactiveLogger(e){this.data.isShowReactiveLogger=e,this.getStorage().setItem(gO,e?"1":"0"),e?dO.a.enable():dO.a.disable(),Object(Zs.g)(this.name,"all")}setIsShowResourceWarning(e){this.data.isShowResourceWarning=e,this.getStorage().setItem(mO,e?"1":"0"),e?this.resourceWarning.enable():this.resourceWarning.disable(),Object(Zs.g)(this.name,"all")}getStorage(){return n.default.getInstance()}getItem(e,t){return this.data}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||lO)||lO)||lO)||lO)||lO);var pO,fO=s("Bwur");Object(ie.b)(fO.b)(pO=Object(i.injectable)()(pO=Object(i.singleton)()(pO=Reflect.metadata("design:type",Function)(pO=Reflect.metadata("design:paramtypes",[])(pO=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.data={isShow:!1},this.name=fO.a,this.key=fO.a}initialize(){Object(VE.b)()&&(ft.ModalManagerV2.addModal(Object(T.a)(Object(T.a)({},cO),{},{altWindowId:void 0})),ft.ModalManagerV2.subscribeTriggers({windowId:rO,name:cO.name,trigger:e=>{}}))}destroy(){0}showMetricsPopup(e){Object(VE.b)()&&(e?ft.ModalManagerV2.openModal(Object(T.a)(Object(T.a)({},cO),{},{windowId:rO,params:null})):ft.ModalManagerV2.closeModal(Object(T.a)(Object(T.a)({},cO),{},{windowId:rO})),this.data.isShow=e,Object(Zs.g)(this.name,"all"))}getItem(e,t){return this.data}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||pO)||pO)||pO)||pO);var vO=s("1UUk"),_O=s("PmZf");class bO{constructor(e){this._queue=void 0,this._maxSize=void 0,this._queue=[],this._maxSize=null==e?void 0:e.maxSize}enqueue(e){this._maxSize&&this._queue.length>=this._maxSize&&this._queue.shift(),this._queue.push(e)}dequeue(){return this._queue.shift()}peek(){return this._queue[0]}isEmpty(){return 0===this._queue.length}get length(){return this._queue.length}clear(){this._queue=[]}toArray(){return this._queue}}var yO,IO=s("WZ0o");const SO="requests / second",CO=1e3;Object(ie.b)(hO.b)(yO=Object(i.injectable)()(yO=Object(i.singleton)()(yO=function(e,t){return Object(i.inject)(vO.b)(e,void 0,0)}(yO=Reflect.metadata("design:type",Function)(yO=Reflect.metadata("design:paramtypes",[void 0===vO.a?Object:vO.a])(yO=class{constructor(e){this.databaseManager=e,this.type=void 0,this.name=void 0,this.key=void 0,this.data={network:{totalRequestInLiveTime:0,queue:new bO,hitCount:0,error:void 0},database:{totalRequestInLiveTime:0,queue:new bO,hitCount:0,error:void 0}},this.warningConfigs=VE.c,this.isEnable=void 0,this.initTime=void 0,this.timeoutSignals={},this.enableLogEachRequest=void 0,this.hitQueue=new bO({maxSize:20}),this.observePerformance=void 0,this.name=hO.a,this.key=hO.a,this.dbQueryExecListener=this.dbQueryExecListener.bind(this)}enable(){Object(VE.b)()&&(this.isEnable||(this.isEnable=!0,this.setup()))}disable(){var e;this.isEnable=!1,null===(e=this.observePerformance)||void 0===e||e.disconnect(),this.databaseManager.removeEventListener(_O.b.QueryExec,this.dbQueryExecListener),this.resetData()}getData(){return this.data}resetNetworkError(){this.data.network.totalRequestInLiveTime=0,this.data.network.error=void 0,Object(Zs.g)(this.name,"all")}resetDatabaseError(){this.data.database.totalRequestInLiveTime=0,this.data.database.error=void 0,Object(Zs.g)(this.name,"all")}setWarningConfigs(e){this.warningConfigs=e}setEnableLogEachRequest(e){this.enableLogEachRequest=e}getHitQueue(){return this.hitQueue}setup(){this.initTime=Object(nO.d)(),this.observePerformance=this.observePerformance?this.observePerformance:Object(IO.b)(["resource"],this.listenObservePerformance.bind(this)),this.observePerformance.observe(),this.databaseManager.addEventListener(_O.b.QueryExec,this.dbQueryExecListener)}listenObservePerformance(e){let t=e.filter((e=>"resource"===e.entryType)).filter((e=>"xmlhttprequest"===e.initiatorType));if(0!==t.length){this.dequeueQueue(this.data.network.queue);for(let e=0;e<t.length;e++){const s=t[e],i={url:s.name,path:WE(s.name),ts:Object(nO.d)()};this.data.network.queue.enqueue(i),this.data.network.totalRequestInLiveTime++,this.enableLogEachRequest}this.slowHandleWarning("network",this.data.network,(()=>this.getWarningDetail("network",this.data.network.queue,(e=>{var t;return(null===(t=e.url)||void 0===t?void 0:t.startsWith("file://"))?"file":`${e.path}`}))))}}dbQueryExecListener(e){const t=e.data;if(!t)return;this.dequeueQueue(this.data.database.queue);const s={database:t.database,method:t.method,table:t.table,ts:Object(nO.d)()};this.data.database.queue.enqueue(s),this.data.database.totalRequestInLiveTime++,this.enableLogEachRequest,this.slowHandleWarning("database",this.data.database,(()=>this.getWarningDetail("database",this.data.database.queue,(e=>`${e.database}.${e.table}`))))}dequeueQueue(e){const t=e.peek();if(t&&t.ts){if(!(Object(nO.d)()-t.ts>CO))return;e.dequeue(),this.dequeueQueue(e)}}slowHandleWarning(e,t,s){this.timeoutSignals[e]||(this.timeoutSignals[e]=setTimeout((()=>{const i=s();this.handleWarning(e,t,i),this.timeoutSignals[e]=void 0}),500))}handleWarning(e,t,s){const i=this.warningConfigs[e].default,a=this.warningConfigs[e].items,n=this.warningConfigs[e].avgRequest,r=i.hit;let o,c,l;const d=s.sorted;for(let h=0;h<d.length;h++){const[e,t]=d[h],i=a[e];if(i){if(t>=i.hit){o=`HIT. ${t} ${SO} (${e})`,c=JSON.stringify(d),l=JSON.stringify(s.meta);break}}else if(t>=r){o=`HIT. ${t} ${SO} (${e})`,c=JSON.stringify(d),l=JSON.stringify(s.meta);break}}if(!o&&this.initTime){let e=t.totalRequestInLiveTime/((Object(nO.d)()-this.initTime)/CO);e=Math.round(e),e>=n&&(o=`AVG. ${e} ${SO}`)}o&&(t.hitCount++,t.error={code:400,message:o,description:c,meta:l,ts:Date.now()},this.hitQueue.enqueue(Object(T.a)(Object(T.a)({},t.error),{},{type:e})),Object(Zs.g)(this.name,"all"))}getWarningDetail(e,t,s){const i={};let a="database"===e?{}:void 0;t.toArray().forEach((e=>{const t=s(e);a&&e.method&&(a[e.method]?a[e.method]++:a[e.method]=1),i[t]?i[t]++:i[t]=1}));return{sorted:Object.entries(i).sort((([,e],[,t])=>t-e)),meta:a}}resetData(){this.initTime=void 0,this.data.network.totalRequestInLiveTime=0,this.data.network.queue.clear(),this.data.network.hitCount=0,this.data.network.error=void 0,this.data.database.totalRequestInLiveTime=0,this.data.database.queue.clear(),this.data.database.hitCount=0,this.data.database.error=void 0;for(let e in this.timeoutSignals)this.timeoutSignals[e]&&clearTimeout(this.timeoutSignals[e]);Object(Zs.g)(this.name,"all")}getItem(e,t){return this.data}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||yO)||yO)||yO)||yO)||yO);Object(VE.b)()&&(window.$zpcHealth||(window.$zpcHealth={}),window.$zpcHealth.resourceWarningController=i.ModuleContainer.resolve(hO.b));const EO={maxRetry:3},OO=e=>(t,s,i)=>{const a=i.value,n=new Map;i.value=async function(...t){const s=e(t);let i=n.get(s);return i||(i=a.apply(this,t),i.finally((()=>n.delete(s))),n.set(s,i)),i}};var TO,MO,RO,wO,LO,FO,DO,AO=s("Hk5Z"),NO=s("Y3Ul"),kO=s("kuNG"),PO=s("5miw");TO=Object(i.injectable)(),MO=Object(i.singleton)(AO.a),RO=OO((([e])=>e)),wO=Reflect.metadata("design:type",Function),LO=Reflect.metadata("design:paramtypes",[void 0===PO.RemoteURL?Object:PO.RemoteURL]),TO(FO=MO((DO=class{constructor(){this.responseCache_=void 0}async convert(e){if(!e||"string"!=typeof e)return NO.a.Error({error:new Error("Invalid Remote URL!")});if("blob:"===e.slice(0,5))return NO.a.Success({blobURL:e});this.responseCache_||(this.responseCache_=this.getCacheLazily_());if(this.responseCache_.has(e)){const t=this.responseCache_.get(e);return NO.a.Success({blobURL:t.blobURL})}try{const t=Object(fl.a)(fetch,{min:1e3,max:5e3,retries:3,afterRetry:async({success:e})=>{}}),s=await t(e),i=await s.blob(),a=URL.createObjectURL(i);return this.responseCache_.set(e,{remoteURL:e,blobURL:a}),NO.a.Success({blobURL:a})}catch(t){return NO.a.Error({error:t})}}revokeBlobUrl_(e){URL.revokeObjectURL(e)}getCacheLazily_(){return new h.default({maxSize:Object(kO.a)().config.max_bu_cache_size,onEviction:(e,t)=>{this.revokeBlobUrl_(t.blobURL)}})}},Object(n_.a)(DO.prototype,"convert",[RO,wO,LO],Object.getOwnPropertyDescriptor(DO.prototype,"convert"),DO.prototype),FO=DO))||FO);const jO=Object(i.define)("InternalEventBus");var UO;Object(i.injectable)()(UO=Object(i.singleton)(jO)(UO=class extends De.b{})||UO);const BO=Object(i.define)("AIStickerMapper");var GO=s("z80d");function zO(e,t="token"){if("number"!=typeof e||Number.isNaN(e))throw Error(`${t}=${e} is invalid!`);return e}class xO{constructor(e,t,s,i,a){this.id=void 0,this.rootStickerCateId=void 0,this.url=void 0,this.width=void 0,this.height=void 0,this.id=zO(e,"id"),this.rootStickerCateId=zO(t,"rootStickerCateId"),this.url=function(e,t="token"){if(!e)throw Error(`${t}=${e} is invalid!`);return e}(s,"url"),this.width=zO(i,"width"),this.height=zO(a,"height")}equals(e){return this.id===e.id}}var VO;s("SF1S");Object(i.injectable)()(VO=Object(i.singleton)(BO)(VO=class{toAIStickerDTOFromDomain(e){return{id:e.id,url:e.url,thumb:"",type:GO.f.AI_GENERATED,intrinsicWidth:e.width,intrinsicHeight:e.height,renderedWidth:e.width,renderedHeight:e.height,animatable:!1}}toEntityFromSchema(e){return new xO(e.id,e.rootStickerCateId,e.url,e.width,e.height)}toSchemaFromEntity(e){return{id:e.id,rootStickerCateId:e.rootStickerCateId,url:e.url,width:e.width,height:e.height}}})||VO);const HO=Object(i.define)("AIStickerAPIClient");var qO;let WO=Object(i.injectable)()(qO=class{forwardAIStickerMessage(e,t,s,i,a,n){return Ni.default.apiForwardMessage(e,W.MSG_PHOTO,t,s,i,a,n)}fetchAIStickerList(){const e={imei:ra.default.getZaloClientID()},t=`${w.b.getStickerDomain()}/api/message/sticker/ai/list?${this.getCommonParams_()}&params=${this.encodeParams_(e)}`;return new Promise(((e,s)=>{this.makeGETRequest_(t,null,12190).then(os.a).then(e).catch(s)}))}makeGETRequest_(e,t,s,i,a,n,r,o,c){return rs.default._get(e,t,s,i,a,n,r,o,c)}getCommonParams_(){return rs.default._getCommonParams()}encodeParams_(e){return rs.default.getEncodedParams(e)}})||qO;i.ModuleContainer.register(HO,WO);const ZO=Object(i.define)("AIStickerLocalStorageDB");var KO;Object(m.f)()(KO=Object(i.injectable)()(KO=Object(i.singleton)(ZO)(KO=Reflect.metadata("design:type",Function)(KO=Reflect.metadata("design:paramtypes",[])(KO=class{constructor(){this.tableName_="ai_sticker_tbl_1706849065515"}onAuthenticated(e){}async countAsync(){const e=await this.getRecords_();return e?e.length:0}async getAsync(e){var t;const s=await this.getRecords_();return s&&null!==(t=s.find((t=>t.id===e)))&&void 0!==t?t:null}async getAllAsync(){return await this.getRecords_()}async insertMultiAsync(e){var t;const s=null!==(t=await this.getRecords_())&&void 0!==t?t:[],i=[];e.forEach((e=>{const t=s.findIndex((t=>t.id===e.id));-1===t?i.push(e):s[t]=e}));const a=[...s,...i];return await this.writeRecords_(a),e}async delete(e){let t=await this.getRecords_();return!t||(t=t.filter((t=>t.id!==e)),await this.writeRecords_(t),!0)}async deleteAll(){return await this.writeRecords_([]),!0}async destroyAsync(){const e=this.getLocalStorageDB_();await e.removeItemForCurrentUserAsync(this.tableName_)}async getMultiAsync(e){throw new Error("Method not implemented yet!")}async insertAsync(e){throw new Error("Method not implemented yet!")}async updateAsync(e,t){throw new Error("Method not implemented yet!")}async deleteMulti(e){throw new Error("Method not implemented yet!")}getLocalStorageDB_(){return n.default.getInstance()}async getRecords_(){const e=this.getLocalStorageDB_(),t=await e.getItemForCurrentUserAsync(this.tableName_);return t?JSON.parse(t):null}async writeRecords_(e){const t=this.getLocalStorageDB_(),s=JSON.stringify(e);await t.setItemForCurrentUserAsync(this.tableName_,s)}})||KO)||KO)||KO)||KO);const QO=Object(i.define)("AIStickerRepository");var $O;Object(i.injectable)()($O=Object(i.singleton)(QO)($O=function(e,t){return Object(i.inject)(ZO)(e,void 0,0)}($O=Reflect.metadata("design:type",Function)($O=Reflect.metadata("design:paramtypes",[Object])($O=class{constructor(e){this.aiStickerDB_=void 0,this.aiStickerDB_=e}getFakeAIStickers_(){const e=[];return e.push(new xO(1,123,"https://media-ten.z-cdn.me/oXS0nzgaaTQAAAAl/pyonium-cute.webp",498,498)),e.push(new xO(2,123,"https://media-ten.z-cdn.me/krDtrF9w1wYAAAAl/chinese-dragon-dragon.webp",498,498)),e.push(new xO(3,123,"https://media-ten.z-cdn.me/XwHQ_iIQT6MAAAAl/dragon-ball.webp",360,360)),e}async getAllAsync(){return this.getFakeAIStickers_()}async countAsync(){return this.aiStickerDB_.countAsync()}async deleteAll(){return this.aiStickerDB_.deleteAll()}async delete(e){return this.aiStickerDB_.delete(e)}async insertMultiAsync(e){const t=e.map((e=>({id:e.id,rootStickerCateId:e.rootStickerCateId,url:e.url,width:e.width,height:e.height})));return await this.aiStickerDB_.insertMultiAsync(t),e}async insertAsync(e){throw new Error("Method not implemented yet!")}async updateAsync(e,t){throw new Error("Method not implemented yet!")}async getAsync(e){throw new Error("Method not implemented yet!")}async find(e){throw new Error("Method not implemented yet!")}})||$O)||$O)||$O)||$O);var YO=s("xvqP");var JO=s("VLUZ");let XO=function(e){return e.SETUP_AI_STICKER_LIST_UPDATER="SETUP_AI_STICKER_LIST_UPDATER",e.FETCH_AI_STICKER_LIST="FETCH_AI_STICKER_LIST",e.FORWARD_AI_STICKER_MESSAGE="FORWARD_AI_STICKER_MESSAGE",e}({});class eT extends De.a{constructor(e,t){super(XO.SETUP_AI_STICKER_LIST_UPDATER),this.expiredTime=void 0,this.version=void 0,this.expiredTime=e,this.version=t}}class tT extends De.a{constructor(e,t){super(XO.FETCH_AI_STICKER_LIST),this.onCompleted=void 0,this.onFailed=void 0,this.onCompleted=null!=e?e:()=>{},this.onFailed=null!=t?t:()=>{}}}class sT extends De.a{constructor(e,t,s){super(XO.FORWARD_AI_STICKER_MESSAGE),this.payload=void 0,this.onCompleted=void 0,this.onFailed=void 0,this.payload=null!=e?e:{},this.onCompleted=null!=t?t:()=>{},this.onFailed=null!=s?s:()=>{}}}var iT;Object(i.injectable)()(iT=Object(m.f)()(iT=Object(i.singleton)(YO.c)(iT=function(e,t){return Object(i.inject)(HO)(e,void 0,0)}(iT=function(e,t){return Object(i.inject)(jO)(e,void 0,1)}(iT=Reflect.metadata("design:type",Function)(iT=Reflect.metadata("design:paramtypes",[Object,Object])(iT=class{constructor(e,t){this.apiClient_=void 0,this.internalEventBus_=void 0,this.apiClient_=e,this.internalEventBus_=t}onAuthenticated(e){this.internalEventBus_.addEventListener(XO.FETCH_AI_STICKER_LIST,this.handleFetchAPIStickerListEvent_.bind(this)),this.internalEventBus_.addEventListener(XO.FORWARD_AI_STICKER_MESSAGE,this.handleForwardAPIStickerMessageEvent_.bind(this))}getAIStickerList(){return new Promise(((e,t)=>{const s=t=>{e({errorCode:JO.a.SUCCESS,data:{expiredTime:t.expired_time,version:t.version,stickers:t.stickers.map((e=>({id:e.id,url:e.url,width:e.width,height:e.height,rootStickerCateId:e.cateid_root})))}})},i=t=>{e({errorCode:JO.a.FAIL,data:void 0})};this.apiClient_.fetchAIStickerList().then(s).catch((e=>{this.requestErrorHandler_(e,this.getAIStickerList).then(s).catch(i)}))}))}handleForwardAPIStickerMessageEvent_(e){const{payload:t,onCompleted:s,onFailed:i}=e,a=t.retryTimeout?{count:U.default.retryConfig.max_retry_count,timeout:t.retryTimeout,timestamp:Date.now(),lowPriority:t.lowPriority}:null,n=ms.a.newReq();this.apiClient_.forwardAIStickerMessage(t.toUid,t.messageContent,t.clientMsgId,a,n,t.additional).then(s).catch(i)}handleFetchAPIStickerListEvent_(e){this.getAIStickerList().then(e.onCompleted).catch(e.onFailed)}requestErrorHandler_(e,t,s=0){return new Promise(((i,a)=>{if(s>=1)return a(e);let n=-1;switch(e?e.error_code||e.code:"UNKNOWN"){case 112:n=5e3;break;case"ERR_NO_NETWORK":case"ERR_CONNECTION_TIMED_OUT":n=1e4;break;default:n=-1}if(n<0)return a(e);setTimeout((()=>{t().then(i).catch((e=>{this.requestErrorHandler_(e,t,s+1).then(i).catch(a)}))}),n)}))}})||iT)||iT)||iT)||iT)||iT)||iT);const aT="ai_sticker_list_ver_1706778251026",nT="ai_sticker_list_expt_1707057455164";class rT{constructor(){this.aiStickerListVersion_=null,this.versionExpiredTime_=null}getAIStickerListVersion(){if(null==this.aiStickerListVersion_){const t=n.default.getInstance().getItemForCurrentUser(aT);let s=GO.b;if(t)try{s=JSON.parse(t)}catch(e){}this.aiStickerListVersion_=s}return this.aiStickerListVersion_}setAIStickerListVersion(e){this.aiStickerListVersion_=e;n.default.getInstance().setItemForCurrentUser(aT,JSON.stringify(e))}getVersionExpiredTime(){if(null==this.versionExpiredTime_){const t=n.default.getInstance().getItemForCurrentUser(nT);let s=-1;if(t)try{s=JSON.parse(t)}catch(e){}this.versionExpiredTime_=s}return this.versionExpiredTime_}setVersionExpiredTime(e){this.versionExpiredTime_=e;n.default.getInstance().setItemForCurrentUser(nT,JSON.stringify(e))}}rT.NOT_AI_STICKER_LIST_VERSION=GO.b,rT.NOT_VERSION_EXPIRED_TIME=-1;var oT,cT=new rT;let lT=Object(i.injectable)()(oT=function(e,t){return Object(i.inject)(BO)(e,void 0,0)}(oT=function(e,t){return Object(i.inject)(QO)(e,void 0,1)}(oT=function(e,t){return Object(i.inject)(jO)(e,void 0,2)}(oT=Reflect.metadata("design:type",Function)(oT=Reflect.metadata("design:paramtypes",[Object,Object,Object])(oT=class{constructor(e,t,s){this.aiStickerListVersion_=void 0,this.aiStickerMapper_=void 0,this.aiStickerRepository_=void 0,this.internalEventBus_=void 0,this.aiStickerMapper_=e,this.aiStickerRepository_=t,this.internalEventBus_=s,this.aiStickerListVersion_=cT}transformFromAIStickerMessage(e){var t,s,i,a,n;const r=e.content,o=e.content.parsedParams,c=o.contentId,l=null!==(t=null!==(s=null!==(i=r.oriUrl)&&void 0!==i?i:r.hdUrl)&&void 0!==s?s:null===(a=o.webp)||void 0===a?void 0:a.url)&&void 0!==t?t:"";return{id:c,url:l,thumb:null!==(n=r.thumbUrl)&&void 0!==n?n:l,intrinsicWidth:o.width,intrinsicHeight:o.height,renderedWidth:Object(kO.a)().config.ai_sticker_message.w,renderedHeight:Object(kO.a)().config.ai_sticker_message.h,animatable:undefined,type:GO.f.AI_GENERATED,extra:{fromSrc:GO.a.MESSAGE}}}transformRecentAIStickerFromAISticker(e){return Object(T.a)(Object(T.a)({},e),{},{extra:{fromSrc:GO.a.RECENT}})}transformFromAIStickerMessageContent(e){throw new Error("Method does not be implemented yet!")}isValidAISticker(e){const t=!!e.id,s=!!e.url,i=e.type===GO.f.AI_GENERATED;return t&&s&&i}isValidAIStickerFromRecentStickerPanel(e){var t;return(null==e||null===(t=e.extra)||void 0===t?void 0:t.fromSrc)===GO.a.RECENT}async getAIStickerList(){let e=await this.aiStickerRepository_.getAllAsync();if((!e||0===e.length)&&this.aiStickerListVersion_.getAIStickerListVersion()===rT.NOT_AI_STICKER_LIST_VERSION){e=await this.syncAIStickerList_()?await this.aiStickerRepository_.getAllAsync():[]}return e.map((e=>this.aiStickerMapper_.toAIStickerDTOFromDomain(e)))}getAIStickerListVersion(){return this.aiStickerListVersion_.getAIStickerListVersion()}async syncAIStickerList_(){return new Promise(((e,t)=>{const s=()=>{e(!1)},i=new tT((async t=>{try{if(t.errorCode===JO.a.SUCCESS){const s=t.data;if(s.version>this.aiStickerListVersion_.getAIStickerListVersion()){const t=s.stickers.map((e=>new xO(e.id,e.rootStickerCateId,e.url,e.width,e.height)));await this.aiStickerRepository_.insertMultiAsync(t),this.aiStickerListVersion_.setAIStickerListVersion(s.version),s.expiredTime&&(this.aiStickerListVersion_.setVersionExpiredTime(s.expiredTime),this.internalEventBus_.dispatchEvent(new eT(s.expiredTime,s.version))),e(!0)}}e(!1)}catch(i){s()}}),s);this.internalEventBus_.dispatchEvent(i)}))}})||oT)||oT)||oT)||oT)||oT)||oT;i.ModuleContainer.register(YO.a,lT);var dT=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger(Ss.ZLoggerNametags.common,[]);function hT(e){return JSON.parse(e)}function uT(e,t){if("object"==typeof e)return e;try{e=hT(e)}catch(s){dT.zsymb(18,"hgz8Nx","Parse json failed",String(e).slice(0,100)),e=t}return e}function gT(e){return hT(e)}function mT(e){var t;if(!e)return;let s={message:""};if("string"==typeof e.msg)s.message=e.msg;else try{const t=e.msg;s=Object(T.a)(Object(T.a)({},t),{},{message:t.title||""})}catch(a){}const i=null!==(t=e.ownerId)&&void 0!==t?t:e.fromUid;return Object(T.a)(Object(T.a)({},e),{},{attachment:gT.deep(e.attach),rootClientMessageID:e.cliMsgId,rootClientMessageType:e.cliMsgType,rootContent:s,rootGlobalMessageID:e.globalMsgId,rootSentTime:+e.ts,rootSenderName:Z.default.getDName(i),rootSenderID:i,ttl:e.ttl})}function pT(e){if(e)return{fromID:e.fromId,icon:e.icon,isGroup:Boolean(e.isGroup),isMessageInfo:Boolean(e.isMsgInfo),senderAvatar:e.senderAvatar,senderDisplayName:e.senderDisplayName,threadID:e.threadId,timestamp:e.ts,ttl:e.ttl}}gT.noExceptions=function(e){try{return gT(e)}catch(t){return void Logger.zsymb(18,"dAQXVo","Parse json failed",String(e).slice(0,100))}},gT.fallback=uT,gT.fallbackSelf=function(e){return uT(e,e)},gT.deep=function e(t){const s=e=>!isNaN(Number(e));if("string"!=typeof t)return Array.isArray(t)?t.map((t=>e(t))):"object"==typeof t&&null!=t?Object.keys(t).reduce(((i,a)=>{const n=t[a];return i[a]=s(n)?n:e(n),i}),{}):t;if(s(t))return t;try{return e(hT(t))}catch(i){return t}};const fT=()=>({contentId:"",width:-1,height:-1,thumbWidth:-1,thumbHeight:-1,pStickerType:GO.c.AI_STICKER,webp:{width:-1,height:-1,url:""}});function vT(e){return e?Object(T.a)(Object(T.a)({},e),{},{contentId:e.contentId,pStickerType:e.pStickerType,webp:{width:e.webp.width,height:e.webp.height,url:e.webp.url},height:e.height,width:e.width,thumbHeight:e.thumb_height,thumbWidth:e.thumb_width}):fT()}const _T=()=>({title:"",description:"",oriUrl:"",thumbUrl:"",hdUrl:"",parsedParams:vT(null)});function bT(e){if(!e)return _T();const t=e.params;let s=vT(null);if("string"==typeof t)try{s=vT(JSON.parse(t))}catch(kF){0}else"object"==typeof t&&(s=vT(t));return Object(T.a)(Object(T.a)({},e),{},{title:e.title,description:e.description,hdUrl:e.hdUrl,oriUrl:e.oriUrl,thumbUrl:e.thumbUrl,parsedParams:s})}const yT=()=>({color:-1,size:-1,subType:-1,type:-1,parsedExt:{sSrcStr:"",sSrcType:-1}});function IT(e){if(!e)return yT();const t=e.ext;let s={sSrcStr:"",sSrcType:-1};if("string"==typeof t)try{s=JSON.parse(t)}catch(kF){0}else"object"==typeof t&&(s=t);return Object(T.a)(Object(T.a)({},e),{},{color:e.color,size:e.size,subType:e.subType,type:e.type,parsedExt:s})}function ST(e){return Object(T.a)(Object(T.a)({},function(e){if(e)return Object(T.a)(Object(T.a)({},e),{},{actionID:e.actionId,clientMessageID:e.cliMsgId,e2eeStatus:e.e2eeStatus,eventInfo:pT(e.eventInfo),extra:e.extra,fromUID:String(e.fromUid),messageID:e.msgId,platformType:e.platformType,quote:mT(e.quote),sentSource:e.src,sentTime:+e.sendDttm,serverTime:+e.serverTime,status:e.status,syncFromMobile:e.syncFromMobile,toUID:String(e.toUid),ttl:e.ttl,type:-1})}(e)),{},{content:bT(e.message),type:9999,src:e.src,msgType:e.msgType,originMsgType:"chat.photo",properties:IT(e.properties)})}var CT,ET=s("bKjh");let OT=Object(i.injectable)()(CT=function(e,t){return Object(i.inject)(jO)(e,void 0,0)}(CT=Reflect.metadata("design:type",Function)(CT=Reflect.metadata("design:paramtypes",[Object])(CT=class{constructor(e){this.internalEventBus_=void 0,this.internalEventBus_=e}isAIStickerMessageObject(e){return Object(ET.b)(e)}isAIStickerMessage(e){return Object(ET.a)(e)}isOldAIStickerMessage(e){return Object(ET.e)(e)}isNewAIStickerMessage(e){return Object(ET.d)(e)}transformFromRawMessage(e){return ST(e)}transformAIStickerMessageObjectFromAISticker(e,t){return{toId:e,sendByUrl:!0,title:"",description:"",file:{},img:t.url,oriUrl:t.url,thumbUrl:t.thumb||t.url,hdUrl:t.url,width:t.intrinsicWidth,height:t.intrinsicHeight,params:{contentId:t.id,pStickerType:GO.c.AI_STICKER,height:t.intrinsicHeight,width:t.intrinsicWidth,thumb_width:t.intrinsicWidth,thumb_height:t.intrinsicHeight,webp:{width:t.intrinsicWidth,height:t.intrinsicHeight,url:t.url}},properties:{subType:0,color:-1,size:-1,type:W.MSG_BUBBLE_LAYOUT_TYPE_NO_BORDER,ext:{sSrcStr:GO.d.AI,sSrcType:GO.e.AI}}}}forwardAIStickerMessage(e,t,s,i={retryTimeout:0,lowPriority:!1,fwAdditional:{}}){return new Promise(((a,n)=>{const r=s.content.parsedParams.webp.url||s.content.oriUrl;if(!r)return n();this.checkAlive_(r,{count:U.default.retryConfig.max_normal_request_retry_count}).then((()=>{var r,o,c,l,d,h;const u={description:"",title:"",oriUrl:s.content.oriUrl,thumbUrl:s.content.thumbUrl,normalUrl:s.content.normalUrl,hdUrl:s.content.hdUrl||s.content.normalUrl,contentId:s.content.parsedParams.contentId,thumb_width:null!==(r=s.content.parsedParams.thumbWidth)&&void 0!==r?r:s.content.parsedParams.width,thumb_height:null!==(o=s.content.parsedParams.thumbHeight)&&void 0!==o?o:s.content.parsedParams.height,webp:JSON.stringify(s.content.parsedParams.webp),width:s.content.parsedParams.width,height:s.content.parsedParams.height,properties:JSON.stringify({color:s.properties.color,size:s.properties.size,subType:s.properties.subType,type:s.properties.type,ext:JSON.stringify(s.properties.parsedExt)}),pStickerType:s.content.parsedParams.pStickerType,photoId:null!==(c=s.content.photoId)&&void 0!==c?c:1},g=s.e2eeStatus===W.MSG_E2EE;g&&(u.isAISticker=!0);const m=new sT({toUid:e,clientMsgId:t,lowPriority:null!==(l=i.lowPriority)&&void 0!==l&&l,retryTimeout:null!==(d=i.retryTimeout)&&void 0!==d?d:0,messageContent:u,additional:null!==(h=i.fwAdditional)&&void 0!==h?h:{}},(async e=>{if(g)a(e);else{const t={msgId:e.msgId+"",thumbUrl:s.content.thumbUrl,hdUrl:s.content.hdUrl,oriUrl:s.content.oriUrl,width:s.content.parsedParams.width,height:s.content.parsedParams.height};a(t)}}),(async e=>{n(e)}));this.internalEventBus_.dispatchEvent(m)})).catch(n)}))}checkAlive_(e,t){return new Promise(((s,a)=>{A.default.checkAlive(e).then(s).catch((n=>{if(U.default.retryConfig.enable_add_missing_retry&&n===af.XMLHttpRequestErrorCode.NO_RESPONSE&&t.count){t.count=t.count-1;const n=()=>this.checkAlive_(e,t).then(s).catch(a);i.ModuleContainer.resolve(af.ConnectionPendingController).pushToRetryQueue(n)}else a(n)}))}))}})||CT)||CT)||CT)||CT;i.ModuleContainer.register(YO.b,OT);var TT,MT=s("56jR"),RT=s("397E"),wT=s("RJlJ");Object(i.injectable)()(TT=Object(m.f)()(TT=Object(ie.b)(RT.b)(TT=Object(i.singleton)(RT.b)(TT=function(e,t){return Object(i.inject)(YO.a)(e,void 0,0)}(TT=Reflect.metadata("design:type",Function)(TT=Reflect.metadata("design:paramtypes",[void 0===MT.IAIStickerAppService?Object:MT.IAIStickerAppService])(TT=class{constructor(e){this.aiStickerService_=void 0,this.state_={version:GO.b,aiStickers:[]},this.name=RT.a,this.key=wT.a,this.aiStickerService_=e}onAuthenticated(e){Object(kO.a)().isEnable("AIStickerTab")&&this.aiStickerService_.getAIStickerList().then((e=>{this.state_.version=this.aiStickerService_.getAIStickerListVersion(),this.state_.aiStickers=e,Object(Zs.g)(this.name,this.key)}))}getAIStickerList(){return this.state_.aiStickers}init(){}getItem(e){if(e.key===this.key)return this.state_}getList(e,t){return[]}onGetItemFailure(e,t){0}onGetListFailure(e,t){0}})||TT)||TT)||TT)||TT)||TT)||TT);var LT=s("T6Qc"),FT=s("RYTL");const DT=Object(FT.b)("socket-polling"),AT=Object(FT.b)("event-bus"),NT=Object(FT.b)("z-storage"),kT=Object(FT.b)("z-search-v3"),PT=Object(FT.b)("actionlog-service"),jT=Object(FT.b)("important-message-manager"),UT=Object(FT.b)("sync-message-controller");var BT,GT=s("6ivO"),zT=s("KBxP");const xT=new Eb.a({enable:Eb.b.field().boolean(),batch_size:Eb.b.field().number().min(0),enable_fetch_foreground:Eb.b.field().boolean(),enable_segment_updater:Eb.b.field().boolean(),enable_tracking_overflow:Eb.b.field().boolean(),min_throttle:Eb.b.field().number().min(100),throttle:Eb.b.field().number().min(0),throttle_idle:Eb.b.field().number(),queue_config:Eb.b.field().array("string"),interval_check_insufficient_data:Eb.b.field().number().min(0),max_time_check_insufficient_data:Eb.b.field().number().min(0),max_retry_batch:Eb.b.field().number().min(0),retry_strategy:Eb.b.field().string().oneOf(["fibo","linear"]),time_exclude:Eb.b.field().array("number"),debugger:Eb.b.field().schema({show_msg_src:Eb.b.field().boolean(),logger:Eb.b.field().schema({machine_transition:Eb.b.field().boolean(),save_message:Eb.b.field().boolean(),batch_request_info:Eb.b.field().boolean(),interval_update_sufficient_ts:Eb.b.field().boolean()}),simulator:Eb.b.field().schema({overflow_db_group_offline:Eb.b.field().boolean(),slow_load_message:Eb.b.field().boolean()})})});let VT=Object(FT.d)()(BT=Object(FT.e)(LT.b)(BT=Reflect.metadata("design:type",Function)(BT=Reflect.metadata("design:paramtypes",[])(BT=class extends GT.ZFeatureConfig{constructor(){super({default:zT.b,valiator:xT})}selector(e){return e.auto_fetch_msg_mini_cloud||{}}shouldConfigUpdate(e,t){return!new as.e.Comparer(e,t,!0).AND("enable").AND("batch_size").AND("min_throttle").AND("enable_fetch_foreground").AND("enable_segment_updater").AND("enable_tracking_overflow").AND("throttle").AND("throttle_idle").AND("queue_config").AND("interval_check_insufficient_data").AND("max_time_check_insufficient_data").AND("max_retry_batch").AND("retry_strategy").AND("time_exclude").AND("debugger",Sb.a.isEqual).exec()}})||BT)||BT)||BT)||BT;var HT=s("7Yx4");let qT=function(e){return e.OVERFLOW_DB_GROUP_OFFLINE="OVERFLOW_DB_GROUP_OFFLINE",e}({});var WT=s("j8Zv");let ZT=function(e){return e[e.ONLY_1_1=0]="ONLY_1_1",e[e.ONLY_GROUP=1]="ONLY_GROUP",e[e.BOTH_1_1_AND_GROUP=2]="BOTH_1_1_AND_GROUP",e[e.NONE=3]="NONE",e}({});class KT extends De.a{constructor(e){super(hc.a.SHOW_SYNC_MESSAGE_SUGGESTION),this.queueId=e}}class QT extends De.a{constructor(){super(hc.a.AFMC_START)}}class $T extends De.a{constructor(){super(hc.a.AFMC_FINISHED)}}var YT;let JT=Object(FT.d)()(YT=Object(ns.e)()(YT=Object(FT.e)(LT.c)(YT=function(e,t){return i.ModuleContainer.inject(B.ZLoggerFactory)(e,void 0,0)}(YT=function(e,t){return i.ModuleContainer.inject(F.b)(e,void 0,1)}(YT=function(e,t){return Object(ns.d)(LT.b)(e,void 0,2)}(YT=function(e,t){return Object(ns.d)(LT.n)(e,void 0,3)}(YT=function(e,t){return Object(ns.d)(LT.h)(e,void 0,4)}(YT=function(e,t){return Object(ns.d)(LT.k)(e,void 0,5)}(YT=function(e,t){return Object(ns.d)(LT.o)(e,void 0,6)}(YT=function(e,t){return Object(ns.d)(LT.i)(e,void 0,7)}(YT=function(e,t){return Object(ns.d)(LT.r)(e,void 0,8)}(YT=function(e,t){return Object(ns.d)(LT.e)(e,void 0,9)}(YT=Reflect.metadata("design:type",Function)(YT=Reflect.metadata("design:paramtypes",[void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory,"undefined"==typeof ISystemTime?Object:ISystemTime,"undefined"==typeof AFMC_IConfig?Object:AFMC_IConfig,"undefined"==typeof AFMC_IService?Object:AFMC_IService,"undefined"==typeof AFMC_ILedger?Object:AFMC_ILedger,"undefined"==typeof AFMC_IMetrics?Object:AFMC_IMetrics,"undefined"==typeof AFMC_IStorage?Object:AFMC_IStorage,"undefined"==typeof AFMC_IMachine?Object:AFMC_IMachine,"undefined"==typeof AFMC_ITrackingOverflowMessage?Object:AFMC_ITrackingOverflowMessage,"undefined"==typeof AFMC_IEventCollector?Object:AFMC_IEventCollector])(YT=class extends De.b{constructor(e,t,s,i,a,n,r,o,c,l){super(),this.logger=void 0,this.service=void 0,this.ledger=void 0,this.metrics=void 0,this.storage=void 0,this.systemTime=void 0,this.fetcherMachine=void 0,this.eventCollector=void 0,this.trackingOverflow=void 0,this.config=void 0,this.isInsufficientMessage=void 0,this.onOverflowDBGroupOffline=()=>{this.logger.zsymb(0,"tF0BCp","DB Group offline overflow, should suggest sync message"),this.dispatchEvent(new KT(WT.a.SOCKET_MESSAGE_GROUP))},this.onConfigUpdate=e=>{!0===e.config.enable?(this.logger.zsymb(0,"u5SKlh","Receive config enabled, let start machine"),this.registerMachineListener(),this.fetcherMachine.start()):(this.logger.zsymb(0,"efi8IK","Receive config disabled, let stop machine"),this.fetcherMachine.stop(),this.unregisterMachineListener())},this.onMachineTransition=e=>{switch(e.event.type){case"START":this.onMachineStartFetch();break;case"STOP":this.onMachineStopFetch()}this.config.get("debugger.logger.machine_transition")&&this.logger.zsymb(12,"cjMHUc","machine transition",JSON.stringify(e.value))},this.onMachineStop=()=>{this.logger.zsymb(0,"utJ-6L","Machine is stopped")},this.onMachineStartFetch=async()=>{this.dispatchEvent(new QT);const e=this.isInsufficientMessage=await this.service.isInsufficientMessage(),t=this.trackingOverflow.getOverflowStatus(),s=this.fetcherMachine.hasRemainConvInPrevSession();if(e)this.dispatchEvent(new KT(WT.a.SOCKET_MESSAGE_GROUP)),this.logger.zsymb(0,"ldNyMX","User messages may not be enough, should suggest sync message"),this.metrics.logAutoShowBannerSuggestion(s);else if(this.logger.zsymb(0,"VxQerl","Can cover overflow by fetch message from mini-cloud"),t===ZT.ONLY_GROUP)this.metrics.logAutoHideBannerSuggestion();this.metrics.logStartFetch(e,t)},this.onMachineStopFetch=async()=>{const e=0===await this.ledger.size();e?(this.logger.zsymb(0,"Deq-0o","fetch done"),this.storage.saveLastFetchSuccess(this.systemTime.getTimeNow())):this.logger.zsymb(18,"h-qQDx","fetch stop"),null!==this.isInsufficientMessage&&this.metrics.logStopFetch(this.isInsufficientMessage,this.trackingOverflow.getOverflowStatus(),e),this.isInsufficientMessage=null,this.dispatchEvent(new $T)},this.onOverflowMessageQueue=async e=>!1===this.config.get("enable")?(this.logger.zsymb(0,"koxmTK","Module is disabled, should suggest sync message"),void this.dispatchEvent(new KT(e.queueId))):!1===this.service.isQueueMessageGroup(e.queueId)?(this.logger.zsymb(0,"FCf2FH","Detected overflow other queue, forward event to suggest sync message"),void this.dispatchEvent(new KT(e.queueId))):void this.logger.zsymb(0,"4sNcYv","Detected overflow queue message group, let wait done offline"),this.logger=e.createZLogger(Ss.ZLoggerNametags.autoFetchMsgCloud,[Ss.ZLoggerNametags.controller]),this.config=s,this.ledger=a,this.service=i,this.metrics=n,this.storage=r,this.systemTime=t,this.fetcherMachine=o,this.eventCollector=l,this.trackingOverflow=c,this.isInsufficientMessage=null}start(){this.fetcherMachine.create(),this.registerListener(),this.config.get("enable")?(this.logger.zsymb(0,"1dnNCJ","Module is enabled on startup, let start machine"),this.registerMachineListener(),this.fetcherMachine.start()):this.logger.zsymb(0,"IQgbv4","Module is disabled on startup, let listen config from server")}registerListener(){this.config.addEventListener("update",this.onConfigUpdate),this.ledger.addEventListener(qT.OVERFLOW_DB_GROUP_OFFLINE,this.onOverflowDBGroupOffline),this.eventCollector.addEventListener(HT.a.OVERFLOW_MESSAGE_QUEUE,this.onOverflowMessageQueue)}registerMachineListener(){this.logger.zsymb(0,"t7lDQS","register machine listener"),this.fetcherMachine.onStop(this.onMachineStop),this.fetcherMachine.onTransition(this.onMachineTransition)}unregisterMachineListener(){this.logger.zsymb(0,"wW9fgo","unregister machine listener"),this.fetcherMachine.off(this.onMachineStop),this.fetcherMachine.off(this.onMachineTransition)}})||YT)||YT)||YT)||YT)||YT)||YT)||YT)||YT)||YT)||YT)||YT)||YT)||YT)||YT)||YT,XT=function(e){return e.AUTO_FETCH_MSG_CLOUD_SETTING="auto_fetch_msg_cloud",e.SYNC_MESSAGE_SETTING="sync_cross_settings",e.IMPORT_MESSAGE_SETTING="export_import_data",e.OVERFLOW_MSG_TS="overflow_msg_ts",e.SUFFICIENT_MSG_TS="sufficient_msg_ts",e.LAST_CLOSE_FIRST_LOGIN_TRANSFER_MODAL_TS="last-time-close-first-login-transfer-modal",e}({});class eM{constructor(e,t,s){this.key=void 0,this.version=void 0,this.storageAdapter=void 0,this.data=null,this.key=e,this.version=t,this.storageAdapter=s}async get(){return this.data?this.data:this.data=await this.storageAdapter.readAsync(this.key,this.version)}async save(e){this.data=e,await this.storageAdapter.writeAsync(this.key,this.version,e)}async clear(){this.data=null,await this.storageAdapter.removeAsync(this.key)}}class tM extends eM{constructor(e,t){super([e,"conv_ids"].join("_"),1,t)}async remove(e){var t;const s=(null!==(t=await this.get())&&void 0!==t?t:[]).filter((t=>t!==e));await this.save(s)}async getRemainConv(){const e=await this.get();return(null==e?void 0:e.length)||0}}class sM extends eM{constructor(e,t){super([e,"overflow"].join("_"),1,t)}}class iM extends eM{constructor(e,t){super([e,"last_fetch"].join("_"),2,t)}async getLastTsSuccess(){var e,t;return null!==(t=(null!==(e=await this.get())&&void 0!==e?e:{}).lastTsSuccess)&&void 0!==t?t:-1}async getFetchInfo(){var e;return null!==(e=await this.get())&&void 0!==e?e:{}}async saveLastTsSuccess(e){var t;const s=null!==(t=await this.get())&&void 0!==t?t:{};return this.save(Object(T.a)(Object(T.a)({},s),{},{lastTsSuccess:e}))}async saveStartFetchInfo(e){var t,s,i;const a=null!==(t=await this.get())&&void 0!==t?t:{},n=null!==(s=a.onProgressInfo)&&void 0!==s?s:{};n.evict||(n.evict=e.evict),n.listTsStart=(null!==(i=n.listTsStart)&&void 0!==i?i:[]).concat(e.tsStart),n.tsSufficient=e.tsSufficient,await this.save(Object(T.a)(Object(T.a)({},a),{},{onProgressInfo:n}))}async saveConvIds(e){var t,s,i;const a=null!==(t=await this.get())&&void 0!==t?t:{},n=null!==(s=a.onProgressInfo)&&void 0!==s?s:{};n.convIds=as.a.merge(null!==(i=null==n?void 0:n.convIds)&&void 0!==i?i:[],e);const r=Object(T.a)(Object(T.a)({},a),{},{onProgressInfo:n});await this.save(r)}async saveConvErrorIds(e){var t,s,i;const a=null!==(t=await this.get())&&void 0!==t?t:{},n=null!==(s=a.onProgressInfo)&&void 0!==s?s:{},r=null!==(i=null==n?void 0:n.convErrorIds)&&void 0!==i?i:[],o=as.a.merge(r,e);n.convErrorIds=o,await this.save(Object(T.a)(Object(T.a)({},a),{},{onProgressInfo:n}))}async saveTotalMessageFetched(e){var t,s,i;const a=null!==(t=await this.get())&&void 0!==t?t:{},n=null!==(s=a.onProgressInfo)&&void 0!==s?s:{},r=(null!==(i=n.totalMsgFetched)&&void 0!==i?i:0)+e;n.totalMsgFetched=r,await this.save(Object(T.a)(Object(T.a)({},a),{},{onProgressInfo:n}))}async removeLastStartFetchInfo(){var e;const t=null!==(e=await this.get())&&void 0!==e?e:{};return delete t.onProgressInfo,this.save(t)}async removeConvId(e){var t,s,i,a;const n=null!==(t=await this.get())&&void 0!==t?t:{},r=null!==(s=n.onProgressInfo)&&void 0!==s?s:{};r.convIds=(null!==(i=r.convIds)&&void 0!==i?i:[]).filter((t=>t!==e)),r.convErrorIds=(null!==(a=r.convErrorIds)&&void 0!==a?a:[]).filter((t=>t!==e));const o=Object(T.a)(Object(T.a)({},n),{},{onProgressInfo:r});await this.save(o)}async removeConvIdFetchFailed(e){var t,s,i;const a=null!==(t=await this.get())&&void 0!==t?t:{},n=null!==(s=a.onProgressInfo)&&void 0!==s?s:{};n.convErrorIds=(null!==(i=n.convErrorIds)&&void 0!==i?i:[]).filter((t=>t!==e));const r=Object(T.a)(Object(T.a)({},a),{},{onProgressInfo:n});await this.save(r)}}var aM;let nM=Object(FT.d)()(aM=Object(ns.e)()(aM=Object(FT.e)(LT.o)(aM=function(e,t){return Object(ns.d)(LT.a)(e,void 0,0)}(aM=Reflect.metadata("design:type",Function)(aM=Reflect.metadata("design:paramtypes",["undefined"==typeof IAsyncStorageAdapter?Object:IAsyncStorageAdapter])(aM=class{constructor(e){this.localStorage=void 0,this.storageConvIds=void 0,this.storageOverflow=void 0,this.storageLastFetch=void 0,this.localStorage=n.default.getInstance(),this.storageConvIds=new tM(XT.AUTO_FETCH_MSG_CLOUD_SETTING,e),this.storageOverflow=new sM(XT.AUTO_FETCH_MSG_CLOUD_SETTING,e),this.storageLastFetch=new iM(XT.AUTO_FETCH_MSG_CLOUD_SETTING,e)}async getAllConvIds(){var e;return null!==(e=await this.storageConvIds.get())&&void 0!==e?e:[]}async getLastTsSyncMessageSuccess(){var e;const t=this.localStorage.getItemForCurrentUser(XT.SYNC_MESSAGE_SETTING),[,s]=as.e.safeParseJson(t);return null!==(e=null==s?void 0:s.lastSync)&&void 0!==e?e:-1}async getLastTsCloseTransferSuggestion(){var e;const t=this.localStorage.getItemForCurrentUser(XT.SYNC_MESSAGE_SETTING),[,s]=as.e.safeParseJson(t);return null!==(e=null==s?void 0:s.lastCloseSuggest)&&void 0!==e?e:-1}async getLastTsCloseFirstLoginTransferSuggestion(){const e=await this.localStorage.getItemForCurrentUserAsync(XT.LAST_CLOSE_FIRST_LOGIN_TRANSFER_MODAL_TS);return e&&!isNaN(Number(e))?Number(e):-1}async getLastTsImportMessageSuccess(){var e;const t=this.localStorage.getItemForCurrentUser(XT.IMPORT_MESSAGE_SETTING),[,s]=as.e.safeParseJson(t);return null!==(e=null==s?void 0:s.lastTimeImportSuccess)&&void 0!==e?e:-1}async getLastTsAutoFetchMessageSuccess(){return await this.storageLastFetch.getLastTsSuccess()}async getFetchInfo(){return await this.storageLastFetch.getFetchInfo()}async getLastTsOverflowMessage(){const e=this.localStorage.getItemForCurrentUser(XT.OVERFLOW_MSG_TS);return e&&!isNaN(Number(e))?Number(e):-1}async getLastTsSufficientMessage(){const e=this.localStorage.getItemForCurrentUser(XT.SUFFICIENT_MSG_TS);return e&&!isNaN(Number(e))?Number(e):-1}async getOverflowInfo(){return await this.storageOverflow.get()}async getRemainConv(){return await this.storageConvIds.getRemainConv()}async saveConvIds(e){await this.storageConvIds.save(e),await this.storageLastFetch.saveConvIds(e)}async saveLastFetchSuccess(e){await this.storageLastFetch.saveLastTsSuccess(e)}async saveLastOverflow(e){this.localStorage.setItemForCurrentUser(XT.OVERFLOW_MSG_TS,String(e))}async saveLastSufficientMessage(e){this.localStorage.setItemForCurrentUser(XT.SUFFICIENT_MSG_TS,String(e))}async saveOverflowInfo(e,t,s){await this.storageOverflow.save({queueId:e,lastMsgId:t,lastActionId:s})}async saveStartFetchInfo(e){await this.storageLastFetch.saveStartFetchInfo(e)}async saveConvErrorId(e){await this.storageLastFetch.saveConvErrorIds([e])}async saveTotalMessageFetched(e){await this.storageLastFetch.saveTotalMessageFetched(e)}async removeOverflowInfo(){await this.storageOverflow.clear()}async removeConvId(e){await this.storageConvIds.remove(e),await this.storageLastFetch.removeConvIdFetchFailed(e)}async forceRemoveConvId(e){await this.storageConvIds.remove(e),await this.storageLastFetch.removeConvId(e)}async removeStartFetchInfo(){await this.storageLastFetch.removeLastStartFetchInfo()}})||aM)||aM)||aM)||aM)||aM)||aM;var rM;let oM=Object(FT.d)()(rM=Object(FT.e)(LT.a)(rM=Reflect.metadata("design:type",Function)(rM=Reflect.metadata("design:paramtypes",[])(rM=class{constructor(){this.storage=void 0,this.storage=n.default.getInstance()}async readAsync(e,t){const s=await this.storage.getItemForCurrentUserAsync(e),[i,a]=as.e.safeParseJson(s);return i||null===a?null:a.version===t?a.value:(await this.storage.removeItemForCurrentUserAsync(e),null)}async writeAsync(e,t,s){const i=JSON.stringify({version:t,value:s});await this.storage.setItemForCurrentUserAsync(e,i)}async removeAsync(e){await this.storage.removeItemForCurrentUserAsync(e)}})||rM)||rM)||rM)||rM;var cM=s("9Gk3"),lM=s("wd/R"),dM=s.n(lM);let hM=function(e){return e[e.SAVE_MESSAE_ERROR=0]="SAVE_MESSAE_ERROR",e[e.GET_GROUP_INFO_ERROR=1]="GET_GROUP_INFO_ERROR",e}({});class uM extends cs{constructor(e){super("SaveMessageError",hM.SAVE_MESSAE_ERROR,e)}}class gM extends cs{constructor(e,t){super("GetGroupInfoError",hM.GET_GROUP_INFO_ERROR,"An error occured during get list groups info. Error: "+JSON.stringify(t)+". GroupIds: "+e)}}var mM,pM,fM,vM,_M,bM,yM,IM,SM,CM,EM,OM,TM,MM,RM,wM,LM,FM,DM,AM,NM,kM;let PM=(mM=Object(FT.d)(),pM=Object(ns.e)(),fM=Object(FT.e)(LT.n),vM=function(e,t){return Object(ns.d)(LT.b)(e,void 0,0)},_M=function(e,t){return Object(ns.d)(LT.o)(e,void 0,1)},bM=function(e,t){return Object(ns.d)(LT.j)(e,void 0,2)},yM=function(e,t){return Object(ns.d)(LT.q)(e,void 0,3)},IM=function(e,t){return i.ModuleContainer.inject(B.ZLoggerFactory)(e,void 0,4)},SM=function(e,t){return i.ModuleContainer.inject(Qt)(e,void 0,5)},CM=function(e,t){return i.ModuleContainer.inject(ua.b)(e,void 0,6)},EM=function(e,t){return i.ModuleContainer.inject(ze.d)(e,void 0,7)},OM=function(e,t){return i.ModuleContainer.inject(F.b)(e,void 0,8)},TM=Reflect.metadata("design:type",Function),MM=Reflect.metadata("design:paramtypes",["undefined"==typeof AFMC_IConfig?Object:AFMC_IConfig,"undefined"==typeof AFMC_IStorage?Object:AFMC_IStorage,"undefined"==typeof AFMC_IMessageProcessor?Object:AFMC_IMessageProcessor,"undefined"==typeof AFMC_ISufficientMessageController?Object:AFMC_ISufficientMessageController,void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory,"undefined"==typeof IMessageController?Object:IMessageController,void 0===ua.b?Object:ua.b,void 0===ze.d?Object:ze.d,"undefined"==typeof ISystemTime?Object:ISystemTime]),RM=OO((([e])=>`${e.convId}::${e.requestMsgId}`)),wM=Reflect.metadata("design:type",Function),LM=Reflect.metadata("design:paramtypes",["undefined"==typeof IBatchRequestInfo?Object:IBatchRequestInfo]),FM=OO((([e])=>`${e.convId}::${e.requestMsgId}`)),DM=Reflect.metadata("design:type",Function),AM=Reflect.metadata("design:paramtypes",["undefined"==typeof IBatchRequestInfo?Object:IBatchRequestInfo,Array]),mM(NM=pM(NM=fM(NM=vM(NM=_M(NM=bM(NM=yM(NM=IM(NM=SM(NM=CM(NM=EM(NM=OM(NM=TM(NM=MM((kM=class{constructor(e,t,s,i,a,n,r,o,c){this.logger=void 0,this.config=void 0,this.storage=void 0,this.systemTime=void 0,this.groupManager=void 0,this.convManager=void 0,this.messageProcessor=void 0,this.messageController=void 0,this.sufficientMessageController=void 0,this.logger=a.createZLogger(Ss.ZLoggerNametags.autoFetchMsgCloud,[Ss.ZLoggerNametags.service]),this.config=e,this.storage=t,this.systemTime=c,this.convManager=o,this.groupManager=r,this.messageProcessor=s,this.messageController=n,this.sufficientMessageController=i}getThrottle(e){return e?Math.max(this.config.get("min_throttle"),this.config.get("throttle")+this.config.get("throttle_idle")):Math.max(this.config.get("min_throttle"),this.config.get("throttle"))}allowFetchForeground(){return this.config.get("enable_fetch_foreground")}async fetchMessages(e){const{convId:t,requestMsgId:s}=e,i=this.config.get("batch_size"),a=await this.messageController.fetchMessagesCloud(t,s,i,{isOA:0,src:cM.c.AUTO_FETCH_MINI_CLOUD});return a.groupMsgs.forEach((e=>e.setSrc(W.MSG_SRC.AUTO_LOADER))),a}async processMessages(e,t){const[s,i]=await as.b.catchPromise(this.messageProcessor.process(e,t));return b_(s,new uM("Save messages error "+(null==s?void 0:s.toString()))),i}checkBusyHour(){const e=this.systemTime.getTimeNow(),t=dM()(e).get("h");if(!1===this.config.get("time_exclude").includes(t))return[!1,0];const s=Math.random()*Math.max(this.config.get("throttle"),this.config.get("min_throttle")),i=dM()(e).add(1,"h").set("m",0).set("s",0).toDate().getTime();return[!0,Math.abs(i-e)+s]}checkMaxRetryBatch(e,t){if(e>=this.config.get("max_retry_batch"))return[!0,0];let s=this.getThrottle(t)+1e3*Math.random();if("fibo"===this.config.get("retry_strategy"))s+=1e3*as.d.get(e+1);return[!1,s]}async isInsufficientMessage(){const e=await this.sufficientMessageController.getLastTsSufficientMessage();return this.systemTime.getTimeNow()-e>this.config.get("max_time_check_insufficient_data")}isQueueMessageGroup(e){return this.config.get("queue_config").includes(e.toString())}async getGroupsHasMessageOffline(){let e=!1,t=[];const s=await this.storage.getOverflowInfo();if(s){const i=await this.messageController.getGroupHasMessageOffline(s.queueId,s.lastMsgId,s.lastActionId);e=i.evict,t=i.listConvIds,zT.a&&this.config.get("debugger.simulator.overflow_db_group_offline")&&(e=!0)}const i=await this.storage.getAllConvIds(),a=as.a.merge(t,i),[n,r]=await as.b.catchPromise(this.groupManager.getMulti(a));b_(n,new gM(a,n));return{listGroups:await as.a.asyncMapParallel(r,(async e=>{const s=await this.convManager.get(e.id),i=e.isAdmin()||e.isOwner(),a=!(null==s||!s.isPinned),n=!(null==s||!s.isMuted),r=e.totalMembers;let o=-1,c=-1;const l=await(null==s?void 0:s.getLastMessage());return null!=l&&l.sendDttm&&(o=Number(l.sendDttm),c=as.c.getNumberOfDays(o,this.systemTime.getTimeNow())),{convId:e.id,groupInfo:e,isNewGroupOffline:t.includes(e.id),isPinned:a,isOwnerOrAdmin:i,isMuted:n,lastActiveTime:o,totalMembers:r,lastActiveTimeInDays:c}})),evict:e}}reloadMessageOfConv(e){this.messageController.reloadMessage(e)}},Object(n_.a)(kM.prototype,"fetchMessages",[RM,wM,LM],Object.getOwnPropertyDescriptor(kM.prototype,"fetchMessages"),kM.prototype),Object(n_.a)(kM.prototype,"processMessages",[FM,DM,AM],Object.getOwnPropertyDescriptor(kM.prototype,"processMessages"),kM.prototype),NM=kM))||NM)||NM)||NM)||NM)||NM)||NM)||NM)||NM)||NM)||NM)||NM)||NM)||NM)||NM);var jM,UM=s("C3LF");let BM=Object(FT.d)()(jM=Object(ns.e)()(jM=Object(FT.e)(LT.e)(jM=function(e,t){return Object(ns.d)(AT)(e,void 0,0)}(jM=function(e,t){return Object(ns.d)(DT)(e,void 0,1)}(jM=function(e,t){return Object(ns.d)(UT)(e,void 0,2)}(jM=function(e,t){return i.ModuleContainer.inject(m.a)(e,void 0,3)}(jM=Reflect.metadata("design:type",Function)(jM=Reflect.metadata("design:paramtypes",["undefined"==typeof IEventBus?Object:IEventBus,"undefined"==typeof ISocketPolling?Object:ISocketPolling,"undefined"==typeof SyncMessageController?Object:SyncMessageController,"undefined"==typeof BaseApplication?Object:BaseApplication])(jM=class extends De.b{constructor(e,t,s,i){super(),this.onStartPullOffline=()=>{this.dispatchEvent(new UM.l)},this.onDonePullOffline=()=>{this.dispatchEvent(new UM.n)},this.onOverflowQueue=e=>{this.dispatchEvent(new UM.j(e.queueId))},this.onStartSyncMessage=()=>{this.dispatchEvent(new UM.m("start"))},this.onResumeSyncMessage=()=>{this.dispatchEvent(new UM.m("resume"))},this.onSyncMessageSuccess=()=>{this.dispatchEvent(new UM.o("",!0))},this.onSyncMessageFailed=()=>{this.dispatchEvent(new UM.o("",!1))},this.onApplicationBackground=()=>{this.dispatchEvent(new UM.a)},this.onApplicationForeground=()=>{this.dispatchEvent(new UM.c)},this.onApplicationExit=()=>{this.dispatchEvent(new UM.b)},this.onNetworkStatusChanged=e=>{this.dispatchEvent(new UM.i(e))},this.onLogout=()=>{this.dispatchEvent(new UM.h)},this.onServiceReady=()=>{this.dispatchEvent(new UM.k)},this.onBeforeUnload=()=>{this.dispatchEvent(new UM.d)},this.registerListener(e,t,i,s)}registerListener(e,t,s,i){var a,n,r,o,c;e.subscribe(((e,t)=>{switch(e){case P.FetchActions.CHECK_OVERFLOW_QUEUE_BY_FLAG:return this.onOverflowQueue(t);case P.GeneralActions.NETWORK_STATUS:return this.onNetworkStatusChanged(t)}})),t.addEventListener(km.SOCKET_POLLING_EVENT.CHAT_CONNECTED,(e=>{var t,s;e.nextChatHandler.subcribe(lf.b.ON_START_PULL_OFFLINE,this.onStartPullOffline),e.nextChatHandler.subcribe(lf.b.ON_DONE_OFFLINE,this.onDonePullOffline),null===(t=e.prevChatHandler)||void 0===t||t.unsubcribe(lf.b.ON_START_PULL_OFFLINE,this.onStartPullOffline),null===(s=e.prevChatHandler)||void 0===s||s.unsubcribe(lf.b.ON_DONE_OFFLINE,this.onDonePullOffline)})),null==i||null===(a=i.addEventListener)||void 0===a||a.call(i,Uo.e.ON_START,this.onStartSyncMessage),null==i||null===(n=i.addEventListener)||void 0===n||n.call(i,Uo.e.ON_RETRY,this.onStartSyncMessage),null==i||null===(r=i.addEventListener)||void 0===r||r.call(i,Uo.e.ON_RESUME,this.onResumeSyncMessage),null==i||null===(o=i.addEventListener)||void 0===o||o.call(i,Uo.e.ON_SUCCESS,this.onSyncMessageSuccess),null==i||null===(c=i.addEventListener)||void 0===c||c.call(i,Uo.e.ON_FAILED,this.onSyncMessageFailed),s.addEventListener(m.b.Idle,this.onApplicationBackground),s.addEventListener(m.b.Active,this.onApplicationForeground),s.addEventListener(m.b.Exit,this.onApplicationExit),s.addEventListener(m.b.ServicesReady,this.onServiceReady),s.addEventListener(m.b.BeforeUnload,this.onBeforeUnload),s.addEventListener(m.b.LogOut,this.onLogout)}onLeaveGroup(e){this.dispatchEvent(new UM.f(e))}onDeleteConv(e){this.dispatchEvent(new UM.e(e))}})||jM)||jM)||jM)||jM)||jM)||jM)||jM)||jM)||jM;var GM=s("Hy6w");class zM{constructor(e,t,s,a,n,r,o,c,l){var d;this.isNew=s,this.isPinned=a,this.isOwnerOrAdmin=n,this.isMuted=r,this.lastActiveTime=o,this.totalMembers=c,this.lastActiveTimeInDays=l,this.segmentController=void 0,this.hasMore=void 0,this.tsCheck=void 0,this.lastMsgId=void 0,this.id=void 0,this.convId=void 0,this.metrics=void 0,this.disabled=!1,this.convId=this.id=t,this.metrics=new xM(t),this.segmentController=e,this.hasMore=!0,this.tsCheck=i.ModuleContainer.resolve(F.b).getTimeNow(),this.lastMsgId=(null===(d=i.ModuleContainer.resolve(ze.b).getConvByIdSync(this.convId))||void 0===d?void 0:d.lastSmsLocalId)||"0"}getCursor(){return{value:()=>this.getCurrentCursorValue(),next:e=>this.update(e)}}async update(e){const t=await this.segmentController.get(this.convId),s=await this.segmentController.updateSegment(t,e);this.hasMore=this.isHasMoreMessage(e,s)}disable(){this.disabled=!0}async isDone(){return null===await this.getCurrentCursorValue()}async getCurrentCursorValue(){var e;if(!this.hasMore)return null;if(this.disabled)return null;const t=await this.segmentController.get(this.convId),s=this.getRequestMsgId(t);return null===s?null:{convId:this.convId,requestMsgId:s,lastMsgId:this.lastMsgId,lastDeleteMsgId:(null===(e=t.lastDeletedMsgID)||void 0===e?void 0:e.toString())||"0"}}getRequestMsgId(e){var t,s,i;const a=null!==(t=e.lastDeletedMsgID)&&void 0!==t?t:0,n=null!==(s=e.lastCloudVerifiedDttm)&&void 0!==s?s:0,r=null!==(i=e.cloudSegmentCheckAutoFetch)&&void 0!==i?i:[];if(parseInt(this.lastMsgId.replace(".",""))<=a)return null;if(this.tsCheck>n)return"9999999999999999";for(let o=r.length-1;o>=0;o--){const[e,t]=r[o];if(a>=t)return null;if(a<e)return String(e)}return null}isHasMoreMessage(e,t){return!!e.hasMore&&(0!==e.messages.length&&this.getRequestMsgId(t)!==e.requestMsgId)}}class xM{constructor(e){this.convId=e,this.timeTracker=new VM,this.tsStart=0,this.tsStop=0,this.isDone=!1,this.totalBatch=0,this.totalRetry=0}get metrics(){return i.ModuleContainer.resolve(LT.l).get(LT.k)}start(){this.tsStart=performance.now()}stop(e){this.tsStop=performance.now(),this.isDone=e}exportReport(){const e=this.tsStop||performance.now(),t=this.timeTracker.prepare.time,s=this.timeTracker.fetch.time,i=this.timeTracker.sync.time,a=e-this.tsStart,n=a-(t+s+i);return{convId:this.convId,meta:{isDone:this.isDone,total:this.totalBatch,retry:this.totalRetry},duration:{total:a,prepare:t,fetch:s,save:i,idle:n}}}increaseBatch(){this.totalBatch++}increaseRetry(){this.totalRetry++}submit(){const e=this.exportReport();this.metrics.submitConvReport(e)}}class VM{constructor(){this.prepare=new GM.a("AFMC_prepare"),this.fetch=new GM.a("AFMC_fetch"),this.sync=new GM.a("AFMC_sync")}}class HM extends De.a{constructor(){super(qT.OVERFLOW_DB_GROUP_OFFLINE)}}var qM,WM,ZM,KM,QM,$M,YM,JM,XM,eR,tR,sR,iR,aR;let nR=(qM=Object(ns.e)(),WM=Object(FT.d)(),ZM=Object(FT.e)(LT.h),KM=function(e,t){return i.ModuleContainer.inject(B.ZLoggerFactory)(e,void 0,0)},QM=function(e,t){return Object(ns.d)(LT.n)(e,void 0,1)},$M=function(e,t){return Object(ns.d)(LT.o)(e,void 0,2)},YM=function(e,t){return Object(ns.d)(LT.k)(e,void 0,3)},JM=Reflect.metadata("design:type",Function),XM=Reflect.metadata("design:paramtypes",[void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory,"undefined"==typeof AFMC_IService?Object:AFMC_IService,"undefined"==typeof AFMC_IStorage?Object:AFMC_IStorage,"undefined"==typeof AFMC_IMetrics?Object:AFMC_IMetrics]),eR=((e=EO)=>(t,s,i)=>{const a=i.value,n="AsyncFunction"===a.constructor.name;i.value=n?async function(...t){let s=0;for(;;){var i;const[n,r]=await as.b.catchAsyncFn((()=>a.apply(this,t)));if(!n)return r;if(null==e||null===(i=e.onRetry)||void 0===i||i.call(e,n),++s>=e.maxRetry)throw n;e.delay&&await as.b.delay(e.delay+1e3*Math.random())}}:function(...t){let s=0;for(;;){var i;const[n,r]=as.b.catchFn((()=>a.apply(this,t)));if(!n)return r;if(null==e||null===(i=e.onRetry)||void 0===i||i.call(e,n),++s>=e.maxRetry)throw n}}})({maxRetry:3,delay:3e3}),tR=Reflect.metadata("design:type",Function),sR=Reflect.metadata("design:paramtypes",[]),qM(iR=WM(iR=ZM(iR=KM(iR=QM(iR=$M(iR=YM(iR=JM(iR=XM((aR=class extends De.b{constructor(e,t,s,i){super(),this.logger=void 0,this.service=void 0,this.storage=void 0,this.metrics=void 0,this.listCheckpoints=void 0,this.currentCursorIndex=void 0,this.logger=e.createZLogger(Ss.ZLoggerNametags.autoFetchMsgCloud,[Ss.ZLoggerNametags.stateMachine]),this.service=t,this.storage=s,this.metrics=i,this.listCheckpoints=[],this.currentCursorIndex=-1}async init(){var e;const{listGroups:t,evict:s}=await this.service.getGroupsHasMessageOffline();s&&this.dispatchEvent(new HM);const a=t.map((e=>e.convId)),n=i.ModuleContainer.resolve(Cs);this.listCheckpoints=t.map((e=>new zM(n,e.convId,e.isNewGroupOffline,e.isPinned,e.isOwnerOrAdmin,e.isMuted,e.lastActiveTime,e.totalMembers,e.lastActiveTimeInDays))),this.listCheckpoints.sort(as.a.Sorter.create([{key:"lastActiveTime",comparer:as.a.Sorter.Comparer.number,order:as.a.Sorter.Order.DES},{key:"isPinned",comparer:as.a.Sorter.Comparer.bool},{key:"isOwnerOrAdmin",comparer:as.a.Sorter.Comparer.bool},{key:"isMuted",comparer:as.a.Sorter.Comparer.bool,order:as.a.Sorter.Order.DES},{key:"lastActiveTimeInDays",comparer:as.a.Sorter.Comparer.number},{key:"totalMembers",comparer:as.a.Sorter.Comparer.number}])),this.currentCursorIndex=0-Number(this.listCheckpoints.length<=0),null===(e=this.getCurrentCursorValue())||void 0===e||e.metrics.start(),await this.storage.saveConvIds(a),await this.storage.removeOverflowInfo(),this.logger.zsymb(0,"CgHBnV","init ledger success",a),this.metrics.submitLedgerReport(this.listCheckpoints);return{isEvict:s,isHasNewConv:this.listCheckpoints.some((e=>e.isNew))}}async size(){return await this.storage.getRemainConv()}async clear(){await Promise.all([this.storage.saveConvIds([]),this.storage.removeOverflowInfo()]),this.listCheckpoints=[]}getCursor(){return{value:async()=>this.getCurrentCursorValue(),next:async()=>this.handleNextCursor()}}async remove(e){await this.storage.forceRemoveConvId(e);const t=this.listCheckpoints.find((t=>t.id===e));return!!t&&(t.disable(),!0)}getCurrentCursorValue(){var e;return null!==(e=this.listCheckpoints[this.currentCursorIndex])&&void 0!==e?e:null}async handleNextCursor(){var e;const t=this.getCurrentCursorValue();if(t){const e=await t.isDone();e&&await this.storage.removeConvId(t.convId),t.metrics.stop(e),t.metrics.submit()}this.currentCursorIndex++,null===(e=this.getCurrentCursorValue())||void 0===e||e.metrics.start()}},Object(n_.a)(aR.prototype,"init",[eR,tR,sR],Object.getOwnPropertyDescriptor(aR.prototype,"init"),aR.prototype),iR=aR))||iR)||iR)||iR)||iR)||iR)||iR)||iR)||iR)||iR),rR=function(e){return e.SUCCESS="success",e.FAILED="failed",e.FILLED_BY_SYNC="filled_by_sync",e}({}),oR=function(e){return e.NONE="none",e.CLOSE_APP="close_app",e}({}),cR=function(e){return e.NEW="new",e.RESUME="resume",e.RESUME_AND_NEW="resume_and_new",e}({}),lR=function(e){return e[e.AVG_EXECUTION_TIME_EACH_CONV=151050]="AVG_EXECUTION_TIME_EACH_CONV",e[e.AVG_BATCH=151051]="AVG_BATCH",e[e.AVG_BATCH_RETRY=151052]="AVG_BATCH_RETRY",e[e.AVG_CONV=151053]="AVG_CONV",e[e.AVG_NEW_CONV=151054]="AVG_NEW_CONV",e[e.ERROR_RUNNING=151055]="ERROR_RUNNING",e}({}),dR=function(e){return e.SYNC_MESSAGE="SYNC_MESSAGE",e}({}),hR=function(e){return e.PREPARE_BATCH="PREPARE_BATCH",e.FETCH_MESSAGE="FETCH_MESSAGE",e.PROCESS_MESSAGE="PROCESS_MESSAGE",e}({}),uR=function(e){return e[e.PREPARE_BATCH=0]="PREPARE_BATCH",e[e.FETCH_MESSAGE=1]="FETCH_MESSAGE",e[e.PROCESS_MESSAGE=2]="PROCESS_MESSAGE",e}({});class gR extends cs{constructor(e,t){super("ErrorTaskAborted",-1,`Task [type,id]=[${e},${t}] is aborted`)}}let mR=function(e){return e.ABORT="ABORT",e.PAUSE="PAUSE",e.RESUME="RESUME",e.FULFILLED="FULFILLED",e}({});class pR extends De.b{constructor(){super(),this.id=void 0,this.type=void 0,this.promiseContainer=void 0,this.abortee=void 0,this.status=void 0,this.isPaused=void 0,this.result=void 0,this.error=void 0,this.onAbort=()=>{this.error=new gR(this.type,this.id),this.resolvePromise(),this.dispatchEvent(new De.a(mR.ABORT))},this.status="idle",this.isPaused=!1,this.abortee=new AbortController,this.promiseContainer=new as.b.Container}exec(e){return this.status="pending",this.abortee.signal.addEventListener("abort",this.onAbort,{once:!0}),as.b.catchPromise(e()).then((([e,t])=>{this.error=e,this.result=t,this.status="fulfilled",this.isPaused||this.resolvePromise()})),this}toPromise(){return this.promiseContainer.promise}pause(){this.isPaused=!0,this.dispatchEvent(new De.a(mR.PAUSE))}resume(){this.isPaused=!1,this.dispatchEvent(new De.a(mR.RESUME)),this.abortee.signal.aborted||"fulfilled"===this.status&&this.resolvePromise()}abort(){this.abortee.abort()}resolvePromise(){this.error?this.promiseContainer.reject(this.error):this.promiseContainer.resolve(this.result),this.dispatchEvent(new De.a(mR.FULFILLED)),this.abortee.signal.removeEventListener("abort",this.onAbort),this.removeAllEventListener()}}class fR extends pR{constructor(){super(),this.id=void 0,this.type="prepare",this.id=++fR.counter}}fR.counter=0;class vR extends pR{constructor(){super(),this.id=void 0,this.type="fetch",this.id=++vR.counter}}vR.counter=0;class _R extends pR{constructor(){super(),this.id=void 0,this.type="process",this.id=++_R.counter}}_R.counter=0;class bR extends pR{constructor(){super(),this.id=void 0,this.type="sleep",this.id=++bR.counter}}bR.counter=0;const yR={isBackground:!1,pausedCounter:0,error:null,totalMessageFetched:0,totalMessageSaved:0,task:null,currentStep:hR.PREPARE_BATCH,convCheckpoint:null,batchRequestInfo:null,batchResponseInfo:null,retryCounter:0};var IR;let SR=Object(FT.d)()(IR=Object(ns.e)()(IR=Object(FT.e)(LT.i)(IR=function(e,t){return Object(ns.d)(LT.h)(e,void 0,0)}(IR=function(e,t){return Object(ns.d)(LT.b)(e,void 0,1)}(IR=function(e,t){return Object(ns.d)(LT.n)(e,void 0,2)}(IR=function(e,t){return Object(ns.d)(LT.o)(e,void 0,3)}(IR=function(e,t){return Object(ns.d)(LT.k)(e,void 0,4)}(IR=function(e,t){return i.ModuleContainer.inject(LT.d)(e,void 0,5)}(IR=function(e,t){return i.ModuleContainer.inject(F.b)(e,void 0,6)}(IR=function(e,t){return Object(ns.d)(DT)(e,void 0,7)}(IR=function(e,t){return Object(ns.d)(LT.e)(e,void 0,8)}(IR=function(e,t){return i.ModuleContainer.inject(B.ZLoggerFactory)(e,void 0,9)}(IR=Reflect.metadata("design:type",Function)(IR=Reflect.metadata("design:paramtypes",["undefined"==typeof AFMC_ILedger?Object:AFMC_ILedger,"undefined"==typeof AFMC_IConfig?Object:AFMC_IConfig,"undefined"==typeof AFMC_IService?Object:AFMC_IService,"undefined"==typeof AFMC_IStorage?Object:AFMC_IStorage,"undefined"==typeof AFMC_IMetrics?Object:AFMC_IMetrics,"undefined"==typeof AFMC_IDevtoolMonitor?Object:AFMC_IDevtoolMonitor,"undefined"==typeof ISystemTime?Object:ISystemTime,"undefined"==typeof ISocketPolling?Object:ISocketPolling,"undefined"==typeof AFMC_IEventCollector?Object:AFMC_IEventCollector,void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory])(IR=class extends No{constructor(e,t,s,i,a,n,r,o,c,l){super(),this.logger=void 0,this.config=void 0,this.ledger=void 0,this.service=void 0,this.storage=void 0,this.monitor=void 0,this.metrics=void 0,this.systemTime=void 0,this.socketPolling=void 0,this.eventCollector=void 0,this.currentSessionFetchInfo=void 0,this.registerSessionFetchListener=()=>{this.logger.zsymb(0,"6muqs7","register session fetch listener"),this.eventCollector.addEventListener(HT.a.LOAD_MESSAGE,this.onLoadMessage),this.eventCollector.addEventListener(HT.a.APPLICATION_BACKGROUND,this.onApplicationBackground),this.eventCollector.addEventListener(HT.a.APPLICATION_FOREGROUND,this.onApplicationForeground)},this.unregisterSessionFetchListener=()=>{this.logger.zsymb(0,"MNwl_y","unregister session fetch listener"),this.eventCollector.removeEventListener(HT.a.LOAD_MESSAGE,this.onLoadMessage),this.eventCollector.removeEventListener(HT.a.APPLICATION_BACKGROUND,this.onApplicationBackground),this.eventCollector.removeEventListener(HT.a.APPLICATION_FOREGROUND,this.onApplicationForeground)},this.onEventChange=e=>{switch(e.type){case"START":this.onMachineStartFetch(),this.registerSessionFetchListener();break;case"STOP":this.unregisterSessionFetchListener(),this.onMachineStopFetch();break;case"NEXT_TO_SLEEP_TO_NEXT_HOUR":this.logger.zsymb(0,"4QXpY8","Busy hour, let sleep to next hour");break;case"TRY_MOVE_TO_NEXT_CONV":this.onFetchConvError(e.data.currConvId);break;case"PROCESS_MESSAGE_SUCCESS":this.storage.saveTotalMessageFetched(e.data.totalMessageFetched);break;case"FAILED":const t=this.interpreter.state.context,{batchRequestInfo:s,currentStep:i}=t,a=`${i}-${null==s?void 0:s.convId}-${null==s?void 0:s.requestMsgId}`;this.logger.zsymb(18,"1IMzlq",`An error ocurred during fetch message ${a}`),this.logger.zsymb(18,"sPljkZ",e.error),this.metrics.submitErrorRunning(i,e.error)}},this.onEventChangeForDevtool=async e=>{switch(e.type){case"PREPARE_BATCH_SUCCESS":this.monitor.updateBatchRequestInfo(e.data.batchRequestInfo),this.monitor.updateRemainConv(await this.ledger.size()),this.config.get("debugger.logger.batch_request_info")&&this.logger.zsymb(12,"erBCu1","batch request info",e.data.batchRequestInfo);break;case"PROCESS_MESSAGE_SUCCESS":var t,s;if(this.monitor.updateTotalMessageFetched(e.data.totalMessageFetched),this.config.get("debugger.logger.save_message"))this.logger.zsymb(12,"hM4VkD","save message result",null===(t=e.data.result)||void 0===t?void 0:t.batchInfo,null===(s=e.data.result)||void 0===s?void 0:s.messages.map((e=>e.msgId)));break;case"STOP":this.monitor.updateBatchRequestInfo(null),this.monitor.updateRemainConv(await this.ledger.size())}},this.onTransitionChangeForDevtool=e=>{const t=["idle","running","paused","locked"];for(const s of t)if(e.matches(s))return this.monitor.updateStatus(s)},this.onFetchConvError=async e=>{this.logger.zsymb(18,"PR0XPU","Save conv fetch failed",e),await this.storage.saveConvErrorId(e)},this.onMachineStartFetch=()=>{var e,t;this.metrics.submitStartFetchReport(null!==(e=null===(t=this.currentSessionFetchInfo)||void 0===t?void 0:t.startType)&&void 0!==e?e:null)},this.onMachineStopFetch=async()=>{var e,t;await this.metrics.submitStopFetchReport((null===(e=this.currentSessionFetchInfo)||void 0===e?void 0:e.startType)||null,(null===(t=this.currentSessionFetchInfo)||void 0===t?void 0:t.interuptType)||null,await this.ledger.size()),this.currentSessionFetchInfo=null},this.onStartPullDataOffline=()=>{this.pauseMachine()},this.onStopPullDataOffline=async()=>{var e,t;const s=await this.ledger.size();s>0&&this.metrics.logResumeFetchAfterInterupt();const[i,a]=await as.b.catchPromise(this.ledger.init());if(i)return this.logger.zsymb(18,"zRdD4y","An error occured during init ledger",i),this.stopMachine(),void(this.currentSessionFetchInfo=null);const{isHasNewConv:n,isEvict:r}=a;if(0===await this.ledger.size())return this.logger.zsymb(0,"v6SZ1o","stop machine"),this.stopMachine(),void(this.currentSessionFetchInfo=null);n&&this.resetMachine(),this.currentSessionFetchInfo={startType:n&&s>0?cR.RESUME_AND_NEW:n&&0===s?cR.NEW:cR.RESUME},null!==(e=this.interpreter)&&void 0!==e&&null!==(t=e.state.history)&&void 0!==t&&t.matches("running")?(this.logger.zsymb(0,"yfpSn-","resume machine"),this.resumeMachine()):(this.logger.zsymb(0,"lQUauQ","start machine"),this.startMachine()),await this.storage.saveStartFetchInfo({evict:r,tsStart:this.systemTime.getTimeNow(),tsSufficient:await this.storage.getLastTsSufficientMessage()})},this.onStartTransferMessage=()=>{this.pauseMachine()},this.onStopTransferMessage=async e=>{const t=await this.ledger.size();t>0&&this.currentSessionFetchInfo&&e.isSuccess&&(this.currentSessionFetchInfo.interuptType=dR.SYNC_MESSAGE),e.isSuccess?(await this.ledger.clear(),this.stopMachine()):this.resumeMachine();t>0&&this.metrics.logStopInteruptFetch(dR.SYNC_MESSAGE,e.isSuccess)},this.onDeleteConv=async e=>{this.logger.zsymb(0,"M9OkHn",`Receive delete conversation ${e.convId} event`),this.handleRemoveConv(e.convId)},this.onLeaveGroup=async e=>{this.logger.zsymb(0,"r4hkb4",`Receive leave group ${e.convId} event`),this.handleRemoveConv(e.convId)},this.onLoadMessage=e=>{if(!this.config.get("enable_fetch_foreground"))return;this.pauseMachine();const t=this.config.get("debugger.simulator.slow_load_message");e.promiseContainer.promise.then((()=>t?as.b.delay(5e3):void 0)).finally((()=>this.resumeMachine()))},this.onApplicationBackground=()=>{this.backgroundMachine()},this.onApplicationForeground=()=>{this.foregroundMachine()},this.autoStartMachine=()=>{var e,t;null!==(e=this.socketPolling.chatHandler)&&void 0!==e&&e.isDoneOffline&&null!==(t=this.interpreter)&&void 0!==t&&t.state.matches("idle")&&(this.logger.zsymb(0,"5JBIHg","Done offline detected, auto dispatch stop pull offline"),this.onStopPullDataOffline())},this.startMachine=()=>this.send({type:"START"}),this.resetMachine=()=>this.send({type:"RESET"}),this.stopMachine=()=>this.send({type:"STOP"}),this.pauseMachine=()=>this.send({type:"PAUSED"}),this.resumeMachine=()=>this.send({type:"RESUME"}),this.foregroundMachine=()=>this.send({type:"FOREGROUND"}),this.backgroundMachine=()=>this.send({type:"BACKGROUND"}),this.logger=l.createZLogger(Ss.ZLoggerNametags.autoFetchMsgCloud,[Ss.ZLoggerNametags.stateMachine]),this.ledger=e,this.config=t,this.service=s,this.storage=i,this.metrics=a,this.monitor=n,this.systemTime=r,this.socketPolling=o,this.eventCollector=c,this.currentSessionFetchInfo=null}createMachine(){return e=this.ledger,t=this.service,Object(Yo.a)({id:"afmc-machine-v2",initial:"idle",context:yR,states:{idle:{on:{RESUME:{target:"#afmc-machine-v2.resume",actions:["decreasePausedCounter","logPausedCounter"]}}},running:{id:"running",type:"compound",initial:"checking",states:{checking:{invoke:{src:s=>async i=>{var a;if(null===await e.getCursor().value())return void i({type:"STOP"});const[n,r]=t.checkBusyHour();if(n)i({type:"NEXT_TO_SLEEP_TO_NEXT_HOUR",data:{time:r}});else if("sleep"!==(null===(a=s.task)||void 0===a?void 0:a.type))if(s.isBackground||t.allowFetchForeground())switch(s.currentStep){case hR.PREPARE_BATCH:return void i({type:"NEXT_TO_PREPARE_BATCH"});case hR.FETCH_MESSAGE:return void i({type:"NEXT_TO_FETCH_MESSAGE"});case hR.PROCESS_MESSAGE:return void i({type:"NEXT_TO_PROCESS_MESSAGE"});default:return void i({type:"NEXT_TO_SLEEP"})}else i({type:"NEXT_TO_SLEEP"});else i({type:"NEXT_TO_SLEEP"})}},on:{NEXT_TO_PREPARE_BATCH:{target:"#running.prepareBatch"},NEXT_TO_FETCH_MESSAGE:{target:"#running.fetchMessage"},NEXT_TO_PROCESS_MESSAGE:{target:"#running.processMessage"},NEXT_TO_SLEEP:{target:"#running.sleep"},NEXT_TO_SLEEP_TO_NEXT_HOUR:{target:"#running.sleep"},STOP:{target:"#afmc-machine-v2.idle"}}},prepareBatch:{invoke:{src:t=>async s=>{var i;if("prepare"===(null===(i=t.task)||void 0===i?void 0:i.type))t.task.resume();else{const i=t.task=new fR,n=e.getCursor(),r=await n.value(),o=r.metrics.timeTracker.prepare.getTracker();try{o.start();const e=await i.exec((async()=>{const e=await r.getCursor().value();return null===e?(await n.next(),null):(r.metrics.increaseBatch(),{convCheckpoint:r,batchRequestInfo:e})})).toPromise(),{convCheckpoint:a=null,batchRequestInfo:c=null}=e||{};t.convCheckpoint=r,t.batchRequestInfo=c,a&&c?(t.currentStep=hR.FETCH_MESSAGE,s({type:"PREPARE_BATCH_SUCCESS",data:{batchRequestInfo:c,convCheckpoint:a}})):s({type:"MOVE_TO_NEXT_CONV"})}catch(a){if(a instanceof gR)return;s({type:"FAILED",error:a})}finally{o.end()}}}},on:{PREPARE_BATCH_SUCCESS:{target:"#running.checking",actions:"clearTask"},MOVE_TO_NEXT_CONV:{target:"#running.checking",actions:"clearTask"},FAILED:{target:"#running.checkRetry",actions:["attachError","clearTask"]}}},fetchMessage:{invoke:{src:e=>async s=>{var i;if("fetch"===(null===(i=e.task)||void 0===i?void 0:i.type))e.task.resume();else{const i=e.task=new vR,{batchRequestInfo:n,convCheckpoint:r}=e,o=r.metrics.timeTracker.fetch.getTracker();try{o.start();const a=await i.exec((()=>t.fetchMessages(n))).toPromise();e.batchResponseInfo=a,e.currentStep=hR.PROCESS_MESSAGE,s({type:"FETCH_MESSAGE_SUCCESS",data:{batchResponseInfo:a}})}catch(a){if(a instanceof gR)return;s({type:"FAILED",error:a})}finally{o.end()}}}},on:{FETCH_MESSAGE_SUCCESS:{target:"#running.checking",actions:"clearTask"},FAILED:{target:"#running.checkRetry",actions:["attachError","clearTask"]}}},processMessage:{invoke:{src:e=>async s=>{var i;if("process"===(null===(i=e.task)||void 0===i?void 0:i.type))e.task.resume();else{const i=e.task=new _R,{batchRequestInfo:r,batchResponseInfo:o,convCheckpoint:c}=e,l=c.metrics.timeTracker.sync.getTracker();try{var a;l.start();const n=o.groupMsgs,d=await i.exec((async()=>{const e=await t.processMessages(r,n);return await c.getCursor().next({messages:n,requestMsgId:r.requestMsgId,lastMsgId:r.lastMsgId,checkLoadTop:!0,hasMore:o.hasMore}),e})).toPromise();e.totalMessageFetched+=n.length,e.totalMessageSaved+=(null==d||null===(a=d.messages)||void 0===a?void 0:a.length)||0,e.error=null,e.retryCounter=0,e.currentStep=hR.PREPARE_BATCH,s({type:"PROCESS_MESSAGE_SUCCESS",data:{result:d,totalMessageFetched:n.length}})}catch(n){if(n instanceof gR)return;s({type:"FAILED",error:n})}finally{l.end()}}}},on:{PROCESS_MESSAGE_SUCCESS:{target:"#running.sleep",actions:"clearTask"},FAILED:{target:"#running.checkRetry",actions:["attachError","clearTask"]}}},sleep:{invoke:{src:(e,s)=>async i=>{var a;if("sleep"===(null===(a=e.task)||void 0===a?void 0:a.type))e.task.resume();else{const a=e.task=new bR;try{let n=0;switch(s.type){case"NEXT_TO_SLEEP_TO_NEXT_HOUR":case"RETRY":n=s.data.time;break;default:n=t.getThrottle(e.isBackground)}await a.exec((()=>as.b.delay(n))).toPromise(),i({type:"WAKE_UP"})}catch(n){}}}},on:{WAKE_UP:{target:"#running.checking",actions:"clearTask"}}},checkRetry:{invoke:{src:s=>async i=>{var a;const[n,r]=t.checkMaxRetryBatch(s.retryCounter,s.isBackground);if(n){var o;await e.getCursor().next();const t=(null===(o=s.batchRequestInfo)||void 0===o?void 0:o.convId)||"";return s.error=null,s.retryCounter=0,s.currentStep=hR.PREPARE_BATCH,i({type:"TRY_MOVE_TO_NEXT_CONV",data:{currConvId:t}})}return null===(a=s.convCheckpoint)||void 0===a||a.metrics.increaseRetry(),s.retryCounter++,i({type:"RETRY",data:{time:r}})}},on:{RETRY:{target:"#running.sleep"},TRY_MOVE_TO_NEXT_CONV:{target:"#running.sleep"}}}}},paused:{on:{RESUME:{target:"#afmc-machine-v2.resume",actions:["decreasePausedCounter","logPausedCounter"]}}},resume:{invoke:{src:e=>async t=>{e.pausedCounter?t({type:"RESUME_PAUSED"}):t({type:"RESUME_RUNNING"})}},on:{RESUME_PAUSED:{target:"#afmc-machine-v2.paused"},RESUME_RUNNING:{target:"#afmc-machine-v2.running"}}}},on:{PAUSED:{target:"#afmc-machine-v2.paused",actions:["increasePausedCounter","pauseTask","logPausedCounter"]},STOP:{target:"#afmc-machine-v2.idle",actions:["abortTask","resetAll"]},RESET:{actions:"reset"},START:{target:"#afmc-machine-v2.resume",actions:"decreasePausedCounter"},FOREGROUND:{actions:"foreground"},BACKGROUND:{actions:"background"}}},{actions:{attachError:Xo.a.assign(((e,t)=>Object(T.a)(Object(T.a)({},e),{},{error:t.error}))),abortTask:e=>{var t;return null!==(t=e.task)&&void 0!==t&&t.abort(),e.task=null},pauseTask:e=>{var t;return null===(t=e.task)||void 0===t?void 0:t.pause()},clearTask:Xo.a.assign((e=>Object(T.a)(Object(T.a)({},e),{},{task:null}))),increasePausedCounter:Xo.a.assign((e=>Object(T.a)(Object(T.a)({},e),{},{pausedCounter:e.pausedCounter+1}))),decreasePausedCounter:Xo.a.assign((e=>Object(T.a)(Object(T.a)({},e),{},{pausedCounter:Math.max(e.pausedCounter-1,0)}))),logPausedCounter:e=>{zT.a},foreground:Xo.a.assign((e=>Object(T.a)(Object(T.a)({},e),{},{isBackground:!1}))),background:Xo.a.assign((e=>Object(T.a)(Object(T.a)({},e),{},{isBackground:!0}))),reset:Xo.a.assign((({isBackground:e,pausedCounter:t})=>Object(T.a)(Object(T.a)({},yR),{},{isBackground:e,pausedCounter:t}))),resetAll:Xo.a.assign((()=>Object(T.a)({},yR)))}});var e,t}start(){super.start(),this.registerListener(),this.autoStartMachine()}stop(){this.unregisterListener(),this.unregisterSessionFetchListener(),super.stop(),this.monitor.updateStatus("disabled")}hasRemainConvInPrevSession(){return null!==this.currentSessionFetchInfo&&this.currentSessionFetchInfo.startType!==cR.NEW}registerListener(){var e,t,s;(this.logger.zsymb(0,"mtYv92","register persit listener"),this.eventCollector.addEventListener(HT.a.START_PULL_OFFLINE_DATA,this.onStartPullDataOffline),this.eventCollector.addEventListener(HT.a.STOP_PULL_OFFLINE_DATA,this.onStopPullDataOffline),this.eventCollector.addEventListener(HT.a.DELETE_CONV,this.onDeleteConv),this.eventCollector.addEventListener(HT.a.LEAVE_GROUP,this.onLeaveGroup),this.eventCollector.addEventListener(HT.a.START_TRANSFER_MESSAGE,this.onStartTransferMessage),this.eventCollector.addEventListener(HT.a.STOP_TRANSFER_MESSAGE,this.onStopTransferMessage),null===(e=this.interpreter)||void 0===e||e.onEvent(this.onEventChange),zT.a)&&(null===(t=this.interpreter)||void 0===t||t.onEvent(this.onEventChangeForDevtool),null===(s=this.interpreter)||void 0===s||s.onTransition(this.onTransitionChangeForDevtool))}unregisterListener(){var e,t,s;(this.logger.zsymb(0,"I9EDW4","unregister persit listener"),this.eventCollector.removeEventListener(HT.a.START_PULL_OFFLINE_DATA,this.onStartPullDataOffline),this.eventCollector.removeEventListener(HT.a.STOP_PULL_OFFLINE_DATA,this.onStopPullDataOffline),this.eventCollector.removeEventListener(HT.a.DELETE_CONV,this.onDeleteConv),this.eventCollector.removeEventListener(HT.a.LEAVE_GROUP,this.onLeaveGroup),this.eventCollector.removeEventListener(HT.a.START_TRANSFER_MESSAGE,this.onStartTransferMessage),this.eventCollector.removeEventListener(HT.a.STOP_TRANSFER_MESSAGE,this.onStopTransferMessage),null===(e=this.interpreter)||void 0===e||e.off(this.onEventChange),zT.a)&&(null===(t=this.interpreter)||void 0===t||t.off(this.onEventChangeForDevtool),null===(s=this.interpreter)||void 0===s||s.off(this.onTransitionChangeForDevtool))}async handleRemoveConv(e){this.pauseMachine(),await this.ledger.remove(e)?(this.logger.zsymb(0,"H9C-BL",`Disabled checkpoint ${e} success`),this.resetMachine()):this.logger.zsymb(0,"weNLtt",`Checkpoint ${e} does not exist`),this.resumeMachine()}})||IR)||IR)||IR)||IR)||IR)||IR)||IR)||IR)||IR)||IR)||IR)||IR)||IR)||IR)||IR;var CR,ER=s("BYQe");let OR=Object(ns.e)()(CR=Object(FT.d)()(CR=Object(FT.e)(LT.j)(CR=function(e,t){return Object(ns.d)(LT.f)(e,void 0,0)}(CR=function(e,t){return Object(ns.d)(LT.p)(e,void 0,1)}(CR=function(e,t){return Object(ns.d)(LT.g)(e,void 0,2)}(CR=Reflect.metadata("design:type",Function)(CR=Reflect.metadata("design:paramtypes",["undefined"==typeof IHandler?Object:IHandler,"undefined"==typeof IHandler?Object:IHandler,"undefined"==typeof IHandler?Object:IHandler])(CR=class{constructor(e,t,s){this.processor=void 0,this.processor=(new ER.Chain).pipe(e).pipe(t).pipe(s)}async process(e,t){return await this.processor.process({batchInfo:e,messages:t})}})||CR)||CR)||CR)||CR)||CR)||CR)||CR)||CR;var TR;let MR=Object(FT.d)()(TR=Object(ns.e)()(TR=Object(FT.e)(LT.k)(TR=function(e,t){return i.ModuleContainer.inject(r_.b)(e,void 0,0)}(TR=function(e,t){return Object(ns.d)(PT)(e,void 0,1)}(TR=function(e,t){return i.ModuleContainer.inject(B.ZLoggerFactory)(e,void 0,2)}(TR=function(e,t){return i.ModuleContainer.inject(F.b)(e,void 0,3)}(TR=function(e,t){return Object(ns.d)(LT.o)(e,void 0,4)}(TR=function(e,t){return Object(ns.d)(LT.b)(e,void 0,5)}(TR=Reflect.metadata("design:type",Function)(TR=Reflect.metadata("design:paramtypes",["undefined"==typeof IQosService?Object:IQosService,"undefined"==typeof IActionlogService?Object:IActionlogService,void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory,"undefined"==typeof ISystemTime?Object:ISystemTime,"undefined"==typeof AFMC_IStorage?Object:AFMC_IStorage,"undefined"==typeof AFMC_IConfig?Object:AFMC_IConfig])(TR=class{constructor(e,t,s,i,a,n){this.logger=void 0,this.qos=void 0,this.config=void 0,this.storage=void 0,this.actionlog=void 0,this.systemTime=void 0,this.qos=e,this.config=n,this.storage=a,this.actionlog=t,this.systemTime=i,this.logger=s.createZLogger(Ss.ZLoggerNametags.autoFetchMsgCloud,[Ss.ZLoggerNametags.metricz])}logAutoHideBannerSuggestion(){this.actionlog.logAction(2460001)}logAutoShowBannerSuggestion(e){this.actionlog.logAction(e?2460003:2460002)}logStartFetch(e,t){switch(this.actionlog.logAction(2460101),t){case ZT.ONLY_GROUP:e?this.actionlog.logAction(2460104):this.actionlog.logAction(2460102);break;case ZT.BOTH_1_1_AND_GROUP:e?this.actionlog.logAction(2460104):this.actionlog.logAction(2460103)}}logStopFetch(e,t,s){if(!s)return this.actionlog.logAction(2460401);switch(this.actionlog.logAction(2460201),t){case ZT.ONLY_GROUP:e?this.actionlog.logAction(2460204):this.actionlog.logAction(2460202);break;case ZT.BOTH_1_1_AND_GROUP:e?this.actionlog.logAction(2460204):this.actionlog.logAction(2460203)}}logStopInteruptFetch(e,t){if(e===dR.SYNC_MESSAGE)this.actionlog.logAction(t?2460302:2460303)}logResumeFetchAfterInterupt(){this.actionlog.logAction(2460304)}async submitStartFetchReport(e){if(null===e)return;const t={type:e,total_days_to_fetch:as.g.countDays(await this.storage.getLastTsSufficientMessage(),this.systemTime.getTimeNow()),days_to_fetch_from_new_evict:-1};this.logger.zsymb(12,"aiimKM","submit start fetch report",JSON.stringify(t)),this.actionlog.logActionInfoV2(fe.FeaturesInfo.AutoFetchMessageCloud,2,t)}async submitStopFetchReport(e,t,s){var i,a,n,r;if(null===e)return;const o=await this.storage.getFetchInfo();if(null==o||!o.onProgressInfo)return;const c=this.systemTime.getTimeNow(),l=o.onProgressInfo.totalMsgFetched||0,d={result:t===dR.SYNC_MESSAGE?rR.FILLED_BY_SYNC:s>0?rR.FAILED:rR.SUCCESS,interupted:(()=>{switch(e){case cR.RESUME:case cR.RESUME_AND_NEW:return oR.CLOSE_APP;case cR.NEW:default:return oR.NONE}})(),filled_queue_evict:(()=>{var e;return as.g.countDays(o.onProgressInfo.tsSufficient,c)>this.config.get("max_time_check_insufficient_data")||null!==(e=o.onProgressInfo)&&void 0!==e&&e.evict?0:1})(),estimated_fetching_time:(()=>Math.ceil(l/this.config.get("batch_size"))*this.config.get("throttle")/1e3)(),total_day_with_session_fetch:as.g.countUniqDays(...null!==(i=null==o||null===(a=o.onProgressInfo)||void 0===a?void 0:a.listTsStart)&&void 0!==i?i:[]),days_from_start_to_complete:(()=>{var e,t;const s=Math.min(...null!==(e=null===(t=o.onProgressInfo)||void 0===t?void 0:t.listTsStart)&&void 0!==e?e:[-1]);return s<0?-1:as.g.countDays(s,c)})(),total_conv_fetched:(null===(n=o.onProgressInfo.convIds)||void 0===n?void 0:n.length)||0,conv_fetch_failed:(null===(r=o.onProgressInfo.convErrorIds)||void 0===r?void 0:r.length)||0,total_msg_fetched:l};this.logger.zsymb(12,"nnW_Ix","submit stop fetch report",JSON.stringify(d)),this.actionlog.logActionInfoV2(fe.FeaturesInfo.AutoFetchMessageCloud,1,d),await this.storage.removeStartFetchInfo()}submitConvReport(e){zT.a&&this.logger.zsymb(12,"r014jC","submit metrics for conv",e.convId,JSON.stringify(e)),this.qos.log({commandId:lR.AVG_EXECUTION_TIME_EACH_CONV,success:!0,startTime:0,duration:e.duration.total,params:[JSON.stringify(e)]}),this.qos.log({commandId:lR.AVG_BATCH,success:!0,startTime:0,duration:e.meta.total}),this.qos.log({commandId:lR.AVG_BATCH_RETRY,success:!0,startTime:0,duration:e.meta.retry})}submitLedgerReport(e){const t=e.length,s=e.filter((e=>e.isNew)).length;zT.a&&this.logger.zsymb(12,"Db1hRL","submit ledger report",JSON.stringify({totalConv:t,totalNewConv:s})),this.qos.log({commandId:lR.AVG_CONV,success:!0,startTime:0,duration:t}),this.qos.log({commandId:lR.AVG_NEW_CONV,success:!0,startTime:0,duration:s})}submitErrorRunning(e,t){this.qos.log({commandId:lR.ERROR_RUNNING,success:!1,startTime:0,errorCode:uR[e],params:[e,t.name,...t.qosParams]})}})||TR)||TR)||TR)||TR)||TR)||TR)||TR)||TR)||TR)||TR)||TR;var RR;let wR=Object(FT.d)()(RR=Object(FT.e)(LT.f)(RR=class{async process(e){const{batchInfo:t,messages:s}=e,i=s.filter((e=>parseInt(e.msgId)>parseInt(t.lastDeleteMsgId)));return{batchInfo:t,messages:i}}})||RR)||RR;var LR;let FR=Object(ns.e)()(LR=Object(FT.d)()(LR=Object(FT.e)(LT.g)(LR=function(e,t){return Object(ns.d)(kT)(e,void 0,0)}(LR=Reflect.metadata("design:type",Function)(LR=Reflect.metadata("design:paramtypes",["undefined"==typeof IZSearchV3?Object:IZSearchV3])(LR=class{constructor(e){this.zsearchV3=e}async process(e){return this.zsearchV3.executeData(this.filterMessageSearchable(e.messages)),e}filterMessageSearchable(e){return e.filter((e=>{var t;return"chat.delete"!==e.msgType&&"chat.undo"!==e.msgType&&"chat.list.action"!==e.msgType&&"msginfo.actionlist"!==(null===(t=e.content)||void 0===t?void 0:t.action)}))}})||LR)||LR)||LR)||LR)||LR)||LR;var DR;let AR=Object(ns.e)()(DR=Object(FT.d)()(DR=Object(FT.e)(LT.p)(DR=function(e,t){return Object(ns.d)(NT)(e,void 0,0)}(DR=function(e,t){return Object(ns.d)(jT)(e,void 0,1)}(DR=Reflect.metadata("design:type",Function)(DR=Reflect.metadata("design:paramtypes",["undefined"==typeof IZStorage?Object:IZStorage,"undefined"==typeof IImportantMsgManager?Object:IImportantMsgManager])(DR=class{constructor(e,t){this.zstorage=e,this.importantMsgManager=t}async process(e){var t;const{batchInfo:s,messages:i}=e,[a,n]=await as.b.catchPromise(this.zstorage.addMessages(s.convId,i,void 0));is(a,new uM("Save messages error "+JSON.stringify(a))),this.importantMsgManager.receiveImportantMessage((null==n?void 0:n.messages)||[]);const r=(null!==(t=null==n?void 0:n.messages)&&void 0!==t?t:[]).map((e=>e.msgId));return{batchInfo:s,messages:i.filter((e=>r.includes(e.msgId)))}}})||DR)||DR)||DR)||DR)||DR)||DR)||DR;var NR;let kR=Object(ns.e)()(NR=Object(FT.d)()(NR=Object(FT.e)(LT.m)(NR=function(e,t){return i.ModuleContainer.inject(Cs)(e,void 0,0)}(NR=function(e,t){return Object(ns.d)(LT.b)(e,void 0,1)}(NR=Reflect.metadata("design:type",Function)(NR=Reflect.metadata("design:paramtypes",["undefined"==typeof ICloudSegmentController?Object:ICloudSegmentController,"undefined"==typeof AFMC_IConfig?Object:AFMC_IConfig])(NR=class{constructor(e,t){this.segmentController=e,this.config=t,this.mapCounter={}}process(e){const[t,s]=e;return!s&&this.config.get("enable_segment_updater")&&as.b.Macrotask.push((()=>this.updateSegment(t))),e}getGroupMessages(e){return e.deliverProcessData.groupMsgs}hasEvict(e){var t,s;const i=null!==(t=null==e||null===(s=e.deliverProcessData)||void 0===s?void 0:s.queueStatus)&&void 0!==t?t:{};for(const n of this.config.get("queue_config")){var a;if(null!==(a=i[n])&&void 0!==a&&a.evict)return!0}return!1}classifyMessagesByConv(e){const t={};for(const i of e){var s;const e=i.isGroup?i.msgKey:i.idTo;(t[e]=null!==(s=t[e])&&void 0!==s?s:[]).push(i)}return t}async updateSegment(e){const t=this.getGroupMessages(e);if(0===t.length)return;const s=this.classifyMessagesByConv(t),i=[];for(const a in s){const t=s[a],n=this.getRange(t);i.push(this.update(a,n,this.getModeMerged(a,e)))}await Promise.all(i)}getModeMerged(e,t){var s;let i="merge";const a=null!==(s=this.mapCounter[e])&&void 0!==s?s:0;return(this.hasEvict(t)||0===a)&&(i="split"),this.mapCounter[e]=a+1,i}getRange(e){e.sort(as.a.Sorter.create([{key:"msgId",comparer:as.a.Sorter.Comparer.number,order:as.a.Sorter.Order.ASC},{key:"ts",comparer:as.a.Sorter.Comparer.number,order:as.a.Sorter.Order.ASC}]));const t=e.filter((e=>!isNaN(Number(e.msgId)))),s=t[0],i=t[t.length-1];return[Number(s.msgId),Number(i.msgId)]}async update(e,t,s){const i=await this.segmentController.get(e),a=0===(null!==(n=i.cloudSegmentCheckAutoFetch)&&void 0!==n?n:[]).length?(s="split",null!==(o=i.cloudSegmentCheck)&&void 0!==o?o:[]):null!==(r=i.cloudSegmentCheckAutoFetch)&&void 0!==r?r:[];var n,r,o;const c=this.mergeSegment(t,a);switch(s){case"split":i.cloudSegmentCheckAutoFetch=c;break;case"merge":i.cloudSegmentCheckAutoFetch=this.connectRange(t,c)}await this.segmentController.update(i)}connectRange(e,t){const s=[];for(let i=0;i<t.length;i++){const a=t[i],n=t[i-1];if(Sb.a.isEqual(e,a)&&n){const e=n[0],t=a[1];s.pop(),s.push([e,t])}else s.push(a)}return s}mergeSegment(e,t){if(!e||2!==e.length||e[0]>e[1])return t;if(0==t.length)return[e];const s=[],[i,a]=e;let n=0,r=0;for(let o=0;o<t.length;o++){const e=t[o],c=e[0],l=e[1]===parseInt(W.MessageConstants.MAX_MSG_ID)?e[0]+1:e[1];if(r){s.push(...t.slice(o));break}i>l?(s.push([c,l]),o===t.length-1&&s.push([i,a])):(0===n&&(n=i<c?i:c),a<c?(r=a,s.push([n,r]),s.push([c,l])):a<=l&&a>=c?(r=l,s.push([n,l])):a>l&&o===t.length-1&&s.push([n,a]))}return s}})||NR)||NR)||NR)||NR)||NR)||NR)||NR;var PR;let jR=Object(FT.d)()(PR=Object(ns.e)()(PR=Object(FT.e)(LT.q)(PR=function(e,t){return Object(ns.d)(LT.b)(e,void 0,0)}(PR=function(e,t){return Object(ns.d)(LT.o)(e,void 0,1)}(PR=function(e,t){return Object(ns.d)(LT.e)(e,void 0,2)}(PR=function(e,t){return i.ModuleContainer.inject(F.b)(e,void 0,3)}(PR=function(e,t){return i.ModuleContainer.inject(B.ZLoggerFactory)(e,void 0,4)}(PR=Reflect.metadata("design:type",Function)(PR=Reflect.metadata("design:paramtypes",["undefined"==typeof AFMC_IConfig?Object:AFMC_IConfig,"undefined"==typeof AFMC_IStorage?Object:AFMC_IStorage,"undefined"==typeof AFMC_IEventCollector?Object:AFMC_IEventCollector,"undefined"==typeof ISystemTime?Object:ISystemTime,void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory])(PR=class{constructor(e,t,s,i,a){this.logger=void 0,this.config=void 0,this.storage=void 0,this.systemTime=void 0,this.prevNetworkState=void 0,this.intervalUpdate=void 0,this.onApplicationExit=()=>{this.updateLastSufficientTs(),this.clearIntervalUpdate()},this.onStartPullOffline=()=>{this.clearIntervalUpdate()},this.onStopPullOffline=()=>{this.updateLastSufficientTs(),this.startIntervalUpdate()},this.logger=a.createZLogger(Ss.ZLoggerNametags.autoFetchMsgCloud,[]),this.config=e,this.storage=t,this.systemTime=i,this.prevNetworkState=null,this.intervalUpdate=null,this.registerListener(s)}registerListener(e){e.addEventListener(HT.a.START_PULL_OFFLINE_DATA,this.onStartPullOffline),e.addEventListener(HT.a.STOP_PULL_OFFLINE_DATA,this.onStopPullOffline),e.addEventListener(HT.a.APPLICATION_EXIT,this.onApplicationExit)}async updateLastSufficientTs(){const e=await this.getLastTsSufficientMessage(),t=this.systemTime.getTimeNow(),s=await this.storage.getLastTsOverflowMessage()>e?e:t;await this.storage.saveLastSufficientMessage(s),this.config.get("debugger.logger.interval_update_sufficient_ts")&&this.logger.zsymb(12,"ucebQx","Update last sufficient ts",s)}async getLastTsSufficientMessage(){const e=await Promise.all([this.storage.getLastTsSyncMessageSuccess(),this.storage.getLastTsImportMessageSuccess(),this.storage.getLastTsAutoFetchMessageSuccess(),this.storage.getLastTsCloseTransferSuggestion(),this.storage.getLastTsCloseFirstLoginTransferSuggestion(),this.storage.getLastTsSufficientMessage()]);return Math.max(...e)}startIntervalUpdate(){this.clearIntervalUpdate(),this.intervalUpdate=setInterval((()=>{this.updateLastSufficientTs()}),this.config.get("interval_check_insufficient_data"))}clearIntervalUpdate(){this.intervalUpdate&&clearInterval(this.intervalUpdate),this.intervalUpdate=null}})||PR)||PR)||PR)||PR)||PR)||PR)||PR)||PR)||PR)||PR;var UR;let BR=Object(FT.d)()(UR=Object(ns.e)()(UR=Object(FT.e)(LT.r)(UR=function(e,t){return Object(ns.d)(LT.b)(e,void 0,0)}(UR=function(e,t){return Object(ns.d)(LT.o)(e,void 0,1)}(UR=function(e,t){return i.ModuleContainer.inject(F.b)(e,void 0,2)}(UR=function(e,t){return i.ModuleContainer.inject(B.ZLoggerFactory)(e,void 0,3)}(UR=function(e,t){return Object(ns.d)(LT.e)(e,void 0,4)}(UR=Reflect.metadata("design:type",Function)(UR=Reflect.metadata("design:paramtypes",["undefined"==typeof AFMC_IConfig?Object:AFMC_IConfig,"undefined"==typeof AFMC_IStorage?Object:AFMC_IStorage,"undefined"==typeof ISystemTime?Object:ISystemTime,void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory,"undefined"==typeof AFMC_IEventCollector?Object:AFMC_IEventCollector])(UR=class{constructor(e,t,s,i,a){this.overflowQueueIds=void 0,this.logger=void 0,this.config=void 0,this.storage=void 0,this.systemTime=void 0,this.logger=i.createZLogger(Ss.ZLoggerNametags.autoFetchMsgCloud,[]),this.config=e,this.storage=t,this.systemTime=s,this.overflowQueueIds=[],a.addEventListener(HT.a.OVERFLOW_MESSAGE_QUEUE,(e=>{this.overflowQueueIds.push(e.queueId.toString()),this.storage.saveLastOverflow(this.systemTime.getTimeNow())}))}process(e,t){if(e&&this.config.get("enable_tracking_overflow"))for(const s in e)if(this.config.get("queue_config").includes(s)){if(e[s].evict){const e="-1";this.saveOverflowInfo(s,e,t)}}}getOverflowStatus(){const e=!!this.overflowQueueIds.find((e=>[WT.a.SOCKET_MESSAGE_GROUP,WT.a.LP_MESSAGE_GROUP].includes(e))),t=!!this.overflowQueueIds.find((e=>[WT.a.SOCKET_MESSAGE_1_1,WT.a.LP_MESSAGE_1_1].includes(e)));return t||e?t&&e?ZT.BOTH_1_1_AND_GROUP:t?ZT.ONLY_1_1:ZT.ONLY_GROUP:ZT.NONE}async saveOverflowInfo(e,t,s){const i=await this.storage.getOverflowInfo();(null==i?void 0:i.queueId)!==e&&(await this.storage.saveOverflowInfo(e,t,s),this.logger.zsymb(0,"O6QX9G","Overflow detected, let save info",{queueId:e,lastMsgId:t,lastActionId:s}))}})||UR)||UR)||UR)||UR)||UR)||UR)||UR)||UR)||UR)||UR;var GR,zR=s("h5Sw");Object(i.singleton)(LT.l)(GR=Object(m.j)()(GR=Object(m.g)()(GR=Object(FT.c)([VT,MR,PM,nM,nR,JT,BM,kR,AR,OR,SR,FR,oM,wR,BR,jR,{token:NT,useFactory:()=>_t.default},{token:AT,useFactory:()=>N.default},{token:kT,useFactory:()=>vi.a.getInstance()},{token:DT,useFactory:()=>km.default},{token:PT,useFactory:()=>fe.default},{token:jT,useFactory:()=>zR.a},{token:UT,useFactory:()=>i.ModuleContainer.resolveIfExist(Fo.a)}])(GR=class{onAuthenticating(){this.get(LT.b)}onStart(){this.get(LT.c).start()}get(e){return FT.a.resolve(e)}})||GR)||GR)||GR);var xR;const VR="z_afmc_devtool_";Object(ie.b)(LT.d)(xR=function(e,t){return Object(i.inject)(Qt)(e,void 0,0)}(xR=Reflect.metadata("design:type",Function)(xR=Reflect.metadata("design:paramtypes",["undefined"==typeof IMessageController?Object:IMessageController])(xR=class{constructor(e){var t;this.messageController=e,this.type=void 0,this.name=void 0,this.key=void 0,this.data={isShow:!0,status:"disabled",totalMessage:0,totalMessageFetched:0,remainConv:0,currentConv:"",currentRequestMsgId:"",totalMessageCurrentConv:0},this.promiseCountTotalMessage=null,this.promiseCountTotalMessageCurrConv=null,this.name="auto-fetch-message-cloud-devtool-monitor",this.key="auto-fetch-message-cloud-devtool-monitor",this.data.isShow=zT.a&&Boolean(Number(null!==(t=n.default.getInstance().getItem(VR))&&void 0!==t?t:"0")),this.toggleUpdateTotalMessage()}toggleDevtool(){!1!==zT.a&&(this.data.isShow=!this.data.isShow,this.data.isShow?n.default.getInstance().setItem(VR,Number(this.data.isShow).toString()):n.default.getInstance().removeItem(VR),Object(Zs.g)(this.name,"all"))}updateStatus(e){!1!==zT.a&&(this.data.status=e,Object(Zs.g)(this.name,"all"))}async toggleUpdateTotalMessage(){zT.a}async toggleUpdateTotalMessageCurrentConv(){if(!1===zT.a)return;this.promiseCountTotalMessageCurrConv||(this.promiseCountTotalMessageCurrConv=this.messageController.countMessages(this.data.currentConv));const e=await this.promiseCountTotalMessageCurrConv;this.promiseCountTotalMessageCurrConv=null,this.data.totalMessageCurrentConv=e,Object(Zs.g)(this.name,"all")}updateTotalMessageFetched(e){!1!==zT.a&&(this.data.totalMessageFetched+=e,Object(Zs.g)(this.name,"all"),this.toggleUpdateTotalMessage(),this.toggleUpdateTotalMessageCurrentConv())}updateRemainConv(e){!1!==zT.a&&(this.data.remainConv=e,Object(Zs.g)(this.name,"all"))}updateBatchRequestInfo(e){!1!==zT.a&&(this.data.currentConv=(null==e?void 0:e.convId)||"",this.data.currentRequestMsgId=(null==e?void 0:e.requestMsgId)||"",e||(this.data.totalMessageCurrentConv=0),Object(Zs.g)(this.name,"all"))}getItem(e,t){return Object(T.a)({},this.data)}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||xR)||xR)||xR);var HR,qR=s("n43+");class WR extends De.a{constructor(){super(qR.a.OVERFLOW_QUEUE)}}class ZR extends De.a{constructor(){super(qR.a.NO_OVERFLOW_QUEUE)}}class KR extends De.a{constructor(){super(qR.a.E2EE_CHANGE_DEVICE)}}class QR extends De.a{constructor(){super(qR.a.NO_E2EE_CHANGE_DEVICE)}}class $R extends De.a{constructor(){super(qR.a.USER_OFFLINE)}}class YR extends De.a{constructor(){super(qR.a.SOCKET_DONE_PULL_OFFLINE)}}Object(m.f)()(HR=Object(i.injectable)()(HR=Object(ie.b)(Ko.b)(HR=function(e,t){return Object(i.inject)(B.ZLoggerFactory)(e,void 0,0)}(HR=Reflect.metadata("design:type",Function)(HR=Reflect.metadata("design:paramtypes",[void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory])(HR=class extends De.b{constructor(e){super(),this.logger=void 0,this.handleEventBus=e=>{try{e===P.GeneralActions.SOCKET_DONE_PULL_OFFLINE&&(this.dispatchEvent(new YR),N.default.unsubscribe(this.handleEventBus))}catch(kF){this.logger.zsymb(0,"5PnFQh","Cannot dispatch SocketDonePullOfflineEvent",kF)}},this.onNoE2EEChangeDevice=()=>{try{this.dispatchEvent(new QR),i.ModuleContainer.resolve(Po.b).removeEventListener(lc.a.NoE2eeConvChangeDevice,this.onNoE2EEChangeDevice)}catch(kF){this.logger.zsymb(0,"B561s4","Cannot dispatch NoE2EEChangeDevice",kF)}},this.onUserOffline=()=>{this.dispatchEvent(new $R)},this.onDoneCheckOverflow=e=>{try{if(e.length>0)return void this.dispatchEvent(new WR);this.dispatchEvent(new ZR),Nm.default.getChatHandler().unsubcribe(lf.b.DONE_CHECK_OVERFLOW,this.onDoneCheckOverflow)}catch(kF){this.logger.zsymb(0,"vg4gbA","Cannot dispatch OverflowQueueEvent",kF)}},this.onE2EEChangeDevice=()=>{try{this.dispatchEvent(new KR),i.ModuleContainer.resolve(Po.b).removeEventListener(lc.a.HasE2eeConvChangeDevice,this.onE2EEChangeDevice)}catch(kF){this.logger.zsymb(0,"xKF3Yu","Cannot dispatch E2EEChangeDeviceEvent",kF)}},this.logger=e.createZLogger(Ss.ZLoggerNametags.msgSync,[Ss.ZLoggerNametags.messageReadinessChecker,Ss.ZLoggerNametags.eventCollectorMessageReadiness])}onAuthenticated(){this.registerListener()}registerListener(){N.default.subscribe(this.handleEventBus),i.ModuleContainer.resolve(Jd).addEventListener(eh.USER_OFFLINE,this.onUserOffline),i.ModuleContainer.resolve(Po.b).addEventListener(lc.a.HasE2eeConvChangeDevice,this.onE2EEChangeDevice),i.ModuleContainer.resolve(Po.b).addEventListener(lc.a.NoE2eeConvChangeDevice,this.onNoE2EEChangeDevice),Nm.default.getChatHandler().subcribe(lf.b.DONE_CHECK_OVERFLOW,this.onDoneCheckOverflow)}})||HR)||HR)||HR)||HR)||HR);class JR extends De.a{constructor(){super(gc.c.NO_MISSING_MESSAGE_EVENTS_ARRIVED)}}function XR(e){const t=new Date(e),s=t.getDay(),i=0===s?6:s-1;return t.setDate(t.getDate()-i),t.setHours(0,0,0,0),t.getTime().toString()}let ew=function(e){return e.CHANGE_DEVICE="CHANGE_DEVICE",e.NO_CHANGE_DEVICE="NO_CHANGE_DEVICE",e.NOT_UPDATED_YET="NOT_UPDATED_YET",e}({}),tw=function(e){return e.OVERFLOW_QUEUE="OVERFLOW_QUEUE",e.NO_OVERFLOW_QUEUE="NO_OVERFLOW_QUEUE",e.NOT_UPDATED_YET="NOT_UPDATED_YET",e}({});var sw;const iw=Object(i.define)("message-readiness-metrics");let aw=Object(i.injectable)()(sw=function(e,t){return i.ModuleContainer.inject(F.b)(e,void 0,0)}(sw=function(e,t){return i.ModuleContainer.inject(B.ZLoggerFactory)(e,void 0,1)}(sw=function(e,t){return i.ModuleContainer.inject($d.a)(e,void 0,2)}(sw=Reflect.metadata("design:type",Function)(sw=Reflect.metadata("design:paramtypes",[void 0===F.ISystemTime?Object:F.ISystemTime,void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory,void 0===$d.IFirstLoginChecker?Object:$d.IFirstLoginChecker])(sw=class{constructor(e,t,s){this.systemTime=void 0,this.logger=void 0,this.firstLoginChecker=void 0,this.systemTime=e,this.firstLoginChecker=s,this.logger=t.createZLogger(Ss.ZLoggerNametags.messageReadinessChecker,[Ss.ZLoggerNametags.metricz])}async updateOnlineHistory(e){const t=XR(this.getTimeNow());let s=this.storage.loginHistory.getHistory(e);s.includes(t)||(s.push(t),s=s.slice(-3),await this.storage.loginHistory.saveHistory(e,s))}logLastTimeUserOffline(){return this.storage.loginHistory.setLastOfflineTimestamp(this.getTimeNow())}async logChangeDevice(){this.storage.changeDeviceLog.isChangedDeviceSinceLastLogin=ew.CHANGE_DEVICE,await this.storage.changeDeviceLog.setChangeDeviceTimestamp(this.getTimeNow()),this.storage.changeDeviceLog.setE2EESessionChangedTimestamp(this.getTimeNow()),await this.updateOnlineHistory(gc.b.CHANGE_DEVICE)}async logNoChangeDevice(){this.storage.changeDeviceLog.isChangedDeviceSinceLastLogin=ew.NO_CHANGE_DEVICE,this.storage.changeDeviceLog.setE2EESessionChangedTimestamp(this.getTimeNow())}logOverflowQueue(){this.storage.overflowQueueLog.isOverflowQueueSinceLastLogin=tw.OVERFLOW_QUEUE,this.storage.overflowQueueLog.setQueueEvictTimestamp(this.getTimeNow()),this.storage.overflowQueueLog.setOverflowQueueTimestamp(this.getTimeNow())}logNoOverflowQueue(){this.storage.overflowQueueLog.isOverflowQueueSinceLastLogin=tw.NO_OVERFLOW_QUEUE,this.storage.overflowQueueLog.setQueueEvictTimestamp(this.getTimeNow())}logMessageReadinessStatus(){const e=this.getOnlineInfo(),t=this.getShowSyncConfig(),s=this.getMessageReadinessLog();this.actionLogInfoV2(fe.FeaturesInfo.MessageReadinessStatus,1,Object(T.a)(Object(T.a)(Object(T.a)({},e),t),s))}getMessageReadinessLog(){const e=this.getMissingMessageEventInfo(),t=this.getMessageFulfillmentInfo(),s=+(t.last_success_sync_timestamp>=e.last_missing_msg_event);return this.logger.zsymb(0,"NthCu7",(()=>[e,t,`messageReadinessStatus: ${s}`])),Object(T.a)(Object(T.a)(Object(T.a)({},e),t),{},{msg_readiness_status:s})}logGetLoginInfoTimestamp(){this.storage.loginHistory.logGetLoginInfoTimestamp(this.getTimeNow())}logApplicationReadyTimestamp(e){this.storage.loginHistory.setApplicationReadyTimestamp(e)}get storage(){return i.ModuleContainer.resolve(Ko.c)}get setting(){return i.ModuleContainer.resolve(jo.a)}actionLogInfoV2(e,t,s,i,a){fe.default.logActionInfoV2(e,t,s,i,a)}getTimeNow(){return this.systemTime.getTimeNow()}checkFrequentUsageByLoginType(e){const t=this.storage.loginHistory.getHistory(e),s=XR(this.getTimeNow()-24192e5);return+t[0]>=+s&&t.length>=3}async getLastMessageTimestampWhenOverflowQueue(){const e=ki.b.getLastMsgKeyFromServer();if(!e)return 0;const[t,s,i]=e.split("_");try{var a;return+(await(null===(a=Wt.b.messageCache)||void 0===a?void 0:a.getMessageAsync(void 0,s,t,i))).sendDttm}catch(n){return 0}}calculateDaysSinceLastOnline(){const e=this.storage.loginHistory.lastOfflineTimestamp;if(e<=0)return 0;return Math.round((this.getTimeNow()-e)/864e5)}async saveLastMessageTimestampWhenOverflowQueue(){const e=await this.getLastMessageTimestampWhenOverflowQueue();e&&this.storage.overflowQueueLog.setLastMessageTimestamp(e)}getOnlineInfo(){return{device_imei:n.default.getInstance().getItem("z_uuid"),multi_device_user:+this.checkFrequentUsageByLoginType(gc.b.CHANGE_DEVICE),frequently_used_device:+this.checkFrequentUsageByLoginType(gc.b.NORMAL),changed_device_since_last_login:Number(this.storage.changeDeviceLog.isChangedDeviceSinceLastLogin===ew.CHANGE_DEVICE),days_since_last_onl:this.calculateDaysSinceLastOnline()}}getShowSyncConfig(){return{config_sync_suggestion:+!this.setting.value().dontSuggest,config_show_sync_progress:+!this.setting.value().hideProgress}}getMissingMessageEventInfo(){const e=this.firstLoginChecker.getFirstLoginTime(ye.p.getSessionUserId()),t=this.storage.changeDeviceLog.changeDeviceTimestamp,s=this.storage.overflowQueueLog.lastMessageTimestamp,i=this.storage.overflowQueueLog.getOverflowQueueTimestamp();return{last_missing_msg_event:Math.max(i,t,e),queue_evicted_last_message_timestamp:s,queue_evicted_timestamp:i,missing_msg_event_device_changed:t,missing_msg_event_first_login:e}}getMessageFulfillmentInfo(){const e=this.setting.value().maxSeq;return{last_msg_fulfilled_timestamp:e,last_msg_sync_timestamp:e,last_msg_import_timestamp:this.storage.importExportLog.lastImportMessageTimestamp,last_success_sync_timestamp:this.setting.value().lastSync}}})||sw)||sw)||sw)||sw)||sw)||sw;i.ModuleContainer.registerSingleton(iw,aw);const nw=new GT.ObjectValidator({enabled:GT.Rule.field().boolean()});var rw=new GT.AdvancedRemoteConfigs("message_readiness_log",{enabled:!0},{validator:nw});const ow="last_three_weeks_login",cw="last_three_weeks_change_device",lw="last_msg_timestamp_when_overflow_queue",dw="timestamp_when_overflow_queue",hw="change_device_e2ee_event_timestamp",uw="last_time_user_offline";class gw{constructor(e){this.adapter=e,this._changedDeviceSinceLastLogin=void 0,this._changeDeviceTimestamp=void 0,this._e2eeSessionChangedTimestamp=void 0,this._changedDeviceSinceLastLogin=ew.NOT_UPDATED_YET,this._changeDeviceTimestamp=0,this._e2eeSessionChangedTimestamp=0}async load(){this._changeDeviceTimestamp=await this.adapter.read(hw,1)||0}get changeDeviceTimestamp(){return this._changeDeviceTimestamp}get isChangedDeviceSinceLastLogin(){return this._changedDeviceSinceLastLogin}async setChangeDeviceTimestamp(e){this._changeDeviceTimestamp=e,await this.adapter.write(hw,1,this._changeDeviceTimestamp)}set isChangedDeviceSinceLastLogin(e){this._changedDeviceSinceLastLogin=e}setE2EESessionChangedTimestamp(e){this._e2eeSessionChangedTimestamp=e}getE2EESessionChangedTimestamp(){return this._e2eeSessionChangedTimestamp}}class mw{constructor(){this._data=void 0,this._secureLocalStorage=void 0,this._data={},this._secureLocalStorage=n.default.getInstance()}get lastImportMessageTimestamp(){try{var e,t;return this._data=gh(this._secureLocalStorage.getItemForCurrentUser(Bi.e)),null!==(e=null===(t=this._data)||void 0===t?void 0:t.lastMessageTimestamp)&&void 0!==e?e:0}catch(kF){return 0}}}class pw{constructor(e){this.adapter=e,this._loginHistory=void 0,this._changeDeviceHistory=void 0,this._lastOfflineTimestamp=void 0,this._getLoginInfoTimestamp=void 0,this._applicationReadyTimestamp=void 0,this._loginHistory=[],this._changeDeviceHistory=[],this._lastOfflineTimestamp=0,this._getLoginInfoTimestamp=0,this._applicationReadyTimestamp=0}async load(){try{const[e,t,s]=await Promise.all([this.adapter.read(ow,1),this.adapter.read(cw,1),this.adapter.read(uw,1)]);this._loginHistory=e||[],this._changeDeviceHistory=t||[],this._lastOfflineTimestamp=s||0}catch(e){this._loginHistory=[],this._changeDeviceHistory=[],this._lastOfflineTimestamp=0}}getHistory(e){switch(e){case gc.b.NORMAL:return this._loginHistory;case gc.b.CHANGE_DEVICE:return this._changeDeviceHistory;default:return[]}}async saveHistory(e,t){switch(e){case gc.b.NORMAL:await this.setLoginHistory(t);break;case gc.b.CHANGE_DEVICE:await this.setChangeDeviceHistory(t)}}logGetLoginInfoTimestamp(e){this._getLoginInfoTimestamp=e}getCurrentLoginTimestamp(){return this._getLoginInfoTimestamp}setApplicationReadyTimestamp(e){this._applicationReadyTimestamp=e}getApplicationReadyTimestamp(){return this._applicationReadyTimestamp}async setLoginHistory(e){this._loginHistory=e,await this.adapter.write(ow,1,this._loginHistory)}async setChangeDeviceHistory(e){this._changeDeviceHistory=e,await this.adapter.write(cw,1,this._changeDeviceHistory)}get lastOfflineTimestamp(){return this._lastOfflineTimestamp}async setLastOfflineTimestamp(e){this._lastOfflineTimestamp=e,await this.adapter.write(uw,1,this._lastOfflineTimestamp)}}class fw{constructor(e){this.adapter=e,this._isOverflowQueueSinceLastLogin=void 0,this._lastMessageTimestamp=void 0,this._queueEvictEventArriveTimestamp=void 0,this._overflowQueueTimestamp=void 0,this._isOverflowQueueSinceLastLogin=tw.NOT_UPDATED_YET,this._lastMessageTimestamp=0,this._queueEvictEventArriveTimestamp=0,this._overflowQueueTimestamp=0}async load(){this._lastMessageTimestamp=await this.adapter.read(lw,1)||0,this._overflowQueueTimestamp=await this.adapter.read(dw,1)||0}get lastMessageTimestamp(){return this._lastMessageTimestamp}async setLastMessageTimestamp(e){this._lastMessageTimestamp=e,await this.adapter.write(lw,1,this._lastMessageTimestamp)}get isOverflowQueueSinceLastLogin(){return this._isOverflowQueueSinceLastLogin}set isOverflowQueueSinceLastLogin(e){this._isOverflowQueueSinceLastLogin=e}setQueueEvictTimestamp(e){this._queueEvictEventArriveTimestamp=e}getQueueEvictTimestamp(){return this._queueEvictEventArriveTimestamp}async setOverflowQueueTimestamp(e){this._overflowQueueTimestamp=e,await this.adapter.write(dw,1,this._overflowQueueTimestamp)}getOverflowQueueTimestamp(){return this._overflowQueueTimestamp}}class vw{constructor(){this.key=""}load(){if(""!==this.key)throw new Error("MessageReadinessStorage already initialized");this.key="message_readiness_store"}async read(e,t){const s=n.default.getInstance();e=`${this.key}_${e}`;const i=await s.getItemForCurrentUserAsync(e);if(i){const a=JSON.parse(i);if(a.version===t)return a.value;s.removeItemForCurrentUser(e)}return null}async write(e,t,s){const i=n.default.getInstance();if(null!==s)return e=`${this.key}_${e}`,void(await i.setItemForCurrentUserAsync(e,JSON.stringify({version:t,value:s})));this.remove(e)}async remove(e){const t=n.default.getInstance();e=`${this.key}_${e}`,await t.removeItemForCurrentUser(e)}}var _w;i.ModuleContainer.registerSingleton(Ko.c,class{constructor(){this._adapter=void 0,this._loginHistoryStore=void 0,this._changeDeviceLogStore=void 0,this._overFlowQueueLogStore=void 0,this._importExportLogStore=void 0,this._adapter=new vw,this._loginHistoryStore=new pw(this._adapter),this._changeDeviceLogStore=new gw(this._adapter),this._overFlowQueueLogStore=new fw(this._adapter),this._importExportLogStore=new mw}async load(){this.migrate(),this._adapter.load(),await Promise.all([this._loginHistoryStore.load(),this._changeDeviceLogStore.load(),this._overFlowQueueLogStore.load()])}get loginHistory(){return this._loginHistoryStore}get changeDeviceLog(){return this._changeDeviceLogStore}get overflowQueueLog(){return this._overFlowQueueLogStore}get importExportLog(){return this._importExportLogStore}migrate(){}});Object(i.injectable)()(_w=Object(m.f)()(_w=Object(m.d)()(_w=Object(ie.b)(Ko.a)(_w=function(e,t){return Object(i.inject)(Ko.b)(e,void 0,0)}(_w=function(e,t){return Object(i.inject)(iw)(e,void 0,1)}(_w=function(e,t){return Object(i.inject)(Ko.c)(e,void 0,2)}(_w=function(e,t){return Object(i.inject)(B.ZLoggerFactory)(e,void 0,3)}(_w=function(e,t){return Object(i.inject)(F.b)(e,void 0,4)}(_w=Reflect.metadata("design:type",Function)(_w=Reflect.metadata("design:paramtypes",[Object,void 0===iw?Object:iw,Object,void 0===B.ZLoggerFactory?Object:B.ZLoggerFactory,void 0===F.ISystemTime?Object:F.ISystemTime])(_w=class extends De.b{constructor(e,t,s,i,a){super(),this.eventCollector=void 0,this.metrics=void 0,this.config=void 0,this.storage=void 0,this.logger=void 0,this.systemTime=void 0,this.getGetLoginInfoTimestamp=()=>this.storage.loginHistory.getCurrentLoginTimestamp(),this.getApplicationReadyTimestamp=()=>this.storage.loginHistory.getApplicationReadyTimestamp(),this.getDoneCheckOverflowTimestamp=()=>this.storage.overflowQueueLog.getQueueEvictTimestamp(),this.getE2eeSessionChangedTimestamp=()=>this.storage.changeDeviceLog.getE2EESessionChangedTimestamp(),this.handleUserOffline=async()=>{try{await this.metrics.logLastTimeUserOffline()}catch(e){this.logger.zsymb(18,"z1Kpaa",(()=>[e]))}},this.handleOverflowQueue=()=>{try{this.logger.zsymb(0,"cHNq-G","overflow queue"),this.metrics.logOverflowQueue(),this.eventCollector.removeEventListener(gc.a.OVERFLOW_QUEUE,this.handleOverflowQueue)}catch(e){this.logger.zsymb(18,"K5oSb2",(()=>[e]))}},this.handleE2EEChangeDevice=async()=>{try{this.logger.zsymb(0,"3nIymR","is e2ee change device"),await this.metrics.logChangeDevice(),this.eventCollector.removeEventListener(gc.a.E2EE_CHANGE_DEVICE,this.handleE2EEChangeDevice)}catch(e){this.logger.zsymb(18,"13Npd6",(()=>[e]))}},this.handleDonePullOffline=()=>{try{this.handleMessageReadinessLog(),this.eventCollector.removeEventListener(gc.a.SOCKET_DONE_PULL_OFFLINE,this.handleDonePullOffline)}catch(e){this.logger.zsymb(18,"Vwxo5B",(()=>[e]))}},this.handleMessageReadinessLog=async()=>{try{if(this.storage.overflowQueueLog.isOverflowQueueSinceLastLogin===tw.OVERFLOW_QUEUE&&await this.metrics.saveLastMessageTimestampWhenOverflowQueue(),await this.metrics.updateOnlineHistory(gc.b.NORMAL),!this.isEnabledMessageReadinessLog())return;setTimeout((()=>this.metrics.logMessageReadinessStatus()),3e5)}catch(e){this.logger.zsymb(18,"HybdU-",(()=>[e]))}},this.handleNoOverflowQueue=()=>{try{this.logger.zsymb(0,"AvfDNM","no overflow queue"),this.metrics.logNoOverflowQueue(),this.storage.changeDeviceLog.isChangedDeviceSinceLastLogin===ew.NO_CHANGE_DEVICE&&(this.logger.zsymb(2,"4ivKlZ","NoMissingMessageEventsArrivedEvent, no overflow triggered "),this.dispatchEvent(new JR)),this.eventCollector.removeEventListener(gc.a.NO_OVERFLOW_QUEUE,this.handleNoOverflowQueue)}catch(e){this.logger.zsymb(18,"QkY76m",(()=>[e]))}},this.handleNoE2EEChangeDevice=()=>{try{this.logger.zsymb(0,"42Kqel","no e2ee change device"),this.metrics.logNoChangeDevice(),this.storage.overflowQueueLog.isOverflowQueueSinceLastLogin===tw.NO_OVERFLOW_QUEUE&&(this.logger.zsymb(2,"u-fqVq","all no-missing-message-event events arrived, triggered by no-e2ee-change-device event"),this.dispatchEvent(new JR)),this.eventCollector.removeEventListener(gc.a.NO_E2EE_CHANGE_DEVICE,this.handleNoE2EEChangeDevice)}catch(e){this.logger.zsymb(18,"werm3j",(()=>[e]))}},this.eventCollector=e,this.metrics=t,this.config=rw,this.storage=s,this.systemTime=a,this.logger=i.createZLogger(Ss.ZLoggerNametags.msgSync,[Ss.ZLoggerNametags.messageReadinessChecker,"daivd"]),this.registerEventListeners()}onAuthenticated(){this.storage.load(),this.metrics.logGetLoginInfoTimestamp()}onApplicationReady(){this.metrics.logApplicationReadyTimestamp(this.systemTime.getTimeNow())}isNoMissingMessageEventsArrived(){const e=this.storage.changeDeviceLog.isChangedDeviceSinceLastLogin===ew.NO_CHANGE_DEVICE;return this.storage.overflowQueueLog.isOverflowQueueSinceLastLogin===tw.NO_OVERFLOW_QUEUE&&e}isAtLeastOneMissingMessageEventArrived(){const e=this.storage.changeDeviceLog.isChangedDeviceSinceLastLogin===ew.CHANGE_DEVICE,t=this.storage.overflowQueueLog.isOverflowQueueSinceLastLogin===tw.OVERFLOW_QUEUE;return Boolean(e||t)}isMessageReady(){const e=this.metrics.getMessageReadinessLog();return Boolean(e.msg_readiness_status)}registerEventListeners(){this.eventCollector.addEventListener(gc.a.USER_OFFLINE,this.handleUserOffline),this.eventCollector.addEventListener(gc.a.E2EE_CHANGE_DEVICE,this.handleE2EEChangeDevice),this.eventCollector.addEventListener(gc.a.OVERFLOW_QUEUE,this.handleOverflowQueue),this.eventCollector.addEventListener(gc.a.NO_OVERFLOW_QUEUE,this.handleNoOverflowQueue),this.eventCollector.addEventListener(gc.a.SOCKET_DONE_PULL_OFFLINE,this.handleDonePullOffline),this.eventCollector.addEventListener(gc.a.NO_E2EE_CHANGE_DEVICE,this.handleNoE2EEChangeDevice)}isEnabledMessageReadinessLog(){return this.config.key("enabled").boolean}})||_w)||_w)||_w)||_w)||_w)||_w)||_w)||_w)||_w)||_w);const bw=Object(i.define)("pulloffline-reporter"),yw=()=>void 0!==U.default.socket.offline_monitor.enable&&U.default.socket.offline_monitor.enable,Iw=()=>void 0!==U.default.socket.offline_monitor.latency_time?U.default.socket.offline_monitor.latency_time:3e4,Sw=()=>void 0!==U.default.socket.offline_monitor.exclude_monitors_queues?U.default.socket.offline_monitor.exclude_monitors_queues:["516","517","518","519"];let Cw;var Ew;!function(e){function t(e,t,s){const i={lowestFPS:60,dropTime:e[s].ts-e[t].ts};for(let a=t;a<=s;a++)e[a].fps<i.lowestFPS&&(i.lowestFPS=e[a].fps);return i}e.getDroppeds=function(e,s){let i=0,a=0,n=s[0].fps<=e;const r=[];return s.forEach(((o,c)=>{n?(o.fps>e&&(a=c,n=!1,r.push(t(s,i,a))),c==s.length-1&&o.fps<=e&&(a=c,n=!1,r.push(t(s,i,a)))):o.fps>e?(i=c,n=!1):c==s.length-1?(a=c,n=!1,r.push(t(s,i,a))):n=!0})),r}}(Cw||(Cw={}));const Ow={dropCount:0,min:60,dropTime:0};var Tw=function(e){return e.BeforePull="beforePull",e.InPull="inPull",e.InSaveDB="inSaveDB",e.AfterSaveDB="afterSaveDB",e}(Tw||{});let Mw=Object(i.singleton)(Ra.a)(Ew=Reflect.metadata("design:type",Function)(Ew=Reflect.metadata("design:paramtypes",[void 0===bw?Object:bw])(Ew=class{constructor(e){this.reporter=e,this.cpuUsage=void 0,this.fpsUsage=void 0,this.timeUsage=void 0,this.lastActionId=void 0,this.countData={},this.started=!1,this.isDoneMonitor=!1,this.doneOfflineCount=0,this.donePullCount=0,this.callStartPullCount=0,this.actionIdSnapshot={},this.monitorQueues=new Set,this.timeStartChat={},this.isFirstSnapshot=!0,this.fpsRecorder={},this.timeUsage={startTrackTime:0,beforePull:0,inPull:0,inSaveDB:0,afterSaveDB:0,openConv:0,waitSendOO:0,waitSendGr:0},this.cpuUsage={beforePull:0,inPull:0,inSaveDB:0,afterSaveDB:0},this.fpsUsage={beforePull:Object(T.a)({},Ow),inPull:Object(T.a)({},Ow),inSaveDB:Object(T.a)({},Ow),afterSaveDB:Object(T.a)({},Ow)},this.lastActionId={}}startMonitor(){return yw(),this.reporter.reportLastSession(),yw()?(this.getCPU(),this.trackFPS(Tw.BeforePull),Promise.resolve()):Promise.resolve()}async stopMonitor(){this.timeStartChat.group&&!this.timeUsage.waitSendGr&&(this.timeUsage.waitSendGr=fi.a.now()-this.timeStartChat.group),this.timeStartChat.oneone&&!this.timeUsage.waitSendOO&&(this.timeUsage.waitSendOO=fi.a.now()-this.timeStartChat.oneone),await this.takeSnapshot(Tw.AfterSaveDB),this.reporter.report({isFirstSnapshot:this.isFirstSnapshot,cpuUsage:this.cpuUsage,fpsUsage:this.fpsUsage,timeUsage:this.timeUsage,countData:this.countData}),this.isFirstSnapshot=!1}resetMonitor(){this.monitorQueues.clear(),this.started=!1,this.isDoneMonitor=!1,this.doneOfflineCount=0,this.donePullCount=0,this.timeUsage={startTrackTime:0,beforePull:0,inPull:0,inSaveDB:0,afterSaveDB:0,openConv:0,waitSendOO:0,waitSendGr:0},this.cpuUsage={beforePull:0,inPull:0,inSaveDB:0,afterSaveDB:0},this.fpsUsage={beforePull:Object(T.a)({},Ow),inPull:Object(T.a)({},Ow),inSaveDB:Object(T.a)({},Ow),afterSaveDB:Object(T.a)({},Ow)},this.lastActionId={},this.actionIdSnapshot={},this.countData={},this.timeStartChat={}}addMonitorQueues(e){const t=Sw();e.forEach((e=>{t.some((t=>e.startsWith(t)))||this.monitorQueues.add(e)})),this.monitorQueues}async onStartPoll(e){this.callStartPullCount++,yw()&&(this.callStartPullCount%2==1&&this.resetMonitor(),this.addMonitorQueues(e),this.started,this.callStartPullCount,this.started||(this.started=!0,this.timeUsage.startTrackTime=fi.a.now(),await this.takeSnapshot(Tw.BeforePull),this.trackFPS(Tw.InPull)))}async onEndPoll(e,t){yw()&&this.monitorQueues.has(e)&&(yw(),this.lastActionId[e]=t,this.donePullCount++,this.monitorQueues.size==this.donePullCount&&(await this.takeSnapshot(Tw.InPull),this.trackFPS(Tw.InSaveDB)))}onPollData(e,t){if(yw()&&!this.isDoneMonitor&&this.monitorQueues.has(e))switch(this.countData[e]||(this.countData[e]=0),e){case"510_0":case"513_0":case"515_0":case"510_1":case"513_1":case"515_1":this.countData[e]+=t.data.msgs.length,this.countData[e]+=t.data.pageMsgs.length;break;case"511_0":case"514_0":case"511_1":case"514_1":this.countData[e]+=t.data.groupMsgs.length;break;case"610_0":case"611_0":case"610_1":case"611_1":this.countData[e]+=t.data.reacts.length,this.countData[e]+=t.data.reactGroups.length;break;case"603_0":case"603_1":this.countData[e]+=t.data.controls.length}}onSavedData(e){if(!this.isDoneMonitor&&yw()){this.actionIdSnapshot;for(const t in e)this.monitorQueues.has(t)&&this.lastActionId[t]&&this.actionIdSnapshot[t]!==e[t]&&(this.checkDoneDoOffline(t,e[t]),this.actionIdSnapshot[t]=e[t])}}onOpenConversation(e){"string"==typeof e&&0===this.timeUsage.openConv&&(this.timeUsage.openConv=fi.a.now()-this.timeUsage.startTrackTime)}onStartChat(e){"string"==typeof e&&(e.startsWith("g")&&!this.timeStartChat.group?this.timeStartChat.group=fi.a.now():this.timeStartChat.oneone||(this.timeStartChat.oneone=fi.a.now()))}onEncryptChat(e){"string"==typeof e&&(e.startsWith("g")&&!this.timeUsage.waitSendGr?this.timeUsage.waitSendGr=fi.a.now()-this.timeStartChat.group:this.timeUsage.waitSendOO||(this.timeUsage.waitSendOO=fi.a.now()-this.timeStartChat.oneone))}async checkDoneDoOffline(e,t){if(this.lastActionId[e],this.doneOfflineCount==this.monitorQueues.size)return;const s=this.lastActionId[e];s&&Number(t)==Number(s)&&(this.doneOfflineCount++,this.doneOfflineCount==this.monitorQueues.size&&(this.isDoneMonitor=!0,await this.takeSnapshot(Tw.InSaveDB),this.trackFPS(Tw.AfterSaveDB),this.reporter.saveDraft({isFirstSnapshot:this.isFirstSnapshot,cpuUsage:this.cpuUsage,fpsUsage:this.fpsUsage,timeUsage:this.timeUsage,countData:this.countData}),setTimeout((()=>{this.stopMonitor()}),Iw())))}async takeSnapshot(e){const t=await this.getCPU(),s=this.getFPS(e);this.cpuUsage[e]=t,this.fpsUsage[e]=s,this.timeUsage[e]=fi.a.now()-this.timeUsage.startTrackTime,this.reporter.saveDraft({isFirstSnapshot:this.isFirstSnapshot,cpuUsage:this.cpuUsage,fpsUsage:this.fpsUsage,timeUsage:this.timeUsage,countData:this.countData})}async getCPU(){return 0}trackFPS(e){this.fpsRecorder[e]=wi.default.Fps.registerSectionRecorder(e),this.fpsRecorder[e].start()}getFPS(e){var t;const s=null===(t=this.fpsRecorder[e])||void 0===t?void 0:t.end();if(delete this.fpsRecorder[e],!s||0==s.fpsHistory.length)return Ow;const i=Cw.getDroppeds(50,s.fpsHistory);if(0==i.length)return Ow;const a=i.reduce(((e,t)=>e+=t.dropTime),0),n=Math.min(...i.map((e=>e.lowestFPS)));return{dropCount:i.length,dropTime:a,min:n}}})||Ew)||Ew)||Ew;var Rw;Object(i.injectable)()(Rw=Object(i.singleton)(Ra.a)(Rw=function(e,t){return Object(i.inject)(bw)(e,void 0,0)}(Rw=Reflect.metadata("design:type",Function)(Rw=Reflect.metadata("design:paramtypes",[void 0===bw?Object:bw])(Rw=class extends Mw{constructor(e){super(e)}async getCPU(){const e=(await $zperf.getCpuInfos()).reduce(((e,t)=>e+=t.cpu.percentCPUUsage||0),0);return Math.round(e)}})||Rw)||Rw)||Rw)||Rw);var ww;const Lw="rp_ofl_p";Object(i.singleton)(bw)(ww=Reflect.metadata("design:type",Function)(ww=Reflect.metadata("design:paramtypes",[])(ww=class{constructor(){this.logger=void 0,this.logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger("offline-monitor",["reporter"])}reportLastSession(){const e=n.default.getInstance().getObject(Lw);e&&(this.logger.zsymb(0,"lZPuPP","detect last session"),this.report(e))}report(e){this.logger.zsymb(0,"pURJxm","report: ",JSON.stringify(e)),fe.default.logActionInfoV2(fe.FeaturesInfo.PullOffline,1,e,[],!0);n.default.getInstance().removeItem(Lw)}saveDraft(e){n.default.getInstance().setObject(Lw,e),this.logger.zsymb(0,"lvq42L","draft saved: ",JSON.stringify(e))}log(e){this.logger.zsymb(0,"5aga_l","log: ",JSON.stringify(e))}})||ww)||ww);var Fw=s("N1xz"),Dw=s("CHYU");const Aw={auto_restart:!0,auto_restart_conf_no_restart:!0,auto_restart_conf_usage_time:144e5,auto_restart_conf_wss_limit:"2.5GB",auto_restart_conf_mem_limit:"2.5GB",auto_restart_conf_idle_time:6e5,auto_restart_conf_idle_interval_check:[9e5,3e5],auto_restart_ext_entry:!0,auto_restart_entries:[]},Nw="restart_ss";var kw;Pw=kw=Reflect.metadata("design:type",Function)(kw=Reflect.metadata("design:paramtypes",[])(kw=class extends wi.MetriczProcessLifecycle.Renderer{constructor(){super(),this.SIDEBAR_TAB_TO_PERSIST=[Ks.SidebarTab.MESSAGE_TAB,Ks.SidebarTab.CONTACT_TAB,Ks.SidebarTab.TODO_TAB],this._logger=void 0,this.running=void 0,this.checkPreviousPersistedStateAfterRestartSilently=()=>{const e=n.default.getInstance(),t=e.getItemForCurrentUser(Nw);if(t){this.Logger.zsymb(0,"8U74Db",`auto-restart: detect prev app state ${t}`);const i=async()=>{e.removeItemForCurrentUser(Nw)};try{const e=JSON.parse(t),{tab:s,ts:a,convId:n}=e;let r=6e4;if(D.default.getTimeNow()-a>r)return this.Logger.zsymb(18,"Pox7nH",`auto-restart: timeout ${r}, not persist prev app state.`),void i();if(!this.SIDEBAR_TAB_TO_PERSIST.includes(s))return this.Logger.zsymb(18,"uVb9-h",`auto-restart: invalid tab to persist: ${s}`),void i();const o=Q.a.ConvListController;if(o.isPreviewLoaded())setTimeout((()=>{this.recoverPreviousPersistedState(s,n)}),500);else{const e=()=>{setTimeout((()=>{this.recoverPreviousPersistedState(s,n)}),500),o.removeEventListener(Ys.c.LoadPreviewDone,e)};o.addEventListener(Ys.c.LoadPreviewDone,e)}}catch(s){i()}}$zsub.$zapp.removeListenAfterAppRestartSilently(this.checkPreviousPersistedStateAfterRestartSilently)},this.handleBeforeRestartSilently=()=>{const e=i.ModuleContainer.resolve(Ks.SidebarController).getState(),t=e.currentTab;if(this.SIDEBAR_TAB_TO_PERSIST.includes(t)){const s={tab:e.currentTab,ts:D.default.getTimeNow()};t===Ks.SidebarTab.MESSAGE_TAB&&e.selectedId&&(s.convId=e.selectedId),n.default.getInstance().setItemForCurrentUser(Nw,JSON.stringify(s)),this.Logger.zsymb(0,"fQVQ71","auto-restart: persist state before restart {}",s)}else this.Logger.zsymb(6,"zhKJOM",`auto-restart: not persist current tab ${t} before restart`)},this.useConfig(Aw)}get Logger(){return this._logger||(this._logger=this.createLogger("auto-restart")),this._logger}async appReady(e){this.checkEnabledAutoRestart(e),e.auto_restart&&$zsub.$zapp.afterAppRestartSilently(this.checkPreviousPersistedStateAfterRestartSilently)}async appReceiveConfigOnRuntime(e){this.checkEnabledAutoRestart(e)}beforeLogOut(){this.cancelCheckBeforeAppRestartSilently()}checkEnabledAutoRestart(e){if(e.auto_restart){if(this.running)return;this.running=!0,$zsub.$zapp.beforeAppRestartSilently(this.handleBeforeRestartSilently)}else this.cancelCheckBeforeAppRestartSilently()}cancelCheckBeforeAppRestartSilently(){this.running&&$zsub.$zapp.removeListenBeforeAppRestartSilently(this.handleBeforeRestartSilently)}recoverPreviousPersistedState(e,t){this.Logger.zsymb(0,"v_uIRj",`auto-restart: start recover previous persisted app state. tab ${e}${t?`; convid ${t}`:""}`);const s=i.ModuleContainer.resolve(Ks.SidebarController);if(s.getState().currentTab!==e&&s.changeTab(e),e===Ks.SidebarTab.MESSAGE_TAB&&t){const e=i.ModuleContainer.resolve(Ge.b);let s=Ge.c;t===U.default.sendToMeId&&(s=Ge.d.fromToolBoxFileTranfer()),s=Object(T.a)(Object(T.a)({},s),{},{silently:!0}),e.openConversation(t,s)}}})||kw)||kw,Fw.a.process===Dw.b.Render&&(null===(jw=Fw.a.ProcessLifecycleController)||void 0===jw||jw.register([Pw]));var Pw,jw;var Uw;const Bw={syncSource:null,forceSyncSource:null,isSyncing:!1};Object(ie.b)(tS.a)(Uw=Reflect.metadata("design:type",Function)(Uw=Reflect.metadata("design:paramtypes",[])(Uw=class{constructor(){this.state=Object(T.a)({},Bw),this.name="syc-zcloud-queue-ui",this.key="syc-zcloud-queue-ui"}getSyncSource(){return this.state.syncSource}getForceSyncSource(){return this.state.forceSyncSource}setSyncSource(e){this.setState((t=>{t.syncSource=e}))}setForceSyncSource(e){this.setState((t=>{t.forceSyncSource=e}))}reset(){this.setState((e=>{e.syncSource=null,e.forceSyncSource=null,e.isSyncing=!1}))}isSyncing(){return this.state.isSyncing}setSyncing(e){this.setState((t=>{t.isSyncing=e}))}init(){}getItem(){return this.state}getList(){return[]}onGetItemFailure(){}onGetListFailure(){}setState(e){const t=Object(kt.a)(this.state,e);this.state!==t&&(this.state=t,Object(Zs.g)(this.name,"current"))}})||Uw)||Uw);let Gw=function(e){return e[e.Hidden=0]="Hidden",e[e.Success=1]="Success",e[e.Info=2]="Info",e[e.Error=3]="Error",e}({});var zw;const xw={zCloudStatus:{isPaid:!1,hasKey:!1,isMigrated:!1},banner:Gw.Hidden,inProgressOffloadSize:0,isShowZCloudOffloadRedDot:!1,offloadingConv:"",error:null,offloadConvNum:0,totalOffloadConvNum:0,offloadSizeConvs:{}};Object(ie.b)(jS.b)(zw=Reflect.metadata("design:type",Function)(zw=Reflect.metadata("design:paramtypes",[])(zw=class{constructor(){this.name=jS.a,this.key="window_id",this.state=Object(T.a)({},xw)}setItem(e,t){this.setState((s=>{s[e]=t}))}setZCloudStatus(e){this.setState((t=>{t.zCloudStatus=e}))}isZCloudStatusReady(){const{zCloudStatus:e}=this.getState();return e.isPaid&&e.hasKey}setShowZCloudOffloadRedDot(e){this.setState((t=>{t.isShowZCloudOffloadRedDot=e}))}setInProgressOffloadSize(e){this.setState((t=>{t.inProgressOffloadSize=e}))}setError(e){this.setState((t=>{t.error=e}))}setOffloadingConv(e){this.setState((t=>{t.offloadingConv=e}))}setOffloadConvNum(e){this.setState((t=>{t.offloadConvNum=e}))}setTotalOffloadConvNum(e){this.setState((t=>{t.totalOffloadConvNum=e}))}setNewEstimatedSizeConv(e,t){this.setState((s=>{s.offloadSizeConvs=Object(T.a)(Object(T.a)({},s.offloadSizeConvs),{},{[e]:t})}))}resetScanedStates(){this.setState((e=>{e.offloadConvNum=xw.offloadConvNum,e.offloadSizeConvs=xw.offloadSizeConvs}))}reset(){this.setState((e=>{e.banner=Gw.Hidden,e.isShowZCloudOffloadRedDot=!1}))}getState(){return this.state}init(){}getItem(){return this.state}getList(){return[]}onGetItemFailure(){}onGetListFailure(){}setState(e){const t=Object(kt.a)(this.state,e);this.state!==t&&(this.state=t,Object(Zs.g)(this.name,"current"))}})||zw)||zw);var Vw,Hw=s("XNYy"),qw=s("5+PA"),Ww=s("X2DH"),Zw=s("/I0A");let Kw=Object(i.injectable)()(Vw=class{constructor(){this.decodeLocalImage=async e=>{const t=Date.now();try{const t=qw.b.get(e);if(t)return t.prepared;const s=await Object(Ww.a)(e),i=URL.createObjectURL(s);return qw.b.set(e,s.size,i),Si.default.increaseSuccess(al.a,0,0),Si.default.increaseSuccess(al.c,0,0),i}catch(kF){if(Object(Zw.a)().zsymb(21,"n91hJb",["JitJxlDecoderImpl:decodeLocalImage:failed","SGfpmY"],kF),Si.default.increaseFailed(al.c,0,0,Object(al.i)(),t),Si.default.increaseFailed(al.a,0,0,Object(al.k)(),t),Object(Il.l)(kF))throw kF;throw new Il.a(9999,"JitJxlDecoderImpl:decodeLocalImage:failed")}}}})||Vw;i.ModuleContainer.registerSingleton(Hw.a,Kw);const Qw=Object(i.define)("JIT_MEDIA_CODEC");var $w,Yw=s("zEx5");let Jw=Object(i.injectable)()($w=class{decodeLocalImage(e){return i.ModuleContainer.resolve(Yw.TJitJxlDecoder).decodeLocalImage(e)}})||$w;i.ModuleContainer.registerSingleton(Qw,Jw);let Xw=function(e){return e[e.Integrity=0]="Integrity",e[e.Strict=1]="Strict",e[e.BestEffort=2]="BestEffort",e}({});const eL={enable_feature:!0,roll_on_exceed_quota:!0,max_alive_account:5,roll_mode:Xw.Integrity,roll_buffer_count:0,count_user_in_ls:!1},tL=new Eb.a({enable_feature:Eb.b.field().boolean(),roll_on_exceed_quota:Eb.b.field().boolean(),max_alive_account:Eb.b.field().number().min(1),roll_mode:Eb.b.field().number().max(Xw.BestEffort).min(Xw.Integrity),roll_buffer_count:Eb.b.field().number().min(0),count_user_in_ls:Eb.b.field().boolean()});class sL extends GT.ZFeatureConfig{constructor(){super({default:eL,valiator:tL})}selector(e){return e.auto_roll_ls||{}}shouldConfigUpdate(e,t){return!0}}class iL{constructor(e,t,s){this.uid=e,this.keyPath=t,this.lastAccess=s,this.setup=void 0,this.dispose=void 0,this.runner=void 0,this.setup=null,this.runner=null,this.dispose=null}get rawKeyPath(){return this.keyPath.slice(1)}get userIndex(){return this.keyPath.slice(0,1)}installSetup(e){this.setup=e}installRunner(e){this.runner=e}installDispose(e){this.dispose=e}async roll(){this.setup&&await this.setup(),this.runner&&await this.runner(),this.dispose&&await this.dispose()}}class aL extends iL{constructor(e,t,s){super(e,t,s),this.uid=e,this.keyPath=t,this.lastAccess=s,this.runner=async()=>{localStorage.removeItem(this.keyPath)}}}var nL,rL=s("Kfp5");const oL="last_check_exceed_quota",cL=["_z_sc","_cdk","_react","_cl-uc","_rs","_tracking-old-cbb","_pcl-k","_preload_cache","_list_recent_g_search_v2"],lL=152101,dL=152102;Object(m.j)()(nL=Reflect.metadata("design:type",Function)(nL=Reflect.metadata("design:paramtypes",[])(nL=class{constructor(){this.logger=void 0,this.config=void 0,this._quotaExceed=void 0,this.logger=i.ModuleContainer.resolve(B.ZLoggerFactory).createZLogger(Ss.ZLoggerNametags.localstorage,[Ss.ZLoggerNametags.lsRoller]),this.config=new sL,this._quotaExceed=null}onAuthenticated(){}onStart(){requestIdleCallback((()=>{this.qosCountAccountInLS(),this.roll()}))}async roll(){if(!this.config.get("enable_feature"))return void this.logger.zsymb(0,"AXCPz8","skip roll, feat disable!");if(!this.isExceededQuota()&&this.config.get("roll_on_exceed_quota"))return void this.logger.zsymb(0,"PIe1bs","skip roll, quota ok!");const e=this.config.get("max_alive_account"),t=this.config.get("roll_mode"),s=this.getUserAccessTimes(),i=s.slice(e);switch(this.logger.zsymb(0,"thj38O","start roll: ",t,s.length,i.length),t){case Xw.Integrity:this.doRollMatchingKey(i),this.qosRoll(t,i.length);break;case Xw.Strict:this.doRollMatchingId(i),this.qosRoll(t,i.length);break;case Xw.BestEffort:{const a=this.config.get("roll_buffer_count"),n=e-a;if(this.doRollMatchingId(i),a&&s.length>=n){const t=s.slice(n,e);this.doRollMatchingKey(t)}this.qosRoll(t,s.length-n);break}default:this.logger.zsymb(0,"XXF-7T","Skip roll, unknow mode!")}}buildRollItems(e){return e.reduce(((e,t)=>(cL.forEach((s=>{const i=`${t.index}${s}`;e.push(new aL(t.uid,i,t.accessTime))})),e)),[])}setupExecutor(e){e.forEach((e=>{"_react"==e.rawKeyPath&&e.installSetup((async()=>{Object(rL.c)(e.uid)}))}))}doRollMatchingKey(e){const t=this.buildRollItems(e);this.setupExecutor(t),this.logger.zsymb(0,"cRRcVS","roll matching key: ",t.length),t.length&&Promise.all(t.map((e=>e.roll().catch((t=>{this.logger.zsymb(0,"rv0KDl","roll item got error: ",e.keyPath,t)})))))}doRollMatchingId(e){if(this.logger.zsymb(0,"dJ4Gwr","roll matching id: ",e.length),e.length){On.a.getInstance().cleanupLocalStorageMatchConditions((t=>e.some((e=>t.startsWith(e.index)))))}}isExceededQuota(){if(null!==this._quotaExceed)return this._quotaExceed;this._quotaExceed=!1;try{n.default.getInstance().setItemForCurrentUser(oL,Date.now().toString())}catch(e){this._quotaExceed=22==(null==e?void 0:e.code)}if(!this._quotaExceed){const e=new Blob(Object.values(localStorage)).size;this._quotaExceed=e>=5e6}return this._quotaExceed}getUserAccessTimes(){const e=Object(Kd.e)(),t=[];return e&&e.length&&e.forEach(((e,s)=>{t.push(this.getAccesstimeFor(e,s))})),t.sort(((e,t)=>t.accessTime-e.accessTime)),t}getAccesstimeFor(e,t){const s=localStorage.getItem(`${t}_${W.LAST_TIME_FETCH_ME_PREFIX}`)||0,i=localStorage.getItem(`${t}_${oL}`)||0;return{uid:e,index:t.toString(),accessTime:Math.max(+s,+i)}}qosRoll(e,t){t>0?Si.default.increaseSuccess(lL,e,0,[t]):Si.default.increaseFailed(lL,e,0,-t,Date.now())}qosCountAccountInLS(){if(!this.config.get("count_user_in_ls"))return;const e=this.isExceededQuota(),t=Object(Kd.e)().length;this.logger.zsymb(0,"WH7leu","total users in ls: ",e,t),e?Si.default.increaseFailed(dL,0,0,t,Date.now()):Si.default.increaseSuccess(dL,0,0,[t])}})||nL)||nL);const hL=Object(i.define)("settings-controller"),uL="z_chatbg_reset";var gL;Object(i.singleton)(hL)(gL=Object(m.j)()(gL=class{onStart(){this.switchDefaultOffBgChat()}switchDefaultOffBgChat(){const e=n.default.getInstance();if(!e.getItemForCurrentUser(uL)){this.isUseChatBackground()&&(ti.g.setUseChatBg(ye.p.getSessionUserId(),!1),N.default.send(P.GeneralActions.CHANGE_BG_CHAT,!1)),e.setItemForCurrentUser(uL,"1")}}isUseChatBackground(){const e=ye.p.getSessionUserId();return Boolean(ti.g.useChatBg(e))}})||gL);var mL=s("uPsl");class pL{constructor(){this.onDeleteMessage=this.onDeleteMessage.bind(this),this.registerEvents()}dispose(){}static create(){return new pL}static getInstance(){return pL.instance||(pL.instance=pL.create()),pL.instance}registerEvents(){k.a.instance.on("delete-message-only-me",this.onDeleteMessage)}cancelUpload(e){mL.a.emit("cancel-upload",e)}onDeleteMessage(e){if(e.type===P.ChatBoxActions.DELETE_MESSAGE){const{payload:t}=e;if(Array.isArray(t.messages)){const e=new Set;t.messages.forEach((t=>{t&&t.cliMsgId&&("file"===t.mediaType||"image"===t.mediaType)&&e.add(t.cliMsgId)})),e.size>0&&Array.from(e).forEach((e=>{this.cancelUpload(e)}))}}}}pL.instance=void 0,pL.create();var fL=s("+pEX"),vL=s("AWVP"),_L=s("Iq7B");class bL{constructor(e,t,s,i,a){this.name=void 0,this.code=void 0,this.data=void 0,this.message=void 0,this.details=void 0,this.name=e,this.code=t,this.message=s,this.details=i,this.data=a,Object(fL.a)().error(`${this.name}[${this.code}]:${this.message}`,this.details)}}class yL extends bL{constructor(e,t,s){super("HttpApiError",vL.e.HTTP_API,e,s),this.data=void 0,this.data=t}}class IL{async sendSeenSubChatTab(e){try{const t=w.b.getChatDomain(),s=_L.b,i=`${t}${s}${`?${this.getCommonParams_()}`}`,a=ms.a.newReq(),n={msgInfos:JSON.stringify({seens:e}),imei:ra.default.getZaloClientID()},r=`params=$${this.encodeParams_(n)}`,o=await rs.default._post(i,r,{retry:0},_L.a,void 0,!1,a),c=await Object(os.a)(o),{status:l}=null!=c?c:{};return vL.b.Success(0==l)}catch(a){var t,s,i;const e={status:null==a?void 0:a.status,errorCode:null!==(t=null==a?void 0:a.error_code)&&void 0!==t?t:null==a?void 0:a.code,message:null!==(s=null!==(i=null==a?void 0:a.error_message)&&void 0!==i?i:null==a?void 0:a.message)&&void 0!==s?s:""};return vL.b.Failure(new yL("Cannot send seen sub chat tab.",e,e))}}getCommonParams_(){return rs.default._getCommonParams()}encodeParams_(e){return rs.default._encodeParams(e)}}class SL extends bL{constructor(e,t,s){super("WSSApiError",vL.e.WSS_API,e,s),this.data=void 0,this.data=t}}class CL{async getLastSeenSubChatTab(e){const t={subtabs:e};try{const e=await Pm.a.instance().requestAsyncV2({cmd:lf.j.GET_LAST_SEEN_SUB_CHAT_TAB,subCmd:0,data:{data:t}});if(0!=e.error_code){const s={errorCode:e.error_code,message:e.error_message},i=Object(T.a)(Object(T.a)({},s),{},{params:JSON.stringify(t)}),a="Cannot get last seen sub chat tab.";return vL.b.Failure(new SL(a,s,i))}return vL.b.Success({clearUnreadInfo:e.data.clearUnreadInfo})}catch(n){var s,i,a;const e={errorCode:null!==(s=null==n?void 0:n.error_code)&&void 0!==s?s:null==n?void 0:n.code,message:null!==(i=null!==(a=null==n?void 0:n.error_message)&&void 0!==a?a:null==n?void 0:n.message)&&void 0!==i?i:""},r=Object(T.a)(Object(T.a)({},e),{},{params:JSON.stringify(t)}),o="Cannot get last seen sub chat tab.";return vL.b.Failure(new SL(o,e,r))}}}var EL,OL=s("1HgD"),TL=s("Ui4J");Object(i.injectable)()(EL=Object(i.singleton)(OL.a)(EL=Reflect.metadata("design:type",Function)(EL=Reflect.metadata("design:paramtypes",[])(EL=class{constructor(){this.httpApi_=void 0,this.wssApi_=void 0,this.currentSyncSeenSubtabReq_=null,this.httpApi_=new IL,this.wssApi_=new CL,Nm.default.getChatHandler().subcribe(lf.b.ON_DONE_OFFLINE,this.pullOfflineLastSeenSubChatTabIfNeeded_.bind(this))}sendSeenSubChatTab_(e,t){let s=!1;const i=null==t?void 0:t.signal;return i&&i.addEventListener("abort",(()=>s=!0)),new Promise(((t,i)=>{const a=TL.a(),n=Object(fl.a)((async()=>{const t=await this.httpApi_.sendSeenSubChatTab(e);return"error"===t.type?Promise.reject(t.data):Promise.resolve(t.data)}),{min:a.min,max:a.max,step:a.step,retries:a.retries,shouldRetryOnError:({error:e})=>new Promise((t=>{var i;if(s)return t(!1);if(!e)return t(!1);const a=null===(i=e.data)||void 0===i?void 0:i.errorCode;if(-69===a)return t(!1);return[W.NetWorkError.NO_NETWORK,W.NetWorkError.TIMEOUT,W.NetWorkError.TIMEOUT_SENT].includes(a)?t(!0):t(111!==a)}))});n().then((e=>{t(vL.b.Success(e))})).catch((e=>{t(vL.b.Failure(e))}))}))}syncSeenSubChatTab(e){const t={abortController:new AbortController,payload:{seens:e}};if(this.currentSyncSeenSubtabReq_){const s=this.currentSyncSeenSubtabReq_,i=[...s.payload.seens,...e].reduce(((e,t)=>{const s=t.sct+"_"+t.id;if(e[s]=t,e[s]){const i=e[s],a=t.msgId>i.msgId?t.msgId:i.msgId;e[s]=Object(T.a)(Object(T.a)({},t),{},{msgId:a})}else e[s]=t;return e}),Object.create(null));t.payload.seens=Object.values(i),s.abortController.abort()}this.currentSyncSeenSubtabReq_=t,this.sendSeenSubChatTab_(t.payload.seens,{signal:t.abortController.signal}).finally((()=>{this.currentSyncSeenSubtabReq_===t&&(this.currentSyncSeenSubtabReq_=null)}))}onReceiveSeenSubChatTab_(e,t=vL.a.Unknown){Object(fL.a)().info(`[${t}] Receive seen sub chat tab.`,{seens:e});const s=i.ModuleContainer.resolve(di.TUnreadSubChatTabStateManager),a=e.map((e=>({type:+e.idTo,msgId:e.lastMsgId})));s.onReceiveSeenSubChatTab(a)}async pullOfflineLastSeenSubChatTabIfNeeded_(){if(Object(fL.a)().info("[PullOffline] Start sync when done offline."),U.default.socket.enable_ctrl_socket){const e=[],t=i.ModuleContainer.resolve(di.TUnreadSubChatTabStateManager);if(t.getAllValidSubtabs().forEach((s=>{t.hasUnreadSubChatTab(s)&&e.push({sct:vL.c.SubChatTab,id:s})})),!e.length)return;const s=await this.wssApi_.getLastSeenSubChatTab(e);"success"===s.type?this.onReceiveSeenSubChatTab_(s.data.clearUnreadInfo,vL.a.Wss_PullOffline):Object(fL.a)().error("[PullOffline] Cannot get last seen sub chat tab.")}else Object(fL.a)().info("[PullOffline] Socket is not enabled. -> Skip.")}onReceiveSeenSubChatTabFromCtrl(e){this.onReceiveSeenSubChatTab_(e,vL.a.Wss_Response)}})||EL)||EL)||EL);var ML=s("TtB7"),RL=s("BjT2");class wL extends bL{constructor(e,t){super("InterfaceError",vL.e.INTERFACE,e,t)}}const LL="s_s_m_prxk",FL="l_r_m_i";class DL{constructor(){this.seenMilestoneAtSubtab_={[vL.d.ARCHIVED]:void 0,[vL.d.FOCUSED]:void 0},this.lastReceivedMsgInfoAtSubtab_={[vL.d.ARCHIVED]:void 0,[vL.d.FOCUSED]:void 0}}setNewSeenMilestone(e,t){if("string"!=typeof t||""===t){throw new wL("newMilestone must be a non-empty string.",{newMilestone:t})}this.seenMilestoneAtSubtab_[e]=t;const s=n.default.getInstance(),i=`${LL}::${e}`;s.setItemForCurrentUser(i,t)}getLastSeenMilestone(e){var t;let s=this.seenMilestoneAtSubtab_[e];if(null!=s)return s;const i=n.default.getInstance(),a=`${LL}::${e}`;return s=null!==(t=i.getItemForCurrentUser(a))&&void 0!==t?t:"",this.seenMilestoneAtSubtab_[e]=s,s}setNewReceivedMsgInfo(e,t){if(!t||!t.convId||!t.msgId){throw new wL("info is not valid.",{info:t})}this.lastReceivedMsgInfoAtSubtab_[e]=Object(T.a)({},t);const s=n.default.getInstance(),i=`${FL}::${e}`;s.setItemForCurrentUser(i,JSON.stringify(t))}getLastReceivedMsgInfo(e){var t,s;if(null!=this.lastReceivedMsgInfoAtSubtab_[e])return this.lastReceivedMsgInfoAtSubtab_[e];const i=n.default.getInstance(),a=`${FL}::${e}`,r=null!==(t=i.getItemForCurrentUser(a))&&void 0!==t?t:"";return r?(this.lastReceivedMsgInfoAtSubtab_[e]=null!==(s=JSON.parse(r))&&void 0!==s?s:{convId:"",msgId:""},this.lastReceivedMsgInfoAtSubtab_[e]):(this.lastReceivedMsgInfoAtSubtab_[e]={convId:"",msgId:""},this.lastReceivedMsgInfoAtSubtab_[e])}}var AL,NL=s("7l8h");Object(ie.b)(RL.b)(AL=function(e,t){return Object(i.inject)(NL.c)(e,void 0,0)}(AL=function(e,t){return Object(i.inject)(m.a)(e,void 0,1)}(AL=Reflect.metadata("design:type",Function)(AL=Reflect.metadata("design:paramtypes",["undefined"==typeof IUnreadSubChatTabNetworkService?Object:IUnreadSubChatTabNetworkService,"undefined"==typeof BaseApplication?Object:BaseApplication])(AL=class{constructor(e,t){this.unreadSubChatTabStateStore_=void 0,this.storage_=void 0,this.networkService_=void 0,this.key=ML.a,this.name=RL.a,this.storage_=new DL,this.networkService_=e,this.handleReceiveLatestMessage=this.handleReceiveLatestMessage.bind(this),this.handleReceiveLatestMessage_=this.handleReceiveLatestMessage_.bind(this),this.handleChangeSubtab=this.handleChangeSubtab.bind(this),this.hasUnreadSubChatTab=this.hasUnreadSubChatTab.bind(this),this.handleDisplayMessageTab=this.handleDisplayMessageTab.bind(this),this.handleHideMessageTab=this.handleHideMessageTab.bind(this),this.handleUpdateArchivedChat=this.handleUpdateArchivedChat.bind(this),this.handleMoveConvFromHiddenToArchivedChat=this.handleMoveConvFromHiddenToArchivedChat.bind(this),this.handleShowReddotsAtSubChatTab=this.handleShowReddotsAtSubChatTab.bind(this),t.addEventListener(m.b.Idle,this.handleMainApplicationInBackground_.bind(this)),t.addEventListener(m.b.Active,this.handleMainApplicationInForeground_.bind(this))}handleReceiveLatestMessage(e){this.handleReceiveLatestMessage_(e)}handleReceiveLatestMessage_(e){const{convId:t,msgId:s}=e,i=this.getSubtabTypeOfConv(t);if(!this.isValidSubChatTabType(i))return;const a=this.storage_.getLastReceivedMsgInfo(i);(!a.msgId||a.msgId<s)&&this.storage_.setNewReceivedMsgInfo(i,{convId:t,msgId:s})}getSubtabTypeOfConv(e){let t=vL.d.NONE;return li.a.isArchivedChat(e)?t=vL.d.ARCHIVED:Le.a.isThreadHidden(e)||(t=vL.d.FOCUSED),t}handleShowReddotsAtSubChatTab(e){const t=this.convetFilterTypeToSubChatTabType(Q.a.ConvListController.getCurrentFilter().type);this.getAllValidSubtabs().forEach((s=>{if(t===s)return;const i=this.hasUnreadSubChatTab(s),a=e[s];if(i!==a){let e=this.getUnreadSubChatTabStateStore_()[s];e=Object(T.a)(Object(T.a)({},e),{},{hasUnread:a}),this.getUnreadSubChatTabStateStore_()[s]=e,Object(Zs.g)(this.name,this.key)}}))}handleMoveConvFromHiddenToArchivedChat(e){this.updateSeenMilestoneByLastProcessUnreadMsgIdIfNeeded_(e,vL.d.ARCHIVED)}handleUpdateArchivedChat(e){this.updateSeenMilestoneByLastProcessUnreadMsgIdIfNeeded_(e,vL.d.ARCHIVED)}handleMoveConvToArchiveChat(e){this.updateSeenMilestoneByLastProcessUnreadMsgIdIfNeeded_(e,vL.d.ARCHIVED)}handleMoveConvToFocusedChat(e){this.updateSeenMilestoneByLastProcessUnreadMsgIdIfNeeded_(e,vL.d.FOCUSED)}handleChangeSubtab(e,t){const s={fromSubtab:e,toSubtab:t};Object(fL.a)().info("[Event] Change subtab.",s);const i=[];if(this.isValidSubChatTabType(t)){const e=this.storage_.getLastReceivedMsgInfo(t);if(e.msgId){let s=this.getUnreadSubChatTabStateStore_()[t];s=Object(T.a)(Object(T.a)({},s),{},{hasUnread:!1}),this.getUnreadSubChatTabStateStore_()[t]=s,this.storage_.setNewSeenMilestone(t,e.msgId),Object(Zs.g)(this.name,this.key),i.push({sct:vL.c.SubChatTab,msgId:e.msgId,id:t})}}if(this.isValidSubChatTabType(e)){const t=this.storage_.getLastReceivedMsgInfo(e),s=this.storage_.getLastSeenMilestone(e);t.msgId&&t.msgId>s&&(this.storage_.setNewSeenMilestone(e,t.msgId),i.push({sct:vL.c.SubChatTab,msgId:t.msgId,id:e}))}i.length&&this.networkService_.syncSeenSubChatTab(i)}handleDisplayMessageTab(e){const t=this.convetFilterTypeToSubChatTabType(Q.a.ConvListController.getCurrentFilter().type);if(Object(fL.a)().info("[Event] Display message tab.",{info:e,enteringSubtab:t}),!this.isValidSubChatTabType(t))return;const s=[],i=this.storage_.getLastReceivedMsgInfo(t),a=this.storage_.getLastSeenMilestone(t);if(i.msgId&&i.msgId>a){const e=i.msgId;this.storage_.setNewSeenMilestone(t,e),s.push({sct:vL.c.SubChatTab,id:t,msgId:e})}s.length&&this.networkService_.syncSeenSubChatTab(s)}handleHideMessageTab(e){const t=this.convetFilterTypeToSubChatTabType(Q.a.ConvListController.getCurrentFilter().type);if(Object(fL.a)().info("[Event] Hide message tab.",{info:e,leavingSubtab:t}),!this.isValidSubChatTabType(t))return;const s=[],i=this.storage_.getLastReceivedMsgInfo(t),a=this.storage_.getLastSeenMilestone(t);if(i.msgId&&i.msgId>a){const e=i.msgId;this.storage_.setNewSeenMilestone(t,e),s.push({sct:vL.c.SubChatTab,id:t,msgId:e})}s.length&&this.networkService_.syncSeenSubChatTab(s)}updateSeenMilestoneByLastProcessUnreadMsgIdIfNeeded_(e,t){const s=Q.a.UnreadDataManager.getUnreadByConvIdSync(e);if(!s)return;const i=s.lastProcessMsgId;if(!i)return;const a=this.storage_.getLastSeenMilestone(t);a&&a>=i||this.storage_.setNewSeenMilestone(t,i)}handleMainApplicationInForeground_(){const e=this.convetFilterTypeToSubChatTabType(Q.a.ConvListController.getCurrentFilter().type);if(Object(fL.a)().info(`[Event] Main application in foreground - enteringSubtab: ${e}`),!this.isValidSubChatTabType(e))return;const t=[],s=this.storage_.getLastReceivedMsgInfo(e),i=this.storage_.getLastSeenMilestone(e);if(s.msgId&&s.msgId>i){const i=s.msgId;this.storage_.setNewSeenMilestone(e,i),t.push({sct:vL.c.SubChatTab,id:e,msgId:i})}t.length&&this.networkService_.syncSeenSubChatTab(t)}handleMainApplicationInBackground_(){const e=this.convetFilterTypeToSubChatTabType(Q.a.ConvListController.getCurrentFilter().type);if(Object(fL.a)().info(`[Event] Main application in background - leavingSubtab: ${e}`),!this.isValidSubChatTabType(e))return;const t=[],s=this.storage_.getLastReceivedMsgInfo(e),i=this.storage_.getLastSeenMilestone(e);if(s.msgId&&s.msgId>i){const i=s.msgId;this.storage_.setNewSeenMilestone(e,i),t.push({sct:vL.c.SubChatTab,id:e,msgId:i})}t.length&&this.networkService_.syncSeenSubChatTab(t)}onReceiveSeenSubChatTab(e){e.forEach((({type:e,msgId:t})=>{if(this.isValidSubChatTabType(e)){const s=t,i=this.storage_.getLastSeenMilestone(e);if(s&&s>i){let t=this.getUnreadSubChatTabStateStore_()[e];t=Object(T.a)(Object(T.a)({},t),{},{hasUnread:!1}),this.getUnreadSubChatTabStateStore_()[e]=t,this.storage_.setNewSeenMilestone(e,s),Object(Zs.g)(this.name,this.key)}}}))}hasUnreadSubChatTab(e){var t;return!!this.isValidSubChatTabType(e)&&(null!==(t=this.getUnreadSubChatTabStateStore_()[e].hasUnread)&&void 0!==t&&t)}isValidSubChatTabType(e){return this.getAllValidSubtabs().includes(e)}convetFilterTypeToSubChatTabType(e){return e===Ii.d.FOCUSED?vL.d.FOCUSED:e===Ii.d.ARCHIVED?vL.d.ARCHIVED:vL.d.NONE}getAllSeenMilestones(){return this.getAllValidSubtabs().reduce(((e,t)=>(e[t]=this.storage_.getLastSeenMilestone(t),e)),{})}getAllValidSubtabs(){return[vL.d.FOCUSED,vL.d.ARCHIVED]}getUnreadSubChatTabStateStore_(){return this.unreadSubChatTabStateStore_||(this.unreadSubChatTabStateStore_=this.getAllValidSubtabs().reduce(((e,t)=>(e[t]={type:t,hasUnread:!1},e)),{})),this.unreadSubChatTabStateStore_}init(){}getItem(e){if(e.key===this.key)return this.unreadSubChatTabStateStore_}getList(e,t){return[]}onGetItemFailure(e,t){0}onGetListFailure(e,t){0}})||AL)||AL)||AL)||AL);s("UCdJ"),s("69Uf"),s("Q/Ir"),s("Lp8g"),s("mneU");var kL=s("GFHO"),PL=s("ziJS"),jL=s("YZUF");s("zlHd");function UL(){PL.b.init(),Oa.b.init(),jL.b.init()}(function(e){const t=new kL.a(e);if(t.remoteConfigs.key("enable").boolean)UL();else{const e=()=>{t.remoteConfigs.key("enable").boolean&&(UL(),t.remoteConfigs.remove(e))};t.remoteConfigs.add(e)}})({platform:"pc"});var BL,GL=s("eK4z");as.g.timeInMs("3m"),as.f.sizeInByte("110MB"),as.f.sizeInByte("100MB"),as.g.timeInMs("24h"),as.g.timeInMs("5s"),as.f.sizeInByte("200MB");const zL={enable:!1,max_retries_create_bu:3,max_timeout_duration:as.g.timeInMs("3m"),total_msg_ratio:1636,delta_size_estimated_sqlite:as.f.sizeInByte("110MB"),force_start_migrate:!1,delta_size_storage_checking:as.f.sizeInByte("100MB"),auto_remind_modal_timeout:as.g.timeInMs("24h"),auto_dismiss_success_screen:as.g.timeInMs("5s"),migrate_version:1,max_retry_count:2,min_estimated_sqlite_size:as.f.sizeInByte("200MB"),drop_idb:!1};let xL=Object(i.singleton)()(BL=Reflect.metadata("design:type",Function)(BL=Reflect.metadata("design:paramtypes",[])(BL=class extends GT.AdvancedRemoteConfigs{constructor(){super("db_migrate",zL,{validator:new GT.ObjectValidator({enable:GT.Rule.field().boolean(),max_retries_create_bu:GT.Rule.field().number().min(0),max_timeout_duration:GT.Rule.field().number().min(0),total_msg_ratio:GT.Rule.field().number().min(0),delta_size_estimated_sqlite:GT.Rule.field().number().min(0),force_start_migrate:GT.Rule.field().boolean(),delta_size_storage_checking:GT.Rule.field().number().min(0),auto_remind_modal_timeout:GT.Rule.field().number().min(0),auto_dismiss_success_screen:GT.Rule.field().number().min(0),migrate_version:GT.Rule.field().number().min(1),max_retry_count:GT.Rule.field().number().min(1),min_estimated_sqlite_size:GT.Rule.field().number().min(0),drop_idb:GT.Rule.field().boolean()})})}loadConfig(e){super.loadConfig(e)}})||BL)||BL)||BL;i.ModuleContainer.registerSingleton(GL.a,xL);class VL{constructor(){this.shouldPromote=void 0,this.shouldPromote=!1}setShouldPromote(e){this.shouldPromote=e}promoteForOpenConv(e){const t={type:"open-conv",payload:{convId:e}};this.sendPromote(t)}async sendPromote(e){if(this.shouldPromote){const t={typeID:f.k,data:{type:f.t,data:e}},s=i.ModuleContainer.resolve(p.b),a=await s.getPort();await a.invokeMessage(t)}}}var HL=s("/brz"),qL=s("YEoC");let WL=function(e){return e[e.SQLITE_OK=0]="SQLITE_OK",e[e.SQLITE_ERROR=1]="SQLITE_ERROR",e[e.SQLITE_INTERNAL=2]="SQLITE_INTERNAL",e[e.SQLITE_PERM=3]="SQLITE_PERM",e[e.SQLITE_ABORT=4]="SQLITE_ABORT",e[e.SQLITE_BUSY=5]="SQLITE_BUSY",e[e.SQLITE_LOCKED=6]="SQLITE_LOCKED",e[e.SQLITE_NOMEM=7]="SQLITE_NOMEM",e[e.SQLITE_READONLY=8]="SQLITE_READONLY",e[e.SQLITE_INTERRUPT=9]="SQLITE_INTERRUPT",e[e.SQLITE_IOERR=10]="SQLITE_IOERR",e[e.SQLITE_CORRUPT=11]="SQLITE_CORRUPT",e[e.SQLITE_NOTFOUND=12]="SQLITE_NOTFOUND",e[e.SQLITE_FULL=13]="SQLITE_FULL",e[e.SQLITE_CANTOPEN=14]="SQLITE_CANTOPEN",e[e.SQLITE_PROTOCOL=15]="SQLITE_PROTOCOL",e[e.SQLITE_EMPTY=16]="SQLITE_EMPTY",e[e.SQLITE_SCHEMA=17]="SQLITE_SCHEMA",e[e.SQLITE_TOOBIG=18]="SQLITE_TOOBIG",e[e.SQLITE_CONSTRAINT=19]="SQLITE_CONSTRAINT",e[e.SQLITE_MISMATCH=20]="SQLITE_MISMATCH",e[e.SQLITE_MISUSE=21]="SQLITE_MISUSE",e[e.SQLITE_NOLFS=22]="SQLITE_NOLFS",e[e.SQLITE_AUTH=23]="SQLITE_AUTH",e[e.SQLITE_FORMAT=24]="SQLITE_FORMAT",e[e.SQLITE_RANGE=25]="SQLITE_RANGE",e[e.SQLITE_NOTADB=26]="SQLITE_NOTADB",e[e.SQLITE_NOTICE=27]="SQLITE_NOTICE",e[e.SQLITE_WARNING=28]="SQLITE_WARNING",e[e.SQLITE_ROW=100]="SQLITE_ROW",e[e.SQLITE_DONE=101]="SQLITE_DONE",e[e.SQLITE_BUSY_RECOVERY=261]="SQLITE_BUSY_RECOVERY",e}({});Error;var ZL=s("MRjZ");let KL=function(e){return e[e.READ=1]="READ",e[e.WRITE=2]="WRITE",e[e.INIT=3]="INIT",e}({});var QL=s("XB6V");let $L;(()=>{const e=i.ModuleContainer.resolve(QL.a);$L=e.createZLogger(Ss.ZLoggerNametags.sqlDataMigration,[""])})();var YL=$L;let JL,XL,eF;var tF;let sF;!function(e){e.isSQLiteError=function(e){return void 0!==e.errno},e.ignoreable=function(e){return t.has(e.errno)},e.retryable=function(e){return s.has(e.errno)},e.renewableError=function(e){return i.has(e.errno)},e.forceStop=function(e){return a.has(e.errno)};const t=new Set([WL.SQLITE_NOTICE,WL.SQLITE_WARNING]),s=new Set([WL.SQLITE_BUSY,WL.SQLITE_ERROR,WL.SQLITE_ABORT,WL.SQLITE_LOCKED,WL.SQLITE_INTERRUPT,WL.SQLITE_PROTOCOL,WL.SQLITE_MISUSE,WL.SQLITE_BUSY_RECOVERY]),i=new Set([WL.SQLITE_IOERR,WL.SQLITE_ERROR,WL.SQLITE_CORRUPT,WL.SQLITE_CANTOPEN,WL.SQLITE_NOTADB]),a=new Set([WL.SQLITE_NOMEM,WL.SQLITE_PERM])}(JL||(JL={})),function(e){e.isIndexedDBError=function(e){return void 0===e.errno&&void 0!==e.code};let t=function(e){return e.NoModificationAllowedError="NoModificationAllowedError",e.DBNotFoundError="DBNotFoundError",e.NotFoundError="NotFoundError",e.NotSupportedError="NotSupportedError",e.InvalidStateError="InvalidStateError",e.SyntaxError="SyntaxError",e.InvalidModificationError="InvalidModificationError",e.AbortError="AbortError",e.QuotaExceededError="QuotaExceededError",e.TimeoutError="TimeoutError",e.DataCloneError="DataCloneError",e.EncodingError="EncodingError",e.NotReadableError="NotReadableError",e.UnknownError="UnknownError",e.ConstraintError="ConstraintError",e.DataError="DataError",e.ReadOnlyError="ReadOnlyError",e.VersionError="VersionError",e.OperationError="OperationError",e.NotAllowedError="NotAllowedError",e.OptOutError="OptOutError",e.Undefined="Undefined",e}({});e.errorsName=t;let s=function(e){return e[e.NoModificationAllowedError=7]="NoModificationAllowedError",e[e.NotFoundError=8]="NotFoundError",e[e.NotSupportedError=9]="NotSupportedError",e[e.InvalidStateError=11]="InvalidStateError",e[e.SyntaxError=12]="SyntaxError",e[e.InvalidModificationError=14]="InvalidModificationError",e[e.AbortError=20]="AbortError",e[e.QuotaExceededError=22]="QuotaExceededError",e[e.TimeoutError=23]="TimeoutError",e[e.DataCloneError=25]="DataCloneError",e}({});e.errorsCode=s,e.retryable=function(e,i){const a=[t.AbortError,t.TimeoutError,t.NotReadableError,t.OperationError].includes(e),n=[s.AbortError,s.TimeoutError].includes(i);return a||n},e.ignoreable=function(e,i){const a=[t.NotFoundError].includes(e),n=[s.NotFoundError].includes(i);return a||n},e.forceStop=function(e,i){const a=[t.QuotaExceededError].includes(e),n=[s.QuotaExceededError].includes(i);return a||n}}(XL||(XL={})),(tF=eF||(eF={})).shouldIgnoreError=function(e,t){return e==qL.a.IDB?XL.ignoreable(t.name,t.code):e==qL.a.SQLite&&JL.ignoreable(t)},tF.shouldRetryError=function(e,t){return e==qL.a.IDB?XL.retryable(t.name,t.code):e==qL.a.SQLite&&JL.retryable(t)},tF.shouldForceStopError=function(e,t){return e==qL.a.IDB?XL.forceStop(t.name,t.code):e==qL.a.SQLite&&JL.forceStop(t)},(sF||(sF={})).parseErrorCode=function({error:e}){try{return JL.isSQLiteError(e)||XL.isIndexedDBError(e)?e.code:"re_"+e.name}catch(kF){return YL.zsymb(21,"kplhxB",["Failed to parse error code: {}","ip5Wjz"],Object(ZL.b)(kF)),-2}};KL.WRITE;var iF=s("dko3");class aF{constructor({session:e,dbConfig:t}){this.session=void 0,this.dbConfig=void 0,this.database=null,this.session=e,this.dbConfig=t}async openDB(){if(null===this.database){const e="",t=this.dbConfig.computeDatabaseName(this.session.userId,e),s=this.dbConfig.getPartition(e,this.session);this.database=await nF.open(t,s)}return this.database}closeConnection(){this.database&&this.database.close()}async getStoreOrIndex(e,t){try{const s=await this.openDB(),i=s.transaction(e.tableName,"readonly").objectStore(e.tableName);return t&&"primary"!=t?i.index(t):i}catch(s){if((null==s?void 0:s.code)===XL.errorsCode.NotFoundError)throw new nF.TableDoesNotExistError(e.tableName);throw s}}async isTableExist(e){try{return await this.getStoreOrIndex(e),!0}catch(t){return!1}}async get(e,t){const s=await this.getStoreOrIndex(e);return await nF.get(s,nF.toIDBQuery(t))}async getAll(e,t,s){const i=await this.getStoreOrIndex(e,null==s?void 0:s.index);return await nF.getAll(i,nF.toIDBQuery(t),null==s?void 0:s.count)}async getMulti(e,t){const s=await this.getStoreOrIndex(e);return await nF.getMulti(s,t)}async count(e,t){const s=await this.getStoreOrIndex(e);return await nF.count(s,nF.toIDBQuery(t))}async getAllKeys(e,t){const s=await this.getStoreOrIndex(e);return await nF.getAllKeys(s,nF.toIDBQuery(t))}}let nF;!function(e){class t extends Error{constructor(e,t){super(t),this.code=e,this.message=t}}e.IDBError=t;e.DBDoesNotExistError=class extends t{constructor(e){super(XL.errorsCode.NotFoundError,`Database ${e} does not exist`),this.name=XL.errorsName.DBNotFoundError}};e.TableDoesNotExistError=class extends t{constructor(e){super(XL.errorsCode.NotFoundError,`Table ${e} does not exist`),this.name=XL.errorsName.NotFoundError}};e.isDatabaseExist=async e=>(await indexedDB.databases()).some((t=>t.name===e)),e.open=async(e,t)=>{if(!(await nF.isDatabaseExist(e)))throw new nF.DBDoesNotExistError(e);return new Promise(((s,i)=>{const a=iF.a.open(e,t.version);a.onsuccess=()=>{s(a.result)},a.onerror=()=>{i(a.error)},a.onblocked=()=>{i(a.error)},a.onupgradeneeded=async s=>{if(null!==s.newVersion)try{const i=a.result,n=a.transaction,r=new HL.a(e,t,i,n);await r.upgrade(s.oldVersion,s.newVersion)}catch(i){throw a.transaction.abort(),i}}}))},e.get=async(e,...t)=>{var s;return null!==(s=await nF.promisifyRequest(e.get(...t)))&&void 0!==s?s:null},e.getAll=(e,...t)=>nF.promisifyRequest(e.getAll(...t)),e.getMulti=(e,t)=>Promise.all(t.map((t=>nF.get(e,t)))),e.getAllKeys=(e,...t)=>nF.promisifyRequest(e.getAllKeys(...t)),e.count=(e,...t)=>nF.promisifyRequest(e.count(...t)),e.promisifyRequest=e=>new Promise(((t,s)=>{e.onsuccess=()=>t(e.result),e.onerror=()=>s(e.error)})),e.toIDBQuery=e=>{if(e){if("string"==typeof e)return e;if("number"==typeof e)return e;if(Array.isArray(e))return e;if(e.from&&e.to)try{return IDBKeyRange.bound(nF.firstOrArray(e.from),nF.firstOrArray(e.to),e.excludeFrom,e.excludeTo)}catch(t){throw t}return e.from?IDBKeyRange.lowerBound(nF.firstOrArray(e.from),e.excludeFrom):e.to?IDBKeyRange.upperBound(nF.firstOrArray(e.to),e.excludeTo):void 0}},e.firstOrArray=e=>1===e.length?e[0]:e}(nF||(nF={}));var rF=s("0W0H"),oF=s("pAGP"),cF=s("JTyQ"),lF=s("2xv9"),dF=s("ggcH"),hF=s("zmG6"),uF=s("Fzrl"),gF=s("p2N7"),mF=s("Q97H"),pF=s("DwEK"),fF=s("4lsZ"),vF=s("ycTR"),_F=s("oRsZ"),bF=s("lDvZ"),yF=s("B7VA"),IF=s("+ExH"),SF=s("0B28");const CF=new Set(rF.f);class EF{constructor(){this.isLocked=void 0,this.isDeleted=void 0,this.session=void 0,this.logger=void 0,this.dodeleteOldDB=async()=>{if(this.isLocked)this.logger.zsymb(0,"GdZuma","Someone call delete when action is locked");else if(await this.dbCleanupHasDone()){this.logger.zsymb(0,"uBAau7","The DB has already been deleted!");TF.getLastBeginTime()&&(this.logger.zsymb(0,"3Jj5tt","Continue delete backup data!"),this.deleteBackupFolder())}else{if(this.lock(),await this.shouldDeleteUserScopeIDB()){const e=Date.now();await this.deleteUserscopeDB().then((t=>{this.qos(t,yF.b.SUB_CMD.USER_SCOPE,Date.now()-e,0)}))}if(await this.shouldDeleteSharedIDB()){const e=Date.now();await this.deleteSharedDB().then((t=>{this.qos(t,yF.b.SUB_CMD.SHARED_DB,Date.now()-e,0)}))}await OF.noDatabasesExists()&&await this.deleteBackupFolder(),this.logger.zsymb(0,"U81Sls","The DB deletion has been done!")}},this.isLocked=!0,this.isDeleted=!1,this.session=null;const e=i.ModuleContainer.resolve(B.ZLoggerFactory);this.logger=e.createZLogger("db-migrate",["DbCleaner"])}static instance(){return this._instance||(this._instance=new this),this._instance}async dbCleanupHasDone(){return!this.session||!(await OF.doesUserDatabasesExist(this.session.userId))&&(!(await OF.isOnlySharesDBsExists())||(this.logger.zsymb(0,"RsTzTl","Detect only shared DB exists"),!1))}async shouldDeleteUserScopeIDB(){return Promise.resolve(!0)}async shouldDeleteSharedIDB(){return Promise.resolve(!0)}lock(){this.logger.zsymb(0,"qzqrGn","lock action"),this.isLocked=!0}unlock(){this.logger.zsymb(0,"x5RcHZ","unlock action"),this.isLocked=!1}async deleteOldDB(e){this.isDeleted?this.logger.zsymb(0,"S6aOXG","Call delete DB already trigger, skip!"):(this.logger.zsymb(0,"ZSovH4","The DB deletion has been schedule!"),this.session=e,this.isDeleted=!0,window.requestIdleCallback(this.dodeleteOldDB,{timeout:1e4}))}deleteSharedDB(){return this.logger.zsymb(0,"dR1ERa","start delete shared DB"),this.deleteDatabases(OF.getSharedDBConfigs())}deleteUserscopeDB(){return this.logger.zsymb(0,"hFeLle","start delete user scope DB"),this.deleteDatabases(OF.getUserScopeDBConfigs())}deleteDatabases(e){const t=e.map((e=>{const t=e.computeDatabaseName(this.session.userId,"");return async()=>this.deleteDatabaseWithName(t)}));return new Promise((e=>{Ga.a.series(t,((t,s)=>{if(t)this.logger.zsymb(18,"NjEqeu","Delete DBs got error: ",t),e(!1);else if(s){const t=null==s?void 0:s.every((e=>e));e(t)}}))}))}async deleteDatabaseWithName(e){if(!(await OF.doesDatabaseExist(e)))return this.logger.zsymb(6,"VklYJR",`Skip db deletion due to non-existence: '${e}'`),!0;const t=indexedDB.deleteDatabase(e);return new Promise((s=>{t.onsuccess=()=>{this.logger.zsymb(0,"x692wH",`Database has been successfully deleted: '${e}'`),s(!0)},t.onblocked=()=>{this.logger.zsymb(18,"g324zm",`Failed to delete DB: '${e}' - Blocked`),s(!1)},t.onerror=()=>{const i=t.error;this.logger.zsymb(18,"7DtpWz",`Failed to delete DB: '${e}' - Error: ${i}`),s(!1),this.qos(!1,yF.b.SUB_CMD.ERROR_TRACKING,0,(null==i?void 0:i.code)||0)}}))}async deleteBackupFolder(){return this.logger.zsymb(0,"FjQ1fY","Start delete backup data"),TF.markBeginDestroy(),SF.a.getInstance().destroyBackup(Yt.AdapterType.IDB).then((e=>{e&&TF.clearBeginDestroy(),this.logger.zsymb(0,"X4NV9U","End delete backup data",e)}))}qos(e,t,s,i){e?Si.default.increaseSuccess(yF.b.CMD,t,s):Si.default.increaseFailed(yF.b.CMD,t,s,i,Date.now())}}let OF,TF;EF._instance=void 0,function(e){let t=[];async function s(e=!1){return t.length&&!e||(t=await indexedDB.databases()),t}function i(){const e=Object.keys(IF.b),t=[];for(const s of e)if(CF.has(s)){const e=Object(vF.a)(s,Yt.AdapterType.IDB);e&&t.push(e)}return t}e.doesDatabaseExist=async function(e,t=!1){return(await s(t)).some((t=>t.name==e))},e.doesUserDatabasesExist=async function(e,t=!1){return(await s(t)).some((t=>{var s;return null===(s=t.name)||void 0===s?void 0:s.includes(e)}))},e.isOnlySharesDBsExists=async function(e=!1){const t=await s(e),a=i(),n=new Set(a.map((e=>e.computeDatabaseName("",""))));return!t.some((e=>e.name&&!n.has(e.name)))&&0!==t.length},e.noDatabasesExists=async function(){return 0==(await s(!0)).length},e.getSharedDBConfigs=i,e.getUserScopeDBConfigs=function(){const e=Object.keys(IF.b),t=[];for(const s of e)if(!CF.has(s)){const e=Object(vF.a)(s,Yt.AdapterType.IDB);e&&t.push(e)}return t}}(OF||(OF={})),function(e){const t="d-bu-bt";e.getLastBeginTime=function(){return n.default.getInstance().getInt(t,{defaultInt:0})},e.markBeginDestroy=function(){const e=n.default.getInstance(),s=Date.now().toString();e.setItem(t,s)},e.clearBeginDestroy=function(){n.default.getInstance().removeItem(t)}}(TF||(TF={}));var MF=s("NTiX"),RF=s("9bet"),wF=s("3iCl");var LF,FF=new class{constructor(){this.messageLogs=[]}checkAndLog(e,t={error_code:0}){try{if(e!==yF.g.CMD)return;if(t.identity&&t.identity.includes("Message"))return t.migrated_count&&this.messageLogs.push(t.migrated_count),void(this.messageLogs.length>=30&&this.flushLogs());this._log({migrated_count:t.migrated_count,identity:t.identity})}catch(s){}}flushLogs(){this._log({data:this.messageLogs,identity:"MsgCount"}),this.messageLogs=[]}_log(e){fe.default.logActionInfoV2(fe.FeaturesInfo.DBv4Migrate,1,e,[])}},DF=s("QO5D");const AF={percent:0,status:La.d.UNSET,isLowDiskSpace:!1,requiredSpace:0,error:"",migratedCount:0,toMigrateCount:0,timeElapsed:0,numOfReader:1,batchSize:5e3,count:1,pausedLastSession:!1,allowReject:!1,forceReject:!1};let NF=Object(i.injectable)()(LF=Object(i.singleton)()(LF=function(e,t){return Object(i.inject)(GL.a)(e,void 0,0)}(LF=function(e,t){return Object(i.inject)(MF.b)(e,void 0,1)}(LF=Reflect.metadata("design:type",Function)(LF=Reflect.metadata("design:paramtypes",["undefined"==typeof IMigrateRemoteConfigs?Object:IMigrateRemoteConfigs,"undefined"==typeof IDatabaseStateStorage?Object:IDatabaseStateStorage])(LF=class{constructor(e,t){this.config=e,this.databaseStateStorage=t,this.name=void 0,this.key=void 0,this.state=void 0,this.signalDone=void 0,this.session=void 0,this.startTime=void 0,this.timeoutTimer=null,this.storageCheckingTimer=null,this.promoteSubject=void 0,this.migrateResolver=void 0,this.isMigrateStarted=void 0,this.taskScheduler=new pF.a(new fF.a,!1),this.logger=void 0,this.didBlockApp=!1,this.stopHandleMigrateProcessDisconnected=()=>{},this.initControllerServiceContainer=null,this.initCacheTotalMsgContainer=null,this.preparedDataProfileTimers=new Map,this.storageCheckingTimerContainer=null,this.isMigrationPaused=!1,this.didSignalProcessToStartMigration=!1,this.removeListenerFullDiskFromSM=()=>{},this.cachedIsFirstTimeMigrate=null,this.cachedTotalMsgCount=-1,this.migrateLocalInfo=null,this._lastElapsedTime=null,this.timeElapsedTimer=null,this.migrateDoneState=null,this._isTrickle=null,this.reminderTimeout=null,this.migrateProgressPercent=null,this.showSuccessScreen=!1,this.handleDBCorruption=e=>{if(this.isMigrateStarted){const{tsStartCheck:t}=e;this.handleErrorDuringBigBangMigration(`Corrupt - tsStartCheck: ${t}`),this.logger.zsymb(0,"KfTwkv","[status] Pause migration due to corruption"),this.handlePauseMigrate("db-corrupt")}else this.logger.zsymb(0,"aZzZwI","[status] corrupt in onboarding screen. Ignore")},this.requestClearInfoDBSizeCache=async()=>{const e={type:f.e,data:{}},t=i.ModuleContainer.resolve(p.b),s=await t.getPort(),a={typeID:f.k,data:e};await s.invokeMessage(a)},this.requestPauseMigrate=async e=>{const t={type:f.s,data:{reason:e}},s=i.ModuleContainer.resolve(p.b),a=await s.getPort(),n={typeID:f.k,data:t};await a.invokeMessage(n),this.isMigrationPaused=!0},this.requestResumeMigrate=async e=>{const t={type:f.w,data:{reason:e}},s=i.ModuleContainer.resolve(p.b),a=await s.getPort(),n={typeID:f.k,data:t};await a.invokeMessage(n),this.isMigrationPaused=!1},this.name=La.a,this.key="",this.state=AF,this.session={userId:""},this.startTime=0,this.isMigrateStarted=!1;const s=i.ModuleContainer.resolve(B.ZLoggerFactory);this.logger=s.createZLogger("db-migrate",["manager"]),this.migrateResolver=new as.b.Container,this.promoteSubject=new VL,this.taskScheduler.start(),this.handleDBMigrationMessage(),this.addDBCorruptionListener()}waitMigrateRelease(){return this.isMigrateStarted?this.migrateResolver.promise:Promise.resolve()}startHandleMigrateProcessDisconnected(){const e=i.ModuleContainer.resolve(p.b),t=[];t.push(e.addEventListener(DF.c.ChannelDisconnected,(()=>{this.logger.zsymb(6,"22Zhef","Migrate process disconnected")}))),t.push(e.addEventListener(DF.c.ChannelReConnected,(()=>{this.logger.zsymb(0,"AtPiwb","Migrate process re-connected -> Resume migrate"),this.signalSQLiteProcessToStartMigrate()}))),this.stopHandleMigrateProcessDisconnected=()=>t.forEach((e=>e()))}waitForDBMigrate(e,t,s){return new Promise((async a=>{try{this.updateCurrentDisplayedMigrateUI(La.d.INIT),this.logger.zsymb(0,"VBaRBt","Sync migrate server config",t),this.config.loadConfig(t),this.logger.zsymb(0,"I-gzdx","Sync full_disk_check server config",s),Et.updateServerConfig(s),this.session=e,this.databaseStateStorage.authenticate(e);const n=this.getIsMigrationStarted();if(!this.enableMigrate&&!n)return this.hideMigrateUI(La.d.DISABLED),this.scheduleReminder(),this.logger.zsymb(0,"wr-VU4","[status] force skip migrate due to server config",this.enableMigrate),a(!1);if(i.ModuleContainer.resolve(dF.TDBCorruptionDetector).corruptionHasOccurred())return this.hideMigrateUI(La.d.DISABLED),this.logger.zsymb(0,"-DGurn","[status] force skip migrate due to corruption"),a(!1);if(this.currentUserHasMigrated())return this.hideMigrateUI(La.d.TR_SUCCESS),this.logger.zsymb(0,"_QKWtV","[status] current user migrated, no need to migrate"),a(!0);if(await $zFeatures.migrateDB.isMigrateFullDone())return this.hideMigrateUI(La.d.TR_SUCCESS),this.logger.zsymb(0,"uyZwG5","[status] all user migrated"),a(!0);const r=Object(bF.a)(e.userId);if(!n&&r)return this.logger.zsymb(0,"uoze5T","[status] first session, silent migrate"),this.isSilentMigrate=!0,void(await this.signalRestartAppToStartMigrate());const o=this.config.nestedKey("migrate_version"),{disable_migrate:c}=await this.getMigrateLocalInfo(o);if(c)return this.hideMigrateUI(La.d.DISABLED),this.logger.zsymb(0,"WsKRqa","[status] force skip migrate due to too many retry!"),a(!1);if(!n){if(await this.needWaitCreateBackup())return this.hideMigrateUI(La.d.WAIT_BACKUP),this.logger.zsymb(0,"-yD0Ef","[status] force skip migrate to wait for backup",this.enableMigrate),RF.a.instance().onSkipDuetoNoBackup(),a(!1)}if(n&&await this.getIsInconsitentAdapterTypeState())return void this.signalRestartAppToStartMigrate();if(this.signalDone=a,$zwindow.setLoginSize(),n&&(wF.b.getInstance().setDisableAnalyzeCorruption(!0),this.startHandleMigrateProcessDisconnected()),n&&(this.isTrickle||this.isSilentMigrate))this.isTrickle?(this.logger.zsymb(0,"MQ1lC6","[status] continue trickle"),this.startMigrateAsTrickle(),this.signalDone(!0)):(this.logger.zsymb(0,"jVR-dW","[status] start silent migrate"),this.startMigrateAsSilent());else if(this.didBlockApp=!0,this.initControllerService(),n){this.logger.zsymb(0,"dk2urt","[status] continue BigBang");let e=!1,t=0;if(!this.isFirstTimeMigrate()){this.updateCurrentDisplayedMigrateUI(La.d.GET_READY),await this.initCacheTotalMsg();try{this.logger.zsymb(0,"99BXZM","[storage-checking] Timestamp: Start up");const s=await this.checkStorageByProgress();e=s.isLowDiskSpace,t=s.requiredSpace}catch(kF){const t=Object(ZL.b)(kF);return this.logger.zsymb(3,"CZqCaP",["[storage-checking] Failed due to error: {}","zio3Wt"],t),RF.a.instance().onCheckDiskError(t),void this.handleErrorDuringBigBangMigration(kF)}}e?(this.logger.zsymb(0,"o9oZG9","[status] show storage checking screen"),this.updateCurrentDisplayedMigrateUI(La.d.STORAGE_CHECK,{isLowDiskSpace:e,requiredSpace:t})):this.startMigrateAsBigBang()}else this.logger.zsymb(0,"FgGOq7","[status] start migration for the 1st time"),this.logger.zsymb(0,"Fe2sS7","[status] show onboarding"),await this.initCacheTotalMsg(),this.updateCurrentDisplayedMigrateUI(La.d.ONBOARDING,{pausedLastSession:this.migratePausedLastSession()})}catch(kF){const t=Object(ZL.b)(kF);this.logger.zsymb(21,"ZZ7DRz",["Unexpected err: {}","Gth0e8"],t),RF.a.instance().onUnexpectedError(t)}}))}async initControllerService(){if(null!==this.initControllerServiceContainer)return this.initControllerServiceContainer.promise;this.initControllerServiceContainer=new as.b.Container,this.startProfileSlowPrepareData(yF.f.SUB_CMD.CONTROL_SERVICE);try{const e=performance.now();await this.signalSQLiteProcessToInitState();const t=performance.now();this.logger.zsymb(3,"lQVvM2",["[prepare][success] 'initState' cost: {}","aG5s8k"],t-e)}catch(kF){const t=Object(ZL.b)(kF);RF.a.instance().onSlowPreparedData(yF.f.SUB_CMD.CONTROL_SERVICE,yF.f.ERR_CODE.FAILED,t),this.logger.zsymb(21,"zVe5oS",["[prepare][failed] 'initState': {}","C1Yjha"],t)}this.stopProfileSlowPrepareData(yF.f.SUB_CMD.CONTROL_SERVICE),this.initControllerServiceContainer.resolve()}async initCacheTotalMsg(){if(null!==this.initCacheTotalMsgContainer)return this.initCacheTotalMsgContainer.promise;this.initCacheTotalMsgContainer=new as.b.Container,this.startProfileSlowPrepareData(yF.f.SUB_CMD.TOTAL_MSG);try{const e=performance.now();await this.getTotalMsgCount(!1);const t=performance.now();this.logger.zsymb(3,"tAajW9",["[prepare][success] 'totalMsg' cost: {}","zZ-J44"],t-e)}catch(kF){const t=Object(ZL.b)(kF);RF.a.instance().onSlowPreparedData(yF.f.SUB_CMD.TOTAL_MSG,yF.f.ERR_CODE.FAILED,t),this.logger.zsymb(21,"57qnt_",["[prepare][failed] 'totalMsg': {}","dHJZF-"],t)}this.stopProfileSlowPrepareData(yF.f.SUB_CMD.TOTAL_MSG),this.initCacheTotalMsgContainer.resolve()}startProfileSlowPrepareData(e){let t=this.preparedDataProfileTimers.get(e);void 0===t&&(t=[setTimeout((()=>{RF.a.instance().onSlowPreparedData(e,yF.f.ERR_CODE["10s"])}),1e4),setTimeout((()=>{RF.a.instance().onSlowPreparedData(e,yF.f.ERR_CODE["20s"])}),2e4),setTimeout((()=>{RF.a.instance().onSlowPreparedData(e,yF.f.ERR_CODE["30s"])}),3e4)],this.preparedDataProfileTimers.set(e,t))}stopProfileSlowPrepareData(e){const t=this.preparedDataProfileTimers.get(e);t&&(t.forEach((e=>clearTimeout(e))),this.preparedDataProfileTimers.delete(e))}waitUntilFinishInitService(){if(null!==this.initControllerServiceContainer)return this.initControllerServiceContainer.promise;this.logger.zsymb(18,"CNxJhK","Service hasn't been init yet")}cleanupInternalState(){n.default.getInstance().removeItemForCurrentUser(rF.e),this.databaseStateStorage.removeItemForCurrentUser(rF.c),this.databaseStateStorage.removeItemForCurrentUser(rF.b)}cleanupData(){this.currentUserHasMigrated()&&this.config.nestedKey("drop_idb")&&(EF.instance().unlock(),EF.instance().deleteOldDB(this.session))}updateCurrentDisplayedMigrateUI(e,t){this.updateState(Object(T.a)({status:e},t||{}))}hideMigrateUI(e){this.updateState({status:e}),$zapp.setMainWindowResizable(!0)}startStorageCheckingTimer(){null===this.storageCheckingTimer&&(this.storageCheckingTimer=setTimeout((async()=>{this.taskScheduler.run({execute:async()=>{this.storageCheckingTimer=null,this.logger.zsymb(0,"5SsXcj","[storage-checking] Timestamp: During BigBang migration");let e=null;try{e=await this.getMigrateDiskInfoByProgress(!0)}catch(kF){this.logger.zsymb(21,"HWHaHi",["Failed to get migrate disk info by progress due to error: {}","caiFY_"],Object(ZL.b)(kF))}const{isLowDiskSpace:t,requiredSpace:s}=e||{isLowDiskSpace:!1,requiredSpace:0};if(t)return await this.handlePauseMigrate("low-disk"),this.logger.zsymb(0,"qatT4g","[status] Pause migration due to low disk (storage checking interval)"),this.stopBigBangMigrationTimers(),this.logger.zsymb(0,"sPp-hB","[status] show storage checking screen"),this.storageCheckingTimerContainer=new as.b.Container,this.updateCurrentDisplayedMigrateUI(La.d.STORAGE_CHECK,{isLowDiskSpace:t,requiredSpace:s}),this.storageCheckingTimerContainer.promise;this.startStorageCheckingTimer()}})}),5e3))}stopStorageCheckingTimer(){null!==this.storageCheckingTimer&&(clearTimeout(this.storageCheckingTimer),this.storageCheckingTimer=null)}async getCurrentMigrateProgress(){if(null===this.migrateProgressPercent){const{migratedCount:e,toMigrateCount:t}=await this.calculateCurrentMigrateProgress();if(-1===e||-1===t)throw new Error("Failed to get current migrate progress");const s=e/t;this.migrateProgressPercent=s}return this.migrateProgressPercent}async signalGetCurrentMigrateProgress(){const e={type:f.o,data:{session:this.session}},t=i.ModuleContainer.resolve(p.b),s=await t.getPort(),a={typeID:f.k,data:e};return await s.invokeMessage(a)}async calculateCurrentMigrateProgress(){return this.logger.zsymb(0,"m-WGto","Get current progress from migrate controller"),this.signalGetCurrentMigrateProgress()}async getEstimatedSQLiteSize(e){const t=this.config.nestedKey("total_msg_ratio"),s=this.config.nestedKey("delta_size_estimated_sqlite"),i=this.config.nestedKey("min_estimated_sqlite_size");return Math.max(t*e+s,i)}async getMigrateDiskInfoByProgress(e){const t=ve.a.analyzeMainDisk();if(!t)throw new Error("Failed to get disk info");const{total:s,free:i}=t,{secondAlmostFullThreshold:a}=this.getAlmostFullStorageThreshold(s),n=await this.getTotalMsgCount(e),r=await this.getEstimatedSQLiteSize(n),o=await this.getCurrentMigrateProgress(),c=r*(1-o),l=this.config.nestedKey("delta_size_storage_checking");let d=0;d=i>a?c+a+l:c+a;const h=as.f.bytesToMB(i),u=as.f.bytesToMB(d),g=Math.ceil(h)<Math.ceil(u);return g?this.logger.zsymb(3,"VGHKaM",["[storage-checking][progress] FAILED  ❌ - Required: {} - Actual: {} - Progress: {}","6g133R"],Object(gF.a)(d),Object(gF.a)(i),o.toFixed(3)):this.logger.zsymb(3,"8PObAj",["[storage-checking][progress] PASSED  ✅ - Required: {} - Actual: {} - Progress: {}","ENwq2H"],Object(gF.a)(d),Object(gF.a)(i),o.toFixed(3)),{isLowDiskSpace:g,requiredSpace:d}}async handleResumeMigrate(e){this.didSignalProcessToStartMigration?(null!==this.storageCheckingTimerContainer&&(this.storageCheckingTimerContainer.resolve(),this.storageCheckingTimerContainer=null),this.logger.zsymb(0,"lGVf0G","[status] resume"),this.startBigBangMigrationTimers(),this.startHandleMigrateProcessDisconnected(),await this.requestResumeMigrate(e),this.logger.zsymb(0,"flaNiA","[status] show in-progress screen"),this.updateCurrentDisplayedMigrateUI(La.d.BB_IN_PROGRESS)):this.startMigrateAsBigBang()}async handlePauseMigrate(e){this.stopBigBangMigrationTimers(),this.stopHandleMigrateProcessDisconnected(),await this.requestPauseMigrate(e)}async checkStorageByProgress(){let e=null;try{e=await this.getMigrateDiskInfoByProgress(!0)}catch(kF){throw this.logger.zsymb(21,"r2gGjI",["Failed to get migrate disk info by progress due to error: {}","caiFY_"],Object(ZL.b)(kF)),kF}return e}async startMigrateAsSilent(){this.updateCurrentDisplayedMigrateUI(La.d.INIT,{pausedLastSession:this.migratePausedLastSession()}),this.signalSQLiteProcessToStartMigrate(),this.didSignalProcessToStartMigration=!0,this.promoteSubject.setShouldPromote(!0)}async startMigrateAsTrickle(){this.hideMigrateUI(La.d.TR_IN_PROGRESS),this.listenFullDiskFromSM(),this.signalSQLiteProcessToStartMigrate(),this.didSignalProcessToStartMigration=!0,this.promoteSubject.setShouldPromote(!0)}async getRejectConfig(){let e=!1,t=!1;try{const s=this.config.nestedKey("migrate_version"),i=this.config.nestedKey("max_retry_count"),a=await this.getMigrateLocalInfo(s),{current_retry_count:n}=a;e=n>0,t=n>=i}catch(kF){const t=Object(ZL.b)(kF);this.logger.zsymb(21,"mnj9_h",["Failed to get reject config: {}","VLsrnq"],t)}return{allowReject:e,forceReject:t}}async startMigrateAsBigBang(){const{allowReject:e,forceReject:t}=await this.getRejectConfig();let s=0;if(!this.isFirstTimeMigrate())try{const e=Math.min(100*await this.getCurrentMigrateProgress(),100);s=this.getMigratePercent(e).percent}catch(kF){this.logger.zsymb(21,"_6-xs7",["Failed to get current migrate progress: {}","6bwwAC"],Object(ZL.b)(kF))}this.logger.zsymb(3,"rwlUCQ",["[status] show in-progress screen","ndSQlF"]),await this.waitUntilFinishInitService(),this.updateCurrentDisplayedMigrateUI(La.d.BB_IN_PROGRESS,{pausedLastSession:this.migratePausedLastSession(),allowReject:e,forceReject:t,percent:this.formatPercent(s)}),this.startBigBangMigrationTimers(),this.signalSQLiteProcessToStartMigrate(),this.didSignalProcessToStartMigration=!0,this.promoteSubject.setShouldPromote(!0)}listenFullDiskFromSM(){const e=async e=>{var t;const s=null==e||null===(t=e.payload)||void 0===t?void 0:t.level;if(s)switch(s){case Be.d.FULL:this.isMigrationPaused||(this.logger.zsymb(0,"oq8l1S","[status] Pause migration due to full disk (SM signal)"),this.stopHandleMigrateProcessDisconnected(),this.requestPauseMigrate("full-disk"));break;case Be.d.RICH_SPACE:case Be.d.ALMOST_FULL_1:case Be.d.ALMOST_FULL_2:this.isMigrationPaused&&(this.logger.zsymb(3,"XV9_qo",["[status] Resume migration (SM signal: {})","x1yKYF"],s),this.startHandleMigrateProcessDisconnected(),this.requestResumeMigrate("sm-signal"))}};Q.a.DiskStatusManager.addEventListener(je.ResDisk_CurrentLevel,e),this.removeListenerFullDiskFromSM=()=>Q.a.DiskStatusManager.removeEventListener(je.ResDisk_CurrentLevel,e)}getAlmostFullStorageThreshold(e){let{firstAlmostFullThreshold:t,secondAlmostFullThreshold:s}=Et.getServerConfigThreshold();let i=-1,a=-1;if(Et.lowCapacityDevice){i=t*e,a=s*e}else i=as.f.sizeInByte(`${t}GB`),a=as.f.sizeInByte(`${s}GB`);return{firstAlmostFullThreshold:i,secondAlmostFullThreshold:a}}async handleStartMigrate(){this.skipCheckStorageWhenStartupOnce(),await this.signalRestartAppToStartMigrate()}skipCheckStorageWhenStartupOnce(){n.default.getInstance().setItemForCurrentUser(rF.a,"1")}isFirstTimeMigrate(){if(null!==this.cachedIsFirstTimeMigrate)return this.cachedIsFirstTimeMigrate;const e=n.default.getInstance(),t=null!==e.getItemForCurrentUser(rF.a);return t&&e.removeItemForCurrentUser(rF.a),this.cachedIsFirstTimeMigrate=t,this.cachedIsFirstTimeMigrate}async handleRetryMigrate(){this.logger.zsymb(0,"LgP9Ih","[retry] start");try{await this.increaseRetryCount(),await this.signalRestartAppToRetryMigrate(),this.logger.zsymb(0,"anDWZG","[retry] done ✅")}catch(kF){throw this.logger.zsymb(21,"TfXQVo",["[retry] fail ❌: {}","71jA1E"],Object(ZL.b)(kF)),kF}}async handleRejectMigrate(){this.logger.zsymb(18,"p_Y9Wb","[reject] start");try{this.resetState(),RF.a.instance().onUserRejectDuetoError(),await this.disableMigrateAfterTooManyRetry(),await this.signalRestartAppToRejectMigrate(),this.logger.zsymb(18,"iSSAzY","[reject] done ✅")}catch(kF){throw this.logger.zsymb(21,"XVGiol",["[reject] fail ❌: {}","58kqxh"],Object(ZL.b)(kF)),kF}}async getTotalMsgCount(e=!0){const t=async()=>{const e=_F.a.baseConfig.name,t=Object(vF.a)(e,qL.a.IDB),s=new aF({session:this.session,dbConfig:t});try{return await s.count(_F.a.schema.Message)}catch(kF){if(XL.ignoreable(kF.name,kF.code))return 0;throw kF}finally{s.closeConnection()}};return-1!==this.cachedTotalMsgCount&&e||(this.cachedTotalMsgCount=await t()),this.cachedTotalMsgCount}async increaseRetryCount(){const e=this.config.nestedKey("migrate_version"),{current_retry_count:t}=await this.getMigrateLocalInfo(e);await this.updateMigrateLocalInfo(e,{current_retry_count:t+1})}async disableMigrateAfterTooManyRetry(){const e=this.config.nestedKey("migrate_version");await this.updateMigrateLocalInfo(e,{disable_migrate:!0})}async getMigrateLocalInfo(e){return null===this.migrateLocalInfo&&(this.migrateLocalInfo=await $zFeatures.migrateDB.getMigrateLocalInfo(e,this.session.userId)),this.migrateLocalInfo}async updateMigrateLocalInfo(e,t){null!==this.migrateLocalInfo&&(this.migrateLocalInfo=Object(T.a)(Object(T.a)({},this.migrateLocalInfo),t)),await $zFeatures.migrateDB.updateMigrateLocalInfo(e,this.session.userId,t)}resetState(){n.default.getInstance().removeItemForCurrentUser(rF.e)}promoteMigrateByOpenConv(e){this.promoteSubject.promoteForOpenConv(e)}async signalRestartAppToStartMigrate(){RF.a.instance().onStartMigrate(),this.setAdaperTypeForDAL(qL.a.SQLite),mF.a.closeDB((()=>{$zFeatures.migrateDB.signalRestartAppToMigrate()}),{idbTimeout:0})}async signalRestartAppToRejectMigrate(){await this.signalSQLiteProcessToResetProgress(),await $zFeatures.migrateDB.signalRestartAppToMigrate()}async signalSQLiteProcessToResetProgress(){const e={type:f.v,data:{session:this.session}},t=i.ModuleContainer.resolve(p.b),s=await t.getPort(),a={typeID:f.k,data:e};await s.invokeMessage(a)}async signalRestartAppToRetryMigrate(){$zFeatures.migrateDB.signalRestartAppToMigrate()}releaseBlockingAppLogic(){this.signalDone(!0)}setAdaperTypeForDAL(e){const t=this.databaseStateStorage.getObject(cF.a)||{},s=Object(T.a)(Object(T.a)({},t),{},{shared:e,[this.session.userId]:e});this.databaseStateStorage.setObject(cF.a,s)}get enableMigrate(){return this.config.nestedKey("enable")}get maxBURetries(){return this.config.nestedKey("max_retries_create_bu")}get timeoutDuration(){return this.config.nestedKey("max_timeout_duration")}get lastElapsedTime(){if(null===this._lastElapsedTime){const e=n.default.getInstance();this._lastElapsedTime=e.getIntForCurrentUser(rF.e,{defaultInt:0})}return this._lastElapsedTime}resetLastElapsedTimeCached(){this._lastElapsedTime=null}getCurrentElapsedTime(){return 0===this.startTime?this.lastElapsedTime:Date.now()-this.startTime+this.lastElapsedTime}recordTimeElapsed(){const e=this.getCurrentElapsedTime();n.default.getInstance().setItemForCurrentUser(rF.e,e.toString())}startRecordingTimeElapsed(){null!==this.timeElapsedTimer&&clearInterval(this.timeElapsedTimer),this.startTime=Date.now(),this.resetLastElapsedTimeCached(),this.timeElapsedTimer=setInterval((()=>{this.recordTimeElapsed()}),1e3)}stopRecordingTimeElapsed(){null!==this.timeElapsedTimer&&clearInterval(this.timeElapsedTimer)}getMigrateDoneState(){if(null===this.migrateDoneState){const e=this.databaseStateStorage.getItem(rF.d);if(e)try{this.migrateDoneState=JSON.parse(e)}catch(kF){this.logger.zsymb(21,"mQkDCu",["Failed to parse migrate done state: {}","qBtzER"],Object(ZL.b)(kF))}else this.migrateDoneState={}}return this.migrateDoneState}updateMigrateDoneState(e){this.migrateDoneState=Object(T.a)(Object(T.a)({},this.migrateDoneState),e);const t=JSON.stringify(this.migrateDoneState);this.databaseStateStorage.setItem(rF.d,t)}currentUserHasMigrated(){const e=this.getMigrateDoneState();return Boolean(e&&e[this.session.userId])}async allUserHasMigrated(){const e=await Object(uF.a)(),t=this.getMigrateDoneState();return Boolean(t&&Object.keys(t).length==e.length)}migratePausedLastSession(){if(this.currentUserHasMigrated())return!1;return!!n.default.getInstance().getItemForCurrentUser(rF.e)}async needWaitCreateBackup(){const e=await $zFeatures.migrateDB.checkNeedWaitBackup(this.maxBURetries);return this.logger.zsymb(0,"qmLT4v","needWaitCreateBackup",this.maxBURetries,e),e}startTimeoutPoint(){if(null!==this.timeoutTimer)return;const e=Math.max(this.timeoutDuration-this.lastElapsedTime,0);this.timeoutTimer=setTimeout((()=>{this.taskScheduler.run({execute:()=>{this.timeoutTimer=null,this.stopBigBangMigrationTimers(),this.isTrickle=!0,this.logger.zsymb(0,"mrKcNL","[status] done big bang migration due to timeout"),this.showBigBangSuccessScreen(),this.disposeMigrationUI(!0),this.listenFullDiskFromSM(),this.removeDBCorruptionListener(),this.taskScheduler.stop()}})}),e)}get isTrickle(){return null===this._isTrickle&&(this.currentUserHasMigrated()?this._isTrickle=!0:this._isTrickle=!!this.databaseStateStorage.getIntForCurrentUser(rF.c,{defaultInt:0})),this._isTrickle}set isTrickle(e){this._isTrickle!==e&&(this._isTrickle=e,0==e?this.databaseStateStorage.removeItemForCurrentUser(rF.c):this.databaseStateStorage.setItemForCurrentUser(rF.c,"1"))}startBigBangMigrationTimers(){this.startTimeoutPoint(),this.startStorageCheckingTimer(),this.startRecordingTimeElapsed()}stopBigBangMigrationTimers(){this.stopTimeoutPoint(),this.stopStorageCheckingTimer(),this.recordTimeElapsed(),this.stopRecordingTimeElapsed()}set isSilentMigrate(e){e?this.databaseStateStorage.setItemForCurrentUser(rF.b,"1"):this.databaseStateStorage.removeItemForCurrentUser(rF.b)}get isSilentMigrate(){return!!this.databaseStateStorage.getIntForCurrentUser(rF.b,{defaultInt:0})}stopTimeoutPoint(){null!==this.timeoutTimer&&(clearTimeout(this.timeoutTimer),this.timeoutTimer=null)}async skipMigrate(){this.logger.zsymb(0,"ncb5fj","[skip]"),this.logger.zsymb(0,"yAkExb","[status] hide migrate ui due to skip"),this.hideMigrateUI(La.d.SKIP),this.removeDBCorruptionListener(),this.signalDone(!1);try{await this.requestClearInfoDBSizeCache(),this.logger.zsymb(3,"gUzbn3",["[status] clear info db size cache success","8VtQEm"])}catch(e){this.logger.zsymb(21,"H6Ylli",["[status] an error occured due to clear info db size cache. {}","qnomqe"],Object(ZL.b)(e))}}scheduleReminder(){if(null===this.reminderTimeout){const e=this.config.nestedKey("auto_remind_modal_timeout");this.updateState({isLowDiskSpace:!1,requiredSpace:0}),this.logger.zsymb(0,"XwZaLg","[reminder] init -  timeout: {}ms",e),this.reminderTimeout=setTimeout((async()=>{this.reminderTimeout=null,this.logger.zsymb(0,"vS1zTr","[reminder] expired"),this.enableMigrate?this.handleShowOnboardingModal():this.scheduleReminder()}),e)}}handleShowOnboardingModal(){this.logger.zsymb(0,"GvguVT","[modal] show"),ft.ModalManagerV2.openModal({windowId:yt.c,name:W.ModalIdentitiesDefine.DATA_MIGRATION,params:!0})}markDoneMigrate(){$zFeatures.migrateDB.signalDoneFullMigrate(),this.promoteSubject.setShouldPromote(!1)}async markDoneMigrateForCurrentUser(){const e=i.ModuleContainer.resolve(oF.a);await e.setAdapterTypeOfUserScopedDatabases(this.session.userId,qL.a.SQLite),await e.setAdapterTypeOfSharedDatabases(qL.a.SQLite),this.updateMigrateDoneState({[this.session.userId]:Date.now()}),this.databaseStateStorage.removeItemForCurrentUser(rF.c)}async signalSQLiteProcessToInitState(){const e={type:f.p,data:{session:this.session}},t=i.ModuleContainer.resolve(p.b),s=await t.getPort(),a={typeID:f.k,data:e};await s.invokeMessage(a)}async signalSQLiteProcessToStartMigrate(){this.isMigrateStarted=!0;const e={type:f.B,data:{session:this.session}},t=i.ModuleContainer.resolve(p.b),s=await t.getPort(),a={typeID:f.k,data:e};await s.invokeMessage(a)}formatPercent(e){return e.toFixed(0)}async onMigrationProgress(e){const{data:t}=e,{error:s,migratedCount:a,toMigrateCount:n}=t;if(this.isTrickle||this.isSilentMigrate){if(s){this.migrateResolver.resolve(),wF.b.getInstance().setDisableAnalyzeCorruption(!1);i.ModuleContainer.resolve(dF.TDBCorruptionDetector).forceCheckDBCorruptionFor(qL.a.IDB)}}else{const e=-1!==a?Math.min(100,100*a/n):100;this.migrateProgressPercent=a/n;const{percent:t,timeElapsed:i}=this.getMigratePercent(e);0,100===t&&this.logger.zsymb(3,"E8if9o",["progress 100 - migrateProgress: {} - timeoutProgress: {}","P0KH5X"],e,Math.min(100*i/this.timeoutDuration,100));const r={timeElapsed:i};s?this.handleErrorDuringBigBangMigration(s.message||s):this.updateState(Object(T.a)({percent:this.formatPercent(t)},r))}}getMigratePercent(e){const t=this.getCurrentElapsedTime(),s=Math.min(100*t/this.timeoutDuration,100);return{percent:Math.max(e,s),timeElapsed:t}}handleErrorDuringBigBangMigration(e){this.isTrickle||this.taskScheduler.run({execute:()=>{this.stopBigBangMigrationTimers();const t=Object(ZL.b)(e);this.logger.zsymb(3,"5bNcuv",["[status] show error screen - error: {}","GBhpCc"],t),this.updateCurrentDisplayedMigrateUI(La.d.BB_FAILED,{error:t});return new Promise((()=>{}))}})}showBigBangSuccessScreen(){this.showSuccessScreen||(this.showSuccessScreen=!0,this.logger.zsymb(0,"lfK8-Q","[status] show success screen"),this.updateCurrentDisplayedMigrateUI(La.d.BB_SUCCESS,{timeElapsed:this.getCurrentElapsedTime()}))}disposeMigrationUI(e){const t=()=>{this.logger.zsymb(0,"YcqO25","[status] hide migrate ui due to release blocking ui"),this.hideMigrateUI(La.d.TR_IN_PROGRESS),this.releaseBlockingAppLogic()};if(e){const e=this.config.nestedKey("auto_dismiss_success_screen");setTimeout(t,e)}else t()}async updateMigrateStateAsFinished(e){this.logger.zsymb(0,"WnWXCr","[status] finish migrate"),await this.markDoneMigrateForCurrentUser(),await this.allUserHasMigrated()&&this.markDoneMigrate(),this.migrateResolver.resolve(),wF.b.getInstance().setDisableAnalyzeCorruption(!1)}async handleDBMigrationMessage(){const e=i.ModuleContainer.resolve(p.b),t=await e.getPort(),s=async e=>{const{data:i}=e,{typeID:a}=i;if(a===f.k){const{data:e}=i,{type:a}=e;switch(a){case f.x:this.onMigrationProgress(e);break;case f.m:{const{data:i}=e;await this.updateMigrateStateAsFinished(i),this.removeListenerFullDiskFromSM(),this.isTrickle||(this.isSilentMigrate?(this.isSilentMigrate=!1,this.disposeMigrationUI(!1)):(this.logger.zsymb(0,"aY2jm0","[status] done big bang migration due to finish migration"),this.taskScheduler.run({execute:()=>{this.stopBigBangMigrationTimers(),this.showBigBangSuccessScreen(),this.disposeMigrationUI(!0),this.taskScheduler.stop()}}))),this.cleanupData(),this.cleanupInternalState(),this.stopHandleMigrateProcessDisconnected(),t.removeEventListener("message",s),this.removeDBCorruptionListener(),FF.flushLogs();break}case f.u:{const{data:t}=e,{success:s,cmd:i,subCmd:a,duration:n,payload:r}=t;RF.a.instance().submitQos(s,i,a,n,r),FF.checkAndLog(i,r);break}}}};t.addEventListener("message",s)}addDBCorruptionListener(){i.ModuleContainer.resolve(dF.TDBCorruptionDetector).addEventListener(hF.a.DB_CORRUPTION_DETECTED,this.handleDBCorruption)}removeDBCorruptionListener(){i.ModuleContainer.resolve(dF.TDBCorruptionDetector).removeEventListener(hF.a.DB_CORRUPTION_DETECTED,this.handleDBCorruption)}getIsMigrationStarted(){const e=Object(lF.a)();let t=e;try{t=this.databaseStateStorage.getObject(cF.a)||e}catch(kF){this.logger.zsymb(18,"8T8bsC","parse adapter type state error",Object(ZL.b)(kF))}return t[this.session.userId]===qL.a.SQLite}async getIsInconsitentAdapterTypeState(){try{const e=await this.databaseStateStorage.getObjectAsync(cF.a);return null!==e&&e.shared!==e[this.session.userId]}catch(kF){return this.logger.zsymb(18,"eDOqNk","parse adapter type state error",Object(ZL.b)(kF)),!1}}init(){}getItem(){return this.state}getList(){return[]}onGetItemFailure(){}onGetListFailure(){}updateState(e){this.state=Object(T.a)(Object(T.a)({},this.state),e),Object(Zs.g)(this.name,La.c)}})||LF)||LF)||LF)||LF)||LF)||LF;"render"==__ZaBUNDLENAME__&&(i.ModuleContainer.registerSingleton(La.b,NF),i.ModuleContainer.registerSingleton(ie.a,NF));s("uiYo")},Lp8g:function(e,t){globalThis.hasOwnProperty("$recoilDebugStates")&&(globalThis.$recoilDebugStates.push=function(...e){this.length>=100&&Array.prototype.splice.apply(this,[0,Math.round(this.length/2)]),Array.prototype.push.apply(this,e)})},SF1S:function(e,t){},WOja:function(e,t){},XNYy:function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var i=s("jDHv");const a=Object(i.define)("JIT_JXL_DECODER")},"g/Wc":function(e,t){},oSk7:function(e,t,s){"use strict";class i{constructor(e){this.stream=void 0,this.stream=e}pipe(e){return this.stream=i.transformStream(this.stream,e),this}getStream(){return this.stream}static transformStream(e,t,s){try{return e.pipeThrough(new TransformStream(t))}catch(i){const s=e.getReader();return new ReadableStream({start(e){var s;const i={desiredSize:null,enqueue(t){e.enqueue(t)},error(e){},terminate(){}};return null===(s=t.start)||void 0===s?void 0:s.call(t,i)},async pull(e){let i=!1;const a={desiredSize:null,enqueue(t){i=!0,t&&e.enqueue(t)},error(e){},terminate(){}};for(;!i;){var n;const i=await s.read();var r;if(i.done)return await(null===(r=t.flush)||void 0===r?void 0:r.call(t,a)),e.close();await(null===(n=t.transform)||void 0===n?void 0:n.call(t,i.value,a))}}})}}static createReadbleStreamFromArrayBuffer(e,t=2**20){const s=Math.ceil(e.byteLength/t);return new ReadableStream({start(i){for(let a=0;a<=s;a++)i.enqueue(new Uint8Array(e,a*t,t));i.close()}})}}t.a=i},taJj:function(e,t,s){"use strict";t.a=class{constructor(e){this.chunkSize=void 0,this.partialChunk=void 0,this.offset=void 0,this.chunkSize=e,this.partialChunk=new Uint8Array(this.chunkSize),this.offset=0}send(e,t){t.enqueue(e),this.partialChunk=new Uint8Array(this.chunkSize),this.offset=0}transform(e,t){let s=0;if(this.offset>0){const i=Math.min(e.byteLength,this.chunkSize-this.offset);this.partialChunk.set(e.slice(0,i),this.offset),this.offset+=i,s+=i,this.offset===this.chunkSize&&this.send(this.partialChunk,t)}for(;s<e.byteLength;){const i=e.byteLength-s;if(i>=this.chunkSize){const i=e.slice(s,s+this.chunkSize);s+=this.chunkSize,this.send(i,t)}else{const t=e.slice(s,s+i);s+=t.byteLength,this.partialChunk.set(t),this.offset=t.byteLength}}}flush(e){this.offset>0&&e.enqueue(this.partialChunk.slice(0,this.offset))}}},uGvo:function(e,t){},zEx5:function(e,t,s){"use strict";var i=s("g/Wc");s.o(i,"TJitJxlDecoder")&&s.d(t,"TJitJxlDecoder",(function(){return i.TJitJxlDecoder}));var a=s("XNYy");s.d(t,"TJitJxlDecoder",(function(){return a.a}))}}]);
//# sourceMappingURL=../sourcemaps/lazy/main-startup.1778f55a0941d7ea8e7d.js.map